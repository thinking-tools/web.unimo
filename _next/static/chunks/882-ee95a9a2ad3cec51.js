(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[882],{9141:function(ei){"use strict";for(var eo=/[\\\"\x00-\x1F]/g,ea={},ec=0;ec<32;++ec)ea[String.fromCharCode(ec)]="\\U"+("0000"+ec.toString(16)).slice(-4).toUpperCase();function ed(ei){return eo.lastIndex=0,ei.replace(eo,function(ei){return ea[ei]})}function eu(ei){switch(typeof ei){case"string":return'"'+ed(ei)+'"';case"number":return isFinite(ei)?ei:"null";case"boolean":return ei;case"object":if(null===ei)return"null";if(Array.isArray(ei))return eh(ei);return ef(ei);default:throw Error("Cannot stringify: "+typeof ei)}}function eh(ei){for(var eo="[",ea="",ec=0;ec<ei.length;++ec)ea+=eo,eo=",",ea+=eu(ei[ec]);return","!=eo?"[]":ea+"]"}function ef(ei){var eo="{",ea="",ec=Object.keys(ei);ec.sort();for(var eh=0;eh<ec.length;++eh){var ef=ec[eh];ea+=eo+'"'+ed(ef)+'":',eo=",",ea+=eu(ei[ef])}return","!=eo?"{}":ea+"}"}ea["\b"]="\\b",ea["	"]="\\t",ea["\n"]="\\n",ea["\f"]="\\f",ea["\r"]="\\r",ea['"']='\\"',ea["\\"]="\\\\",ei.exports={stringify:eu}},8162:function(ei){"use strict";function eo(ei){if(ei.length>=255)throw TypeError("Alphabet too long");for(var eo=new Uint8Array(256),ea=0;ea<eo.length;ea++)eo[ea]=255;for(var ec=0;ec<ei.length;ec++){var ed=ei.charAt(ec),eu=ed.charCodeAt(0);if(255!==eo[eu])throw TypeError(ed+" is ambiguous");eo[eu]=ec}var eh=ei.length,ef=ei.charAt(0),ep=Math.log(eh)/Math.log(256),eg=Math.log(256)/Math.log(eh);function em(ei){if("string"!=typeof ei)throw TypeError("Expected String");if(0===ei.length)return new Uint8Array;for(var ea=0,ec=0,ed=0;ei[ea]===ef;)ec++,ea++;for(var eu=(ei.length-ea)*ep+1>>>0,eg=new Uint8Array(eu);ei[ea];){var em=eo[ei.charCodeAt(ea)];if(255===em)return;for(var ey=0,eb=eu-1;(0!==em||ey<ed)&&-1!==eb;eb--,ey++)em+=eh*eg[eb]>>>0,eg[eb]=em%256>>>0,em=em/256>>>0;if(0!==em)throw Error("Non-zero carry");ed=ey,ea++}for(var eS=eu-ed;eS!==eu&&0===eg[eS];)eS++;for(var eE=new Uint8Array(ec+(eu-eS)),ew=ec;eS!==eu;)eE[ew++]=eg[eS++];return eE}function ey(ei){var eo=em(ei);if(eo)return eo;throw Error("Non-base"+eh+" character")}return{encode:function(eo){if(eo instanceof Uint8Array||(ArrayBuffer.isView(eo)?eo=new Uint8Array(eo.buffer,eo.byteOffset,eo.byteLength):Array.isArray(eo)&&(eo=Uint8Array.from(eo))),!(eo instanceof Uint8Array))throw TypeError("Expected Uint8Array");if(0===eo.length)return"";for(var ea=0,ec=0,ed=0,eu=eo.length;ed!==eu&&0===eo[ed];)ed++,ea++;for(var ep=(eu-ed)*eg+1>>>0,em=new Uint8Array(ep);ed!==eu;){for(var ey=eo[ed],eb=0,eS=ep-1;(0!==ey||eb<ec)&&-1!==eS;eS--,eb++)ey+=256*em[eS]>>>0,em[eS]=ey%eh>>>0,ey=ey/eh>>>0;if(0!==ey)throw Error("Non-zero carry");ec=eb,ed++}for(var eE=ep-ec;eE!==ep&&0===em[eE];)eE++;for(var ew=ef.repeat(ea);eE<ep;++eE)ew+=ei.charAt(em[eE]);return ew},decodeUnsafe:em,decode:ey}}ei.exports=eo},9742:function(ei,eo){"use strict";eo.byteLength=eg,eo.toByteArray=ey,eo.fromByteArray=eE;for(var ea=[],ec=[],ed="undefined"!=typeof Uint8Array?Uint8Array:Array,eu="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",eh=0,ef=eu.length;eh<ef;++eh)ea[eh]=eu[eh],ec[eu.charCodeAt(eh)]=eh;function ep(ei){var eo=ei.length;if(eo%4>0)throw Error("Invalid string. Length must be a multiple of 4");var ea=ei.indexOf("=");-1===ea&&(ea=eo);var ec=ea===eo?0:4-ea%4;return[ea,ec]}function eg(ei){var eo=ep(ei),ea=eo[0],ec=eo[1];return(ea+ec)*3/4-ec}function em(ei,eo,ea){return(eo+ea)*3/4-ea}function ey(ei){var eo,ea,eu=ep(ei),eh=eu[0],ef=eu[1],eg=new ed(em(ei,eh,ef)),ey=0,eb=ef>0?eh-4:eh;for(ea=0;ea<eb;ea+=4)eo=ec[ei.charCodeAt(ea)]<<18|ec[ei.charCodeAt(ea+1)]<<12|ec[ei.charCodeAt(ea+2)]<<6|ec[ei.charCodeAt(ea+3)],eg[ey++]=eo>>16&255,eg[ey++]=eo>>8&255,eg[ey++]=255&eo;return 2===ef&&(eo=ec[ei.charCodeAt(ea)]<<2|ec[ei.charCodeAt(ea+1)]>>4,eg[ey++]=255&eo),1===ef&&(eo=ec[ei.charCodeAt(ea)]<<10|ec[ei.charCodeAt(ea+1)]<<4|ec[ei.charCodeAt(ea+2)]>>2,eg[ey++]=eo>>8&255,eg[ey++]=255&eo),eg}function eb(ei){return ea[ei>>18&63]+ea[ei>>12&63]+ea[ei>>6&63]+ea[63&ei]}function eS(ei,eo,ea){for(var ec=[],ed=eo;ed<ea;ed+=3)ec.push(eb((ei[ed]<<16&16711680)+(ei[ed+1]<<8&65280)+(255&ei[ed+2])));return ec.join("")}function eE(ei){for(var eo,ec=ei.length,ed=ec%3,eu=[],eh=16383,ef=0,ep=ec-ed;ef<ep;ef+=eh)eu.push(eS(ei,ef,ef+eh>ep?ep:ef+eh));return 1===ed?eu.push(ea[(eo=ei[ec-1])>>2]+ea[eo<<4&63]+"=="):2===ed&&eu.push(ea[(eo=(ei[ec-2]<<8)+ei[ec-1])>>10]+ea[eo>>4&63]+ea[eo<<2&63]+"="),eu.join("")}ec["-".charCodeAt(0)]=62,ec["_".charCodeAt(0)]=63},7191:function(ei,eo,ea){let ec=ea(8162),ed="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";ei.exports=ec(ed)},8764:function(ei,eo,ea){"use strict";/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */let ec=ea(9742),ed=ea(645),eu="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;eo.Buffer=eg,eo.SlowBuffer=eO,eo.INSPECT_MAX_BYTES=50;let eh=2147483647;function ef(){try{let ei=new Uint8Array(1),eo={foo:function(){return 42}};return Object.setPrototypeOf(eo,Uint8Array.prototype),Object.setPrototypeOf(ei,eo),42===ei.foo()}catch(ei){return!1}}function ep(ei){if(ei>eh)throw RangeError('The value "'+ei+'" is invalid for option "size"');let eo=new Uint8Array(ei);return Object.setPrototypeOf(eo,eg.prototype),eo}function eg(ei,eo,ea){if("number"==typeof ei){if("string"==typeof eo)throw TypeError('The "string" argument must be of type string. Received type number');return eS(ei)}return em(ei,eo,ea)}function em(ei,eo,ea){if("string"==typeof ei)return eE(ei,eo);if(ArrayBuffer.isView(ei))return e_(ei);if(null==ei)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof ei);if(th(ei,ArrayBuffer)||ei&&th(ei.buffer,ArrayBuffer)||"undefined"!=typeof SharedArrayBuffer&&(th(ei,SharedArrayBuffer)||ei&&th(ei.buffer,SharedArrayBuffer)))return eT(ei,eo,ea);if("number"==typeof ei)throw TypeError('The "value" argument must not be of type number. Received type number');let ec=ei.valueOf&&ei.valueOf();if(null!=ec&&ec!==ei)return eg.from(ec,eo,ea);let ed=eI(ei);if(ed)return ed;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof ei[Symbol.toPrimitive])return eg.from(ei[Symbol.toPrimitive]("string"),eo,ea);throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof ei)}function ey(ei){if("number"!=typeof ei)throw TypeError('"size" argument must be of type number');if(ei<0)throw RangeError('The value "'+ei+'" is invalid for option "size"')}function eb(ei,eo,ea){return(ey(ei),ei<=0)?ep(ei):void 0!==eo?"string"==typeof ea?ep(ei).fill(eo,ea):ep(ei).fill(eo):ep(ei)}function eS(ei){return ey(ei),ep(ei<0?0:0|eC(ei))}function eE(ei,eo){if(("string"!=typeof eo||""===eo)&&(eo="utf8"),!eg.isEncoding(eo))throw TypeError("Unknown encoding: "+eo);let ea=0|eR(ei,eo),ec=ep(ea),ed=ec.write(ei,eo);return ed!==ea&&(ec=ec.slice(0,ed)),ec}function ew(ei){let eo=ei.length<0?0:0|eC(ei.length),ea=ep(eo);for(let ec=0;ec<eo;ec+=1)ea[ec]=255&ei[ec];return ea}function e_(ei){if(th(ei,Uint8Array)){let eo=new Uint8Array(ei);return eT(eo.buffer,eo.byteOffset,eo.byteLength)}return ew(ei)}function eT(ei,eo,ea){let ec;if(eo<0||ei.byteLength<eo)throw RangeError('"offset" is outside of buffer bounds');if(ei.byteLength<eo+(ea||0))throw RangeError('"length" is outside of buffer bounds');return Object.setPrototypeOf(ec=void 0===eo&&void 0===ea?new Uint8Array(ei):void 0===ea?new Uint8Array(ei,eo):new Uint8Array(ei,eo,ea),eg.prototype),ec}function eI(ei){if(eg.isBuffer(ei)){let eo=0|eC(ei.length),ea=ep(eo);return 0===ea.length||ei.copy(ea,0,0,eo),ea}return void 0!==ei.length?"number"!=typeof ei.length||tf(ei.length)?ep(0):ew(ei):"Buffer"===ei.type&&Array.isArray(ei.data)?ew(ei.data):void 0}function eC(ei){if(ei>=eh)throw RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+eh.toString(16)+" bytes");return 0|ei}function eO(ei){return+ei!=ei&&(ei=0),eg.alloc(+ei)}function eR(ei,eo){if(eg.isBuffer(ei))return ei.length;if(ArrayBuffer.isView(ei)||th(ei,ArrayBuffer))return ei.byteLength;if("string"!=typeof ei)throw TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof ei);let ea=ei.length,ec=arguments.length>2&&!0===arguments[2];if(!ec&&0===ea)return 0;let ed=!1;for(;;)switch(eo){case"ascii":case"latin1":case"binary":return ea;case"utf8":case"utf-8":return ti(ei).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*ea;case"hex":return ea>>>1;case"base64":return td(ei).length;default:if(ed)return ec?-1:ti(ei).length;eo=(""+eo).toLowerCase(),ed=!0}}function ek(ei,eo,ea){let ec=!1;if((void 0===eo||eo<0)&&(eo=0),eo>this.length||((void 0===ea||ea>this.length)&&(ea=this.length),ea<=0||(ea>>>=0)<=(eo>>>=0)))return"";for(ei||(ei="utf8");;)switch(ei){case"hex":return eG(this,eo,ea);case"utf8":case"utf-8":return eF(this,eo,ea);case"ascii":return eW(this,eo,ea);case"latin1":case"binary":return eV(this,eo,ea);case"base64":return eB(this,eo,ea);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return eH(this,eo,ea);default:if(ec)throw TypeError("Unknown encoding: "+ei);ei=(ei+"").toLowerCase(),ec=!0}}function eM(ei,eo,ea){let ec=ei[eo];ei[eo]=ei[ea],ei[ea]=ec}function eP(ei,eo,ea,ec,ed){if(0===ei.length)return -1;if("string"==typeof ea?(ec=ea,ea=0):ea>2147483647?ea=2147483647:ea<-2147483648&&(ea=-2147483648),tf(ea=+ea)&&(ea=ed?0:ei.length-1),ea<0&&(ea=ei.length+ea),ea>=ei.length){if(ed)return -1;ea=ei.length-1}else if(ea<0){if(!ed)return -1;ea=0}if("string"==typeof eo&&(eo=eg.from(eo,ec)),eg.isBuffer(eo))return 0===eo.length?-1:eA(ei,eo,ea,ec,ed);if("number"==typeof eo)return(eo&=255,"function"==typeof Uint8Array.prototype.indexOf)?ed?Uint8Array.prototype.indexOf.call(ei,eo,ea):Uint8Array.prototype.lastIndexOf.call(ei,eo,ea):eA(ei,[eo],ea,ec,ed);throw TypeError("val must be string, number or Buffer")}function eA(ei,eo,ea,ec,ed){let eu,eh=1,ef=ei.length,ep=eo.length;if(void 0!==ec&&("ucs2"===(ec=String(ec).toLowerCase())||"ucs-2"===ec||"utf16le"===ec||"utf-16le"===ec)){if(ei.length<2||eo.length<2)return -1;eh=2,ef/=2,ep/=2,ea/=2}function eg(ei,eo){return 1===eh?ei[eo]:ei.readUInt16BE(eo*eh)}if(ed){let ec=-1;for(eu=ea;eu<ef;eu++)if(eg(ei,eu)===eg(eo,-1===ec?0:eu-ec)){if(-1===ec&&(ec=eu),eu-ec+1===ep)return ec*eh}else -1!==ec&&(eu-=eu-ec),ec=-1}else for(ea+ep>ef&&(ea=ef-ep),eu=ea;eu>=0;eu--){let ea=!0;for(let ec=0;ec<ep;ec++)if(eg(ei,eu+ec)!==eg(eo,ec)){ea=!1;break}if(ea)return eu}return -1}function eD(ei,eo,ea,ec){let ed;ea=Number(ea)||0;let eu=ei.length-ea;ec?(ec=Number(ec))>eu&&(ec=eu):ec=eu;let eh=eo.length;for(ec>eh/2&&(ec=eh/2),ed=0;ed<ec;++ed){let ec=parseInt(eo.substr(2*ed,2),16);if(tf(ec))break;ei[ea+ed]=ec}return ed}function ej(ei,eo,ea,ec){return tu(ti(eo,ei.length-ea),ei,ea,ec)}function eL(ei,eo,ea,ec){return tu(ta(eo),ei,ea,ec)}function eN(ei,eo,ea,ec){return tu(td(eo),ei,ea,ec)}function eU(ei,eo,ea,ec){return tu(tc(eo,ei.length-ea),ei,ea,ec)}function eB(ei,eo,ea){return 0===eo&&ea===ei.length?ec.fromByteArray(ei):ec.fromByteArray(ei.slice(eo,ea))}function eF(ei,eo,ea){ea=Math.min(ei.length,ea);let ec=[],ed=eo;for(;ed<ea;){let eo=ei[ed],eu=null,eh=eo>239?4:eo>223?3:eo>191?2:1;if(ed+eh<=ea){let ea,ec,ef,ep;switch(eh){case 1:eo<128&&(eu=eo);break;case 2:(192&(ea=ei[ed+1]))==128&&(ep=(31&eo)<<6|63&ea)>127&&(eu=ep);break;case 3:ea=ei[ed+1],ec=ei[ed+2],(192&ea)==128&&(192&ec)==128&&(ep=(15&eo)<<12|(63&ea)<<6|63&ec)>2047&&(ep<55296||ep>57343)&&(eu=ep);break;case 4:ea=ei[ed+1],ec=ei[ed+2],ef=ei[ed+3],(192&ea)==128&&(192&ec)==128&&(192&ef)==128&&(ep=(15&eo)<<18|(63&ea)<<12|(63&ec)<<6|63&ef)>65535&&ep<1114112&&(eu=ep)}}null===eu?(eu=65533,eh=1):eu>65535&&(eu-=65536,ec.push(eu>>>10&1023|55296),eu=56320|1023&eu),ec.push(eu),ed+=eh}return e$(ec)}eo.kMaxLength=eh,eg.TYPED_ARRAY_SUPPORT=ef(),eg.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(eg.prototype,"parent",{enumerable:!0,get:function(){if(eg.isBuffer(this))return this.buffer}}),Object.defineProperty(eg.prototype,"offset",{enumerable:!0,get:function(){if(eg.isBuffer(this))return this.byteOffset}}),eg.poolSize=8192,eg.from=function(ei,eo,ea){return em(ei,eo,ea)},Object.setPrototypeOf(eg.prototype,Uint8Array.prototype),Object.setPrototypeOf(eg,Uint8Array),eg.alloc=function(ei,eo,ea){return eb(ei,eo,ea)},eg.allocUnsafe=function(ei){return eS(ei)},eg.allocUnsafeSlow=function(ei){return eS(ei)},eg.isBuffer=function(ei){return null!=ei&&!0===ei._isBuffer&&ei!==eg.prototype},eg.compare=function(ei,eo){if(th(ei,Uint8Array)&&(ei=eg.from(ei,ei.offset,ei.byteLength)),th(eo,Uint8Array)&&(eo=eg.from(eo,eo.offset,eo.byteLength)),!eg.isBuffer(ei)||!eg.isBuffer(eo))throw TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(ei===eo)return 0;let ea=ei.length,ec=eo.length;for(let ed=0,eu=Math.min(ea,ec);ed<eu;++ed)if(ei[ed]!==eo[ed]){ea=ei[ed],ec=eo[ed];break}return ea<ec?-1:ec<ea?1:0},eg.isEncoding=function(ei){switch(String(ei).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},eg.concat=function(ei,eo){let ea;if(!Array.isArray(ei))throw TypeError('"list" argument must be an Array of Buffers');if(0===ei.length)return eg.alloc(0);if(void 0===eo)for(ea=0,eo=0;ea<ei.length;++ea)eo+=ei[ea].length;let ec=eg.allocUnsafe(eo),ed=0;for(ea=0;ea<ei.length;++ea){let eo=ei[ea];if(th(eo,Uint8Array))ed+eo.length>ec.length?(eg.isBuffer(eo)||(eo=eg.from(eo)),eo.copy(ec,ed)):Uint8Array.prototype.set.call(ec,eo,ed);else if(eg.isBuffer(eo))eo.copy(ec,ed);else throw TypeError('"list" argument must be an Array of Buffers');ed+=eo.length}return ec},eg.byteLength=eR,eg.prototype._isBuffer=!0,eg.prototype.swap16=function(){let ei=this.length;if(ei%2!=0)throw RangeError("Buffer size must be a multiple of 16-bits");for(let eo=0;eo<ei;eo+=2)eM(this,eo,eo+1);return this},eg.prototype.swap32=function(){let ei=this.length;if(ei%4!=0)throw RangeError("Buffer size must be a multiple of 32-bits");for(let eo=0;eo<ei;eo+=4)eM(this,eo,eo+3),eM(this,eo+1,eo+2);return this},eg.prototype.swap64=function(){let ei=this.length;if(ei%8!=0)throw RangeError("Buffer size must be a multiple of 64-bits");for(let eo=0;eo<ei;eo+=8)eM(this,eo,eo+7),eM(this,eo+1,eo+6),eM(this,eo+2,eo+5),eM(this,eo+3,eo+4);return this},eg.prototype.toString=function(){let ei=this.length;return 0===ei?"":0==arguments.length?eF(this,0,ei):ek.apply(this,arguments)},eg.prototype.toLocaleString=eg.prototype.toString,eg.prototype.equals=function(ei){if(!eg.isBuffer(ei))throw TypeError("Argument must be a Buffer");return this===ei||0===eg.compare(this,ei)},eg.prototype.inspect=function(){let ei="",ea=eo.INSPECT_MAX_BYTES;return ei=this.toString("hex",0,ea).replace(/(.{2})/g,"$1 ").trim(),this.length>ea&&(ei+=" ... "),"<Buffer "+ei+">"},eu&&(eg.prototype[eu]=eg.prototype.inspect),eg.prototype.compare=function(ei,eo,ea,ec,ed){if(th(ei,Uint8Array)&&(ei=eg.from(ei,ei.offset,ei.byteLength)),!eg.isBuffer(ei))throw TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof ei);if(void 0===eo&&(eo=0),void 0===ea&&(ea=ei?ei.length:0),void 0===ec&&(ec=0),void 0===ed&&(ed=this.length),eo<0||ea>ei.length||ec<0||ed>this.length)throw RangeError("out of range index");if(ec>=ed&&eo>=ea)return 0;if(ec>=ed)return -1;if(eo>=ea)return 1;if(eo>>>=0,ea>>>=0,ec>>>=0,ed>>>=0,this===ei)return 0;let eu=ed-ec,eh=ea-eo,ef=Math.min(eu,eh),ep=this.slice(ec,ed),em=ei.slice(eo,ea);for(let ei=0;ei<ef;++ei)if(ep[ei]!==em[ei]){eu=ep[ei],eh=em[ei];break}return eu<eh?-1:eh<eu?1:0},eg.prototype.includes=function(ei,eo,ea){return -1!==this.indexOf(ei,eo,ea)},eg.prototype.indexOf=function(ei,eo,ea){return eP(this,ei,eo,ea,!0)},eg.prototype.lastIndexOf=function(ei,eo,ea){return eP(this,ei,eo,ea,!1)},eg.prototype.write=function(ei,eo,ea,ec){if(void 0===eo)ec="utf8",ea=this.length,eo=0;else if(void 0===ea&&"string"==typeof eo)ec=eo,ea=this.length,eo=0;else if(isFinite(eo))eo>>>=0,isFinite(ea)?(ea>>>=0,void 0===ec&&(ec="utf8")):(ec=ea,ea=void 0);else throw Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let ed=this.length-eo;if((void 0===ea||ea>ed)&&(ea=ed),ei.length>0&&(ea<0||eo<0)||eo>this.length)throw RangeError("Attempt to write outside buffer bounds");ec||(ec="utf8");let eu=!1;for(;;)switch(ec){case"hex":return eD(this,ei,eo,ea);case"utf8":case"utf-8":return ej(this,ei,eo,ea);case"ascii":case"latin1":case"binary":return eL(this,ei,eo,ea);case"base64":return eN(this,ei,eo,ea);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return eU(this,ei,eo,ea);default:if(eu)throw TypeError("Unknown encoding: "+ec);ec=(""+ec).toLowerCase(),eu=!0}},eg.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};let eK=4096;function e$(ei){let eo=ei.length;if(eo<=eK)return String.fromCharCode.apply(String,ei);let ea="",ec=0;for(;ec<eo;)ea+=String.fromCharCode.apply(String,ei.slice(ec,ec+=eK));return ea}function eW(ei,eo,ea){let ec="";ea=Math.min(ei.length,ea);for(let ed=eo;ed<ea;++ed)ec+=String.fromCharCode(127&ei[ed]);return ec}function eV(ei,eo,ea){let ec="";ea=Math.min(ei.length,ea);for(let ed=eo;ed<ea;++ed)ec+=String.fromCharCode(ei[ed]);return ec}function eG(ei,eo,ea){let ec=ei.length;(!eo||eo<0)&&(eo=0),(!ea||ea<0||ea>ec)&&(ea=ec);let ed="";for(let ec=eo;ec<ea;++ec)ed+=tp[ei[ec]];return ed}function eH(ei,eo,ea){let ec=ei.slice(eo,ea),ed="";for(let ei=0;ei<ec.length-1;ei+=2)ed+=String.fromCharCode(ec[ei]+256*ec[ei+1]);return ed}function ez(ei,eo,ea){if(ei%1!=0||ei<0)throw RangeError("offset is not uint");if(ei+eo>ea)throw RangeError("Trying to access beyond buffer length")}function eY(ei,eo,ea,ec,ed,eu){if(!eg.isBuffer(ei))throw TypeError('"buffer" argument must be a Buffer instance');if(eo>ed||eo<eu)throw RangeError('"value" argument is out of bounds');if(ea+ec>ei.length)throw RangeError("Index out of range")}function eJ(ei,eo,ea,ec,ed){e4(eo,ec,ed,ei,ea,7);let eu=Number(eo&BigInt(4294967295));ei[ea++]=eu,eu>>=8,ei[ea++]=eu,eu>>=8,ei[ea++]=eu,eu>>=8,ei[ea++]=eu;let eh=Number(eo>>BigInt(32)&BigInt(4294967295));return ei[ea++]=eh,eh>>=8,ei[ea++]=eh,eh>>=8,ei[ea++]=eh,eh>>=8,ei[ea++]=eh,ea}function eQ(ei,eo,ea,ec,ed){e4(eo,ec,ed,ei,ea,7);let eu=Number(eo&BigInt(4294967295));ei[ea+7]=eu,eu>>=8,ei[ea+6]=eu,eu>>=8,ei[ea+5]=eu,eu>>=8,ei[ea+4]=eu;let eh=Number(eo>>BigInt(32)&BigInt(4294967295));return ei[ea+3]=eh,eh>>=8,ei[ea+2]=eh,eh>>=8,ei[ea+1]=eh,eh>>=8,ei[ea]=eh,ea+8}function eX(ei,eo,ea,ec,ed,eu){if(ea+ec>ei.length||ea<0)throw RangeError("Index out of range")}function eZ(ei,eo,ea,ec,eu){return eo=+eo,ea>>>=0,eu||eX(ei,eo,ea,4,34028234663852886e22,-34028234663852886e22),ed.write(ei,eo,ea,ec,23,4),ea+4}function e0(ei,eo,ea,ec,eu){return eo=+eo,ea>>>=0,eu||eX(ei,eo,ea,8,17976931348623157e292,-17976931348623157e292),ed.write(ei,eo,ea,ec,52,8),ea+8}eg.prototype.slice=function(ei,eo){let ea=this.length;ei=~~ei,eo=void 0===eo?ea:~~eo,ei<0?(ei+=ea)<0&&(ei=0):ei>ea&&(ei=ea),eo<0?(eo+=ea)<0&&(eo=0):eo>ea&&(eo=ea),eo<ei&&(eo=ei);let ec=this.subarray(ei,eo);return Object.setPrototypeOf(ec,eg.prototype),ec},eg.prototype.readUintLE=eg.prototype.readUIntLE=function(ei,eo,ea){ei>>>=0,eo>>>=0,ea||ez(ei,eo,this.length);let ec=this[ei],ed=1,eu=0;for(;++eu<eo&&(ed*=256);)ec+=this[ei+eu]*ed;return ec},eg.prototype.readUintBE=eg.prototype.readUIntBE=function(ei,eo,ea){ei>>>=0,eo>>>=0,ea||ez(ei,eo,this.length);let ec=this[ei+--eo],ed=1;for(;eo>0&&(ed*=256);)ec+=this[ei+--eo]*ed;return ec},eg.prototype.readUint8=eg.prototype.readUInt8=function(ei,eo){return ei>>>=0,eo||ez(ei,1,this.length),this[ei]},eg.prototype.readUint16LE=eg.prototype.readUInt16LE=function(ei,eo){return ei>>>=0,eo||ez(ei,2,this.length),this[ei]|this[ei+1]<<8},eg.prototype.readUint16BE=eg.prototype.readUInt16BE=function(ei,eo){return ei>>>=0,eo||ez(ei,2,this.length),this[ei]<<8|this[ei+1]},eg.prototype.readUint32LE=eg.prototype.readUInt32LE=function(ei,eo){return ei>>>=0,eo||ez(ei,4,this.length),(this[ei]|this[ei+1]<<8|this[ei+2]<<16)+16777216*this[ei+3]},eg.prototype.readUint32BE=eg.prototype.readUInt32BE=function(ei,eo){return ei>>>=0,eo||ez(ei,4,this.length),16777216*this[ei]+(this[ei+1]<<16|this[ei+2]<<8|this[ei+3])},eg.prototype.readBigUInt64LE=tg(function(ei){e5(ei>>>=0,"offset");let eo=this[ei],ea=this[ei+7];(void 0===eo||void 0===ea)&&e8(ei,this.length-8);let ec=eo+256*this[++ei]+65536*this[++ei]+16777216*this[++ei],ed=this[++ei]+256*this[++ei]+65536*this[++ei]+16777216*ea;return BigInt(ec)+(BigInt(ed)<<BigInt(32))}),eg.prototype.readBigUInt64BE=tg(function(ei){e5(ei>>>=0,"offset");let eo=this[ei],ea=this[ei+7];(void 0===eo||void 0===ea)&&e8(ei,this.length-8);let ec=16777216*eo+65536*this[++ei]+256*this[++ei]+this[++ei],ed=16777216*this[++ei]+65536*this[++ei]+256*this[++ei]+ea;return(BigInt(ec)<<BigInt(32))+BigInt(ed)}),eg.prototype.readIntLE=function(ei,eo,ea){ei>>>=0,eo>>>=0,ea||ez(ei,eo,this.length);let ec=this[ei],ed=1,eu=0;for(;++eu<eo&&(ed*=256);)ec+=this[ei+eu]*ed;return ec>=(ed*=128)&&(ec-=Math.pow(2,8*eo)),ec},eg.prototype.readIntBE=function(ei,eo,ea){ei>>>=0,eo>>>=0,ea||ez(ei,eo,this.length);let ec=eo,ed=1,eu=this[ei+--ec];for(;ec>0&&(ed*=256);)eu+=this[ei+--ec]*ed;return eu>=(ed*=128)&&(eu-=Math.pow(2,8*eo)),eu},eg.prototype.readInt8=function(ei,eo){return(ei>>>=0,eo||ez(ei,1,this.length),128&this[ei])?-((255-this[ei]+1)*1):this[ei]},eg.prototype.readInt16LE=function(ei,eo){ei>>>=0,eo||ez(ei,2,this.length);let ea=this[ei]|this[ei+1]<<8;return 32768&ea?4294901760|ea:ea},eg.prototype.readInt16BE=function(ei,eo){ei>>>=0,eo||ez(ei,2,this.length);let ea=this[ei+1]|this[ei]<<8;return 32768&ea?4294901760|ea:ea},eg.prototype.readInt32LE=function(ei,eo){return ei>>>=0,eo||ez(ei,4,this.length),this[ei]|this[ei+1]<<8|this[ei+2]<<16|this[ei+3]<<24},eg.prototype.readInt32BE=function(ei,eo){return ei>>>=0,eo||ez(ei,4,this.length),this[ei]<<24|this[ei+1]<<16|this[ei+2]<<8|this[ei+3]},eg.prototype.readBigInt64LE=tg(function(ei){e5(ei>>>=0,"offset");let eo=this[ei],ea=this[ei+7];(void 0===eo||void 0===ea)&&e8(ei,this.length-8);let ec=this[ei+4]+256*this[ei+5]+65536*this[ei+6]+(ea<<24);return(BigInt(ec)<<BigInt(32))+BigInt(eo+256*this[++ei]+65536*this[++ei]+16777216*this[++ei])}),eg.prototype.readBigInt64BE=tg(function(ei){e5(ei>>>=0,"offset");let eo=this[ei],ea=this[ei+7];(void 0===eo||void 0===ea)&&e8(ei,this.length-8);let ec=(eo<<24)+65536*this[++ei]+256*this[++ei]+this[++ei];return(BigInt(ec)<<BigInt(32))+BigInt(16777216*this[++ei]+65536*this[++ei]+256*this[++ei]+ea)}),eg.prototype.readFloatLE=function(ei,eo){return ei>>>=0,eo||ez(ei,4,this.length),ed.read(this,ei,!0,23,4)},eg.prototype.readFloatBE=function(ei,eo){return ei>>>=0,eo||ez(ei,4,this.length),ed.read(this,ei,!1,23,4)},eg.prototype.readDoubleLE=function(ei,eo){return ei>>>=0,eo||ez(ei,8,this.length),ed.read(this,ei,!0,52,8)},eg.prototype.readDoubleBE=function(ei,eo){return ei>>>=0,eo||ez(ei,8,this.length),ed.read(this,ei,!1,52,8)},eg.prototype.writeUintLE=eg.prototype.writeUIntLE=function(ei,eo,ea,ec){if(ei=+ei,eo>>>=0,ea>>>=0,!ec){let ec=Math.pow(2,8*ea)-1;eY(this,ei,eo,ea,ec,0)}let ed=1,eu=0;for(this[eo]=255&ei;++eu<ea&&(ed*=256);)this[eo+eu]=ei/ed&255;return eo+ea},eg.prototype.writeUintBE=eg.prototype.writeUIntBE=function(ei,eo,ea,ec){if(ei=+ei,eo>>>=0,ea>>>=0,!ec){let ec=Math.pow(2,8*ea)-1;eY(this,ei,eo,ea,ec,0)}let ed=ea-1,eu=1;for(this[eo+ed]=255&ei;--ed>=0&&(eu*=256);)this[eo+ed]=ei/eu&255;return eo+ea},eg.prototype.writeUint8=eg.prototype.writeUInt8=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,1,255,0),this[eo]=255&ei,eo+1},eg.prototype.writeUint16LE=eg.prototype.writeUInt16LE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,2,65535,0),this[eo]=255&ei,this[eo+1]=ei>>>8,eo+2},eg.prototype.writeUint16BE=eg.prototype.writeUInt16BE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,2,65535,0),this[eo]=ei>>>8,this[eo+1]=255&ei,eo+2},eg.prototype.writeUint32LE=eg.prototype.writeUInt32LE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,4,4294967295,0),this[eo+3]=ei>>>24,this[eo+2]=ei>>>16,this[eo+1]=ei>>>8,this[eo]=255&ei,eo+4},eg.prototype.writeUint32BE=eg.prototype.writeUInt32BE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,4,4294967295,0),this[eo]=ei>>>24,this[eo+1]=ei>>>16,this[eo+2]=ei>>>8,this[eo+3]=255&ei,eo+4},eg.prototype.writeBigUInt64LE=tg(function(ei,eo=0){return eJ(this,ei,eo,BigInt(0),BigInt("0xffffffffffffffff"))}),eg.prototype.writeBigUInt64BE=tg(function(ei,eo=0){return eQ(this,ei,eo,BigInt(0),BigInt("0xffffffffffffffff"))}),eg.prototype.writeIntLE=function(ei,eo,ea,ec){if(ei=+ei,eo>>>=0,!ec){let ec=Math.pow(2,8*ea-1);eY(this,ei,eo,ea,ec-1,-ec)}let ed=0,eu=1,eh=0;for(this[eo]=255&ei;++ed<ea&&(eu*=256);)ei<0&&0===eh&&0!==this[eo+ed-1]&&(eh=1),this[eo+ed]=(ei/eu>>0)-eh&255;return eo+ea},eg.prototype.writeIntBE=function(ei,eo,ea,ec){if(ei=+ei,eo>>>=0,!ec){let ec=Math.pow(2,8*ea-1);eY(this,ei,eo,ea,ec-1,-ec)}let ed=ea-1,eu=1,eh=0;for(this[eo+ed]=255&ei;--ed>=0&&(eu*=256);)ei<0&&0===eh&&0!==this[eo+ed+1]&&(eh=1),this[eo+ed]=(ei/eu>>0)-eh&255;return eo+ea},eg.prototype.writeInt8=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,1,127,-128),ei<0&&(ei=255+ei+1),this[eo]=255&ei,eo+1},eg.prototype.writeInt16LE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,2,32767,-32768),this[eo]=255&ei,this[eo+1]=ei>>>8,eo+2},eg.prototype.writeInt16BE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,2,32767,-32768),this[eo]=ei>>>8,this[eo+1]=255&ei,eo+2},eg.prototype.writeInt32LE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,4,2147483647,-2147483648),this[eo]=255&ei,this[eo+1]=ei>>>8,this[eo+2]=ei>>>16,this[eo+3]=ei>>>24,eo+4},eg.prototype.writeInt32BE=function(ei,eo,ea){return ei=+ei,eo>>>=0,ea||eY(this,ei,eo,4,2147483647,-2147483648),ei<0&&(ei=4294967295+ei+1),this[eo]=ei>>>24,this[eo+1]=ei>>>16,this[eo+2]=ei>>>8,this[eo+3]=255&ei,eo+4},eg.prototype.writeBigInt64LE=tg(function(ei,eo=0){return eJ(this,ei,eo,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),eg.prototype.writeBigInt64BE=tg(function(ei,eo=0){return eQ(this,ei,eo,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),eg.prototype.writeFloatLE=function(ei,eo,ea){return eZ(this,ei,eo,!0,ea)},eg.prototype.writeFloatBE=function(ei,eo,ea){return eZ(this,ei,eo,!1,ea)},eg.prototype.writeDoubleLE=function(ei,eo,ea){return e0(this,ei,eo,!0,ea)},eg.prototype.writeDoubleBE=function(ei,eo,ea){return e0(this,ei,eo,!1,ea)},eg.prototype.copy=function(ei,eo,ea,ec){if(!eg.isBuffer(ei))throw TypeError("argument should be a Buffer");if(ea||(ea=0),ec||0===ec||(ec=this.length),eo>=ei.length&&(eo=ei.length),eo||(eo=0),ec>0&&ec<ea&&(ec=ea),ec===ea||0===ei.length||0===this.length)return 0;if(eo<0)throw RangeError("targetStart out of bounds");if(ea<0||ea>=this.length)throw RangeError("Index out of range");if(ec<0)throw RangeError("sourceEnd out of bounds");ec>this.length&&(ec=this.length),ei.length-eo<ec-ea&&(ec=ei.length-eo+ea);let ed=ec-ea;return this===ei&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(eo,ea,ec):Uint8Array.prototype.set.call(ei,this.subarray(ea,ec),eo),ed},eg.prototype.fill=function(ei,eo,ea,ec){let ed;if("string"==typeof ei){if("string"==typeof eo?(ec=eo,eo=0,ea=this.length):"string"==typeof ea&&(ec=ea,ea=this.length),void 0!==ec&&"string"!=typeof ec)throw TypeError("encoding must be a string");if("string"==typeof ec&&!eg.isEncoding(ec))throw TypeError("Unknown encoding: "+ec);if(1===ei.length){let eo=ei.charCodeAt(0);("utf8"===ec&&eo<128||"latin1"===ec)&&(ei=eo)}}else"number"==typeof ei?ei&=255:"boolean"==typeof ei&&(ei=Number(ei));if(eo<0||this.length<eo||this.length<ea)throw RangeError("Out of range index");if(ea<=eo)return this;if(eo>>>=0,ea=void 0===ea?this.length:ea>>>0,ei||(ei=0),"number"==typeof ei)for(ed=eo;ed<ea;++ed)this[ed]=ei;else{let eu=eg.isBuffer(ei)?ei:eg.from(ei,ec),eh=eu.length;if(0===eh)throw TypeError('The value "'+ei+'" is invalid for argument "value"');for(ed=0;ed<ea-eo;++ed)this[ed+eo]=eu[ed%eh]}return this};let e1={};function e2(ei,eo,ea){e1[ei]=class extends ea{constructor(){super(),Object.defineProperty(this,"message",{value:eo.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${ei}]`,this.stack,delete this.name}get code(){return ei}set code(ei){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:ei,writable:!0})}toString(){return`${this.name} [${ei}]: ${this.message}`}}}function e3(ei){let eo="",ea=ei.length,ec="-"===ei[0]?1:0;for(;ea>=ec+4;ea-=3)eo=`_${ei.slice(ea-3,ea)}${eo}`;return`${ei.slice(0,ea)}${eo}`}function e6(ei,eo,ea){e5(eo,"offset"),(void 0===ei[eo]||void 0===ei[eo+ea])&&e8(eo,ei.length-(ea+1))}function e4(ei,eo,ea,ec,ed,eu){if(ei>ea||ei<eo){let ec;let ed="bigint"==typeof eo?"n":"";throw ec=eu>3?0===eo||eo===BigInt(0)?`>= 0${ed} and < 2${ed} ** ${(eu+1)*8}${ed}`:`>= -(2${ed} ** ${(eu+1)*8-1}${ed}) and < 2 ** ${(eu+1)*8-1}${ed}`:`>= ${eo}${ed} and <= ${ea}${ed}`,new e1.ERR_OUT_OF_RANGE("value",ec,ei)}e6(ec,ed,eu)}function e5(ei,eo){if("number"!=typeof ei)throw new e1.ERR_INVALID_ARG_TYPE(eo,"number",ei)}function e8(ei,eo,ea){if(Math.floor(ei)!==ei)throw e5(ei,ea),new e1.ERR_OUT_OF_RANGE(ea||"offset","an integer",ei);if(eo<0)throw new e1.ERR_BUFFER_OUT_OF_BOUNDS;throw new e1.ERR_OUT_OF_RANGE(ea||"offset",`>= ${ea?1:0} and <= ${eo}`,ei)}e2("ERR_BUFFER_OUT_OF_BOUNDS",function(ei){return ei?`${ei} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),e2("ERR_INVALID_ARG_TYPE",function(ei,eo){return`The "${ei}" argument must be of type number. Received type ${typeof eo}`},TypeError),e2("ERR_OUT_OF_RANGE",function(ei,eo,ea){let ec=`The value of "${ei}" is out of range.`,ed=ea;return Number.isInteger(ea)&&Math.abs(ea)>4294967296?ed=e3(String(ea)):"bigint"==typeof ea&&(ed=String(ea),(ea>BigInt(2)**BigInt(32)||ea<-(BigInt(2)**BigInt(32)))&&(ed=e3(ed)),ed+="n"),ec+=` It must be ${eo}. Received ${ed}`},RangeError);let e7=/[^+/0-9A-Za-z-_]/g;function e9(ei){if((ei=(ei=ei.split("=")[0]).trim().replace(e7,"")).length<2)return"";for(;ei.length%4!=0;)ei+="=";return ei}function ti(ei,eo){let ea;eo=eo||1/0;let ec=ei.length,ed=null,eu=[];for(let eh=0;eh<ec;++eh){if((ea=ei.charCodeAt(eh))>55295&&ea<57344){if(!ed){if(ea>56319||eh+1===ec){(eo-=3)>-1&&eu.push(239,191,189);continue}ed=ea;continue}if(ea<56320){(eo-=3)>-1&&eu.push(239,191,189),ed=ea;continue}ea=(ed-55296<<10|ea-56320)+65536}else ed&&(eo-=3)>-1&&eu.push(239,191,189);if(ed=null,ea<128){if((eo-=1)<0)break;eu.push(ea)}else if(ea<2048){if((eo-=2)<0)break;eu.push(ea>>6|192,63&ea|128)}else if(ea<65536){if((eo-=3)<0)break;eu.push(ea>>12|224,ea>>6&63|128,63&ea|128)}else if(ea<1114112){if((eo-=4)<0)break;eu.push(ea>>18|240,ea>>12&63|128,ea>>6&63|128,63&ea|128)}else throw Error("Invalid code point")}return eu}function ta(ei){let eo=[];for(let ea=0;ea<ei.length;++ea)eo.push(255&ei.charCodeAt(ea));return eo}function tc(ei,eo){let ea,ec;let ed=[];for(let eu=0;eu<ei.length&&!((eo-=2)<0);++eu)ec=(ea=ei.charCodeAt(eu))>>8,ed.push(ea%256),ed.push(ec);return ed}function td(ei){return ec.toByteArray(e9(ei))}function tu(ei,eo,ea,ec){let ed;for(ed=0;ed<ec&&!(ed+ea>=eo.length)&&!(ed>=ei.length);++ed)eo[ed+ea]=ei[ed];return ed}function th(ei,eo){return ei instanceof eo||null!=ei&&null!=ei.constructor&&null!=ei.constructor.name&&ei.constructor.name===eo.name}function tf(ei){return ei!=ei}let tp=function(){let ei="0123456789abcdef",eo=Array(256);for(let ea=0;ea<16;++ea){let ec=16*ea;for(let ed=0;ed<16;++ed)eo[ec+ed]=ei[ea]+ei[ed]}return eo}();function tg(ei){return"undefined"==typeof BigInt?tv:ei}function tv(){throw Error("BigInt not supported")}},7811:function(ei,eo){"use strict";/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var ea=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,ec=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,ed=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,eu=/\\([\u000b\u0020-\u00ff])/g,eh=/([\\"])/g,ef=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function ep(ei){if(!ei||"object"!=typeof ei)throw TypeError("argument obj is required");var eo=ei.parameters,ea=ei.type;if(!ea||!ef.test(ea))throw TypeError("invalid type");var ec=ea;if(eo&&"object"==typeof eo)for(var eu,eh=Object.keys(eo).sort(),ep=0;ep<eh.length;ep++){if(eu=eh[ep],!ed.test(eu))throw TypeError("invalid parameter name");ec+="; "+eu+"="+ey(eo[eu])}return ec}function eg(ei){if(!ei)throw TypeError("argument string is required");var eo,ec,ed,eh="object"==typeof ei?em(ei):ei;if("string"!=typeof eh)throw TypeError("argument string is required to be a string");var ep=eh.indexOf(";"),eg=-1!==ep?eh.slice(0,ep).trim():eh.trim();if(!ef.test(eg))throw TypeError("invalid media type");var ey=new eb(eg.toLowerCase());if(-1!==ep){for(ea.lastIndex=ep;ec=ea.exec(eh);){if(ec.index!==ep)throw TypeError("invalid parameter format");ep+=ec[0].length,eo=ec[1].toLowerCase(),34===(ed=ec[2]).charCodeAt(0)&&-1!==(ed=ed.slice(1,-1)).indexOf("\\")&&(ed=ed.replace(eu,"$1")),ey.parameters[eo]=ed}if(ep!==eh.length)throw TypeError("invalid parameter format")}return ey}function em(ei){var eo;if("function"==typeof ei.getHeader?eo=ei.getHeader("content-type"):"object"==typeof ei.headers&&(eo=ei.headers&&ei.headers["content-type"]),"string"!=typeof eo)throw TypeError("content-type header is missing from object");return eo}function ey(ei){var eo=String(ei);if(ed.test(eo))return eo;if(eo.length>0&&!ec.test(eo))throw TypeError("invalid parameter value");return'"'+eo.replace(eh,"\\$1")+'"'}function eb(ei){this.parameters=Object.create(null),this.type=ei}eo.format=ep,eo.parse=eg},1227:function(ei,eo,ea){var ec=ea(3454);function ed(){return"undefined"!=typeof window&&!!window.process&&("renderer"===window.process.type||!!window.process.__nwjs)||!("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))}function eu(eo){if(eo[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+eo[0]+(this.useColors?"%c ":" ")+"+"+ei.exports.humanize(this.diff),!this.useColors)return;let ea="color: "+this.color;eo.splice(1,0,ea,"color: inherit");let ec=0,ed=0;eo[0].replace(/%[a-zA-Z%]/g,ei=>{"%%"!==ei&&(ec++,"%c"===ei&&(ed=ec))}),eo.splice(ed,0,ea)}function eh(ei){try{ei?eo.storage.setItem("debug",ei):eo.storage.removeItem("debug")}catch(ei){}}function ef(){let ei;try{ei=eo.storage.getItem("debug")}catch(ei){}return!ei&&void 0!==ec&&"env"in ec&&(ei=ec.env.DEBUG),ei}function ep(){try{return localStorage}catch(ei){}}eo.formatArgs=eu,eo.save=eh,eo.load=ef,eo.useColors=ed,eo.storage=ep(),eo.destroy=(()=>{let ei=!1;return()=>{ei||(ei=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),eo.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],eo.log=console.debug||console.log||(()=>{}),ei.exports=ea(2447)(eo);let{formatters:eg}=ei.exports;eg.j=function(ei){try{return JSON.stringify(ei)}catch(ei){return"[UnexpectedJSONParseError]: "+ei.message}}},2447:function(ei,eo,ea){function ec(ei){function eo(ei){let eo=0;for(let ea=0;ea<ei.length;ea++)eo=(eo<<5)-eo+ei.charCodeAt(ea)|0;return ec.colors[Math.abs(eo)%ec.colors.length]}function ec(ei){let eo,ea,eu;let eh=null;function ef(...ei){if(!ef.enabled)return;let ea=ef,ed=Number(new Date),eu=ed-(eo||ed);ea.diff=eu,ea.prev=eo,ea.curr=ed,eo=ed,ei[0]=ec.coerce(ei[0]),"string"!=typeof ei[0]&&ei.unshift("%O");let eh=0;ei[0]=ei[0].replace(/%([a-zA-Z%])/g,(eo,ed)=>{if("%%"===eo)return"%";eh++;let eu=ec.formatters[ed];if("function"==typeof eu){let ec=ei[eh];eo=eu.call(ea,ec),ei.splice(eh,1),eh--}return eo}),ec.formatArgs.call(ea,ei);let ep=ea.log||ec.log;ep.apply(ea,ei)}return ef.namespace=ei,ef.useColors=ec.useColors(),ef.color=ec.selectColor(ei),ef.extend=ed,ef.destroy=ec.destroy,Object.defineProperty(ef,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==eh?eh:(ea!==ec.namespaces&&(ea=ec.namespaces,eu=ec.enabled(ei)),eu),set:ei=>{eh=ei}}),"function"==typeof ec.init&&ec.init(ef),ef}function ed(ei,eo){let ea=ec(this.namespace+(void 0===eo?":":eo)+ei);return ea.log=this.log,ea}function eu(ei){let eo;ec.save(ei),ec.namespaces=ei,ec.names=[],ec.skips=[];let ea=("string"==typeof ei?ei:"").split(/[\s,]+/),ed=ea.length;for(eo=0;eo<ed;eo++)ea[eo]&&("-"===(ei=ea[eo].replace(/\*/g,".*?"))[0]?ec.skips.push(RegExp("^"+ei.slice(1)+"$")):ec.names.push(RegExp("^"+ei+"$")))}function eh(){let ei=[...ec.names.map(ep),...ec.skips.map(ep).map(ei=>"-"+ei)].join(",");return ec.enable(""),ei}function ef(ei){let eo,ea;if("*"===ei[ei.length-1])return!0;for(eo=0,ea=ec.skips.length;eo<ea;eo++)if(ec.skips[eo].test(ei))return!1;for(eo=0,ea=ec.names.length;eo<ea;eo++)if(ec.names[eo].test(ei))return!0;return!1}function ep(ei){return ei.toString().substring(2,ei.toString().length-2).replace(/\.\*\?$/,"*")}function eg(ei){return ei instanceof Error?ei.stack||ei.message:ei}function em(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return ec.debug=ec,ec.default=ec,ec.coerce=eg,ec.disable=eh,ec.enable=eu,ec.enabled=ef,ec.humanize=ea(7824),ec.destroy=em,Object.keys(ei).forEach(eo=>{ec[eo]=ei[eo]}),ec.names=[],ec.skips=[],ec.formatters={},ec.selectColor=eo,ec.enable(ec.load()),ec}ei.exports=ec},2114:function(ei){"use strict";function eo(ei,eo){for(let ea in eo)Object.defineProperty(ei,ea,{value:eo[ea],enumerable:!0,configurable:!0});return ei}function ea(ei,ea,ec){if(!ei||"string"==typeof ei)throw TypeError("Please pass an Error to err-code");ec||(ec={}),"object"==typeof ea&&(ec=ea,ea=""),ea&&(ec.code=ea);try{return eo(ei,ec)}catch(eu){ec.message=ei.message,ec.stack=ei.stack;let ea=function(){};ea.prototype=Object.create(Object.getPrototypeOf(ei));let ed=eo(new ea,ec);return ed}}ei.exports=ea},7187:function(ei){"use strict";var eo,ea="object"==typeof Reflect?Reflect:null,ec=ea&&"function"==typeof ea.apply?ea.apply:function(ei,eo,ea){return Function.prototype.apply.call(ei,eo,ea)};function ed(ei){console&&console.warn&&console.warn(ei)}eo=ea&&"function"==typeof ea.ownKeys?ea.ownKeys:Object.getOwnPropertySymbols?function(ei){return Object.getOwnPropertyNames(ei).concat(Object.getOwnPropertySymbols(ei))}:function(ei){return Object.getOwnPropertyNames(ei)};var eu=Number.isNaN||function(ei){return ei!=ei};function eh(){eh.init.call(this)}ei.exports=eh,ei.exports.once=eI,eh.EventEmitter=eh,eh.prototype._events=void 0,eh.prototype._eventsCount=0,eh.prototype._maxListeners=void 0;var ef=10;function ep(ei){if("function"!=typeof ei)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof ei)}function eg(ei){return void 0===ei._maxListeners?eh.defaultMaxListeners:ei._maxListeners}function em(ei,eo,ea,ec){if(ep(ea),void 0===(eh=ei._events)?(eh=ei._events=Object.create(null),ei._eventsCount=0):(void 0!==eh.newListener&&(ei.emit("newListener",eo,ea.listener?ea.listener:ea),eh=ei._events),ef=eh[eo]),void 0===ef)ef=eh[eo]=ea,++ei._eventsCount;else if("function"==typeof ef?ef=eh[eo]=ec?[ea,ef]:[ef,ea]:ec?ef.unshift(ea):ef.push(ea),(eu=eg(ei))>0&&ef.length>eu&&!ef.warned){ef.warned=!0;var eu,eh,ef,em=Error("Possible EventEmitter memory leak detected. "+ef.length+" "+String(eo)+" listeners added. Use emitter.setMaxListeners() to increase limit");em.name="MaxListenersExceededWarning",em.emitter=ei,em.type=eo,em.count=ef.length,ed(em)}return ei}function ey(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function eb(ei,eo,ea){var ec={fired:!1,wrapFn:void 0,target:ei,type:eo,listener:ea},ed=ey.bind(ec);return ed.listener=ea,ec.wrapFn=ed,ed}function eS(ei,eo,ea){var ec=ei._events;if(void 0===ec)return[];var ed=ec[eo];return void 0===ed?[]:"function"==typeof ed?ea?[ed.listener||ed]:[ed]:ea?eT(ed):ew(ed,ed.length)}function eE(ei){var eo=this._events;if(void 0!==eo){var ea=eo[ei];if("function"==typeof ea)return 1;if(void 0!==ea)return ea.length}return 0}function ew(ei,eo){for(var ea=Array(eo),ec=0;ec<eo;++ec)ea[ec]=ei[ec];return ea}function e_(ei,eo){for(;eo+1<ei.length;eo++)ei[eo]=ei[eo+1];ei.pop()}function eT(ei){for(var eo=Array(ei.length),ea=0;ea<eo.length;++ea)eo[ea]=ei[ea].listener||ei[ea];return eo}function eI(ei,eo){return new Promise(function(ea,ec){function ed(ea){ei.removeListener(eo,eu),ec(ea)}function eu(){"function"==typeof ei.removeListener&&ei.removeListener("error",ed),ea([].slice.call(arguments))}eO(ei,eo,eu,{once:!0}),"error"!==eo&&eC(ei,ed,{once:!0})})}function eC(ei,eo,ea){"function"==typeof ei.on&&eO(ei,"error",eo,ea)}function eO(ei,eo,ea,ec){if("function"==typeof ei.on)ec.once?ei.once(eo,ea):ei.on(eo,ea);else if("function"==typeof ei.addEventListener)ei.addEventListener(eo,function ed(eu){ec.once&&ei.removeEventListener(eo,ed),ea(eu)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof ei)}Object.defineProperty(eh,"defaultMaxListeners",{enumerable:!0,get:function(){return ef},set:function(ei){if("number"!=typeof ei||ei<0||eu(ei))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+ei+".");ef=ei}}),eh.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},eh.prototype.setMaxListeners=function(ei){if("number"!=typeof ei||ei<0||eu(ei))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+ei+".");return this._maxListeners=ei,this},eh.prototype.getMaxListeners=function(){return eg(this)},eh.prototype.emit=function(ei){for(var eo=[],ea=1;ea<arguments.length;ea++)eo.push(arguments[ea]);var ed="error"===ei,eu=this._events;if(void 0!==eu)ed=ed&&void 0===eu.error;else if(!ed)return!1;if(ed){if(eo.length>0&&(eh=eo[0]),eh instanceof Error)throw eh;var eh,ef=Error("Unhandled error."+(eh?" ("+eh.message+")":""));throw ef.context=eh,ef}var ep=eu[ei];if(void 0===ep)return!1;if("function"==typeof ep)ec(ep,this,eo);else for(var eg=ep.length,em=ew(ep,eg),ea=0;ea<eg;++ea)ec(em[ea],this,eo);return!0},eh.prototype.addListener=function(ei,eo){return em(this,ei,eo,!1)},eh.prototype.on=eh.prototype.addListener,eh.prototype.prependListener=function(ei,eo){return em(this,ei,eo,!0)},eh.prototype.once=function(ei,eo){return ep(eo),this.on(ei,eb(this,ei,eo)),this},eh.prototype.prependOnceListener=function(ei,eo){return ep(eo),this.prependListener(ei,eb(this,ei,eo)),this},eh.prototype.removeListener=function(ei,eo){var ea,ec,ed,eu,eh;if(ep(eo),void 0===(ec=this._events)||void 0===(ea=ec[ei]))return this;if(ea===eo||ea.listener===eo)0==--this._eventsCount?this._events=Object.create(null):(delete ec[ei],ec.removeListener&&this.emit("removeListener",ei,ea.listener||eo));else if("function"!=typeof ea){for(ed=-1,eu=ea.length-1;eu>=0;eu--)if(ea[eu]===eo||ea[eu].listener===eo){eh=ea[eu].listener,ed=eu;break}if(ed<0)return this;0===ed?ea.shift():e_(ea,ed),1===ea.length&&(ec[ei]=ea[0]),void 0!==ec.removeListener&&this.emit("removeListener",ei,eh||eo)}return this},eh.prototype.off=eh.prototype.removeListener,eh.prototype.removeAllListeners=function(ei){var eo,ea,ec;if(void 0===(ea=this._events))return this;if(void 0===ea.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==ea[ei]&&(0==--this._eventsCount?this._events=Object.create(null):delete ea[ei]),this;if(0==arguments.length){var ed,eu=Object.keys(ea);for(ec=0;ec<eu.length;++ec)"removeListener"!==(ed=eu[ec])&&this.removeAllListeners(ed);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(eo=ea[ei]))this.removeListener(ei,eo);else if(void 0!==eo)for(ec=eo.length-1;ec>=0;ec--)this.removeListener(ei,eo[ec]);return this},eh.prototype.listeners=function(ei){return eS(this,ei,!0)},eh.prototype.rawListeners=function(ei){return eS(this,ei,!1)},eh.listenerCount=function(ei,eo){return"function"==typeof ei.listenerCount?ei.listenerCount(eo):eE.call(ei,eo)},eh.prototype.listenerCount=eE,eh.prototype.eventNames=function(){return this._eventsCount>0?eo(this._events):[]}},5177:function(ei){ei.exports=function(){if("undefined"==typeof globalThis)return null;var ei={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return ei.RTCPeerConnection?ei:null}},645:function(ei,eo){/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */eo.read=function(ei,eo,ea,ec,ed){var eu,eh,ef=8*ed-ec-1,ep=(1<<ef)-1,eg=ep>>1,em=-7,ey=ea?ed-1:0,eb=ea?-1:1,eS=ei[eo+ey];for(ey+=eb,eu=eS&(1<<-em)-1,eS>>=-em,em+=ef;em>0;eu=256*eu+ei[eo+ey],ey+=eb,em-=8);for(eh=eu&(1<<-em)-1,eu>>=-em,em+=ec;em>0;eh=256*eh+ei[eo+ey],ey+=eb,em-=8);if(0===eu)eu=1-eg;else{if(eu===ep)return eh?NaN:(eS?-1:1)*(1/0);eh+=Math.pow(2,ec),eu-=eg}return(eS?-1:1)*eh*Math.pow(2,eu-ec)},eo.write=function(ei,eo,ea,ec,ed,eu){var eh,ef,ep,eg=8*eu-ed-1,em=(1<<eg)-1,ey=em>>1,eb=23===ed?5960464477539062e-23:0,eS=ec?0:eu-1,eE=ec?1:-1,ew=eo<0||0===eo&&1/eo<0?1:0;for(isNaN(eo=Math.abs(eo))||eo===1/0?(ef=isNaN(eo)?1:0,eh=em):(eh=Math.floor(Math.log(eo)/Math.LN2),eo*(ep=Math.pow(2,-eh))<1&&(eh--,ep*=2),eh+ey>=1?eo+=eb/ep:eo+=eb*Math.pow(2,1-ey),eo*ep>=2&&(eh++,ep/=2),eh+ey>=em?(ef=0,eh=em):eh+ey>=1?(ef=(eo*ep-1)*Math.pow(2,ed),eh+=ey):(ef=eo*Math.pow(2,ey-1)*Math.pow(2,ed),eh=0));ed>=8;ei[ea+eS]=255&ef,eS+=eE,ef/=256,ed-=8);for(eh=eh<<ed|ef,eg+=ed;eg>0;ei[ea+eS]=255&eh,eS+=eE,eh/=256,eg-=8);ei[ea+eS-eE]|=128*ew}},5717:function(ei){"function"==typeof Object.create?ei.exports=function(ei,eo){eo&&(ei.super_=eo,ei.prototype=Object.create(eo.prototype,{constructor:{value:ei,enumerable:!1,writable:!0,configurable:!0}}))}:ei.exports=function(ei,eo){if(eo){ei.super_=eo;var ea=function(){};ea.prototype=eo.prototype,ei.prototype=new ea,ei.prototype.constructor=ei}}},2043:function(ei,eo,ea){var ec,ed;!function(eu,eh){"use strict";void 0!==(ed="function"==typeof(ec=eh)?ec.call(eo,ea,eo,ei):ec)&&(ei.exports=ed)}(0,function(){"use strict";var ei=function(){},eo="undefined",ea=typeof window!==eo&&typeof window.navigator!==eo&&/Trident\/|MSIE /.test(window.navigator.userAgent),ec=["trace","debug","info","warn","error"];function ed(ei,eo){var ea=ei[eo];if("function"==typeof ea.bind)return ea.bind(ei);try{return Function.prototype.bind.call(ea,ei)}catch(eo){return function(){return Function.prototype.apply.apply(ea,[ei,arguments])}}}function eu(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function eh(ec){return"debug"===ec&&(ec="log"),typeof console!==eo&&("trace"===ec&&ea?eu:void 0!==console[ec]?ed(console,ec):void 0!==console.log?ed(console,"log"):ei)}function ef(eo,ea){for(var ed=0;ed<ec.length;ed++){var eu=ec[ed];this[eu]=ed<eo?ei:this.methodFactory(eu,eo,ea)}this.log=this.debug}function ep(ei,ea,ec){return function(){typeof console!==eo&&(ef.call(this,ea,ec),this[ei].apply(this,arguments))}}function eg(ei,eo,ea){return eh(ei)||ep.apply(this,arguments)}function em(ei,ea,ed){var eu,eh=this;ea=null==ea?"WARN":ea;var ep="loglevel";function em(ei){var ea=(ec[ei]||"silent").toUpperCase();if(typeof window!==eo&&ep){try{window.localStorage[ep]=ea;return}catch(ei){}try{window.document.cookie=encodeURIComponent(ep)+"="+ea+";"}catch(ei){}}}function ey(){var ei;if(typeof window!==eo&&ep){try{ei=window.localStorage[ep]}catch(ei){}if(typeof ei===eo)try{var ea=window.document.cookie,ec=ea.indexOf(encodeURIComponent(ep)+"=");-1!==ec&&(ei=/^([^;]+)/.exec(ea.slice(ec))[1])}catch(ei){}return void 0===eh.levels[ei]&&(ei=void 0),ei}}function eb(){if(typeof window!==eo&&ep){try{window.localStorage.removeItem(ep);return}catch(ei){}try{window.document.cookie=encodeURIComponent(ep)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(ei){}}}"string"==typeof ei?ep+=":"+ei:"symbol"==typeof ei&&(ep=void 0),eh.name=ei,eh.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},eh.methodFactory=ed||eg,eh.getLevel=function(){return eu},eh.setLevel=function(ea,ec){if("string"==typeof ea&&void 0!==eh.levels[ea.toUpperCase()]&&(ea=eh.levels[ea.toUpperCase()]),"number"==typeof ea&&ea>=0&&ea<=eh.levels.SILENT){if(eu=ea,!1!==ec&&em(ea),ef.call(eh,ea,ei),typeof console===eo&&ea<eh.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+ea},eh.setDefaultLevel=function(ei){ea=ei,ey()||eh.setLevel(ei,!1)},eh.resetLevel=function(){eh.setLevel(ea,!1),eb()},eh.enableAll=function(ei){eh.setLevel(eh.levels.TRACE,ei)},eh.disableAll=function(ei){eh.setLevel(eh.levels.SILENT,ei)};var eS=ey();null==eS&&(eS=ea),eh.setLevel(eS,!1)}var ey=new em,eb={};ey.getLogger=function(ei){if("symbol"!=typeof ei&&"string"!=typeof ei||""===ei)throw TypeError("You must supply a name when creating a logger.");var eo=eb[ei];return eo||(eo=eb[ei]=new em(ei,ey.getLevel(),ey.methodFactory)),eo};var eS=typeof window!==eo?window.log:void 0;return ey.noConflict=function(){return typeof window!==eo&&window.log===ey&&(window.log=eS),ey},ey.getLoggers=function(){return eb},ey.default=ey,ey})},686:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.ExtensibleEvents=void 0;var ec=ea(5998),ed=ea(1940),eu=ea(5617),eh=ea(4600),ef=ea(6931),ep=ea(3637),eg=ea(5492);function em(ei,eo){var ea="undefined"!=typeof Symbol&&ei[Symbol.iterator]||ei["@@iterator"];if(!ea){if(Array.isArray(ei)||(ea=ey(ei))||eo&&ei&&"number"==typeof ei.length){ea&&(ei=ea);var ec=0,ed=function(){};return{s:ed,n:function(){return ec>=ei.length?{done:!0}:{done:!1,value:ei[ec++]}},e:function(ei){throw ei},f:ed}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var eu,eh=!0,ef=!1;return{s:function(){ea=ea.call(ei)},n:function(){var ei=ea.next();return eh=ei.done,ei},e:function(ei){ef=!0,eu=ei},f:function(){try{eh||null==ea.return||ea.return()}finally{if(ef)throw eu}}}}function ey(ei,eo){if(ei){if("string"==typeof ei)return eb(ei,eo);var ea=Object.prototype.toString.call(ei).slice(8,-1);if("Object"===ea&&ei.constructor&&(ea=ei.constructor.name),"Map"===ea||"Set"===ea)return Array.from(ei);if("Arguments"===ea||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ea))return eb(ei,eo)}}function eb(ei,eo){(null==eo||eo>ei.length)&&(eo=ei.length);for(var ea=0,ec=Array(eo);ea<eo;ea++)ec[ea]=ei[ea];return ec}function eS(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eE(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function ew(ei,eo,ea){return eo&&eE(ei.prototype,eo),ea&&eE(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function e_(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var eT=function(){function ei(){eS(this,ei),e_(this,"interpreters",new ec.NamespacedMap([[eu.LEGACY_M_ROOM_MESSAGE,eu.parseMRoomMessage],[ef.M_MESSAGE,eh.parseMMessage],[ef.M_EMOTE,eh.parseMMessage],[ef.M_NOTICE,eh.parseMMessage],[ep.M_POLL_START,eg.parseMPoll],[ep.M_POLL_RESPONSE,eg.parseMPoll],[ep.M_POLL_END,eg.parseMPoll]])),e_(this,"_unknownInterpretOrder",[ef.M_MESSAGE])}return ew(ei,[{key:"unknownInterpretOrder",get:function(){var ei;return null!==(ei=this._unknownInterpretOrder)&&void 0!==ei?ei:[]},set:function(ei){this._unknownInterpretOrder=ei}},{key:"registerInterpreter",value:function(ei,eo){this.interpreters.set(ei,eo)}},{key:"parse",value:function(ei){try{if(this.interpreters.hasNamespaced(ei.type))return this.interpreters.getNamespaced(ei.type)(ei);var eo,ea=em(this.unknownInterpretOrder);try{for(ea.s();!(eo=ea.n()).done;){var ec=eo.value;if(this.interpreters.has(ec)){var eu=this.interpreters.get(ec)(ei);if(eu)return eu}}}catch(ei){ea.e(ei)}finally{ea.f()}return null}catch(ei){if(ei instanceof ed.InvalidEventError)return null;throw ei}}}],[{key:"defaultInstance",get:function(){return ei._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return ei.defaultInstance.unknownInterpretOrder},set:function(eo){ei.defaultInstance.unknownInterpretOrder=eo}},{key:"registerInterpreter",value:function(eo,ea){ei.defaultInstance.registerInterpreter(eo,ea)}},{key:"parse",value:function(eo){return ei.defaultInstance.parse(eo)}}]),ei}();eo.ExtensibleEvents=eT,e_(eT,"_defaultInstance",new eT)},2508:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},1940:function(ei,eo){"use strict";function ea(ei){return(ea="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function ec(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function ed(ei,eo,ea){return eo&&ec(ei.prototype,eo),ea&&ec(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eu(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eh(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eE(ei,eo)}function ef(ei){var eo=eb();return function(){var ea,ec=ew(ei);if(eo){var ed=ew(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return ep(this,ea)}}function ep(ei,eo){if(eo&&("object"===ea(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eg(ei)}function eg(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function em(ei){var eo="function"==typeof Map?new Map:void 0;return(em=function(ei){if(null===ei||!eS(ei))return ei;if("function"!=typeof ei)throw TypeError("Super expression must either be null or a function");if(void 0!==eo){if(eo.has(ei))return eo.get(ei);eo.set(ei,ea)}function ea(){return ey(ei,arguments,ew(this).constructor)}return ea.prototype=Object.create(ei.prototype,{constructor:{value:ea,enumerable:!1,writable:!0,configurable:!0}}),eE(ea,ei)})(ei)}function ey(ei,eo,ea){return(ey=eb()?Reflect.construct:function(ei,eo,ea){var ec=[null];ec.push.apply(ec,eo);var ed=new(Function.bind.apply(ei,ec));return ea&&eE(ed,ea.prototype),ed}).apply(null,arguments)}function eb(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eS(ei){return -1!==Function.toString.call(ei).indexOf("[native code]")}function eE(ei,eo){return(eE=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function ew(ei){return(ew=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.InvalidEventError=void 0;var e_=function(ei){eh(ea,ei);var eo=ef(ea);function ea(ei){return eu(this,ea),eo.call(this,ei)}return ed(ea)}(em(Error));eo.InvalidEventError=e_},5998:function(ei,eo){"use strict";function ea(ei,eo){var ea="undefined"!=typeof Symbol&&ei[Symbol.iterator]||ei["@@iterator"];if(!ea){if(Array.isArray(ei)||(ea=ec(ei))||eo&&ei&&"number"==typeof ei.length){ea&&(ei=ea);var ed=0,eu=function(){};return{s:eu,n:function(){return ed>=ei.length?{done:!0}:{done:!1,value:ei[ed++]}},e:function(ei){throw ei},f:eu}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var eh,ef=!0,ep=!1;return{s:function(){ea=ea.call(ei)},n:function(){var ei=ea.next();return ef=ei.done,ei},e:function(ei){ep=!0,eh=ei},f:function(){try{ef||null==ea.return||ea.return()}finally{if(ep)throw eh}}}}function ec(ei,eo){if(ei){if("string"==typeof ei)return ed(ei,eo);var ea=Object.prototype.toString.call(ei).slice(8,-1);if("Object"===ea&&ei.constructor&&(ea=ei.constructor.name),"Map"===ea||"Set"===ea)return Array.from(ei);if("Arguments"===ea||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ea))return ed(ei,eo)}}function ed(ei,eo){(null==eo||eo>ei.length)&&(eo=ei.length);for(var ea=0,ec=Array(eo);ea<eo;ea++)ec[ea]=ei[ea];return ec}function eu(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eh(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function ef(ei,eo,ea){return eo&&eh(ei.prototype,eo),ea&&eh(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function ep(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}Object.defineProperty(eo,"__esModule",{value:!0}),eo.NamespacedMap=void 0;var eg=function(){function ei(eo){if(eu(this,ei),ep(this,"internalMap",new Map),eo){var ec,ed=ea(eo);try{for(ed.s();!(ec=ed.n()).done;){var eh=ec.value;this.set(eh[0],eh[1])}}catch(ei){ed.e(ei)}finally{ed.f()}}}return ef(ei,[{key:"get",value:function(ei){return ei.name&&this.internalMap.has(ei.name)?this.internalMap.get(ei.name):ei.altName&&this.internalMap.has(ei.altName)?this.internalMap.get(ei.altName):null}},{key:"set",value:function(ei,eo){ei.name&&this.internalMap.set(ei.name,eo),ei.altName&&this.internalMap.set(ei.altName,eo)}},{key:"has",value:function(ei){return!!this.get(ei)}},{key:"delete",value:function(ei){ei.name&&this.internalMap.delete(ei.name),ei.altName&&this.internalMap.delete(ei.altName)}},{key:"hasNamespaced",value:function(ei){return this.internalMap.has(ei)}},{key:"getNamespaced",value:function(ei){return this.internalMap.get(ei)}}]),ei}();eo.NamespacedMap=eg},4355:function(ei,eo){"use strict";function ea(ei){return(ea="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function ec(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&ed(ei,eo)}function ed(ei,eo){return(ed=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function eu(ei){var eo=ep();return function(){var ea,ec=eg(ei);if(eo){var ed=eg(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return eh(this,ea)}}function eh(ei,eo){if(eo&&("object"===ea(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return ef(ei)}function ef(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function ep(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eg(ei){return(eg=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function em(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function ey(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function eb(ei,eo,ea){return eo&&ey(ei.prototype,eo),ea&&ey(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}Object.defineProperty(eo,"__esModule",{value:!0}),eo.UnstableValue=eo.NamespacedValue=void 0;var eS=function(){function ei(eo,ea){if(em(this,ei),this.stable=eo,this.unstable=ea,!this.unstable&&!this.stable)throw Error("One of stable or unstable values must be supplied")}return eb(ei,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(ei){return!!this.name&&this.name===ei||!!this.altName&&this.altName===ei}},{key:"findIn",value:function(ei){var eo;return this.name&&(eo=null==ei?void 0:ei[this.name]),!eo&&this.altName&&(eo=null==ei?void 0:ei[this.altName]),eo}},{key:"includedIn",value:function(ei){var eo=!1;return this.name&&(eo=ei.includes(this.name)),!eo&&this.altName&&(eo=ei.includes(this.altName)),eo}}]),ei}();eo.NamespacedValue=eS;var eE=function(ei){ec(ea,ei);var eo=eu(ea);function ea(ei,ec){var ed;if(em(this,ea),!(ed=eo.call(this,ei,ec)).unstable)throw Error("Unstable value must be supplied");return ed}return eb(ea,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),ea}(eS);eo.UnstableValue=eE},4449:function(ei,eo,ea){"use strict";function ec(ei){return(ec="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.EmoteEvent=void 0;var ed=ea(3240),eu=ea(6931),eh=ea(8472);function ef(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function ep(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eg(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function em(ei,eo,ea){return eo&&eg(ei.prototype,eo),ea&&eg(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function ey(){return(ey="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(ei,eo,ea){var ec=eb(ei,eo);if(ec){var ed=Object.getOwnPropertyDescriptor(ec,eo);return ed.get?ed.get.call(arguments.length<3?ei:ea):ed.value}}).apply(this,arguments)}function eb(ei,eo){for(;!Object.prototype.hasOwnProperty.call(ei,eo)&&null!==(ei=eC(ei)););return ei}function eS(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eE(ei,eo)}function eE(ei,eo){return(eE=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function ew(ei){var eo=eI();return function(){var ea,ec=eC(ei);if(eo){var ed=eC(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return e_(this,ea)}}function e_(ei,eo){if(eo&&("object"===ec(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eT(ei)}function eT(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function eI(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eC(ei){return(eC=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}var eO=function(ei){eS(ea,ei);var eo=ew(ea);function ea(ei){return ep(this,ea),eo.call(this,ei)}return em(ea,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(ei){return(0,eh.isEventTypeSame)(ei,eu.M_EMOTE)||ey(eC(ea.prototype),"isEquivalentTo",this).call(this,ei)}},{key:"serialize",value:function(){var ei=ey(eC(ea.prototype),"serialize",this).call(this);return ei.content.msgtype="m.emote",ei}}],[{key:"from",value:function(ei,eo){var ec;return new ea({type:eu.M_EMOTE.name,content:(ef(ec={},eu.M_TEXT.name,ei),ef(ec,eu.M_HTML.name,eo),ec)})}}]),ea}(ed.MessageEvent);eo.EmoteEvent=eO},2869:function(ei,eo){"use strict";function ea(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function ec(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function ed(ei,eo,ea){return eo&&ec(ei.prototype,eo),ea&&ec(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}Object.defineProperty(eo,"__esModule",{value:!0}),eo.ExtensibleEvent=void 0;var eu=function(){function ei(eo){ea(this,ei),this.wireFormat=eo}return ed(ei,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),ei}();eo.ExtensibleEvent=eu},3240:function(ei,eo,ea){"use strict";function ec(ei){return(ec="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.MessageEvent=void 0;var ed=ea(2869),eu=ea(2932),eh=ea(1940),ef=ea(6931),ep=ea(8472);function eg(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function em(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eg(Object(ea),!0).forEach(function(eo){eR(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eg(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function ey(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eb(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function eS(ei,eo,ea){return eo&&eb(ei.prototype,eo),ea&&eb(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eE(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&ew(ei,eo)}function ew(ei,eo){return(ew=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function e_(ei){var eo=eC();return function(){var ea,ec=eO(ei);if(eo){var ed=eO(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return eT(this,ea)}}function eT(ei,eo){if(eo&&("object"===ec(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eI(ei)}function eI(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function eC(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eO(ei){return(eO=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function eR(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var ek=function(ei){eE(ea,ei);var eo=e_(ea);function ea(ei){ey(this,ea),eR(eI(ec=eo.call(this,ei)),"text",void 0),eR(eI(ec),"html",void 0),eR(eI(ec),"renderings",void 0);var ec,ed=ef.M_MESSAGE.findIn(ec.wireContent),ep=ef.M_TEXT.findIn(ec.wireContent),eg=ef.M_HTML.findIn(ec.wireContent);if((0,eu.isProvided)(ed)){if(!Array.isArray(ed))throw new eh.InvalidEventError("m.message contents must be an array");var em=ed.find(function(ei){return!(0,eu.isProvided)(ei.mimetype)||"text/plain"===ei.mimetype}),eb=ed.find(function(ei){return"text/html"===ei.mimetype});if(!em)throw new eh.InvalidEventError("m.message is missing a plain text representation");ec.text=em.body,ec.html=null==eb?void 0:eb.body,ec.renderings=ed}else if((0,eu.isOptionalAString)(ep))ec.text=ep,ec.html=eg,ec.renderings=[{body:ep,mimetype:"text/plain"}],ec.html&&ec.renderings.push({body:ec.html,mimetype:"text/html"});else throw new eh.InvalidEventError("Missing textual representation for event");return ec}return eS(ea,[{key:"isEmote",get:function(){return ef.M_EMOTE.matches(this.wireFormat.type)||(0,eu.isProvided)(ef.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return ef.M_NOTICE.matches(this.wireFormat.type)||(0,eu.isProvided)(ef.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(ei){return(0,ep.isEventTypeSame)(ei,ef.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var ei=eR({},ef.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var eo=this.renderings[0].mimetype;(void 0===eo||"text/plain"===eo)&&(ei=eR({},ef.M_TEXT.name,this.renderings[0].body))}return ei}},{key:"serialize",value:function(){var ei;return{type:"m.room.message",content:em(em({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(ei=this.html)&&void 0!==ei?ei:void 0})}}}],[{key:"from",value:function(ei,eo){var ec;return new ea({type:ef.M_MESSAGE.name,content:(eR(ec={},ef.M_TEXT.name,ei),eR(ec,ef.M_HTML.name,eo),ec)})}}]),ea}(ed.ExtensibleEvent);eo.MessageEvent=ek},4808:function(ei,eo,ea){"use strict";function ec(ei){return(ec="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.NoticeEvent=void 0;var ed=ea(3240),eu=ea(6931),eh=ea(8472);function ef(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function ep(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eg(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function em(ei,eo,ea){return eo&&eg(ei.prototype,eo),ea&&eg(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function ey(){return(ey="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(ei,eo,ea){var ec=eb(ei,eo);if(ec){var ed=Object.getOwnPropertyDescriptor(ec,eo);return ed.get?ed.get.call(arguments.length<3?ei:ea):ed.value}}).apply(this,arguments)}function eb(ei,eo){for(;!Object.prototype.hasOwnProperty.call(ei,eo)&&null!==(ei=eC(ei)););return ei}function eS(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eE(ei,eo)}function eE(ei,eo){return(eE=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function ew(ei){var eo=eI();return function(){var ea,ec=eC(ei);if(eo){var ed=eC(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return e_(this,ea)}}function e_(ei,eo){if(eo&&("object"===ec(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eT(ei)}function eT(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function eI(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eC(ei){return(eC=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}var eO=function(ei){eS(ea,ei);var eo=ew(ea);function ea(ei){return ep(this,ea),eo.call(this,ei)}return em(ea,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(ei){return(0,eh.isEventTypeSame)(ei,eu.M_NOTICE)||ey(eC(ea.prototype),"isEquivalentTo",this).call(this,ei)}},{key:"serialize",value:function(){var ei=ey(eC(ea.prototype),"serialize",this).call(this);return ei.content.msgtype="m.notice",ei}}],[{key:"from",value:function(ei,eo){var ec;return new ea({type:eu.M_NOTICE.name,content:(ef(ec={},eu.M_TEXT.name,ei),ef(ec,eu.M_HTML.name,eo),ec)})}}]),ea}(ed.MessageEvent);eo.NoticeEvent=eO},5510:function(ei,eo,ea){"use strict";function ec(ei){return(ec="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.PollEndEvent=void 0;var ed=ea(3637),eu=ea(1940),eh=ea(1210),ef=ea(3240),ep=ea(6931),eg=ea(8472);function em(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ey(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?em(Object(ea),!0).forEach(function(eo){ek(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):em(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eb(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eS(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function eE(ei,eo,ea){return eo&&eS(ei.prototype,eo),ea&&eS(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function ew(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&e_(ei,eo)}function e_(ei,eo){return(e_=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function eT(ei){var eo=eO();return function(){var ea,ec=eR(ei);if(eo){var ed=eR(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return eI(this,ea)}}function eI(ei,eo){if(eo&&("object"===ec(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eC(ei)}function eC(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function eO(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eR(ei){return(eR=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function ek(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var eM=function(ei){ew(ea,ei);var eo=eT(ea);function ea(ei){eb(this,ea),ek(eC(ec=eo.call(this,ei)),"pollEventId",void 0),ek(eC(ec),"closingMessage",void 0);var ec,ed=ec.wireContent["m.relates_to"];if(!eh.REFERENCE_RELATION.matches(null==ed?void 0:ed.rel_type)||"string"!=typeof(null==ed?void 0:ed.event_id))throw new eu.InvalidEventError("Relationship must be a reference to an event");return ec.pollEventId=ed.event_id,ec.closingMessage=new ef.MessageEvent(ec.wireFormat),ec}return eE(ea,[{key:"isEquivalentTo",value:function(ei){return(0,eg.isEventTypeSame)(ei,ed.M_POLL_END)}},{key:"serialize",value:function(){return{type:ed.M_POLL_END.name,content:ey(ek({"m.relates_to":{rel_type:eh.REFERENCE_RELATION.name,event_id:this.pollEventId}},ed.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(ei,eo){var ec;return new ea({type:ed.M_POLL_END.name,content:(ek(ec={"m.relates_to":{rel_type:eh.REFERENCE_RELATION.name,event_id:ei}},ed.M_POLL_END.name,{}),ek(ec,ep.M_TEXT.name,eo),ec)})}}]),ea}(ea(2869).ExtensibleEvent);eo.PollEndEvent=eM},4648:function(ei,eo,ea){"use strict";function ec(ei){return(ec="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.PollResponseEvent=void 0;var ed=ea(2869),eu=ea(3637),eh=ea(1940),ef=ea(1210),ep=ea(8472);function eg(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function em(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function ey(ei,eo,ea){return eo&&em(ei.prototype,eo),ea&&em(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eb(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eS(ei,eo)}function eS(ei,eo){return(eS=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function eE(ei){var eo=eT();return function(){var ea,ec=eI(ei);if(eo){var ed=eI(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return ew(this,ea)}}function ew(ei,eo){if(eo&&("object"===ec(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return e_(ei)}function e_(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function eT(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eI(ei){return(eI=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function eC(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var eO=function(ei){eb(ea,ei);var eo=eE(ea);function ea(ei){eg(this,ea),eC(e_(ec=eo.call(this,ei)),"internalAnswerIds",void 0),eC(e_(ec),"internalSpoiled",void 0),eC(e_(ec),"pollEventId",void 0);var ec,ed=ec.wireContent["m.relates_to"];if(!ef.REFERENCE_RELATION.matches(null==ed?void 0:ed.rel_type)||"string"!=typeof(null==ed?void 0:ed.event_id))throw new eh.InvalidEventError("Relationship must be a reference to an event");return ec.pollEventId=ed.event_id,ec.validateAgainst(null),ec}return ey(ea,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(ei){var eo=eu.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==eo?void 0:eo.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var ea=eo.answers;if(ea.some(function(ei){return"string"!=typeof ei})||0===ea.length){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(ei){if(ea.some(function(eo){return!ei.answers.some(function(ei){return ei.id===eo})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}ea=ea.slice(0,ei.maxSelections)}this.internalAnswerIds=ea,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(ei){return(0,ep.isEventTypeSame)(ei,eu.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:eu.M_POLL_RESPONSE.name,content:eC({"m.relates_to":{rel_type:ef.REFERENCE_RELATION.name,event_id:this.pollEventId}},eu.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(ei,eo){return new ea({type:eu.M_POLL_RESPONSE.name,content:eC({"m.relates_to":{rel_type:ef.REFERENCE_RELATION.name,event_id:eo}},eu.M_POLL_RESPONSE.name,{answers:ei})})}}]),ea}(ed.ExtensibleEvent);eo.PollResponseEvent=eO},8267:function(ei,eo,ea){"use strict";function ec(ei){return(ec="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.PollStartEvent=eo.PollAnswerSubevent=void 0;var ed=ea(3637),eu=ea(3240),eh=ea(6931),ef=ea(1940),ep=ea(4355),eg=ea(8472),em=ea(2869);function ey(ei){return ew(ei)||eE(ei)||eS(ei)||eb()}function eb(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function eS(ei,eo){if(ei){if("string"==typeof ei)return e_(ei,eo);var ea=Object.prototype.toString.call(ei).slice(8,-1);if("Object"===ea&&ei.constructor&&(ea=ei.constructor.name),"Map"===ea||"Set"===ea)return Array.from(ei);if("Arguments"===ea||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ea))return e_(ei,eo)}}function eE(ei){if("undefined"!=typeof Symbol&&null!=ei[Symbol.iterator]||null!=ei["@@iterator"])return Array.from(ei)}function ew(ei){if(Array.isArray(ei))return e_(ei)}function e_(ei,eo){(null==eo||eo>ei.length)&&(eo=ei.length);for(var ea=0,ec=Array(eo);ea<eo;ea++)ec[ea]=ei[ea];return ec}function eT(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eI(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eT(Object(ea),!0).forEach(function(eo){eN(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eT(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eC(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eO(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function eR(ei,eo,ea){return eo&&eO(ei.prototype,eo),ea&&eO(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function ek(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eM(ei,eo)}function eM(ei,eo){return(eM=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function eP(ei){var eo=ej();return function(){var ea,ec=eL(ei);if(eo){var ed=eL(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return eA(this,ea)}}function eA(ei,eo){if(eo&&("object"===ec(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eD(ei)}function eD(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function ej(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eL(ei){return(eL=Object.setPrototypeOf?Object.getPrototypeOf:function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function eN(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var eU=function(ei){ek(ea,ei);var eo=eP(ea);function ea(ei){eC(this,ea),eN(eD(ec=eo.call(this,ei)),"id",void 0);var ec,ed=ei.content.id;if(!ed||"string"!=typeof ed)throw new ef.InvalidEventError("Answer ID must be a non-empty string");return ec.id=ed,ec}return eR(ea,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:eI({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(ei,eo){return new ea({type:"org.matrix.sdk.poll.answer",content:eN({id:ei},eh.M_TEXT.name,eo)})}}]),ea}(eu.MessageEvent);eo.PollAnswerSubevent=eU;var eB=function(ei){ek(ea,ei);var eo=eP(ea);function ea(ei){eC(this,ea),eN(eD(ec=eo.call(this,ei)),"question",void 0),eN(eD(ec),"kind",void 0),eN(eD(ec),"rawKind",void 0),eN(eD(ec),"maxSelections",void 0),eN(eD(ec),"answers",void 0);var ec,eh=ed.M_POLL_START.findIn(ec.wireContent);if(!eh.question)throw new ef.InvalidEventError("A question is required");if(ec.question=new eu.MessageEvent({type:"org.matrix.sdk.poll.question",content:eh.question}),ec.rawKind=eh.kind,ed.M_POLL_KIND_DISCLOSED.matches(ec.rawKind)?ec.kind=ed.M_POLL_KIND_DISCLOSED:ec.kind=ed.M_POLL_KIND_UNDISCLOSED,ec.maxSelections=Number.isFinite(eh.max_selections)&&eh.max_selections>0?eh.max_selections:1,!Array.isArray(eh.answers))throw new ef.InvalidEventError("Poll answers must be an array");var ep=eh.answers.slice(0,20).map(function(ei){return new eU({type:"org.matrix.sdk.poll.answer",content:ei})});if(ep.length<=0)throw new ef.InvalidEventError("No answers available");return ec.answers=ep,ec}return eR(ea,[{key:"isEquivalentTo",value:function(ei){return(0,eg.isEventTypeSame)(ei,ed.M_POLL_START)}},{key:"serialize",value:function(){var ei;return{type:ed.M_POLL_START.name,content:(eN(ei={},ed.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(ei){return ei.serialize().content})}),eN(ei,eh.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map(function(ei,eo){return"".concat(eo+1,". ").concat(ei.text)}).join("\n"))),ei)}}}],[{key:"from",value:function(ei,eo,ec){var eu,ef=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new ea({type:ed.M_POLL_START.name,content:(eN(eu={},eh.M_TEXT.name,ei),eN(eu,ed.M_POLL_START.name,{question:eN({},eh.M_TEXT.name,ei),kind:ec instanceof ep.NamespacedValue?ec.name:ec,max_selections:ef,answers:eo.map(function(ei){return eN({id:eK()},eh.M_TEXT.name,ei)})}),eu)})}}]),ea}(em.ExtensibleEvent);eo.PollStartEvent=eB;var eF="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function eK(){return ey(Array(16)).map(function(){return eF.charAt(Math.floor(Math.random()*eF.length))}).join("")}},6931:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.M_TEXT=eo.M_NOTICE=eo.M_MESSAGE=eo.M_HTML=eo.M_EMOTE=void 0;var ec=ea(4355),ed=new ec.UnstableValue("m.message","org.matrix.msc1767.message");eo.M_MESSAGE=ed;var eu=new ec.UnstableValue("m.text","org.matrix.msc1767.text");eo.M_TEXT=eu;var eh=new ec.UnstableValue("m.html","org.matrix.msc1767.html");eo.M_HTML=eh;var ef=new ec.UnstableValue("m.emote","org.matrix.msc1767.emote");eo.M_EMOTE=ef;var ep=new ec.UnstableValue("m.notice","org.matrix.msc1767.notice");eo.M_NOTICE=ep},3637:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.M_POLL_START=eo.M_POLL_RESPONSE=eo.M_POLL_KIND_UNDISCLOSED=eo.M_POLL_KIND_DISCLOSED=eo.M_POLL_END=void 0;var ec=ea(4355),ed=new ec.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");eo.M_POLL_KIND_DISCLOSED=ed;var eu=new ec.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");eo.M_POLL_KIND_UNDISCLOSED=eu;var eh=new ec.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");eo.M_POLL_START=eh;var ef=new ec.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");eo.M_POLL_RESPONSE=ef;var ep=new ec.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");eo.M_POLL_END=ep},1210:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.REFERENCE_RELATION=void 0;var ec=new(ea(4355)).NamespacedValue("m.reference");eo.REFERENCE_RELATION=ec},1333:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0});var ec=ea(686);Object.keys(ec).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ec[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ec[ei]}}))});var ed=ea(2508);Object.keys(ed).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ed[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ed[ei]}}))});var eu=ea(1940);Object.keys(eu).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eu[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eu[ei]}}))});var eh=ea(4355);Object.keys(eh).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eh[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eh[ei]}}))});var ef=ea(5998);Object.keys(ef).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ef[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ef[ei]}}))});var ep=ea(2932);Object.keys(ep).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ep[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ep[ei]}}))});var eg=ea(2117);Object.keys(eg).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eg[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eg[ei]}}))});var em=ea(8472);Object.keys(em).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===em[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return em[ei]}}))});var ey=ea(5617);Object.keys(ey).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ey[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ey[ei]}}))});var eb=ea(4600);Object.keys(eb).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eb[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eb[ei]}}))});var eS=ea(5492);Object.keys(eS).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eS[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eS[ei]}}))});var eE=ea(1210);Object.keys(eE).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eE[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eE[ei]}}))});var ew=ea(2869);Object.keys(ew).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ew[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ew[ei]}}))});var e_=ea(6931);Object.keys(e_).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===e_[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e_[ei]}}))});var eT=ea(3240);Object.keys(eT).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eT[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eT[ei]}}))});var eI=ea(4449);Object.keys(eI).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eI[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eI[ei]}}))});var eC=ea(4808);Object.keys(eC).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eC[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eC[ei]}}))});var eO=ea(3637);Object.keys(eO).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eO[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eO[ei]}}))});var eR=ea(8267);Object.keys(eR).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eR[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eR[ei]}}))});var ek=ea(4648);Object.keys(ek).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ek[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ek[ei]}}))});var eM=ea(5510);Object.keys(eM).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eM[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eM[ei]}}))})},5617:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.LEGACY_M_ROOM_MESSAGE=void 0,eo.parseMRoomMessage=eb;var ec=ea(3240),ed=ea(4808),eu=ea(4449),eh=ea(4355),ef=ea(6931);function ep(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eg(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ep(Object(ea),!0).forEach(function(eo){em(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ep(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function em(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var ey=new eh.NamespacedValue("m.room.message");function eb(ei){if(ef.M_MESSAGE.findIn(ei.content)||ef.M_TEXT.findIn(ei.content))return new ec.MessageEvent(ei);var eo,ea,eh,ep,ey,eb,eS=null===(eo=ei.content)||void 0===eo?void 0:eo.msgtype,eE=null===(ea=ei.content)||void 0===ea?void 0:ea.body,ew=(null===(eh=ei.content)||void 0===eh?void 0:eh.format)==="org.matrix.custom.html"?ei.content.formatted_body:null;return"m.text"===eS?new ec.MessageEvent(eg(eg({},ei),{},{content:eg(eg({},ei.content),{},(em(ep={},ef.M_TEXT.name,eE),em(ep,ef.M_HTML.name,ew),ep))})):"m.notice"===eS?new ed.NoticeEvent(eg(eg({},ei),{},{content:eg(eg({},ei.content),{},(em(ey={},ef.M_TEXT.name,eE),em(ey,ef.M_HTML.name,ew),ey))})):"m.emote"===eS?new eu.EmoteEvent(eg(eg({},ei),{},{content:eg(eg({},ei.content),{},(em(eb={},ef.M_TEXT.name,eE),em(eb,ef.M_HTML.name,ew),eb))})):null}eo.LEGACY_M_ROOM_MESSAGE=ey},4600:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.parseMMessage=ef;var ec=ea(3240),ed=ea(6931),eu=ea(4449),eh=ea(4808);function ef(ei){return ed.M_EMOTE.matches(ei.type)?new eu.EmoteEvent(ei):ed.M_NOTICE.matches(ei.type)?new eh.NoticeEvent(ei):new ec.MessageEvent(ei)}},5492:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.parseMPoll=ef;var ec=ea(3637),ed=ea(8267),eu=ea(4648),eh=ea(5510);function ef(ei){return ec.M_POLL_START.matches(ei.type)?new ed.PollStartEvent(ei):ec.M_POLL_RESPONSE.matches(ei.type)?new eu.PollResponseEvent(ei):ec.M_POLL_END.matches(ei.type)?new eh.PollEndEvent(ei):null}},2932:function(ei,eo){"use strict";function ea(ei){return ec(ei)&&"string"==typeof ei}function ec(ei){return null!=ei}Object.defineProperty(eo,"__esModule",{value:!0}),eo.isOptionalAString=ea,eo.isProvided=ec},2117:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.LegacyMsgType=void 0,eo.isEventLike=eu;var ec,ed=ea(6931);function eu(ei,eo){var ea=ei.content;return eo===ec.Text?ed.M_MESSAGE.matches(ei.type)||"m.room.message"===ei.type&&(null==ea?void 0:ea.msgtype)==="m.text":eo===ec.Emote?ed.M_EMOTE.matches(ei.type)||"m.room.message"===ei.type&&(null==ea?void 0:ea.msgtype)==="m.emote":eo===ec.Notice&&(ed.M_NOTICE.matches(ei.type)||"m.room.message"===ei.type&&(null==ea?void 0:ea.msgtype)==="m.notice")}eo.LegacyMsgType=ec,function(ei){ei.Text="m.text",ei.Notice="m.notice",ei.Emote="m.emote"}(ec||(eo.LegacyMsgType=ec={}))},8472:function(ei,eo){"use strict";function ea(ei,eo){if("string"==typeof ei)return"string"==typeof eo?eo===ei:eo.matches(ei);if("string"==typeof eo)return ei.matches(eo);var ea=eo,ec=ei;return ea.matches(ec.name)||ea.matches(ec.altName)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.isEventTypeSame=ea},1470:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.TweakName=eo.RuleId=eo.PushRuleKind=eo.PushRuleActionName=eo.DMMemberCountCondition=eo.ConditionOperator=eo.ConditionKind=void 0,eo.isDmMemberCountCondition=eh;let ea=function(ei){return ei.DontNotify="dont_notify",ei.Notify="notify",ei.Coalesce="coalesce",ei}({});eo.PushRuleActionName=ea;let ec=function(ei){return ei.Highlight="highlight",ei.Sound="sound",ei}({});eo.TweakName=ec;let ed=function(ei){return ei.ExactEquals="==",ei.LessThan="<",ei.GreaterThan=">",ei.GreaterThanOrEqual=">=",ei.LessThanOrEqual="<=",ei}({});eo.ConditionOperator=ed;let eu="2";function eh(ei){return"==2"===ei||"2"===ei}eo.DMMemberCountCondition=eu;let ef=function(ei){return ei.EventMatch="event_match",ei.EventPropertyIs="event_property_is",ei.EventPropertyContains="event_property_contains",ei.ContainsDisplayName="contains_display_name",ei.RoomMemberCount="room_member_count",ei.SenderNotificationPermission="sender_notification_permission",ei.CallStarted="call_started",ei.CallStartedPrefix="org.matrix.msc3914.call_started",ei}({});eo.ConditionKind=ef;let ep=function(ei){return ei.Override="override",ei.ContentSpecific="content",ei.RoomSpecific="room",ei.SenderSpecific="sender",ei.Underride="underride",ei}({});eo.PushRuleKind=ep;let eg=function(ei){return ei.Master=".m.rule.master",ei.IsUserMention=".org.matrix.msc3952.is_user_mention",ei.IsRoomMention=".org.matrix.msc3952.is_room_mention",ei.ContainsDisplayName=".m.rule.contains_display_name",ei.ContainsUserName=".m.rule.contains_user_name",ei.AtRoomNotification=".m.rule.roomnotif",ei.DM=".m.rule.room_one_to_one",ei.EncryptedDM=".m.rule.encrypted_room_one_to_one",ei.Message=".m.rule.message",ei.EncryptedMessage=".m.rule.encrypted",ei.InviteToSelf=".m.rule.invite_for_me",ei.MemberEvent=".m.rule.member_event",ei.IncomingCall=".m.rule.call",ei.SuppressNotices=".m.rule.suppress_notices",ei.Tombstone=".m.rule.tombstone",ei.PollStart=".m.rule.poll_start",ei.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",ei.PollEnd=".m.rule.poll_end",ei.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",ei.PollStartOneToOne=".m.rule.poll_start_one_to_one",ei.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",ei.PollEndOneToOne=".m.rule.poll_end_one_to_one",ei.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",ei}({});eo.RuleId=eg},5699:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.M_BEACON_INFO=eo.M_BEACON=void 0;var ec=ea(7048);let ed=new ec.UnstableValue("m.beacon_info","org.matrix.msc3672.beacon_info");eo.M_BEACON_INFO=ed;let eu=new ec.UnstableValue("m.beacon","org.matrix.msc3672.beacon");eo.M_BEACON=eu},2481:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.UNSTABLE_MSC3089_TREE_SUBTYPE=eo.UNSTABLE_MSC3089_LEAF=eo.UNSTABLE_MSC3089_BRANCH=eo.UNSTABLE_MSC3088_PURPOSE=eo.UNSTABLE_MSC3088_ENABLED=eo.UNSTABLE_MSC2716_MARKER=eo.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=eo.ToDeviceMessageId=eo.RoomType=eo.RoomCreateTypeField=eo.RelationType=eo.PUSHER_ENABLED=eo.PUSHER_DEVICE_ID=eo.MsgType=eo.MSC3912_RELATION_BASED_REDACTIONS_PROP=eo.LOCAL_NOTIFICATION_SETTINGS_PREFIX=eo.EventType=eo.EVENT_VISIBILITY_CHANGE_TYPE=void 0;var ec=ea(7048);let ed=function(ei){return ei.RoomCanonicalAlias="m.room.canonical_alias",ei.RoomCreate="m.room.create",ei.RoomJoinRules="m.room.join_rules",ei.RoomMember="m.room.member",ei.RoomThirdPartyInvite="m.room.third_party_invite",ei.RoomPowerLevels="m.room.power_levels",ei.RoomName="m.room.name",ei.RoomTopic="m.room.topic",ei.RoomAvatar="m.room.avatar",ei.RoomPinnedEvents="m.room.pinned_events",ei.RoomEncryption="m.room.encryption",ei.RoomHistoryVisibility="m.room.history_visibility",ei.RoomGuestAccess="m.room.guest_access",ei.RoomServerAcl="m.room.server_acl",ei.RoomTombstone="m.room.tombstone",ei.RoomPredecessor="org.matrix.msc3946.room_predecessor",ei.SpaceChild="m.space.child",ei.SpaceParent="m.space.parent",ei.RoomRedaction="m.room.redaction",ei.RoomMessage="m.room.message",ei.RoomMessageEncrypted="m.room.encrypted",ei.Sticker="m.sticker",ei.CallInvite="m.call.invite",ei.CallCandidates="m.call.candidates",ei.CallAnswer="m.call.answer",ei.CallHangup="m.call.hangup",ei.CallReject="m.call.reject",ei.CallSelectAnswer="m.call.select_answer",ei.CallNegotiate="m.call.negotiate",ei.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",ei.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",ei.CallReplaces="m.call.replaces",ei.CallAssertedIdentity="m.call.asserted_identity",ei.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",ei.KeyVerificationRequest="m.key.verification.request",ei.KeyVerificationStart="m.key.verification.start",ei.KeyVerificationCancel="m.key.verification.cancel",ei.KeyVerificationMac="m.key.verification.mac",ei.KeyVerificationDone="m.key.verification.done",ei.KeyVerificationKey="m.key.verification.key",ei.KeyVerificationAccept="m.key.verification.accept",ei.KeyVerificationReady="m.key.verification.ready",ei.RoomMessageFeedback="m.room.message.feedback",ei.Reaction="m.reaction",ei.PollStart="org.matrix.msc3381.poll.start",ei.Typing="m.typing",ei.Receipt="m.receipt",ei.Presence="m.presence",ei.FullyRead="m.fully_read",ei.Tag="m.tag",ei.SpaceOrder="org.matrix.msc3230.space_order",ei.PushRules="m.push_rules",ei.Direct="m.direct",ei.IgnoredUserList="m.ignored_user_list",ei.RoomKey="m.room_key",ei.RoomKeyRequest="m.room_key_request",ei.ForwardedRoomKey="m.forwarded_room_key",ei.Dummy="m.dummy",ei.GroupCallPrefix="org.matrix.msc3401.call",ei.GroupCallMemberPrefix="org.matrix.msc3401.call.member",ei}({});eo.EventType=ed;let eu=function(ei){return ei.Annotation="m.annotation",ei.Replace="m.replace",ei.Reference="m.reference",ei.Thread="m.thread",ei}({});eo.RelationType=eu;let eh=function(ei){return ei.Text="m.text",ei.Emote="m.emote",ei.Notice="m.notice",ei.Image="m.image",ei.File="m.file",ei.Audio="m.audio",ei.Location="m.location",ei.Video="m.video",ei.KeyVerificationRequest="m.key.verification.request",ei}({});eo.MsgType=eh;let ef="type";eo.RoomCreateTypeField=ef;let ep=function(ei){return ei.Space="m.space",ei.UnstableCall="org.matrix.msc3417.call",ei.ElementVideo="io.element.video",ei}({});eo.RoomType=ep;let eg="org.matrix.msgid";eo.ToDeviceMessageId=eg;let em=new ec.UnstableValue("m.room.purpose","org.matrix.msc3088.purpose");eo.UNSTABLE_MSC3088_PURPOSE=em;let ey=new ec.UnstableValue("m.enabled","org.matrix.msc3088.enabled");eo.UNSTABLE_MSC3088_ENABLED=ey;let eb=new ec.UnstableValue("m.data_tree","org.matrix.msc3089.data_tree");eo.UNSTABLE_MSC3089_TREE_SUBTYPE=eb;let eS=new ec.UnstableValue("m.leaf","org.matrix.msc3089.leaf");eo.UNSTABLE_MSC3089_LEAF=eS;let eE=new ec.UnstableValue("m.branch","org.matrix.msc3089.branch");eo.UNSTABLE_MSC3089_BRANCH=eE;let ew=new ec.UnstableValue("m.room.marker","org.matrix.msc2716.marker");eo.UNSTABLE_MSC2716_MARKER=ew;let e_=new ec.UnstableValue("with_relations","org.matrix.msc3912.with_relations");eo.MSC3912_RELATION_BASED_REDACTIONS_PROP=e_;let eT=new ec.UnstableValue("io.element.functional_members","io.element.functional_members");eo.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=eT;let eI=new ec.UnstableValue("m.visibility","org.matrix.msc3531.visibility");eo.EVENT_VISIBILITY_CHANGE_TYPE=eI;let eC=new ec.UnstableValue("enabled","org.matrix.msc3881.enabled");eo.PUSHER_ENABLED=eC;let eO=new ec.UnstableValue("device_id","org.matrix.msc3881.device_id");eo.PUSHER_DEVICE_ID=eO;let eR=new ec.UnstableValue("m.local_notification_settings","org.matrix.msc3890.local_notification_settings");eo.LOCAL_NOTIFICATION_SETTINGS_PREFIX=eR},6548:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.REFERENCE_RELATION=eo.M_TEXT=eo.M_MESSAGE=eo.M_HTML=void 0,eo.isEventTypeSame=eg;var ec=ea(1333),ed=ea(4992);let eu=new ec.UnstableValue("m.message","org.matrix.msc1767.message");eo.M_MESSAGE=eu;let eh=new ec.UnstableValue("m.text","org.matrix.msc1767.text");eo.M_TEXT=eh;let ef=new ec.UnstableValue("m.html","org.matrix.msc1767.html");eo.M_HTML=ef;let ep=new ec.NamespacedValue("m.reference");function eg(ei,eo){if("string"==typeof ei)return"string"==typeof eo?eo===ei:eo.matches(ei);if("string"==typeof eo)return ei.matches(eo);{let ea=eo,ec=ei;return ea.matches(ec.name)||(0,ed.isProvided)(ec.altName)&&ea.matches(ec.altName)}}eo.REFERENCE_RELATION=ep},6709:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.M_TIMESTAMP=eo.M_LOCATION=eo.M_ASSET=eo.LocationAssetType=void 0;var ec=ea(7048);ea(6548);let ed=function(ei){return ei.Self="m.self",ei.Pin="m.pin",ei}({});eo.LocationAssetType=ed;let eu=new ec.UnstableValue("m.asset","org.matrix.msc3488.asset");eo.M_ASSET=eu;let eh=new ec.UnstableValue("m.ts","org.matrix.msc3488.ts");eo.M_TIMESTAMP=eh;let ef=new ec.UnstableValue("m.location","org.matrix.msc3488.location");eo.M_LOCATION=ef},4702:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.Visibility=eo.RestrictedAllowType=eo.Preset=eo.JoinRule=eo.HistoryVisibility=eo.GuestAccess=void 0;let ea=function(ei){return ei.Public="public",ei.Private="private",ei}({});eo.Visibility=ea;let ec=function(ei){return ei.PrivateChat="private_chat",ei.TrustedPrivateChat="trusted_private_chat",ei.PublicChat="public_chat",ei}({});eo.Preset=ec;let ed=function(ei){return ei.Public="public",ei.Invite="invite",ei.Private="private",ei.Knock="knock",ei.Restricted="restricted",ei}({});eo.JoinRule=ed;let eu=function(ei){return ei.RoomMembership="m.room_membership",ei}({});eo.RestrictedAllowType=eu;let eh=function(ei){return ei.CanJoin="can_join",ei.Forbidden="forbidden",ei}({});eo.GuestAccess=eh;let ef=function(ei){return ei.Invited="invited",ei.Joined="joined",ei.Shared="shared",ei.WorldReadable="world_readable",ei}({});eo.HistoryVisibility=ef},5931:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.M_POLL_START=eo.M_POLL_RESPONSE=eo.M_POLL_KIND_UNDISCLOSED=eo.M_POLL_KIND_DISCLOSED=eo.M_POLL_END=void 0;var ec=ea(1333);let ed=new ec.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");eo.M_POLL_KIND_DISCLOSED=ed;let eu=new ec.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");eo.M_POLL_KIND_UNDISCLOSED=eu;let eh=new ec.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");eo.M_POLL_START=eh;let ef=new ec.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");eo.M_POLL_RESPONSE=ef;let ep=new ec.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");eo.M_POLL_END=ep},5550:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.ReceiptType=eo.MAIN_ROOM_TIMELINE=void 0;let ea=function(ei){return ei.Read="m.read",ei.FullyRead="m.fully_read",ei.ReadPrivate="m.read.private",ei}({});eo.ReceiptType=ea;let ec="main";eo.MAIN_ROOM_TIMELINE=ec},6513:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},9162:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.SearchOrderBy=void 0;var ea=function(ei){return ei.RoomId="room_id",ei.Sender="sender",ei}(ea||{});let ec=function(ei){return ei.Recent="recent",ei.Rank="rank",ei}({});eo.SearchOrderBy=ec},1467:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.UNREAD_THREAD_NOTIFICATIONS=void 0;var ec=ea(7048);let ed=new ec.ServerControlledNamespacedValue("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");eo.UNREAD_THREAD_NOTIFICATIONS=ed},9953:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.M_TOPIC=void 0;var ec=ea(7048);let ed=new ec.UnstableValue("m.topic","org.matrix.msc3765.topic");eo.M_TOPIC=ed},7048:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.UnstableValue=eo.ServerControlledNamespacedValue=eo.NamespacedValue=void 0;var ed=ec(ea(8416));class eu{constructor(ei,eo){if(this.stable=ei,this.unstable=eo,!this.unstable&&!this.stable)throw Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){let ei=[this.name],eo=this.altName;return eo&&ei.push(eo),ei}matches(ei){return this.name===ei||this.altName===ei}findIn(ei){let eo;return this.name&&(eo=null==ei?void 0:ei[this.name]),!eo&&this.altName&&(eo=null==ei?void 0:ei[this.altName]),eo}includedIn(ei){let eo=!1;return this.name&&(eo=ei.includes(this.name)),!eo&&this.altName&&(eo=ei.includes(this.altName)),eo}}eo.NamespacedValue=eu;class eh extends eu{constructor(...ei){super(...ei),(0,ed.default)(this,"preferUnstable",!1)}setPreferUnstable(ei){this.preferUnstable=ei}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}eo.ServerControlledNamespacedValue=eh;class ef extends eu{constructor(ei,eo){if(super(ei,eo),!this.unstable)throw Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}eo.UnstableValue=ef},771:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.TypedReEmitter=eo.ReEmitter=void 0;var ed=ec(ea(8416));class eu{constructor(ei){this.target=ei,(0,ed.default)(this,"reEmitters",new Map)}reEmit(ei,eo){let ea=this.reEmitters.get(ei);for(let ec of(ea||(ea=new Map,this.reEmitters.set(ei,ea)),eo)){let eo=(...eo)=>{("error"!==ec||0!==this.target.listenerCount("error"))&&this.target.emit(ec,...eo,ei)};ei.on(ec,eo),ea.set(ec,eo)}}stopReEmitting(ei,eo){let ea=this.reEmitters.get(ei);if(ea){for(let ec of eo)ei.off(ec,ea.get(ec)),ea.delete(ec);0===ea.size&&this.reEmitters.delete(ei)}}}eo.ReEmitter=eu;class eh extends eu{constructor(ei){super(ei)}reEmit(ei,eo){super.reEmit(ei,eo)}stopReEmitting(ei,eo){super.stopReEmitting(ei,eo)}}eo.TypedReEmitter=eh},3210:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.ToDeviceMessageQueue=void 0;var ed=ec(ea(8416)),eu=ea(2481),eh=ea(7434),ef=ea(2168),ep=ea(9443),eg=ea(4551),em=ea(3102);let ey=20;class eb{constructor(ei){this.client=ei,(0,ed.default)(this,"sending",!1),(0,ed.default)(this,"running",!0),(0,ed.default)(this,"retryTimeout",null),(0,ed.default)(this,"retryAttempts",0),(0,ed.default)(this,"sendQueue",async()=>{let ei;if(null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,!this.sending&&this.running){eh.logger.debug("Attempting to send queued to-device messages"),this.sending=!0;try{for(;this.running&&(ei=await this.client.store.getOldestToDeviceBatch(),null!==ei);)await this.sendBatch(ei),await this.client.store.removeToDeviceBatch(ei.id),this.retryAttempts=0;if(!this.running)return;eh.logger.debug("All queued to-device messages sent")}catch(ea){++this.retryAttempts;let eo=ep.MatrixScheduler.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,ea);if(-1===eo){4===Math.floor(ea.httpStatus/100)?(eh.logger.error("Fatal error when sending to-device message - dropping to-device batch!",ea),await this.client.store.removeToDeviceBatch(ei.id)):eh.logger.info("Automatic retry limit reached for to-device messages.");return}eh.logger.info(`Failed to send batch of to-device messages. Will retry in ${eo}ms`,ea),this.retryTimeout=setTimeout(this.sendQueue,eo)}finally{this.sending=!1}}}),(0,ed.default)(this,"onResumedSync",(ei,eo)=>{ei===eg.SyncState.Syncing&&eo!==eg.SyncState.Syncing&&(eh.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(ef.ClientEvent.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ef.ClientEvent.Sync,this.onResumedSync)}async queueBatch(ei){let eo=[];for(let ea=0;ea<ei.batch.length;ea+=ey){let ec={eventType:ei.eventType,batch:ei.batch.slice(ea,ea+ey),txnId:this.client.makeTxnId()};eo.push(ec);let ed=ec.batch.map(ei=>`${ei.userId}/${ei.deviceId} (msgid ${ei.payload[eu.ToDeviceMessageId]})`);eh.logger.info(`Enqueuing batch of to-device messages. type=${ei.eventType} txnid=${ec.txnId}`,ed)}await this.client.store.saveToDeviceBatches(eo),this.sendQueue()}async sendBatch(ei){let eo=new em.MapWithDefault(()=>new Map);for(let ea of ei.batch)eo.getOrCreate(ea.userId).set(ea.deviceId,ea.payload);eh.logger.info(`Sending batch of ${ei.batch.length} to-device messages with ID ${ei.id} and txnId ${ei.txnId}`),await this.client.sendToDevice(ei.eventType,eo,ei.txnId)}}eo.ToDeviceMessageQueue=eb},9118:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.AutoDiscoveryAction=eo.AutoDiscovery=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(95);let ef=function(ei){return ei.SUCCESS="SUCCESS",ei.IGNORE="IGNORE",ei.PROMPT="PROMPT",ei.FAIL_PROMPT="FAIL_PROMPT",ei.FAIL_ERROR="FAIL_ERROR",ei}({});eo.AutoDiscoveryAction=ef;var ep=function(ei){return ei.Invalid="Invalid homeserver discovery response",ei.GenericFailure="Failed to get autodiscovery configuration from server",ei.InvalidHsBaseUrl="Invalid base_url for m.homeserver",ei.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",ei.InvalidIsBaseUrl="Invalid base_url for m.identity_server",ei.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",ei.InvalidIs="Invalid identity server discovery response",ei.MissingWellknown="No .well-known JSON file found",ei.InvalidJson="Invalid JSON",ei}(ep||{});class eg{static async fromDiscoveryConfig(ei){var eo;let ea={"m.homeserver":{state:eg.FAIL_ERROR,error:eg.ERROR_INVALID,base_url:null},"m.identity_server":{state:eg.PROMPT,error:null,base_url:null}};if(!ei||!ei["m.homeserver"])return eu.logger.error("No m.homeserver key in config"),ea["m.homeserver"].state=eg.FAIL_PROMPT,ea["m.homeserver"].error=eg.ERROR_INVALID,Promise.resolve(ea);if(!ei["m.homeserver"].base_url)return eu.logger.error("No m.homeserver base_url in config"),ea["m.homeserver"].state=eg.FAIL_PROMPT,ea["m.homeserver"].error=eg.ERROR_INVALID_HS_BASE_URL,Promise.resolve(ea);let ec=this.sanitizeWellKnownUrl(ei["m.homeserver"].base_url);if(!ec)return eu.logger.error("Invalid base_url for m.homeserver"),ea["m.homeserver"].error=eg.ERROR_INVALID_HS_BASE_URL,Promise.resolve(ea);let ed=await this.fetchWellKnownObject(`${ec}/_matrix/client/versions`);if(!ed||!(null!==(eo=ed.raw)&&void 0!==eo&&eo.versions))return eu.logger.error("Invalid /versions response"),ea["m.homeserver"].error=eg.ERROR_INVALID_HOMESERVER,ea["m.homeserver"].base_url=ec,Promise.resolve(ea);ea["m.homeserver"]={state:eg.SUCCESS,error:null,base_url:ec};let eh="";if(ei["m.identity_server"]){let eo={"m.homeserver":ea["m.homeserver"],"m.identity_server":{state:eg.FAIL_PROMPT,error:eg.ERROR_INVALID_IS,base_url:null}};if(!(eh=this.sanitizeWellKnownUrl(ei["m.identity_server"].base_url)))return eu.logger.error("Invalid base_url for m.identity_server"),eo["m.identity_server"].error=eg.ERROR_INVALID_IS_BASE_URL,Promise.resolve(eo);let ec=await this.fetchWellKnownObject(`${eh}/_matrix/identity/v2`);if(!(null!=ec&&ec.raw)||ec.action!==ef.SUCCESS)return eu.logger.error("Invalid /v2 response"),eo["m.identity_server"].error=eg.ERROR_INVALID_IDENTITY_SERVER,eo["m.identity_server"].base_url=eh,Promise.resolve(eo)}return eh&&eh.toString().length>0&&(ea["m.identity_server"]={state:eg.SUCCESS,error:null,base_url:eh}),Object.keys(ei).forEach(eo=>{if("m.homeserver"===eo||"m.identity_server"===eo){let ec=["error","state","base_url"];for(let ed of Object.keys(ei[eo]))ec.includes(ed)||(ea[eo][ed]=ei[eo][ed])}else ea[eo]=ei[eo]}),Promise.resolve(ea)}static async findClientConfig(ei){if(!ei||"string"!=typeof ei||0===ei.length)throw Error("'domain' must be a string of non-zero length");let eo={"m.homeserver":{state:eg.FAIL_ERROR,error:eg.ERROR_INVALID,base_url:null},"m.identity_server":{state:eg.PROMPT,error:null,base_url:null}},ea=await this.fetchWellKnownObject(`https://${ei}/.well-known/matrix/client`);return ea&&ea.action===ef.SUCCESS?eg.fromDiscoveryConfig(ea.raw):(eu.logger.error("No response or error when parsing .well-known"),ea.reason&&eu.logger.error(ea.reason),ea.action===ef.IGNORE?eo["m.homeserver"]={state:eg.PROMPT,error:null,base_url:null}:(eo["m.homeserver"].state=eg.FAIL_PROMPT,eo["m.homeserver"].error=eg.ERROR_INVALID),Promise.resolve(eo))}static async getRawClientConfig(ei){if(!ei||"string"!=typeof ei||0===ei.length)throw Error("'domain' must be a string of non-zero length");let eo=await this.fetchWellKnownObject(`https://${ei}/.well-known/matrix/client`);return eo&&eo.raw||{}}static sanitizeWellKnownUrl(ei){if(!ei)return!1;try{var eo;let ea;try{ea=new URL(ei)}catch(ei){eu.logger.error("Could not parse url",ei)}if(!(null!==(eo=ea)&&void 0!==eo&&eo.hostname)||"http:"!==ea.protocol&&"https:"!==ea.protocol)return!1;let ec=ea.port?`:${ea.port}`:"",ed=ea.pathname?ea.pathname:"",eh=`${ea.protocol}//${ea.hostname}${ec}${ed}`;return eh.endsWith("/")&&(eh=eh.substring(0,eh.length-1)),eh}catch(ei){return eu.logger.error(ei),!1}}static fetch(ei,eo){return this.fetchFn?this.fetchFn(ei,eo):ea.g.fetch(ei,eo)}static setFetchFn(ei){eg.fetchFn=ei}static async fetchWellKnownObject(ei){let eo;try{if(eo=await eg.fetch(ei,{method:eh.Method.Get,signal:(0,eh.timeoutSignal)(5e3)}),404===eo.status)return{raw:{},action:ef.IGNORE,reason:eg.ERROR_MISSING_WELLKNOWN};if(!eo.ok)return{raw:{},action:ef.FAIL_PROMPT,reason:"General failure"}}catch(ea){let ei=ea,eo="";return"object"==typeof ei&&(eo=null==ei?void 0:ei.message),{error:ei,raw:{},action:ef.FAIL_PROMPT,reason:eo||"General failure"}}try{return{raw:await eo.json(),action:ef.SUCCESS}}catch(eo){let ei=eo;return{error:ei,raw:{},action:ef.FAIL_PROMPT,reason:(null==ei?void 0:ei.name)==="SyntaxError"?eg.ERROR_INVALID_JSON:eg.ERROR_INVALID}}}}eo.AutoDiscovery=eg,(0,ed.default)(eg,"ERROR_INVALID",ep.Invalid),(0,ed.default)(eg,"ERROR_GENERIC_FAILURE",ep.GenericFailure),(0,ed.default)(eg,"ERROR_INVALID_HS_BASE_URL",ep.InvalidHsBaseUrl),(0,ed.default)(eg,"ERROR_INVALID_HOMESERVER",ep.InvalidHomeserver),(0,ed.default)(eg,"ERROR_INVALID_IS_BASE_URL",ep.InvalidIsBaseUrl),(0,ed.default)(eg,"ERROR_INVALID_IDENTITY_SERVER",ep.InvalidIdentityServer),(0,ed.default)(eg,"ERROR_INVALID_IS",ep.InvalidIs),(0,ed.default)(eg,"ERROR_MISSING_WELLKNOWN",ep.MissingWellknown),(0,ed.default)(eg,"ERROR_INVALID_JSON",ep.InvalidJson),(0,ed.default)(eg,"ALL_ERRORS",Object.keys(ep)),(0,ed.default)(eg,"FAIL_ERROR",ef.FAIL_ERROR),(0,ed.default)(eg,"FAIL_PROMPT",ef.FAIL_PROMPT),(0,ed.default)(eg,"PROMPT",ef.PROMPT),(0,ed.default)(eg,"SUCCESS",ef.SUCCESS),(0,ed.default)(eg,"fetchFn",void 0)},8743:function(ei,eo,ea){"use strict";let ec;Object.defineProperty(eo,"__esModule",{value:!0});var ed={};eo.default=void 0;var eu=ef(ea(8070));function eh(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eh=function(ei){return ei?ea:eo})(ei)}function ef(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eh(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var ef=ed?Object.getOwnPropertyDescriptor(ei,eu):null;ef&&(ef.get||ef.set)?Object.defineProperty(ec,eu,ef):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}if(Object.keys(eu).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ed,ei))&&(ei in eo&&eo[ei]===eu[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eu[ei]}}))}),ea.g.__js_sdk_entrypoint)throw Error("Multiple matrix-js-sdk entrypoints detected!");ea.g.__js_sdk_entrypoint=!0;try{ec=ea.g.indexedDB}catch(ei){}ec&&eu.setCryptoStoreFactory(()=>new eu.IndexedDBCryptoStore(ec,"matrix-js-sdk:crypto"));var ep=eu;eo.default=ep,ea.g.matrixcs=eu},4656:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.makeBeaconInfoContent=eo.makeBeaconContent=eo.getTextForLocationEvent=void 0,eo.makeEmoteMessage=eT,eo.makeHtmlEmote=eE,eo.makeHtmlMessage=eb,eo.makeHtmlNotice=eS,eo.makeLocationContent=void 0,eo.makeNotice=e_,eo.makeTextMessage=ew,eo.parseTopicContent=eo.parseLocationEvent=eo.parseBeaconInfoContent=eo.parseBeaconContent=eo.makeTopicContent=void 0;var ed=ec(ea(8416)),eu=ea(2481),eh=ea(6548),ef=ea(4992),ep=ea(6709),eg=ea(9953);function em(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ey(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?em(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):em(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eb(ei,eo){return{msgtype:eu.MsgType.Text,format:"org.matrix.custom.html",body:ei,formatted_body:eo}}function eS(ei,eo){return{msgtype:eu.MsgType.Notice,format:"org.matrix.custom.html",body:ei,formatted_body:eo}}function eE(ei,eo){return{msgtype:eu.MsgType.Emote,format:"org.matrix.custom.html",body:ei,formatted_body:eo}}function ew(ei){return{msgtype:eu.MsgType.Text,body:ei}}function e_(ei){return{msgtype:eu.MsgType.Notice,body:ei}}function eT(ei){return{msgtype:eu.MsgType.Emote,body:ei}}let eI=(ei,eo,ea,ec)=>{let ed=`at ${new Date(ea).toISOString()}`,eu=eo===ep.LocationAssetType.Self?"User":void 0,eh=ec?`"${ec}"`:void 0;return[eu,"Location",eh,ei,ed].filter(Boolean).join(" ")};eo.getTextForLocationEvent=eI;let eC=(ei,eo,ea,ec,ed)=>{let ef=null!=ei?ei:eI(eo,ed||ep.LocationAssetType.Self,ea,ec),eg=ea?{[ep.M_TIMESTAMP.name]:ea}:{};return ey({msgtype:eu.MsgType.Location,body:ef,geo_uri:eo,[ep.M_LOCATION.name]:{description:ec,uri:eo},[ep.M_ASSET.name]:{type:ed||ep.LocationAssetType.Self},[eh.M_TEXT.name]:ef},eg)};eo.makeLocationContent=eC;let eO=ei=>{var eo,ea;let ec=ep.M_LOCATION.findIn(ei),ed=ep.M_ASSET.findIn(ei),eu=ep.M_TIMESTAMP.findIn(ei),ef=eh.M_TEXT.findIn(ei),eg=null!==(eo=null==ec?void 0:ec.uri)&&void 0!==eo?eo:null==ei?void 0:ei.geo_uri,em=null==ec?void 0:ec.description,ey=null!==(ea=null==ed?void 0:ed.type)&&void 0!==ea?ea:ep.LocationAssetType.Self,eb=null!=ef?ef:ei.body;return eC(eb,eg,null!=eu?eu:void 0,em,ey)};eo.parseLocationEvent=eO;let eR=(ei,eo)=>{let ea=[{body:ei,mimetype:"text/plain"}];return(0,ef.isProvided)(eo)&&ea.push({body:eo,mimetype:"text/html"}),{topic:ei,[eg.M_TOPIC.name]:ea}};eo.makeTopicContent=eR;let ek=ei=>{var eo,ea,ec;let ed=eg.M_TOPIC.findIn(ei);if(!Array.isArray(ed))return{text:ei.topic};let eu=null!==(eo=null==ed?void 0:null===(ea=ed.find(ei=>!(0,ef.isProvided)(ei.mimetype)||"text/plain"===ei.mimetype))||void 0===ea?void 0:ea.body)&&void 0!==eo?eo:ei.topic,eh=null==ed?void 0:null===(ec=ed.find(ei=>"text/html"===ei.mimetype))||void 0===ec?void 0:ec.body;return{text:eu,html:eh}};eo.parseTopicContent=ek;let eM=(ei,eo,ea,ec,ed)=>({description:ea,timeout:ei,live:eo,[ep.M_TIMESTAMP.name]:ed||Date.now(),[ep.M_ASSET.name]:{type:null!=ec?ec:ep.LocationAssetType.Self}});eo.makeBeaconInfoContent=eM;let eP=ei=>{var eo;let{description:ea,timeout:ec,live:ed}=ei,eu=null!==(eo=ep.M_TIMESTAMP.findIn(ei))&&void 0!==eo?eo:void 0,eh=ep.M_ASSET.findIn(ei);return{description:ea,timeout:ec,live:ed,assetType:null==eh?void 0:eh.type,timestamp:eu}};eo.parseBeaconInfoContent=eP;let eA=(ei,eo,ea,ec)=>({[ep.M_LOCATION.name]:{description:ec,uri:ei},[ep.M_TIMESTAMP.name]:eo,"m.relates_to":{rel_type:eh.REFERENCE_RELATION.name,event_id:ea}});eo.makeBeaconContent=eA;let eD=ei=>{var eo;let ea=ep.M_LOCATION.findIn(ei),ec=null!==(eo=ep.M_TIMESTAMP.findIn(ei))&&void 0!==eo?eo:void 0;return{description:null==ea?void 0:ea.description,uri:null==ea?void 0:ea.uri,timestamp:ec}};eo.parseBeaconContent=eD},3667:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.getHttpUriForMxc=eh;var ec=eu(ea(3102));function ed(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ed=function(ei){return ei?ea:eo})(ei)}function eu(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ed(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},eu=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eh in ei)if("default"!==eh&&Object.prototype.hasOwnProperty.call(ei,eh)){var ef=eu?Object.getOwnPropertyDescriptor(ei,eh):null;ef&&(ef.get||ef.set)?Object.defineProperty(ec,eh,ef):ec[eh]=ei[eh]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function eh(ei,eo,ea,ed,eu,eh=!1){if("string"!=typeof eo||!eo)return"";if(0!==eo.indexOf("mxc://"))return eh?eo:"";let ef=eo.slice(6),ep="/_matrix/media/r0/download/",eg={};ea&&(eg.width=Math.round(ea).toString()),ed&&(eg.height=Math.round(ed).toString()),eu&&(eg.method=eu),Object.keys(eg).length>0&&(ep="/_matrix/media/r0/thumbnail/");let em=ef.indexOf("#"),ey="";em>=0&&(ey=ef.slice(em),ef=ef.slice(0,em));let eb=0===Object.keys(eg).length?"":"?"+ec.encodeParams(eg);return ei+ep+ef+eb+ey}},3075:function(ei,eo,ea){"use strict";var ec=ea(8764).Buffer,ed=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.UserTrustLevel=eo.DeviceTrustLevel=eo.CrossSigningLevel=eo.CrossSigningInfo=void 0,eo.createCryptoStoreCacheCallbacks=eT,eo.requestKeysDuringVerification=eI;var eu=ed(ea(8416)),eh=ea(2772),ef=ea(7434),ep=ea(7585),eg=ea(2611);let em=6e4;function ey(ei){return Object.values(ei.keys)[0]}class eb{constructor(ei,eo={},ea={}){this.userId=ei,this.callbacks=eo,this.cacheCallbacks=ea,(0,eu.default)(this,"keys",{}),(0,eu.default)(this,"firstUse",!0),(0,eu.default)(this,"crossSigningVerifiedBefore",!1)}static fromStorage(ei,eo){let ea=new eb(eo);for(let eo in ei)ei.hasOwnProperty(eo)&&(ea[eo]=ei[eo]);return ea}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(ei,eo){let ec=["master","self_signing","user_signing"].indexOf(ei)>=0;if(!this.callbacks.getCrossSigningKey)throw Error("No getCrossSigningKey callback supplied");function ed(ei){if(!ei)return;let ec=new ea.g.Olm.PkSigning,ed=ec.init_with_seed(ei);if(ed===eo)return[ed,ec];ec.free()}void 0===eo&&(eo=this.getId(ei));let eu=null;this.cacheCallbacks.getCrossSigningKeyCache&&ec&&(eu=await this.cacheCallbacks.getCrossSigningKeyCache(ei,eo));let eh=ed(eu);if(eh)return eh;eu=await this.callbacks.getCrossSigningKey(ei,eo);let ef=ed(eu);if(ef)return this.cacheCallbacks.storeCrossSigningKeyCache&&ec&&await this.cacheCallbacks.storeCrossSigningKeyCache(ei,eu),ef;if(!eu)throw Error("getCrossSigningKey callback for "+ei+" returned falsey");throw Error("Key type "+ei+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(ei){let eo=await ei.isStored("m.cross_signing.master")||{};function ea(ei){for(let ea of Object.keys(eo))ei[ea]||delete eo[ea]}for(let eo of["self_signing","user_signing"])ea(await ei.isStored(`m.cross_signing.${eo}`)||{});return Object.keys(eo).length?eo:null}static async storeInSecretStorage(ei,eo){for(let[ea,ec]of ei){let ei=(0,eh.encodeBase64)(ec);await eo.store(`m.cross_signing.${ea}`,ei)}}static async getFromSecretStorage(ei,eo){let ea=await eo.get(`m.cross_signing.${ei}`);return ea?(0,eh.decodeBase64)(ea):null}async isStoredInKeyCache(ei){let eo=this.cacheCallbacks;if(!eo)return!1;let ea=ei?[ei]:["master","self_signing","user_signing"];for(let ei of ea){var ec;if(!await (null===(ec=eo.getCrossSigningKeyCache)||void 0===ec?void 0:ec.call(eo,ei)))return!1}return!0}async getCrossSigningKeysFromCache(){let ei=new Map,eo=this.cacheCallbacks;if(!eo)return ei;for(let ec of["master","self_signing","user_signing"]){var ea;let ed=await (null===(ea=eo.getCrossSigningKeyCache)||void 0===ea?void 0:ea.call(eo,ec));ed&&ei.set(ec,ed)}return ei}getId(ei="master"){if(!this.keys[ei])return null;let eo=this.keys[ei];return ey(eo)}async resetKeys(ei){let eo,ec;if(!this.callbacks.saveCrossSigningKeys)throw Error("No saveCrossSigningKeys callback supplied");if(void 0===ei||ei&eE.MASTER||!this.keys.master)ei=eE.MASTER|eE.USER_SIGNING|eE.SELF_SIGNING;else if(0===ei)return;let ed={},eu={};try{if(ei&eE.MASTER?(eo=new ea.g.Olm.PkSigning,ed.master=eo.generate_seed(),ec=eo.init_with_seed(ed.master),eu.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+ec]:ec}}):[ec,eo]=await this.getCrossSigningKey("master"),ei&eE.SELF_SIGNING){let ei=new ea.g.Olm.PkSigning;try{ed.self_signing=ei.generate_seed();let ea=ei.init_with_seed(ed.self_signing);eu.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+ea]:ea}},(0,eh.pkSign)(eu.self_signing,eo,this.userId,ec)}finally{ei.free()}}if(ei&eE.USER_SIGNING){let ei=new ea.g.Olm.PkSigning;try{ed.user_signing=ei.generate_seed();let ea=ei.init_with_seed(ed.user_signing);eu.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+ea]:ea}},(0,eh.pkSign)(eu.user_signing,eo,this.userId,ec)}finally{ei.free()}}Object.assign(this.keys,eu),this.callbacks.saveCrossSigningKeys(ed)}finally{eo&&eo.free()}}clearKeys(){this.keys={}}setKeys(ei){let eo={};if(ei.master){if(ei.master.user_id!==this.userId){let eo="Mismatched user ID "+ei.master.user_id+" in master key from "+this.userId;throw ef.logger.error(eo),Error(eo)}this.keys.master?ey(ei.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,eo.master=ei.master}else if(this.keys.master)eo.master=this.keys.master;else throw Error("Tried to set cross-signing keys without a master key");let ea=ey(eo.master);if(ei.user_signing){if(ei.user_signing.user_id!==this.userId){let eo="Mismatched user ID "+ei.master.user_id+" in user_signing key from "+this.userId;throw ef.logger.error(eo),Error(eo)}try{(0,eh.pkVerify)(ei.user_signing,ea,this.userId)}catch(ei){throw ef.logger.error("invalid signature on user-signing key"),ei}}if(ei.self_signing){if(ei.self_signing.user_id!==this.userId){let eo="Mismatched user ID "+ei.master.user_id+" in self_signing key from "+this.userId;throw ef.logger.error(eo),Error(eo)}try{(0,eh.pkVerify)(ei.self_signing,ea,this.userId)}catch(ei){throw ef.logger.error("invalid signature on self-signing key"),ei}}ei.master&&(this.keys.master=ei.master,delete this.keys.self_signing,delete this.keys.user_signing),ei.self_signing&&(this.keys.self_signing=ei.self_signing),ei.user_signing&&(this.keys.user_signing=ei.user_signing)}updateCrossSigningVerifiedBefore(ei){!this.crossSigningVerifiedBefore&&ei&&(this.crossSigningVerifiedBefore=!0)}async signObject(ei,eo){if(!this.keys[eo])throw Error("Attempted to sign with "+eo+" key but no such key present");let[ea,ec]=await this.getCrossSigningKey(eo);try{return(0,eh.pkSign)(ei,ec,this.userId,ea),ei}finally{ec.free()}}async signUser(ei){if(!this.keys.user_signing){ef.logger.info("No user signing key: not signing user");return}return this.signObject(ei.keys.master,"user_signing")}async signDevice(ei,eo){if(ei!==this.userId)throw Error(`Trying to sign ${ei}'s device; can only sign our own device`);if(!this.keys.self_signing){ef.logger.info("No self signing key: not signing device");return}return this.signObject({algorithms:eo.algorithms,keys:eo.keys,device_id:eo.deviceId,user_id:ei},"self_signing")}checkUserTrust(ei){let eo;if(this.userId===ei.userId&&this.getId()&&this.getId()===ei.getId()&&this.getId("self_signing")&&this.getId("self_signing")===ei.getId("self_signing"))return new ew(!0,!0,this.firstUse);if(!this.keys.user_signing)return new ew(!1,!1,ei.firstUse);let ea=ei.keys.master,ec=this.getId("user_signing");try{(0,eh.pkVerify)(ea,ec,this.userId),eo=!0}catch(ei){eo=!1}return new ew(eo,ei.crossSigningVerifiedBefore,ei.firstUse)}checkDeviceTrust(ei,eo,ea,ec){let ed=this.checkUserTrust(ei),eu=ei.keys.self_signing;if(!eu)return new e_(!1,!1,ea,ec);let ef=eS(eo,ei.userId);try{return(0,eh.pkVerify)(eu,ei.getId(),ei.userId),(0,eh.pkVerify)(ef,ey(eu),ei.userId),e_.fromUserTrustLevel(ed,ea,ec)}catch(ei){return new e_(!1,!1,ea,ec)}}getCacheCallbacks(){return this.cacheCallbacks}}function eS(ei,eo){return{algorithms:ei.algorithms,keys:ei.keys,device_id:ei.deviceId,user_id:eo,signatures:ei.signatures}}eo.CrossSigningInfo=eb;let eE=function(ei){return ei[ei.MASTER=4]="MASTER",ei[ei.USER_SIGNING=2]="USER_SIGNING",ei[ei.SELF_SIGNING=1]="SELF_SIGNING",ei}({});eo.CrossSigningLevel=eE;class ew{constructor(ei,eo,ea){this.crossSigningVerified=ei,this.crossSigningVerifiedBefore=eo,this.tofu=ea}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}eo.UserTrustLevel=ew;class e_{constructor(ei,eo,ea,ec){this.crossSigningVerified=ei,this.tofu=eo,this.localVerified=ea,this.trustCrossSignedDevices=ec}static fromUserTrustLevel(ei,eo,ea){return new e_(ei.isCrossSigningVerified(),ei.isTofu(),eo,ea)}isVerified(){return!!(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function eT(ei,eo){return{getCrossSigningKeyCache:async function(ea,ed){let eu=await new Promise(eo=>ei.doTxn("readonly",[ep.IndexedDBCryptoStore.STORE_ACCOUNT],ec=>{ei.getSecretStorePrivateKey(ec,eo,ea)}));if(!eu||!eu.ciphertext)return eu;{let ei=ec.from(eo.pickleKey),ed=await (0,eg.decryptAES)(eu,ei,ea);return(0,eh.decodeBase64)(ed)}},storeCrossSigningKeyCache:async function(ea,ed){if(!(ed instanceof Uint8Array))throw Error(`storeCrossSigningKeyCache expects Uint8Array, got ${ed}`);let eu=ec.from(eo.pickleKey),ef=await (0,eg.encryptAES)((0,eh.encodeBase64)(ed),eu,ea);return ei.doTxn("readwrite",[ep.IndexedDBCryptoStore.STORE_ACCOUNT],eo=>{ei.storeSecretStorePrivateKey(eo,ea,ef)})}}}async function eI(ei,eo,ea){if(ei.getUserId()===eo)return ef.logger.log("Cross-signing: Self-verification done; requesting keys"),new Promise((eo,ec)=>{let ed=ei,eu=ed.crypto.crossSigningInfo,ep=new eb(eu.userId,{getCrossSigningKey:async ei=>{ef.logger.debug("Cross-signing: requesting secret",ei,ea);let{promise:eo}=ed.requestSecret(`m.cross_signing.${ei}`,[ea]),ec=await eo,eu=(0,eh.decodeBase64)(ec);return Uint8Array.from(eu)}},eu.getCacheCallbacks());ep.keys=eu.keys;let eg=new Promise(ei=>{setTimeout(ei,em,Error("Timeout"))}),ey=(async()=>{let ei=await ed.crypto.getSessionBackupPrivateKey();if(!ei){ef.logger.info("No cached backup key found. Requesting...");let ei=ed.requestSecret("m.megolm_backup.v1",[ea]),eo=await ei.promise;ef.logger.info("Got key backup key, decoding...");let ec=(0,eh.decodeBase64)(eo);ef.logger.info("Decoded backup key, storing..."),await ed.crypto.storeSessionBackupPrivateKey(Uint8Array.from(ec)),ef.logger.info("Backup key stored. Starting backup restore...");let eu=await ed.getKeyBackupVersion();ed.restoreKeyBackupWithCache(void 0,void 0,eu).then(()=>{ef.logger.info("Backup restored.")})}})();return Promise.race([Promise.all([ep.getCrossSigningKey("master"),ep.getCrossSigningKey("self_signing"),ep.getCrossSigningKey("user_signing"),ey]),eg]).then(eo,ec)}).catch(ei=>{ef.logger.warn("Cross-signing: failure while requesting keys:",ei)})}eo.DeviceTrustLevel=e_},6670:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.TrackingStatus=eo.DeviceList=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(3272),ef=ea(3075),ep=eE(ea(2772)),eg=ea(7585),em=ea(3102),ey=ea(5861),eb=ea(2600);function eS(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eS=function(ei){return ei?ea:eo})(ei)}function eE(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eS(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let ew=function(ei){return ei[ei.NotTracked=0]="NotTracked",ei[ei.PendingDownload=1]="PendingDownload",ei[ei.DownloadInProgress=2]="DownloadInProgress",ei[ei.UpToDate=3]="UpToDate",ei}({});eo.TrackingStatus=ew;class e_ extends ey.TypedEventEmitter{constructor(ei,eo,ea,ec=250){super(),this.cryptoStore=eo,this.keyDownloadChunkSize=ec,(0,ed.default)(this,"devices",{}),(0,ed.default)(this,"crossSigningInfo",{}),(0,ed.default)(this,"userByIdentityKey",{}),(0,ed.default)(this,"deviceTrackingStatus",{}),(0,ed.default)(this,"syncToken",null),(0,ed.default)(this,"keyDownloadsInProgressByUser",new Map),(0,ed.default)(this,"dirty",!1),(0,ed.default)(this,"savePromise",null),(0,ed.default)(this,"resolveSavePromise",null),(0,ed.default)(this,"savePromiseTime",null),(0,ed.default)(this,"saveTimer",null),(0,ed.default)(this,"hasFetched",null),(0,ed.default)(this,"serialiser",void 0),this.serialiser=new eT(ei,ea,this)}async load(){for(let ei of(await this.cryptoStore.doTxn("readonly",[eg.IndexedDBCryptoStore.STORE_DEVICE_DATA],ei=>{this.cryptoStore.getEndToEndDeviceData(ei,ei=>{var eo;for(let ea of(this.hasFetched=!!(ei&&ei.devices),this.devices=ei?ei.devices:{},this.crossSigningInfo=ei&&ei.crossSigningInfo||{},this.deviceTrackingStatus=ei?ei.trackingStatus:{},this.syncToken=null!==(eo=null==ei?void 0:ei.syncToken)&&void 0!==eo?eo:null,this.userByIdentityKey={},Object.keys(this.devices))){let ei=this.devices[ea];for(let eo of Object.keys(ei)){let ec=ei[eo].keys["curve25519:"+eo];void 0!==ec&&(this.userByIdentityKey[ec]=ea)}}})}),Object.keys(this.deviceTrackingStatus)))this.deviceTrackingStatus[ei]==ew.DownloadInProgress&&(this.deviceTrackingStatus[ei]=ew.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(ei=500){if(!this.dirty)return Promise.resolve(!1);let eo=Date.now()+ei;this.savePromiseTime&&eo<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let ea=this.savePromise;if(null===ea&&(ea=new Promise(ei=>{this.resolveSavePromise=ei}),this.savePromise=ea),null===this.saveTimer){let ea=this.resolveSavePromise;this.savePromiseTime=eo,this.saveTimer=setTimeout(()=>{eu.logger.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[eg.IndexedDBCryptoStore.STORE_DEVICE_DATA],ei=>{var eo;this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:null!==(eo=this.syncToken)&&void 0!==eo?eo:void 0},ei)}).then(()=>{this.dirty=!1,null==ea||ea(!0)},ei=>{eu.logger.error("Failed to save device tracking data",this.syncToken),eu.logger.error(ei)})},ei)}return ea}getSyncToken(){return this.syncToken}setSyncToken(ei){this.syncToken=ei}downloadKeys(ei,eo){let ea=[],ec=[];if(ei.forEach(ei=>{let ed=this.deviceTrackingStatus[ei];this.keyDownloadsInProgressByUser.has(ei)?(eu.logger.log(`downloadKeys: already have a download in progress for ${ei}: awaiting its result`),ec.push(this.keyDownloadsInProgressByUser.get(ei))):(eo||ed!=ew.UpToDate)&&ea.push(ei)}),0!=ea.length){eu.logger.log("downloadKeys: downloading for",ea);let ei=this.doKeyDownload(ea);ec.push(ei)}return 0===ec.length&&eu.logger.log("downloadKeys: already have all necessary keys"),Promise.all(ec).then(()=>this.getDevicesFromStore(ei))}getDevicesFromStore(ei){let eo=new Map;return ei.forEach(ei=>{var ea;let ec=new Map;null===(ea=this.getStoredDevicesForUser(ei))||void 0===ea||ea.forEach(function(ei){ec.set(ei.deviceId,ei)}),eo.set(ei,ec)}),eo}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(ei){let eo=this.devices[ei];if(!eo)return null;let ea=[];for(let ei in eo)eo.hasOwnProperty(ei)&&ea.push(eh.DeviceInfo.fromStorage(eo[ei],ei));return ea}getRawStoredDevicesForUser(ei){return this.devices[ei]}getStoredCrossSigningForUser(ei){return this.crossSigningInfo[ei]?ef.CrossSigningInfo.fromStorage(this.crossSigningInfo[ei],ei):null}storeCrossSigningForUser(ei,eo){this.crossSigningInfo[ei]=eo,this.dirty=!0}getStoredDevice(ei,eo){let ea=this.devices[ei];if(null!=ea&&ea[eo])return eh.DeviceInfo.fromStorage(ea[eo],eo)}getUserByIdentityKey(ei,eo){return ei!==ep.OLM_ALGORITHM&&ei!==ep.MEGOLM_ALGORITHM?null:this.userByIdentityKey[eo]}getDeviceByIdentityKey(ei,eo){let ea=this.getUserByIdentityKey(ei,eo);if(!ea)return null;let ec=this.devices[ea];if(!ec)return null;for(let ei in ec){if(!ec.hasOwnProperty(ei))continue;let ea=ec[ei];for(let ec in ea.keys){if(!ea.keys.hasOwnProperty(ec)||0!==ec.indexOf("curve25519:"))continue;let ed=ea.keys[ec];if(ed==eo)return eh.DeviceInfo.fromStorage(ea,ei)}}return null}storeDevicesForUser(ei,eo){this.setRawStoredDevicesForUser(ei,eo),this.dirty=!0}startTrackingDeviceList(ei){if("string"!=typeof ei)throw Error("userId must be a string; was "+ei);this.deviceTrackingStatus[ei]||(eu.logger.log("Now tracking device list for "+ei),this.deviceTrackingStatus[ei]=ew.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(ei){this.deviceTrackingStatus[ei]&&(eu.logger.log("No longer tracking device list for "+ei),this.deviceTrackingStatus[ei]=ew.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(let ei of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[ei]=ew.NotTracked;this.dirty=!0}invalidateUserDeviceList(ei){this.deviceTrackingStatus[ei]&&(eu.logger.log("Marking device list outdated for",ei),this.deviceTrackingStatus[ei]=ew.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();let ei=[];for(let eo of Object.keys(this.deviceTrackingStatus)){let ea=this.deviceTrackingStatus[eo];ea==ew.PendingDownload&&ei.push(eo)}return this.doKeyDownload(ei)}setRawStoredDevicesForUser(ei,eo){if(void 0!==this.devices[ei])for(let[eo,ea]of Object.entries(this.devices[ei])){let ei=ea.keys["curve25519:"+eo];delete this.userByIdentityKey[ei]}for(let[ea,ec]of(this.devices[ei]=eo,Object.entries(eo))){let eo=ec.keys["curve25519:"+ea];this.userByIdentityKey[eo]=ei}}setRawStoredCrossSigningForUser(ei,eo){this.crossSigningInfo[ei]=eo}doKeyDownload(ei){if(0===ei.length)return Promise.resolve();let eo=this.serialiser.updateDevicesForUsers(ei,this.syncToken).then(()=>{ea(!0)},eo=>{throw eu.logger.error("Error downloading keys for "+ei+":",eo),ea(!1),eo});ei.forEach(ei=>{this.keyDownloadsInProgressByUser.set(ei,eo);let ea=this.deviceTrackingStatus[ei];ea==ew.PendingDownload&&(this.deviceTrackingStatus[ei]=ew.DownloadInProgress)});let ea=ea=>{this.emit(eb.CryptoEvent.WillUpdateDevices,ei,!this.hasFetched),ei.forEach(ei=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(ei)!==eo){eu.logger.log("Another update in the queue for",ei,"- not marking up-to-date");return}this.keyDownloadsInProgressByUser.delete(ei);let ec=this.deviceTrackingStatus[ei];ec==ew.DownloadInProgress&&(ea?(this.deviceTrackingStatus[ei]=ew.UpToDate,eu.logger.log("Device list for",ei,"now up to date")):this.deviceTrackingStatus[ei]=ew.PendingDownload)}),this.saveIfDirty(),this.emit(eb.CryptoEvent.DevicesUpdated,ei,!this.hasFetched),this.hasFetched=!0};return eo}}eo.DeviceList=e_;class eT{constructor(ei,eo,ea){this.baseApis=ei,this.olmDevice=eo,this.deviceList=ea,(0,ed.default)(this,"downloadInProgress",!1),(0,ed.default)(this,"keyDownloadsQueuedByUser",{}),(0,ed.default)(this,"queuedQueryDeferred",void 0),(0,ed.default)(this,"syncToken",void 0)}updateDevicesForUsers(ei,eo){return(ei.forEach(ei=>{this.keyDownloadsQueuedByUser[ei]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,em.defer)()),this.syncToken=eo,this.downloadInProgress)?(eu.logger.log("Queued key download for",ei),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");let ei=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};let eo=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,eu.logger.log("Starting key download for",ei),this.downloadInProgress=!0;let ea={};this.syncToken&&(ea.token=this.syncToken);let ec=[];for(let eo=0;eo<ei.length;eo+=this.deviceList.keyDownloadChunkSize){let ed=ei.slice(eo,eo+this.deviceList.keyDownloadChunkSize);ec.push(()=>this.baseApis.downloadKeysForUsers(ed,ea))}return(0,em.chunkPromises)(ec,3).then(async eo=>{let ea=Object.assign({},...eo.map(ei=>ei.device_keys||{})),ec=Object.assign({},...eo.map(ei=>ei.master_keys||{})),ed=Object.assign({},...eo.map(ei=>ei.self_signing_keys||{})),eh=Object.assign({},...eo.map(ei=>ei.user_signing_keys||{}));for(let eo of ei){await (0,em.sleep)(5);try{await this.processQueryResponseForUser(eo,ea[eo],{master:null==ec?void 0:ec[eo],self_signing:null==ed?void 0:ed[eo],user_signing:null==eh?void 0:eh[eo]})}catch(ei){eu.logger.error(`Error processing keys for ${eo}:`,ei)}}}).then(()=>{eu.logger.log("Completed key download for "+ei),this.downloadInProgress=!1,null==eo||eo.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},ea=>{eu.logger.warn("Error downloading keys for "+ei+":",ea),this.downloadInProgress=!1,null==eo||eo.reject(ea)}),eo.promise}async processQueryResponseForUser(ei,eo,ea){eu.logger.log("got device keys for "+ei+":",eo),eu.logger.log("got cross-signing keys for "+ei+":",ea);{let ea={},ec=this.deviceList.getRawStoredDevicesForUser(ei);ec&&Object.keys(ec).forEach(ei=>{let eo=eh.DeviceInfo.fromStorage(ec[ei],ei);ea[ei]=eo}),await eI(this.olmDevice,ei,ea,eo||{},this.baseApis.getUserId(),this.baseApis.deviceId);let ed={};Object.keys(ea).forEach(ei=>{ed[ei]=ea[ei].toStorage()}),this.deviceList.setRawStoredDevicesForUser(ei,ed)}if(ea&&(ea.master||ea.self_signing||ea.user_signing)){let eo=this.deviceList.getStoredCrossSigningForUser(ei)||new ef.CrossSigningInfo(ei);eo.setKeys(ea),this.deviceList.setRawStoredCrossSigningForUser(ei,eo.toStorage()),this.deviceList.emit(eb.CryptoEvent.UserCrossSigningUpdated,ei)}}}async function eI(ei,eo,ea,ec,ed,eh){let ef=!1;for(let ei in ea)if(ea.hasOwnProperty(ei)&&!(ei in ec)){if(eo===ed&&ei===eh){eu.logger.warn(`Local device ${ei} missing from sync, skipping removal`);continue}eu.logger.log("Device "+eo+":"+ei+" has been removed"),delete ea[ei],ef=!0}for(let ed in ec){if(!ec.hasOwnProperty(ed))continue;let eh=ec[ed];if(eh.user_id!==eo){eu.logger.warn("Mismatched user_id "+eh.user_id+" in keys from "+eo+":"+ed);continue}if(eh.device_id!==ed){eu.logger.warn("Mismatched device_id "+eh.device_id+" in keys from "+eo+":"+ed);continue}await eC(ei,ea,eh)&&(ef=!0)}return ef}async function eC(ei,eo,ea){let ec;if(!ea.keys)return!1;let ed=ea.device_id,ef=ea.user_id,eg="ed25519:"+ed,em=ea.keys[eg];if(!em)return eu.logger.warn("Device "+ef+":"+ed+" has no ed25519 key"),!1;let ey=ea.unsigned||{},eb=ea.signatures||{};try{await ep.verifySignature(ei,ea,ef,ed,em)}catch(ei){return eu.logger.warn("Unable to verify signature on device "+ef+":"+ed+":"+ei),!1}if(ed in eo){if((ec=eo[ed]).getFingerprint()!=em)return eu.logger.warn("Ed25519 key for device "+ef+":"+ed+" has changed"),!1}else eo[ed]=ec=new eh.DeviceInfo(ed);return ec.keys=ea.keys||{},ec.algorithms=ea.algorithms||[],ec.unsigned=ey,ec.signatures=eb,!0}},636:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.EncryptionSetupOperation=eo.EncryptionSetupBuilder=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(4369),ef=ea(3075),ep=ea(7585),eg=ea(95),em=ea(2168),ey=ea(5861);class eb{constructor(ei,eo){(0,ed.default)(this,"accountDataClientAdapter",void 0),(0,ed.default)(this,"crossSigningCallbacks",void 0),(0,ed.default)(this,"ssssCryptoCallbacks",void 0),(0,ed.default)(this,"crossSigningKeys",void 0),(0,ed.default)(this,"keySignatures",void 0),(0,ed.default)(this,"keyBackupInfo",void 0),(0,ed.default)(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new eE(ei),this.crossSigningCallbacks=new ew,this.ssssCryptoCallbacks=new e_(eo)}addCrossSigningKeys(ei,eo){this.crossSigningKeys={authUpload:ei,keys:eo}}addSessionBackup(ei){this.keyBackupInfo=ei}addSessionBackupPrivateKeyToCache(ei){this.sessionBackupPrivateKey=ei}addKeySignature(ei,eo,ea){this.keySignatures||(this.keySignatures={});let ec=this.keySignatures[ei]||{};this.keySignatures[ei]=ec,ec[eo]=ea}async setAccountData(ei,eo){await this.accountDataClientAdapter.setAccountData(ei,eo)}buildOperation(){let ei=this.accountDataClientAdapter.values;return new eS(ei,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(ei){if(this.crossSigningKeys){let ea=(0,ef.createCryptoStoreCacheCallbacks)(ei.cryptoStore,ei.olmDevice);for(let ei of["master","self_signing","user_signing"]){var eo;eu.logger.log(`Cache ${ei} cross-signing private key locally`);let ec=this.crossSigningCallbacks.privateKeys.get(ei);await (null===(eo=ea.storeCrossSigningKeyCache)||void 0===eo?void 0:eo.call(ea,ei,ec))}await ei.cryptoStore.doTxn("readwrite",[ep.IndexedDBCryptoStore.STORE_ACCOUNT],eo=>{ei.cryptoStore.storeCrossSigningKeys(eo,this.crossSigningKeys.keys)})}this.sessionBackupPrivateKey&&await ei.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}eo.EncryptionSetupBuilder=eb;class eS{constructor(ei,eo,ea,ec){this.accountData=ei,this.crossSigningKeys=eo,this.keyBackupInfo=ea,this.keySignatures=ec}async apply(ei){let eo=ei.baseApis;if(this.crossSigningKeys){var ea,ec;let ed={};for(let[ei,eo]of Object.entries(this.crossSigningKeys.keys))ed[ei+"_key"]=eo;await (null===(ea=(ec=this.crossSigningKeys).authUpload)||void 0===ea?void 0:ea.call(ec,ei=>eo.uploadDeviceSigningKeys(ei,ed))),ei.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(let[ei,ea]of this.accountData)await eo.setAccountData(ei,ea);this.keySignatures&&await eo.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await eo.http.authedRequest(eg.Method.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:eg.ClientPrefix.V3}):await eo.http.authedRequest(eg.Method.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:eg.ClientPrefix.V3}))}}eo.EncryptionSetupOperation=eS;class eE extends ey.TypedEventEmitter{constructor(ei){super(),this.existingValues=ei,(0,ed.default)(this,"values",new Map)}getAccountDataFromServer(ei){return Promise.resolve(this.getAccountData(ei))}getAccountData(ei){let eo=this.values.get(ei);if(eo)return eo;let ea=this.existingValues.get(ei);return ea?ea.getContent():null}setAccountData(ei,eo){let ea=this.values.get(ei);return this.values.set(ei,eo),Promise.resolve().then(()=>{let ec=new eh.MatrixEvent({type:ei,content:eo});return this.emit(em.ClientEvent.AccountData,ec,ea),{}})}}class ew{constructor(){(0,ed.default)(this,"privateKeys",new Map)}getCrossSigningKeyCache(ei,eo){return this.getCrossSigningKey(ei,eo)}storeCrossSigningKeyCache(ei,eo){return this.privateKeys.set(ei,eo),Promise.resolve()}getCrossSigningKey(ei,eo){var ea;return Promise.resolve(null!==(ea=this.privateKeys.get(ei))&&void 0!==ea?ea:null)}saveCrossSigningKeys(ei){for(let[eo,ea]of Object.entries(ei))this.privateKeys.set(eo,ea)}}class e_{constructor(ei){this.delegateCryptoCallbacks=ei,(0,ed.default)(this,"privateKeys",new Map)}async getSecretStorageKey({keys:ei},eo){var ea;for(let eo of Object.keys(ei)){let ei=this.privateKeys.get(eo);if(ei)return[eo,ei]}if(this!==null&&void 0!==this&&null!==(ea=this.delegateCryptoCallbacks)&&void 0!==ea&&ea.getSecretStorageKey){let ea=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:ei},eo);if(ea){let[ei,eo]=ea;this.privateKeys.set(ei,eo)}return ea}return null}addPrivateKey(ei,eo,ea){var ec,ed;this.privateKeys.set(ei,ea),null===(ec=this.delegateCryptoCallbacks)||void 0===ec||null===(ed=ec.cacheSecretStorageKey)||void 0===ed||ed.call(ec,ei,eo,ea)}}},2573:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.WITHHELD_MESSAGES=eo.PayloadTooLargeError=eo.OlmDevice=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(7585),ef=eg(ea(1994));function ep(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ep=function(ei){return ei?ea:eo})(ei)}function eg(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ep(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let em=49152;class ey extends Error{constructor(...ei){super(...ei),(0,ed.default)(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function eb(ei){if(void 0===ei)throw Error("payloadString undefined");if(ei.length>em)throw new ey(`Message too long (${ei.length} bytes). The maximum for an encrypted message is ${em} bytes.`)}eo.PayloadTooLargeError=ey;class eS{constructor(ei){this.cryptoStore=ei,(0,ed.default)(this,"pickleKey","DEFAULT_KEY"),(0,ed.default)(this,"deviceCurve25519Key",null),(0,ed.default)(this,"deviceEd25519Key",null),(0,ed.default)(this,"maxOneTimeKeys",null),(0,ed.default)(this,"outboundGroupSessionStore",{}),(0,ed.default)(this,"inboundGroupSessionMessageIndexes",{}),(0,ed.default)(this,"sessionsInProgress",{}),(0,ed.default)(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return ea.g.Olm.get_library_version()}async init({pickleKey:ei,fromExportedDevice:eo}={}){let ec;let ed=new ea.g.Olm.Account;try{eo?(ei&&eu.logger.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=eo.pickleKey,await this.initialiseFromExportedDevice(eo,ed)):(ei&&(this.pickleKey=ei),await this.initialiseAccount(ed)),ec=JSON.parse(ed.identity_keys()),this.maxOneTimeKeys=ed.max_number_of_one_time_keys()}finally{ed.free()}this.deviceCurve25519Key=ec.curve25519,this.deviceEd25519Key=ec.ed25519}async initialiseFromExportedDevice(ei,eo){await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT,eh.IndexedDBCryptoStore.STORE_SESSIONS],eo=>{this.cryptoStore.storeAccount(eo,ei.pickledAccount),ei.sessions.forEach(ei=>{let{deviceKey:ea,sessionId:ec}=ei,ed={session:ei.session,lastReceivedMessageTs:ei.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(ea,ec,ed,eo)})}),eo.unpickle(this.pickleKey,ei.pickledAccount)}async initialiseAccount(ei){await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],eo=>{this.cryptoStore.getAccount(eo,ea=>{null!==ea?ei.unpickle(this.pickleKey,ea):(ei.create(),ea=ei.pickle(this.pickleKey),this.cryptoStore.storeAccount(eo,ea))})})}getAccount(ei,eo){this.cryptoStore.getAccount(ei,ei=>{let ec=new ea.g.Olm.Account;try{ec.unpickle(this.pickleKey,ei),eo(ec)}finally{ec.free()}})}storeAccount(ei,eo){this.cryptoStore.storeAccount(ei,eo.pickle(this.pickleKey))}async export(){let ei={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_ACCOUNT,eh.IndexedDBCryptoStore.STORE_SESSIONS],eo=>{this.cryptoStore.getAccount(eo,eo=>{ei.pickledAccount=eo}),ei.sessions=[],this.cryptoStore.getAllEndToEndSessions(eo,eo=>{ei.sessions.push(eo)})}),ei}getSession(ei,eo,ea,ec){this.cryptoStore.getEndToEndSession(ei,eo,ea,ei=>{this.unpickleSession(ei,ec)})}unpickleSession(ei,eo){let ec=new ea.g.Olm.Session;try{ec.unpickle(this.pickleKey,ei.session);let ea=Object.assign({},ei,{session:ec});eo(ea)}finally{ec.free()}}saveSession(ei,eo,ea){let ec=eo.session.session_id();eu.logger.debug(`Saving Olm session ${ec} with device ${ei}: ${eo.session.describe()}`);let ed=Object.assign(eo,{session:eo.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(ei,ec,ed,ea)}getUtility(ei){let eo=new ea.g.Olm.Utility;try{return ei(eo)}finally{eo.free()}}async sign(ei){let eo;return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],ea=>{this.getAccount(ea,ea=>{eo=ea.sign(ei)})}),eo}async getOneTimeKeys(){let ei;return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],eo=>{this.getAccount(eo,eo=>{ei=JSON.parse(eo.one_time_keys())})}),ei}maxNumberOfOneTimeKeys(){var ei;return null!==(ei=this.maxOneTimeKeys)&&void 0!==ei?ei:-1}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.getAccount(ei,eo=>{eo.mark_keys_as_published(),this.storeAccount(ei,eo)})})}generateOneTimeKeys(ei){return this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],eo=>{this.getAccount(eo,ea=>{ea.generate_one_time_keys(ei),this.storeAccount(eo,ea)})})}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.getAccount(ei,eo=>{eo.generate_fallback_key(),this.storeAccount(ei,eo)})})}async getFallbackKey(){let ei;return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],eo=>{this.getAccount(eo,eo=>{ei=JSON.parse(eo.unpublished_fallback_key())})}),ei}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.getAccount(ei,eo=>{eo.forget_old_fallback_key(),this.storeAccount(ei,eo)})})}async createOutboundSession(ei,eo){let ec;return await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT,eh.IndexedDBCryptoStore.STORE_SESSIONS],ed=>{this.getAccount(ed,eu=>{let eh=new ea.g.Olm.Session;try{eh.create_outbound(eu,ei,eo),ec=eh.session_id(),this.storeAccount(ed,eu);let ea={session:eh,lastReceivedMessageTs:Date.now()};this.saveSession(ei,ea,ed)}finally{eh.free()}})},eu.logger.withPrefix("[createOutboundSession]")),ec}async createInboundSession(ei,eo,ec){let ed;if(0!==eo)throw Error("Need messageType == 0 to create inbound session");return await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_ACCOUNT,eh.IndexedDBCryptoStore.STORE_SESSIONS],eu=>{this.getAccount(eu,eh=>{let ef=new ea.g.Olm.Session;try{ef.create_inbound_from(eh,ei,ec),eh.remove_one_time_keys(ef),this.storeAccount(eu,eh);let ea=ef.decrypt(eo,ec),ep={session:ef,lastReceivedMessageTs:Date.now()};this.saveSession(ei,ep,eu),ed={payload:ea,session_id:ef.session_id()}}finally{ef.free()}})},eu.logger.withPrefix("[createInboundSession]")),ed}async getSessionIdsForDevice(ei){let eo;let ea=eu.logger.withPrefix("[getSessionIdsForDevice]");if(ei in this.sessionsInProgress){ea.debug(`Waiting for Olm session for ${ei} to be created`);try{await this.sessionsInProgress[ei]}catch(ei){}}return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_SESSIONS],ea=>{this.cryptoStore.getEndToEndSessions(ei,ea,ei=>{eo=Object.keys(ei)})},ea),eo}async getSessionIdForDevice(ei,eo=!1,ea){let ec=await this.getSessionInfoForDevice(ei,eo,ea);if(0===ec.length)return null;let ed=0;for(let ei=1;ei<ec.length;ei++){let eo=ec[ei],ea=void 0===eo.lastReceivedMessageTs?0:eo.lastReceivedMessageTs,eu=ec[ed],eh=void 0===eu.lastReceivedMessageTs?0:eu.lastReceivedMessageTs;(ea>eh||ea===eh&&eo.sessionId<eu.sessionId)&&(ed=ei)}return ec[ed].sessionId}async getSessionInfoForDevice(ei,eo=!1,ea=eu.logger){if(ea=ea.withPrefix("[getSessionInfoForDevice]"),ei in this.sessionsInProgress&&!eo){ea.debug(`Waiting for Olm session for ${ei} to be created`);try{await this.sessionsInProgress[ei]}catch(ei){}}let ec=[];return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_SESSIONS],eo=>{this.cryptoStore.getEndToEndSessions(ei,eo,ei=>{let eo=Object.keys(ei).sort();for(let ea of eo)this.unpickleSession(ei[ea],ei=>{ec.push({lastReceivedMessageTs:ei.lastReceivedMessageTs,hasReceivedMessage:ei.session.has_received_message(),sessionId:ea})})})},ea),ec}async encryptMessage(ei,eo,ea){let ec;return eb(ea),await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_SESSIONS],ed=>{this.getSession(ei,eo,ed,eh=>{let ef=eh.session.describe();eu.logger.log("encryptMessage: Olm Session ID "+eo+" to "+ei+": "+ef),ec=eh.session.encrypt(ea),this.saveSession(ei,eh,ed)})},eu.logger.withPrefix("[encryptMessage]")),ec}async decryptMessage(ei,eo,ea,ec){let ed;return await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_SESSIONS],eh=>{this.getSession(ei,eo,eh,ef=>{let ep=ef.session.describe();eu.logger.log("decryptMessage: Olm Session ID "+eo+" from "+ei+": "+ep),ed=ef.session.decrypt(ea,ec),ef.lastReceivedMessageTs=Date.now(),this.saveSession(ei,ef,eh)})},eu.logger.withPrefix("[decryptMessage]")),ed}async matchesSession(ei,eo,ea,ec){let ed;return 0===ea&&(await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_SESSIONS],ea=>{this.getSession(ei,eo,ea,ei=>{ed=ei.session.matches_inbound(ec)})},eu.logger.withPrefix("[matchesSession]")),ed)}async recordSessionProblem(ei,eo,ea){eu.logger.info(`Recording problem on olm session with ${ei} of type ${eo}. Recreating: ${ea}`),await this.cryptoStore.storeEndToEndSessionProblem(ei,eo,ea)}sessionMayHaveProblems(ei,eo){return this.cryptoStore.getEndToEndSessionProblem(ei,eo)}filterOutNotifiedErrorDevices(ei){return this.cryptoStore.filterOutNotifiedErrorDevices(ei)}saveOutboundGroupSession(ei){this.outboundGroupSessionStore[ei.session_id()]=ei.pickle(this.pickleKey)}getOutboundGroupSession(ei,eo){let ec=this.outboundGroupSessionStore[ei];if(void 0===ec)throw Error("Unknown outbound group session "+ei);let ed=new ea.g.Olm.OutboundGroupSession;try{return ed.unpickle(this.pickleKey,ec),eo(ed)}finally{ed.free()}}createOutboundGroupSession(){let ei=new ea.g.Olm.OutboundGroupSession;try{return ei.create(),this.saveOutboundGroupSession(ei),ei.session_id()}finally{ei.free()}}encryptGroupMessage(ei,eo){return eu.logger.log(`encrypting msg with megolm session ${ei}`),eb(eo),this.getOutboundGroupSession(ei,ei=>{let ea=ei.encrypt(eo);return this.saveOutboundGroupSession(ei),ea})}getOutboundGroupSessionKey(ei){return this.getOutboundGroupSession(ei,function(ei){return{chain_index:ei.message_index(),key:ei.session_key()}})}unpickleInboundGroupSession(ei,eo){let ec=new ea.g.Olm.InboundGroupSession;try{return ec.unpickle(this.pickleKey,ei.session),eo(ec)}finally{ec.free()}}getInboundGroupSession(ei,eo,ea,ec,ed){this.cryptoStore.getEndToEndInboundGroupSession(eo,ea,ec,(eo,ea)=>{if(null===eo){ed(null,null,ea);return}if(null!==ei&&ei!==eo.room_id)throw Error("Mismatched room_id for inbound group session (expected "+eo.room_id+", was "+ei+")");this.unpickleInboundGroupSession(eo,ei=>{ed(ei,eo,ea)})})}async addInboundGroupSession(ei,eo,ec,ed,ef,ep,eg,em={}){await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,eh.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],eh=>{this.getInboundGroupSession(ei,eo,ed,eh,(ey,eb)=>{let eS=new ea.g.Olm.InboundGroupSession;try{if(eg?eS.import_session(ef):eS.create(ef),ed!=eS.session_id())throw Error("Mismatched group session ID from senderKey: "+eo);if(ey&&(eu.logger.log(`Update for megolm session ${eo}|${ed}`),ey.first_known_index()<=eS.first_known_index())){if(!eb.untrusted||em.untrusted){eu.logger.log(`Keeping existing megolm session ${eo}|${ed}`);return}if(ey.first_known_index()<eS.first_known_index()){ey.export_session(eS.first_known_index())===eS.export_session(eS.first_known_index())?(eu.logger.info(`Upgrading trust of existing megolm session ${eo}|${ed} based on newly-received trusted session`),eb.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(eo,ed,eb,eh)):eu.logger.warn(`Newly-received megolm session ${eo}|$sessionId} does not match existing session! Keeping existing session`);return}}eu.logger.info(`Storing megolm session ${eo}|${ed} with first index `+eS.first_known_index());let ea=Object.assign({},em,{room_id:ei,session:eS.pickle(this.pickleKey),keysClaimed:ep,forwardingCurve25519KeyChain:ec});this.cryptoStore.storeEndToEndInboundGroupSession(eo,ed,ea,eh),!ey&&em.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(ei,eo,ed,eh)}finally{eS.free()}})},eu.logger.withPrefix("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(ei,eo,ea,ec,ed){await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],eu=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(eo,ea,{room_id:ei,code:ec,reason:ed},eu)})}async decryptGroupMessage(ei,eo,ea,ec,ed,ep){let eg,em=null;if(await this.cryptoStore.doTxn("readwrite",[eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],eu=>{this.getInboundGroupSession(ei,eo,ea,eu,(ei,eh,ey)=>{let eb;if(null===ei||null===eh){ey&&(eg=new ef.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",ew(ey),{session:eo+"|"+ea})),em=null;return}try{eb=ei.decrypt(ec)}catch(ei){eg=(null==ei?void 0:ei.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&ey?new ef.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",ew(ey),{session:eo+"|"+ea}):ei;return}let eS=eb.plaintext;if(void 0===eS)eS=eb;else{let ei=eo+"|"+ea+"|"+eb.message_index;if(ei in this.inboundGroupSessionMessageIndexes){let eo=this.inboundGroupSessionMessageIndexes[ei];if(eo.id!==ed||eo.timestamp!==ep){eg=Error("Duplicate message index, possible replay attack: "+ei);return}}this.inboundGroupSessionMessageIndexes[ei]={id:ed,timestamp:ep}}eh.session=ei.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(eo,ea,eh,eu),em={result:eS,keysClaimed:eh.keysClaimed||{},senderKey:eo,forwardingCurve25519KeyChain:eh.forwardingCurve25519KeyChain||[],untrusted:!!eh.untrusted}})},eu.logger.withPrefix("[decryptGroupMessage]")),eg)throw eg;return em}async hasInboundSessionKeys(ei,eo,ea){let ec;return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],ed=>{this.cryptoStore.getEndToEndInboundGroupSession(eo,ea,ed,ed=>{if(null===ed){ec=!1;return}ei!==ed.room_id?(eu.logger.warn(`requested keys for inbound group session ${eo}|${ea}, with incorrect room_id (expected ${ed.room_id}, was ${ei})`),ec=!1):ec=!0})},eu.logger.withPrefix("[hasInboundSessionKeys]")),ec}async getInboundGroupSessionKey(ei,eo,ea,ec){let ed=null;return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,eh.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],eu=>{this.getInboundGroupSession(ei,eo,ea,eu,(ei,eo)=>{if(null===ei||null===eo){ed=null;return}void 0===ec&&(ec=ei.first_known_index());let ea=ei.export_session(ec),eu=eo.keysClaimed||{},eh=eu.ed25519||null,ef=eo.forwardingCurve25519KeyChain||[],ep="untrusted"in eo?eo.untrusted:ef.length>0;ed={chain_index:ec,key:ea,forwarding_curve25519_key_chain:ef,sender_claimed_ed25519_key:eh,shared_history:eo.sharedHistory||!1,untrusted:ep}})},eu.logger.withPrefix("[getInboundGroupSessionKey]")),ed}exportInboundGroupSession(ei,eo,ea){return this.unpickleInboundGroupSession(ea,ec=>{let ed=ec.first_known_index();return{sender_key:ei,sender_claimed_keys:ea.keysClaimed,room_id:ea.room_id,session_id:eo,session_key:ec.export_session(ed),forwarding_curve25519_key_chain:ea.forwardingCurve25519KeyChain||[],first_known_index:ec.first_known_index(),"org.matrix.msc3061.shared_history":ea.sharedHistory||!1}})}async getSharedHistoryInboundGroupSessions(ei){let eo;return await this.cryptoStore.doTxn("readonly",[eh.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],ea=>{eo=this.cryptoStore.getSharedHistoryInboundGroupSessions(ei,ea)},eu.logger.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),eo}verifySignature(ei,eo,ea){this.getUtility(function(ec){ec.ed25519_verify(ei,eo,ea)})}}eo.OlmDevice=eS;let eE={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function ew(ei){return ei.code&&ei.code in eE?eE[ei.code]:ei.reason?ei.reason:"decryption key withheld"}eo.WITHHELD_MESSAGES=eE},6617:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomKeyRequestState=eo.OutgoingRoomKeyRequestManager=void 0;var ed=ec(ea(8416)),eu=ea(7429),eh=ea(7434),ef=ea(2481),ep=ea(3102);function eg(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function em(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eg(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eg(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let ey=500,eb=function(ei){return ei[ei.Unsent=0]="Unsent",ei[ei.Sent=1]="Sent",ei[ei.CancellationPending=2]="CancellationPending",ei[ei.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend",ei}({});eo.RoomKeyRequestState=eb;class eS{constructor(ei,eo,ea){this.baseApis=ei,this.deviceId=eo,this.cryptoStore=ea,(0,ed.default)(this,"sendOutgoingRoomKeyRequestsTimer",void 0),(0,ed.default)(this,"sendOutgoingRoomKeyRequestsRunning",!1),(0,ed.default)(this,"clientRunning",!0)}stop(){eh.logger.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(ei,eo,ea=!1){let ec=await this.cryptoStore.getOutgoingRoomKeyRequest(ei);if(ec)switch(ec.state){case eb.CancellationPendingAndWillResend:case eb.Unsent:return;case eb.CancellationPending:{let ei=ea?eb.CancellationPendingAndWillResend:eb.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(ec.requestId,eb.CancellationPending,{state:ei,cancellationTxnId:this.baseApis.makeTxnId()});break}case eb.Sent:if(ea){let ed=eb.CancellationPendingAndWillResend,eu=await this.cryptoStore.updateOutgoingRoomKeyRequest(ec.requestId,eb.Sent,{state:ed,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!eu)return this.queueRoomKeyRequest(ei,eo,ea);try{await this.sendOutgoingRoomKeyRequestCancellation(eu,!0)}catch(ei){eh.logger.error("Error sending room key request cancellation; will retry later.",ei)}}break;default:throw Error("unhandled state: "+ec.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:ei,recipients:eo,requestId:this.baseApis.makeTxnId(),state:eb.Unsent})}cancelRoomKeyRequest(ei){return this.cryptoStore.getOutgoingRoomKeyRequest(ei).then(eo=>{if(eo)switch(eo.state){case eb.CancellationPending:case eb.CancellationPendingAndWillResend:return;case eb.Unsent:return eh.logger.log("deleting unnecessary room key request for "+eE(ei)),this.cryptoStore.deleteOutgoingRoomKeyRequest(eo.requestId,eb.Unsent);case eb.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(eo.requestId,eb.Sent,{state:eb.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then(eo=>{if(!eo){eh.logger.log("Tried to cancel room key request for "+eE(ei)+" but it was already cancelled in another tab");return}this.sendOutgoingRoomKeyRequestCancellation(eo).catch(ei=>{eh.logger.error("Error sending room key request cancellation; will retry later.",ei),this.startTimer()})});default:throw Error("unhandled state: "+eo.state)}})}getOutgoingSentRoomKeyRequest(ei,eo){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(ei,eo,[eb.Sent])}async cancelAndResendAllOutgoingRequests(){let ei=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(eb.Sent);return Promise.all(ei.map(({requestBody:ei,recipients:eo})=>this.queueRoomKeyRequest(ei,eo,!0)))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;let ei=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(ei=>{eh.logger.warn(`error in OutgoingRoomKeyRequestManager: ${ei}`)})};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(ei,ey)}async sendOutgoingRoomKeyRequests(){if(!this.clientRunning){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}let ei=await this.cryptoStore.getOutgoingRoomKeyRequestByState([eb.CancellationPending,eb.CancellationPendingAndWillResend,eb.Unsent]);if(!ei){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}try{switch(ei.state){case eb.Unsent:await this.sendOutgoingRoomKeyRequest(ei);break;case eb.CancellationPending:await this.sendOutgoingRoomKeyRequestCancellation(ei);break;case eb.CancellationPendingAndWillResend:await this.sendOutgoingRoomKeyRequestCancellation(ei,!0)}return this.sendOutgoingRoomKeyRequests()}catch(ei){eh.logger.error("Error sending room key request; will retry later.",ei),this.sendOutgoingRoomKeyRequestsTimer=void 0}}sendOutgoingRoomKeyRequest(ei){eh.logger.log(`Requesting keys for ${eE(ei.requestBody)} from ${ew(ei.recipients)}(id ${ei.requestId})`);let eo={action:"request",requesting_device_id:this.deviceId,request_id:ei.requestId,body:ei.requestBody};return this.sendMessageToDevices(eo,ei.recipients,ei.requestTxnId||ei.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(ei.requestId,eb.Unsent,{state:eb.Sent}))}sendOutgoingRoomKeyRequestCancellation(ei,eo=!1){eh.logger.log(`Sending cancellation for key request for ${eE(ei.requestBody)} to ${ew(ei.recipients)} (cancellation id ${ei.cancellationTxnId})`);let ea={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:ei.requestId};return this.sendMessageToDevices(ea,ei.recipients,ei.cancellationTxnId).then(()=>eo?this.cryptoStore.updateOutgoingRoomKeyRequest(ei.requestId,eb.CancellationPendingAndWillResend,{state:eb.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(ei.requestId,eb.CancellationPending))}sendMessageToDevices(ei,eo,ea){let ec=new ep.MapWithDefault(()=>new Map);for(let ea of eo){let eo=ec.getOrCreate(ea.userId);eo.set(ea.deviceId,em(em({},ei),{},{[ef.ToDeviceMessageId]:(0,eu.v4)()}))}return this.baseApis.sendToDevice(ef.EventType.RoomKeyRequest,ec,ea)}}function eE(ei){return ei.room_id+" / "+ei.session_id}function ew(ei){return`[${ei.map(ei=>`${ei.userId}:${ei.deviceId}`).join(",")}]`}eo.OutgoingRoomKeyRequestManager=eS},635:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomList=void 0;var ed=ec(ea(8416)),eu=ea(7585);class eh{constructor(ei){this.cryptoStore=ei,(0,ed.default)(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[eu.IndexedDBCryptoStore.STORE_ROOMS],ei=>{this.cryptoStore.getEndToEndRooms(ei,ei=>{this.roomEncryption=ei})})}getRoomEncryption(ei){return this.roomEncryption[ei]||null}isRoomEncrypted(ei){return!!this.getRoomEncryption(ei)}async setRoomEncryption(ei,eo){this.roomEncryption[ei]=eo,await this.cryptoStore.doTxn("readwrite",[eu.IndexedDBCryptoStore.STORE_ROOMS],ea=>{this.cryptoStore.storeEndToEndRoom(ei,eo,ea)})}}eo.RoomList=eh},1922:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SecretSharing=void 0;var ed=ec(ea(8416)),eu=ea(7429),eh=ea(3102),ef=ea(2481),ep=ea(7434),eg=ey(ea(2772));function em(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(em=function(ei){return ei?ea:eo})(ei)}function ey(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=em(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}class eb{constructor(ei,eo){this.baseApis=ei,this.cryptoCallbacks=eo,(0,ed.default)(this,"requests",new Map)}request(ei,eo){let ea=this.baseApis.makeTxnId(),ec=(0,eh.defer)();this.requests.set(ea,{name:ei,devices:eo,deferred:ec});let ed=ei=>{let ed={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:ea},eu=new Map;for(let ei of eo)eu.set(ei,ed);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),eu]])),ec.reject(Error(ei||"Cancelled"))},eg={name:ei,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:ea,[ef.ToDeviceMessageId]:(0,eu.v4)()},em=new Map;for(let ei of eo)em.set(ei,eg);return ep.logger.info(`Request secret ${ei} from ${eo}, id ${ea}`),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),em]])),{requestId:ea,promise:ec.promise,cancel:ed}}async onRequestReceived(ei){let eo=ei.getSender(),ea=ei.getContent();if(eo!==this.baseApis.getUserId()||!(ea.name&&ea.action&&ea.requesting_device_id&&ea.request_id))return;let ec=ea.requesting_device_id;if("request_cancellation"===ea.action);else if("request"===ea.action){if(ec===this.baseApis.deviceId||(ep.logger.info("received request for secret ("+eo+", "+ec+", "+ea.request_id+")"),!this.cryptoCallbacks.onSecretRequested))return;let ei=await this.cryptoCallbacks.onSecretRequested(eo,ec,ea.request_id,ea.name,this.baseApis.checkDeviceTrust(eo,ec));if(ei){ep.logger.info(`Preparing ${ea.name} secret for ${ec}`);let ed={type:"m.secret.send",content:{request_id:ea.request_id,secret:ei}},eh={algorithm:eg.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[ef.ToDeviceMessageId]:(0,eu.v4)()};await eg.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,new Map([[eo,[this.baseApis.getStoredDevice(eo,ec)]]])),await eg.encryptMessageForDevice(eh.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,eo,this.baseApis.getStoredDevice(eo,ec),ed);let em=new Map([[eo,new Map([[ec,eh]])]]);ep.logger.info(`Sending ${ea.name} secret for ${ec}`),this.baseApis.sendToDevice("m.room.encrypted",em)}else ep.logger.info(`Request denied for ${ea.name} secret for ${ec}`)}}onSecretReceived(ei){if(ei.getSender()!==this.baseApis.getUserId())return;if(!eg.isOlmEncrypted(ei)){ep.logger.error("secret event not properly encrypted");return}let eo=ei.getContent(),ea=this.baseApis.crypto.deviceList.getUserByIdentityKey(eg.OLM_ALGORITHM,ei.getSenderKey()||"");if(ea!==ei.getSender()){ep.logger.error("sending device does not belong to the user it claims to be from");return}ep.logger.log("got secret share for request",eo.request_id);let ec=this.requests.get(eo.request_id);if(ec){let ea=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(eg.OLM_ALGORITHM,ei.getSenderKey());if(!ea){ep.logger.log("secret share from unknown device with key",ei.getSenderKey());return}if(!ec.devices.includes(ea.deviceId)){ep.logger.log("unsolicited secret share from device",ea.deviceId);return}let ed=this.baseApis.crypto.checkDeviceInfoTrust(ei.getSender(),ea);if(!ed.isVerified()){ep.logger.log("secret share from unverified device");return}ep.logger.log(`Successfully received secret ${ec.name} from ${ea.deviceId}`),ec.deferred.resolve(eo.secret)}}}eo.SecretSharing=eb},4823:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SecretStorage=void 0;var ed=ec(ea(8416)),eu=ea(1891),eh=ea(1922);class ef{constructor(ei,eo,ea){(0,ed.default)(this,"storageImpl",void 0),(0,ed.default)(this,"sharingImpl",void 0),this.storageImpl=new eu.ServerSideSecretStorageImpl(ei,eo),this.sharingImpl=new eh.SecretSharing(ea,eo)}getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(ei){return this.storageImpl.setDefaultKeyId(ei)}addKey(ei,eo={},ea){return this.storageImpl.addKey(ei,eo,ea)}getKey(ei){return this.storageImpl.getKey(ei)}hasKey(ei){return this.storageImpl.hasKey(ei)}checkKey(ei,eo){return this.storageImpl.checkKey(ei,eo)}store(ei,eo,ea){return this.storageImpl.store(ei,eo,ea)}get(ei){return this.storageImpl.get(ei)}async isStored(ei){return this.storageImpl.isStored(ei)}request(ei,eo){return this.sharingImpl.request(ei,eo)}onRequestReceived(ei){return this.sharingImpl.onRequestReceived(ei)}onSecretReceived(ei){this.sharingImpl.onSecretReceived(ei)}}eo.SecretStorage=ef},2611:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.calculateKeyCheck=em,eo.decryptAES=ef,eo.encryptAES=eh;var ec=ea(2772),ed=ea(9126);let eu=new Uint8Array(8);async function eh(ei,eo,ea,eu){let eh;eu?eh=(0,ec.decodeBase64)(eu):(eh=new Uint8Array(16),ed.crypto.getRandomValues(eh),eh[8]&=127);let[ef,eg]=await ep(eo,ea),em=new ed.TextEncoder().encode(ei),ey=await ed.subtleCrypto.encrypt({name:"AES-CTR",counter:eh,length:64},ef,em),eb=await ed.subtleCrypto.sign({name:"HMAC"},eg,ey);return{iv:(0,ec.encodeBase64)(eh),ciphertext:(0,ec.encodeBase64)(ey),mac:(0,ec.encodeBase64)(eb)}}async function ef(ei,eo,ea){let[eu,eh]=await ep(eo,ea),ef=(0,ec.decodeBase64)(ei.ciphertext);if(!await ed.subtleCrypto.verify({name:"HMAC"},eh,(0,ec.decodeBase64)(ei.mac),ef))throw Error(`Error decrypting secret ${ea}: bad MAC`);let eg=await ed.subtleCrypto.decrypt({name:"AES-CTR",counter:(0,ec.decodeBase64)(ei.iv),length:64},eu,ef);return new TextDecoder().decode(new Uint8Array(eg))}async function ep(ei,eo){let ea=await ed.subtleCrypto.importKey("raw",ei,{name:"HKDF"},!1,["deriveBits"]),ec=await ed.subtleCrypto.deriveBits({name:"HKDF",salt:eu,info:new ed.TextEncoder().encode(eo),hash:"SHA-256"},ea,512),eh=ec.slice(0,32),ef=ec.slice(32),ep=ed.subtleCrypto.importKey("raw",eh,{name:"AES-CTR"},!1,["encrypt","decrypt"]),eg=ed.subtleCrypto.importKey("raw",ef,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([ep,eg])}let eg="\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";function em(ei,eo){return eh(eg,ei,"",eo)}},1897:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.UnknownDeviceError=eo.EncryptionAlgorithm=eo.ENCRYPTION_CLASSES=eo.DecryptionError=eo.DecryptionAlgorithm=eo.DECRYPTION_CLASSES=void 0,eo.registerAlgorithm=eb;var ed=ec(ea(8416));let eu=new Map;eo.ENCRYPTION_CLASSES=eu;let eh=new Map;eo.DECRYPTION_CLASSES=eh;class ef{constructor(ei){(0,ed.default)(this,"userId",void 0),(0,ed.default)(this,"deviceId",void 0),(0,ed.default)(this,"crypto",void 0),(0,ed.default)(this,"olmDevice",void 0),(0,ed.default)(this,"baseApis",void 0),(0,ed.default)(this,"roomId",void 0),this.userId=ei.userId,this.deviceId=ei.deviceId,this.crypto=ei.crypto,this.olmDevice=ei.olmDevice,this.baseApis=ei.baseApis,this.roomId=ei.roomId}prepareToEncrypt(ei){}onRoomMembership(ei,eo,ea){}}eo.EncryptionAlgorithm=ef;class ep{constructor(ei){(0,ed.default)(this,"userId",void 0),(0,ed.default)(this,"crypto",void 0),(0,ed.default)(this,"olmDevice",void 0),(0,ed.default)(this,"baseApis",void 0),(0,ed.default)(this,"roomId",void 0),this.userId=ei.userId,this.crypto=ei.crypto,this.olmDevice=ei.olmDevice,this.baseApis=ei.baseApis,this.roomId=ei.roomId}async onRoomKeyEvent(ei){}async importRoomKey(ei,eo){}hasKeysForKeyRequest(ei){return Promise.resolve(!1)}shareKeysWithDevice(ei){throw Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(ei){return!1}}eo.DecryptionAlgorithm=ep;class eg extends Error{constructor(ei,eo,ea){super(eo),this.code=ei,(0,ed.default)(this,"detailedString",void 0),this.code=ei,this.name="DecryptionError",this.detailedString=em(this,ea)}}function em(ei,eo){let ea=ei.name+"[msg: "+ei.message;return eo&&(ea+=", "+Object.keys(eo).map(ei=>ei+": "+eo[ei]).join(", ")),ea+="]"}eo.DecryptionError=eg;class ey extends Error{constructor(ei,eo,ea){super(ei),this.devices=eo,this.event=ea,this.name="UnknownDeviceError",this.devices=eo}}function eb(ei,eo,ea){eu.set(ei,eo),eh.set(ei,ea)}eo.UnknownDeviceError=ey},1994:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),ea(3072),ea(7125);var ec=ea(1897);Object.keys(ec).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ec[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ec[ei]}}))})},7125:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MegolmEncryption=eo.MegolmDecryption=void 0,eo.isRoomSharedHistory=eT;var ed=ec(ea(8416)),eu=ea(7429),eh=ea(7434),ef=eE(ea(2772)),ep=ea(1897),eg=ea(2573),em=ea(2481),ey=ea(6617),eb=ea(3102);function eS(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eS=function(ei){return ei?ea:eo})(ei)}function eE(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eS(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function ew(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function e_(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ew(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ew(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eT(ei){var eo,ea;let ec=null==ei?void 0:null===(eo=ei.currentState)||void 0===eo?void 0:eo.getStateEvents("m.room.history_visibility",""),ed=null==ec?void 0:null===(ea=ec.getContent())||void 0===ea?void 0:ea.history_visibility;return["world_readable","shared"].includes(ed)}let eI=ei=>"string"==typeof ei.ciphertext?!!ei.ciphertext.length:!!Object.keys(ei.ciphertext).length;class eC{constructor(ei,eo=!1){this.sessionId=ei,this.sharedHistory=eo,(0,ed.default)(this,"useCount",0),(0,ed.default)(this,"creationTime",void 0),(0,ed.default)(this,"sharedWithDevices",new eb.MapWithDefault(()=>new Map)),(0,ed.default)(this,"blockedDevicesNotified",new eb.MapWithDefault(()=>new Map)),this.creationTime=new Date().getTime()}needsRotation(ei,eo){let ea=new Date().getTime()-this.creationTime;return(this.useCount>=ei||ea>=eo)&&(eh.logger.log("Rotating megolm session after "+this.useCount+" messages, "+ea+"ms"),!0)}markSharedWithDevice(ei,eo,ea,ec){this.sharedWithDevices.getOrCreate(ei).set(eo,{deviceKey:ea,messageIndex:ec})}markNotifiedBlockedDevice(ei,eo){this.blockedDevicesNotified.getOrCreate(ei).set(eo,!0)}sharedWithTooManyDevices(ei){for(let[ea,ec]of this.sharedWithDevices){if(!ei.has(ea))return eh.logger.log("Starting new megolm session because we shared with "+ea),!0;for(let[ed]of ec){var eo;if(!(null!==(eo=ei.get(ea))&&void 0!==eo&&eo.get(ed)))return eh.logger.log("Starting new megolm session because we shared with "+ea+":"+ed),!0}}return!1}}class eO extends ep.EncryptionAlgorithm{constructor(ei){var eo,ea,ec,eu;super(ei),(0,ed.default)(this,"setupPromise",Promise.resolve(null)),(0,ed.default)(this,"outboundSessions",{}),(0,ed.default)(this,"sessionRotationPeriodMsgs",void 0),(0,ed.default)(this,"sessionRotationPeriodMs",void 0),(0,ed.default)(this,"encryptionPreparation",void 0),(0,ed.default)(this,"roomId",void 0),(0,ed.default)(this,"prefixedLogger",void 0),this.roomId=ei.roomId,this.prefixedLogger=eh.logger.withPrefix(`[${this.roomId} encryption]`),this.sessionRotationPeriodMsgs=null!==(eo=null===(ea=ei.config)||void 0===ea?void 0:ea.rotation_period_msgs)&&void 0!==eo?eo:100,this.sessionRotationPeriodMs=null!==(ec=null===(eu=ei.config)||void 0===eu?void 0:eu.rotation_period_ms)&&void 0!==ec?ec:6048e5}async ensureOutboundSession(ei,eo,ea,ec=!1){let ed=async ed=>{let eu=eT(ei),eh=await this.prepareSession(eo,eu,ed);return await this.shareSession(eo,eu,ec,ea,eh),eh},eu=this.setupPromise.then(ed);return this.setupPromise=eu.catch(ei=>(this.prefixedLogger.error("Failed to setup outbound session",ei),null)),eu}async prepareSession(ei,eo,ea){var ec,ed;return ea&&eo!==ea.sharedHistory&&(ea=null),null!==(ec=ea)&&void 0!==ec&&ec.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(this.prefixedLogger.log("Starting new megolm session because we need to rotate."),ea=null),null!==(ed=ea)&&void 0!==ed&&ed.sharedWithTooManyDevices(ei)&&(ea=null),ea||(this.prefixedLogger.log("Starting new megolm session"),ea=await this.prepareNewSession(eo),this.prefixedLogger.log(`Started new megolm session ${ea.sessionId}`),this.outboundSessions[ea.sessionId]=ea),ea}async shareSession(ei,eo,ea,ec,ed){let eu={};for(let[eo,ea]of ei)for(let[ei,ec]of ea){var eh;let ea=ec.getIdentityKey();ea!=this.olmDevice.deviceCurve25519Key&&(null!==(eh=ed.sharedWithDevices.get(eo))&&void 0!==eh&&eh.get(ei)||(eu[eo]=eu[eo]||[],eu[eo].push(ec)))}let ep=this.olmDevice.getOutboundGroupSessionKey(ed.sessionId),eg={type:"m.room_key",content:{algorithm:ef.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:ed.sessionId,session_key:ep.key,chain_index:ep.chain_index,"org.matrix.msc3061.shared_history":eo}},[em,ey]=await ef.getExistingOlmSessions(this.olmDevice,this.baseApis,eu);await Promise.all([(async()=>{let ei=Array.from(ey.entries()).map(([ei,eo])=>Array.from(eo.entries()).map(([eo,ea])=>`${ei}/${eo}: ${ea.sessionId}`)).flat(1);this.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",ei),await this.shareKeyWithOlmSessions(ed,ep,eg,ey),this.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),(async()=>{let ei=Array.from(em.entries()).map(([ei,eo])=>eo.map(eo=>`${ei}/${eo.deviceId}`)).flat(1);this.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",ei);let eo=[],ec=Date.now(),eu=[];await this.shareKeyWithDevices(ed,ep,eg,em,eo,ea?1e4:2e3,eu),this.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!ea&&Date.now()-ec<1e4?(async()=>{let ei=new eb.MapWithDefault(()=>[]),ea=new Set;for(let ei of eu)ea.add(ei);let ec=[];for(let{userId:ed,deviceInfo:eu}of eo){let eo=ed.slice(ed.indexOf(":")+1);ea.has(eo)?ei.getOrCreate(ed).push(eu):ec.push({userId:ed,deviceInfo:eu})}let eh=Array.from(ei.entries()).map(([ei,eo])=>eo.map(eo=>`${ei}/${eo.deviceId}`)).flat(1);eh.length>0&&(this.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",eh),await this.shareKeyWithDevices(ed,ep,eg,ei,ec,3e4),this.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),await this.notifyFailedOlmDevices(ed,ep,ec)})():await this.notifyFailedOlmDevices(ed,ep,eo)})(),(async()=>{this.prefixedLogger.debug(`There are ${ec.size} blocked devices:`,Array.from(ec.entries()).map(([ei,eo])=>Array.from(eo.entries()).map(([eo,ea])=>`${ei}/${eo}`)).flat(1));let ei=new eb.MapWithDefault(()=>new Map),eo=0;for(let[eu,eh]of ec)for(let[ec,ef]of eh){var ea;(null===(ea=ed.blockedDevicesNotified.get(eu))||void 0===ea?void 0:ea.get(ec))===void 0&&(ei.getOrCreate(eu).set(ec,{device:ef}),eo++)}eo&&(this.prefixedLogger.debug(`Notifying ${eo} newly blocked devices:`,Array.from(ei.entries()).map(([ei,eo])=>Object.entries(eo).map(([eo,ea])=>`${ei}/${eo}`)).flat(1)),await this.notifyBlockedDevices(ed,ei),this.prefixedLogger.debug(`Notified ${eo} newly blocked devices`))})()])}async prepareNewSession(ei){let eo=this.olmDevice.createOutboundGroupSession(),ea=this.olmDevice.getOutboundGroupSessionKey(eo);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],eo,ea.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:ei}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,eo),new eC(eo,ei)}getDevicesWithoutSessions(ei,eo,ea=[]){for(let[ec,ed]of eo){let eo=ei.get(ec);for(let ei of ed){let ed=ei.deviceId,eu=null==eo?void 0:eo.get(ed);if(!(null!=eu&&eu.sessionId)){ea.push({userId:ec,deviceInfo:ei}),null==eo||eo.delete(ed);continue}}}return ea}splitDevices(ei){let eo=20,ea=[],ec=[ea];for(let[ed,eu]of ei){for(let ei of eu.values())ea.push({userId:ed,deviceInfo:ei.device});ea.length>eo&&(ea=[],ec.push(ea))}return 0===ea.length&&ec.pop(),ec}encryptAndSendKeysToDevices(ei,eo,ea,ec){return this.crypto.encryptAndSendToDevices(ea,ec).then(()=>{for(let ec of ea)ei.markSharedWithDevice(ec.userId,ec.deviceInfo.deviceId,ec.deviceInfo.getIdentityKey(),eo)}).catch(ei=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",ei),ei})}async sendBlockedNotificationsToDevices(ei,eo,ea){let ec=new eb.MapWithDefault(()=>new Map);for(let ei of eo){let eo=ei.userId,ed=ei.deviceInfo,eh=ed.deviceInfo,ef=eh.deviceId,ep=e_(e_({},ea),{},{code:ed.code,reason:ed.reason,[em.ToDeviceMessageId]:(0,eu.v4)()});"m.no_olm"===ep.code&&(delete ep.room_id,delete ep.session_id),ec.getOrCreate(eo).set(ef,ep)}for(let[eo,ea]of(await this.baseApis.sendToDevice("m.room_key.withheld",ec),ec))for(let ec of ea.keys())ei.markNotifiedBlockedDevice(eo,ec)}async reshareKeyWithDevice(ei,eo,ea,ec){var ed;let eh=this.outboundSessions[eo];if(!eh){this.prefixedLogger.debug(`megolm session ${ei}|${eo} not found: not re-sharing keys`);return}if(!eh.sharedWithDevices.has(ea)){this.prefixedLogger.debug(`megolm session ${ei}|${eo} never shared with user ${ea}`);return}let ep=null===(ed=eh.sharedWithDevices.get(ea))||void 0===ed?void 0:ed.get(ec.deviceId);if(void 0===ep){this.prefixedLogger.debug(`megolm session ${ei}|${eo} never shared with device ${ea}:${ec.deviceId}`);return}if(ep.deviceKey!==ec.getIdentityKey()){this.prefixedLogger.warn(`Megolm session ${ei}|${eo} has been shared with device ${ec.deviceId} but with identity key ${ep.deviceKey}. Key is now ${ec.getIdentityKey()}!`);return}let eg=await this.olmDevice.getInboundGroupSessionKey(this.roomId,ei,eo,ep.messageIndex);if(!eg){this.prefixedLogger.warn(`No inbound session key found for megolm session ${ei}|${eo}: not re-sharing keys`);return}await ef.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[ea,[ec]]]));let ey={type:"m.forwarded_room_key",content:{algorithm:ef.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:eo,session_key:eg.key,chain_index:eg.chain_index,sender_key:ei,sender_claimed_ed25519_key:eg.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:eg.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":eg.shared_history||!1}},eb={algorithm:ef.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[em.ToDeviceMessageId]:(0,eu.v4)()};await ef.encryptMessageForDevice(eb.ciphertext,this.userId,this.deviceId,this.olmDevice,ea,ec,ey),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[ea,new Map([[ec.deviceId,eb]])]])),this.prefixedLogger.debug(`Re-shared key for megolm session ${ei}|${eo} with ${ea}:${ec.deviceId}`)}async shareKeyWithDevices(ei,eo,ea,ec,ed,eu,eh){let ep=await ef.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,ec,!1,eu,eh,this.prefixedLogger);this.getDevicesWithoutSessions(ep,ec,ed),await this.shareKeyWithOlmSessions(ei,eo,ea,ep)}async shareKeyWithOlmSessions(ei,eo,ea,ec){let ed=this.splitDevices(ec);for(let ec=0;ec<ed.length;ec++){let eu=`megolm keys for ${ei.sessionId} (slice ${ec+1}/${ed.length})`;try{this.prefixedLogger.debug(`Sharing ${eu}`,ed[ec].map(ei=>`${ei.userId}/${ei.deviceInfo.deviceId}`)),await this.encryptAndSendKeysToDevices(ei,eo.chain_index,ed[ec],ea),this.prefixedLogger.debug(`Shared ${eu}`)}catch(ei){throw this.prefixedLogger.error(`Failed to share ${eu}`),ei}}}async notifyFailedOlmDevices(ei,eo,ea){for(let{userId:ec,deviceInfo:ed}of(this.prefixedLogger.debug(`Notifying ${ea.length} devices we failed to create Olm sessions`),ea)){let ea=ed.deviceId;ei.markSharedWithDevice(ec,ea,ed.getIdentityKey(),eo.chain_index)}let ec=await this.olmDevice.filterOutNotifiedErrorDevices(ea);this.prefixedLogger.debug(`Need to notify ${ec.length} failed devices which haven't been notified before`);let ed=new eb.MapWithDefault(()=>new Map);for(let{userId:ei,deviceInfo:eo}of ec)ed.getOrCreate(ei).set(eo.deviceId,{device:{code:"m.no_olm",reason:eg.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:eo}});await this.notifyBlockedDevices(ei,ed),this.prefixedLogger.debug(`Notified ${ec.length} devices we failed to create Olm sessions`)}async notifyBlockedDevices(ei,eo){let ea={room_id:this.roomId,session_id:ei.sessionId,algorithm:ef.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},ec=this.splitDevices(eo);for(let eo=0;eo<ec.length;eo++)try{await this.sendBlockedNotificationsToDevices(ei,ec[eo],ea),this.prefixedLogger.log(`Completed blacklist notification for ${ei.sessionId} (slice ${eo+1}/${ec.length})`)}catch(ea){throw this.prefixedLogger.log(`blacklist notification for ${ei.sessionId} (slice ${eo+1}/${ec.length}) failed`),ea}}prepareToEncrypt(ei){if(ei.roomId!==this.roomId)throw Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(null!=this.encryptionPreparation){let ei=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug(`Already started preparing to encrypt for this room ${ei}ms ago, skipping`),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");let eo=!1,ea=()=>eo;return this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{let eo=await this.getDevicesInRoom(ei,!1,ea);if(null===eo)return;let[ec,ed]=eo;this.crypto.globalErrorOnUnknownDevices&&this.removeUnknownDevices(ec),this.prefixedLogger.debug("Ensuring outbound megolm session"),await this.ensureOutboundSession(ei,ec,ed,!0),this.prefixedLogger.debug("Ready to encrypt events")}catch(ei){this.prefixedLogger.error("Failed to prepare to encrypt events",ei)}finally{delete this.encryptionPreparation}})(),cancel:()=>{eo=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}async encryptMessage(ei,eo,ea){if(this.prefixedLogger.log("Starting to encrypt event"),null!=this.encryptionPreparation)try{await this.encryptionPreparation.promise}catch(ei){}let ec=this.isVerificationEvent(eo,ea),[ed,eu]=await this.getDevicesInRoom(ei,ec);this.crypto.globalErrorOnUnknownDevices&&this.checkForUnknownDevices(ed);let eh=await this.ensureOutboundSession(ei,ed,eu),ep={room_id:this.roomId,type:eo,content:ea},eg=this.olmDevice.encryptGroupMessage(eh.sessionId,JSON.stringify(ep)),em={algorithm:ef.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:eg,session_id:eh.sessionId,device_id:this.deviceId};return eh.useCount++,em}isVerificationEvent(ei,eo){switch(ei){case em.EventType.KeyVerificationCancel:case em.EventType.KeyVerificationDone:case em.EventType.KeyVerificationMac:case em.EventType.KeyVerificationStart:case em.EventType.KeyVerificationKey:case em.EventType.KeyVerificationReady:case em.EventType.KeyVerificationAccept:return!0;case em.EventType.RoomMessage:return eo.msgtype===em.MsgType.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(ei){let eo=new eb.MapWithDefault(()=>new Map);for(let[ea,ec]of ei)for(let[ei,ed]of ec)ed.isUnverified()&&!ed.isKnown()&&eo.getOrCreate(ea).set(ei,ed);if(eo.size)throw new ep.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",eo)}removeUnknownDevices(ei){for(let[eo,ea]of ei){for(let[ei,eo]of ea)eo.isUnverified()&&!eo.isKnown()&&ea.delete(ei);0===ea.size&&ei.delete(eo)}}async getDevicesInRoom(ei,eo=!1,ea){let ec=await ei.getEncryptionTargetMembers();this.prefixedLogger.debug(`Encrypting for users (shouldEncryptForInvitedMembers: ${ei.shouldEncryptForInvitedMembers()}):`,ec.map(ei=>`${ei.userId} (${ei.membership})`));let ed=ec.map(function(ei){return ei.userId}),eu=this.crypto.globalBlacklistUnverifiedDevices,eh=ei.getBlacklistUnverifiedDevices();"boolean"==typeof eh&&(eu=eh);let ef=await this.crypto.downloadKeys(ed,!1);if((null==ea?void 0:ea())===!0)return null;let ep=new eb.MapWithDefault(()=>new Map);for(let[ei,ec]of ef)for(let[ed,eh]of ec){if(void 0!==ea&&await (0,eb.immediate)(),(null==ea?void 0:ea())===!0)return null;let ef=this.crypto.checkDeviceTrust(ei,ed);if(eh.isBlocked()||!ef.isVerified()&&eu&&!eo){let eo=ep.getOrCreate(ei),ea=eh.isBlocked();eo.set(ed,{code:ea?"m.blacklisted":"m.unverified",reason:eg.WITHHELD_MESSAGES[ea?"m.blacklisted":"m.unverified"],deviceInfo:eh}),ec.delete(ed)}}return[ef,ep]}}eo.MegolmEncryption=eO;class eR extends ep.DecryptionAlgorithm{constructor(ei){super(ei),(0,ed.default)(this,"pendingEvents",new Map),(0,ed.default)(this,"olmlib",ef),(0,ed.default)(this,"roomId",void 0),(0,ed.default)(this,"prefixedLogger",void 0),this.roomId=ei.roomId,this.prefixedLogger=eh.logger.withPrefix(`[${this.roomId} decryption]`)}async decryptEvent(ei){let eo;let ea=ei.getWireContent();if(!ea.sender_key||!ea.session_id||!ea.ciphertext)throw new ep.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");this.addEventToPendingList(ei);try{eo=await this.olmDevice.decryptGroupMessage(ei.getRoomId(),ea.sender_key,ea.session_id,ea.ciphertext,ei.getId(),ei.getTs())}catch(ec){if("DecryptionError"===ec.name)throw ec;let eo="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw(null==ec?void 0:ec.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&(this.requestKeysForEvent(ei),eo="OLM_UNKNOWN_MESSAGE_INDEX"),new ep.DecryptionError(eo,ec instanceof Error?ec.message:"Unknown Error: Error is undefined",{session:ea.sender_key+"|"+ea.session_id})}if(null===eo){this.crypto.backupManager.queryKeyBackupRateLimited(ei.getRoomId(),ea.session_id).catch(()=>{}),this.requestKeysForEvent(ei);let eo=await this.olmDevice.sessionMayHaveProblems(ea.sender_key,ei.getTs()-12e4);if(eo){this.prefixedLogger.info(`When handling UISI from ${ei.getSender()} (sender key ${ea.sender_key}): recent session problem with that sender:`,eo);let ec=ek[eo.type]||ek.unknown;throw eo.fixed&&(ec+=" Trying to create a new secure channel and re-requesting the keys."),new ep.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",ec,{session:ea.sender_key+"|"+ea.session_id})}throw new ep.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:ea.sender_key+"|"+ea.session_id})}eo.untrusted||this.removeEventFromPendingList(ei);let ec=JSON.parse(eo.result);if(ec.room_id!==ei.getRoomId())throw new ep.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+ec.room_id);return{clearEvent:ec,senderCurve25519Key:eo.senderKey,claimedEd25519Key:eo.keysClaimed.ed25519,forwardingCurve25519KeyChain:eo.forwardingCurve25519KeyChain,untrusted:eo.untrusted}}requestKeysForEvent(ei){let eo=ei.getWireContent(),ea=ei.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:ei.getRoomId(),algorithm:eo.algorithm,sender_key:eo.sender_key,session_id:eo.session_id},ea)}addEventToPendingList(ei){var eo;let ea=ei.getWireContent(),ec=ea.sender_key,ed=ea.session_id;this.pendingEvents.has(ec)||this.pendingEvents.set(ec,new Map);let eu=this.pendingEvents.get(ec);eu.has(ed)||eu.set(ed,new Set),null===(eo=eu.get(ed))||void 0===eo||eo.add(ei)}removeEventFromPendingList(ei){let eo=ei.getWireContent(),ea=eo.sender_key,ec=eo.session_id,ed=this.pendingEvents.get(ea),eu=null==ed?void 0:ed.get(ec);eu&&(eu.delete(ei),0===eu.size&&ed.delete(ec),0===ed.size&&this.pendingEvents.delete(ea))}roomKeyFromEvent(ei){let eo=ei.getSenderKey(),ea=ei.getContent(),ec={};if(!ea.room_id||!ea.session_key||!ea.session_id||!ea.algorithm){this.prefixedLogger.error("key event is missing fields");return}if(!ef.isOlmEncrypted(ei)){this.prefixedLogger.error("key event not properly encrypted");return}ea["org.matrix.msc3061.shared_history"]&&(ec.sharedHistory=!0);let ed={senderKey:eo,sessionId:ea.session_id,sessionKey:ea.session_key,extraSessionData:ec,exportFormat:!1,roomId:ea.room_id,algorithm:ea.algorithm,forwardingKeyChain:[],keysClaimed:ei.getKeysClaimed()};return ed}forwardedRoomKeyFromEvent(ei){let eo=this.roomKeyFromEvent(ei);if(!eo)return;let ea=ei.getSenderKey(),ec=ei.getContent(),ed=this.baseApis.crypto.deviceList.getUserByIdentityKey(ef.OLM_ALGORITHM,ea),eu=ec.sender_key,eh=ec.sender_claimed_ed25519_key,ep=Array.isArray(ec.forwarding_curve25519_key_chain)?ec.forwarding_curve25519_key_chain:[];if((ep=ep.slice()).push(ea),ed!==ei.getSender()){this.prefixedLogger.error("sending device does not belong to the user it claims to be from");return}if(!eu){this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");return}if(!eh){this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");return}let eg={ed25519:eh};return eo.senderKey=eu,eo.keysClaimed=eg,eo.exportFormat=!0,eo.forwardingKeyChain=ep,eo.extraSessionData.untrusted=!0,eo}async shouldAcceptForwardedKey(ei,eo){var ea;let ec=ei.getSenderKey(),ed=null!==(ea=this.crypto.deviceList.getDeviceByIdentityKey(ef.OLM_ALGORITHM,ec))&&void 0!==ea?ea:void 0,eu=this.crypto.checkDeviceInfoTrust(ei.getSender(),ed),eh=ei.getSender()===this.baseApis.getUserId(),ep=eu.isVerified()&&eh,eg=await this.wasRoomKeyRequested(ei,eo),em=this.wasRoomKeyForwardedByInviter(ei,eo),ey=this.wasRoomKeyForwardedAsHistory(eo);return eg&&ep||em&&ey}async wasRoomKeyRequested(ei,eo){let ea=await this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(ei.getSender(),"*",[ey.RoomKeyRequestState.Sent]);return ea.some(ei=>ei.requestBody.room_id===eo.roomId&&ei.requestBody.session_id===eo.sessionId)}wasRoomKeyForwardedByInviter(ei,eo){var ea,ec,ed;let eu=this.baseApis.getRoom(eo.roomId),eh=ei.getSenderKey();if(!eh)return!1;let ep=this.crypto.deviceList.getUserByIdentityKey(ef.OLM_ALGORITHM,eh);if(!ep)return!1;let eg=null==eu?void 0:null===(ea=eu.getMember(this.userId))||void 0===ea?void 0:ea.events.member,em=(null==eg?void 0:eg.getSender())===ep||(null==eg?void 0:null===(ec=eg.getUnsigned())||void 0===ec?void 0:ec.prev_sender)===ep&&(null==eg?void 0:null===(ed=eg.getPrevContent())||void 0===ed?void 0:ed.membership)==="invite";return!!eu&&!!em}wasRoomKeyForwardedAsHistory(ei){let eo=this.baseApis.getRoom(ei.roomId);return!!eo&&!!ei.extraSessionData.sharedHistory}shouldParkForwardedKey(ei){let eo=this.baseApis.getRoom(ei.roomId);return!eo&&!!ei.extraSessionData.sharedHistory}async parkForwardedKey(ei,eo){let ea={senderId:ei.getSender(),senderKey:eo.senderKey,sessionId:eo.sessionId,sessionKey:eo.sessionKey,keysClaimed:eo.keysClaimed,forwardingCurve25519KeyChain:eo.forwardingKeyChain};await this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],ei=>this.crypto.cryptoStore.addParkedSharedHistory(eo.roomId,ea,ei),eh.logger.withPrefix("[addParkedSharedHistory]"))}async addRoomKey(ei){try{await this.olmDevice.addInboundGroupSession(ei.roomId,ei.senderKey,ei.forwardingKeyChain,ei.sessionId,ei.sessionKey,ei.keysClaimed,ei.exportFormat,ei.extraSessionData),await this.retryDecryption(ei.senderKey,ei.sessionId,!ei.extraSessionData.untrusted)&&this.crypto.cancelRoomKeyRequest({algorithm:ei.algorithm,room_id:ei.roomId,session_id:ei.sessionId,sender_key:ei.senderKey}),await this.crypto.backupManager.backupGroupSession(ei.senderKey,ei.sessionId)}catch(ei){this.prefixedLogger.error(`Error handling m.room_key_event: ${ei}`)}}async onForwardedRoomKey(ei){let eo=this.forwardedRoomKeyFromEvent(ei);eo&&(await this.shouldAcceptForwardedKey(ei,eo)?await this.addRoomKey(eo):this.shouldParkForwardedKey(eo)&&await this.parkForwardedKey(ei,eo))}async onRoomKeyEvent(ei){if("m.forwarded_room_key"==ei.getType())await this.onForwardedRoomKey(ei);else{let eo=this.roomKeyFromEvent(ei);if(!eo)return;await this.addRoomKey(eo)}}async onRoomKeyWithheldEvent(ei){let eo=ei.getContent(),ea=eo.sender_key;"m.no_olm"===eo.code?await this.onNoOlmWithheldEvent(ei):"m.unavailable"===eo.code||await this.olmDevice.addInboundGroupSessionWithheld(eo.room_id,ea,eo.session_id,eo.code,eo.reason),eo.session_id?await this.retryDecryption(ea,eo.session_id):await this.retryDecryptionFromSender(ea)}async onNoOlmWithheldEvent(ei){let eo=ei.getContent(),ea=eo.sender_key,ec=ei.getSender();if(this.prefixedLogger.warn(`${ec}:${ea} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(ea)){this.prefixedLogger.debug("New session already created.  Not creating a new one."),await this.olmDevice.recordSessionProblem(ea,"no_olm",!0);return}let ed=this.crypto.deviceList.getDeviceByIdentityKey(eo.algorithm,ea);if(!ed&&(await this.crypto.downloadKeys([ec],!1),!(ed=this.crypto.deviceList.getDeviceByIdentityKey(eo.algorithm,ea)))){this.prefixedLogger.info("Couldn't find device for identity key "+ea+": not establishing session"),await this.olmDevice.recordSessionProblem(ea,"no_olm",!1);return}await ef.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[ec,[ed]]]),!1);let eh={algorithm:ef.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[em.ToDeviceMessageId]:(0,eu.v4)()};await ef.encryptMessageForDevice(eh.ciphertext,this.userId,void 0,this.olmDevice,ec,ed,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(ea,"no_olm",!0),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[ec,new Map([[ed.deviceId,eh]])]]))}hasKeysForKeyRequest(ei){let eo=ei.requestBody;return this.olmDevice.hasInboundSessionKeys(eo.room_id,eo.sender_key,eo.session_id)}shareKeysWithDevice(ei){let eo=ei.userId,ea=ei.deviceId,ec=this.crypto.getStoredDevice(eo,ea),ed=ei.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[eo,[ec]]])).then(ei=>{var ec;let eu=null===(ec=ei.get(eo))||void 0===ec?void 0:ec.get(ea);return null!=eu&&eu.sessionId?(this.prefixedLogger.log("sharing keys for session "+ed.sender_key+"|"+ed.session_id+" with device "+eo+":"+ea),this.buildKeyForwardingMessage(ed.room_id,ed.sender_key,ed.session_id)):null}).then(ei=>{let ed={algorithm:ef.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[em.ToDeviceMessageId]:(0,eu.v4)()};return this.olmlib.encryptMessageForDevice(ed.ciphertext,this.userId,void 0,this.olmDevice,eo,ec,ei).then(()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[eo,new Map([[ea,ed]])]])))})}async buildKeyForwardingMessage(ei,eo,ea){let ec=await this.olmDevice.getInboundGroupSessionKey(ei,eo,ea);return{type:"m.forwarded_room_key",content:{algorithm:ef.MEGOLM_ALGORITHM,room_id:ei,sender_key:eo,sender_claimed_ed25519_key:ec.sender_claimed_ed25519_key,session_id:ea,session_key:ec.key,chain_index:ec.chain_index,forwarding_curve25519_key_chain:ec.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":ec.shared_history||!1}}}importRoomKey(ei,{untrusted:eo,source:ea}={}){let ec={};return(eo||ei.untrusted)&&(ec.untrusted=!0),ei["org.matrix.msc3061.shared_history"]&&(ec.sharedHistory=!0),this.olmDevice.addInboundGroupSession(ei.room_id,ei.sender_key,ei.forwarding_curve25519_key_chain,ei.session_id,ei.session_key,ei.sender_claimed_keys,!0,ec).then(()=>{"backup"!==ea&&this.crypto.backupManager.backupGroupSession(ei.sender_key,ei.session_id).catch(ei=>{this.prefixedLogger.log("Failed to back up megolm session",ei)}),this.retryDecryption(ei.sender_key,ei.session_id,!ec.untrusted)})}async retryDecryption(ei,eo,ea){var ec;let ed=this.pendingEvents.get(ei);if(!ed)return!0;let eu=ed.get(eo);if(!eu)return!0;let eh=[...eu];return this.prefixedLogger.debug("Retrying decryption on events:",eh.map(ei=>`${ei.getId()}`)),await Promise.all(eh.map(async ei=>{try{await ei.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:ea})}catch(ei){}})),!(null!==(ec=this.pendingEvents.get(ei))&&void 0!==ec&&ec.has(eo))}async retryDecryptionFromSender(ei){let eo=this.pendingEvents.get(ei);return!eo||(this.pendingEvents.delete(ei),await Promise.all([...eo].map(async([ei,eo])=>{await Promise.all([...eo].map(async ei=>{try{await ei.attemptDecryption(this.crypto)}catch(ei){}}))})),!this.pendingEvents.has(ei))}async sendSharedHistoryInboundSessions(ei){await ef.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,ei);let eo=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);for(let[ea,ec]of(this.prefixedLogger.log(`Sharing history in with users ${Array.from(ei.keys())}`,eo.map(([ei,eo])=>`${ei}|${eo}`)),eo)){let eo=await this.buildKeyForwardingMessage(this.roomId,ea,ec),ed=[],eh=new Map;for(let[ea,ec]of ei){let ei=new Map;for(let ep of(eh.set(ea,ei),ec)){let ec={algorithm:ef.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[em.ToDeviceMessageId]:(0,eu.v4)()};ei.set(ep.deviceId,ec),ed.push(ef.encryptMessageForDevice(ec.ciphertext,this.userId,void 0,this.olmDevice,ea,ep,eo))}}for(let[ei,eo]of(await Promise.all(ed),eh)){for(let[ea,ec]of eo)eI(ec)||(this.prefixedLogger.log("No ciphertext for device "+ei+":"+ea+": pruning"),eo.delete(ea));0===eo.size&&(this.prefixedLogger.log("Pruned all devices for user "+ei),eh.delete(ei))}if(0===eh.size){this.prefixedLogger.log("No users left to send to: aborting");return}await this.baseApis.sendToDevice("m.room.encrypted",eh)}}}eo.MegolmDecryption=eR;let ek={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};(0,ep.registerAlgorithm)(ef.MEGOLM_ALGORITHM,eO,eR)},3072:function(ei,eo,ea){"use strict";var ec=ea(4836)(ea(8416)),ed=ea(7434),eu=eg(ea(2772)),eh=ea(3272),ef=ea(1897);function ep(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ep=function(ei){return ei?ea:eo})(ei)}function eg(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ep(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let em=eh.DeviceInfo.DeviceVerification;class ey extends ef.EncryptionAlgorithm{constructor(...ei){super(...ei),(0,ec.default)(this,"sessionPrepared",!1),(0,ec.default)(this,"prepPromise",null)}ensureSession(ei){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(ei).then(()=>this.crypto.ensureOlmSessionsForUsers(ei)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}async encryptMessage(ei,eo,ea){let ec=await ei.getEncryptionTargetMembers(),ed=ec.map(function(ei){return ei.userId});await this.ensureSession(ed);let eh={room_id:ei.roomId,type:eo,content:ea},ef={algorithm:eu.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},ep=[];for(let ei of ed){let eo=this.crypto.getStoredDevicesForUser(ei)||[];for(let ea of eo){let eo=ea.getIdentityKey();eo!=this.olmDevice.deviceCurve25519Key&&ea.verified!=em.BLOCKED&&ep.push(eu.encryptMessageForDevice(ef.ciphertext,this.userId,this.deviceId,this.olmDevice,ei,ea,eh))}}return Promise.all(ep).then(()=>ef)}}class eb extends ef.DecryptionAlgorithm{async decryptEvent(ei){let eo;let ea=ei.getWireContent(),ec=ea.sender_key,ed=ea.ciphertext;if(!ed)throw new ef.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in ed))throw new ef.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");let eh=ed[this.olmDevice.deviceCurve25519Key];try{eo=await this.decryptMessage(ec,eh)}catch(ei){throw new ef.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:ec,err:ei})}let ep=JSON.parse(eo);if(ep.recipient!=this.userId)throw new ef.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+ep.recipient);if(ep.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new ef.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:ep.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});await this.crypto.deviceList.downloadKeys([ei.getSender()],!1);let eg=this.crypto.deviceList.getUserByIdentityKey(eu.OLM_ALGORITHM,ec);if(eg!==ei.getSender()&&void 0!=eg)throw new ef.DecryptionError("OLM_BAD_SENDER","Message claimed to be from "+ei.getSender(),{real_sender:eg});if(ep.sender!=ei.getSender())throw new ef.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+ep.sender,{reported_sender:ei.getSender()});if(ep.room_id!==ei.getRoomId())throw new ef.DecryptionError("OLM_BAD_ROOM","Message intended for room "+ep.room_id,{reported_room:ei.getRoomId()||"ROOM_ID_UNDEFINED"});let em=ep.keys||{};return{clearEvent:ep,senderCurve25519Key:ec,claimedEd25519Key:em.ed25519||null}}decryptMessage(ei,eo){if(0!==eo.type)return this.reallyDecryptMessage(ei,eo);{let ea=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(ei,eo));return this.olmDevice.olmPrekeyPromise=ea.catch(()=>{}),ea}}async reallyDecryptMessage(ei,eo){let ea;let ec=await this.olmDevice.getSessionIdsForDevice(ei),eu={};for(let ea of ec)try{let ec=await this.olmDevice.decryptMessage(ei,ea,eo.type,eo.body);return ed.logger.log("Decrypted Olm message from "+ei+" with session "+ea),ec}catch(ed){let ec=await this.olmDevice.matchesSession(ei,ea,eo.type,eo.body);if(ec)throw Error("Error decrypting prekey message with existing session id "+ea+": "+ed.message);eu[ea]=ed.message}if(0!==eo.type){if(0===ec.length)throw Error("No existing sessions");throw Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(eu))}try{ea=await this.olmDevice.createInboundSession(ei,eo.type,eo.body)}catch(ei){throw eu["(new)"]=ei.message,Error("Error decrypting prekey message: "+JSON.stringify(eu))}return ed.logger.log("created new inbound Olm session ID "+ea.session_id+" with "+ei),ea.payload}}(0,ef.registerAlgorithm)(eu.OLM_ALGORITHM,ey,eb)},764:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.CrossSigningKey=void 0;let ea=function(ei){return ei.Master="master",ei.SelfSigning="self_signing",ei.UserSigning="user_signing",ei}({});eo.CrossSigningKey=ea},5537:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.algorithmsByName=eo.DefaultAlgorithm=eo.Curve25519=eo.BackupManager=eo.Aes256=void 0;var ed=ec(ea(8416)),eu=ea(2168),eh=ea(7434),ef=ea(2772),ep=ea(1597),eg=ea(3102),em=ea(7585),ey=ea(4077),eb=ea(2611),eS=ea(7048),eE=ea(2600),ew=ea(9126),e_=ea(95);let eT=200,eI=5e3;class eC{constructor(ei,eo){this.baseApis=ei,this.getKey=eo,(0,ed.default)(this,"algorithm",void 0),(0,ed.default)(this,"backupInfo",void 0),(0,ed.default)(this,"checkedForBackup",void 0),(0,ed.default)(this,"sendingBackups",void 0),(0,ed.default)(this,"sessionLastCheckAttemptedTime",{}),this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(ei){let eo=eP[ei.algorithm];if(!eo)throw Error("Unknown backup algorithm: "+ei.algorithm);if("object"!=typeof ei.auth_data)throw Error("Invalid backup data returned");return eo.checkBackupVersion(ei)}static makeAlgorithm(ei,eo){let ea=eP[ei.algorithm];if(!ea)throw Error("Unknown backup algorithm");return ea.init(ei.auth_data,eo)}async enableKeyBackup(ei){this.backupInfo=ei,this.algorithm&&this.algorithm.free(),this.algorithm=await eC.makeAlgorithm(ei,this.getKey),this.baseApis.emit(eE.CryptoEvent.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(eE.CryptoEvent.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?!!this.algorithm:null}async prepareKeyBackupVersion(ei,eo){let ea=eo?eP[eo]:eA;if(!ea)throw Error("Unknown backup algorithm");let[ec,ed]=await ea.prepare(ei),eu=(0,ey.encodeRecoveryKey)(ec);return{algorithm:ea.algorithmName,auth_data:ed,recovery_key:eu,privateKey:ec}}async createKeyBackupVersion(ei){this.algorithm=await eC.makeAlgorithm(ei,this.getKey)}async checkAndStart(){let ei;if(eh.logger.log("Checking key backup status..."),this.baseApis.isGuest())return eh.logger.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;try{var eo;ei=null!==(eo=await this.baseApis.getKeyBackupVersion())&&void 0!==eo?eo:void 0}catch(ei){return eh.logger.log("Error checking for active key backup",ei),404===ei.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;let ea=await this.isKeyBackupTrusted(ei);return ea.usable&&!this.backupInfo?(eh.logger.log(`Found usable key backup v${ei.version}: enabling key backups`),await this.enableKeyBackup(ei)):!ea.usable&&this.backupInfo?(eh.logger.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):ea.usable||this.backupInfo?ea.usable&&this.backupInfo&&(ei.version!==this.backupInfo.version?(eh.logger.log(`On backup version ${this.backupInfo.version} but found version ${ei.version}: switching.`),this.disableKeyBackup(),await this.enableKeyBackup(ei),await this.scheduleAllGroupSessionsForBackup()):eh.logger.log(`Backup version ${ei.version} still current`)):eh.logger.log("No usable key backup: not enabling key backup"),{backupInfo:ei,trustInfo:ea}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(ei,eo){if(!this.backupInfo)return;let ea=new Date().getTime();(!this.sessionLastCheckAttemptedTime[eo]||ea-this.sessionLastCheckAttemptedTime[eo]>eI)&&(this.sessionLastCheckAttemptedTime[eo]=ea,await this.baseApis.restoreKeyBackupWithCache(ei,eo,this.backupInfo,{}))}async isKeyBackupTrusted(ei){let eo={usable:!1,trusted_locally:!1,sigs:[]};if(!ei||!ei.algorithm||!ei.auth_data||!ei.auth_data.signatures)return eh.logger.info("Key backup is absent or missing required data"),eo;let ea=this.baseApis.getUserId(),ec=await this.baseApis.crypto.getSessionBackupPrivateKey();if(ec){let ea=null;try{ea=await eC.makeAlgorithm(ei,async()=>ec),await ea.keyMatches(ec)&&(eh.logger.info("Backup is trusted locally"),eo.trusted_locally=!0)}catch{}finally{var ed;null===(ed=ea)||void 0===ed||ed.free()}}let eu=ei.auth_data.signatures[ea]||{};for(let ec of Object.keys(eu)){let ed=ec.split(":");if("ed25519"!==ed[0]){eh.logger.log("Ignoring unknown signature type: "+ed[0]);continue}let eu={deviceId:ed[1]},ep=this.baseApis.crypto.crossSigningInfo.getId();if(ep===eu.deviceId){eu.crossSigningId=!0;try{await (0,ef.verifySignature)(this.baseApis.crypto.olmDevice,ei.auth_data,ea,eu.deviceId,ep),eu.valid=!0}catch(ei){eh.logger.warn("Bad signature from cross signing key "+ep,ei),eu.valid=!1}eo.sigs.push(eu);continue}let eg=this.baseApis.crypto.deviceList.getStoredDevice(ea,eu.deviceId);if(eg){eu.device=eg,eu.deviceTrust=this.baseApis.checkDeviceTrust(ea,eu.deviceId);try{await (0,ef.verifySignature)(this.baseApis.crypto.olmDevice,ei.auth_data,ea,eg.deviceId,eg.getFingerprint()),eu.valid=!0}catch(eo){eh.logger.info("Bad signature from key ID "+ec+" userID "+this.baseApis.getUserId()+" device ID "+eg.deviceId+" fingerprint: "+eg.getFingerprint(),ei.auth_data,eo),eu.valid=!1}}else eu.valid=null,eh.logger.info("Ignoring signature from unknown key "+ec);eo.sigs.push(eu)}return eo.usable=eo.sigs.some(ei=>{var eo;return ei.valid&&(ei.device&&(null===(eo=ei.deviceTrust)||void 0===eo?void 0:eo.isVerified())||ei.crossSigningId)}),eo}async scheduleKeyBackupSend(ei=1e4){if(!this.sendingBackups){this.sendingBackups=!0;try{let eo=Math.random()*ei;await (0,eg.sleep)(eo);let ea=0;for(;;){if(!this.algorithm)return;try{let ei=await this.backupPendingKeys(eT);if(0===ei)return;ea=0}catch(ei){if(ea++,eh.logger.log("Key backup request failed",ei),ei.data&&("M_NOT_FOUND"==ei.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==ei.data.errcode))throw await this.checkKeyBackup(),this.baseApis.crypto.emit(eE.CryptoEvent.KeyBackupFailed,ei.data.errcode),ei}ea&&await (0,eg.sleep)(1e3*Math.pow(2,Math.min(ea-1,4)))}}finally{this.sendingBackups=!1}}}async backupPendingKeys(ei){let eo=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(ei);if(!eo.length)return 0;let ea=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(eE.CryptoEvent.KeyBackupSessionsRemaining,ea);let ec={};for(let ei of eo){var ed;let eo=ei.sessionData.room_id;(0,eg.safeSet)(ec,eo,ec[eo]||{sessions:{}});let ea=this.baseApis.crypto.olmDevice.exportInboundGroupSession(ei.senderKey,ei.sessionId,ei.sessionData);ea.algorithm=ef.MEGOLM_ALGORITHM;let eu=(ea.forwarding_curve25519_key_chain||[]).length,eh=this.baseApis.crypto.deviceList.getUserByIdentityKey(ef.MEGOLM_ALGORITHM,ei.senderKey),ep=null!==(ed=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(ef.MEGOLM_ALGORITHM,ei.senderKey))&&void 0!==ed?ed:void 0,em=this.baseApis.crypto.checkDeviceInfoTrust(eh,ep).isVerified();(0,eg.safeSet)(ec[eo].sessions,ei.sessionId,{first_message_index:ea.first_known_index,forwarded_count:eu,is_verified:em,session_data:await this.algorithm.encryptSession(ea)})}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:ec}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(eo),ea=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(eE.CryptoEvent.KeyBackupSessionsRemaining,ea),eo.length}async backupGroupSession(ei,eo){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:ei,sessionId:eo}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[em.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,em.IndexedDBCryptoStore.STORE_BACKUP],ei=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(ei,eo=>{null!==eo&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([eo],ei)})});let ei=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(eE.CryptoEvent.KeyBackupSessionsRemaining,ei),ei}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}eo.BackupManager=eC;class eO{constructor(ei,eo,ea){this.authData=ei,this.publicKey=eo,this.getKey=ea}static async init(ei,eo){if(!ei||!("public_key"in ei))throw Error("auth_data missing required information");let ec=new ea.g.Olm.PkEncryption;return ec.set_recipient_key(ei.public_key),new eO(ei,ec,eo)}static async prepare(ei){let eo=new ea.g.Olm.PkDecryption;try{let ec={};if(ei){if(ei instanceof Uint8Array)ec.public_key=eo.init_with_private_key(ei);else{let ea=await (0,ep.keyFromPassphrase)(ei);ec.private_key_salt=ea.salt,ec.private_key_iterations=ea.iterations,ec.public_key=eo.init_with_private_key(ea.key)}}else ec.public_key=eo.generate_key();let ed=new ea.g.Olm.PkEncryption;return ed.set_recipient_key(ec.public_key),[eo.get_private_key(),ec]}finally{eo.free()}}static checkBackupVersion(ei){if(!("public_key"in ei.auth_data))throw Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(ei){let eo=Object.assign({},ei);return delete eo.session_id,delete eo.room_id,delete eo.first_known_index,this.publicKey.encrypt(JSON.stringify(eo))}async decryptSessions(ei){let eo=await this.getKey(),ec=new ea.g.Olm.PkDecryption;try{let ea=ec.init_with_private_key(eo);if(ea!==this.authData.public_key)throw new e_.MatrixError({errcode:eu.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY});let ed=[];for(let[eo,ea]of Object.entries(ei))try{let ei=JSON.parse(ec.decrypt(ea.session_data.ephemeral,ea.session_data.mac,ea.session_data.ciphertext));ei.session_id=eo,ed.push(ei)}catch(ei){eh.logger.log("Failed to decrypt megolm session from backup",ei,ea)}return ed}finally{ec.free()}}async keyMatches(ei){let eo;let ec=new ea.g.Olm.PkDecryption;try{eo=ec.init_with_private_key(ei)}finally{ec.free()}return eo===this.authData.public_key}free(){this.publicKey.free()}}function eR(ei){let eo=new Uint8Array(ei);return ew.crypto.getRandomValues(eo),eo}eo.Curve25519=eO,(0,ed.default)(eO,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");let ek=new eS.UnstableValue("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class eM{constructor(ei,eo){this.authData=ei,this.key=eo}static async init(ei,eo){if(!ei)throw Error("auth_data missing");let ea=await eo();if(ei.mac){let{mac:eo}=await (0,eb.calculateKeyCheck)(ea,ei.iv);if(ei.mac.replace(/=+$/g,"")!==eo.replace(/=+/g,""))throw Error("Key does not match")}return new eM(ei,ea)}static async prepare(ei){let eo;let ea={};if(ei){if(ei instanceof Uint8Array)eo=new Uint8Array(ei);else{let ec=await (0,ep.keyFromPassphrase)(ei);ea.private_key_salt=ec.salt,ea.private_key_iterations=ec.iterations,eo=ec.key}}else eo=eR(32);let{iv:ec,mac:ed}=await (0,eb.calculateKeyCheck)(eo);return ea.iv=ec,ea.mac=ed,[eo,ea]}static checkBackupVersion(ei){if(!("iv"in ei.auth_data&&"mac"in ei.auth_data))throw Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(ei){let eo=Object.assign({},ei);return delete eo.session_id,delete eo.room_id,delete eo.first_known_index,(0,eb.encryptAES)(JSON.stringify(eo),this.key,ei.session_id)}async decryptSessions(ei){let eo=[];for(let[ea,ec]of Object.entries(ei))try{let ei=JSON.parse(await (0,eb.decryptAES)(ec.session_data,this.key,ea));ei.session_id=ea,eo.push(ei)}catch(ei){eh.logger.log("Failed to decrypt megolm session from backup",ei,ec)}return eo}async keyMatches(ei){if(!this.authData.mac)return!0;{let{mac:eo}=await (0,eb.calculateKeyCheck)(ei,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===eo.replace(/=+/g,"")}}free(){this.key.fill(0)}}eo.Aes256=eM,(0,ed.default)(eM,"algorithmName",ek.name);let eP={[eO.algorithmName]:eO,[eM.algorithmName]:eM};eo.algorithmsByName=eP;let eA=eO;eo.DefaultAlgorithm=eA},9126:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.crypto=eo.TextEncoder=void 0,eo.setCrypto=ew,eo.setTextEncoder=e_,eo.subtleCrypto=void 0;var ec,ed,eu,eh,ef,ep,eg,em,ey=ea(7434);let eb=null===(ec=ea.g.window)||void 0===ec?void 0:ec.crypto;eo.crypto=eb;let eS=null!==(ed=null===(eu=ea.g.window)||void 0===eu?void 0:null===(eh=eu.crypto)||void 0===eh?void 0:eh.subtle)&&void 0!==ed?ed:null===(ef=ea.g.window)||void 0===ef?void 0:null===(ep=ef.crypto)||void 0===ep?void 0:ep.webkitSubtle;eo.subtleCrypto=eS;let eE=null===(eg=ea.g.window)||void 0===eg?void 0:eg.TextEncoder;if(eo.TextEncoder=eE,!eb)try{eo.crypto=eb=ea(2474).webcrypto}catch(ei){ey.logger.error("Failed to load webcrypto",ei)}if(eS||(eo.subtleCrypto=eS=null===(em=eb)||void 0===em?void 0:em.subtle),!eE)try{eo.TextEncoder=eE=ea(9720).TextEncoder}catch(ei){ey.logger.error("Failed to load TextEncoder util",ei)}function ew(ei){var ea;eo.crypto=eb=ei,eo.subtleCrypto=eS=null!==(ea=ei.subtle)&&void 0!==ea?ea:ei.webkitSubtle}function e_(ei){eo.TextEncoder=eE=ei}},4830:function(ei,eo,ea){"use strict";var ec=ea(8764).Buffer,ed=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.DehydrationManager=eo.DEHYDRATION_ALGORITHM=void 0;var eu=ed(ea(8416)),eh=ed(ea(9141)),ef=ea(2772),ep=ea(7585),eg=ea(2611),em=ea(7434),ey=ea(95);let eb="org.matrix.msc2697.v1.olm.libolm_pickle";eo.DEHYDRATION_ALGORITHM=eb;let eS=6048e5;class eE{constructor(ei){this.crypto=ei,(0,eu.default)(this,"inProgress",!1),(0,eu.default)(this,"timeoutId",void 0),(0,eu.default)(this,"key",void 0),(0,eu.default)(this,"keyInfo",void 0),(0,eu.default)(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[ep.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.crypto.cryptoStore.getSecretStorePrivateKey(ei,async ei=>{if(ei){let{key:eo,keyInfo:ed,deviceDisplayName:eu,time:eh}=ei,ep=ec.from(this.crypto.olmDevice.pickleKey),em=await (0,eg.decryptAES)(eo,ep,eb);this.key=(0,ef.decodeBase64)(em),this.keyInfo=ed,this.deviceDisplayName=eu;let ey=Date.now(),eE=Math.max(1,eh+eS-ey);this.timeoutId=ea.g.setTimeout(this.dehydrateDevice.bind(this),eE)}},"dehydration")})}async setKeyAndQueueDehydration(ei,eo={},ea){let ec=await this.setKey(ei,eo,ea);ec||this.dehydrateDevice()}async setKey(ei,eo={},ec){if(!ei){this.timeoutId&&(ea.g.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[ep.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(ei,"dehydration",null)}),this.key=void 0,this.keyInfo=void 0;return}let ed=!!this.key&&ei.length==this.key.length;for(let eo=0;ed&&eo<ei.length;eo++)ei[eo]!=this.key[eo]&&(ed=!1);return ed||(this.key=ei,this.keyInfo=eo,this.deviceDisplayName=ec),ed}async dehydrateDevice(){if(this.inProgress){em.logger.log("Dehydration already in progress -- not starting new dehydration");return}this.inProgress=!0,this.timeoutId&&(ea.g.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{let ei=ec.from(this.crypto.olmDevice.pickleKey),eo=await (0,eg.encryptAES)((0,ef.encodeBase64)(this.key),ei,eb);await this.crypto.cryptoStore.doTxn("readwrite",[ep.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(ei,"dehydration",{keyInfo:this.keyInfo,key:eo,deviceDisplayName:this.deviceDisplayName,time:Date.now()})}),em.logger.log("Attempting to dehydrate device"),em.logger.log("Creating account");let ed=new ea.g.Olm.Account;ed.create();let eu=JSON.parse(ed.identity_keys()),eE=ed.max_number_of_one_time_keys();ed.generate_one_time_keys(eE/2),ed.generate_fallback_key();let ew=JSON.parse(ed.one_time_keys()),e_=JSON.parse(ed.fallback_key());ed.mark_keys_as_published();let eT=ed.pickle(new Uint8Array(this.key)),eI={algorithm:eb,account:eT};this.keyInfo.passphrase&&(eI.passphrase=this.keyInfo.passphrase),em.logger.log("Uploading account to server");let eC=await this.crypto.baseApis.http.authedRequest(ey.Method.Put,"/dehydrated_device",void 0,{device_data:eI,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"}),eO=eC.device_id;em.logger.log("Preparing device keys",eO);let eR={algorithms:this.crypto.supportedAlgorithms,device_id:eO,user_id:this.crypto.userId,keys:{[`ed25519:${eO}`]:eu.ed25519,[`curve25519:${eO}`]:eu.curve25519}},ek=ed.sign(eh.default.stringify(eR));eR.signatures={[this.crypto.userId]:{[`ed25519:${eO}`]:ek}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(eR,"self_signing"),em.logger.log("Preparing one-time keys");let eM={};for(let[ei,eo]of Object.entries(ew.curve25519)){let ea={key:eo},ec=ed.sign(eh.default.stringify(ea));ea.signatures={[this.crypto.userId]:{[`ed25519:${eO}`]:ec}},eM[`signed_curve25519:${ei}`]=ea}em.logger.log("Preparing fallback keys");let eP={};for(let[ei,eo]of Object.entries(e_.curve25519)){let ea={key:eo,fallback:!0},ec=ed.sign(eh.default.stringify(ea));ea.signatures={[this.crypto.userId]:{[`ed25519:${eO}`]:ec}},eP[`signed_curve25519:${ei}`]=ea}return em.logger.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(ey.Method.Post,"/keys/upload/"+encodeURI(eO),void 0,{device_keys:eR,one_time_keys:eM,"org.matrix.msc2732.fallback_keys":eP}),em.logger.log("Done dehydrating"),this.timeoutId=ea.g.setTimeout(this.dehydrateDevice.bind(this),eS),eO}finally{this.inProgress=!1}}stop(){this.timeoutId&&(ea.g.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}eo.DehydrationManager=eE},3272:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.DeviceInfo=void 0;var ed=ec(ea(8416)),eu=function(ei){return ei[ei.Blocked=-1]="Blocked",ei[ei.Unverified=0]="Unverified",ei[ei.Verified=1]="Verified",ei}(eu||{});class eh{static fromStorage(ei,eo){let ea=new eh(eo);for(let eo in ei)ei.hasOwnProperty(eo)&&(ea[eo]=ei[eo]);return ea}constructor(ei){this.deviceId=ei,(0,ed.default)(this,"algorithms",[]),(0,ed.default)(this,"keys",{}),(0,ed.default)(this,"verified",eu.Unverified),(0,ed.default)(this,"known",!1),(0,ed.default)(this,"unsigned",{}),(0,ed.default)(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==eu.Blocked}isVerified(){return this.verified==eu.Verified}isUnverified(){return this.verified==eu.Unverified}isKnown(){return!0===this.known}}eo.DeviceInfo=eh,(0,ed.default)(eh,"DeviceVerification",{VERIFIED:eu.Verified,UNVERIFIED:eu.Unverified,BLOCKED:eu.Blocked})},2600:function(ei,eo,ea){"use strict";var ec=ea(8764).Buffer,ed=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.IncomingRoomKeyRequest=eo.CryptoEvent=eo.Crypto=void 0,eo.fixBackupKey=e8,eo.isCryptoAvailable=e3,eo.verificationMethods=void 0;var eu=ed(ea(8416)),eh=ed(ea(9141)),ef=ea(7429),ep=ea(2481),eg=ea(771),em=ea(7434),ey=ea(2573),eb=eQ(ea(2772)),eS=ea(6670),eE=ea(3272),ew=eQ(ea(1994)),e_=ea(3075),eT=ea(636),eI=ea(4823),eC=ea(6617),eO=ea(7585),eR=ea(1696),ek=ea(6381),eM=ea(1597),eP=ea(4077),eA=ea(5279),eD=ea(2842),ej=ea(9588),eL=ea(4028),eN=ea(9489),eU=ea(2611),eB=ea(4830),eF=ea(5537),eK=ea(7366),e$=ea(2848),eW=ea(4369),eV=ea(2168),eG=ea(5861),eH=ea(6860),ez=ea(3102),eY=ea(1891);function eJ(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eJ=function(ei){return ei?ea:eo})(ei)}function eQ(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eJ(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function eX(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eZ(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eX(Object(ea),!0).forEach(function(eo){(0,eu.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eX(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let e0=eE.DeviceInfo.DeviceVerification,e1={[eR.ReciprocateQRCode.NAME]:eR.ReciprocateQRCode,[ek.SAS.NAME]:ek.SAS,[eR.SHOW_QR_CODE_METHOD]:eL.IllegalMethod,[eR.SCAN_QR_CODE_METHOD]:eL.IllegalMethod},e2={RECIPROCATE_QR_CODE:eR.ReciprocateQRCode.NAME,SAS:ek.SAS.NAME};function e3(){return!!ea.g.Olm}eo.verificationMethods=e2;let e6=36e5,e4=function(ei){return ei.DeviceVerificationChanged="deviceVerificationChanged",ei.UserTrustStatusChanged="userTrustStatusChanged",ei.UserCrossSigningUpdated="userCrossSigningUpdated",ei.RoomKeyRequest="crypto.roomKeyRequest",ei.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",ei.KeyBackupStatus="crypto.keyBackupStatus",ei.KeyBackupFailed="crypto.keyBackupFailed",ei.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",ei.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",ei.VerificationRequest="crypto.verification.request",ei.Warning="crypto.warning",ei.WillUpdateDevices="crypto.willUpdateDevices",ei.DevicesUpdated="crypto.devicesUpdated",ei.KeysChanged="crossSigning.keysChanged",ei}({});eo.CryptoEvent=e4;class e5 extends eG.TypedEventEmitter{static getOlmVersion(){return ey.OlmDevice.getOlmVersion()}constructor(ei,eo,ea,ec,ed,eh,ef){if(super(),this.baseApis=ei,this.userId=eo,this.deviceId=ea,this.clientStore=ec,this.cryptoStore=ed,this.roomList=eh,(0,eu.default)(this,"backupManager",void 0),(0,eu.default)(this,"crossSigningInfo",void 0),(0,eu.default)(this,"olmDevice",void 0),(0,eu.default)(this,"deviceList",void 0),(0,eu.default)(this,"dehydrationManager",void 0),(0,eu.default)(this,"secretStorage",void 0),(0,eu.default)(this,"reEmitter",void 0),(0,eu.default)(this,"verificationMethods",void 0),(0,eu.default)(this,"supportedAlgorithms",void 0),(0,eu.default)(this,"outgoingRoomKeyRequestManager",void 0),(0,eu.default)(this,"toDeviceVerificationRequests",void 0),(0,eu.default)(this,"inRoomVerificationRequests",void 0),(0,eu.default)(this,"trustCrossSignedDevices",!0),(0,eu.default)(this,"lastOneTimeKeyCheck",null),(0,eu.default)(this,"oneTimeKeyCheckInProgress",!1),(0,eu.default)(this,"roomEncryptors",new Map),(0,eu.default)(this,"roomDecryptors",new Map),(0,eu.default)(this,"deviceKeys",{}),(0,eu.default)(this,"globalBlacklistUnverifiedDevices",!1),(0,eu.default)(this,"globalErrorOnUnknownDevices",!0),(0,eu.default)(this,"receivedRoomKeyRequests",[]),(0,eu.default)(this,"receivedRoomKeyRequestCancellations",[]),(0,eu.default)(this,"processingRoomKeyRequests",!1),(0,eu.default)(this,"lazyLoadMembers",!1),(0,eu.default)(this,"roomDeviceTrackingState",{}),(0,eu.default)(this,"lastNewSessionForced",new ez.MapWithDefault(()=>new ez.MapWithDefault(()=>0))),(0,eu.default)(this,"sendKeyRequestsImmediately",!1),(0,eu.default)(this,"oneTimeKeyCount",void 0),(0,eu.default)(this,"needsNewFallback",void 0),(0,eu.default)(this,"fallbackCleanup",void 0),(0,eu.default)(this,"onDeviceListUserCrossSigningUpdated",async ei=>{if(ei===this.userId){let eo=this.deviceList.getStoredCrossSigningForUser(ei),ea=eo?eo.getId():null,ec=this.crossSigningInfo.getId(),ed=ec!==ea;ec&&ea&&!ed?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit(e4.KeysChanged,{}),this.emit(e4.UserTrustStatusChanged,this.userId,this.checkUserTrust(ei)))}else{await this.checkDeviceVerifications(ei);let eo=this.deviceList.getStoredCrossSigningForUser(ei);eo&&(eo.updateCrossSigningVerifiedBefore(this.checkUserTrust(ei).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(ei,eo.toStorage())),this.emit(e4.UserTrustStatusChanged,ei,this.checkUserTrust(ei))}}),(0,eu.default)(this,"onMembership",(ei,eo,ea)=>{try{this.onRoomMembership(ei,eo,ea)}catch(ei){em.logger.error("Error handling membership change:",ei)}}),(0,eu.default)(this,"onToDeviceEvent",ei=>{try{em.logger.log(`received to-device ${ei.getType()} from: ${ei.getSender()} id: ${ei.getContent()[ep.ToDeviceMessageId]}`),"m.room_key"==ei.getType()||"m.forwarded_room_key"==ei.getType()?this.onRoomKeyEvent(ei):"m.room_key_request"==ei.getType()?this.onRoomKeyRequestEvent(ei):"m.secret.request"===ei.getType()?this.secretStorage.onRequestReceived(ei):"m.secret.send"===ei.getType()?this.secretStorage.onSecretReceived(ei):"m.room_key.withheld"===ei.getType()?this.onRoomKeyWithheldEvent(ei):ei.getContent().transaction_id?this.onKeyVerificationMessage(ei):"m.bad.encrypted"===ei.getContent().msgtype?this.onToDeviceBadEncrypted(ei):(ei.isBeingDecrypted()||ei.shouldAttemptDecryption())&&(ei.isBeingDecrypted()||ei.attemptDecryption(this),ei.once(eW.MatrixEventEvent.Decrypted,ei=>{this.onToDeviceEvent(ei)}))}catch(ei){em.logger.error("Error handling toDeviceEvent:",ei)}}),(0,eu.default)(this,"onTimelineEvent",(ei,eo,ea,ec,{liveEvent:ed=!0}={})=>{if(!eD.InRoomChannel.validateEvent(ei,this.baseApis))return;let eu=ei=>{let eo=new eD.InRoomChannel(this.baseApis,ei.getRoomId());return new eA.VerificationRequest(eo,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(ei,this.inRoomVerificationRequests,eu,ed)}),this.reEmitter=new eg.TypedReEmitter(this),ef)for(let ei of(this.verificationMethods=new Map,ef))"string"==typeof ei?e1[ei]&&this.verificationMethods.set(ei,e1[ei]):ei.NAME?this.verificationMethods.set(ei.NAME,ei):em.logger.warn(`Excluding unknown verification method ${ei}`);else this.verificationMethods=new Map(Object.entries(e1));this.backupManager=new eF.BackupManager(ei,async()=>{let ei=await this.getSessionBackupPrivateKey();if(ei)return ei;let eo=await this.secretStorage.get("m.megolm_backup.v1");if(eo){let ei=e8(eo);if(ei){let eo=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",ei,[eo[0]])}return eb.decodeBase64(ei||eo)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw Error("Unable to get private key")}),this.olmDevice=new ey.OlmDevice(ed),this.deviceList=new eS.DeviceList(ei,ed,this.olmDevice),this.deviceList.on(e4.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[e4.DevicesUpdated,e4.WillUpdateDevices]),this.supportedAlgorithms=Array.from(ew.DECRYPTION_CLASSES.keys()),this.outgoingRoomKeyRequestManager=new eC.OutgoingRoomKeyRequestManager(ei,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new ej.ToDeviceRequests,this.inRoomVerificationRequests=new eD.InRoomRequests;let eE=this.baseApis.cryptoCallbacks||{},eT=(0,e_.createCryptoStoreCacheCallbacks)(ed,this.olmDevice);this.crossSigningInfo=new e_.CrossSigningInfo(eo,eE,eT),this.secretStorage=new eI.SecretStorage(ei,eE,ei),this.dehydrationManager=new eB.DehydrationManager(this),!eE.getCrossSigningKey&&eE.getSecretStorageKey&&(eE.getCrossSigningKey=async ei=>e_.CrossSigningInfo.getFromSecretStorage(ei,this.secretStorage))}async init({exportedOlmDevice:ei,pickleKey:eo}={}){em.logger.log("Crypto: initialising Olm..."),await ea.g.Olm.init(),em.logger.log(ei?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:ei,pickleKey:eo}),em.logger.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,em.logger.log("Crypto: fetching own devices...");let ec=this.deviceList.getRawStoredDevicesForUser(this.userId);if(ec||(ec={}),!ec[this.deviceId]){em.logger.log("Crypto: adding this device to the store...");let ei={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:e0.VERIFIED,known:!0};ec[this.deviceId]=ei,this.deviceList.storeDevicesForUser(this.userId,ec),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[eO.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.cryptoStore.getCrossSigningKeys(ei,ei=>{ei&&0!==Object.keys(ei).length&&(em.logger.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(ei))})}),this.deviceList.startTrackingDeviceList(this.userId),em.logger.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(ei){for(let eo of(this.trustCrossSignedDevices=ei,this.deviceList.getKnownUserIds())){let ei=this.deviceList.getRawStoredDevicesForUser(eo);for(let ea of Object.keys(ei)){let ei=this.checkDeviceTrust(eo,ea);if(!ei.isLocallyVerified()&&ei.isCrossSigningVerified()){let ei=this.deviceList.getStoredDevice(eo,ea);this.emit(e4.DeviceVerificationChanged,eo,ea,ei)}}}}async createRecoveryKeyFromPassphrase(ei){let eo=new ea.g.Olm.PkDecryption;try{let ea={};if(ei){let ec=await (0,eM.keyFromPassphrase)(ei);ea.passphrase={algorithm:"m.pbkdf2",iterations:ec.iterations,salt:ec.salt},ea.pubkey=eo.init_with_private_key(ec.key)}else ea.pubkey=eo.generate_key();let ec=eo.get_private_key(),ed=(0,eP.encodeRecoveryKey)(ec);return{keyInfo:ea,encodedPrivateKey:ed,privateKey:ec}}finally{null==eo||eo.free()}}async userHasCrossSigningKeys(){return await this.downloadKeys([this.userId]),null!==this.deviceList.getStoredCrossSigningForUser(this.userId)}async isCrossSigningReady(){let ei=this.crossSigningInfo.getId(),eo=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!!(ei&&eo)}async isSecretStorageReady(){let ei=await this.secretStorage.hasKey(),eo=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),ea=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(ei&&eo&&ea)}async bootstrapCrossSigning({authUploadDeviceSigningKeys:ei,setupNewCrossSigning:eo}={}){em.logger.log("Bootstrapping cross-signing");let ea=this.baseApis.cryptoCallbacks,ec=new eT.EncryptionSetupBuilder(this.baseApis.store.accountData,ea),ed=new e_.CrossSigningInfo(this.userId,ec.crossSigningCallbacks,ec.crossSigningCallbacks),eu=async()=>{ed.resetKeys(),await this.signObject(ed.keys.master),ec.addCrossSigningKeys(ei,ed.keys);let eo=this.deviceList.getStoredDevice(this.userId,this.deviceId),ea=await ed.signDevice(this.userId,eo);ec.addKeySignature(this.userId,this.deviceId,ea),this.backupManager.backupInfo&&(await ed.signObject(this.backupManager.backupInfo.auth_data,"master"),ec.addSessionBackup(this.backupManager.backupInfo))},eh=this.crossSigningInfo.getId(),ef=await this.crossSigningInfo.isStoredInKeyCache(),ep=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),eg=ef||ep;em.logger.log({setupNewCrossSigning:eo,publicKeysOnDevice:eh,privateKeysInCache:ef,privateKeysInStorage:ep,privateKeysExistSomewhere:eg}),!eg||eo?(em.logger.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await eu()):eh&&ef?em.logger.log("Cross-signing public keys trusted and private keys found locally"):ep&&(em.logger.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));let ey=ec.crossSigningCallbacks.privateKeys;if(ey.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){let ei=new eY.ServerSideSecretStorageImpl(ec.accountDataClientAdapter,ec.ssssCryptoCallbacks);await ei.hasKey()&&(em.logger.log("Storing new cross-signing private keys in secret storage"),await e_.CrossSigningInfo.storeInSecretStorage(ey,ei))}let eb=ec.buildOperation();await eb.apply(this),await ec.persist(this),em.logger.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:ei=async()=>({}),keyBackupInfo:eo,setupNewKeyBackup:ea,setupNewSecretStorage:ec,getKeyBackupPassphrase:ed}={}){em.logger.log("Bootstrapping Secure Secret Storage");let eu=this.baseApis.cryptoCallbacks,eh=new eT.EncryptionSetupBuilder(this.baseApis.store.accountData,eu),ef=new eY.ServerSideSecretStorageImpl(eh.accountDataClientAdapter,eh.ssssCryptoCallbacks),ep=null,eg=async(ei,eo)=>{eo&&(ei.key=eo);let{keyId:ea,keyInfo:ec}=await ef.addKey(eY.SECRET_STORAGE_ALGORITHM_V1_AES,ei);return eo&&eh.ssssCryptoCallbacks.addPrivateKey(ea,ec,eo),await ef.setDefaultKeyId(ea),ea},ey=async(ei,eo)=>{if(!eo.mac){var ea,ec;let ed=await (null===(ea=(ec=this.baseApis.cryptoCallbacks).getSecretStorageKey)||void 0===ea?void 0:ea.call(ec,{keys:{[ei]:eo}},""));if(ed){let ea=ed[1];eh.ssssCryptoCallbacks.addPrivateKey(ei,eo,ea);let{iv:ec,mac:eu}=await (0,eU.calculateKeyCheck)(ea);eo.iv=ec,eo.mac=eu,await eh.setAccountData(`m.secret_storage.key.${ei}`,eo)}}},eS=async ei=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{em.logger.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(ei,"master")}catch(ei){em.logger.error("Signing key backup with cross-signing keys failed",ei)}else em.logger.warn("Cross-signing keys not available, skipping signature on key backup")},eE=await this.secretStorage.getKey(),[ew,eI]=eE||[null,null],eC=!ec&&eI&&eI.algorithm===eY.SECRET_STORAGE_ALGORITHM_V1_AES;if(em.logger.log({keyBackupInfo:eo,setupNewKeyBackup:ea,setupNewSecretStorage:ec,storageExists:eC,oldKeyInfo:eI}),eC||eo){if(!eC&&eo){em.logger.log("Secret storage does not exist, using key backup key");let ei=await this.getSessionBackupPrivateKey()||await (null==ed?void 0:ed()),ea={};eo.auth_data.private_key_salt&&eo.auth_data.private_key_iterations&&(ea.passphrase={algorithm:"m.pbkdf2",iterations:eo.auth_data.private_key_iterations,salt:eo.auth_data.private_key_salt,bits:256}),ep=await eg(ea,ei),await ef.store("m.megolm_backup.v1",eb.encodeBase64(ei),[ep]),await eS(eo.auth_data),eh.addSessionBackup(eo)}else em.logger.log("Secret storage exists"),eI&&eI.algorithm===eY.SECRET_STORAGE_ALGORITHM_V1_AES&&await ey(ew,eI)}else{em.logger.log("Secret storage does not exist, creating new storage key");let{keyInfo:eo={},privateKey:ea}=await ei();ep=await eg(eo,ea)}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(ep||!await this.crossSigningInfo.isStoredInSecretStorage(ef))){em.logger.log("Copying cross-signing private keys from cache to secret storage");let ei=await this.crossSigningInfo.getCrossSigningKeysFromCache();await e_.CrossSigningInfo.storeInSecretStorage(ei,ef)}if(ea&&!eo){em.logger.log("Creating new message key backup version");let ei=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),eo=(0,eP.decodeRecoveryKey)(ei.recovery_key);await ef.store("m.megolm_backup.v1",eb.encodeBase64(eo));let ea={algorithm:ei.algorithm,auth_data:ei.auth_data};await eS(ea.auth_data),await this.signObject(ea.auth_data),eh.addSessionBackup(ea)}let eO=await ef.get("m.megolm_backup.v1");if(eO){em.logger.info("Got session backup key from secret storage: caching");let ei=e8(eO);if(ei){let eo=ep||ew;await ef.store("m.megolm_backup.v1",ei,eo?[eo]:null)}let eo=new Uint8Array(eb.decodeBase64(ei||eO));eh.addSessionBackupPrivateKeyToCache(eo)}else if(this.backupManager.getKeyBackupEnabled()){let ei=await this.getSessionBackupPrivateKey()||await (null==ed?void 0:ed());if(!ei){em.logger.error("Key backup is enabled but couldn't get key backup key!");return}em.logger.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await ef.store("m.megolm_backup.v1",eb.encodeBase64(ei))}let eR=eh.buildOperation();await eR.apply(this),await eh.persist(this),em.logger.log("Secure Secret Storage ready")}addSecretStorageKey(ei,eo,ea){return this.secretStorage.addKey(ei,eo,ea)}hasSecretStorageKey(ei){return this.secretStorage.hasKey(ei)}getSecretStorageKey(ei){return this.secretStorage.getKey(ei)}storeSecret(ei,eo,ea){return this.secretStorage.store(ei,eo,ea)}getSecret(ei){return this.secretStorage.get(ei)}isSecretStored(ei){return this.secretStorage.isStored(ei)}requestSecret(ei,eo){return eo||(eo=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(ei,eo)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(ei){return this.secretStorage.setDefaultKeyId(ei)}checkSecretStorageKey(ei,eo){return this.secretStorage.checkKey(ei,eo)}checkSecretStoragePrivateKey(ei,eo){let ec=null;try{ec=new ea.g.Olm.PkDecryption;let ed=ec.init_with_private_key(ei);return ed===eo}finally{var ed;null===(ed=ec)||void 0===ed||ed.free()}}async getSessionBackupPrivateKey(){let ei=await new Promise(ei=>{this.cryptoStore.doTxn("readonly",[eO.IndexedDBCryptoStore.STORE_ACCOUNT],eo=>{this.cryptoStore.getSecretStorePrivateKey(eo,ei,"m.megolm_backup.v1")})});if(ei&&"string"==typeof ei&&(ei=new Uint8Array(eb.decodeBase64(e8(ei)||ei)),await this.storeSessionBackupPrivateKey(ei)),ei&&ei.ciphertext){let eo=ec.from(this.olmDevice.pickleKey),ea=await (0,eU.decryptAES)(ei,eo,"m.megolm_backup.v1");ei=eb.decodeBase64(ea)}return ei}async storeSessionBackupPrivateKey(ei){if(!(ei instanceof Uint8Array))throw Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${ei}`);let eo=ec.from(this.olmDevice.pickleKey),ea=await (0,eU.encryptAES)(eb.encodeBase64(ei),eo,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[eO.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.cryptoStore.storeSecretStorePrivateKey(ei,"m.megolm_backup.v1",ea)})}checkCrossSigningPrivateKey(ei,eo){let ec=null;try{ec=new ea.g.Olm.PkSigning;let ed=ec.init_with_seed(ei);return ed===eo}finally{var ed;null===(ed=ec)||void 0===ed||ed.free()}}async afterCrossSigningLocalKeyChange(){em.logger.info("Starting cross-signing key change post-processing");let ei=this.deviceList.getStoredDevice(this.userId,this.deviceId),eo=await this.crossSigningInfo.signDevice(this.userId,ei);em.logger.info(`Starting background key sig upload for ${this.deviceId}`);let ea=({shouldEmit:ei=!1})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:eo}}).then(eo=>{let{failures:ec}=eo||{};if(Object.keys(ec||[]).length>0)throw ei&&this.baseApis.emit(e4.KeySignatureUploadFailure,ec,"afterCrossSigningLocalKeyChange",ea),new eN.KeySignatureUploadError("Key upload failed",{failures:ec});em.logger.info(`Finished background key sig upload for ${this.deviceId}`)}).catch(ei=>{em.logger.error(`Error during background key sig upload for ${this.deviceId}`,ei)});ea({shouldEmit:!0});let ec=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(ec){em.logger.info("Starting device verification upgrade");let ei={};for(let[eo,ea]of Object.entries(this.deviceList.crossSigningInfo)){let ec=await this.checkForDeviceVerificationUpgrade(eo,e_.CrossSigningInfo.fromStorage(ea,eo));ec&&(ei[eo]=ec)}if(Object.keys(ei).length>0){em.logger.info(`Found ${Object.keys(ei).length} verif users to upgrade`);try{let eo=await ec({users:ei});if(eo)for(let ea of eo)ea in ei&&await this.baseApis.setDeviceVerified(ea,ei[ea].crossSigningInfo.getId())}catch(ei){em.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",ei)}}em.logger.info("Finished device verification upgrade")}em.logger.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(ei,eo){let ea=this.crossSigningInfo.checkUserTrust(eo);if(eo.firstUse&&!ea.isVerified()){let ea=this.deviceList.getRawStoredDevicesForUser(ei),ec=await this.checkForValidDeviceSignature(ei,eo.keys.master,ea);if(ec.length)return{devices:ec.map(ei=>eE.DeviceInfo.fromStorage(ea[ei],ei)),crossSigningInfo:eo}}}async checkForValidDeviceSignature(ei,eo,ea){let ec=[];if(ea&&eo.signatures&&eo.signatures[ei])for(let ed of Object.keys(eo.signatures[ei])){let[,eu]=ed.split(":",2);if(eu in ea&&ea[eu].verified===e0.VERIFIED)try{await eb.verifySignature(this.olmDevice,eo,ei,eu,ea[eu].keys[ed]),ec.push(eu)}catch(ei){}}return ec}getCrossSigningId(ei){return this.crossSigningInfo.getId(ei)}getStoredCrossSigningForUser(ei){return this.deviceList.getStoredCrossSigningForUser(ei)}checkUserTrust(ei){let eo=this.deviceList.getStoredCrossSigningForUser(ei);return eo?this.crossSigningInfo.checkUserTrust(eo):new e_.UserTrustLevel(!1,!1,!1)}checkDeviceTrust(ei,eo){let ea=this.deviceList.getStoredDevice(ei,eo);return this.checkDeviceInfoTrust(ei,ea)}checkDeviceInfoTrust(ei,eo){let ea=!!(null!=eo&&eo.isVerified()),ec=this.deviceList.getStoredCrossSigningForUser(ei);if(!eo||!ec)return new e_.DeviceTrustLevel(!1,!1,ea,!1);{let ed=this.trustCrossSignedDevices||ei===this.userId;return this.crossSigningInfo.checkDeviceTrust(ec,eo,ea,ed)}}checkIfOwnDeviceCrossSigned(ei){var eo;let ea=this.deviceList.getStoredDevice(this.userId,ei);if(!ea)return!1;let ec=this.deviceList.getStoredCrossSigningForUser(this.userId);return null!==(eo=null==ec?void 0:ec.checkDeviceTrust(ec,ea,!1,!0).isCrossSigningVerified())&&void 0!==eo&&eo}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:ei=!1}={}){var eo,ea,ec;let ed=this.userId;await this.downloadKeys([this.userId]);let eu=await this.crossSigningInfo.getCrossSigningKeysFromCache(),eh=this.deviceList.getStoredCrossSigningForUser(ed);if(!eh){em.logger.error("Got cross-signing update event for user "+ed+" but no new cross-signing information found!");return}let ef=eh.getId(),ep=this.crossSigningInfo.getId()!==ef,eg=eh.getId()&&!eu.has("master");if(ep&&em.logger.info("Got new master public key",ef),ei&&(ep||eg)){em.logger.info("Attempting to retrieve cross-signing master private key");let ei=null;try{let eo=await this.crossSigningInfo.getCrossSigningKey("master",ef);ei=eo[1],em.logger.info("Got cross-signing master private key")}finally{null===(eo=ei)||void 0===eo||eo.free()}}let ey=this.crossSigningInfo.getId("self_signing"),eb=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(eh.keys);let eS=ey!==eh.getId("self_signing"),eE=eb!==eh.getId("user_signing"),ew=eh.getId("self_signing")&&!eu.has("self_signing"),e_=eh.getId("user_signing")&&!eu.has("user_signing"),eT={};if(eS&&em.logger.info("Got new self-signing key",eh.getId("self_signing")),ei&&(eS||ew)){em.logger.info("Attempting to retrieve cross-signing self-signing private key");let ei=null;try{let eo=await this.crossSigningInfo.getCrossSigningKey("self_signing",eh.getId("self_signing"));ei=eo[1],em.logger.info("Got cross-signing self-signing private key")}finally{null===(ea=ei)||void 0===ea||ea.free()}let eo=this.deviceList.getStoredDevice(this.userId,this.deviceId),ec=await this.crossSigningInfo.signDevice(this.userId,eo);eT[this.deviceId]=ec}if(eE&&em.logger.info("Got new user-signing key",eh.getId("user_signing")),ei&&(eE||e_)){em.logger.info("Attempting to retrieve cross-signing user-signing private key");let ei=null;try{let eo=await this.crossSigningInfo.getCrossSigningKey("user_signing",eh.getId("user_signing"));ei=eo[1],em.logger.info("Got cross-signing user-signing private key")}finally{null===(ec=ei)||void 0===ec||ec.free()}}if(ep){let ei=this.crossSigningInfo.keys.master;await this.signObject(ei);let eo=ei.signatures[this.userId]["ed25519:"+this.deviceId];eT[this.crossSigningInfo.getId()]=Object.assign({},ei,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:eo}}})}let eI=Object.keys(eT);if(eI.length){let ei=({shouldEmit:eo=!1})=>(em.logger.info(`Starting background key sig upload for ${eI}`),this.baseApis.uploadKeySignatures({[this.userId]:eT}).then(ea=>{let{failures:ec}=ea||{};if(em.logger.info(`Finished background key sig upload for ${eI}`),Object.keys(ec||[]).length>0)throw eo&&this.baseApis.emit(e4.KeySignatureUploadFailure,ec,"checkOwnCrossSigningTrust",ei),new eN.KeySignatureUploadError("Key upload failed",{failures:ec})}).catch(ei=>{em.logger.error(`Error during background key sig upload for ${eI}`,ei)}));ei({shouldEmit:!0})}this.emit(e4.UserTrustStatusChanged,ed,this.checkUserTrust(ed)),ep&&(this.emit(e4.KeysChanged,{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async storeTrustedSelfKeys(ei){ei?this.crossSigningInfo.setKeys(ei):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[eO.IndexedDBCryptoStore.STORE_ACCOUNT],ei=>{this.cryptoStore.storeCrossSigningKeys(ei,this.crossSigningInfo.keys)})}async checkDeviceVerifications(ei){let eo=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(eo){if(em.logger.info(`Starting device verification upgrade for ${ei}`),this.crossSigningInfo.keys.user_signing){let ea=this.deviceList.getStoredCrossSigningForUser(ei);if(ea){let ec=await this.checkForDeviceVerificationUpgrade(ei,ea);if(ec){let ed=await eo({users:{[ei]:ec}});ed.includes(ei)&&await this.baseApis.setDeviceVerified(ei,ea.getId())}}}em.logger.info(`Finished device verification upgrade for ${ei}`)}}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(ei){ei.on(e$.RoomMemberEvent.Membership,this.onMembership),ei.on(eV.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),ei.on(eK.RoomEvent.Timeline,this.onTimelineEvent),ei.on(eW.MatrixEventEvent.Decrypted,this.onTimelineEvent)}start(){em.logger.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(ei){this.globalBlacklistUnverifiedDevices=ei}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){let ei={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(ei).then(()=>this.baseApis.uploadKeysRequest({device_keys:ei}))}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){let ei=6e4,eo=5;if(this.oneTimeKeyCheckInProgress)return;let ea=Date.now();if(null!==this.lastOneTimeKeyCheck&&ea-this.lastOneTimeKeyCheck<ei)return;this.lastOneTimeKeyCheck=ea;let ec=this.olmDevice.maxNumberOfOneTimeKeys(),ed=Math.floor(ec/2),eu=async ei=>{for(;ed>ei||this.getNeedsNewFallback();){if(ed>ei){em.logger.info("generating oneTimeKeys");let ea=Math.min(ed-ei,eo);await this.olmDevice.generateOneTimeKeys(ea)}if(this.getNeedsNewFallback()){let ei=await this.olmDevice.getFallbackKey();ei.curve25519&&0!=Object.keys(ei.curve25519).length||(em.logger.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}em.logger.info("calling uploadOneTimeKeys");let ea=await this.uploadOneTimeKeys();if(ea.one_time_key_counts&&ea.one_time_key_counts.signed_curve25519)ei=ea.one_time_key_counts.signed_curve25519;else throw Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(ei=>ei.one_time_key_counts.signed_curve25519||0)).then(ei=>eu(ei)).catch(ei=>{em.logger.error("Error uploading one-time keys",ei.stack||ei)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}async uploadOneTimeKeys(){let ei;let eo=[];if(this.getNeedsNewFallback()){ei={};let ea=await this.olmDevice.getFallbackKey();for(let[ec,ed]of Object.entries(ea.curve25519)){let ea={key:ed,fallback:!0};ei["signed_curve25519:"+ec]=ea,eo.push(this.signObject(ea))}this.needsNewFallback=!1}let ea=await this.olmDevice.getOneTimeKeys(),ec={};for(let ei in ea.curve25519)if(ea.curve25519.hasOwnProperty(ei)){let ed={key:ea.curve25519[ei]};ec["signed_curve25519:"+ei]=ed,eo.push(this.signObject(ed))}await Promise.all(eo);let ed={one_time_keys:ec};ei&&(ed["org.matrix.msc2732.fallback_keys"]=ei,ed.fallback_keys=ei);let eu=await this.baseApis.uploadKeysRequest(ed);return ei&&(this.fallbackCleanup=setTimeout(()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()},36e5)),await this.olmDevice.markKeysAsPublished(),eu}downloadKeys(ei,eo){return this.deviceList.downloadKeys(ei,!!eo)}getStoredDevicesForUser(ei){return this.deviceList.getStoredDevicesForUser(ei)}getStoredDevice(ei,eo){return this.deviceList.getStoredDevice(ei,eo)}saveDeviceList(ei){return this.deviceList.saveIfDirty(ei)}async setDeviceVerification(ei,eo,ea=null,ec=null,ed=null,eu){let eh=this.deviceList.getStoredCrossSigningForUser(ei);if(eh&&eh.getId()===eo){if(null!==ec||null!==ed)throw Error("Cannot set blocked or known for a cross-signing key");if(!ea)throw Error("Cannot set a cross-signing key as unverified");let ef=eu?Object.values(eu)[0]:null;if(eu&&(1!==Object.values(eu).length||ef!==eh.getId()))throw Error(`Key did not match expected value: expected ${eh.getId()}, got ${ef}`);if(this.crossSigningInfo.getId()||ei!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(eh.keys),this.emit(e4.UserTrustStatusChanged,this.userId,this.checkUserTrust(ei))),ei===this.userId)return eh;{em.logger.info("Master key "+eh.getId()+" for "+ei+" marked verified. Signing...");let ea=await this.crossSigningInfo.signUser(eh);if(ea){let ec=async({shouldEmit:ed=!1})=>{em.logger.info("Uploading signature for "+ei+"...");let eu=await this.baseApis.uploadKeySignatures({[ei]:{[eo]:ea}}),{failures:eh}=eu||{};if(Object.keys(eh||[]).length>0)throw ed&&this.baseApis.emit(e4.KeySignatureUploadFailure,eh,"setDeviceVerification",ec),new eN.KeySignatureUploadError("Key upload failed",{failures:eh})};await ec({shouldEmit:!0})}return ea}}let ef=this.deviceList.getRawStoredDevicesForUser(ei);if(!ef||!ef[eo])throw Error("Unknown device "+ei+":"+eo);let ep=ef[eo],eg=ep.verified;if(ea){if(eu){for(let[ei,eo]of Object.entries(eu))if(ep.keys[ei]!==eo)throw Error(`Key did not match expected value: expected ${eo}, got ${ep.keys[ei]}`)}eg=e0.VERIFIED}else null!==ea&&eg==e0.VERIFIED&&(eg=e0.UNVERIFIED);ec?eg=e0.BLOCKED:null!==ec&&eg==e0.BLOCKED&&(eg=e0.UNVERIFIED);let ey=ep.known;if(null!==ed&&(ey=ed),(ep.verified!==eg||ep.known!==ey)&&(ep.verified=eg,ep.known=ey,this.deviceList.storeDevicesForUser(ei,ef),this.deviceList.saveIfDirty()),ea&&ei===this.userId){let ea;em.logger.info("Own device "+eo+" marked verified: signing");let ec=this.checkDeviceTrust(ei,eo);if(ec.isCrossSigningVerified()?em.logger.log(`Own device ${eo} already cross-signing verified`):ea=await this.crossSigningInfo.signDevice(ei,eE.DeviceInfo.fromStorage(ep,eo)),ea){let ec=async({shouldEmit:ed=!1})=>{em.logger.info("Uploading signature for "+eo);let eu=await this.baseApis.uploadKeySignatures({[ei]:{[eo]:ea}}),{failures:eh}=eu||{};if(Object.keys(eh||[]).length>0)throw ed&&this.baseApis.emit(e4.KeySignatureUploadFailure,eh,"setDeviceVerification",ec),new eN.KeySignatureUploadError("Key upload failed",{failures:eh})};await ec({shouldEmit:!0})}}let eb=eE.DeviceInfo.fromStorage(ep,eo);return this.emit(e4.DeviceVerificationChanged,ei,eo,eb),eb}findVerificationRequestDMInProgress(ei){return this.inRoomVerificationRequests.findRequestInProgress(ei)}getVerificationRequestsToDeviceInProgress(ei){return this.toDeviceVerificationRequests.getRequestsInProgress(ei)}requestVerificationDM(ei,eo){let ea=this.inRoomVerificationRequests.findRequestInProgress(eo);if(ea)return Promise.resolve(ea);let ec=new eD.InRoomChannel(this.baseApis,eo,ei);return this.requestVerificationWithChannel(ei,ec,this.inRoomVerificationRequests)}requestVerification(ei,eo){eo||(eo=Object.keys(this.deviceList.getRawStoredDevicesForUser(ei)));let ea=this.toDeviceVerificationRequests.findRequestInProgress(ei,eo);if(ea)return Promise.resolve(ea);let ec=new ej.ToDeviceChannel(this.baseApis,ei,eo,ej.ToDeviceChannel.makeTransactionId());return this.requestVerificationWithChannel(ei,ec,this.toDeviceVerificationRequests)}async requestVerificationWithChannel(ei,eo,ea){let ec=new eA.VerificationRequest(eo,this.verificationMethods,this.baseApis);eo.transactionId&&ea.setRequestByChannel(eo,ec),await ec.sendRequest();let ed=ea.getRequestByChannel(eo);return ed?ec=ed:(em.logger.log(`Crypto: adding new request to requestsByTxnId with id ${eo.transactionId} ${eo.roomId}`),ea.setRequestByChannel(eo,ec)),ec}beginKeyVerification(ei,eo,ea,ec=null){let ed;if(ec){if(!(ed=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(eo,ec)))throw Error(`No request found for user ${eo} with transactionId ${ec}`)}else{ec=ej.ToDeviceChannel.makeTransactionId();let ei=new ej.ToDeviceChannel(this.baseApis,eo,[ea],ec,ea);ed=new eA.VerificationRequest(ei,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(eo,ec,ed)}return ed.beginKeyVerification(ei,{userId:eo,deviceId:ea})}async legacyDeviceVerification(ei,eo,ea){let ec=ej.ToDeviceChannel.makeTransactionId(),ed=new ej.ToDeviceChannel(this.baseApis,ei,[eo],ec,eo),eu=new eA.VerificationRequest(ed,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(ei,ec,eu);let eh=eu.beginKeyVerification(ea,{userId:ei,deviceId:eo});return await Promise.race([eh.verify(),eu.waitFor(ei=>ei.started)]),eu}async getOlmSessionsForUser(ei){let eo=this.getStoredDevicesForUser(ei)||[],ea={};for(let ei of eo){let eo=ei.getIdentityKey(),ec=await this.olmDevice.getSessionInfoForDevice(eo);ea[ei.deviceId]={deviceIdKey:eo,sessions:ec}}return ea}getEventSenderDeviceInfo(ei){let eo=ei.getSenderKey(),ea=ei.getWireContent().algorithm;if(!eo||!ea||ei.isKeySourceUntrusted())return null;let ec=this.deviceList.getDeviceByIdentityKey(ea,eo);if(null===ec)return null;let ed=ei.getClaimedEd25519Key();return ed?ed!==ec.getFingerprint()?(em.logger.warn("Event "+ei.getId()+" claims ed25519 key "+ed+" but sender device has key "+ec.getFingerprint()),null):ec:(em.logger.warn("Event "+ei.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(ei){var eo,ea;let ec={};if(ec.senderKey=null!==(eo=ei.getSenderKey())&&void 0!==eo?eo:void 0,ec.algorithm=ei.getWireContent().algorithm,!ec.senderKey||!ec.algorithm)return ec.encrypted=!1,ec;ec.encrypted=!0,ei.isKeySourceUntrusted()?ec.authenticated=!1:ec.authenticated=!0,ec.sender=null!==(ea=this.deviceList.getDeviceByIdentityKey(ec.algorithm,ec.senderKey))&&void 0!==ea?ea:void 0;let ed=ei.getClaimedEd25519Key();return ed||(em.logger.warn("Event "+ei.getId()+" claims no ed25519 key: cannot verify sending device"),ec.mismatchedSender=!0),ec.sender&&ed!==ec.sender.getFingerprint()&&(em.logger.warn("Event "+ei.getId()+" claims ed25519 key "+ed+"but sender device has key "+ec.sender.getFingerprint()),ec.mismatchedSender=!0),ec}forceDiscardSession(ei){let eo=this.roomEncryptors.get(ei);if(void 0===eo)throw Error("Room not encrypted");if(void 0===eo.forceDiscardSession)throw Error("Room encryption algorithm doesn't support session discarding");return eo.forceDiscardSession(),Promise.resolve()}async setRoomEncryption(ei,eo,ea){let ec=this.clientStore.getRoom(ei);if(!ec)throw Error(`Unable to enable encryption tracking devices in unknown room ${ei}`);await this.setRoomEncryptionImpl(ec,eo),this.lazyLoadMembers||ea||this.deviceList.refreshOutdatedDeviceLists()}async setRoomEncryptionImpl(ei,eo){let ea=ei.roomId;if(!eo.algorithm){em.logger.log("Ignoring setRoomEncryption with no algorithm");return}let ec=this.roomList.getRoomEncryption(ea);if(ec&&JSON.stringify(ec)!=JSON.stringify(eo)){em.logger.error("Ignoring m.room.encryption event which requests a change of config in "+ea);return}let ed=this.roomEncryptors.get(ea);if(ed)return;let eu=null;ec||(eu=this.roomList.setRoomEncryption(ea,eo));let eh=ew.ENCRYPTION_CLASSES.get(eo.algorithm);if(!eh)throw Error("Unable to encrypt with "+eo.algorithm);let ef=new eh({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:ea,config:eo});if(this.roomEncryptors.set(ea,ef),eu&&await eu,em.logger.log(`Enabling encryption in ${ea}`),ei.membersLoaded())await this.trackRoomDevicesImpl(ei);else{let eo=ec=>{ei.off(eH.RoomStateEvent.Update,eo),ei.membersLoaded()&&this.trackRoomDevicesImpl(ei).catch(ei=>{em.logger.error(`Error enabling device tracking in ${ea}`,ei)})};ei.on(eH.RoomStateEvent.Update,eo)}}trackRoomDevices(ei){let eo=this.clientStore.getRoom(ei);if(!eo)throw Error(`Unable to start tracking devices in unknown room ${ei}`);return this.trackRoomDevicesImpl(eo)}trackRoomDevicesImpl(ei){let eo=ei.roomId,ea=async()=>{if(!this.roomEncryptors.has(eo))return;em.logger.log(`Starting to track devices for room ${eo} ...`);let ea=await ei.getEncryptionTargetMembers();ea.forEach(ei=>{this.deviceList.startTrackingDeviceList(ei.userId)})},ec=this.roomDeviceTrackingState[eo];return ec||(ec=ea(),this.roomDeviceTrackingState[eo]=ec.catch(ei=>{throw delete this.roomDeviceTrackingState[eo],ei})),ec}ensureOlmSessionsForUsers(ei,eo){let ea=new Map;for(let eo of ei){let ei=[];ea.set(eo,ei);let ec=this.getStoredDevicesForUser(eo)||[];for(let eo of ec){let ea=eo.getIdentityKey();ea!=this.olmDevice.deviceCurve25519Key&&eo.verified!=e0.BLOCKED&&ei.push(eo)}}return eb.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,ea,eo)}async exportRoomKeys(){let ei=[];return await this.cryptoStore.doTxn("readonly",[eO.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],eo=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(eo,eo=>{if(null===eo)return;let ea=this.olmDevice.exportInboundGroupSession(eo.senderKey,eo.sessionId,eo.sessionData);delete ea.first_known_index,ea.algorithm=eb.MEGOLM_ALGORITHM,ei.push(ea)})}),ei}importRoomKeys(ei,eo={}){let ea=0,ec=0,ed=ei.length;function eu(){var ei;null===(ei=eo.progressCallback)||void 0===ei||ei.call(eo,{stage:"load_keys",successes:ea,failures:ec,total:ed})}return Promise.all(ei.map(ei=>{if(!ei.room_id||!ei.algorithm)return em.logger.warn("ignoring room key entry with missing fields",ei),ec++,eo.progressCallback&&eu(),null;let ed=this.getRoomDecryptor(ei.room_id,ei.algorithm);return ed.importRoomKey(ei,eo).finally(()=>{ea++,eo.progressCallback&&eu()})})).then()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(ei){let eo=this.roomEncryptors.get(ei.roomId);eo&&eo.prepareToEncrypt(ei)}async encryptEvent(ei,eo){let ea=ei.getRoomId(),ec=this.roomEncryptors.get(ea);if(!ec)throw Error("Room "+ea+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");await this.trackRoomDevicesImpl(eo);let ed=ei.getContent(),eu=ed["m.relates_to"];eu&&(ed=Object.assign({},ed),delete ed["m.relates_to"]);let eh=ed["io.element.performance_metrics"];eh&&(ed=Object.assign({},ed),delete ed["io.element.performance_metrics"]);let ef=await ec.encryptMessage(eo,ei.getType(),ed);eu&&(ef["m.relates_to"]=eu),eh&&(ef["io.element.performance_metrics"]=eh),ei.makeEncrypted("m.room.encrypted",ef,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(ei){if(ei.isRedacted()){let eo=new eW.MatrixEvent(eZ({room_id:ei.getRoomId()},ei.getUnsigned().redacted_because)),ea=ei.getUnsigned().redacted_because;if(eo.isEncrypted())try{let ei=await this.decryptEvent(eo);ea=ei.clearEvent}catch(ei){em.logger.warn("Decryption of redaction failed. Falling back to unencrypted event.",ei)}return{clearEvent:{room_id:ei.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:ea}}}}{let eo=ei.getWireContent(),ea=this.getRoomDecryptor(ei.getRoomId(),eo.algorithm);return ea.decryptEvent(ei)}}async processDeviceLists(ei){await this.evalDeviceListChanges(ei)}requestRoomKey(ei,eo,ea=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(ei,eo,ea).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(ei=>{em.logger.error("Error requesting key for event",ei)})}cancelRoomKeyRequest(ei){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(ei).catch(ei=>{em.logger.warn("Error clearing pending room key requests",ei)})}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(ei,eo){let ea=eo.getContent();await this.setRoomEncryptionImpl(ei,ea)}async onSyncWillProcess(ei){ei.oldSyncToken||(em.logger.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(ei){var eo;this.deviceList.setSyncToken(null!==(eo=ei.nextSyncToken)&&void 0!==eo?eo:null),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),ei.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(ei){if(Array.isArray(null==ei?void 0:ei.changed)&&ei.changed.forEach(ei=>{this.deviceList.invalidateUserDeviceList(ei)}),Array.isArray(null==ei?void 0:ei.left)&&ei.left.length){let eo=new Set(await this.getTrackedE2eUsers());ei.left.forEach(ei=>{eo.has(ei)||this.deviceList.stopTrackingDeviceList(ei)})}}async getTrackedE2eUsers(){let ei=[];for(let eo of this.getTrackedE2eRooms()){let ea=await eo.getEncryptionTargetMembers();for(let eo of ea)ei.push(eo.userId)}return ei}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(ei=>{let eo=this.roomEncryptors.get(ei.roomId);if(!eo||!this.roomDeviceTrackingState[ei.roomId])return!1;let ea=ei.getMyMembership();return"join"===ea||"invite"===ea})}async encryptAndSendToDevices(ei,eo){let ea={eventType:ep.EventType.RoomMessageEncrypted,batch:[]};try{await Promise.all(ei.map(async({userId:ei,deviceInfo:ec})=>{let ed=ec.deviceId,eu={algorithm:eb.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ep.ToDeviceMessageId]:(0,ef.v4)()};ea.batch.push({userId:ei,deviceId:ed,payload:eu}),await eb.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[ei,[ec]]])),await eb.encryptMessageForDevice(eu.ciphertext,this.userId,this.deviceId,this.olmDevice,ei,ec,eo)})),ea.batch=ea.batch.filter(ei=>Object.keys(ei.payload.ciphertext).length>0||(em.logger.log(`No ciphertext for device ${ei.userId}:${ei.deviceId}: pruning`),!1));try{await this.baseApis.queueToDevice(ea)}catch(ei){throw em.logger.error("sendToDevice failed",ei),ei}}catch(ei){throw em.logger.error("encryptAndSendToDevices promises failed",ei),ei}}async preprocessToDeviceMessages(ei){return ei.filter(ei=>{var eo;return!!(ei.type!==ep.EventType.RoomMessageEncrypted||["m.olm.v1.curve25519-aes-sha2"].includes(null===(eo=ei.content)||void 0===eo?void 0:eo.algorithm))||(em.logger.log("Ignoring invalid encrypted to-device event from "+ei.sender),!1)})}updateOneTimeKeyCount(ei){if(isFinite(ei))this.oneTimeKeyCount=ei;else throw TypeError("Parameter for updateOneTimeKeyCount has to be a number")}processKeyCounts(ei,eo){return void 0!==ei&&this.updateOneTimeKeyCount(ei.signed_curve25519||0),void 0!==eo&&(this.needsNewFallback=!eo.includes("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(ei){let eo=ei.getContent();if(!eo.room_id||!eo.algorithm){em.logger.error("key event is missing fields");return}this.backupManager.checkedForBackup||this.backupManager.checkAndStart();let ea=this.getRoomDecryptor(eo.room_id,eo.algorithm);ea.onRoomKeyEvent(ei)}onRoomKeyWithheldEvent(ei){let eo=ei.getContent();if("m.no_olm"!==eo.code&&(!eo.room_id||!eo.session_id)||!eo.algorithm||!eo.sender_key){em.logger.error("key withheld event is missing fields");return}em.logger.info(`Got room key withheld event from ${ei.getSender()} for ${eo.algorithm} session ${eo.sender_key}|${eo.session_id} in room ${eo.room_id} with code ${eo.code} (${eo.reason})`);let ea=this.getRoomDecryptor(eo.room_id,eo.algorithm);if(ea.onRoomKeyWithheldEvent&&ea.onRoomKeyWithheldEvent(ei),!eo.room_id){let ei=this.getRoomDecryptors(eo.algorithm);for(let ea of ei)ea.retryDecryptionFromSender(eo.sender_key)}}onKeyVerificationMessage(ei){if(!ej.ToDeviceChannel.validateEvent(ei,this.baseApis))return;let eo=ei=>{if(!ej.ToDeviceChannel.canCreateRequest(ej.ToDeviceChannel.getEventType(ei)))return;let eo=ei.getContent(),ea=eo&&eo.from_device;if(!ea)return;let ec=ei.getSender(),ed=new ej.ToDeviceChannel(this.baseApis,ec,[ea]);return new eA.VerificationRequest(ed,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(ei,this.toDeviceVerificationRequests,eo)}async handleVerificationEvent(ei,eo,ea,ec=!0){if(ei.isSending()&&ei.status!=eW.EventStatus.SENT){let eo,ea;try{await new Promise((ec,ed)=>{eo=ec,ea=()=>{ei.status==eW.EventStatus.CANCELLED&&ed(Error("Event status set to CANCELLED."))},ei.once(eW.MatrixEventEvent.LocalEventIdReplaced,eo),ei.on(eW.MatrixEventEvent.Status,ea)})}catch(ei){em.logger.error("error while waiting for the verification event to be sent: ",ei);return}finally{ei.removeListener(eW.MatrixEventEvent.LocalEventIdReplaced,eo),ei.removeListener(eW.MatrixEventEvent.Status,ea)}}let ed=eo.getRequest(ei),eu=!1;if(!ed){if(!(ed=ea(ei))){em.logger.log(`Crypto: could not find VerificationRequest for ${ei.getType()}, and could not create one, so ignoring.`);return}eu=!0,eo.setRequest(ei,ed)}ei.setVerificationRequest(ed);try{await ed.channel.handleEvent(ei,ed,ec)}catch(ei){em.logger.error("error while handling verification event",ei)}let eh=eu&&!ed.initiatedByMe&&!ed.invalid&&!ed.observeOnly;eh&&this.baseApis.emit(e4.VerificationRequest,ed)}async onToDeviceBadEncrypted(ei){let eo=ei.getWireContent(),ea=ei.getSender(),ec=eo.algorithm,ed=eo.sender_key;this.baseApis.emit(eV.ClientEvent.UndecryptableToDeviceEvent,ei);let eu=()=>{let ei=this.getRoomDecryptors(eb.MEGOLM_ALGORITHM);for(let eo of ei)eo.retryDecryptionFromSender(ed)};if(void 0===ea||void 0===ed||void 0===ed)return;let eh=this.lastNewSessionForced.getOrCreate(ea),eg=eh.getOrCreate(ed);if(eg+e6>Date.now()){em.logger.debug("New session already forced with device "+ea+":"+ed+" at "+eg+": not forcing another"),await this.olmDevice.recordSessionProblem(ed,"wedged",!0),eu();return}let ey=this.deviceList.getDeviceByIdentityKey(ec,ed);if(!ey&&(await this.downloadKeys([ea],!1),!(ey=this.deviceList.getDeviceByIdentityKey(ec,ed)))){em.logger.info("Couldn't find device for identity key "+ed+": not re-establishing session"),await this.olmDevice.recordSessionProblem(ed,"wedged",!1),eu();return}let eS=new Map([[ea,[ey]]]);await eb.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,eS,!0),eh.set(ed,Date.now());let eE={algorithm:eb.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ep.ToDeviceMessageId]:(0,ef.v4)()};await eb.encryptMessageForDevice(eE.ciphertext,this.userId,this.deviceId,this.olmDevice,ea,ey,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(ed,"wedged",!0),eu(),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[ea,new Map([[ey.deviceId,eE]])]]));let ew=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(ea,ey.deviceId);for(let ei of ew)this.requestRoomKey(ei.requestBody,ei.recipients,!0)}onRoomMembership(ei,eo,ea){let ec=eo.roomId,ed=this.roomEncryptors.get(ec);if(ed){if(ec in this.roomDeviceTrackingState){var eu;"join"==eo.membership?(em.logger.log("Join event for "+eo.userId+" in "+ec),this.deviceList.startTrackingDeviceList(eo.userId)):"invite"==eo.membership&&null!==(eu=this.clientStore.getRoom(ec))&&void 0!==eu&&eu.shouldEncryptForInvitedMembers()&&(em.logger.log("Invite event for "+eo.userId+" in "+ec),this.deviceList.startTrackingDeviceList(eo.userId))}ed.onRoomMembership(ei,eo,ea)}}onRoomKeyRequestEvent(ei){let eo=ei.getContent();if("request"===eo.action){let eo=new e7(ei);this.receivedRoomKeyRequests.push(eo)}else if("request_cancellation"===eo.action){let eo=new e9(ei);this.receivedRoomKeyRequestCancellations.push(eo)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{let ei=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];let eo=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(ei.map(ei=>this.processReceivedRoomKeyRequest(ei))),await Promise.all(eo.map(ei=>this.processReceivedRoomKeyRequestCancellation(ei)))}catch(ei){em.logger.error(`Error processing room key requsts: ${ei}`)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(ei){let eo=ei.userId,ea=ei.deviceId,ec=ei.requestBody,ed=ec.room_id,eu=ec.algorithm;if(em.logger.log(`m.room_key_request from ${eo}:${ea} for ${ed} / ${ec.session_id} (id ${ei.requestId})`),eo!==this.userId){if(!this.roomEncryptors.get(ed)){em.logger.debug(`room key request for unencrypted room ${ed}`);return}let ei=this.roomEncryptors.get(ed),eu=this.deviceList.getStoredDevice(eo,ea);if(!eu){em.logger.debug(`Ignoring keyshare for unknown device ${eo}:${ea}`);return}try{await ei.reshareKeyWithDevice(ec.sender_key,ec.session_id,eo,eu)}catch(ei){em.logger.warn("Failed to re-share keys for session "+ec.session_id+" with device "+eo+":"+eu.deviceId,ei)}return}if(ea===this.deviceId){em.logger.log("Ignoring room key request from ourselves");return}if(!this.roomDecryptors.has(ed)){em.logger.log(`room key request for unencrypted room ${ed}`);return}let eh=this.roomDecryptors.get(ed).get(eu);if(!eh){em.logger.log(`room key request for unknown alg ${eu} in room ${ed}`);return}if(!await eh.hasKeysForKeyRequest(ei)){em.logger.log(`room key request for unknown session ${ed} / `+ec.session_id);return}if(ei.share=()=>{eh.shareKeysWithDevice(ei)},this.checkDeviceTrust(eo,ea).isVerified()){em.logger.log("device is already verified: sharing keys"),ei.share();return}this.emit(e4.RoomKeyRequest,ei)}async processReceivedRoomKeyRequestCancellation(ei){em.logger.log(`m.room_key_request cancellation for ${ei.userId}:${ei.deviceId} (id ${ei.requestId})`),this.emit(e4.RoomKeyRequestCancellation,ei)}getRoomDecryptor(ei,eo){let ea,ec;if(ei&&((ea=this.roomDecryptors.get(ei))||(ea=new Map,this.roomDecryptors.set(ei,ea)),ec=ea.get(eo)))return ec;let ed=ew.DECRYPTION_CLASSES.get(eo);if(!ed)throw new ew.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+eo+'".');return ec=new ed({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:null!=ei?ei:void 0}),ea&&ea.set(eo,ec),ec}getRoomDecryptors(ei){let eo=[];for(let ea of this.roomDecryptors.values())ea.has(ei)&&eo.push(ea.get(ei));return eo}async signObject(ei){let eo=new Map(Object.entries(ei.signatures||{})),ea=ei.unsigned;delete ei.signatures,delete ei.unsigned;let ec=eo.get(this.userId)||{};eo.set(this.userId,ec),ec["ed25519:"+this.deviceId]=await this.olmDevice.sign(eh.default.stringify(ei)),ei.signatures=(0,ez.recursiveMapToObject)(eo),void 0!==ea&&(ei.unsigned=ea)}}function e8(ei){if("string"!=typeof ei||0>ei.indexOf(","))return null;let eo=Uint8Array.from(ei.split(","),ei=>parseInt(ei));return eb.encodeBase64(eo)}eo.Crypto=e5;class e7{constructor(ei){(0,eu.default)(this,"userId",void 0),(0,eu.default)(this,"deviceId",void 0),(0,eu.default)(this,"requestId",void 0),(0,eu.default)(this,"requestBody",void 0),(0,eu.default)(this,"share",void 0);let eo=ei.getContent();this.userId=ei.getSender(),this.deviceId=eo.requesting_device_id,this.requestId=eo.request_id,this.requestBody=eo.body||{},this.share=()=>{throw Error("don't know how to share keys for this request yet")}}}eo.IncomingRoomKeyRequest=e7;class e9{constructor(ei){(0,eu.default)(this,"userId",void 0),(0,eu.default)(this,"deviceId",void 0),(0,eu.default)(this,"requestId",void 0);let eo=ei.getContent();this.userId=ei.getSender(),this.deviceId=eo.requesting_device_id,this.requestId=eo.request_id}}},1597:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.deriveKey=eg,eo.keyFromAuthData=ef,eo.keyFromPassphrase=ep;var ec=ea(8401),ed=ea(9126);let eu=5e5,eh=256;function ef(ei,eo){if(!ea.g.Olm)throw Error("Olm is not available");if(!ei.private_key_salt||!ei.private_key_iterations)throw Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return eg(eo,ei.private_key_salt,ei.private_key_iterations,ei.private_key_bits||eh)}async function ep(ei){if(!ea.g.Olm)throw Error("Olm is not available");let eo=(0,ec.randomString)(32),ed=await eg(ei,eo,eu,eh);return{key:ed,salt:eo,iterations:eu}}async function eg(ei,eo,ea,ec=eh){if(!ed.subtleCrypto||!ed.TextEncoder)throw Error("Password-based backup is not available on this platform");let eu=await ed.subtleCrypto.importKey("raw",new ed.TextEncoder().encode(ei),{name:"PBKDF2"},!1,["deriveBits"]),ef=await ed.subtleCrypto.deriveBits({name:"PBKDF2",salt:new ed.TextEncoder().encode(eo),iterations:ea,hash:"SHA-512"},eu,ec);return new Uint8Array(ef)}},2772:function(ei,eo,ea){"use strict";var ec=ea(8764).Buffer,ed=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.OLM_ALGORITHM=eo.MEGOLM_BACKUP_ALGORITHM=eo.MEGOLM_ALGORITHM=void 0,eo.decodeBase64=eD,eo.encodeBase64=eP,eo.encodeUnpaddedBase64=eA,eo.encryptMessageForDevice=e_,eo.ensureOlmSessionsForDevices=eI,eo.getExistingOlmSessions=eT,eo.isOlmEncrypted=eM,eo.pkSign=eR,eo.pkVerify=ek,eo.verifySignature=eO;var eu=ed(ea(8416)),eh=ed(ea(9141)),ef=ea(7434),ep=ea(2481),eg=ea(3102);function em(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ey(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?em(Object(ea),!0).forEach(function(eo){(0,eu.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):em(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}var eb=function(ei){return ei.Olm="m.olm.v1.curve25519-aes-sha2",ei.Megolm="m.megolm.v1.aes-sha2",ei.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2",ei}(eb||{});let eS=eb.Olm;eo.OLM_ALGORITHM=eS;let eE=eb.Megolm;eo.MEGOLM_ALGORITHM=eE;let ew=eb.MegolmBackup;async function e_(ei,eo,ea,ec,ed,eu,eh){let ep=eu.getIdentityKey(),eg=await ec.getSessionIdForDevice(ep);if(null===eg){ef.logger.log(`[olmlib.encryptMessageForDevice] Unable to find Olm session for device ${ed}:${eu.deviceId}`);return}ef.logger.log(`[olmlib.encryptMessageForDevice] Using Olm session ${eg} for device ${ed}:${eu.deviceId}`);let em=ey({sender:eo,sender_device:ea,keys:{ed25519:ec.deviceEd25519Key},recipient:ed,recipient_keys:{ed25519:eu.getFingerprint()}},eh);ei[ep]=await ec.encryptMessage(ep,eg,JSON.stringify(em))}async function eT(ei,eo,ea){let ec=new eg.MapWithDefault(()=>[]),ed=new eg.MapWithDefault(()=>new Map),eu=[];for(let[eo,eh]of Object.entries(ea))for(let ea of eh){let eh=ea.deviceId,ef=ea.getIdentityKey();eu.push((async()=>{let eu=await ei.getSessionIdForDevice(ef,!0);null===eu?ec.getOrCreate(eo).push(ea):ed.getOrCreate(eo).set(eh,{device:ea,sessionId:eu})})())}return await Promise.all(eu),[ec,ed]}async function eI(ei,eo,ea,ec=!1,ed,eu,eh=ef.logger){let ep;let eg=[],em=new Map,ey=new Map;for(let eo of ea.values())for(let ea of eo){let eo=ea.getIdentityKey();eo!==ei.deviceCurve25519Key&&(ei.sessionsInProgress[eo]||(ei.sessionsInProgress[eo]=new Promise(ea=>{ey.set(eo,ec=>{delete ei.sessionsInProgress[eo],ea(ec)})})))}for(let[eo,ed]of ea){let ea=new Map;for(let eu of(em.set(eo,ea),ed)){let ed=eu.deviceId,ef=eu.getIdentityKey();if(ef===ei.deviceCurve25519Key){eh.info("Attempted to start session with ourself! Ignoring"),ea.set(ed,{device:eu,sessionId:null});continue}let ep=`for ${ef} (${eo}:${ed})`,em=await ei.getSessionIdForDevice(ef,!!ey.get(ef),eh),eb=ey.get(ef);null!==em&&eb&&eb(),(null===em||ec)&&(ec?eh.info(`Forcing new Olm session ${ep}`):eh.info(`Making new Olm session ${ep}`),eg.push([eo,ed])),ea.set(ed,{device:eu,sessionId:em})}}if(0===eg.length)return em;let eb="signed_curve25519",eS=`one-time keys for ${eg.length} devices`;try{eh.debug(`Claiming ${eS}`),ep=await eo.claimOneTimeKeys(eg,eb,ed),eh.debug(`Claimed ${eS}`)}catch(ei){for(let ei of ey.values())ei();throw eh.log(`Failed to claim ${eS}`,ei,eg),ei}eu&&"failures"in ep&&eu.push(...Object.keys(ep.failures));let eE=ep.one_time_keys||{},ew=[];for(let[eo,ed]of ea){let ea=eE[eo]||{};for(let eu of ed){var e_,eT,eI;let ed=eu.deviceId,ef=eu.getIdentityKey();if(ef===ei.deviceCurve25519Key||null!==(e_=em.get(eo))&&void 0!==e_&&null!==(eT=e_.get(ed))&&void 0!==eT&&eT.sessionId&&!ec)continue;let ep=ea[ed]||{},eg=null;for(let ei in ep)0===ei.indexOf(eb+":")&&(eg=ep[ei]);if(!eg){eh.warn(`No one-time keys (alg=${eb}) for device ${eo}:${ed}`),null===(eI=ey.get(ef))||void 0===eI||eI();continue}ew.push(eC(ei,eg,eo,eu).then(ei=>{var ea,ec;null===(ea=ey.get(ef))||void 0===ea||ea(null!=ei?ei:void 0);let eu=null===(ec=em.get(eo))||void 0===ec?void 0:ec.get(ed);eu&&(eu.sessionId=ei)},ei=>{var eo;throw null===(eo=ey.get(ef))||void 0===eo||eo(),ei}))}}return eS=`Olm sessions for ${ew.length} devices`,eh.debug(`Starting ${eS}`),await Promise.all(ew),eh.debug(`Started ${eS}`),em}async function eC(ei,eo,ea,ec){let ed;let eu=ec.deviceId;try{await eO(ei,eo,ea,eu,ec.getFingerprint())}catch(ei){return ef.logger.error("Unable to verify signature on one-time key for device "+ea+":"+eu+":",ei),null}try{ed=await ei.createOutboundSession(ec.getIdentityKey(),eo.key)}catch(ei){return ef.logger.error("Error starting olm session with device "+ea+":"+eu+": "+ei),null}return ef.logger.log("Started new olm sessionid "+ed+" for device "+ea+":"+eu),ed}async function eO(ei,eo,ea,ec,ed){let eu="ed25519:"+ec,ef=eo.signatures||{},ep=ef[ea]||{},eg=ep[eu];if(!eg)throw Error("No signature");let em=Object.assign({},eo);"unsigned"in em&&delete em.unsigned,delete em.signatures;let ey=eh.default.stringify(em);ei.verifySignature(ed,ey,eg)}function eR(ei,eo,ec,ed){let eu=!1;if(eo instanceof Uint8Array){let ei=new ea.g.Olm.PkSigning;ed=ei.init_with_seed(eo),eo=ei,eu=!0}let ef=ei.signatures||{};delete ei.signatures;let ep=ei.unsigned;ei.unsigned&&delete ei.unsigned;try{let ea=ef[ec]||{};return ef[ec]=ea,ea["ed25519:"+ed]=eo.sign(eh.default.stringify(ei))}finally{ei.signatures=ef,ep&&(ei.unsigned=ep),eu&&eo.free()}}function ek(ei,eo,ec){let ed="ed25519:"+eo;if(!(ei.signatures&&ei.signatures[ec]&&ei.signatures[ec][ed]))throw Error("No signature");let eu=ei.signatures[ec][ed],ef=new ea.g.Olm.Utility,ep=ei.signatures;delete ei.signatures;let eg=ei.unsigned;ei.unsigned&&delete ei.unsigned;try{ef.ed25519_verify(eo,eh.default.stringify(ei),eu)}finally{ei.signatures=ep,eg&&(ei.unsigned=eg),ef.free()}}function eM(ei){return ei.getSenderKey()?!!(ei.getWireType()===ep.EventType.RoomMessageEncrypted&&["m.olm.v1.curve25519-aes-sha2"].includes(ei.getWireContent().algorithm))||(ef.logger.error("Event was not encrypted using an appropriate algorithm"),!1):(ef.logger.error("Event has no sender key (not encrypted?)"),!1)}function eP(ei){return ec.from(ei).toString("base64")}function eA(ei){return eP(ei).replace(/=+$/g,"")}function eD(ei){return ec.from(ei,"base64")}eo.MEGOLM_BACKUP_ALGORITHM=ew},4077:function(ei,eo,ea){"use strict";var ec=ea(8764).Buffer;Object.defineProperty(eo,"__esModule",{value:!0}),eo.decodeRecoveryKey=eg,eo.encodeRecoveryKey=ep;var ed=eh(ea(7191));function eu(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eu=function(ei){return ei?ea:eo})(ei)}function eh(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eu(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eh in ei)if("default"!==eh&&Object.prototype.hasOwnProperty.call(ei,eh)){var ef=ed?Object.getOwnPropertyDescriptor(ei,eh):null;ef&&(ef.get||ef.set)?Object.defineProperty(ec,eh,ef):ec[eh]=ei[eh]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let ef=[139,1];function ep(ei){var eo;let ea=ec.alloc(ef.length+ei.length+1);ea.set(ef,0),ea.set(ei,ef.length);let eu=0;for(let ei=0;ei<ea.length-1;++ei)eu^=ea[ei];ea[ea.length-1]=eu;let eh=ed.encode(ea);return null===(eo=eh.match(/.{1,4}/g))||void 0===eo?void 0:eo.join(" ")}function eg(ei){let eo=ed.decode(ei.replace(/ /g,"")),ec=0;for(let ei of eo)ec^=ei;if(0!==ec)throw Error("Incorrect parity");for(let ei=0;ei<ef.length;++ei)if(eo[ei]!==ef[ei])throw Error("Incorrect prefix");if(eo.length!==ef.length+ea.g.Olm.PRIVATE_KEY_LENGTH+1)throw Error("Incorrect length");return Uint8Array.from(eo.slice(ef.length,ef.length+ea.g.Olm.PRIVATE_KEY_LENGTH))}},4233:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.VERSION=eo.Backend=void 0,eo.upgradeDatabase=eS;var ed=ec(ea(8416)),eu=ea(7434),eh=ep(ea(3102));function ef(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ef=function(ei){return ei?ea:eo})(ei)}function ep(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ef(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let eg=!1;class em{constructor(ei){this.db=ei,(0,ed.default)(this,"nextTxnId",0),ei.onversionchange=()=>{eu.logger.log(`versionchange for indexeddb ${this.db.name}: closing`),ei.close()}}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}getOrAddOutgoingRoomKeyRequest(ei){let eo=ei.requestBody;return new Promise((ea,ec)=>{let ed=this.db.transaction("outgoingRoomKeyRequests","readwrite");ed.onerror=ec,this._getOutgoingRoomKeyRequest(ed,eo,ec=>{if(ec){eu.logger.log(`already have key request outstanding for ${eo.room_id} / ${eo.session_id}: not sending another`),ea(ec);return}eu.logger.log(`enqueueing key request for ${eo.room_id} / `+eo.session_id),ed.oncomplete=()=>{ea(ei)};let eh=ed.objectStore("outgoingRoomKeyRequests");eh.add(ei)})})}getOutgoingRoomKeyRequest(ei){return new Promise((eo,ea)=>{let ec=this.db.transaction("outgoingRoomKeyRequests","readonly");ec.onerror=ea,this._getOutgoingRoomKeyRequest(ec,ei,ei=>{eo(ei)})})}_getOutgoingRoomKeyRequest(ei,eo,ea){let ec=ei.objectStore("outgoingRoomKeyRequests"),ed=ec.index("session"),eu=ed.openCursor([eo.room_id,eo.session_id]);eu.onsuccess=()=>{let ei=eu.result;if(!ei){ea(null);return}let ec=ei.value;if(eh.deepCompare(ec.requestBody,eo)){ea(ec);return}ei.continue()}}getOutgoingRoomKeyRequestByState(ei){let eo;if(0===ei.length)return Promise.resolve(null);let ea=0;function ec(){let ed=this.result;if(ed){eo=ed.value;return}if(++ea>=ei.length)return;let eu=ei[ea],eh=this.source.openCursor(eu);eh.onsuccess=ec}let ed=this.db.transaction("outgoingRoomKeyRequests","readonly"),eu=ed.objectStore("outgoingRoomKeyRequests"),eh=ei[ea],ef=eu.index("state").openCursor(eh);return ef.onsuccess=ec,e_(ed).then(()=>eo)}getAllOutgoingRoomKeyRequestsByState(ei){return new Promise((eo,ea)=>{let ec=this.db.transaction("outgoingRoomKeyRequests","readonly"),ed=ec.objectStore("outgoingRoomKeyRequests"),eu=ed.index("state"),eh=eu.getAll(ei);eh.onsuccess=()=>eo(eh.result),eh.onerror=()=>ea(eh.error)})}getOutgoingRoomKeyRequestsByTarget(ei,eo,ea){let ec=0,ed=[];function eu(){let eh=this.result;if(eh){let ea=eh.value;ea.recipients.some(ea=>ea.userId===ei&&ea.deviceId===eo)&&ed.push(ea),eh.continue()}else{if(++ec>=ea.length)return;let ei=ea[ec],eo=this.source.openCursor(ei);eo.onsuccess=eu}}let eh=this.db.transaction("outgoingRoomKeyRequests","readonly"),ef=eh.objectStore("outgoingRoomKeyRequests"),ep=ea[ec],eg=ef.index("state").openCursor(ep);return eg.onsuccess=eu,e_(eh).then(()=>ed)}updateOutgoingRoomKeyRequest(ei,eo,ea){let ec=null;function ed(){let ei=this.result;if(!ei)return;let ed=ei.value;if(ed.state!=eo){eu.logger.warn(`Cannot update room key request from ${eo} as it was already updated to ${ed.state}`);return}Object.assign(ed,ea),ei.update(ed),ec=ed}let eh=this.db.transaction("outgoingRoomKeyRequests","readwrite"),ef=eh.objectStore("outgoingRoomKeyRequests").openCursor(ei);return ef.onsuccess=ed,e_(eh).then(()=>ec)}deleteOutgoingRoomKeyRequest(ei,eo){let ea=this.db.transaction("outgoingRoomKeyRequests","readwrite"),ec=ea.objectStore("outgoingRoomKeyRequests").openCursor(ei);return ec.onsuccess=()=>{let ei=ec.result;if(!ei)return;let ea=ei.value;if(ea.state!=eo){eu.logger.warn(`Cannot delete room key request in state ${ea.state} (expected ${eo})`);return}ei.delete()},e_(ea)}getAccount(ei,eo){let ea=ei.objectStore("account"),ec=ea.get("-");ec.onsuccess=function(){try{eo(ec.result||null)}catch(eo){ew(ei,eo)}}}storeAccount(ei,eo){let ea=ei.objectStore("account");ea.put(eo,"-")}getCrossSigningKeys(ei,eo){let ea=ei.objectStore("account"),ec=ea.get("crossSigningKeys");ec.onsuccess=function(){try{eo(ec.result||null)}catch(eo){ew(ei,eo)}}}getSecretStorePrivateKey(ei,eo,ea){let ec=ei.objectStore("account"),ed=ec.get(`ssss_cache:${ea}`);ed.onsuccess=function(){try{eo(ed.result||null)}catch(eo){ew(ei,eo)}}}storeCrossSigningKeys(ei,eo){let ea=ei.objectStore("account");ea.put(eo,"crossSigningKeys")}storeSecretStorePrivateKey(ei,eo,ea){let ec=ei.objectStore("account");ec.put(ea,`ssss_cache:${eo}`)}countEndToEndSessions(ei,eo){let ea=ei.objectStore("sessions"),ec=ea.count();ec.onsuccess=function(){try{eo(ec.result)}catch(eo){ew(ei,eo)}}}getEndToEndSessions(ei,eo,ea){let ec=eo.objectStore("sessions"),ed=ec.index("deviceKey"),eu=ed.openCursor(ei),eh={};eu.onsuccess=function(){let ei=eu.result;if(ei)eh[ei.value.sessionId]={session:ei.value.session,lastReceivedMessageTs:ei.value.lastReceivedMessageTs},ei.continue();else try{ea(eh)}catch(ei){ew(eo,ei)}}}getEndToEndSession(ei,eo,ea,ec){let ed=ea.objectStore("sessions"),eu=ed.get([ei,eo]);eu.onsuccess=function(){try{eu.result?ec({session:eu.result.session,lastReceivedMessageTs:eu.result.lastReceivedMessageTs}):ec(null)}catch(ei){ew(ea,ei)}}}getAllEndToEndSessions(ei,eo){let ea=ei.objectStore("sessions"),ec=ea.openCursor();ec.onsuccess=function(){try{let ei=ec.result;ei?(eo(ei.value),ei.continue()):eo(null)}catch(eo){ew(ei,eo)}}}storeEndToEndSession(ei,eo,ea,ec){let ed=ec.objectStore("sessions");ed.put({deviceKey:ei,sessionId:eo,session:ea.session,lastReceivedMessageTs:ea.lastReceivedMessageTs})}async storeEndToEndSessionProblem(ei,eo,ea){let ec=this.db.transaction("session_problems","readwrite"),ed=ec.objectStore("session_problems");ed.put({deviceKey:ei,type:eo,fixed:ea,time:Date.now()}),await e_(ec)}async getEndToEndSessionProblem(ei,eo){let ea=null,ec=this.db.transaction("session_problems","readwrite"),ed=ec.objectStore("session_problems"),eu=ed.index("deviceKey"),eh=eu.getAll(ei);return eh.onsuccess=()=>{let ei=eh.result;if(!ei.length){ea=null;return}ei.sort((ei,eo)=>ei.time-eo.time);let ec=ei[ei.length-1];for(let ed of ei)if(ed.time>eo){ea=Object.assign({},ed,{fixed:ec.fixed});return}ea=ec.fixed?null:ec},await e_(ec),ea}async filterOutNotifiedErrorDevices(ei){let eo=this.db.transaction("notified_error_devices","readwrite"),ea=eo.objectStore("notified_error_devices"),ec=[];return await Promise.all(ei.map(ei=>new Promise(eo=>{let{userId:ed,deviceInfo:eu}=ei,eh=ea.get([ed,eu.deviceId]);eh.onsuccess=function(){eh.result||(ea.put({userId:ed,deviceId:eu.deviceId}),ec.push(ei)),eo()}}))),ec}getEndToEndInboundGroupSession(ei,eo,ea,ec){let ed=!1,eu=!1,eh=ea.objectStore("inbound_group_sessions"),ef=eh.get([ei,eo]);ef.onsuccess=function(){try{ed=ef.result?ef.result.session:null,!1!==eu&&ec(ed,eu)}catch(ei){ew(ea,ei)}};let ep=ea.objectStore("inbound_group_sessions_withheld"),eg=ep.get([ei,eo]);eg.onsuccess=function(){try{eu=eg.result?eg.result.session:null,!1!==ed&&ec(ed,eu)}catch(ei){ew(ea,ei)}}}getAllEndToEndInboundGroupSessions(ei,eo){let ea=ei.objectStore("inbound_group_sessions"),ec=ea.openCursor();ec.onsuccess=function(){let ea=ec.result;if(ea){try{eo({senderKey:ea.value.senderCurve25519Key,sessionId:ea.value.sessionId,sessionData:ea.value.session})}catch(eo){ew(ei,eo)}ea.continue()}else try{eo(null)}catch(eo){ew(ei,eo)}}}addEndToEndInboundGroupSession(ei,eo,ea,ec){let ed=ec.objectStore("inbound_group_sessions"),eh=ed.add({senderCurve25519Key:ei,sessionId:eo,session:ea});eh.onerror=ea=>{var ed;(null===(ed=eh.error)||void 0===ed?void 0:ed.name)==="ConstraintError"?(ea.stopPropagation(),ea.preventDefault(),eu.logger.log("Ignoring duplicate inbound group session: "+ei+" / "+eo)):ew(ec,Error("Failed to add inbound group session: "+eh.error))}}storeEndToEndInboundGroupSession(ei,eo,ea,ec){let ed=ec.objectStore("inbound_group_sessions");ed.put({senderCurve25519Key:ei,sessionId:eo,session:ea})}storeEndToEndInboundGroupSessionWithheld(ei,eo,ea,ec){let ed=ec.objectStore("inbound_group_sessions_withheld");ed.put({senderCurve25519Key:ei,sessionId:eo,session:ea})}getEndToEndDeviceData(ei,eo){let ea=ei.objectStore("device_data"),ec=ea.get("-");ec.onsuccess=function(){try{eo(ec.result||null)}catch(eo){ew(ei,eo)}}}storeEndToEndDeviceData(ei,eo){let ea=eo.objectStore("device_data");ea.put(ei,"-")}storeEndToEndRoom(ei,eo,ea){let ec=ea.objectStore("rooms");ec.put(eo,ei)}getEndToEndRooms(ei,eo){let ea={},ec=ei.objectStore("rooms"),ed=ec.openCursor();ed.onsuccess=function(){let ec=ed.result;if(ec)ea[ec.key]=ec.value,ec.continue();else try{eo(ea)}catch(eo){ew(ei,eo)}}}getSessionsNeedingBackup(ei){return new Promise((eo,ea)=>{let ec=[],ed=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");ed.onerror=ea,ed.oncomplete=function(){eo(ec)};let eu=ed.objectStore("sessions_needing_backup"),eh=ed.objectStore("inbound_group_sessions"),ef=eu.openCursor();ef.onsuccess=function(){let eo=ef.result;if(eo){let ea=eh.get(eo.key);ea.onsuccess=function(){ec.push({senderKey:ea.result.senderCurve25519Key,sessionId:ea.result.sessionId,sessionData:ea.result.session})},(!ei||ec.length<ei)&&eo.continue()}}})}countSessionsNeedingBackup(ei){ei||(ei=this.db.transaction("sessions_needing_backup","readonly"));let eo=ei.objectStore("sessions_needing_backup");return new Promise((ei,ea)=>{let ec=eo.count();ec.onerror=ea,ec.onsuccess=()=>ei(ec.result)})}async unmarkSessionsNeedingBackup(ei,eo){eo||(eo=this.db.transaction("sessions_needing_backup","readwrite"));let ea=eo.objectStore("sessions_needing_backup");await Promise.all(ei.map(ei=>new Promise((eo,ec)=>{let ed=ea.delete([ei.senderKey,ei.sessionId]);ed.onsuccess=eo,ed.onerror=ec})))}async markSessionsNeedingBackup(ei,eo){eo||(eo=this.db.transaction("sessions_needing_backup","readwrite"));let ea=eo.objectStore("sessions_needing_backup");await Promise.all(ei.map(ei=>new Promise((eo,ec)=>{let ed=ea.put({senderCurve25519Key:ei.senderKey,sessionId:ei.sessionId});ed.onsuccess=eo,ed.onerror=ec})))}addSharedHistoryInboundGroupSession(ei,eo,ea,ec){ec||(ec=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));let ed=ec.objectStore("shared_history_inbound_group_sessions"),eu=ed.get([ei]);eu.onsuccess=()=>{let{sessions:ec}=eu.result||{sessions:[]};ec.push([eo,ea]),ed.put({roomId:ei,sessions:ec})}}getSharedHistoryInboundGroupSessions(ei,eo){eo||(eo=this.db.transaction("shared_history_inbound_group_sessions","readonly"));let ea=eo.objectStore("shared_history_inbound_group_sessions"),ec=ea.get([ei]);return new Promise((ei,eo)=>{ec.onsuccess=()=>{let{sessions:eo}=ec.result||{sessions:[]};ei(eo)},ec.onerror=eo})}addParkedSharedHistory(ei,eo,ea){ea||(ea=this.db.transaction("parked_shared_history","readwrite"));let ec=ea.objectStore("parked_shared_history"),ed=ec.get([ei]);ed.onsuccess=()=>{let{parked:ea}=ed.result||{parked:[]};ea.push(eo),ec.put({roomId:ei,parked:ea})}}takeParkedSharedHistory(ei,eo){eo||(eo=this.db.transaction("parked_shared_history","readwrite"));let ea=eo.objectStore("parked_shared_history").openCursor(ei);return new Promise((ei,eo)=>{ea.onsuccess=()=>{let eo=ea.result;if(!eo){ei([]);return}let ec=eo.value;eo.delete(),ei(ec)},ea.onerror=eo})}doTxn(ei,eo,ea,ec=eu.logger){let ed,eh;if(eg){let ea=this.nextTxnId++;ed=Date.now(),eh=`${ei} crypto store transaction ${ea} in ${eo}`,ec.debug(`Starting ${eh}`)}let ef=this.db.transaction(eo,ei),ep=e_(ef),em=ea(ef);return eg&&ep.then(()=>{let ei=Date.now()-ed;ec.debug(`Finished ${eh}, took ${ei} ms`)},()=>{let ei=Date.now()-ed;ec.error(`Failed ${eh}, took ${ei} ms`)}),ep.then(()=>em)}}eo.Backend=em;let ey=[ei=>{eE(ei)},ei=>{ei.createObjectStore("account")},ei=>{let eo=ei.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});eo.createIndex("deviceKey","deviceKey")},ei=>{ei.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},ei=>{ei.createObjectStore("device_data")},ei=>{ei.createObjectStore("rooms")},ei=>{ei.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},ei=>{ei.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},ei=>{let eo=ei.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});eo.createIndex("deviceKey","deviceKey"),ei.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},ei=>{ei.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},ei=>{ei.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],eb=ey.length;function eS(ei,eo){eu.logger.log(`Upgrading IndexedDBCryptoStore from version ${eo} to ${eb}`),ey.forEach((ea,ec)=>{eo<=ec&&ea(ei)})}function eE(ei){let eo=ei.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});eo.createIndex("session",["requestBody.room_id","requestBody.session_id"]),eo.createIndex("state","state")}function ew(ei,eo){ei._mx_abortexception=eo;try{ei.abort()}catch(ei){}}function e_(ei){return new Promise((eo,ea)=>{ei.oncomplete=()=>{void 0!==ei._mx_abortexception&&ea(ei._mx_abortexception),eo(null)},ei.onerror=eo=>{void 0!==ei._mx_abortexception?ea(ei._mx_abortexception):(eu.logger.log("Error performing indexeddb txn",eo),ea(ei.error))},ei.onabort=eo=>{void 0!==ei._mx_abortexception?ea(ei._mx_abortexception):(eu.logger.log("Error performing indexeddb txn",eo),ea(ei.error))}})}eo.VERSION=eb},7585:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.IndexedDBCryptoStore=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(4250),ef=ea(1045),ep=eb(ea(4233)),eg=ea(9489),em=eb(ea(3415));function ey(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ey=function(ei){return ei?ea:eo})(ei)}function eb(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ey(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}class eS{static exists(ei,eo){return em.exists(ei,eo)}constructor(ei,eo){this.indexedDB=ei,this.dbName=eo,(0,ed.default)(this,"backendPromise",void 0),(0,ed.default)(this,"backend",void 0)}startup(){return this.backendPromise||(this.backendPromise=new Promise((ei,eo)=>{if(!this.indexedDB){eo(Error("no indexeddb support available"));return}eu.logger.log(`connecting to indexeddb ${this.dbName}`);let ea=this.indexedDB.open(this.dbName,ep.VERSION);ea.onupgradeneeded=ei=>{let eo=ea.result,ec=ei.oldVersion;ep.upgradeDatabase(eo,ec)},ea.onblocked=()=>{eu.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},ea.onerror=ei=>{eu.logger.log("Error connecting to indexeddb",ei),eo(ea.error)},ea.onsuccess=()=>{let eo=ea.result;eu.logger.log(`connected to indexeddb ${this.dbName}`),ei(new ep.Backend(eo))}}).then(ei=>ei.doTxn("readonly",[eS.STORE_INBOUND_GROUP_SESSIONS,eS.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],eo=>{ei.getEndToEndInboundGroupSession("","",eo,()=>{})}).then(()=>ei)).catch(ei=>{if("VersionError"===ei.name)throw eu.logger.warn("Crypto DB is too new for us to use!",ei),new eg.InvalidCryptoStoreError(eg.InvalidCryptoStoreState.TooNew);eu.logger.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${ei}`);try{return new eh.LocalStorageCryptoStore(ea.g.localStorage)}catch(ei){return eu.logger.warn(`unable to open localStorage: falling back to in-memory store: ${ei}`),new ef.MemoryCryptoStore}}).then(ei=>(this.backend=ei,ei))),this.backendPromise}deleteAllData(){return new Promise((ei,eo)=>{if(!this.indexedDB){eo(Error("no indexeddb support available"));return}eu.logger.log(`Removing indexeddb instance: ${this.dbName}`);let ea=this.indexedDB.deleteDatabase(this.dbName);ea.onblocked=()=>{eu.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},ea.onerror=ei=>{eu.logger.log("Error deleting data from indexeddb",ei),eo(ea.error)},ea.onsuccess=()=>{eu.logger.log(`Removed indexeddb instance: ${this.dbName}`),ei()}}).catch(ei=>{eu.logger.warn(`unable to delete IndexedDBCryptoStore: ${ei}`)})}getOrAddOutgoingRoomKeyRequest(ei){return this.backend.getOrAddOutgoingRoomKeyRequest(ei)}getOutgoingRoomKeyRequest(ei){return this.backend.getOutgoingRoomKeyRequest(ei)}getOutgoingRoomKeyRequestByState(ei){return this.backend.getOutgoingRoomKeyRequestByState(ei)}getAllOutgoingRoomKeyRequestsByState(ei){return this.backend.getAllOutgoingRoomKeyRequestsByState(ei)}getOutgoingRoomKeyRequestsByTarget(ei,eo,ea){return this.backend.getOutgoingRoomKeyRequestsByTarget(ei,eo,ea)}updateOutgoingRoomKeyRequest(ei,eo,ea){return this.backend.updateOutgoingRoomKeyRequest(ei,eo,ea)}deleteOutgoingRoomKeyRequest(ei,eo){return this.backend.deleteOutgoingRoomKeyRequest(ei,eo)}getAccount(ei,eo){this.backend.getAccount(ei,eo)}storeAccount(ei,eo){this.backend.storeAccount(ei,eo)}getCrossSigningKeys(ei,eo){this.backend.getCrossSigningKeys(ei,eo)}getSecretStorePrivateKey(ei,eo,ea){this.backend.getSecretStorePrivateKey(ei,eo,ea)}storeCrossSigningKeys(ei,eo){this.backend.storeCrossSigningKeys(ei,eo)}storeSecretStorePrivateKey(ei,eo,ea){this.backend.storeSecretStorePrivateKey(ei,eo,ea)}countEndToEndSessions(ei,eo){this.backend.countEndToEndSessions(ei,eo)}getEndToEndSession(ei,eo,ea,ec){this.backend.getEndToEndSession(ei,eo,ea,ec)}getEndToEndSessions(ei,eo,ea){this.backend.getEndToEndSessions(ei,eo,ea)}getAllEndToEndSessions(ei,eo){this.backend.getAllEndToEndSessions(ei,eo)}storeEndToEndSession(ei,eo,ea,ec){this.backend.storeEndToEndSession(ei,eo,ea,ec)}storeEndToEndSessionProblem(ei,eo,ea){return this.backend.storeEndToEndSessionProblem(ei,eo,ea)}getEndToEndSessionProblem(ei,eo){return this.backend.getEndToEndSessionProblem(ei,eo)}filterOutNotifiedErrorDevices(ei){return this.backend.filterOutNotifiedErrorDevices(ei)}getEndToEndInboundGroupSession(ei,eo,ea,ec){this.backend.getEndToEndInboundGroupSession(ei,eo,ea,ec)}getAllEndToEndInboundGroupSessions(ei,eo){this.backend.getAllEndToEndInboundGroupSessions(ei,eo)}addEndToEndInboundGroupSession(ei,eo,ea,ec){this.backend.addEndToEndInboundGroupSession(ei,eo,ea,ec)}storeEndToEndInboundGroupSession(ei,eo,ea,ec){this.backend.storeEndToEndInboundGroupSession(ei,eo,ea,ec)}storeEndToEndInboundGroupSessionWithheld(ei,eo,ea,ec){this.backend.storeEndToEndInboundGroupSessionWithheld(ei,eo,ea,ec)}storeEndToEndDeviceData(ei,eo){this.backend.storeEndToEndDeviceData(ei,eo)}getEndToEndDeviceData(ei,eo){this.backend.getEndToEndDeviceData(ei,eo)}storeEndToEndRoom(ei,eo,ea){this.backend.storeEndToEndRoom(ei,eo,ea)}getEndToEndRooms(ei,eo){this.backend.getEndToEndRooms(ei,eo)}getSessionsNeedingBackup(ei){return this.backend.getSessionsNeedingBackup(ei)}countSessionsNeedingBackup(ei){return this.backend.countSessionsNeedingBackup(ei)}unmarkSessionsNeedingBackup(ei,eo){return this.backend.unmarkSessionsNeedingBackup(ei,eo)}markSessionsNeedingBackup(ei,eo){return this.backend.markSessionsNeedingBackup(ei,eo)}addSharedHistoryInboundGroupSession(ei,eo,ea,ec){this.backend.addSharedHistoryInboundGroupSession(ei,eo,ea,ec)}getSharedHistoryInboundGroupSessions(ei,eo){return this.backend.getSharedHistoryInboundGroupSessions(ei,eo)}addParkedSharedHistory(ei,eo,ea){this.backend.addParkedSharedHistory(ei,eo,ea)}takeParkedSharedHistory(ei,eo){return this.backend.takeParkedSharedHistory(ei,eo)}doTxn(ei,eo,ea,ec){return this.backend.doTxn(ei,eo,ea,ec)}}eo.IndexedDBCryptoStore=eS,(0,ed.default)(eS,"STORE_ACCOUNT","account"),(0,ed.default)(eS,"STORE_SESSIONS","sessions"),(0,ed.default)(eS,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,ed.default)(eS,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,ed.default)(eS,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,ed.default)(eS,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),(0,ed.default)(eS,"STORE_DEVICE_DATA","device_data"),(0,ed.default)(eS,"STORE_ROOMS","rooms"),(0,ed.default)(eS,"STORE_BACKUP","sessions_needing_backup")},4250:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.LocalStorageCryptoStore=void 0;var ec=ea(7434),ed=ea(1045),eu=ea(3102);let eh="crypto.",ef=eh+"account",ep=eh+"cross_signing_keys",eg=eh+"notified_error_devices",em=eh+"device_data",ey=eh+"inboundgroupsessions/",eb=eh+"inboundgroupsessions.withheld/",eS=eh+"rooms/",eE=eh+"sessionsneedingbackup";function ew(ei){return eh+"sessions/"+ei}function e_(ei){return eh+"session.problems/"+ei}function eT(ei,eo){return ey+ei+"/"+eo}function eI(ei,eo){return eb+ei+"/"+eo}function eC(ei){return eS+ei}class eO extends ed.MemoryCryptoStore{static exists(ei){let eo=ei.length;for(let ec=0;ec<eo;ec++){var ea;if(null!==(ea=ei.key(ec))&&void 0!==ea&&ea.startsWith(eh))return!0}return!1}constructor(ei){super(),this.store=ei}countEndToEndSessions(ei,eo){let ea=0;for(let ei=0;ei<this.store.length;++ei){var ec;null!==(ec=this.store.key(ei))&&void 0!==ec&&ec.startsWith(ew(""))&&++ea}eo(ea)}_getEndToEndSessions(ei){let eo=eR(this.store,ew(ei)),ea={};for(let[ei,ec]of Object.entries(eo||{}))"string"==typeof ec?ea[ei]={session:ec}:ea[ei]=ec;return ea}getEndToEndSession(ei,eo,ea,ec){let ed=this._getEndToEndSessions(ei);ec(ed[eo]||{})}getEndToEndSessions(ei,eo,ea){ea(this._getEndToEndSessions(ei)||{})}getAllEndToEndSessions(ei,eo){for(let ei=0;ei<this.store.length;++ei){var ea;if(null!==(ea=this.store.key(ei))&&void 0!==ea&&ea.startsWith(ew(""))){let ea=this.store.key(ei).split("/")[1];for(let ei of Object.values(this._getEndToEndSessions(ea)))eo(ei)}}}storeEndToEndSession(ei,eo,ea,ec){let ed=this._getEndToEndSessions(ei)||{};ed[eo]=ea,ek(this.store,ew(ei),ed)}async storeEndToEndSessionProblem(ei,eo,ea){let ec=e_(ei),ed=eR(this.store,ec)||[];ed.push({type:eo,fixed:ea,time:Date.now()}),ed.sort((ei,eo)=>ei.time-eo.time),ek(this.store,ec,ed)}async getEndToEndSessionProblem(ei,eo){let ea=e_(ei),ec=eR(this.store,ea)||[];if(!ec.length)return null;let ed=ec[ec.length-1];for(let ei of ec)if(ei.time>eo)return Object.assign({},ei,{fixed:ed.fixed});return ed.fixed?null:ed}async filterOutNotifiedErrorDevices(ei){let eo=eR(this.store,eg)||{},ea=[];for(let ec of ei){let{userId:ei,deviceInfo:ed}=ec;ei in eo?ed.deviceId in eo[ei]||(ea.push(ec),(0,eu.safeSet)(eo[ei],ed.deviceId,!0)):(ea.push(ec),(0,eu.safeSet)(eo,ei,{[ed.deviceId]:!0}))}return ek(this.store,eg,eo),ea}getEndToEndInboundGroupSession(ei,eo,ea,ec){ec(eR(this.store,eT(ei,eo)),eR(this.store,eI(ei,eo)))}getAllEndToEndInboundGroupSessions(ei,eo){for(let ei=0;ei<this.store.length;++ei){let ea=this.store.key(ei);null!=ea&&ea.startsWith(ey)&&eo({senderKey:ea.slice(ey.length,ey.length+43),sessionId:ea.slice(ey.length+44),sessionData:eR(this.store,ea)})}eo(null)}addEndToEndInboundGroupSession(ei,eo,ea,ec){let ed=eR(this.store,eT(ei,eo));ed||this.storeEndToEndInboundGroupSession(ei,eo,ea,ec)}storeEndToEndInboundGroupSession(ei,eo,ea,ec){ek(this.store,eT(ei,eo),ea)}storeEndToEndInboundGroupSessionWithheld(ei,eo,ea,ec){ek(this.store,eI(ei,eo),ea)}getEndToEndDeviceData(ei,eo){eo(eR(this.store,em))}storeEndToEndDeviceData(ei,eo){ek(this.store,em,ei)}storeEndToEndRoom(ei,eo,ea){ek(this.store,eC(ei),eo)}getEndToEndRooms(ei,eo){let ea={},ec=eC("");for(let ei=0;ei<this.store.length;++ei){let eo=this.store.key(ei);if(null!=eo&&eo.startsWith(ec)){let ei=eo.slice(ec.length);ea[ei]=eR(this.store,eo)}}eo(ea)}getSessionsNeedingBackup(ei){let eo=eR(this.store,eE)||{},ea=[];for(let ec in eo)if(Object.prototype.hasOwnProperty.call(eo,ec)){let eo=ec.slice(0,43),ed=ec.slice(44);if(this.getEndToEndInboundGroupSession(eo,ed,null,ei=>{ea.push({senderKey:eo,sessionId:ed,sessionData:ei})}),ei&&ea.length>=ei)break}return Promise.resolve(ea)}countSessionsNeedingBackup(){let ei=eR(this.store,eE)||{};return Promise.resolve(Object.keys(ei).length)}unmarkSessionsNeedingBackup(ei){let eo=eR(this.store,eE)||{};for(let ea of ei)delete eo[ea.senderKey+"/"+ea.sessionId];return ek(this.store,eE,eo),Promise.resolve()}markSessionsNeedingBackup(ei){let eo=eR(this.store,eE)||{};for(let ea of ei)eo[ea.senderKey+"/"+ea.sessionId]=!0;return ek(this.store,eE,eo),Promise.resolve()}deleteAllData(){return this.store.removeItem(ef),Promise.resolve()}getAccount(ei,eo){let ea=eR(this.store,ef);eo(ea)}storeAccount(ei,eo){ek(this.store,ef,eo)}getCrossSigningKeys(ei,eo){let ea=eR(this.store,ep);eo(ea)}getSecretStorePrivateKey(ei,eo,ea){let ec=eR(this.store,eh+`ssss_cache.${ea}`);eo(ec)}storeCrossSigningKeys(ei,eo){ek(this.store,ep,eo)}storeSecretStorePrivateKey(ei,eo,ea){ek(this.store,eh+`ssss_cache.${eo}`,ea)}doTxn(ei,eo,ea){return Promise.resolve(ea(null))}}function eR(ei,eo){try{return JSON.parse(ei.getItem(eo))}catch(ei){ec.logger.log("Error: Failed to get key %s: %s",eo,ei.message),ec.logger.log(ei.stack)}return null}function ek(ei,eo,ea){ei.setItem(eo,JSON.stringify(ea))}eo.LocalStorageCryptoStore=eO},1045:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MemoryCryptoStore=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ep(ea(3102));function ef(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ef=function(ei){return ei?ea:eo})(ei)}function ep(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ef(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function eg(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function em(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eg(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eg(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}class ey{constructor(){(0,ed.default)(this,"outgoingRoomKeyRequests",[]),(0,ed.default)(this,"account",null),(0,ed.default)(this,"crossSigningKeys",null),(0,ed.default)(this,"privateKeys",{}),(0,ed.default)(this,"sessions",{}),(0,ed.default)(this,"sessionProblems",{}),(0,ed.default)(this,"notifiedErrorDevices",{}),(0,ed.default)(this,"inboundGroupSessions",{}),(0,ed.default)(this,"inboundGroupSessionsWithheld",{}),(0,ed.default)(this,"deviceData",null),(0,ed.default)(this,"rooms",{}),(0,ed.default)(this,"sessionsNeedingBackup",{}),(0,ed.default)(this,"sharedHistoryInboundGroupSessions",{}),(0,ed.default)(this,"parkedSharedHistory",new Map)}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(ei){let eo=ei.requestBody;return eh.promiseTry(()=>{let ea=this._getOutgoingRoomKeyRequest(eo);return ea?(eu.logger.log(`already have key request outstanding for ${eo.room_id} / ${eo.session_id}: not sending another`),ea):(eu.logger.log(`enqueueing key request for ${eo.room_id} / `+eo.session_id),this.outgoingRoomKeyRequests.push(ei),ei)})}getOutgoingRoomKeyRequest(ei){return Promise.resolve(this._getOutgoingRoomKeyRequest(ei))}_getOutgoingRoomKeyRequest(ei){for(let eo of this.outgoingRoomKeyRequests)if(eh.deepCompare(eo.requestBody,ei))return eo;return null}getOutgoingRoomKeyRequestByState(ei){for(let eo of this.outgoingRoomKeyRequests)for(let ea of ei)if(eo.state===ea)return Promise.resolve(eo);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(ei){return Promise.resolve(this.outgoingRoomKeyRequests.filter(eo=>eo.state==ei))}getOutgoingRoomKeyRequestsByTarget(ei,eo,ea){let ec=[];for(let ed of this.outgoingRoomKeyRequests)for(let eu of ea)ed.state===eu&&ed.recipients.some(ea=>ea.userId===ei&&ea.deviceId===eo)&&ec.push(ed);return Promise.resolve(ec)}updateOutgoingRoomKeyRequest(ei,eo,ea){for(let ec of this.outgoingRoomKeyRequests)if(ec.requestId===ei){if(ec.state!==eo){eu.logger.warn(`Cannot update room key request from ${eo} as it was already updated to ${ec.state}`);break}return Object.assign(ec,ea),Promise.resolve(ec)}return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(ei,eo){for(let ea=0;ea<this.outgoingRoomKeyRequests.length;ea++){let ec=this.outgoingRoomKeyRequests[ea];if(ec.requestId===ei){if(ec.state!=eo){eu.logger.warn(`Cannot delete room key request in state ${ec.state} (expected ${eo})`);break}return this.outgoingRoomKeyRequests.splice(ea,1),Promise.resolve(ec)}}return Promise.resolve(null)}getAccount(ei,eo){eo(this.account)}storeAccount(ei,eo){this.account=eo}getCrossSigningKeys(ei,eo){eo(this.crossSigningKeys)}getSecretStorePrivateKey(ei,eo,ea){let ec=this.privateKeys[ea];eo(ec||null)}storeCrossSigningKeys(ei,eo){this.crossSigningKeys=eo}storeSecretStorePrivateKey(ei,eo,ea){this.privateKeys[eo]=ea}countEndToEndSessions(ei,eo){eo(Object.keys(this.sessions).length)}getEndToEndSession(ei,eo,ea,ec){let ed=this.sessions[ei]||{};ec(ed[eo]||null)}getEndToEndSessions(ei,eo,ea){ea(this.sessions[ei]||{})}getAllEndToEndSessions(ei,eo){Object.entries(this.sessions).forEach(([ei,ea])=>{Object.entries(ea).forEach(([ea,ec])=>{eo(em(em({},ec),{},{deviceKey:ei,sessionId:ea}))})})}storeEndToEndSession(ei,eo,ea,ec){let ed=this.sessions[ei];void 0===ed&&(ed={},this.sessions[ei]=ed),(0,eh.safeSet)(ed,eo,ea)}async storeEndToEndSessionProblem(ei,eo,ea){let ec=this.sessionProblems[ei]=this.sessionProblems[ei]||[];ec.push({type:eo,fixed:ea,time:Date.now()}),ec.sort((ei,eo)=>ei.time-eo.time)}async getEndToEndSessionProblem(ei,eo){let ea=this.sessionProblems[ei]||[];if(!ea.length)return null;let ec=ea[ea.length-1];for(let ei of ea)if(ei.time>eo)return Object.assign({},ei,{fixed:ec.fixed});return ec.fixed?null:ec}async filterOutNotifiedErrorDevices(ei){let eo=this.notifiedErrorDevices,ea=[];for(let ec of ei){let{userId:ei,deviceInfo:ed}=ec;ei in eo?ed.deviceId in eo[ei]||(ea.push(ec),(0,eh.safeSet)(eo[ei],ed.deviceId,!0)):(ea.push(ec),(0,eh.safeSet)(eo,ei,{[ed.deviceId]:!0}))}return ea}getEndToEndInboundGroupSession(ei,eo,ea,ec){let ed=ei+"/"+eo;ec(this.inboundGroupSessions[ed]||null,this.inboundGroupSessionsWithheld[ed]||null)}getAllEndToEndInboundGroupSessions(ei,eo){for(let ei of Object.keys(this.inboundGroupSessions))eo({senderKey:ei.slice(0,43),sessionId:ei.slice(44),sessionData:this.inboundGroupSessions[ei]});eo(null)}addEndToEndInboundGroupSession(ei,eo,ea,ec){let ed=ei+"/"+eo;void 0===this.inboundGroupSessions[ed]&&(this.inboundGroupSessions[ed]=ea)}storeEndToEndInboundGroupSession(ei,eo,ea,ec){this.inboundGroupSessions[ei+"/"+eo]=ea}storeEndToEndInboundGroupSessionWithheld(ei,eo,ea,ec){let ed=ei+"/"+eo;this.inboundGroupSessionsWithheld[ed]=ea}getEndToEndDeviceData(ei,eo){eo(this.deviceData)}storeEndToEndDeviceData(ei,eo){this.deviceData=ei}storeEndToEndRoom(ei,eo,ea){this.rooms[ei]=eo}getEndToEndRooms(ei,eo){eo(this.rooms)}getSessionsNeedingBackup(ei){let eo=[];for(let ea in this.sessionsNeedingBackup)if(this.inboundGroupSessions[ea]&&(eo.push({senderKey:ea.slice(0,43),sessionId:ea.slice(44),sessionData:this.inboundGroupSessions[ea]}),ei&&ea.length>=ei))break;return Promise.resolve(eo)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(ei){for(let eo of ei){let ei=eo.senderKey+"/"+eo.sessionId;delete this.sessionsNeedingBackup[ei]}return Promise.resolve()}markSessionsNeedingBackup(ei){for(let eo of ei){let ei=eo.senderKey+"/"+eo.sessionId;this.sessionsNeedingBackup[ei]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(ei,eo,ea){let ec=this.sharedHistoryInboundGroupSessions[ei]||[];ec.push([eo,ea]),this.sharedHistoryInboundGroupSessions[ei]=ec}getSharedHistoryInboundGroupSessions(ei){return Promise.resolve(this.sharedHistoryInboundGroupSessions[ei]||[])}addParkedSharedHistory(ei,eo){var ea;let ec=null!==(ea=this.parkedSharedHistory.get(ei))&&void 0!==ea?ea:[];ec.push(eo),this.parkedSharedHistory.set(ei,ec)}takeParkedSharedHistory(ei){var eo;let ea=null!==(eo=this.parkedSharedHistory.get(ei))&&void 0!==eo?eo:[];return this.parkedSharedHistory.delete(ei),Promise.resolve(ea)}doTxn(ei,eo,ea){return Promise.resolve(ea(null))}}eo.MemoryCryptoStore=ey},1631:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.VerificationEvent=eo.VerificationBase=eo.SwitchStartEventError=void 0;var ed=ec(ea(8416)),eu=ea(4369),eh=ea(2481),ef=ea(7434),ep=ea(3272),eg=ea(6702),em=ea(3075),ey=ea(5861);let eb=Error("Verification timed out");class eS extends Error{constructor(ei){super(),this.startEvent=ei}}eo.SwitchStartEventError=eS;let eE=function(ei){return ei.Cancel="cancel",ei}({});eo.VerificationEvent=eE;class ew extends ey.TypedEventEmitter{constructor(ei,eo,ea,ec,eu,eh){super(),this.channel=ei,this.baseApis=eo,this.userId=ea,this.deviceId=ec,this.startEvent=eu,this.request=eh,(0,ed.default)(this,"cancelled",!1),(0,ed.default)(this,"_done",!1),(0,ed.default)(this,"promise",null),(0,ed.default)(this,"transactionTimeoutTimer",null),(0,ed.default)(this,"expectedEvent",void 0),(0,ed.default)(this,"resolve",void 0),(0,ed.default)(this,"reject",void 0),(0,ed.default)(this,"resolveEvent",void 0),(0,ed.default)(this,"rejectEvent",void 0),(0,ed.default)(this,"started",void 0),(0,ed.default)(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;let ei=this.startEvent.getSender(),eo=this.startEvent.getContent();return ei===this.baseApis.getUserId()&&eo.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){ef.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(ef.logger.info("Triggering verification timeout"),this.cancel(eb))},6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(ei,eo){return this.channel.send(ei,eo)}waitForEvent(ei){if(this._done)return Promise.reject(Error("Verification is already done"));let eo=this.request.getEventFromOtherParty(ei);return eo?Promise.resolve(eo):(this.expectedEvent=ei,new Promise((ei,eo)=>{this.resolveEvent=ei,this.rejectEvent=eo}))}canSwitchStartEvent(ei){return!1}switchStartEvent(ei){if(this.canSwitchStartEvent(ei)){if(ef.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){let eo=this.rejectEvent;this.rejectEvent=void 0,eo(new eS(ei))}else this.startEvent=ei}}handleEvent(ei){if(!this._done){if(ei.getType()===this.expectedEvent){if(this.expectedEvent!==eh.EventType.KeyVerificationDone){var eo;this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),null===(eo=this.resolveEvent)||void 0===eo||eo.call(this,ei)}}else if(ei.getType()===eh.EventType.KeyVerificationCancel){let eo=this.reject;if(this.reject=void 0,eo){let ea=ei.getContent(),{reason:ec,code:ed}=ea;eo(Error(`Other side cancelled verification because ${ec} (${ed})`))}}else if(this.expectedEvent){let eo=Error("Unexpected message: expecting "+this.expectedEvent+" but got "+ei.getType());if(this.expectedEvent=void 0,this.rejectEvent){let ei=this.rejectEvent;this.rejectEvent=void 0,ei(eo)}this.cancel(eo)}}}async done(){if(this.endTimer(),!this._done){var ei;return this.request.onVerifierFinished(),null===(ei=this.resolve)||void 0===ei||ei.call(this),(0,em.requestKeysDuringVerification)(this.baseApis,this.userId,this.deviceId)}}cancel(ei){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId){if(ei===eb){let ei=(0,eg.newTimeoutError)();this.send(ei.getType(),ei.getContent())}else if(ei instanceof eu.MatrixEvent){let eo=ei.getSender();if(eo!==this.userId){let eo=ei.getContent();ei.getType()===eh.EventType.KeyVerificationCancel?(eo.code=eo.code||"m.unknown",eo.reason=eo.reason||eo.body||"Unknown reason",this.send(eh.EventType.KeyVerificationCancel,eo)):this.send(eh.EventType.KeyVerificationCancel,{code:"m.unknown",reason:eo.body||"Unknown reason"})}}else this.send(eh.EventType.KeyVerificationCancel,{code:"m.unknown",reason:ei.toString()})}null!==this.promise?this.reject&&this.reject(ei):this.promise=Promise.reject(ei),this.emit(eE.Cancel,ei)}}verify(){return this.promise||(this.promise=new Promise((ei,eo)=>{this.resolve=(...eo)=>{this._done=!0,this.endTimer(),ei(...eo)},this.reject=ei=>{this._done=!0,this.endTimer(),eo(ei)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise((ei,eo)=>{var ea;let ec=null===(ea=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))||void 0===ea?void 0:ea.getId();ec===this.deviceId&&eo(Error("Device ID is the same as the cross-signing ID")),ei()}).then(()=>this.doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(ei,eo,ea){let ec=[];for(let[ed,eu]of Object.entries(eo)){let eo=ed.split(":",2)[1],eh=this.baseApis.getStoredDevice(ei,eo);if(eh)ea(ed,eh,eu),ec.push([eo,ed,eh.keys[ed]]);else{let eh=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(ei);eh&&eh.getId()===eo?(ea(ed,ep.DeviceInfo.fromStorage({keys:{[ed]:eo}},eo),eu),ec.push([eo,ed,eo])):ef.logger.warn(`verification: Could not find device ${eo} to verify`)}}if(!ec.length)throw Error("No devices could be verified");for(let[eo,ea,ed]of(ef.logger.info("Verification completed! Marking devices verified: ",ec),ec))await this.baseApis.crypto.setDeviceVerification(ei,eo,!0,null,null,{[ea]:ed});ei==this.baseApis.credentials.userId&&await this.baseApis.checkKeyBackup()}get events(){}}eo.VerificationBase=ew},6702:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.errorFactory=eh,eo.errorFromEvent=eS,eo.newUserCancelledError=eo.newUnknownMethodError=eo.newUnexpectedMessageError=eo.newTimeoutError=eo.newKeyMismatchError=eo.newInvalidMessageError=void 0,eo.newVerificationError=eu;var ec=ea(4369),ed=ea(2481);function eu(ei,eo,ea){let eu=Object.assign({},{code:ei,reason:eo},ea);return new ec.MatrixEvent({type:ed.EventType.KeyVerificationCancel,content:eu})}function eh(ei,eo){return function(ea){return eu(ei,eo,ea)}}let ef=eh("m.user","Cancelled by user");eo.newUserCancelledError=ef;let ep=eh("m.timeout","Timed out");eo.newTimeoutError=ep;let eg=eh("m.unknown_method","Unknown method");eo.newUnknownMethodError=eg;let em=eh("m.unexpected_message","Unexpected message");eo.newUnexpectedMessageError=em;let ey=eh("m.key_mismatch","Key mismatch");eo.newKeyMismatchError=ey;let eb=eh("m.invalid_message","Invalid message");function eS(ei){let eo=ei.getContent();if(!eo)return{code:"Unknown error",reason:"m.unknown"};{let{code:ei,reason:ea}=eo;return{code:ei,reason:ea}}}eo.newInvalidMessageError=eb},4028:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.IllegalMethod=void 0;var ed=ec(ea(8416)),eu=ea(1631);class eh extends eu.VerificationBase{constructor(...ei){super(...ei),(0,ed.default)(this,"doVerification",async()=>{throw Error("Verification is not possible with this method")})}static factory(ei,eo,ea,ec,ed,eu){return new eh(ei,eo,ea,ec,ed,eu)}static get NAME(){return"org.matrix.illegal_method"}}eo.IllegalMethod=eh},1696:function(ei,eo,ea){"use strict";var ec=ea(8764).Buffer,ed=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SHOW_QR_CODE_METHOD=eo.SCAN_QR_CODE_METHOD=eo.ReciprocateQRCode=eo.QrCodeEvent=eo.QRCodeData=void 0;var eu=ed(ea(8416)),eh=ea(1631),ef=ea(6702),ep=ea(2772),eg=ea(7434);let em="m.qr_code.show.v1";eo.SHOW_QR_CODE_METHOD=em;let ey="m.qr_code.scan.v1";eo.SCAN_QR_CODE_METHOD=ey;let eb=function(ei){return ei.ShowReciprocateQr="show_reciprocate_qr",ei}({});eo.QrCodeEvent=eb;class eS extends eh.VerificationBase{constructor(...ei){super(...ei),(0,eu.default)(this,"reciprocateQREvent",void 0),(0,eu.default)(this,"doVerification",async()=>{if(!this.startEvent)throw Error("It is not currently possible to start verificationwith this method yet.");let{qrCodeData:ei}=this.request;if(this.startEvent.getContent().secret!==(null==ei?void 0:ei.encodedSharedSecret))throw(0,ef.newKeyMismatchError)();await new Promise((ei,eo)=>{this.reciprocateQREvent={confirm:ei,cancel:()=>eo((0,ef.newUserCancelledError)())},this.emit(eb.ShowReciprocateQr,this.reciprocateQREvent)});let eo={};switch(null==ei?void 0:ei.mode){case e_.VerifyOtherUser:{let ea=ei.otherUserMasterKey;eo[`ed25519:${ea}`]=ea;break}case e_.VerifySelfTrusted:{let ea=this.request.targetDevice.deviceId;eo[`ed25519:${ea}`]=ei.otherDeviceKey;break}case e_.VerifySelfUntrusted:{let ea=ei.myMasterKey;eo[`ed25519:${ea}`]=ea}}await this.verifyKeys(this.userId,eo,(ei,ea,ec)=>{let ed=eo[ei];if(!ed)throw(0,ef.newKeyMismatchError)();if(ec!==ed)throw eg.logger.error("key ID from key info does not match"),(0,ef.newKeyMismatchError)();for(let ei in ea.keys){if(!ei.startsWith("ed25519"))continue;let ec=eo[ei];if(!ec)throw(0,ef.newKeyMismatchError)();if(ea.keys[ei]!==ec)throw eg.logger.error("master key does not match"),(0,ef.newKeyMismatchError)()}})})}static factory(ei,eo,ea,ec,ed,eu){return new eS(ei,eo,ea,ec,ed,eu)}static get NAME(){return"m.reciprocate.v1"}}eo.ReciprocateQRCode=eS;let eE=2,ew="MATRIX";var e_=function(ei){return ei[ei.VerifyOtherUser=0]="VerifyOtherUser",ei[ei.VerifySelfTrusted=1]="VerifySelfTrusted",ei[ei.VerifySelfUntrusted=2]="VerifySelfUntrusted",ei}(e_||{});class eT{constructor(ei,eo,ea,ec,ed,eu){this.mode=ei,this.sharedSecret=eo,this.otherUserMasterKey=ea,this.otherDeviceKey=ec,this.myMasterKey=ed,this.buffer=eu}static async create(ei,eo){let ea=eT.generateSharedSecret(),ec=eT.determineMode(ei,eo),ed=null,eu=null,eh=null;if(ec===e_.VerifyOtherUser){let ea=eo.getStoredCrossSigningForUser(ei.otherUserId);ed=ea.getId("master")}else if(ec===e_.VerifySelfTrusted)eu=await eT.getOtherDeviceKey(ei,eo);else if(ec===e_.VerifySelfUntrusted){let ei=eo.getUserId(),ea=eo.getStoredCrossSigningForUser(ei);eh=ea.getId("master")}let ef=eT.generateQrData(ei,eo,ec,ea,ed,eu,eh),ep=eT.generateBuffer(ef);return new eT(ec,ea,ed,eu,eh,ep)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){let ei=new Uint8Array(11);return ea.g.crypto.getRandomValues(ei),(0,ep.encodeUnpaddedBase64)(ei)}static async getOtherDeviceKey(ei,eo){let ea=eo.getUserId(),ec=ei.targetDevice,ed=ec.deviceId?eo.getStoredDevice(ea,ec.deviceId):void 0;if(!ed)throw Error("could not find device "+(null==ec?void 0:ec.deviceId));return ed.getFingerprint()}static determineMode(ei,eo){let ea=eo.getUserId(),ec=ei.otherUserId,ed=e_.VerifyOtherUser;if(ea===ec){let ei=eo.checkUserTrust(ea);ed=ei.isCrossSigningVerified()?e_.VerifySelfTrusted:e_.VerifySelfUntrusted}return ed}static generateQrData(ei,eo,ea,ec,ed,eu,eh){let ef=eo.getUserId(),ep=ei.channel.transactionId,eg={prefix:ew,version:eE,mode:ea,transactionId:ep,firstKeyB64:"",secondKeyB64:"",secretB64:ec},em=eo.getStoredCrossSigningForUser(ef);return ea===e_.VerifyOtherUser?(eg.firstKeyB64=em.getId("master"),eg.secondKeyB64=ed):ea===e_.VerifySelfTrusted?(eg.firstKeyB64=em.getId("master"),eg.secondKeyB64=eu):ea===e_.VerifySelfUntrusted&&(eg.firstKeyB64=eo.getDeviceEd25519Key(),eg.secondKeyB64=eh),eg}static generateBuffer(ei){let eo=ec.alloc(0),ea=ei=>{let ea=ec.from([ei]);eo=ec.concat([eo,ea])},ed=ei=>{let ea=ec.alloc(2);ea.writeInt16BE(ei,0),eo=ec.concat([eo,ea])},eu=(ei,ea,eu=!0)=>{let eh=ec.from(ei,ea);eu&&ed(eh.byteLength),eo=ec.concat([eo,eh])},eh=ei=>{let ea=(0,ep.decodeBase64)(ei),ed=ec.from(ea);eo=ec.concat([eo,ed])};return eu(ei.prefix,"ascii",!1),ea(ei.version),ea(ei.mode),eu(ei.transactionId,"utf-8"),eh(ei.firstKeyB64),eh(ei.secondKeyB64),eh(ei.secretB64),eo}}eo.QRCodeData=eT},6381:function(ei,eo,ea){"use strict";let ec;var ed=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SasEvent=eo.SAS=void 0;var eu=ed(ea(8416)),eh=ed(ea(9141)),ef=ea(1631),ep=ea(6702),eg=ea(7434),em=ea(1649),ey=ea(2481);let eb=ey.EventType.KeyVerificationStart,eS=[ey.EventType.KeyVerificationAccept,ey.EventType.KeyVerificationKey,ey.EventType.KeyVerificationMac],eE=(0,ep.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),ew=(0,ep.errorFactory)("m.mismatched_commitment","Mismatched commitment"),e_=[["\uD83D\uDC36","dog"],["\uD83D\uDC31","cat"],["\uD83E\uDD81","lion"],["\uD83D\uDC0E","horse"],["\uD83E\uDD84","unicorn"],["\uD83D\uDC37","pig"],["\uD83D\uDC18","elephant"],["\uD83D\uDC30","rabbit"],["\uD83D\uDC3C","panda"],["\uD83D\uDC13","rooster"],["\uD83D\uDC27","penguin"],["\uD83D\uDC22","turtle"],["\uD83D\uDC1F","fish"],["\uD83D\uDC19","octopus"],["\uD83E\uDD8B","butterfly"],["\uD83C\uDF37","flower"],["\uD83C\uDF33","tree"],["\uD83C\uDF35","cactus"],["\uD83C\uDF44","mushroom"],["\uD83C\uDF0F","globe"],["\uD83C\uDF19","moon"],["","cloud"],["\uD83D\uDD25","fire"],["\uD83C\uDF4C","banana"],["\uD83C\uDF4E","apple"],["\uD83C\uDF53","strawberry"],["\uD83C\uDF3D","corn"],["\uD83C\uDF55","pizza"],["\uD83C\uDF82","cake"],["","heart"],["\uD83D\uDE42","smiley"],["\uD83E\uDD16","robot"],["\uD83C\uDFA9","hat"],["\uD83D\uDC53","glasses"],["\uD83D\uDD27","spanner"],["\uD83C\uDF85","santa"],["\uD83D\uDC4D","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["\uD83C\uDF81","gift"],["\uD83D\uDCA1","light bulb"],["\uD83D\uDCD5","book"],["","pencil"],["\uD83D\uDCCE","paperclip"],["","scissors"],["\uD83D\uDD12","lock"],["\uD83D\uDD11","key"],["\uD83D\uDD28","hammer"],["","telephone"],["\uD83C\uDFC1","flag"],["\uD83D\uDE82","train"],["\uD83D\uDEB2","bicycle"],["","aeroplane"],["\uD83D\uDE80","rocket"],["\uD83C\uDFC6","trophy"],["","ball"],["\uD83C\uDFB8","guitar"],["\uD83C\uDFBA","trumpet"],["\uD83D\uDD14","bell"],["","anchor"],["\uD83C\uDFA7","headphones"],["\uD83D\uDCC1","folder"],["\uD83D\uDCCC","pin"]];function eT(ei){let eo=[ei[0]>>2,(3&ei[0])<<4|ei[1]>>4,(15&ei[1])<<2|ei[2]>>6,63&ei[2],ei[3]>>2,(3&ei[3])<<4|ei[4]>>4,(15&ei[4])<<2|ei[5]>>6];return eo.map(ei=>e_[ei])}let eI={decimal:em.generateDecimalSas,emoji:eT};function eC(ei,eo){let ea={};for(let ec of eo)ec in eI&&(ea[ec]=eI[ec](Array.from(ei)));return ea}let eO={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function eR(ei,eo){return function(ea,ec){let ed=ei[eO[eo]](ea,ec);return eg.logger.log("SAS calculateMAC:",eo,[ea,ec],ed),ed}}let ek={"curve25519-hkdf-sha256":function(ei,eo,ea){let ec=`${ei.baseApis.getUserId()}|${ei.baseApis.deviceId}|${ei.ourSASPubKey}|`,ed=`${ei.userId}|${ei.deviceId}|${ei.theirSASPubKey}|`,eu="MATRIX_KEY_VERIFICATION_SAS|"+(ei.initiatedByMe?ec+ed:ed+ec)+ei.channel.transactionId;return eo.generate_bytes(eu,ea)},curve25519:function(ei,eo,ea){let ec=`${ei.baseApis.getUserId()}${ei.baseApis.deviceId}`,ed=`${ei.userId}${ei.deviceId}`,eu="MATRIX_KEY_VERIFICATION_SAS"+(ei.initiatedByMe?ec+ed:ed+ec)+ei.channel.transactionId;return eo.generate_bytes(eu,ea)}},eM=["curve25519-hkdf-sha256","curve25519"],eP=["sha256"],eA=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],eD=Object.keys(eI),ej=new Set(eM),eL=new Set(eP),eN=new Set(eA),eU=new Set(eD);function eB(ei,eo){return Array.isArray(ei)?ei.filter(ei=>eo.has(ei)):[]}let eF=function(ei){return ei.ShowSas="show_sas",ei}({});eo.SasEvent=eF;class eK extends ef.VerificationBase{constructor(...ei){super(...ei),(0,eu.default)(this,"waitingForAccept",void 0),(0,eu.default)(this,"ourSASPubKey",void 0),(0,eu.default)(this,"theirSASPubKey",void 0),(0,eu.default)(this,"sasEvent",void 0),(0,eu.default)(this,"doVerification",async()=>{await ea.g.Olm.init(),ec=ec||new ea.g.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let ei=!1;do try{if(this.initiatedByMe)return await this.doSendVerification();return await this.doRespondVerification()}catch(eo){if(eo instanceof ef.SwitchStartEventError)this.startEvent=eo.startEvent,ei=!0;else throw eo}while(ei)})}static get NAME(){return"m.sas.v1"}get events(){return eS}canSwitchStartEvent(ei){if(ei.getType()!==eb)return!1;let eo=ei.getContent();return(null==eo?void 0:eo.method)===eK.NAME&&!!this.waitingForAccept}async sendStart(){let ei=this.channel.completeContent(eb,{method:eK.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:eM,hashes:eP,message_authentication_codes:eA,short_authentication_string:eD});return await this.channel.sendCompleted(eb,ei),ei}async verifyAndCheckMAC(ei,eo,ea,ec){let ed=ek[ei](this,ea,6),eu=new Promise((ei,eu)=>{this.sasEvent={sas:eC(ed,eo),confirm:async()=>{try{await this.sendMAC(ea,ec),ei()}catch(ei){eu(ei)}},cancel:()=>eu((0,ep.newUserCancelledError)()),mismatch:()=>eu(eE())},this.emit(eF.ShowSas,this.sasEvent)}),[eh]=await Promise.all([this.waitForEvent(ey.EventType.KeyVerificationMac).then(ei=>(this.expectedEvent=ey.EventType.KeyVerificationDone,ei)),eu]),ef=eh.getContent();await this.checkMAC(ea,ef,ec)}async doSendVerification(){let ei,eo;if(this.waitingForAccept=!0,ei=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new ef.SwitchStartEventError(this.startEvent);try{eo=await this.waitForEvent(ey.EventType.KeyVerificationAccept)}finally{this.waitingForAccept=!1}let ed=eo.getContent(),eu=eB(ed.short_authentication_string,eU);if(!(ej.has(ed.key_agreement_protocol)&&eL.has(ed.hash)&&eN.has(ed.message_authentication_code)&&eu.length))throw(0,ep.newUnknownMethodError)();if("string"!=typeof ed.commitment)throw(0,ep.newInvalidMessageError)();let eg=ed.key_agreement_protocol,em=ed.message_authentication_code,eb=ed.commitment,eS=new ea.g.Olm.SAS;try{this.ourSASPubKey=eS.get_pubkey(),await this.send(ey.EventType.KeyVerificationKey,{key:this.ourSASPubKey}),ed=(eo=await this.waitForEvent(ey.EventType.KeyVerificationKey)).getContent();let ea=ed.key+eh.default.stringify(ei);if(ec.sha256(ea)!==eb)throw ew();this.theirSASPubKey=ed.key,eS.set_their_key(ed.key),await this.verifyAndCheckMAC(eg,eu,eS,em)}finally{eS.free()}}async doRespondVerification(){let ei=this.channel.completedContentFromEvent(this.startEvent),eo=eB(eM,new Set(ei.key_agreement_protocols))[0],ed=eB(eP,new Set(ei.hashes))[0],eu=eB(eA,new Set(ei.message_authentication_codes))[0],ef=eB(ei.short_authentication_string,eU);if(!(void 0!==eo&&void 0!==ed&&void 0!==eu&&ef.length))throw(0,ep.newUnknownMethodError)();let eg=new ea.g.Olm.SAS;try{let ea=eg.get_pubkey()+eh.default.stringify(ei);await this.send(ey.EventType.KeyVerificationAccept,{key_agreement_protocol:eo,hash:ed,message_authentication_code:eu,short_authentication_string:ef,commitment:ec.sha256(ea)});let ep=await this.waitForEvent(ey.EventType.KeyVerificationKey);ei=ep.getContent(),this.theirSASPubKey=ei.key,eg.set_their_key(ei.key),this.ourSASPubKey=eg.get_pubkey(),await this.send(ey.EventType.KeyVerificationKey,{key:this.ourSASPubKey}),await this.verifyAndCheckMAC(eo,ef,eg,eu)}finally{eg.free()}}sendMAC(ei,eo){let ea={},ec=[],ed="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,eu=`ed25519:${this.baseApis.deviceId}`;ea[eu]=eR(ei,eo)(this.baseApis.getDeviceEd25519Key(),ed+eu),ec.push(eu);let eh=this.baseApis.getCrossSigningId();if(eh){let eu=`ed25519:${eh}`;ea[eu]=eR(ei,eo)(eh,ed+eu),ec.push(eu)}let ef=eR(ei,eo)(ec.sort().join(","),ed+"KEY_IDS");return this.send(ey.EventType.KeyVerificationMac,{mac:ea,keys:ef})}async checkMAC(ei,eo,ea){let ec="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(eo.keys!==eR(ei,ea)(Object.keys(eo.mac).sort().join(","),ec+"KEY_IDS"))throw(0,ep.newKeyMismatchError)();await this.verifyKeys(this.userId,eo.mac,(eo,ed,eu)=>{if(eu!==eR(ei,ea)(ed.keys[eo],ec+eo))throw(0,ep.newKeyMismatchError)()})}}eo.SAS=eK},1649:function(ei,eo){"use strict";function ea(ei){return[(ei[0]<<5|ei[1]>>3)+1e3,((7&ei[1])<<10|ei[2]<<2|ei[3]>>6)+1e3,((63&ei[3])<<7|ei[4]>>1)+1e3]}Object.defineProperty(eo,"__esModule",{value:!0}),eo.generateDecimalSas=ea},2842:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.InRoomRequests=eo.InRoomChannel=void 0;var ed=ec(ea(8416)),eu=ea(5279),eh=ea(7434),ef=ea(2481);let ep=ef.EventType.RoomMessage,eg="m.reference",em="m.relates_to";class ey{constructor(ei,eo,ea){this.client=ei,this.roomId=eo,this.userId=ea,(0,ed.default)(this,"requestEventId",void 0)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(ei,eo){let ea=ey.getEventType(ei);if(ea!==eu.REQUEST_TYPE)return;let ec=eo.getUserId(),ed=ei.getSender(),eh=ei.getContent(),ef=eh.to;return ed===ec?ef:ef===ec?ed:void 0}getTimestamp(ei){return ei.getTs()}static canCreateRequest(ei){return ei===eu.REQUEST_TYPE}canCreateRequest(ei){return ey.canCreateRequest(ei)}static getTransactionId(ei){if(ey.getEventType(ei)===eu.REQUEST_TYPE)return ei.getId();{let eo=ei.getRelation();if((null==eo?void 0:eo.rel_type)===eg)return eo.event_id}}static validateEvent(ei,eo){let ea=ey.getTransactionId(ei);if("string"!=typeof ea||0===ea.length)return!1;let ec=ey.getEventType(ei),ed=ei.getContent();if(ec===eu.REQUEST_TYPE){if(!ed||"string"!=typeof ed.to||!ed.to.length)return eh.logger.log("InRoomChannel: validateEvent: no valid to "+(ed&&ed.to)),!1;if(!ey.getOtherPartyUserId(ei,eo))return eh.logger.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${ei.getSender()}, ${ed&&ed.to}`),!1}return eu.VerificationRequest.validateEvent(ec,ei,eo)}static getEventType(ei){let eo=ei.getType();if(eo===ep){let eo=ei.getContent();if(eo){let{msgtype:ei}=eo;if(ei===eu.REQUEST_TYPE)return eu.REQUEST_TYPE}}return eo&&eo!==eu.REQUEST_TYPE?eo:""}async handleEvent(ei,eo,ea=!1){if(eo.hasEventId(ei.getId()))return;let ec=ey.getEventType(ei);if(ei.getRoomId()!==this.roomId)return;if(!this.userId){let eo=ey.getOtherPartyUserId(ei,this.client);eo&&(this.userId=eo)}let ed=this.client.getUserId(),eu=ei.getSender();if(this.userId&&eu!==ed&&eu!==this.userId){eh.logger.log(`InRoomChannel: ignoring verification event from non-participating sender ${eu}`);return}this.requestEventId||(this.requestEventId=ey.getTransactionId(ei));let ef=!!ei.getUnsigned().transaction_id,ep=ei.getSender()===this.client.getUserId();return eo.handleEvent(ec,ei,ea,ef,ep)}completedContentFromEvent(ei){let eo=Object.assign({},ei.getContent());return eo[em]=ei.getRelation(),eo}completeContent(ei,eo){return eo=Object.assign({},eo),(ei===eu.REQUEST_TYPE||ei===eu.READY_TYPE||ei===eu.START_TYPE)&&(eo.from_device=this.client.getDeviceId()),ei===eu.REQUEST_TYPE?eo={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:eu.REQUEST_TYPE,to:this.userId,from_device:eo.from_device,methods:eo.methods}:eo[em]={rel_type:eg,event_id:this.transactionId},eo}send(ei,eo){let ea=this.completeContent(ei,eo);return this.sendCompleted(ei,ea)}async sendCompleted(ei,eo){let ea=ei;ei===eu.REQUEST_TYPE&&(ea=ep);let ec=await this.client.sendEvent(this.roomId,ea,eo);ei===eu.REQUEST_TYPE&&(this.requestEventId=ec.event_id)}}eo.InRoomChannel=ey;class eb{constructor(){(0,ed.default)(this,"requestsByRoomId",new Map)}getRequest(ei){let eo=ei.getRoomId(),ea=ey.getTransactionId(ei);return this.getRequestByTxnId(eo,ea)}getRequestByChannel(ei){return this.getRequestByTxnId(ei.roomId,ei.transactionId)}getRequestByTxnId(ei,eo){let ea=this.requestsByRoomId.get(ei);if(ea)return ea.get(eo)}setRequest(ei,eo){this.doSetRequest(ei.getRoomId(),ey.getTransactionId(ei),eo)}setRequestByChannel(ei,eo){this.doSetRequest(ei.roomId,ei.transactionId,eo)}doSetRequest(ei,eo,ea){let ec=this.requestsByRoomId.get(ei);ec||(ec=new Map,this.requestsByRoomId.set(ei,ec)),ec.set(eo,ea)}removeRequest(ei){let eo=ei.getRoomId(),ea=this.requestsByRoomId.get(eo);ea&&(ea.delete(ey.getTransactionId(ei)),0===ea.size&&this.requestsByRoomId.delete(eo))}findRequestInProgress(ei){let eo=this.requestsByRoomId.get(ei);if(eo){for(let ei of eo.values())if(ei.pending)return ei}}}eo.InRoomRequests=eb},9588:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.ToDeviceRequests=eo.ToDeviceChannel=void 0;var ed=ec(ea(8416)),eu=ea(8401),eh=ea(7434),ef=ea(5279),ep=ea(6702),eg=ea(4369);class em{constructor(ei,eo,ea,ec,eu){this.client=ei,this.userId=eo,this.devices=ea,this.transactionId=ec,this.deviceId=eu,(0,ed.default)(this,"request",void 0)}isToDevices(ei){if(ei.length!==this.devices.length)return!1;for(let eo of ei)if(!this.devices.includes(eo))return!1;return!0}static getEventType(ei){return ei.getType()}static getTransactionId(ei){let eo=ei.getContent();return eo&&eo.transaction_id}static canCreateRequest(ei){return ei===ef.REQUEST_TYPE||ei===ef.START_TYPE}canCreateRequest(ei){return em.canCreateRequest(ei)}static validateEvent(ei,eo){if(ei.isCancelled())return eh.logger.warn("Ignoring flagged verification request from "+ei.getSender()),!1;let ea=ei.getContent();if(!ea)return eh.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!ea.transaction_id)return eh.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;let ec=ei.getType();if(ec===ef.REQUEST_TYPE){if(!Number.isFinite(ea.timestamp))return eh.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(ei.getSender()===eo.getUserId()&&ea.from_device==eo.getDeviceId())return eh.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return ef.VerificationRequest.validateEvent(ec,ei,eo)}getTimestamp(ei){let eo=ei.getContent();return eo&&eo.timestamp}async handleEvent(ei,eo,ea=!1){let ec=ei.getType(),ed=ei.getContent();if(ec===ef.REQUEST_TYPE||ec===ef.READY_TYPE||ec===ef.START_TYPE){this.transactionId||(this.transactionId=ed.transaction_id);let ei=ed.from_device;if(!this.deviceId&&this.devices.includes(ei)&&(this.deviceId=ei),!this.deviceId||this.deviceId!==ei){let eo=this.completeContent(ef.CANCEL_TYPE,(0,ep.errorFromEvent)((0,ep.newUnexpectedMessageError)()));return this.sendToDevices(ef.CANCEL_TYPE,eo,[ei])}}let eu=eo.phase===ef.PHASE_STARTED||eo.phase===ef.PHASE_READY;await eo.handleEvent(ei.getType(),ei,ea,!1,!1);let eh=eo.phase===ef.PHASE_STARTED||eo.phase===ef.PHASE_READY,eg=ec===ef.START_TYPE||ec===ef.READY_TYPE;if(eg&&!eu&&eh&&this.deviceId){let ei=this.devices.filter(ei=>ei!==this.deviceId&&ei!==this.client.getDeviceId());if(ei.length){let eo=this.completeContent(ef.CANCEL_TYPE,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(ef.CANCEL_TYPE,eo,ei)}}}completedContentFromEvent(ei){return ei.getContent()}completeContent(ei,eo){return eo=Object.assign({},eo),this.transactionId&&(eo.transaction_id=this.transactionId),(ei===ef.REQUEST_TYPE||ei===ef.READY_TYPE||ei===ef.START_TYPE)&&(eo.from_device=this.client.getDeviceId()),ei===ef.REQUEST_TYPE&&(eo.timestamp=Date.now()),eo}send(ei,eo={}){ei!==ef.REQUEST_TYPE&&ei!==ef.START_TYPE||this.transactionId||(this.transactionId=em.makeTransactionId());let ea=this.completeContent(ei,eo);return this.sendCompleted(ei,ea)}async sendCompleted(ei,eo){let ea;ea=ei!==ef.REQUEST_TYPE&&(ei!==ef.CANCEL_TYPE||this.deviceId)?await this.sendToDevices(ei,eo,[this.deviceId]):await this.sendToDevices(ei,eo,this.devices);let ec=new eg.MatrixEvent({sender:this.client.getUserId(),content:eo,type:ei});return await this.request.handleEvent(ei,ec,!0,!0,!0),ea}async sendToDevices(ei,eo,ea){if(ea.length){let ec=new Map;for(let ei of ea)ec.set(ei,eo);await this.client.sendToDevice(ei,new Map([[this.userId,ec]]))}}static makeTransactionId(){return(0,eu.randomString)(32)}}eo.ToDeviceChannel=em;class ey{constructor(){(0,ed.default)(this,"requestsByUserId",new Map)}getRequest(ei){return this.getRequestBySenderAndTxnId(ei.getSender(),em.getTransactionId(ei))}getRequestByChannel(ei){return this.getRequestBySenderAndTxnId(ei.userId,ei.transactionId)}getRequestBySenderAndTxnId(ei,eo){let ea=this.requestsByUserId.get(ei);if(ea)return ea.get(eo)}setRequest(ei,eo){this.setRequestBySenderAndTxnId(ei.getSender(),em.getTransactionId(ei),eo)}setRequestByChannel(ei,eo){this.setRequestBySenderAndTxnId(ei.userId,ei.transactionId,eo)}setRequestBySenderAndTxnId(ei,eo,ea){let ec=this.requestsByUserId.get(ei);ec||(ec=new Map,this.requestsByUserId.set(ei,ec)),ec.set(eo,ea)}removeRequest(ei){let eo=ei.getSender(),ea=this.requestsByUserId.get(eo);ea&&(ea.delete(em.getTransactionId(ei)),0===ea.size&&this.requestsByUserId.delete(eo))}findRequestInProgress(ei,eo){let ea=this.requestsByUserId.get(ei);if(ea){for(let ei of ea.values())if(ei.pending&&ei.channel.isToDevices(eo))return ei}}getRequestsInProgress(ei){let eo=this.requestsByUserId.get(ei);return eo?Array.from(eo.values()).filter(ei=>ei.pending):[]}}eo.ToDeviceRequests=ey},5279:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.VerificationRequestEvent=eo.VerificationRequest=eo.START_TYPE=eo.REQUEST_TYPE=eo.READY_TYPE=eo.Phase=eo.PHASE_UNSENT=eo.PHASE_STARTED=eo.PHASE_REQUESTED=eo.PHASE_READY=eo.PHASE_DONE=eo.PHASE_CANCELLED=eo.EVENT_PREFIX=eo.DONE_TYPE=eo.CANCEL_TYPE=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(6702),ef=ea(1696),ep=ea(2481),eg=ea(5861);let em=6e5,ey=12e4,eb=3e3,eS="m.key.verification.";eo.EVENT_PREFIX=eS;let eE=eS+"request";eo.REQUEST_TYPE=eE;let ew=eS+"start";eo.START_TYPE=ew;let e_=eS+"cancel";eo.CANCEL_TYPE=e_;let eT=eS+"done";eo.DONE_TYPE=eT;let eI=eS+"ready";eo.READY_TYPE=eI;let eC=function(ei){return ei[ei.Unsent=1]="Unsent",ei[ei.Requested=2]="Requested",ei[ei.Ready=3]="Ready",ei[ei.Started=4]="Started",ei[ei.Cancelled=5]="Cancelled",ei[ei.Done=6]="Done",ei}({});eo.Phase=eC;let eO=eC.Unsent;eo.PHASE_UNSENT=eO;let eR=eC.Requested;eo.PHASE_REQUESTED=eR;let ek=eC.Ready;eo.PHASE_READY=ek;let eM=eC.Started;eo.PHASE_STARTED=eM;let eP=eC.Cancelled;eo.PHASE_CANCELLED=eP;let eA=eC.Done;eo.PHASE_DONE=eA;let eD=function(ei){return ei.Change="change",ei}({});eo.VerificationRequestEvent=eD;class ej extends eg.TypedEventEmitter{constructor(ei,eo,ea){super(),this.channel=ei,this.verificationMethods=eo,this.client=ea,(0,ed.default)(this,"eventsByUs",new Map),(0,ed.default)(this,"eventsByThem",new Map),(0,ed.default)(this,"_observeOnly",!1),(0,ed.default)(this,"timeoutTimer",null),(0,ed.default)(this,"_accepting",!1),(0,ed.default)(this,"_declining",!1),(0,ed.default)(this,"verifierHasFinished",!1),(0,ed.default)(this,"_cancelled",!1),(0,ed.default)(this,"_chosenMethod",null),(0,ed.default)(this,"_qrCodeData",null),(0,ed.default)(this,"requestReceivedAt",null),(0,ed.default)(this,"commonMethods",[]),(0,ed.default)(this,"_phase",void 0),(0,ed.default)(this,"_cancellingUserId",void 0),(0,ed.default)(this,"_verifier",void 0),(0,ed.default)(this,"cancelOnTimeout",async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(ei){eu.logger.error("Error while cancelling verification request",ei)}}),this.channel.request=this,this.setPhase(eO,!1)}static validateEvent(ei,eo,ea){let ec=eo.getContent();return!!(ei&&ei.startsWith(eS))&&(ec?ei!==eE&&ei!==eI||Array.isArray(ec.methods)?ei!==eE&&ei!==eI&&ei!==ew||"string"==typeof ec.from_device&&0!==ec.from_device.length||(eu.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(eu.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(eu.logger.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===eO}get requested(){return this.phase===eR}get cancelled(){return this.phase===eP}get ready(){return this.phase===ek}get started(){return this.phase===eM}get done(){return this.phase===eA}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(ei){let eo=this.channel.getTimestamp(ei)+em;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=eR){let ei=this.requestReceivedAt+ey;eo=Math.min(eo,ei)}return Math.max(0,eo-Date.now())}get timeout(){let ei=this.getEventByEither(eE);return ei?this.calculateEventTimeout(ei):0}get requestEvent(){return this.getEventByEither(eE)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<ek&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==eA&&this._phase!==eP}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(ei,eo=!1){if(!eo&&!this.ready&&!this.started)return!1;let ea=this.eventsByThem.get(eE)||this.eventsByThem.get(eI);if(!ea){if(this.started&&this.initiatedByMe){let eo=this.eventsByUs.get(ew),ea=eo&&eo.getContent(),ec=ea&&ea.method;return ei==ec}return!1}let ec=ea.getContent();if(!ec)return!1;let{methods:ed}=ec;return!!Array.isArray(ed)&&ed.includes(ei)}get initiatedByMe(){let ei=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===eO&&ei)return!0;let eo=this.eventsByUs.has(eE),ea=this.eventsByThem.has(eE);if(eo&&!ea)return!0;if(!eo&&ea)return!1;let ec=this.eventsByUs.has(ew),ed=this.eventsByThem.has(ew);return!!ec&&!ed}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){let ei=this.eventsByUs.get(e_),eo=this.eventsByThem.get(e_);return ei&&(!eo||ei.getId()<eo.getId())?ei.getSender():eo?eo.getSender():void 0}get cancellationCode(){let ei=this.getEventByEither(e_);return ei?ei.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){let ei=this.eventsByThem.get(eE)||this.eventsByThem.get(eI)||this.eventsByThem.get(ew),eo=null==ei?void 0:ei.getContent(),ea=null==eo?void 0:eo.from_device;return{userId:this.otherUserId,deviceId:ea}}beginKeyVerification(ei,eo=null){if(!this.observeOnly&&!this._verifier){let ea=this.phase===eR||this.phase===ek||this.phase===eO&&this.channel.canCreateRequest(ew);if(ea){if(this.commonMethods.length&&!this.commonMethods.includes(ei)||(this._verifier=this.createVerifier(ei,null,eo),!this._verifier))throw(0,eh.newUnknownMethodError)();this._chosenMethod=ei}}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===eO){let ei=[...this.verificationMethods.keys()];await this.channel.send(eE,{methods:ei})}}async cancel({reason:ei="User declined",code:eo="m.user"}={}){if(!this.observeOnly&&this._phase!==eP){if(this._declining=!0,this.emit(eD.Change),this._verifier)return this._verifier.cancel((0,eh.errorFactory)(eo,ei)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(e_,{code:eo,reason:ei})}}async accept(){if(!this.observeOnly&&this.phase===eR&&!this.initiatedByMe){let ei=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(eD.Change),await this.channel.send(eI,{methods:ei})}}waitFor(ei){return new Promise((eo,ea)=>{let ec=()=>{let ed=!1;return ei(this)?(eo(this),ed=!0):this.cancelled&&(ea(Error("cancelled")),ed=!0),ed&&this.off(eD.Change,ec),ed};ec()||this.on(eD.Change,ec)})}setPhase(ei,eo=!0){this._phase=ei,eo&&this.emit(eD.Change)}getEventByEither(ei){return this.eventsByThem.get(ei)||this.eventsByUs.get(ei)}getEventBy(ei,eo=!1){return eo?this.eventsByThem.get(ei):this.eventsByUs.get(ei)}calculatePhaseTransitions(){let ei;let eo=[{phase:eO}],ea=()=>eo[eo.length-1].phase,ec=this.eventsByThem.has(eE),ed=this.getEventBy(eE,ec);ed&&eo.push({phase:eR,event:ed});let eu=ed&&this.getEventBy(eI,!ec);if(eu&&ea()===eR&&eo.push({phase:ek,event:eu}),eu||!ed){let eo=this.eventsByThem.get(ew),ea=this.eventsByUs.get(ew);ei=eo&&ea?eo.getSender()<ea.getSender()?eo:ea:eo||ea}else ei=this.getEventBy(ew,!ec);if(ei){let ec=ea()===eR&&(null==ed?void 0:ed.getSender())!==ei.getSender(),eu=ea()===eO&&this.channel.canCreateRequest(ew);(ec||ea()===ek||eu)&&eo.push({phase:eM,event:ei})}let eh=this.eventsByUs.get(eT);(this.verifierHasFinished||eh&&ea()===eM)&&eo.push({phase:eA});let ef=this.getEventByEither(e_);return(this._cancelled||ef)&&ea()!==eA&&eo.push({phase:eP,event:ef}),eo}transitionToPhase(ei){let{phase:eo,event:ea}=ei;if((eo===eR||eo===ek)&&!this.wasSentByOwnDevice(ea)){let ei=ea.getContent();this.commonMethods=ei.methods.filter(ei=>this.verificationMethods.has(ei))}if(!this.observeOnly&&(eo===eR||eo===eM||eo===ek)&&this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(ea)&&!this.wasSentByOwnDevice(ea)&&(this._observeOnly=!0),eo===eM){let{method:ei}=ea.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(ei,ea),this._verifier?this._chosenMethod=ei:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${ei}`}))}}applyPhaseTransitions(){let ei=this.calculatePhaseTransitions(),eo=ei.findIndex(ei=>ei.phase===this.phase),ea=ei.slice(eo+1);for(let ei of ea)this.transitionToPhase(ei);return ea}isWinningStartRace(ei){let eo,ea;if(ei.getType()!==ew)return!1;let ec=this._verifier.startEvent;if(this.isSelfVerification){if(ec){let ei=ec.getContent();eo=ei&&ei.from_device}else eo=this.client.getDeviceId()}else eo=ec?ec.getSender():this.client.getUserId();if(this.isSelfVerification){let eo=ei.getContent();ea=eo&&eo.from_device}else ea=ei.getSender();return ea<eo}hasEventId(ei){for(let eo of this.eventsByUs.values())if(eo.getId()===ei)return!0;for(let eo of this.eventsByThem.values())if(eo.getId()===ei)return!0;return!1}async handleEvent(ei,eo,ea,ec,ed){if(this.done||this.cancelled)return;let eh=this._observeOnly;if(this.adjustObserveOnly(eo,ea),!this.observeOnly&&!ec&&await this.cancelOnError(ei,eo))return;let ep=ed?this.eventsByUs.has(ei):this.eventsByThem.has(ei);if(ep)return;let eg=this.phase;this.addEvent(ei,eo,ed);let em=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){let ea=this.isWinningStartRace(eo);if(this._verifier.canSwitchStartEvent(eo)&&ea)this._verifier.switchStartEvent(eo);else if(!ec){var ey;(ei===e_||null!==(ey=this._verifier.events)&&void 0!==ey&&ey.includes(ei))&&this._verifier.handleEvent(eo)}}if(em.length){if(ea&&em.some(ei=>ei.phase===ek)){let ei=this.otherPartySupportsMethod(ef.SCAN_QR_CODE_METHOD,!0);ei&&(this._qrCodeData=await ef.QRCodeData.create(this,this.client))}let ei=em[em.length-1],{phase:eo}=ei;this.setupTimeout(eo),this.setPhase(eo)}else this._observeOnly!==eh&&this.emit(eD.Change)}finally{eu.logger.log(`Verification request ${this.channel.transactionId}: ${ei} event with id:${eo.getId()}, content:${JSON.stringify(eo.getContent())} deviceId:${this.channel.deviceId}, sender:${eo.getSender()}, isSentByUs:${ed}, isLiveEvent:${ea}, isRemoteEcho:${ec}, phase:${eg}=>${this.phase}, observeOnly:${eh}=>${this._observeOnly}`)}}setupTimeout(ei){let eo=!this.timeoutTimer&&!this.observeOnly&&ei===eR;if(eo&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){let eo=ei===eM||ei===ek||ei===eA||ei===eP;eo&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}async cancelOnError(ei,eo){if(ei===ew){let ei=eo.getContent().method;if(!this.verificationMethods.has(ei))return await this.cancel((0,eh.errorFromEvent)((0,eh.newUnknownMethodError)())),!0}let ea=ei===eE&&this.phase!==eO,ec=ei===eI&&this.phase!==eR&&this.phase!==eM;if(this.phase!==eO&&(ea||ec)){eu.logger.warn(`Cancelling, unexpected ${ei} verification event from ${eo.getSender()}`);let ea=`Unexpected ${ei} event in phase ${this.phase}`;return await this.cancel((0,eh.errorFromEvent)((0,eh.newUnexpectedMessageError)({reason:ea}))),!0}return!1}adjustObserveOnly(ei,eo=!1){eo||(this._observeOnly=!0),this.calculateEventTimeout(ei)<eb&&(this._observeOnly=!0)}addEvent(ei,eo,ea=!1){if(ea?this.eventsByUs.set(ei,eo):this.eventsByThem.set(ei,eo),ei===eE){for(let[ei,eo]of this.eventsByThem.entries())eo.getSender()!==this.otherUserId&&this.eventsByThem.delete(ei);this.requestReceivedAt=Date.now()}}createVerifier(ei,eo=null,ea=null){ea||(ea=this.targetDevice);let{userId:ec,deviceId:ed}=ea,eh=this.verificationMethods.get(ei);if(!eh){eu.logger.warn("could not find verifier constructor for method",ei);return}return new eh(this.channel,this.client,ec,ed,eo,this)}wasSentByOwnUser(ei){return(null==ei?void 0:ei.getSender())===this.client.getUserId()}wasSentByOwnDevice(ei){if(!this.wasSentByOwnUser(ei))return!1;let eo=ei.getContent();return!!eo&&eo.from_device===this.client.getDeviceId()}onVerifierCancelled(){this._cancelled=!0;let ei=this.applyPhaseTransitions();ei.length&&this.setPhase(ei[ei.length-1].phase)}onVerifierFinished(){this.channel.send(ep.EventType.KeyVerificationDone,{}),this.verifierHasFinished=!0;let ei=this.applyPhaseTransitions();ei.length&&this.setPhase(ei[ei.length-1].phase)}getEventFromOtherParty(ei){return this.eventsByThem.get(ei)}}eo.VerificationRequest=ej},9810:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomWidgetClient=void 0;var ed=ec(ea(8416)),eu=ea(7760),eh=ea(4369),ef=ea(2481),ep=ea(7434),eg=ea(2168),em=ea(4551),ey=ea(11),eb=ea(3998),eS=ea(3102);class eE extends eg.MatrixClient{constructor(ei,eo,ea,ec){var ey,eb,eS,eE,ew,e_,eT,eI,eC,eO;super(ec),this.widgetApi=ei,this.capabilities=eo,this.roomId=ea,(0,ed.default)(this,"room",void 0),(0,ed.default)(this,"widgetApiReady",new Promise(ei=>this.widgetApi.once("ready",ei))),(0,ed.default)(this,"lifecycle",void 0),(0,ed.default)(this,"syncState",null),(0,ed.default)(this,"onEvent",async ei=>{if(ei.preventDefault(),ei.detail.data.room_id===this.roomId){let eo=new eh.MatrixEvent(ei.detail.data);await this.syncApi.injectRoomEvents(this.room,[],[eo]),this.emit(eg.ClientEvent.Event,eo),this.setSyncState(em.SyncState.Syncing),ep.logger.info(`Received event ${eo.getId()} ${eo.getType()} ${eo.getStateKey()}`)}else{let{event_id:eo,room_id:ea}=ei.detail.data;ep.logger.info(`Received event ${eo} for a different room ${ea}; discarding`)}await this.ack(ei)}),(0,ed.default)(this,"onToDevice",async ei=>{ei.preventDefault();let eo=new eh.MatrixEvent({type:ei.detail.data.type,sender:ei.detail.data.sender,content:ei.detail.data.content});ei.detail.data.encrypted&&eo.makeEncrypted(ef.EventType.RoomMessageEncrypted,{},"",""),this.emit(eg.ClientEvent.ToDeviceEvent,eo),this.setSyncState(em.SyncState.Syncing),await this.ack(ei)}),(null!==(ey=eo.sendEvent)&&void 0!==ey&&ey.length||null!==(eb=eo.receiveEvent)&&void 0!==eb&&eb.length||!0===eo.sendMessage||Array.isArray(eo.sendMessage)&&eo.sendMessage.length||!0===eo.receiveMessage||Array.isArray(eo.receiveMessage)&&eo.receiveMessage.length||null!==(eS=eo.sendState)&&void 0!==eS&&eS.length||null!==(eE=eo.receiveState)&&void 0!==eE&&eE.length)&&ei.requestCapabilityForRoomTimeline(ea),null===(ew=eo.sendEvent)||void 0===ew||ew.forEach(eo=>ei.requestCapabilityToSendEvent(eo)),null===(e_=eo.receiveEvent)||void 0===e_||e_.forEach(eo=>ei.requestCapabilityToReceiveEvent(eo)),!0===eo.sendMessage?ei.requestCapabilityToSendMessage():Array.isArray(eo.sendMessage)&&eo.sendMessage.forEach(eo=>ei.requestCapabilityToSendMessage(eo)),!0===eo.receiveMessage?ei.requestCapabilityToReceiveMessage():Array.isArray(eo.receiveMessage)&&eo.receiveMessage.forEach(eo=>ei.requestCapabilityToReceiveMessage(eo)),null===(eT=eo.sendState)||void 0===eT||eT.forEach(({eventType:eo,stateKey:ea})=>ei.requestCapabilityToSendState(eo,ea)),null===(eI=eo.receiveState)||void 0===eI||eI.forEach(({eventType:eo,stateKey:ea})=>ei.requestCapabilityToReceiveState(eo,ea)),null===(eC=eo.sendToDevice)||void 0===eC||eC.forEach(eo=>ei.requestCapabilityToSendToDevice(eo)),null===(eO=eo.receiveToDevice)||void 0===eO||eO.forEach(eo=>ei.requestCapabilityToReceiveToDevice(eo)),eo.turnServers&&ei.requestCapability(eu.MatrixCapabilities.MSC3846TurnServers),ei.on(`action:${eu.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),ei.on(`action:${eu.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),ei.start()}async startClient(ei={}){var eo,ea;this.lifecycle=new AbortController;let ec=this.getUserId();ec&&this.store.storeUser(new eb.User(ec)),ei.slidingSync?this.syncApi=new ey.SlidingSyncSdk(ei.slidingSync,this,ei,this.buildSyncApiOptions()):this.syncApi=new em.SyncApi(this,ei,this.buildSyncApiOptions()),this.room=this.syncApi.createRoom(this.roomId),this.store.storeRoom(this.room),await this.widgetApiReady,await Promise.all(null!==(eo=null===(ea=this.capabilities.receiveState)||void 0===ea?void 0:ea.map(async({eventType:ei,stateKey:eo})=>{let ea=await this.widgetApi.readStateEvents(ei,void 0,eo,[this.roomId]),ec=ea.map(ei=>new eh.MatrixEvent(ei));await this.syncApi.injectRoomEvents(this.room,[],ec),ec.forEach(ei=>{this.emit(eg.ClientEvent.Event,ei),ep.logger.info(`Backfilled event ${ei.getId()} ${ei.getType()} ${ei.getStateKey()}`)})}))&&void 0!==eo?eo:[]),this.setSyncState(em.SyncState.Syncing),ep.logger.info("Finished backfilling events"),this.capabilities.turnServers&&this.watchTurnServers()}stopClient(){this.widgetApi.off(`action:${eu.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),this.widgetApi.off(`action:${eu.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),super.stopClient(),this.lifecycle.abort()}async joinRoom(ei){if(ei===this.roomId)return this.room;throw Error(`Unknown room: ${ei}`)}async encryptAndSendEvent(ei,eo){let ea;try{ea=await this.widgetApi.sendRoomEvent(eo.getType(),eo.getContent(),ei.roomId)}catch(ea){throw this.updatePendingEventStatus(ei,eo,eh.EventStatus.NOT_SENT),ea}return ei.updatePendingEvent(eo,eh.EventStatus.SENT,ea.event_id),{event_id:ea.event_id}}async sendStateEvent(ei,eo,ea,ec=""){return await this.widgetApi.sendStateEvent(eo,ec,ea,ei)}async sendToDevice(ei,eo){return await this.widgetApi.sendToDevice(ei,!1,(0,eS.recursiveMapToObject)(eo)),{}}async queueToDevice({eventType:ei,batch:eo}){let ea=new eS.MapWithDefault(()=>new Map);for(let{userId:ei,deviceId:ec,payload:ed}of eo)ea.getOrCreate(ei).set(ec,ed);await this.widgetApi.sendToDevice(ei,!1,(0,eS.recursiveMapToObject)(ea))}async encryptAndSendToDevices(ei,eo){let ea=new eS.MapWithDefault(()=>new Map);for(let{userId:ec,deviceInfo:{deviceId:ed}}of ei)ea.getOrCreate(ec).set(ed,eo);await this.widgetApi.sendToDevice(eo.type,!0,(0,eS.recursiveMapToObject)(ea))}async checkTurnServers(){return this.turnServers.length>0}getSyncState(){return this.syncState}setSyncState(ei){let eo=this.syncState;this.syncState=ei,this.emit(eg.ClientEvent.Sync,ei,eo)}async ack(ei){await this.widgetApi.transport.reply(ei.detail,{})}async watchTurnServers(){let ei=this.widgetApi.getTurnServers(),eo=()=>{ei.return(void 0)};this.lifecycle.signal.addEventListener("abort",eo);try{for await(let eo of ei)this.turnServers=[{urls:eo.uris,username:eo.username,credential:eo.password}],this.emit(eg.ClientEvent.TurnServers,this.turnServers),ep.logger.log(`Received TURN server: ${eo.uris}`)}catch(ei){ep.logger.warn("Error watching TURN servers",ei)}finally{this.lifecycle.signal.removeEventListener("abort",eo)}}}eo.RoomWidgetClient=eE},9489:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.KeySignatureUploadError=eo.InvalidStoreState=eo.InvalidStoreError=eo.InvalidCryptoStoreState=eo.InvalidCryptoStoreError=void 0;var ed=ec(ea(8416));let eu=function(ei){return ei[ei.ToggledLazyLoading=0]="ToggledLazyLoading",ei}({});eo.InvalidStoreState=eu;class eh extends Error{constructor(ei,eo){let ea=`Store is invalid because ${ei}, please stop the client, delete all data and start the client again`;super(ea),this.reason=ei,this.value=eo,this.name="InvalidStoreError"}}eo.InvalidStoreError=eh,(0,ed.default)(eh,"TOGGLED_LAZY_LOADING",eu.ToggledLazyLoading);let ef=function(ei){return ei.TooNew="TOO_NEW",ei}({});eo.InvalidCryptoStoreState=ef;class ep extends Error{constructor(ei){let eo=`Crypto store is invalid because ${ei}, please stop the client, delete all data and start the client again`;super(eo),this.reason=ei,this.name="InvalidCryptoStoreError"}}eo.InvalidCryptoStoreError=ep,(0,ed.default)(ep,"TOO_NEW",ef.TooNew);class eg extends Error{constructor(ei,eo){super(ei),this.value=eo}}eo.KeySignatureUploadError=eg},1166:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.eventMapperFor=eg;var ed=ec(ea(8416)),eu=ea(4369),eh=ea(2481);function ef(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ep(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ef(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ef(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eg(ei,eo){let ea=!!eo.preventReEmit,ec=!1!==eo.decrypt;function ed(ef){let eg;eo.toDevice&&delete ef.room_id;let em=ei.getRoom(ef.room_id);em&&void 0===ef.state_key&&(eg=em.findEventById(ef.event_id)),!eg||eg.status?eg=new eu.MatrixEvent(ef):(eg.setUnsigned(ep(ep({},eg.getUnsigned()),ef.unsigned)),ea=!0);let ey=eg.getServerAggregatedRelation(eh.RelationType.Replace);if(null!=ey&&ey.content){let ei=ed(ey);eg.makeReplaced(ei)}let eb=null==em?void 0:em.findThreadForEvent(eg);return eb&&eg.setThread(eb),eg.isEncrypted()&&(ea||ei.reEmitter.reEmit(eg,[eu.MatrixEventEvent.Decrypted]),ec&&ei.decryptEventIfNeeded(eg)),ea||(ei.reEmitter.reEmit(eg,[eu.MatrixEventEvent.Replaced,eu.MatrixEventEvent.VisibilityChange]),null==em||em.reEmitter.reEmit(eg,[eu.MatrixEventEvent.BeforeRedaction])),eg}return ed}},4992:function(ei,eo){"use strict";function ea(ei){return null!=ei}function ec(ei){return ea(ei)&&"string"==typeof ei}Object.defineProperty(eo,"__esModule",{value:!0}),eo.isOptionalAString=ec,eo.isProvided=ea},5268:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.ServerSupport=eo.Feature=void 0,eo.buildFeatureSupportMap=eu;let ea=function(ei){return ei[ei.Stable=0]="Stable",ei[ei.Unstable=1]="Unstable",ei[ei.Unsupported=2]="Unsupported",ei}({});eo.ServerSupport=ea;let ec=function(ei){return ei.Thread="Thread",ei.ThreadUnreadNotifications="ThreadUnreadNotifications",ei.LoginTokenRequest="LoginTokenRequest",ei.RelationBasedRedactions="RelationBasedRedactions",ei.AccountDataDeletion="AccountDataDeletion",ei}({});eo.Feature=ec;let ed={[ec.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[ec.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[ec.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[ec.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[ec.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]}};async function eu(ei){let eo=new Map;for(let[ep,eg]of Object.entries(ed)){var ec,eu,eh,ef;let ed=null!==(ec=null===(eu=ei.versions)||void 0===eu?void 0:eu.includes(eg.matrixVersion||""))&&void 0!==ec&&ec,em=null!==(eh=null===(ef=eg.unstablePrefixes)||void 0===ef?void 0:ef.every(eo=>{var ea;return(null===(ea=ei.unstable_features)||void 0===ea?void 0:ea[eo])===!0}))&&void 0!==eh&&eh;ed?eo.set(ep,ea.Stable):em?eo.set(ep,ea.Unstable):eo.set(ep,ea.Unsupported)}return eo}},3564:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.FilterComponent=void 0;var ec=ea(6969);function ed(ei,eo){if(!eo.endsWith("*"))return ei===eo;{let ea=eo.slice(0,-1);return ei.slice(0,ea.length)===ea}}class eu{constructor(ei,eo){this.filterJson=ei,this.userId=eo}check(ei){var eo,ea;let ed=(null===(eo=ei.getUnsigned())||void 0===eo?void 0:eo["m.relations"])||{},eu=Object.keys(ed),eh=[];return this.userId&&null!=ed&&null!==(ea=ed[ec.THREAD_RELATION_TYPE.name])&&void 0!==ea&&ea.current_user_participated&&eh.push(this.userId),this.checkFields(ei.getRoomId(),ei.getSender(),ei.getType(),!!ei.getContent()&&void 0!==ei.getContent().url,eu,eh)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[ec.FILTER_RELATED_BY_SENDERS.name]:this.filterJson[ec.FILTER_RELATED_BY_SENDERS.name]||[],[ec.FILTER_RELATED_BY_REL_TYPES.name]:this.filterJson[ec.FILTER_RELATED_BY_REL_TYPES.name]||[]}}checkFields(ei,eo,ea,eu,eh,ef){let ep={rooms:function(eo){return ei===eo},senders:function(ei){return eo===ei},types:function(ei){return ed(ea,ei)}};for(let ei in ep){let eo=ep[ei],ea="not_"+ei,ec=this.filterJson[ea];if(null!=ec&&ec.some(eo))return!1;let ed=this.filterJson[ei];if(ed&&!ed.some(eo))return!1}let eg=this.filterJson.contains_url;if(void 0!==eg&&eg!==eu)return!1;let em=this.filterJson[ec.FILTER_RELATED_BY_REL_TYPES.name];if(void 0!==em&&!this.arrayMatchesFilter(em,eh))return!1;let ey=this.filterJson[ec.FILTER_RELATED_BY_SENDERS.name];return!!(void 0===ey||this.arrayMatchesFilter(ey,ef))}arrayMatchesFilter(ei,eo){return eo.length>0&&ei.every(ei=>eo.includes(ei))}filter(ei){return ei.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}eo.FilterComponent=eu},7906:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.Filter=void 0;var ed=ec(ea(8416)),eu=ea(1467),eh=ea(3564);function ef(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ep(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ef(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ef(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eg(ei,eo,ea){let ec=eo.split("."),ed=ei;for(let ei=0;ei<ec.length-1;ei++)ed[ec[ei]]||(ed[ec[ei]]={}),ed=ed[ec[ei]];ed[ec[ec.length-1]]=ea}class em{static fromJson(ei,eo,ea){let ec=new em(ei,eo);return ec.setDefinition(ea),ec}constructor(ei,eo){this.userId=ei,this.filterId=eo,(0,ed.default)(this,"definition",{}),(0,ed.default)(this,"roomFilter",void 0),(0,ed.default)(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(ei){this.definition=ei;let eo=ei.room,ea={};eo&&(eo.rooms&&(ea.rooms=eo.rooms),eo.rooms&&(ea.not_rooms=eo.not_rooms)),this.roomFilter=new eh.FilterComponent(ea,this.userId),this.roomTimelineFilter=new eh.FilterComponent((null==eo?void 0:eo.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(ei){return this.roomFilter&&(ei=this.roomFilter.filter(ei)),this.roomTimelineFilter&&(ei=this.roomTimelineFilter.filter(ei)),ei}setTimelineLimit(ei){eg(this.definition,"room.timeline.limit",ei)}setUnreadThreadNotifications(ei){var eo,ea,ec;this.definition=ep(ep({},this.definition),{},{room:ep(ep({},null===(eo=this.definition)||void 0===eo?void 0:eo.room),{},{timeline:ep(ep({},null===(ea=this.definition)||void 0===ea?void 0:null===(ec=ea.room)||void 0===ec?void 0:ec.timeline),{},{[eu.UNREAD_THREAD_NOTIFICATIONS.name]:ei})})})}setLazyLoadMembers(ei){eg(this.definition,"room.state.lazy_load_members",ei)}setIncludeLeaveRooms(ei){eg(this.definition,"room.include_leave",ei)}}eo.Filter=em,(0,ed.default)(em,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},5144:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MatrixError=eo.HTTPError=eo.ConnectionError=void 0;var ed=ec(ea(8416));class eu extends Error{constructor(ei,eo){super(ei),this.httpStatus=eo}}eo.HTTPError=eu;class eh extends eu{constructor(ei={},eo,ea,ec){let eu=ei.error||"Unknown message";eo&&(eu=`[${eo}] ${eu}`),ea&&(eu=`${eu} (${ea})`),super(`MatrixError: ${eu}`,eo),this.httpStatus=eo,this.url=ea,this.event=ec,(0,ed.default)(this,"errcode",void 0),(0,ed.default)(this,"data",void 0),this.errcode=ei.errcode,this.name=ei.errcode||"Unknown error code",this.data=ei}}eo.MatrixError=eh;class ef extends Error{constructor(ei,eo){super(ei+(eo?`: ${eo.message}`:""))}get name(){return"ConnectionError"}}eo.ConnectionError=ef},956:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.FetchHttpApi=void 0;var ed=ec(ea(8416)),eu=ey(ea(3102)),eh=ea(3750),ef=ea(5144),ep=ea(400),eg=ea(4590);function em(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(em=function(ei){return ei?ea:eo})(ei)}function ey(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=em(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}class eb{constructor(ei,eo){var ea;this.eventEmitter=ei,this.opts=eo,(0,ed.default)(this,"abortController",new AbortController),eu.checkObjectHasKeys(eo,["baseUrl","prefix"]),eo.onlyData=!!eo.onlyData,eo.useAuthorizationHeader=null===(ea=eo.useAuthorizationHeader)||void 0===ea||ea}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(ei,eo){return this.opts.fetchFn?this.opts.fetchFn(ei,eo):ea.g.fetch(ei,eo)}setIdBaseUrl(ei){this.opts.idBaseUrl=ei}idServerRequest(ei,eo,ea,ec,ed){let eu,ef;if(!this.opts.idBaseUrl)throw Error("No identity server base URL set");ei===eh.Method.Get?eu=ea:ef=ea;let ep=this.getUrl(eo,eu,ec,this.opts.idBaseUrl),eg={json:!0,headers:{}};return ed&&(eg.headers.Authorization=`Bearer ${ed}`),this.requestOtherUrl(ei,ep,ef,eg)}authedRequest(ei,eo,ea,ec,ed={}){ea||(ea={}),this.opts.accessToken&&(this.opts.useAuthorizationHeader?(ed.headers||(ed.headers={}),ed.headers.Authorization||(ed.headers.Authorization="Bearer "+this.opts.accessToken),ea.access_token&&delete ea.access_token):ea.access_token||(ea.access_token=this.opts.accessToken));let eu=this.request(ei,eo,ea,ec,ed);return eu.catch(ei=>{"M_UNKNOWN_TOKEN"!=ei.errcode||null!=ed&&ed.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==ei.errcode&&this.eventEmitter.emit(ep.HttpApiEvent.NoConsent,ei.message,ei.data.consent_uri):this.eventEmitter.emit(ep.HttpApiEvent.SessionLoggedOut,ei)}),eu}request(ei,eo,ea,ec,ed){let eu=this.getUrl(eo,ea,null==ed?void 0:ed.prefix,null==ed?void 0:ed.baseUrl);return this.requestOtherUrl(ei,eu,ec,ed)}async requestOtherUrl(ei,eo,ea,ec={}){var ed,eu,eh,ep;let em,ey;let eb=Object.assign({},ec.headers||{}),eS=null===(ed=ec.json)||void 0===ed||ed,eE=eS&&(null==ea?void 0:null===(eu=ea.constructor)||void 0===eu?void 0:eu.name)===Object.name;eS&&(eE&&!eb["Content-Type"]&&(eb["Content-Type"]="application/json"),eb.Accept||(eb.Accept="application/json"));let ew=null!==(eh=ec.localTimeoutMs)&&void 0!==eh?eh:this.opts.localTimeoutMs,e_=null!==(ep=ec.keepAlive)&&void 0!==ep&&ep,eT=[this.abortController.signal];void 0!==ew&&eT.push((0,eg.timeoutSignal)(ew)),ec.abortSignal&&eT.push(ec.abortSignal),em=eE?JSON.stringify(ea):ea;let{signal:eI,cleanup:eC}=(0,eg.anySignal)(eT);try{ey=await this.fetch(eo,{signal:eI,method:ei,body:em,headers:eb,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:e_})}catch(ei){if("AbortError"===ei.name)throw ei;throw new ef.ConnectionError("fetch failed",ei)}finally{eC()}if(!ey.ok)throw(0,eg.parseErrorResponse)(ey,await ey.text());return this.opts.onlyData?eS?ey.json():ey.text():ey}getUrl(ei,eo,ea,ec){let ed=new URL((null!=ec?ec:this.opts.baseUrl)+(null!=ea?ea:this.opts.prefix)+ei);return eo&&eu.encodeParams(eo,ed.searchParams),ed}}eo.FetchHttpApi=eb},95:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0});var ed={MatrixHttpApi:!0};eo.MatrixHttpApi=void 0;var eu=ec(ea(8416)),eh=ea(956),ef=ea(9889);Object.keys(ef).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ed,ei))&&(ei in eo&&eo[ei]===ef[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ef[ei]}}))});var ep=ew(ea(3102)),eg=ew(ea(2731)),em=ea(3750);Object.keys(em).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ed,ei))&&(ei in eo&&eo[ei]===em[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return em[ei]}}))});var ey=ea(5144);Object.keys(ey).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ed,ei))&&(ei in eo&&eo[ei]===ey[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ey[ei]}}))});var eb=ea(4590);Object.keys(eb).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ed,ei))&&(ei in eo&&eo[ei]===eb[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eb[ei]}}))});var eS=ea(400);function eE(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eE=function(ei){return ei?ea:eo})(ei)}function ew(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eE(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}Object.keys(eS).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ed,ei))&&(ei in eo&&eo[ei]===eS[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eS[ei]}}))});class e_ extends eh.FetchHttpApi{constructor(...ei){super(...ei),(0,eu.default)(this,"uploads",[])}uploadContent(ei,eo={}){var ec,ed,eu,eh,eS;let eE=null===(ec=eo.includeFilename)||void 0===ec||ec,ew=null!==(ed=eo.abortController)&&void 0!==ed?ed:new AbortController,e_=null!==(eu=null!==(eh=eo.type)&&void 0!==eh?eh:ei.type)&&void 0!==eu?eu:"application/octet-stream",eT=null!==(eS=eo.name)&&void 0!==eS?eS:ei.name,eI={loaded:0,total:0,abortController:ew},eC=ep.defer();if(ea.g.XMLHttpRequest){let ec=new ea.g.XMLHttpRequest,ed=function(){ec.abort(),eC.reject(Error("Timeout"))},eu=eg.setTimeout(ed,3e4);ec.onreadystatechange=function(){if(ec.readyState===ea.g.XMLHttpRequest.DONE){eg.clearTimeout(eu);try{if(0===ec.status)throw new DOMException(ec.statusText,"AbortError");if(!ec.responseText)throw Error("No response body.");ec.status>=400?eC.reject((0,eb.parseErrorResponse)(ec,ec.responseText)):eC.resolve(JSON.parse(ec.responseText))}catch(ei){if("AbortError"===ei.name){eC.reject(ei);return}eC.reject(new ey.ConnectionError("request failed",ei))}}},ec.upload.onprogress=ei=>{var ea;eg.clearTimeout(eu),eI.loaded=ei.loaded,eI.total=ei.total,eu=eg.setTimeout(ed,3e4),null===(ea=eo.progressHandler)||void 0===ea||ea.call(eo,{loaded:ei.loaded,total:ei.total})};let eh=this.getUrl("/upload",void 0,ef.MediaPrefix.R0);eE&&eT&&eh.searchParams.set("filename",encodeURIComponent(eT)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&eh.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),ec.open(em.Method.Post,eh.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&ec.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),ec.setRequestHeader("Content-Type",e_),ec.send(ei),ew.signal.addEventListener("abort",()=>{ec.abort()})}else{let eo={};eE&&eT&&(eo.filename=eT);let ea={"Content-Type":e_};this.authedRequest(em.Method.Post,"/upload",eo,ei,{prefix:ef.MediaPrefix.R0,headers:ea,abortSignal:ew.signal}).then(ei=>this.opts.onlyData?ei:ei.json()).then(eC.resolve,eC.reject)}return eI.promise=eC.promise.finally(()=>{ep.removeElement(this.uploads,ei=>ei===eI)}),ew.signal.addEventListener("abort",()=>{ep.removeElement(this.uploads,ei=>ei===eI),eC.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(eI),eI.promise}cancelUpload(ei){let eo=this.uploads.find(eo=>eo.promise===ei);return!!eo&&(eo.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:ef.MediaPrefix.R0+"/upload",params:{access_token:this.opts.accessToken}}}}eo.MatrixHttpApi=e_},400:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.HttpApiEvent=void 0;let ea=function(ei){return ei.SessionLoggedOut="Session.logged_out",ei.NoConsent="no_consent",ei}({});eo.HttpApiEvent=ea},3750:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.Method=void 0;let ea=function(ei){return ei.Get="GET",ei.Put="PUT",ei.Post="POST",ei.Delete="DELETE",ei}({});eo.Method=ea},9889:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.MediaPrefix=eo.IdentityPrefix=eo.ClientPrefix=void 0;let ea=function(ei){return ei.R0="/_matrix/client/r0",ei.V1="/_matrix/client/v1",ei.V3="/_matrix/client/v3",ei.Unstable="/_matrix/client/unstable",ei}({});eo.ClientPrefix=ea;let ec=function(ei){return ei.V2="/_matrix/identity/v2",ei}({});eo.IdentityPrefix=ec;let ed=function(ei){return ei.R0="/_matrix/media/r0",ei}({});eo.MediaPrefix=ed},4590:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.anySignal=ep,eo.parseErrorResponse=eg,eo.retryNetworkOperation=eb,eo.timeoutSignal=ef;var ec=ea(7811),ed=ea(7434),eu=ea(3102),eh=ea(5144);function ef(ei){let eo=new AbortController;return setTimeout(()=>{eo.abort()},ei),eo.signal}function ep(ei){let eo=new AbortController;function ea(){for(let eo of ei)eo.removeEventListener("abort",ec)}function ec(){eo.abort(),ea()}for(let eo of ei){if(eo.aborted){ec();break}eo.addEventListener("abort",ec)}return{signal:eo.signal,cleanup:ea}}function eg(ei,eo){var ea,ec;let ed;try{ed=ey(ei)}catch(ei){return ei}return(null===(ea=ed)||void 0===ea?void 0:ea.type)==="application/json"&&eo?new eh.MatrixError(JSON.parse(eo),ei.status,em(ei)?ei.responseURL:ei.url):(null===(ec=ed)||void 0===ec?void 0:ec.type)==="text/plain"?new eh.HTTPError(`Server returned ${ei.status} error: ${eo}`,ei.status):new eh.HTTPError(`Server returned ${ei.status} error`,ei.status)}function em(ei){return"getResponseHeader"in ei}function ey(ei){let eo;if(!(eo=em(ei)?ei.getResponseHeader("Content-Type"):ei.headers.get("Content-Type")))return null;try{return(0,ec.parse)(eo)}catch(ei){throw Error(`Error parsing Content-Type '${eo}': ${ei}`)}}async function eb(ei,eo){let ea=0,ec=null;for(;ea<ei;)try{if(ea>0){let ei=1e3*Math.pow(2,ea);ed.logger.log(`network operation failed ${ea} times, retrying in ${ei}ms...`),await (0,eu.sleep)(ei)}return await eo()}catch(ei){if(ei instanceof eh.ConnectionError)ea+=1,ec=ei;else throw ei}throw ec}},3415:function(ei,eo){"use strict";function ea(ei,eo){return new Promise((ea,ec)=>{let ed=!0,eu=ei.open(eo);eu.onupgradeneeded=()=>{ed=!1},eu.onblocked=()=>ec(eu.error),eu.onsuccess=()=>{let ec=eu.result;ec.close(),ed||ei.deleteDatabase(eo),ea(ed)},eu.onerror=()=>ec(eu.error)})}Object.defineProperty(eo,"__esModule",{value:!0}),eo.exists=ea},8670:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.NoAuthFlowFoundError=eo.InteractiveAuth=eo.AuthType=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(3102);let ef="m.login.email.identity",ep="m.login.msisdn",eg=function(ei){return ei.Password="m.login.password",ei.Recaptcha="m.login.recaptcha",ei.Terms="m.login.terms",ei.Email="m.login.email.identity",ei.Msisdn="m.login.msisdn",ei.Sso="m.login.sso",ei.SsoUnstable="org.matrix.login.sso",ei.Dummy="m.login.dummy",ei.RegistrationToken="m.login.registration_token",ei.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",ei}({});eo.AuthType=eg;class em extends Error{constructor(ei,eo,ea){super(ei),this.required_stages=eo,this.flows=ea,(0,ed.default)(this,"name","NoAuthFlowFoundError")}}eo.NoAuthFlowFoundError=em;class ey{constructor(ei){(0,ed.default)(this,"matrixClient",void 0),(0,ed.default)(this,"inputs",void 0),(0,ed.default)(this,"clientSecret",void 0),(0,ed.default)(this,"requestCallback",void 0),(0,ed.default)(this,"busyChangedCallback",void 0),(0,ed.default)(this,"stateUpdatedCallback",void 0),(0,ed.default)(this,"requestEmailTokenCallback",void 0),(0,ed.default)(this,"data",void 0),(0,ed.default)(this,"emailSid",void 0),(0,ed.default)(this,"requestingEmailToken",!1),(0,ed.default)(this,"attemptAuthDeferred",null),(0,ed.default)(this,"chosenFlow",null),(0,ed.default)(this,"currentStage",null),(0,ed.default)(this,"emailAttempt",1),(0,ed.default)(this,"submitPromise",null),(0,ed.default)(this,"requestEmailToken",async()=>{if(this.requestingEmailToken)eu.logger.warn("Could not request email token: Already requesting");else{eu.logger.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{let ei=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=ei.sid,eu.logger.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}}),this.matrixClient=ei.matrixClient,this.data=ei.authData||{},this.requestCallback=ei.doRequest,this.busyChangedCallback=ei.busyChanged,this.stateUpdatedCallback=ei.stateUpdated||ei.startAuthStage,this.requestEmailTokenCallback=ei.requestEmailToken,this.inputs=ei.inputs||{},ei.sessionId&&(this.data.session=ei.sessionId),this.clientSecret=ei.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=ei.emailSid}attemptAuth(){var ei,eo;this.attemptAuthDeferred=(0,eh.defer)();let ea=this.attemptAuthDeferred.promise;if(null!==(ei=this.data)&&void 0!==ei&&ei.flows)this.startNextAuthStage();else{null===(eo=this.busyChangedCallback)||void 0===eo||eo.call(this,!0);let ei=this.data.session?{session:this.data.session}:null;this.doRequest(ei).finally(()=>{var ei;null===(ei=this.busyChangedCallback)||void 0===ei||ei.call(this,!1)})}return ea}async poll(){if(!this.data.session||!this.attemptAuthDeferred||this.submitPromise)return;let ei={};if(this.currentStage==ef&&this.emailSid){let eo={sid:this.emailSid,client_secret:this.clientSecret};if(await this.matrixClient.doesServerRequireIdServerParam()){let ei=new URL(this.matrixClient.getIdentityServerUrl());eo.id_server=ei.host}ei={type:ef,threepid_creds:eo,threepidCreds:eo}}this.submitAuthDict(ei,!0)}getSessionId(){var ei;return null===(ei=this.data)||void 0===ei?void 0:ei.session}getClientSecret(){return this.clientSecret}getStageParams(ei){var eo;return null===(eo=this.data.params)||void 0===eo?void 0:eo[ei]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(ei,eo=!1){var ea,ec;let ed;if(!this.attemptAuthDeferred)throw Error("submitAuthDict() called before attemptAuth()");for(eo||null===(ea=this.busyChangedCallback)||void 0===ea||ea.call(this,!0);this.submitPromise;)try{await this.submitPromise}catch(ei){}this.data.session?Object.assign(ed={session:this.data.session},ei):ed=ei;try{this.submitPromise=this.doRequest(ed,eo),await this.submitPromise}finally{this.submitPromise=null,eo||null===(ec=this.busyChangedCallback)||void 0===ec||ec.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(ei){this.emailSid=ei}async doRequest(ei,eo=!1){try{let ea=await this.requestCallback(ei,eo);this.attemptAuthDeferred.resolve(ea),this.attemptAuthDeferred=null}catch(ep){var ea,ec,ed,eh;let ei=null!==(ea=null===(ec=ep.data)||void 0===ec?void 0:ec.flows)&&void 0!==ea?ea:null,ef=this.data.flows||!!ei;401===ep.httpStatus&&ep.data&&ef||(eo?eu.logger.log("Background poll request failed doing UI auth: ignoring",ep):null===(eh=this.attemptAuthDeferred)||void 0===eh||eh.reject(ep)),ep.data||(ep.data={}),ep.data.flows||ep.data.completed||ep.data.session||(ep.data.flows=this.data.flows,ep.data.completed=this.data.completed,ep.data.session=this.data.session),this.data=ep.data;try{this.startNextAuthStage()}catch(ei){this.attemptAuthDeferred.reject(ei),this.attemptAuthDeferred=null;return}if(!this.emailSid&&null!==(ed=this.chosenFlow)&&void 0!==ed&&ed.stages.includes(eg.Email))try{await this.requestEmailToken()}catch(ei){this.attemptAuthDeferred.reject(ei),this.attemptAuthDeferred=null}}}startNextAuthStage(){var ei,eo,ea,ec;let ed=this.chooseStage();if(!ed)throw Error("No incomplete flows from the server");if(this.currentStage=ed,ed===eg.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if(null!==(ei=this.data)&&void 0!==ei&&ei.errcode||null!==(eo=this.data)&&void 0!==eo&&eo.error){this.stateUpdatedCallback(ed,{errcode:(null===(ea=this.data)||void 0===ea?void 0:ea.errcode)||"",error:(null===(ec=this.data)||void 0===ec?void 0:ec.error)||""});return}this.stateUpdatedCallback(ed,ed===ef?{emailSid:this.emailSid}:{})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),eu.logger.log("Active flow => %s",JSON.stringify(this.chosenFlow));let ei=this.firstUncompletedStage(this.chosenFlow);return eu.logger.log("Next stage: %s",ei),ei}chooseFlow(){let ei=this.data.flows||[],eo=!!this.inputs.emailAddress||!!this.emailSid,ea=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;for(let ec of ei){let ei=!1,ed=!1;for(let eo of ec.stages)eo===ef?ei=!0:eo==ep&&(ed=!0);if(ei==eo&&ed==ea)return ec}let ec=[];throw eo&&ec.push(ef),ea&&ec.push(ep),new em("No appropriate authentication flow found",ec,ei)}firstUncompletedStage(ei){let eo=this.data.completed||[];return ei.stages.find(ei=>!eo.includes(ei))}}eo.InteractiveAuth=ey},7434:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.logger=void 0;var ed=ec(ea(2043));let eu="matrix";ed.default.methodFactory=function(ei,eo,ea){return function(...eo){this.prefix&&eo.unshift(this.prefix);let ea="error"===ei||"warn"===ei||"trace"===ei||"info"===ei;return ea?console[ei](...eo):console.log(...eo)}};let eh=ed.default.getLogger(eu);function ef(ei){ei.withPrefix=function(ei){let eo=this.prefix||"";return ep(eo+ei)}}function ep(ei){let eo=ed.default.getLogger(`${eu}-${ei}`);return eo.prefix!==ei&&(ef(eo),eo.prefix=ei,eo.setLevel(ed.default.levels.DEBUG,!1)),eo}eo.logger=eh,eh.setLevel(ed.default.levels.DEBUG,!1),ef(eh)},8070:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0});var ec={setCryptoStoreFactory:!0,createClient:!0,createRoomWidgetClient:!0,ContentHelpers:!0,SecretStorage:!0,createNewMatrixCall:!0,GroupCallEvent:!0,GroupCallIntent:!0,GroupCallState:!0,GroupCallType:!0,CryptoEvent:!0};eo.ContentHelpers=void 0,Object.defineProperty(eo,"CryptoEvent",{enumerable:!0,get:function(){return ez.CryptoEvent}}),Object.defineProperty(eo,"GroupCallEvent",{enumerable:!0,get:function(){return eH.GroupCallEvent}}),Object.defineProperty(eo,"GroupCallIntent",{enumerable:!0,get:function(){return eH.GroupCallIntent}}),Object.defineProperty(eo,"GroupCallState",{enumerable:!0,get:function(){return eH.GroupCallState}}),Object.defineProperty(eo,"GroupCallType",{enumerable:!0,get:function(){return eH.GroupCallType}}),eo.SecretStorage=void 0,eo.createClient=e0,Object.defineProperty(eo,"createNewMatrixCall",{enumerable:!0,get:function(){return eG.createNewMatrixCall}}),eo.createRoomWidgetClient=e1,eo.setCryptoStoreFactory=eX;var ed=ea(1045);Object.keys(ed).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===ed[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ed[ei]}}))});var eu=ea(1703);Object.keys(eu).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eu[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eu[ei]}}))});var eh=ea(9443);Object.keys(eh).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eh[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eh[ei]}}))});var ef=ea(2168);Object.keys(ef).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===ef[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ef[ei]}}))});var ep=ea(9810);Object.keys(ep).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===ep[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ep[ei]}}))});var eg=ea(95);Object.keys(eg).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eg[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eg[ei]}}))});var em=ea(9118);Object.keys(em).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===em[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return em[ei]}}))});var ey=ea(2741);Object.keys(ey).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===ey[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ey[ei]}}))});var eb=ea(9489);Object.keys(eb).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eb[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eb[ei]}}))});var eS=ea(3971);Object.keys(eS).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eS[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eS[ei]}}))});var eE=ea(4369);Object.keys(eE).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eE[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eE[ei]}}))});var ew=ea(7366);Object.keys(ew).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===ew[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ew[ei]}}))});var e_=ea(8910);Object.keys(e_).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===e_[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e_[ei]}}))});var eT=ea(3705);Object.keys(eT).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eT[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eT[ei]}}))});var eI=ea(5561);Object.keys(eI).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eI[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eI[ei]}}))});var eC=ea(2848);Object.keys(eC).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eC[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eC[ei]}}))});var eO=ea(6860);Object.keys(eO).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eO[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eO[ei]}}))});var eR=ea(3998);Object.keys(eR).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eR[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eR[ei]}}))});var ek=ea(7906);Object.keys(ek).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===ek[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ek[ei]}}))});var eM=ea(4969);Object.keys(eM).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eM[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eM[ei]}}))});var eP=ea(8670);Object.keys(eP).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eP[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eP[ei]}}))});var eA=ea(1415);Object.keys(eA).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eA[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eA[ei]}}))});var eD=ea(9789);Object.keys(eD).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eD[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eD[ei]}}))});var ej=ea(7585);Object.keys(ej).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===ej[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ej[ei]}}))});var eL=ea(3667);Object.keys(eL).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eL[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eL[ei]}}))});var eN=ea(2481);Object.keys(eN).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eN[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eN[ei]}}))});var eU=ea(1470);Object.keys(eU).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eU[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eU[ei]}}))});var eB=ea(4702);Object.keys(eB).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eB[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eB[ei]}}))});var eF=ea(6513);Object.keys(eF).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eF[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eF[ei]}}))});var eK=ea(9162);Object.keys(eK).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===eK[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eK[ei]}}))});var e$=ea(5205);Object.keys(e$).forEach(function(ei){!("default"===ei||"__esModule"===ei||Object.prototype.hasOwnProperty.call(ec,ei))&&(ei in eo&&eo[ei]===e$[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e$[ei]}}))});var eW=eJ(ea(4656));eo.ContentHelpers=eW;var eV=eJ(ea(1891));eo.SecretStorage=eV;var eG=ea(9679),eH=ea(8969),ez=ea(2600);function eY(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eY=function(ei){return ei?ea:eo})(ei)}function eJ(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eY(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let eQ=()=>new ed.MemoryCryptoStore;function eX(ei){eQ=ei}function eZ(ei){var eo,ec,ed;return ei.store=null!==(eo=ei.store)&&void 0!==eo?eo:new eu.MemoryStore({localStorage:ea.g.localStorage}),ei.scheduler=null!==(ec=ei.scheduler)&&void 0!==ec?ec:new eh.MatrixScheduler,ei.cryptoStore=null!==(ed=ei.cryptoStore)&&void 0!==ed?ed:eQ(),ei}function e0(ei){return new ef.MatrixClient(eZ(ei))}function e1(ei,eo,ea,ec){return new ep.RoomWidgetClient(ei,eo,ea,eZ(ec))}},8807:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MSC3089Branch=void 0;var ed=ec(ea(8416)),eu=ea(2481),eh=ea(8910);function ef(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ep(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ef(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ef(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}class eg{constructor(ei,eo,ea){this.client=ei,this.indexEvent=eo,this.directory=ea}get id(){let ei=this.indexEvent.getStateKey();if(!ei)throw Error("State key not found for branch");return ei}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var ei;return null!==(ei=this.indexEvent.getContent().version)&&void 0!==ei?ei:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,eu.UNSTABLE_MSC3089_BRANCH.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);let ei=(await this.getVersionHistory())[1];ei&&await ei.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(ei){await this.client.sendStateEvent(this.roomId,eu.UNSTABLE_MSC3089_BRANCH.name,ep(ep({},this.indexEvent.getContent()),{},{name:ei}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(ei){await this.client.sendStateEvent(this.roomId,eu.UNSTABLE_MSC3089_BRANCH.name,ep(ep({},this.indexEvent.getContent()),{},{locked:ei}),this.id)}async getFileInfo(){let ei=await this.getFileEvent(),eo=ei.getOriginalContent().file,ea=this.client.mxcUrlToHttp(eo.url);if(!ea)throw Error(`No HTTP URL available for ${eo.url}`);return{info:eo,httpUrl:ea}}async getFileEvent(){let ei=this.client.getRoom(this.roomId);if(!ei)throw Error("Unknown room");let eo=ei.getUnfilteredTimelineSet().findEventById(this.id);for(;!eo&&ei.getLiveTimeline().getState(eh.EventTimeline.BACKWARDS).paginationToken;)await this.client.scrollback(ei,100),eo=ei.getUnfilteredTimelineSet().findEventById(this.id);if(!eo)throw Error("Failed to find event");return await this.client.decryptEventIfNeeded(eo,{emit:!0,isRetry:!0}),eo}async createNewVersion(ei,eo,ea,ec){let ed=await this.directory.createFile(ei,eo,ea,ep(ep({},null!=ec?ec:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:eu.RelationType.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,eu.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:ei,version:this.version+1},ed.event_id),await this.client.sendStateEvent(this.roomId,eu.UNSTABLE_MSC3089_BRANCH.name,ep(ep({},this.indexEvent.getContent()),{},{active:!1}),this.id),ed}async getVersionHistory(){let ei;let eo=[];eo.push(this);let ea=this.client.getRoom(this.roomId);if(!ea)throw Error("Invalid or unknown room");let ec=[...ea.getLiveTimeline().getEvents()].reverse(),ed=await this.getFileEvent();do if(ei=ec.find(ei=>ei.replacingEventId()===ed.getId())){let ea=this.directory.getFile(ei.getId());if(ea)eo.push(ea),ed=ei;else break}while(ei);return eo}}eo.MSC3089Branch=eg},6170:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.TreePermissions=eo.MSC3089TreeSpace=eo.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=void 0;var ed=ec(ea(8416)),eu=ec(ea(2693)),eh=ea(2481),ef=ea(7434),ep=ea(3102),eg=ea(8807),em=ea(7125);function ey(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eb(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ey(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ey(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let eS={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[eh.EventType.RoomPowerLevels]:100,[eh.EventType.RoomHistoryVisibility]:100,[eh.EventType.RoomTombstone]:100,[eh.EventType.RoomEncryption]:100,[eh.EventType.RoomName]:50,[eh.EventType.RoomMessage]:50,[eh.EventType.RoomMessageEncrypted]:50,[eh.EventType.Sticker]:50},users:{}};eo.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=eS;let eE=function(ei){return ei.Viewer="viewer",ei.Editor="editor",ei.Owner="owner",ei}({});eo.TreePermissions=eE;class ew{constructor(ei,eo){if(this.client=ei,this.roomId=eo,(0,ed.default)(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){let ei=this.room.currentState.getStateEvents(eh.EventType.SpaceParent);return null==ei||!ei.length||ei.every(ei=>{var eo;return!(null!==(eo=ei.getContent())&&void 0!==eo&&eo.via)})}async setName(ei){await this.client.sendStateEvent(this.roomId,eh.EventType.RoomName,{name:ei},"")}async invite(ei,eo=!0,ea=!0){let ec=[this.retryInvite(ei)];return eo&&ec.push(...this.getDirectories().map(ec=>ec.invite(ei,eo,ea))),Promise.all(ec).then(()=>{ea&&(0,em.isRoomSharedHistory)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[ei])})}retryInvite(ei){return(0,ep.simpleRetryOperation)(async()=>{await this.client.invite(this.roomId,ei).catch(ei=>{if((null==ei?void 0:ei.errcode)==="M_FORBIDDEN")throw new eu.default.AbortError(ei);throw ei})})}async setPermissions(ei,eo){var ea;let ec=this.room.currentState.getStateEvents(eh.EventType.RoomPowerLevels,"");if(Array.isArray(ec))throw Error("Unexpected return type for power levels");let ed=(null==ec?void 0:ec.getContent())||{},eu=ed.users_default||0,ef=ed.events_default||50,ep=(null===(ea=ed.events)||void 0===ea?void 0:ea[eh.EventType.RoomPowerLevels])||100,eg=ed.users||{};switch(eo){case eE.Viewer:eg[ei]=eu;break;case eE.Editor:eg[ei]=ef;break;case eE.Owner:eg[ei]=ep;break;default:throw Error("Invalid role: "+eo)}ed.users=eg,await this.client.sendStateEvent(this.roomId,eh.EventType.RoomPowerLevels,ed,"")}getPermissions(ei){var eo,ea;let ec=this.room.currentState.getStateEvents(eh.EventType.RoomPowerLevels,"");if(Array.isArray(ec))throw Error("Unexpected return type for power levels");let ed=(null==ec?void 0:ec.getContent())||{},eu=ed.users_default||0,ef=ed.events_default||50,ep=(null===(eo=ed.events)||void 0===eo?void 0:eo[eh.EventType.RoomPowerLevels])||100,eg=(null===(ea=ed.users)||void 0===ea?void 0:ea[ei])||eu;return eg>=ep?eE.Owner:eg>=ef?eE.Editor:eE.Viewer}async createDirectory(ei){let eo=await this.client.unstableCreateFileTree(ei);return await this.client.sendStateEvent(this.roomId,eh.EventType.SpaceChild,{via:[this.client.getDomain()]},eo.roomId),await this.client.sendStateEvent(eo.roomId,eh.EventType.SpaceParent,{via:[this.client.getDomain()]},this.roomId),eo}getDirectories(){let ei=[],eo=this.room.currentState.getStateEvents(eh.EventType.SpaceChild);for(let ea of eo)try{let eo=ea.getStateKey();if(eo){let ea=this.client.unstableGetFileTreeSpace(eo);ea&&ei.push(ea)}}catch(ei){ef.logger.warn("Unable to create tree space instance for listing. Are we joined?",ei)}return ei}getDirectory(ei){return this.getDirectories().find(eo=>eo.roomId===ei)}async delete(){let ei=this.getDirectories();for(let eo of ei)await eo.delete();let eo=["invite","knock","join"],ea=this.room.currentState.getStateEvents(eh.EventType.RoomMember);for(let ei of ea){let ea=ei.getStateKey()!==this.client.getUserId();if(ea&&eo.includes(ei.getContent().membership)){let eo=ei.getStateKey();if(!eo)throw Error("State key not found for branch");await this.client.kick(this.roomId,eo,"Room deleted")}}await this.client.leave(this.roomId)}getOrderedChildren(ei){let eo=ei.map(ei=>({roomId:ei.getStateKey(),order:ei.getContent().order})).filter(ei=>ei.roomId);return eo.sort((ei,eo)=>{if(ei.order&&!eo.order)return -1;if(!ei.order&&eo.order)return 1;if(ei.order||eo.order)return(0,ep.lexicographicCompare)(ei.order,eo.order);{var ea,ec,ed,eu;let ef=this.client.getRoom(ei.roomId),eg=this.client.getRoom(eo.roomId);if(!ef||!eg)return(0,ep.lexicographicCompare)(ei.roomId,eo.roomId);let em=null!==(ea=null===(ec=ef.currentState.getStateEvents(eh.EventType.RoomCreate,""))||void 0===ec?void 0:ec.getTs())&&void 0!==ea?ea:0,ey=null!==(ed=null===(eu=eg.currentState.getStateEvents(eh.EventType.RoomCreate,""))||void 0===eu?void 0:eu.getTs())&&void 0!==ed?ed:0;return em===ey?(0,ep.lexicographicCompare)(ei.roomId,eo.roomId):em-ey}}),eo}getParentRoom(){let ei=this.room.currentState.getStateEvents(eh.EventType.SpaceParent),eo=ei[0];if(!eo)throw Error("Expected to have a parent in a non-top level space");let ea=eo.getStateKey();if(!ea)throw Error("No state key found for parent");let ec=this.client.getRoom(ea);if(!ec)throw Error("Unable to locate room for parent");return ec}getOrder(){if(this.isTopLevel)return -1;let ei=this.getParentRoom(),eo=ei.currentState.getStateEvents(eh.EventType.SpaceChild),ea=this.getOrderedChildren(eo);return ea.findIndex(ei=>ei.roomId===this.roomId)}async setOrder(ei){var eo,ea;if(this.isTopLevel)throw Error("Cannot set order of top level spaces currently");let ec=this.getParentRoom(),ed=ec.currentState.getStateEvents(eh.EventType.SpaceChild),eu=this.getOrderedChildren(ed);ei=Math.max(Math.min(ei,eu.length-1),0);let ef=this.getOrder(),eg=ef<ei;eg&&ei===eu.length-1?ei--:!eg&&0===ei&&ei++;let em=eu[eg?ei:ei-1],ey=eu[eg?ei+1:ei],eS=ep.DEFAULT_ALPHABET[0],eE=!1;if(em){if(ei===eu.length-1)null!=ey&&ey.order&&(eS=(0,ep.nextString)(ey.order));else{let ei=null==em?void 0:em.order,eo=null==ey?void 0:ey.order;ei&&eo?eS=ei===eo?(0,ep.nextString)(ei):(0,ep.averageBetweenStrings)(ei,eo):ei?eS=(0,ep.nextString)(ei):eo?eS=(0,ep.prevString)(eo):eE=!0}}else null!=ey&&ey.order&&(eS=(0,ep.prevString)(ey.order));if(eE){let eo;for(let ed=0;ed<=ei;ed++){let ei=eu[ed];if(0===ed&&(eo=ei.order),ei.order)eo=ei.order;else{eo=eo?(0,ep.nextString)(eo):ep.DEFAULT_ALPHABET[0];let ed=ec.currentState.getStateEvents(eh.EventType.SpaceChild,ei.roomId),eu=null!==(ea=null==ed?void 0:ed.getContent())&&void 0!==ea?ea:{via:[this.client.getDomain()]};await this.client.sendStateEvent(ec.roomId,eh.EventType.SpaceChild,eb(eb({},eu),{},{order:eo}),ei.roomId)}}eo&&(eS=(0,ep.nextString)(eo))}let ew=ec.currentState.getStateEvents(eh.EventType.SpaceChild,this.roomId),e_=null!==(eo=null==ew?void 0:ew.getContent())&&void 0!==eo?eo:{via:[this.client.getDomain()]};await this.client.sendStateEvent(ec.roomId,eh.EventType.SpaceChild,eb(eb({},e_),{},{order:eS}),this.roomId)}async createFile(ei,eo,ea,ec){var ed;let{content_uri:eu}=await this.client.uploadContent(eo,{includeFilename:!1});ea.url=eu;let ef={msgtype:eh.MsgType.File,body:ei,url:eu,file:ea};(ec=null!==(ed=ec)&&void 0!==ed?ed:{})["m.new_content"]&&(ec["m.new_content"]=ef);let ep=await this.client.sendMessage(this.roomId,eb(eb(eb({},ec),ef),{},{[eh.UNSTABLE_MSC3089_LEAF.name]:{}}));return await this.client.sendStateEvent(this.roomId,eh.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:ei},ep.event_id),ep}getFile(ei){let eo=this.room.currentState.getStateEvents(eh.UNSTABLE_MSC3089_BRANCH.name,ei);return eo?new eg.MSC3089Branch(this.client,eo,this):null}listFiles(){return this.listAllFiles().filter(ei=>ei.isActive)}listAllFiles(){var ei;let eo=null!==(ei=this.room.currentState.getStateEvents(eh.UNSTABLE_MSC3089_BRANCH.name))&&void 0!==ei?ei:[];return eo.map(ei=>new eg.MSC3089Branch(this.client,ei,this))}}eo.MSC3089TreeSpace=ew},3971:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.isTimestampInDuration=eo.getBeaconInfoIdentifier=eo.BeaconEvent=eo.Beacon=void 0;var ed=ec(ea(8416)),eu=ea(4656),eh=ea(3102),ef=ea(5861);let ep=function(ei){return ei.New="Beacon.new",ei.Update="Beacon.update",ei.LivenessChange="Beacon.LivenessChange",ei.Destroy="Beacon.Destroy",ei.LocationUpdate="Beacon.LocationUpdate",ei}({});eo.BeaconEvent=ep;let eg=(ei,eo,ea)=>ea>=ei&&ei+eo>=ea;eo.isTimestampInDuration=eg;let em=ei=>`${ei.getRoomId()}_${ei.getStateKey()}`;eo.getBeaconInfoIdentifier=em;class ey extends ef.TypedEventEmitter{constructor(ei){super(),this.rootEvent=ei,(0,ed.default)(this,"roomId",void 0),(0,ed.default)(this,"_beaconInfo",void 0),(0,ed.default)(this,"_isLive",void 0),(0,ed.default)(this,"livenessWatchTimeout",void 0),(0,ed.default)(this,"_latestLocationEvent",void 0),(0,ed.default)(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(ep.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return em(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,eu.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(ei){if(em(ei)!==this.identifier)throw Error("Invalid updating event");ei.getTs()<this.rootEvent.getTs()||(this.rootEvent=ei,this.setBeaconInfo(this.rootEvent),this.emit(ep.Update,ei,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(ep.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo){if(this.isLive){let ei=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();ei>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},ei))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}}addLocations(ei){var eo;if(!this.isLive)return;let ea=ei.filter(ei=>{let eo=ei.getContent(),ea=(0,eu.parseBeaconContent)(eo);if(!ea.uri||!ea.timestamp)return!1;let{timestamp:ec}=ea;return this._beaconInfo.timestamp&&eg(this._beaconInfo.timestamp,this._beaconInfo.timeout,ec)&&(!this.latestLocationState||ec>this.latestLocationState.timestamp)}),ec=null===(eo=ea.sort(eh.sortEventsByLatestContentTimestamp))||void 0===eo?void 0:eo[0];ec&&(this._latestLocationEvent=ec,this.emit(ep.LocationUpdate,this.latestLocationState))}setBeaconInfo(ei){this._beaconInfo=(0,eu.parseBeaconInfoContent)(ei.getContent()),this.checkLiveness()}checkLiveness(){let ei=this.isLive;if(!this.beaconInfo)return;let eo=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!eo&&eg(eo,this._beaconInfo.timeout,Date.now()),ei!==this.isLive&&this.emit(ep.LivenessChange,this.isLive,this)}}eo.Beacon=ey},3558:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.EventContext=void 0;var ed=ec(ea(8416)),eu=ea(8910);class eh{constructor(ei){this.ourEvent=ei,(0,ed.default)(this,"timeline",void 0),(0,ed.default)(this,"ourEventIndex",0),(0,ed.default)(this,"paginateTokens",{[eu.Direction.Backward]:null,[eu.Direction.Forward]:null}),this.timeline=[ei]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(ei=!1){return this.paginateTokens[ei?eu.Direction.Backward:eu.Direction.Forward]}setPaginateToken(ei,eo=!1){this.paginateTokens[eo?eu.Direction.Backward:eu.Direction.Forward]=null!=ei?ei:null}addEvents(ei,eo=!1){eo?(this.timeline=ei.concat(this.timeline),this.ourEventIndex+=ei.length):this.timeline=this.timeline.concat(ei)}}eo.EventContext=eh},8881:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.EventStatus=void 0;let ea=function(ei){return ei.NOT_SENT="not_sent",ei.ENCRYPTING="encrypting",ei.SENDING="sending",ei.QUEUED="queued",ei.SENT="sent",ei.CANCELLED="cancelled",ei}({});eo.EventStatus=ea},3705:function(ei,eo,ea){"use strict";let ec;var ed=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.EventTimelineSet=eo.DuplicateStrategy=void 0;var eu=ed(ea(8416)),eh=ea(8910),ef=ea(7434),ep=ea(7366),eg=ea(5861),em=ea(7286);let ey=!0;ec=ey?ef.logger.log.bind(ef.logger):function(){};let eb=function(ei){return ei.Ignore="ignore",ei.Replace="replace",ei}({});eo.DuplicateStrategy=eb;class eS extends eg.TypedEventEmitter{constructor(ei,eo={},ea,ec,ed=null){var ef,ep,eg;super(),this.room=ei,this.thread=ec,this.threadListType=ed,(0,eu.default)(this,"relations",void 0),(0,eu.default)(this,"timelineSupport",void 0),(0,eu.default)(this,"displayPendingEvents",void 0),(0,eu.default)(this,"liveTimeline",void 0),(0,eu.default)(this,"timelines",void 0),(0,eu.default)(this,"_eventIdToTimeline",new Map),(0,eu.default)(this,"filter",void 0),this.timelineSupport=!!eo.timelineSupport,this.liveTimeline=new eh.EventTimeline(this),this.displayPendingEvents=!1!==eo.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=eo.filter,this.relations=null!==(ef=null===(ep=this.room)||void 0===ep?void 0:ep.relations)&&void 0!==ef?ef:new em.RelationsContainer(null!==(eg=null==ei?void 0:ei.client)&&void 0!==eg?eg:ea)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(ei){this.filter=ei}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(ei){this.liveTimeline=ei}eventIdToTimeline(ei){return this._eventIdToTimeline.get(ei)}replaceEventId(ei,eo){let ea=this._eventIdToTimeline.get(ei);ea&&(this._eventIdToTimeline.delete(ei),this._eventIdToTimeline.set(eo,ea))}resetLiveTimeline(ei,eo){let ea=!this.timelineSupport||!eo,ec=this.liveTimeline,ed=ea?ec.forkLive(eh.EventTimeline.FORWARDS):ec.fork(eh.EventTimeline.FORWARDS);ea?(this.timelines=[ed],this._eventIdToTimeline=new Map):this.timelines.push(ed),eo&&ec.setPaginationToken(eo,eh.EventTimeline.FORWARDS),ed.setPaginationToken(null!=ei?ei:null,eh.EventTimeline.BACKWARDS),this.liveTimeline=ed,this.emit(ep.RoomEvent.TimelineReset,this.room,this,ea)}getTimelineForEvent(ei){if(null==ei)return null;let eo=this._eventIdToTimeline.get(ei);return void 0===eo?null:eo}findEventById(ei){let eo=this.getTimelineForEvent(ei);if(eo)return eo.getEvents().find(function(eo){return eo.getId()==ei})}addTimeline(){if(!this.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");let ei=new eh.EventTimeline(this);return this.timelines.push(ei),ei}addEventsToTimeline(ei,eo,ea,ed){if(!ea)throw Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!eo&&ea==this.liveTimeline)throw Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(ei=this.filter.filterRoomTimeline(ei)).length)return;let eu=eo?eh.EventTimeline.BACKWARDS:eh.EventTimeline.FORWARDS,ep=eo?eh.EventTimeline.FORWARDS:eh.EventTimeline.BACKWARDS,eg=!1,em=!1;for(let ed of ei){let ei=ed.getId(),ey=this._eventIdToTimeline.get(ei);if(!ey){this.addEventToTimeline(ed,ea,{toStartOfTimeline:eo}),em=!0,eg=!0;continue}if(em=!1,ey==ea){ec("Event "+ei+" already in timeline "+ea);continue}let eb=ea.getNeighbouringTimeline(eu);if(eb){ey==eb?ec("Event "+ei+" in neighbouring timeline - switching to "+ey):ec("Event "+ei+" already in a different timeline "+ey),ea=ey;continue}ef.logger.info("Already have timeline for "+ei+" - joining timeline "+ea+" to "+ey);let eS=ey===this.liveTimeline,eE=ea===this.liveTimeline,ew=eu===eh.EventTimeline.BACKWARDS&&eS,e_=eu===eh.EventTimeline.FORWARDS&&eE;if(ew||e_){ew&&ef.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+ey+")"),e_&&ef.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+ea+")");continue}ea.setNeighbouringTimeline(ey,eu),ey.setNeighbouringTimeline(ea,ep),ea=ey,eg=!0}if(em||!eg){if(eu===eh.EventTimeline.FORWARDS&&ea===this.liveTimeline){ef.logger.warn({lastEventWasNew:em,didUpdate:eg}),ef.logger.warn(`Refusing to set forwards pagination token of live timeline ${ea} to ${ed}`);return}ea.setPaginationToken(null!=ed?ed:null,eu)}}addLiveEvent(ei,eo,ea=!1,ed){let eu,ep=eo||eb.Ignore;if("object"==typeof eo?{duplicateStrategy:ep=eb.Ignore,fromCache:ea=!1,roomState:ed,timelineWasEmpty:eu}=eo:void 0!==eo&&ef.logger.warn("Overload deprecated: `EventTimelineSet.addLiveEvent(event, duplicateStrategy?, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addLiveEvent(event, IAddLiveEventOptions)`"),this.filter){let eo=this.filter.filterRoomTimeline([ei]);if(!eo.length)return}let eg=this._eventIdToTimeline.get(ei.getId());if(eg){if(ep===eb.Replace){ec("EventTimelineSet.addLiveEvent: replacing duplicate event "+ei.getId());let eo=eg.getEvents();for(let ea=0;ea<eo.length;ea++)if(eo[ea].getId()===ei.getId()){ed||(ed=eg.getState(eh.EventTimeline.FORWARDS)),eh.EventTimeline.setEventMetadata(ei,ed,!1),eo[ea]=ei;break}}else ec("EventTimelineSet.addLiveEvent: ignoring duplicate event "+ei.getId());return}this.addEventToTimeline(ei,this.liveTimeline,{toStartOfTimeline:!1,fromCache:ea,roomState:ed,timelineWasEmpty:eu})}addEventToTimeline(ei,eo,ea,ec=!1,ed){var eu,eh;let eg,em=!!ea;if("object"==typeof ea?{toStartOfTimeline:em,fromCache:ec=!1,roomState:ed,timelineWasEmpty:eg}=ea:void 0!==ea&&ef.logger.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),eo.getTimelineSet()!==this)throw Error(`EventTimelineSet.addEventToTimeline: Timeline=${eo.toString()} does not belong " +
                "in timelineSet(threadId=${null===(eu=this.thread)||void 0===eu?void 0:eu.id})`);if(this.room&&!this.canContain(ei)){let ea=`event=${ei.getId()}`;ei.threadRootId&&(ea+=`(belongs to thread=${ei.threadRootId})`),ef.logger.warn(`EventTimelineSet.addEventToTimeline: Ignoring ${ea} that does not belong in timeline=${eo.toString()} timelineSet(threadId=${null===(eh=this.thread)||void 0===eh?void 0:eh.id})`);return}let ey=ei.getId();eo.addEvent(ei,{toStartOfTimeline:em,roomState:ed,timelineWasEmpty:eg}),this._eventIdToTimeline.set(ey,eo),this.relations.aggregateParentEvent(ei),this.relations.aggregateChildEvent(ei,this);let eb={timeline:eo,liveEvent:!em&&eo==this.liveTimeline&&!ec};this.emit(ep.RoomEvent.Timeline,ei,this.room,!!em,!1,eb)}handleRemoteEcho(ei,eo,ea){let ec=this._eventIdToTimeline.get(eo);ec?(this._eventIdToTimeline.delete(eo),this._eventIdToTimeline.set(ea,ec)):(!this.filter||this.filter.filterRoomTimeline([ei]).length)&&this.addEventToTimeline(ei,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(ei){let eo=this._eventIdToTimeline.get(ei);if(!eo)return null;let ea=eo.removeEvent(ei);if(ea){this._eventIdToTimeline.delete(ei);let ec={timeline:eo};this.emit(ep.RoomEvent.Timeline,ea,this.room,void 0,!0,ec)}return ea}compareEventOrdering(ei,eo){if(ei==eo)return 0;let ea=this._eventIdToTimeline.get(ei),ec=this._eventIdToTimeline.get(eo);if(void 0===ea||void 0===ec)return null;if(ea===ec){let ec,ed;let eu=ea.getEvents();for(let ea=0;ea<eu.length&&(void 0===ec||void 0===ed);ea++){let eh=eu[ea].getId();eh==ei&&(ec=ea),eh==eo&&(ed=ea)}return ec-ed}let ed=ea;for(;ed;){if(ed===ec)return -1;ed=ed.getNeighbouringTimeline(eh.EventTimeline.FORWARDS)}for(ed=ea;ed;){if(ed===ec)return 1;ed=ed.getNeighbouringTimeline(eh.EventTimeline.BACKWARDS)}return null}canContain(ei){if(!this.room)throw Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");let{threadId:eo,shouldLiveInRoom:ea}=this.room.eventShouldLiveIn(ei);return this.thread?this.thread.id===eo:ea}}eo.EventTimelineSet=eS},8910:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.EventTimeline=eo.Direction=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(6860),ef=ea(2481);let ep=function(ei){return ei.Backward="b",ei.Forward="f",ei}({});eo.Direction=ep;class eg{static setEventMetadata(ei,eo,ea){var ec,ed,eu,eh;null!==(ec=ei.sender)&&void 0!==ec&&null!==(ed=ec.events)&&void 0!==ed&&ed.member||(ei.sender=eo.getSentinelMember(ei.getSender())),null!==(eu=ei.target)&&void 0!==eu&&null!==(eh=eu.events)&&void 0!==eh&&eh.member||ei.getType()!==ef.EventType.RoomMember||(ei.target=eo.getSentinelMember(ei.getStateKey())),ei.isState()&&ea&&(ei.forwardLooking=!1)}constructor(ei){var eo,ea;this.eventTimelineSet=ei,(0,ed.default)(this,"roomId",void 0),(0,ed.default)(this,"name",void 0),(0,ed.default)(this,"events",[]),(0,ed.default)(this,"baseIndex",0),(0,ed.default)(this,"startState",void 0),(0,ed.default)(this,"endState",void 0),(0,ed.default)(this,"startToken",null),(0,ed.default)(this,"endToken",null),(0,ed.default)(this,"prevTimeline",null),(0,ed.default)(this,"nextTimeline",null),(0,ed.default)(this,"paginationRequests",{[ep.Backward]:null,[ep.Forward]:null}),this.roomId=null!==(eo=null===(ea=ei.room)||void 0===ea?void 0:ea.roomId)&&void 0!==eo?eo:null,this.roomId&&(this.startState=new eh.RoomState(this.roomId),this.endState=new eh.RoomState(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(ei,{timelineWasEmpty:eo}={}){var ea,ec;if(this.events.length>0)throw Error("Cannot initialise state after events are added");null===(ea=this.startState)||void 0===ea||ea.setStateEvents(ei,{timelineWasEmpty:eo}),null===(ec=this.endState)||void 0===ec||ec.setStateEvents(ei,{timelineWasEmpty:eo})}forkLive(ei){let eo=this.getState(ei),ea=new eg(this.eventTimelineSet);return ea.startState=null==eo?void 0:eo.clone(),ea.endState=eo,this.endState=null==eo?void 0:eo.clone(),ea}fork(ei){let eo=this.getState(ei),ea=new eg(this.eventTimelineSet);return ea.startState=null==eo?void 0:eo.clone(),ea.endState=null==eo?void 0:eo.clone(),ea}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(ei){if(ei==eg.BACKWARDS)return this.startState;if(ei==eg.FORWARDS)return this.endState;throw Error("Invalid direction '"+ei+"'")}getPaginationToken(ei){return this.roomId?this.getState(ei).paginationToken:ei===ep.Backward?this.startToken:this.endToken}setPaginationToken(ei,eo){this.roomId?this.getState(eo).paginationToken=ei:eo===ep.Backward?this.startToken=ei:this.endToken=ei}getNeighbouringTimeline(ei){if(ei==eg.BACKWARDS)return this.prevTimeline;if(ei==eg.FORWARDS)return this.nextTimeline;throw Error("Invalid direction '"+ei+"'")}setNeighbouringTimeline(ei,eo){if(this.getNeighbouringTimeline(eo))throw Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+eo+")");if(eo==eg.BACKWARDS)this.prevTimeline=ei;else if(eo==eg.FORWARDS)this.nextTimeline=ei;else throw Error("Invalid direction '"+eo+"'");this.setPaginationToken(null,eo)}addEvent(ei,eo,ea){let ec,ed,eh=!!eo;"object"==typeof eo?{toStartOfTimeline:eh,roomState:ea,timelineWasEmpty:ec}=eo:void 0!==eo&&eu.logger.warn("Overload deprecated: `EventTimeline.addEvent(event, toStartOfTimeline, roomState?)` is deprecated in favor of the overload with `EventTimeline.addEvent(event, IAddEventOptions)`"),ea||(ea=eh?this.startState:this.endState);let ep=this.getTimelineSet();if(ep.room&&(eg.setEventMetadata(ei,ea,eh),ei.isState()&&ep.room.getUnfilteredTimelineSet()===ep)){var em;null===(em=ea)||void 0===em||em.setStateEvents([ei],{timelineWasEmpty:ec}),ei.sender&&(ei.getType()!==ef.EventType.RoomMember||eh)||eg.setEventMetadata(ei,ea,eh)}ed=eh?0:this.events.length,this.events.splice(ed,0,ei),eh&&this.baseIndex++}removeEvent(ei){for(let eo=this.events.length-1;eo>=0;eo--){let ea=this.events[eo];if(ea.getId()==ei)return this.events.splice(eo,1),eo<this.baseIndex&&this.baseIndex--,ea}return null}toString(){return this.name}}eo.EventTimeline=eg,(0,ed.default)(eg,"BACKWARDS",ep.Backward),(0,ed.default)(eg,"FORWARDS",ep.Forward)},4369:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),Object.defineProperty(eo,"EventStatus",{enumerable:!0,get:function(){return eE.EventStatus}}),eo.MatrixEventEvent=eo.MatrixEvent=void 0;var ed=ec(ea(8416)),eu=ea(1333),eh=ea(7434),ef=ea(2481),ep=ea(3102),eg=ea(6969),em=ea(771),ey=ea(5861),eb=ea(1994),eS=ea(2573),eE=ea(8881);let ew=Object.freeze({visible:!0}),e_=function(ei){return ei.Decrypted="Event.decrypted",ei.BeforeRedaction="Event.beforeRedaction",ei.VisibilityChange="Event.visibilityChange",ei.LocalEventIdReplaced="Event.localEventIdReplaced",ei.Status="Event.status",ei.Replaced="Event.replaced",ei.RelationsCreated="Event.relationsCreated",ei}({});eo.MatrixEventEvent=e_;class eT extends ey.TypedEventEmitter{constructor(ei={}){var eo;super(),this.event=ei,(0,ed.default)(this,"pushDetails",{}),(0,ed.default)(this,"_replacingEvent",null),(0,ed.default)(this,"_localRedactionEvent",null),(0,ed.default)(this,"_isCancelled",!1),(0,ed.default)(this,"clearEvent",void 0),(0,ed.default)(this,"visibility",ew),(0,ed.default)(this,"_hasCachedExtEv",!1),(0,ed.default)(this,"_cachedExtEv",void 0),(0,ed.default)(this,"senderCurve25519Key",null),(0,ed.default)(this,"claimedEd25519Key",null),(0,ed.default)(this,"forwardingCurve25519KeyChain",[]),(0,ed.default)(this,"untrusted",null),(0,ed.default)(this,"decryptionPromise",null),(0,ed.default)(this,"retryDecryption",!1),(0,ed.default)(this,"txnId",void 0),(0,ed.default)(this,"thread",void 0),(0,ed.default)(this,"threadId",void 0),(0,ed.default)(this,"encryptedDisabledForUnverifiedDevices",!1),(0,ed.default)(this,"localTimestamp",void 0),(0,ed.default)(this,"sender",null),(0,ed.default)(this,"target",null),(0,ed.default)(this,"status",null),(0,ed.default)(this,"error",null),(0,ed.default)(this,"forwardLooking",!0),(0,ed.default)(this,"verificationRequest",void 0),(0,ed.default)(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(eo=>{"string"==typeof ei[eo]&&(ei[eo]=(0,ep.internaliseString)(ei[eo]))}),["membership","avatar_url","displayname"].forEach(eo=>{var ea;"string"==typeof(null===(ea=ei.content)||void 0===ea?void 0:ea[eo])&&(ei.content[eo]=(0,ep.internaliseString)(ei.content[eo]))}),["rel_type"].forEach(eo=>{var ea,ec;"string"==typeof(null===(ea=ei.content)||void 0===ea?void 0:null===(ec=ea["m.relates_to"])||void 0===ec?void 0:ec[eo])&&(ei.content["m.relates_to"][eo]=(0,ep.internaliseString)(ei.content["m.relates_to"][eo]))}),this.txnId=ei.txn_id,this.localTimestamp=Date.now()-(null!==(eo=this.getAge())&&void 0!==eo?eo:0),this.reEmitter=new em.TypedReEmitter(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=eu.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){let ei=Object.assign({},this.getContent());if(this.getWireType()===ef.EventType.RoomMessageEncrypted)for(let[eo,ea]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(eo)||void 0!==ei[eo]||(ei[eo]=ea);return Object.assign({},this.event,this.clearEvent,{content:ei})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){let ei=`id=${this.getId()} type=${this.getWireType()} sender=${this.getSender()}`,eo=this.getRoomId();eo&&(ei+=` room=${eo}`);let ea=this.getDate();return ea&&(ei+=` ts=${ea.toISOString()}`),ei}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var ei,eo;let ea=null===(ei=this.getWireContent())||void 0===ei?void 0:ei["m.relates_to"];return(null==ea?void 0:ea.rel_type)===eg.THREAD_RELATION_TYPE.name?ea.event_id:(null===(eo=this.getThread())||void 0===eo?void 0:eo.id)||this.threadId}get isThreadRoot(){var ei;let eo=this.getServerAggregatedRelation(eg.THREAD_RELATION_TYPE.name);return!!eo||(null===(ei=this.getThread())||void 0===ei?void 0:ei.id)===this.getId()}get replyEventId(){var ei,eo;return null===(ei=this.getWireContent()["m.relates_to"])||void 0===ei?void 0:null===(eo=ei["m.in_reply_to"])||void 0===eo?void 0:eo.event_id}get relationEventId(){var ei,eo;return null===(ei=this.getWireContent())||void 0===ei?void 0:null===(eo=ei["m.relates_to"])||void 0===eo?void 0:eo.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(ei,eo,ea,ec){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=ei,this.event.content=eo,this.senderCurve25519Key=ea,this.claimedEd25519Key=ec}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){var ei,eo;return(null===(ei=this.clearEvent)||void 0===ei?void 0:null===(eo=ei.content)||void 0===eo?void 0:eo.msgtype)==="m.bad.encrypted"}get isEncryptedDisabledForUnverifiedDevices(){return this.isDecryptionFailure()&&this.encryptedDisabledForUnverifiedDevices}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted())&&!this.clearEvent&&!!this.isEncrypted()}async attemptDecryption(ei,eo={}){if(!this.isEncrypted())throw Error("Attempt to decrypt event which isn't encrypted");let ea=this.clearEvent&&!this.isDecryptionFailure(),ec=eo.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(ea&&!ec)throw Error("Attempt to decrypt event which has already been decrypted");return this.decryptionPromise?(eh.logger.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this.decryptionPromise):(this.decryptionPromise=this.decryptionLoop(ei,eo),this.decryptionPromise)}cancelAndResendKeyRequest(ei,eo){let ea=this.getWireContent();return ei.requestRoomKey({algorithm:ea.algorithm,room_id:this.getRoomId(),session_id:ea.session_id,sender_key:ea.sender_key},this.getKeyRequestRecipients(eo),!0)}getKeyRequestRecipients(ei){let eo=[{userId:ei,deviceId:"*"}];return eo}async decryptionLoop(ei,eo={}){for(await Promise.resolve();;){let ea,ec;this.retryDecryption=!1;try{ei?(ea=await ei.decryptEvent(this),!0===eo.isRetry&&eh.logger.info(`Decrypted event on retry (${this.getDetails()})`)):ea=this.badEncryptedMessage("Encryption not enabled")}catch(eo){let ei=eo instanceof eb.DecryptionError?eo.detailedString:String(eo);if(ec=eo,this.retryDecryption){eh.logger.log(`Error decrypting event (${this.getDetails()}), but retrying: ${ei}`);continue}eh.logger.warn(`Error decrypting event (${this.getDetails()}): ${ei}`),ea=this.badEncryptedMessage(String(eo))}this.decryptionPromise=null,this.retryDecryption=!1,this.setClearData(ea),this.setPushDetails(),!1!==eo.emit&&this.emit(e_.Decrypted,this,ec);return}}badEncryptedMessage(ei){return{clearEvent:{type:ef.EventType.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+ei+" **"}},encryptedDisabledForUnverifiedDevices:ei===`DecryptionError: ${eS.WITHHELD_MESSAGES["m.unverified"]}`}}setClearData(ei){var eo,ea;this.clearEvent=ei.clearEvent,this.senderCurve25519Key=null!==(eo=ei.senderCurve25519Key)&&void 0!==eo?eo:null,this.claimedEd25519Key=null!==(ea=ei.claimedEd25519Key)&&void 0!==ea?ea:null,this.forwardingCurve25519KeyChain=ei.forwardingCurve25519KeyChain||[],this.untrusted=ei.untrusted||!1,this.encryptedDisabledForUnverifiedDevices=ei.encryptedDisabledForUnverifiedDevices||!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===ef.EventType.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(ei){this.event.unsigned=ei}unmarkLocallyRedacted(){let ei=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!ei}markLocallyRedacted(ei){this._localRedactionEvent||(this.emit(e_.BeforeRedaction,this,ei),this._localRedactionEvent=ei,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=ei.event)}applyVisibilityEvent(ei){var eo,ea;let ec=null===(eo=null==ei?void 0:ei.visible)||void 0===eo||eo,ed=null!==(ea=null==ei?void 0:ei.reason)&&void 0!==ea?ea:null,eu=!1;this.visibility.visible!==ec?eu=!0:this.visibility.visible||this.visibility.reason===ed||(eu=!0),eu&&(ec?this.visibility=ew:this.visibility=Object.freeze({visible:!1,reason:ed}),this.emit(e_.VisibilityChange,this,ec))}messageVisibility(){return this.visibility}makeRedacted(ei){if(!ei.event)throw Error("invalid redactionEvent in makeRedacted");for(let eo in this._localRedactionEvent=null,this.emit(e_.BeforeRedaction,this,ei),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=ei.event,this.event)this.event.hasOwnProperty(eo)&&!eI.has(eo)&&delete this.event[eo];this.isEncrypted()&&(this.clearEvent=void 0);let eo=this.getType() in eC?eC[this.getType()]:{},ea=this.getContent();for(let ei in ea)ea.hasOwnProperty(ei)&&!eo[ei]&&delete ea[ei];this.invalidateExtensibleEvent()}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===ef.EventType.RoomRedaction}asVisibilityChange(){if(!ef.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType()))return null;let ei=this.getRelation();if(!ei||"m.reference"!=ei.rel_type)return null;let eo=ei.event_id;if(!eo)return null;let ea=this.getWireContent(),ec=!!ea.visible,ed=ea.reason;return ed&&"string"!=typeof ed?null:{visible:ec,reason:ed,eventId:eo}}isVisibilityEvent(){return ef.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType())}getRedactionEvent(){var ei,eo,ea,ec;return this.isRedacted()?null!==(ei=this.clearEvent)&&void 0!==ei&&ei.unsigned?null!==(ea=null===(ec=this.clearEvent)||void 0===ec?void 0:ec.unsigned.redacted_because)&&void 0!==ea?ea:null:null!==(eo=this.event.unsigned)&&void 0!==eo&&eo.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushActions(ei){this.pushDetails={actions:ei||void 0}}setPushDetails(ei,eo){this.pushDetails={actions:ei,rule:eo}}handleRemoteEcho(ei){let eo=this.getUnsigned(),ea=this.getId();this.event=ei,eo.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=eo.redacted_because),this.setStatus(null),this.getId()!==ea&&this.emit(e_.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(ei){this.status=ei,this.emit(e_.Status,this,ei)}replaceLocalEventId(ei){this.event.event_id=ei,this.emit(e_.LocalEventIdReplaced,this)}isRelation(ei){var eo;let ea=null===(eo=this.getWireContent())||void 0===eo?void 0:eo["m.relates_to"];return(!this.isState()||(null==ea?void 0:ea.rel_type)!==ef.RelationType.Replace)&&!!(null!=ea&&ea.rel_type&&ea.event_id&&(!ei||ea.rel_type===ei))}getRelation(){var ei;return this.isRelation()&&null!==(ei=this.getWireContent()["m.relates_to"])&&void 0!==ei?ei:null}makeReplaced(ei){this.isRedacted()&&ei||this.isState()||this._replacingEvent===ei||(this._replacingEvent=null!=ei?ei:null,this.emit(e_.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(ei){var eo;return null===(eo=this.getUnsigned()["m.relations"])||void 0===eo?void 0:eo[ei]}replacingEventId(){let ei=this.getServerAggregatedRelation(ef.RelationType.Replace);return ei?ei.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){let ei=this.getServerAggregatedRelation(ef.RelationType.Replace);if(ei){let eo=ei.origin_server_ts;if(Number.isFinite(eo))return new Date(eo)}else if(this._replacingEvent){var eo;return null!==(eo=this._replacingEvent.getDate())&&void 0!==eo?eo:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){let ei=this.getRelation();return this.replyEventId?this.replyEventId:ei?ei.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(ei){let eo=this.getRelation();eo?eo.event_id=ei:this.isRedaction()&&(this.event.redacts=ei)}flagCancelled(ei=!0){this._isCancelled=ei}isCancelled(){return this._isCancelled}toSnapshot(){let ei=new eT(JSON.parse(JSON.stringify(this.event)));for(let[eo,ea]of Object.entries(this))"event"!==eo&&(ei[eo]=ea);return ei}isEquivalentTo(ei){if(!ei)return!1;if(ei===this)return!0;let eo=(0,ep.deepSortedObjectEntries)(this.event),ea=(0,ep.deepSortedObjectEntries)(ei.event);return JSON.stringify(eo)===JSON.stringify(ea)}toJSON(){let ei=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:ei,encrypted:this.event}:ei}setVerificationRequest(ei){this.verificationRequest=ei}setTxnId(ei){this.txnId=ei}getTxnId(){return this.txnId}setThread(ei){this.thread&&this.reEmitter.stopReEmitting(this.thread,[eg.ThreadEvent.Update]),this.thread=ei,this.setThreadId(null==ei?void 0:ei.id),ei&&this.reEmitter.reEmit(ei,[eg.ThreadEvent.Update])}getThread(){return this.thread}setThreadId(ei){this.threadId=ei}}eo.MatrixEvent=eT;let eI=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),eC={[ef.EventType.RoomMember]:{membership:1},[ef.EventType.RoomCreate]:{creator:1},[ef.EventType.RoomJoinRules]:{join_rule:1},[ef.EventType.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},8515:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.PolicyScope=eo.POLICIES_ACCOUNT_EVENT_TYPE=eo.IgnoredInvites=eo.IGNORE_INVITES_ACCOUNT_EVENT_KEY=void 0;var ec=ea(1333),ed=ea(8910),eu=ea(4702),eh=ea(3102);let ef=new ec.UnstableValue("m.policies","org.matrix.msc3847.policies");eo.POLICIES_ACCOUNT_EVENT_TYPE=ef;let ep=new ec.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites");eo.IGNORE_INVITES_ACCOUNT_EVENT_KEY=ep;var eg=function(ei){return ei.Ban="m.ban",ei}(eg||{});let em=function(ei){return ei.User="m.policy.user",ei.Room="m.policy.room",ei.Server="m.policy.server",ei}({});eo.PolicyScope=em;class ey{constructor(ei){this.client=ei}async addRule(ei,eo,ea){let ec=await this.getOrCreateTargetRoom(),ed=await this.client.sendStateEvent(ec.roomId,ei,{entity:eo,reason:ea,recommendation:eg.Ban});return ed.event_id}async removeRule(ei){await this.client.redactEvent(ei.getRoomId(),ei.getId())}async addSource(ei){await this.client.joinRoom(ei);let eo=(await this.getOrCreateSourceRooms()).map(ei=>ei.roomId);return!eo.includes(ei)&&(eo.push(ei),await this.withIgnoreInvitesPolicies(ei=>{ei.sources=eo}),!0)}async getRuleForInvite({sender:ei,roomId:eo}){let ea=await this.getOrCreateSourceRooms(),ec=ei.split(":")[1],eu=eo.split(":")[1];for(let ef of ea){let ea=ef.getUnfilteredTimelineSet().getLiveTimeline().getState(ed.EventTimeline.FORWARDS);for(let{scope:ed,entities:ef}of[{scope:em.Room,entities:[eo]},{scope:em.User,entities:[ei]},{scope:em.Server,entities:[ec,eu]}]){let ei=ea.getStateEvents(ed);for(let eo of ei){let ei;let ea=eo.getContent();if((null==ea?void 0:ea.recommendation)!=eg.Ban)continue;let ec=null==ea?void 0:ea.entity;if(ec){try{ei=new RegExp((0,eh.globToRegexp)(ec,!1))}catch(ei){continue}for(let ea of ef)if(ea&&ei.test(ea))return eo}}}}return null}async getOrCreateTargetRoom(){let ei=this.getIgnoreInvitesPolicies(),eo=ei.target;if("string"!=typeof eo&&(eo=null),eo){let ei=this.client.getRoom(eo);if(ei)return ei;eo=null}return eo=(await this.client.createRoom({name:"Individual Policy Room",preset:eu.Preset.PrivateChat})).room_id,await this.withIgnoreInvitesPolicies(ei=>{ei.target=eo}),this.client.getRoom(eo)}async getOrCreateSourceRooms(){let ei=this.getIgnoreInvitesPolicies(),eo=ei.sources,ea=!1;Array.isArray(eo)||(ea=!0,eo=[]);let ec=eo.filter(ei=>"string"==typeof ei).map(ei=>this.client.getRoom(ei)).filter(ei=>!!ei);if(ec.length!=eo.length&&(ea=!0),0==ec.length){let ei=await this.getOrCreateTargetRoom();ea=!0,ec=[ei]}return ea&&await this.withIgnoreInvitesPolicies(ei=>{ei.sources=eo}),ec}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(ei){let{policies:eo,ignoreInvitesPolicies:ea}=this.getPoliciesAndIgnoreInvitesPolicies();ei(ea),eo[ep.name]=ea,await this.client.setAccountData(ef.name,eo)}getPoliciesAndIgnoreInvitesPolicies(){let ei={};for(let ea of[ef.name,ef.altName]){var eo;if(!ea)continue;let ec=null===(eo=this.client.getAccountData(ea))||void 0===eo?void 0:eo.getContent();if(ec){ei=ec;break}}let ea={},ec=!1;for(let eo of[ep.name,ep.altName]){if(!eo)continue;let ed=ei[eo];if(ed&&"object"==typeof ed){ea=ed,ec=!0;break}}return ec||(ei[ep.name]=ea),{policies:ei,ignoreInvitesPolicies:ea}}}eo.IgnoredInvites=ey},5561:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.isPollEvent=eo.PollEvent=eo.Poll=void 0;var ed=ec(ea(8416)),eu=ea(1333),eh=ea(5931),ef=ea(9690),ep=ea(5861);let eg=function(ei){return ei.New="Poll.new",ei.End="Poll.end",ei.Update="Poll.update",ei.Responses="Poll.Responses",ei.Destroy="Poll.Destroy",ei.UndecryptableRelations="Poll.UndecryptableRelations",ei}({});eo.PollEvent=eg;let em=(ei,eo)=>{let ea=ei.filter(ei=>{if(!ei.isDecryptionFailure())return eh.M_POLL_RESPONSE.matches(ei.getType())&&ei.getTs()<=eo});return{responseEvents:ea}};class ey extends ep.TypedEventEmitter{constructor(ei,eo,ea){if(super(),this.rootEvent=ei,this.matrixClient=eo,this.room=ea,(0,ed.default)(this,"roomId",void 0),(0,ed.default)(this,"pollEvent",void 0),(0,ed.default)(this,"_isFetchingResponses",!1),(0,ed.default)(this,"relationsNextBatch",void 0),(0,ed.default)(this,"responses",null),(0,ed.default)(this,"endEvent",void 0),(0,ed.default)(this,"undecryptableRelationEventIds",new Set),(0,ed.default)(this,"countUndecryptableEvents",ei=>{let eo=ei.filter(ei=>ei.isDecryptionFailure()).map(ei=>ei.getId()),ea=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...eo]),this.undecryptableRelationsCount!==ea&&this.emit(eg.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var ei;return null===(ei=this.endEvent)||void 0===ei?void 0:ei.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}async getResponses(){return this.responses||this.isFetchingResponses||await this.fetchResponses(),this.responses}onNewRelation(ei){var eo;if(eh.M_POLL_END.matches(ei.getType())&&this.validateEndEvent(ei)&&(this.endEvent=ei,this.refilterResponsesOnEnd(),this.emit(eg.End)),!this.responses)return;let ea=(null===(eo=this.endEvent)||void 0===eo?void 0:eo.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:ec}=em([ei],ea);this.countUndecryptableEvents([ei]),ec.length&&(ec.forEach(ei=>{this.responses.addEvent(ei)}),this.emit(eg.Responses,this.responses))}async fetchResponses(){var ei,eo;this._isFetchingResponses=!0;let ea=await this.matrixClient.relations(this.roomId,this.rootEvent.getId(),"m.reference",void 0,{from:this.relationsNextBatch||void 0});await Promise.all(ea.events.map(ei=>this.matrixClient.decryptEventIfNeeded(ei)));let ec=this.responses||new ef.Relations("m.reference",eh.M_POLL_RESPONSE.name,this.matrixClient,[eh.M_POLL_RESPONSE.altName]),ed=ea.events.find(ei=>eh.M_POLL_END.matches(ei.getType()));this.validateEndEvent(ed)&&(this.endEvent=ed,this.refilterResponsesOnEnd(),this.emit(eg.End));let eu=(null===(ei=this.endEvent)||void 0===ei?void 0:ei.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:ep}=em(ea.events,eu);ep.forEach(ei=>{ec.addEvent(ei)}),this.relationsNextBatch=null!==(eo=ea.nextBatch)&&void 0!==eo?eo:void 0,this.responses=ec,this.countUndecryptableEvents(ea.events),this.relationsNextBatch?this.fetchResponses():this._isFetchingResponses=!1,this.emit(eg.Responses,this.responses)}refilterResponsesOnEnd(){var ei;if(!this.responses)return;let eo=(null===(ei=this.endEvent)||void 0===ei?void 0:ei.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(ei=>{if(ei.getTs()>eo){var ea;null===(ea=this.responses)||void 0===ea||ea.removeEvent(ei)}}),this.emit(eg.Responses,this.responses)}validateEndEvent(ei){if(!ei||this.endEvent&&this.endEvent.getTs()<ei.getTs())return!1;let eo=this.room.currentState,ea=ei.getSender();return!!ea&&(ea===this.rootEvent.getSender()||eo.maySendRedactionForEvent(this.rootEvent,ea))}}eo.Poll=ey;let eb=ei=>{let eo=ei.getType();return eu.M_POLL_START.matches(eo)||eh.M_POLL_RESPONSE.matches(eo)||eh.M_POLL_END.matches(eo)};eo.isPollEvent=eb},2958:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.ReadReceipt=void 0,eo.synthesizeReceipt=eS;var ed=ec(ea(8416)),eu=ea(5550),eh=ea(5861),ef=eb(ea(3102)),ep=ea(4369),eg=ea(2481),em=ea(7366);function ey(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ey=function(ei){return ei?ea:eo})(ei)}function eb(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ey(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function eS(ei,eo,ea){var ec;return new ep.MatrixEvent({content:{[eo.getId()]:{[ea]:{[ei]:{ts:eo.getTs(),thread_id:null!==(ec=eo.threadRootId)&&void 0!==ec?ec:eu.MAIN_ROOM_TIMELINE}}}},type:eg.EventType.Receipt,room_id:eo.getRoomId()})}let eE=0,ew=1;class e_ extends eh.TypedEventEmitter{constructor(...ei){super(...ei),(0,ed.default)(this,"receipts",new ef.MapWithDefault(()=>new Map)),(0,ed.default)(this,"receiptCacheByEventId",new Map),(0,ed.default)(this,"timeline",void 0)}getReadReceiptForUserId(ei,eo=!1,ea=eu.ReceiptType.Read){var ec,ed;let[eh,ef]=null!==(ec=null===(ed=this.receipts.get(ea))||void 0===ed?void 0:ed.get(ei))&&void 0!==ec?ec:[null,null];return eo?eh:null!=ef?ef:eh}getEventReadUpTo(ei,eo=!1){var ea,ec,ed,eh,ef,ep,eg;let em;let ey=this.getUnfilteredTimelineSet(),eb=this.getReadReceiptForUserId(ei,eo,eu.ReceiptType.Read),eS=this.getReadReceiptForUserId(ei,eo,eu.ReceiptType.ReadPrivate);return(null!=eb&&eb.eventId&&null!=eS&&eS.eventId&&(em=ey.compareEventOrdering(null==eb?void 0:eb.eventId,null==eS?void 0:eS.eventId)),!em&&null!=eb&&null!==(ea=eb.data)&&void 0!==ea&&ea.ts&&null!=eS&&null!==(ec=eS.data)&&void 0!==ec&&ec.ts&&(em=(null==eb?void 0:null===(ep=eb.data)||void 0===ep?void 0:ep.ts)-(null==eS?void 0:null===(eg=eS.data)||void 0===eg?void 0:eg.ts)),em)?null!==(ef=em<0?null==eS?void 0:eS.eventId:null==eb?void 0:eb.eventId)&&void 0!==ef?ef:null:null!==(ed=null!==(eh=null==eS?void 0:eS.eventId)&&void 0!==eh?eh:null==eb?void 0:eb.eventId)&&void 0!==ed?ed:null}addReceiptToStructure(ei,eo,ea,ec,ed){var eu,eh,ef;let ep=this.receipts.getOrCreate(eo),eg=ep.get(ea);eg||(eg=[null,null],ep.set(ea,eg));let em=eg[eE];if(ed&&(em=null!==(ef=eg[ew])&&void 0!==ef?ef:eg[eE]),em){let eo=this.getUnfilteredTimelineSet().compareEventOrdering(em.eventId,ei);if(null!==eo&&eo>=0)return}let ey={eventId:ei,data:ec},eb=ed?eg[eE]:ey,eS=ed?ey:eg[ew],e_=null;eb&&eS&&(e_=this.getUnfilteredTimelineSet().compareEventOrdering(eb.eventId,eS.eventId));let eT=null===e_||e_<0,eI=null!==(eu=eg[ew])&&void 0!==eu?eu:eg[eE];ed&&eT?eg[ew]=ey:ed||(eg[eE]=ey,eT||(eg[ew]=null));let eC=null!==(eh=eg[ew])&&void 0!==eh?eh:eg[eE];if(eI!==eC){if(eI&&this.receiptCacheByEventId.get(eI.eventId)){let ei=eI.eventId;this.receiptCacheByEventId.set(ei,this.receiptCacheByEventId.get(ei).filter(ei=>ei.type!==eo||ei.userId!==ea)),this.receiptCacheByEventId.get(ei).length<1&&this.receiptCacheByEventId.delete(ei)}this.receiptCacheByEventId.get(ei)||this.receiptCacheByEventId.set(ei,[]),this.receiptCacheByEventId.get(ei).push({userId:ea,type:eo,data:ec})}}getReceiptsForEvent(ei){return this.receiptCacheByEventId.get(ei.getId())||[]}fixupNotifications(ei){let eo=this.getReadReceiptForUserId(ei,!1),ea=this.timeline[this.timeline.length-1];ea&&(null==eo?void 0:eo.eventId)===ea.getId()&&ei===ea.getSender()&&(this.setUnread(em.NotificationCountType.Total,0),this.setUnread(em.NotificationCountType.Highlight,0))}addLocalEchoReceipt(ei,eo,ea){this.addReceipt(eS(ei,eo,ea),!0)}getUsersReadUpTo(ei){return this.getReceiptsForEvent(ei).filter(function(ei){return ef.isSupportedReceiptType(ei.type)}).map(function(ei){return ei.userId})}hasUserReadEvent(ei,eo){var ea,ec;let ed=this.getEventReadUpTo(ei,!1);if(ed===eo||null!==(ea=this.timeline)&&void 0!==ea&&ea.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===ei)return!0;for(let ei=(null===(ec=this.timeline)||void 0===ec?void 0:ec.length)-1;ei>=0;--ei){let ea=this.timeline[ei];if(ea.getId()===eo)break;if(ea.getId()===ed)return!0}return!1}}eo.ReadReceipt=e_},7286:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RelationsContainer=void 0;var ed=ec(ea(8416)),eu=ea(9690),eh=ea(4369);class ef{constructor(ei,eo){this.client=ei,this.room=eo,(0,ed.default)(this,"relations",new Map)}getChildEventsForEvent(ei,eo,ea){var ec,ed;return null===(ec=this.relations.get(ei))||void 0===ec?void 0:null===(ed=ec.get(eo))||void 0===ed?void 0:ed.get(ea)}getAllChildEventsForEvent(ei){var eo;let ea=null!==(eo=this.relations.get(ei))&&void 0!==eo?eo:new Map,ec=[];for(let ei of ea.values())for(let eo of ei.values())ec.push(...eo.getRelations());return ec}aggregateParentEvent(ei){let eo=this.relations.get(ei.getId());if(eo)for(let ea of eo.values())for(let eo of ea.values())eo.setTargetEvent(ei)}aggregateChildEvent(ei,eo){if(ei.isRedacted()||ei.status===eh.EventStatus.CANCELLED)return;let ea=ei.getRelation();if(!ea)return;let ec=()=>{if(ei.isDecryptionFailure()){ei.once(eh.MatrixEventEvent.Decrypted,ec);return}this.aggregateChildEvent(ei,eo)};if(ei.isBeingDecrypted()||ei.shouldAttemptDecryption()){ei.once(eh.MatrixEventEvent.Decrypted,ec);return}let{event_id:ed,rel_type:ef}=ea,ep=ei.getType(),eg=this.relations.get(ed);eg||(eg=new Map,this.relations.set(ed,eg));let em=eg.get(ef);em||(em=new Map,eg.set(ef,em));let ey=em.get(ep);if(!ey){var eb,eS,eE;ey=new eu.Relations(ef,ep,this.client),em.set(ep,ey);let ei=null!==(eb=this.room)&&void 0!==eb?eb:null==eo?void 0:eo.room,ea=null!==(eS=null!==(eE=null==eo?void 0:eo.findEventById(ed))&&void 0!==eE?eE:null==ei?void 0:ei.findEventById(ed))&&void 0!==eS?eS:null==ei?void 0:ei.getPendingEvent(ed);ea&&ey.setTargetEvent(ea)}ey.addEvent(ei)}}eo.RelationsContainer=ef},9690:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RelationsEvent=eo.Relations=void 0;var ed=ec(ea(8416)),eu=ea(4369),eh=ea(7434),ef=ea(2481),ep=ea(5861),eg=ea(7366);let em=function(ei){return ei.Add="Relations.add",ei.Remove="Relations.remove",ei.Redaction="Relations.redaction",ei}({});eo.RelationsEvent=em;let ey=(ei,eo,ea=[])=>[eo,...ea].includes(ei);class eb extends ep.TypedEventEmitter{constructor(ei,eo,ea,ec){super(),this.relationType=ei,this.eventType=eo,this.altEventTypes=ec,(0,ed.default)(this,"relationEventIds",new Set),(0,ed.default)(this,"relations",new Set),(0,ed.default)(this,"annotationsByKey",{}),(0,ed.default)(this,"annotationsBySender",{}),(0,ed.default)(this,"sortedAnnotationsByKey",[]),(0,ed.default)(this,"targetEvent",null),(0,ed.default)(this,"creationEmitted",!1),(0,ed.default)(this,"client",void 0),(0,ed.default)(this,"onEventStatus",(ei,eo)=>{if(!ei.isSending()){ei.removeListener(eu.MatrixEventEvent.Status,this.onEventStatus);return}eo===eu.EventStatus.CANCELLED&&(ei.removeListener(eu.MatrixEventEvent.Status,this.onEventStatus),this.removeEvent(ei))}),(0,ed.default)(this,"onBeforeRedaction",async ei=>{if(this.relations.has(ei)){if(this.relations.delete(ei),this.relationType===ef.RelationType.Annotation)this.removeAnnotationFromAggregation(ei);else if(this.relationType===ef.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){let ei=await this.getLastReplacement();this.targetEvent.makeReplaced(ei)}ei.removeListener(eu.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(em.Redaction,ei)}}),this.client=ea instanceof eg.Room?ea.client:ea}async addEvent(ei){if(this.relationEventIds.has(ei.getId()))return;let eo=ei.getRelation();if(!eo){eh.logger.error("Event must have relation info");return}let ea=eo.rel_type,ec=ei.getType();if(this.relationType!==ea||!ey(ec,this.eventType,this.altEventTypes)){eh.logger.error("Event relation info doesn't match this container");return}if(ei.isSending()&&ei.on(eu.MatrixEventEvent.Status,this.onEventStatus),this.relations.add(ei),this.relationEventIds.add(ei.getId()),this.relationType===ef.RelationType.Annotation)this.addAnnotationToAggregation(ei);else if(this.relationType===ef.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){let ei=await this.getLastReplacement();this.targetEvent.makeReplaced(ei)}ei.on(eu.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(em.Add,ei),this.maybeEmitCreated()}async removeEvent(ei){if(this.relations.has(ei)){if(this.relations.delete(ei),this.relationType===ef.RelationType.Annotation)this.removeAnnotationFromAggregation(ei);else if(this.relationType===ef.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){let ei=await this.getLastReplacement();this.targetEvent.makeReplaced(ei)}this.emit(em.Remove,ei)}}getRelations(){return[...this.relations]}addAnnotationToAggregation(ei){var eo;let{key:ea}=null!==(eo=ei.getRelation())&&void 0!==eo?eo:{};if(!ea)return;let ec=this.annotationsByKey[ea];ec||(ec=this.annotationsByKey[ea]=new Set,this.sortedAnnotationsByKey.push([ea,ec])),ec.add(ei),this.sortedAnnotationsByKey.sort((ei,eo)=>{let ea=ei[1],ec=eo[1];return ec.size-ea.size});let ed=ei.getSender(),eu=this.annotationsBySender[ed];eu||(eu=this.annotationsBySender[ed]=new Set),eu.add(ei)}removeAnnotationFromAggregation(ei){var eo;let{key:ea}=null!==(eo=ei.getRelation())&&void 0!==eo?eo:{};if(!ea)return;let ec=this.annotationsByKey[ea];ec&&(ec.delete(ei),this.sortedAnnotationsByKey.sort((ei,eo)=>{let ea=ei[1],ec=eo[1];return ec.size-ea.size}));let ed=ei.getSender(),eu=this.annotationsBySender[ed];eu&&eu.delete(ei)}getSortedAnnotationsByKey(){return this.relationType!==ef.RelationType.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==ef.RelationType.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==ef.RelationType.Replace||!this.targetEvent)return null;let ei=this.targetEvent.getServerAggregatedRelation(ef.RelationType.Replace),eo=null==ei?void 0:ei.origin_server_ts,ea=this.getRelations().reduce((ei,ea)=>ea.getSender()!==this.targetEvent.getSender()||eo&&eo>ea.getTs()||ei&&ei.getTs()>ea.getTs()?ei:ea,null);return null!=ea&&ea.shouldAttemptDecryption()&&this.client.isCryptoEnabled()?await ea.attemptDecryption(this.client.crypto):null!=ea&&ea.isBeingDecrypted()&&await ea.getDecryptionPromise(),ea}async setTargetEvent(ei){if(!this.targetEvent){if(this.targetEvent=ei,this.relationType===ef.RelationType.Replace&&!this.targetEvent.isState()){let ei=await this.getLastReplacement();ei&&this.targetEvent.makeReplaced(ei)}this.maybeEmitCreated()}}maybeEmitCreated(){!this.creationEmitted&&this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(eu.MatrixEventEvent.RelationsCreated,this.relationType,this.eventType))}}eo.Relations=eb},2848:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomMemberEvent=eo.RoomMember=void 0;var ed=ec(ea(8416)),eu=ea(3667),eh=ey(ea(3102)),ef=ea(7434),ep=ea(5861),eg=ea(2481);function em(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(em=function(ei){return ei?ea:eo})(ei)}function ey(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=em(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let eb=function(ei){return ei.Membership="RoomMember.membership",ei.Name="RoomMember.name",ei.PowerLevel="RoomMember.powerLevel",ei.Typing="RoomMember.typing",ei}({});eo.RoomMemberEvent=eb;class eS extends ep.TypedEventEmitter{constructor(ei,eo){super(),this.roomId=ei,this.userId=eo,(0,ed.default)(this,"_isOutOfBand",!1),(0,ed.default)(this,"modified",-1),(0,ed.default)(this,"requestedProfileInfo",!1),(0,ed.default)(this,"typing",!1),(0,ed.default)(this,"name",void 0),(0,ed.default)(this,"rawDisplayName",void 0),(0,ed.default)(this,"powerLevel",0),(0,ed.default)(this,"powerLevelNorm",0),(0,ed.default)(this,"user",void 0),(0,ed.default)(this,"membership",void 0),(0,ed.default)(this,"disambiguate",!1),(0,ed.default)(this,"events",{}),this.name=eo,this.rawDisplayName=eo,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(ei,eo){var ea,ec;let ed=null!==(ea=ei.getDirectionalContent().displayname)&&void 0!==ea?ea:"";if(ei.getType()!==eg.EventType.RoomMember)return;this._isOutOfBand=!1,this.events.member=ei;let eu=this.membership;this.membership=ei.getDirectionalContent().membership,void 0===this.membership&&ef.logger.trace(`membership event with membership undefined (forwardLooking: ${ei.forwardLooking})!`,ei.getContent(),"prevcontent is ",ei.getPrevContent()),this.disambiguate=e_(this.userId,ed,eo);let ep=this.name;this.name=eT(this.userId,ed,this.disambiguate),this.rawDisplayName=eh.removeDirectionOverrideChars(null!==(ec=ei.getDirectionalContent().displayname)&&void 0!==ec?ec:""),this.rawDisplayName&&eh.removeHiddenChars(this.rawDisplayName)||(this.rawDisplayName=this.userId),eu!==this.membership&&(this.updateModifiedTime(),this.emit(eb.Membership,ei,this,eu)),ep!==this.name&&(this.updateModifiedTime(),this.emit(eb.Name,ei,this,ep))}setPowerLevelEvent(ei){if(ei.getType()!==eg.EventType.RoomPowerLevels||""!==ei.getStateKey())return;let eo=ei.getDirectionalContent(),ea=eo.users_default||0,ec=eo.users||{};Object.values(ec).forEach(ei=>{ea=Math.max(ea,ei)});let ed=this.powerLevel,eu=this.powerLevelNorm;void 0!==ec[this.userId]&&Number.isInteger(ec[this.userId])?this.powerLevel=ec[this.userId]:void 0!==eo.users_default?this.powerLevel=eo.users_default:this.powerLevel=0,this.powerLevelNorm=0,ea>0&&(this.powerLevelNorm=100*this.powerLevel/ea),(ed!==this.powerLevel||eu!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit(eb.PowerLevel,ei,this))}setTypingEvent(ei){if("m.typing"!==ei.getType())return;let eo=this.typing;this.typing=!1;let ea=ei.getContent().user_ids;Array.isArray(ea)&&(-1!==ea.indexOf(this.userId)&&(this.typing=!0),eo!==this.typing&&(this.updateModifiedTime(),this.emit(eb.Typing,ei,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return"leave"===this.membership&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){let ei=this.events.member,eo=ei.getContent(),ea=ei.getSender();if("join"===eo.membership&&(eo=ei.getPrevContent(),ea=ei.getUnsigned().prev_sender),"invite"===eo.membership&&eo.is_direct)return ea}}getAvatarUrl(ei,eo,ea,ec,ed=!0,eh){let ef=this.getMxcAvatarUrl();if(!ef&&!ed)return null;let ep=(0,eu.getHttpUriForMxc)(ei,ef,eo,ea,ec,eh);return ep||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}}eo.RoomMember=eS;let eE=/@.+:.+/,ew=/[\u200E\u200F\u202A-\u202F]/;function e_(ei,eo,ea){if(!eo||eo===ei||!eh.removeHiddenChars(eo)||!ea)return!1;if(eE.test(eo)||ew.test(eo))return!0;let ec=ea.getUserIdsWithDisplayName(eo);return!!ec.some(eo=>eo!==ei)}function eT(ei,eo,ea){return eo&&eo!==ei?ea?eh.removeDirectionOverrideChars(eo)+" ("+ei+")":eh.removeHiddenChars(eo)?eh.removeDirectionOverrideChars(eo):ei:ei}},6860:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomStateEvent=eo.RoomState=void 0;var ed=ec(ea(8416)),eu=ea(2848),eh=ea(7434),ef=e_(ea(3102)),ep=ea(2481),eg=ea(4369),em=ea(4702),ey=ea(5861),eb=ea(3971),eS=ea(771),eE=ea(5699);function ew(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ew=function(ei){return ei?ea:eo})(ei)}function e_(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ew(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}var eT=function(ei){return ei[ei.NotStarted=0]="NotStarted",ei[ei.InProgress=1]="InProgress",ei[ei.Finished=2]="Finished",ei}(eT||{});let eI=function(ei){return ei.Events="RoomState.events",ei.Members="RoomState.members",ei.NewMember="RoomState.newMember",ei.Update="RoomState.update",ei.BeaconLiveness="RoomState.BeaconLiveness",ei.Marker="RoomState.Marker",ei}({});eo.RoomStateEvent=eI;class eC extends ey.TypedEventEmitter{constructor(ei,eo={status:eT.NotStarted}){super(),this.roomId=ei,this.oobMemberFlags=eo,(0,ed.default)(this,"reEmitter",new eS.TypedReEmitter(this)),(0,ed.default)(this,"sentinels",{}),(0,ed.default)(this,"displayNameToUserIds",new Map),(0,ed.default)(this,"userIdsToDisplayNames",{}),(0,ed.default)(this,"tokenToInvite",{}),(0,ed.default)(this,"joinedMemberCount",null),(0,ed.default)(this,"summaryJoinedMemberCount",null),(0,ed.default)(this,"invitedMemberCount",null),(0,ed.default)(this,"summaryInvitedMemberCount",null),(0,ed.default)(this,"modified",-1),(0,ed.default)(this,"members",{}),(0,ed.default)(this,"events",new Map),(0,ed.default)(this,"paginationToken",null),(0,ed.default)(this,"beacons",new Map),(0,ed.default)(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce((ei,eo)=>"join"===eo.membership?ei+1:ei,0)),this.joinedMemberCount)}setJoinedMemberCount(ei){this.summaryJoinedMemberCount=ei}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce((ei,eo)=>"invite"===eo.membership?ei+1:ei,0)),this.invitedMemberCount)}setInvitedMemberCount(ei){this.summaryInvitedMemberCount=ei}getMembers(){return Object.values(this.members)}getMembersExcept(ei){return this.getMembers().filter(eo=>!ei.includes(eo.userId))}getMember(ei){return this.members[ei]||null}getSentinelMember(ei){if(!ei)return null;let eo=this.sentinels[ei];if(void 0===eo){eo=new eu.RoomMember(this.roomId,ei);let ea=this.members[ei];null!=ea&&ea.events.member&&eo.setMembershipEvent(ea.events.member,this),this.sentinels[ei]=eo}return eo}getStateEvents(ei,eo){if(!this.events.has(ei))return void 0===eo?[]:null;if(void 0===eo)return Array.from(this.events.get(ei).values());let ea=this.events.get(ei).get(eo);return ea||null}get hasLiveBeacons(){var ei;return!!(null!==(ei=this.liveBeaconIds)&&void 0!==ei&&ei.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){let ei=new eC(this.roomId,this.oobMemberFlags),eo=this.oobMemberFlags.status;return this.oobMemberFlags.status=eT.NotStarted,Array.from(this.events.values()).forEach(eo=>{ei.setStateEvents(Array.from(eo.values()))}),this.oobMemberFlags.status=eo,null!==this.summaryInvitedMemberCount&&ei.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&ei.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==eT.Finished&&this.getMembers().forEach(eo=>{if(eo.isOutOfBand()){var ea;null===(ea=ei.getMember(eo.userId))||void 0===ea||ea.markOutOfBand()}}),ei}setUnknownStateEvents(ei){let eo=ei.filter(ei=>!this.events.has(ei.getType())||!this.events.get(ei.getType()).has(ei.getStateKey()));this.setStateEvents(eo)}setStateEvents(ei,eo){this.updateModifiedTime(),ei.forEach(ei=>{if(ei.getRoomId()!==this.roomId||!ei.isState())return;eE.M_BEACON_INFO.matches(ei.getType())&&this.setBeacon(ei);let eo=this.getStateEventMatching(ei);if(this.setStateEvent(ei),ei.getType()===ep.EventType.RoomMember){var ea;this.updateDisplayNameCache(ei.getStateKey(),null!==(ea=ei.getContent().displayname)&&void 0!==ea?ea:""),this.updateThirdPartyTokenCache(ei)}this.emit(eI.Events,ei,this,eo)}),this.onBeaconLivenessChange(),ei.forEach(ei=>{if(ei.getRoomId()===this.roomId&&ei.isState()){if(ei.getType()===ep.EventType.RoomMember){let eo=ei.getStateKey();("leave"===ei.getContent().membership||"ban"===ei.getContent().membership)&&(ei.getContent().avatar_url=ei.getContent().avatar_url||ei.getPrevContent().avatar_url,ei.getContent().displayname=ei.getContent().displayname||ei.getPrevContent().displayname);let ea=this.getOrCreateMember(eo,ei);ea.setMembershipEvent(ei,this),this.updateMember(ea),this.emit(eI.Members,ei,this,ea)}else if(ei.getType()===ep.EventType.RoomPowerLevels){if(""!==ei.getStateKey())return;let eo=Object.values(this.members);eo.forEach(eo=>{let ea=eo.getLastModifiedTime();eo.setPowerLevelEvent(ei),ea!==eo.getLastModifiedTime()&&this.emit(eI.Members,ei,this,eo)}),this.sentinels={}}else ep.UNSTABLE_MSC2716_MARKER.matches(ei.getType())&&this.emit(eI.Marker,ei,eo)}}),this.emit(eI.Update,this)}async processBeaconEvents(ei,eo){if(!ei.length||!this.beacons.size)return;let ea=[...this.beacons.values()].reduce((ei,eo)=>(ei[eo.beaconInfoId]=eo,ei),{}),ec=(ei,eo)=>{if(!eE.M_BEACON.matches(eo.getType()))return;let ec=ea[ei];ec&&ec.addLocations([eo])};for(let eu of ei){var ed;let ei=null===(ed=eu.getRelation())||void 0===ed?void 0:ed.event_id;if(!ei||!ea[ei]||!eE.M_BEACON.matches(eu.getType())&&!eu.isEncrypted())return;try{await eo.decryptEventIfNeeded(eu),ec(ei,eu)}catch{eu.isDecryptionFailure()&&eu.once(eg.MatrixEventEvent.Decrypted,async()=>{ec(ei,eu)})}}}getOrCreateMember(ei,eo){let ea=this.members[ei];return ea||(ea=new eu.RoomMember(this.roomId,ei),this.members[ei]=ea,this.emit(eI.NewMember,eo,this,ea)),ea}setStateEvent(ei){this.events.has(ei.getType())||this.events.set(ei.getType(),new Map),this.events.get(ei.getType()).set(ei.getStateKey(),ei)}setBeacon(ei){let eo=(0,eb.getBeaconInfoIdentifier)(ei);if(this.beacons.has(eo)){let ec=this.beacons.get(eo);if(ei.isRedacted()){var ea;ec.beaconInfoId===(null===(ea=ei.getRedactionEvent())||void 0===ea?void 0:ea.redacts)&&(ec.destroy(),this.beacons.delete(eo));return}return ec.update(ei)}if(ei.isRedacted())return;let ec=new eb.Beacon(ei);this.reEmitter.reEmit(ec,[eb.BeaconEvent.New,eb.BeaconEvent.Update,eb.BeaconEvent.Destroy,eb.BeaconEvent.LivenessChange]),this.emit(eb.BeaconEvent.New,ei,ec),ec.on(eb.BeaconEvent.LivenessChange,this.onBeaconLivenessChange.bind(this)),ec.on(eb.BeaconEvent.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(ec.identifier,ec)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(ei=>ei.isLive).map(ei=>ei.identifier),this.emit(eI.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(ei){var eo,ea;return null!==(eo=null===(ea=this.events.get(ei.getType()))||void 0===ea?void 0:ea.get(ei.getStateKey()))&&void 0!==eo?eo:null}updateMember(ei){let eo=this.getStateEvents(ep.EventType.RoomPowerLevels,"");eo&&ei.setPowerLevelEvent(eo),delete this.sentinels[ei.userId],this.members[ei.userId]=ei,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===eT.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===eT.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===eT.NotStarted&&(this.oobMemberFlags.status=eT.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===eT.InProgress&&(this.oobMemberFlags.status=eT.NotStarted)}clearOutOfBandMembers(){let ei=0;Object.keys(this.members).forEach(eo=>{let ea=this.members[eo];ea.isOutOfBand()&&(++ei,delete this.members[eo])}),eh.logger.log(`LL: RoomState removed ${ei} members...`),this.oobMemberFlags.status=eT.NotStarted}setOutOfBandMembers(ei){eh.logger.log(`LL: RoomState about to set ${ei.length} OOB members ...`),this.oobMemberFlags.status===eT.InProgress&&(eh.logger.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=eT.Finished,ei.forEach(ei=>this.setOutOfBandMember(ei)),this.emit(eI.Update,this))}setOutOfBandMember(ei){if(ei.getType()!==ep.EventType.RoomMember)return;let eo=ei.getStateKey(),ea=this.getMember(eo);if(ea&&!ea.isOutOfBand())return;let ec=this.getOrCreateMember(eo,ei);ec.setMembershipEvent(ei,this),ec.markOutOfBand(),this.updateDisplayNameCache(ec.userId,ec.name),this.setStateEvent(ei),this.updateMember(ec),this.emit(eI.Members,ei,this,ec)}setTypingEvent(ei){Object.values(this.members).forEach(function(eo){eo.setTypingEvent(ei)})}getInviteForThreePidToken(ei){return this.tokenToInvite[ei]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(ei){var eo;return null!==(eo=this.displayNameToUserIds.get(ef.removeHiddenChars(ei)))&&void 0!==eo?eo:[]}maySendRedactionForEvent(ei,eo){let ea=this.getMember(eo);if(!ea||"leave"===ea.membership||ei.status||ei.isRedacted())return!1;let ec=this.maySendEvent(ep.EventType.RoomRedaction,eo);return ei.getSender()===eo?ec:this.hasSufficientPowerLevelFor("redact",ea.powerLevel)}hasSufficientPowerLevelFor(ei,eo){let ea=this.getStateEvents(ep.EventType.RoomPowerLevels,""),ec={};ea&&(ec=ea.getContent());let ed=50;return ef.isNumber(ec[ei])&&(ed=ec[ei]),eo>=ed}maySendMessage(ei){return this.maySendEventOfType(ep.EventType.RoomMessage,ei,!1)}maySendEvent(ei,eo){return this.maySendEventOfType(ei,eo,!1)}mayClientSendStateEvent(ei,eo){return!eo.isGuest()&&!!eo.credentials.userId&&this.maySendStateEvent(ei,eo.credentials.userId)}maySendStateEvent(ei,eo){return this.maySendEventOfType(ei,eo,!0)}maySendEventOfType(ei,eo,ea){let ec;let ed=this.getStateEvents(ep.EventType.RoomPowerLevels,""),eu={},eh=0,ef=0,eg=0;if(ed){eu=(ec=ed.getContent()).events||{},eh=Number.isSafeInteger(ec.state_default)?ec.state_default:50;let ei=ec.users&&ec.users[eo];Number.isSafeInteger(ei)?eg=ei:Number.isSafeInteger(ec.users_default)&&(eg=ec.users_default),Number.isSafeInteger(ec.events_default)&&(ef=ec.events_default)}let em=ea?eh:ef;return Number.isSafeInteger(eu[ei])&&(em=eu[ei]),eg>=em}mayTriggerNotifOfType(ei,eo){let ea=this.getMember(eo);if(!ea)return!1;let ec=this.getStateEvents(ep.EventType.RoomPowerLevels,""),ed=50;return ec&&ec.getContent()&&ec.getContent().notifications&&ef.isNumber(ec.getContent().notifications[ei])&&(ed=ec.getContent().notifications[ei]),ea.powerLevel>=ed}getJoinRule(){var ei;let eo=this.getStateEvents(ep.EventType.RoomJoinRules,""),ea=null!==(ei=null==eo?void 0:eo.getContent())&&void 0!==ei?ei:{};return ea.join_rule||em.JoinRule.Invite}getHistoryVisibility(){var ei;let eo=this.getStateEvents(ep.EventType.RoomHistoryVisibility,""),ea=null!==(ei=null==eo?void 0:eo.getContent())&&void 0!==ei?ei:{};return ea.history_visibility||em.HistoryVisibility.Shared}getGuestAccess(){var ei;let eo=this.getStateEvents(ep.EventType.RoomGuestAccess,""),ea=null!==(ei=null==eo?void 0:eo.getContent())&&void 0!==ei?ei:{};return ea.guest_access||em.GuestAccess.Forbidden}findPredecessor(ei=!1){if(ei){let ei=this.getStateEvents(ep.EventType.RoomPredecessor,"");if(ei){let eo=ei.getContent(),ea=eo.predecessor_room_id,ec=eo.last_known_event_id;"string"!=typeof ec&&(ec=void 0);let ed=eo.via_servers;if(Array.isArray(ed)||(ed=void 0),"string"==typeof ea)return{roomId:ea,eventId:ec,viaServers:ed}}}let eo=this.getStateEvents(ep.EventType.RoomCreate,"");if(eo){let ei=eo.getContent().predecessor;if(ei){let eo=ei.room_id;if("string"==typeof eo){let ea=ei.event_id;return("string"!=typeof ea||""===ea)&&(ea=void 0),{roomId:eo,eventId:ea}}}}return null}updateThirdPartyTokenCache(ei){if(!ei.getContent().third_party_invite)return;let eo=(ei.getContent().third_party_invite.signed||{}).token;if(!eo)return;let ea=this.getStateEvents(ep.EventType.RoomThirdPartyInvite,eo);ea&&(this.tokenToInvite[eo]=ei)}updateDisplayNameCache(ei,eo){let ea=this.userIdsToDisplayNames[ei];if(delete this.userIdsToDisplayNames[ei],ea){let eo=ef.removeHiddenChars(ea),ec=this.displayNameToUserIds.get(eo);if(ec){let ea=ec.filter(eo=>eo!==ei);this.displayNameToUserIds.set(eo,ea)}}this.userIdsToDisplayNames[ei]=eo;let ec=eo&&ef.removeHiddenChars(eo);if(ec){var ed;let eo=null!==(ed=this.displayNameToUserIds.get(ec))&&void 0!==ed?ed:[];eo.push(ei),this.displayNameToUserIds.set(ec,eo)}}}eo.RoomState=eC},5205:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomSummary=void 0;class ea{constructor(ei,eo){this.roomId=ei}}eo.RoomSummary=ea},7366:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomNameType=eo.RoomEvent=eo.Room=eo.NotificationCountType=eo.KNOWN_SAFE_ROOM_VERSION=void 0;var ed=ec(ea(8416)),eu=ea(1333),eh=ea(3705),ef=ea(8910),ep=ea(3667),eg=ej(ea(3102)),em=ea(4369),ey=ea(8881),eb=ea(2848),eS=ea(5205),eE=ea(7434),ew=ea(771),e_=ea(2481),eT=ea(2168),eI=ea(7906),eC=ea(6860),eO=ea(3971),eR=ea(6969),ek=ea(5550),eM=ea(7286),eP=ea(2958),eA=ea(5561);function eD(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eD=function(ei){return ei?ea:eo})(ei)}function ej(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eD(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function eL(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eN(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eL(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eL(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let eU="9";eo.KNOWN_SAFE_ROOM_VERSION=eU;let eB=["1","2","3","4","5","6","7","8","9"],eF=30,eK=function(ei){return ei.Highlight="highlight",ei.Total="total",ei}({});eo.NotificationCountType=eK;let e$=function(ei){return ei.MyMembership="Room.myMembership",ei.Tags="Room.tags",ei.AccountData="Room.accountData",ei.Receipt="Room.receipt",ei.Name="Room.name",ei.Redaction="Room.redaction",ei.RedactionCancelled="Room.redactionCancelled",ei.LocalEchoUpdated="Room.localEchoUpdated",ei.Timeline="Room.timeline",ei.TimelineReset="Room.timelineReset",ei.TimelineRefresh="Room.TimelineRefresh",ei.OldStateUpdated="Room.OldStateUpdated",ei.CurrentStateUpdated="Room.CurrentStateUpdated",ei.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",ei.UnreadNotifications="Room.UnreadNotifications",ei}({});eo.RoomEvent=e$;class eW extends eP.ReadReceipt{constructor(ei,eo,ea,ec={}){super(),this.roomId=ei,this.client=eo,this.myUserId=ea,this.opts=ec,(0,ed.default)(this,"reEmitter",void 0),(0,ed.default)(this,"txnToEvent",new Map),(0,ed.default)(this,"notificationCounts",{}),(0,ed.default)(this,"threadNotifications",new Map),(0,ed.default)(this,"cachedThreadReadReceipts",new Map),(0,ed.default)(this,"oldestThreadedReceiptTs",1/0),(0,ed.default)(this,"unthreadedReceipts",new Map),(0,ed.default)(this,"timelineSets",void 0),(0,ed.default)(this,"polls",new Map),(0,ed.default)(this,"threadsTimelineSets",[]),(0,ed.default)(this,"filteredTimelineSets",{}),(0,ed.default)(this,"timelineNeedsRefresh",!1),(0,ed.default)(this,"pendingEventList",void 0),(0,ed.default)(this,"blacklistUnverifiedDevices",void 0),(0,ed.default)(this,"selfMembership",void 0),(0,ed.default)(this,"summaryHeroes",null),(0,ed.default)(this,"getTypeWarning",!1),(0,ed.default)(this,"getVersionWarning",!1),(0,ed.default)(this,"membersPromise",void 0),(0,ed.default)(this,"name",void 0),(0,ed.default)(this,"normalizedName",void 0),(0,ed.default)(this,"tags",{}),(0,ed.default)(this,"accountData",new Map),(0,ed.default)(this,"summary",null),(0,ed.default)(this,"timeline",void 0),(0,ed.default)(this,"oldState",void 0),(0,ed.default)(this,"currentState",void 0),(0,ed.default)(this,"relations",new eM.RelationsContainer(this.client,this)),(0,ed.default)(this,"threads",new Map),(0,ed.default)(this,"lastThread",void 0),(0,ed.default)(this,"visibilityEvents",new Map),(0,ed.default)(this,"threadTimelineSetsPromise",null),(0,ed.default)(this,"threadsReady",!1),(0,ed.default)(this,"updateThreadRootEvents",(ei,eo,ea)=>{if(ei.length){var ec,ed;this.updateThreadRootEvent(null===(ec=this.threadsTimelineSets)||void 0===ec?void 0:ec[0],ei,eo,ea),ei.hasCurrentUserParticipated&&this.updateThreadRootEvent(null===(ed=this.threadsTimelineSets)||void 0===ed?void 0:ed[1],ei,eo,ea)}}),(0,ed.default)(this,"updateThreadRootEvent",(ei,eo,ea,ec)=>{ei&&eo.rootEvent&&(ec&&ei.removeEvent(eo.id),eR.Thread.hasServerSideSupport?ei.addLiveEvent(eo.rootEvent,{duplicateStrategy:eh.DuplicateStrategy.Replace,fromCache:!1,roomState:this.currentState}):ei.addEventToTimeline(eo.rootEvent,ei.getLiveTimeline(),{toStartOfTimeline:ea}))}),(0,ed.default)(this,"applyRedaction",ei=>{if(ei.isRedaction()){let eo=ei.event.redacts,ea=eo?this.findEventById(eo):void 0;if(ea){if(ea.makeRedacted(ei),ea.isState()){let ei=this.currentState.getStateEvents(ea.getType(),ea.getStateKey());(null==ei?void 0:ei.getId())===ea.getId()&&this.currentState.setStateEvents([ea])}this.emit(e$.Redaction,ei,this),this.visibilityEvents.delete(eo),ea.isVisibilityEvent()&&this.redactVisibilityChangeEvent(ei)}}}),this.setMaxListeners(100),this.reEmitter=new ew.TypedReEmitter(this),ec.pendingEventOrdering=ec.pendingEventOrdering||eT.PendingEventOrdering.Chronological,this.name=ei,this.normalizedName=ei,this.timelineSets=[new eh.EventTimelineSet(this,ec)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[e$.Timeline,e$.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===eT.PendingEventOrdering.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(ei=>{let ea=this.client.getEventMapper({toDevice:!1,decrypt:!1});ei.forEach(async ei=>{let ec=ea(ei);await eo.decryptEventIfNeeded(ec),ec.setStatus(ey.EventStatus.NOT_SENT),this.addPendingEvent(ec,ec.getTxnId())})})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var ei;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(ei=this.client)&&void 0!==ei&&ei.supportsThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(eR.ThreadFilterType.My)]);let ei=await this.threadTimelineSetsPromise;return this.threadsTimelineSets[0]=ei[0],this.threadsTimelineSets[1]=ei[1],ei}catch(ei){this.threadTimelineSetsPromise=null}return null}async decryptCriticalEvents(){if(!this.client.isCryptoEnabled())return;let ei=this.getEventReadUpTo(this.client.getUserId(),!0),eo=this.getLiveTimeline().getEvents(),ea=eo.findIndex(eo=>eo.event.event_id===ei),ec=eo.slice(ea).reverse().map(ei=>this.client.decryptEventIfNeeded(ei,{isRetry:!0}));await Promise.allSettled(ec)}async decryptAllEvents(){if(!this.client.isCryptoEnabled())return;let ei=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(ei=>this.client.decryptEventIfNeeded(ei,{isRetry:!0}));await Promise.allSettled(ei)}getCreator(){var ei;let eo=this.currentState.getStateEvents(e_.EventType.RoomCreate,"");return null!==(ei=null==eo?void 0:eo.getContent().creator)&&void 0!==ei?ei:null}getVersion(){var ei;let eo=this.currentState.getStateEvents(e_.EventType.RoomCreate,"");return eo?null!==(ei=eo.getContent().room_version)&&void 0!==ei?ei:"1":(this.getVersionWarning||(eE.logger.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}shouldUpgradeToVersion(){return eB.includes(this.getVersion())?null:eU}async getRecommendedVersion(){let ei=await this.client.getCapabilities(),eo=ei["m.room_versions"];if(!eo)for(let ei of(eo={default:eU,available:{}},eB))eo.available[ei]=eT.RoomVersionStability.Stable;let ea=this.checkVersionAgainstCapability(eo);if(ea.urgent&&ea.needsUpgrade){eE.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");let ei=await this.client.getCapabilities(!0);(eo=ei["m.room_versions"])?ea=this.checkVersionAgainstCapability(eo):eE.logger.warn("No room version capability - assuming upgrade required.")}return ea}checkVersionAgainstCapability(ei){let eo=this.getVersion();eE.logger.log(`[${this.roomId}] Current version: ${eo}`),eE.logger.log(`[${this.roomId}] Version capability: `,ei);let ea={version:eo,needsUpgrade:!1,urgent:!1};if(eo===ei.default)return ea;let ec=Object.keys(ei.available).filter(eo=>"stable"===ei.available[eo]);return ec.includes(eo)||(ea.version=ei.default,ea.needsUpgrade=!0,ea.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),ea.urgent?eE.logger.warn(`URGENT upgrade required on ${this.roomId}`):eE.logger.warn(`Non-urgent upgrade required on ${this.roomId}`)),ea}userMayUpgradeRoom(ei){return this.currentState.maySendStateEvent(e_.EventType.RoomTombstone,ei)}getPendingEvents(){if(!this.pendingEventList)throw Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(ei){if(!this.pendingEventList)throw Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);let eo=eg.removeElement(this.pendingEventList,function(eo){return eo.getId()==ei},!1);return this.savePendingEvents(),eo}hasPendingEvent(ei){var eo,ea;return null!==(eo=null===(ea=this.pendingEventList)||void 0===ea?void 0:ea.some(eo=>eo.getId()===ei))&&void 0!==eo&&eo}getPendingEvent(ei){var eo,ea;return null!==(eo=null===(ea=this.pendingEventList)||void 0===ea?void 0:ea.find(eo=>eo.getId()===ei))&&void 0!==eo?eo:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){let ei=this.getLiveTimeline(),eo=ei.getEvents();if(!eo.length)return Number.MIN_SAFE_INTEGER;{let ei=eo[eo.length-1];return ei.getTs()}}getMyMembership(){var ei;return null!==(ei=this.selfMembership)&&void 0!==ei?ei:"leave"}getDMInviter(){let ei=this.getMember(this.myUserId);if(ei)return ei.getDMInviter();if("invite"===this.selfMembership){let ei=this.getInvitedAndJoinedMemberCount();if(2===ei){var eo;return null===(eo=this.summaryHeroes)||void 0===eo?void 0:eo[0]}}}guessDMUserId(){let ei=this.getMember(this.myUserId);if(ei){let eo=ei.getDMInviter();if(eo)return eo}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];let eo=this.currentState.getMembers(),ea=eo.find(ei=>ei.userId!==this.myUserId);return ea?ea.userId:this.myUserId}getAvatarFallbackMember(){let ei=this.getInvitedAndJoinedMemberCount();if(ei>2)return;let eo=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(eo){let ei=this.summaryHeroes.map(ei=>this.getMember(ei)).find(ei=>!!ei);if(ei)return ei}let ea=this.currentState.getMembers();if(ea.length<=2){let ei=ea.find(ei=>ei.userId!==this.myUserId);if(ei)return ei}if(eo){let ei=this.summaryHeroes.map(ei=>this.client.getUser(ei)).find(ei=>!!ei);if(ei){let eo=new eb.RoomMember(this.roomId,ei.userId);return eo.user=ei,eo}}}updateMyMembership(ei){let eo=this.selfMembership;this.selfMembership=ei,eo!==ei&&("leave"===ei&&this.cleanupAfterLeaving(),this.emit(e$.MyMembership,this,ei,eo))}async loadMembersFromServer(){let ei=this.client.store.getSyncToken(),eo=await this.client.members(this.roomId,void 0,"leave",null!=ei?ei:void 0);return eo.chunk}async loadMembers(){let ei=!1,eo=await this.client.store.getOutOfBandMembers(this.roomId);(null===eo||this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId))&&(ei=!0,eo=await this.loadMembersFromServer(),eE.logger.log(`LL: got ${eo.length} members from server for room ${this.roomId}`));let ea=eo.filter(eg.noUnsafeEventProps).map(this.client.getEventMapper());return{memberEvents:ea,fromServer:ei}}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();let ei=this.loadMembers().then(ei=>(this.currentState.setOutOfBandMembers(ei.memberEvents),ei.fromServer)).catch(ei=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),ei});return ei.then(ei=>{if(ei){let ei=this.currentState.getMembers().filter(ei=>ei.isOutOfBand()).map(ei=>{var eo;return null===(eo=ei.events.member)||void 0===eo?void 0:eo.event});eE.logger.log(`LL: telling store to write ${ei.length} members for room ${this.roomId}`);let eo=this.client.store;return eo.setOutOfBandMembers(this.roomId,ei).catch(ei=>{eE.logger.log("LL: storing OOB room members failed, oh well",ei)})}}).catch(ei=>{eE.logger.error(ei)}),this.membersPromise=ei,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(ei=>{eE.logger.error(`error after clearing loaded members from room ${this.roomId} after leaving`),eE.logger.log(ei)})}async refreshLiveTimeline(){let ei;let eo=this.getLiveTimeline(),ea=eo.getPaginationToken(ef.EventTimeline.FORWARDS),ec=eo.getPaginationToken(ef.EventTimeline.BACKWARDS),ed=eo.getEvents(),eu=ed[ed.length-1];eE.logger.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${eu&&eu.getId()} liveTimelineBefore=${eo.toString()} forwardPaginationToken=${ea} backwardPaginationToken=${ec}`);let eh=this.getUnfilteredTimelineSet();eu?(this.resetLiveTimeline(null,null),this.emit(e$.TimelineRefresh,this,eh),ei=await this.client.getEventTimeline(eh,eu.getId())):ei=await this.client.getLatestTimeline(eh);let ep=eh.getLiveTimeline();ep&&(null!==ep.getPaginationToken(ef.Direction.Forward)||null!==ep.getPaginationToken(ef.Direction.Backward)||0!==ep.getEvents().length)?eE.logger.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`):(eE.logger.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),ei.setPaginationToken(ea,ef.EventTimeline.FORWARDS),eh.setLiveTimeline(ei),this.fixUpLegacyTimelineFields()),this.setTimelineNeedsRefresh(!1),this.emit(e$.TimelineRefresh,this,eh)}resetLiveTimeline(ei,eo){for(let ea of this.timelineSets)ea.resetLiveTimeline(null!=ei?ei:void 0,null!=eo?eo:void 0);for(let ea of this.threads.values())ea.resetLiveTimeline(ei,eo);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){let ei=this.oldState,eo=this.currentState;this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(ef.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(ef.EventTimeline.FORWARDS),ei!==this.oldState&&this.emit(e$.OldStateUpdated,this,ei,this.oldState),eo!==this.currentState&&(this.emit(e$.CurrentStateUpdated,this,eo,this.currentState),this.reEmitter.stopReEmitting(eo,[eC.RoomStateEvent.Events,eC.RoomStateEvent.Members,eC.RoomStateEvent.NewMember,eC.RoomStateEvent.Update,eC.RoomStateEvent.Marker,eO.BeaconEvent.New,eO.BeaconEvent.Update,eO.BeaconEvent.Destroy,eO.BeaconEvent.LivenessChange]),this.reEmitter.reEmit(this.currentState,[eC.RoomStateEvent.Events,eC.RoomStateEvent.Members,eC.RoomStateEvent.NewMember,eC.RoomStateEvent.Update,eC.RoomStateEvent.Marker,eO.BeaconEvent.New,eO.BeaconEvent.Update,eO.BeaconEvent.Destroy,eO.BeaconEvent.LivenessChange]))}async hasUnverifiedDevices(){if(!this.client.isRoomEncrypted(this.roomId))return!1;let ei=await this.getEncryptionTargetMembers();for(let eo of ei){let ei=this.client.getStoredDevicesForUser(eo.userId);if(ei.some(ei=>ei.isUnverified()))return!0}return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(ei){let eo=this.findEventById(ei),ea=this.findThreadForEvent(eo);return ea?ea.timelineSet.getTimelineForEvent(ei):this.getUnfilteredTimelineSet().getTimelineForEvent(ei)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(ei){this.timelineNeedsRefresh=ei}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(ei){let eo=this.getUnfilteredTimelineSet().findEventById(ei);if(!eo){let ea=this.getThreads();for(let ec=0;ec<ea.length;ec++){let ed=ea[ec];if(eo=ed.findEventById(ei))break}}return eo}getUnreadNotificationCount(ei=eK.Total){let eo=this.getRoomUnreadNotificationCount(ei);for(let ec of this.threadNotifications.values()){var ea;eo+=null!==(ea=ec[ei])&&void 0!==ea?ea:0}return eo}getUnreadCountForEventContext(ei=eK.Total,eo){var ea;let ec=!!eo.threadRootId&&!eo.isThreadRoot;return null!==(ea=ec?this.getThreadUnreadNotificationCount(eo.threadRootId,ei):this.getRoomUnreadNotificationCount(ei))&&void 0!==ea?ea:0}getRoomUnreadNotificationCount(ei=eK.Total){var eo;return null!==(eo=this.notificationCounts[ei])&&void 0!==eo?eo:0}getThreadUnreadNotificationCount(ei,eo=eK.Total){var ea,ec;return null!==(ea=null===(ec=this.threadNotifications.get(ei))||void 0===ec?void 0:ec[eo])&&void 0!==ea?ea:0}hasThreadUnreadNotification(){for(let ea of this.threadNotifications.values()){var ei,eo;if((null!==(ei=ea.highlight)&&void 0!==ei?ei:0)>0||(null!==(eo=ea.total)&&void 0!==eo?eo:0)>0)return!0}return!1}setThreadUnreadNotificationCount(ei,eo,ea){var ec,ed;let eu=eN({highlight:null===(ec=this.threadNotifications.get(ei))||void 0===ec?void 0:ec.highlight,total:null===(ed=this.threadNotifications.get(ei))||void 0===ed?void 0:ed.total},{[eo]:ea});this.threadNotifications.set(ei,eu),this.emit(e$.UnreadNotifications,eu,ei)}get threadsAggregateNotificationType(){let ei=null;for(let ec of this.threadNotifications.values()){var eo,ea;if((null!==(eo=ec.highlight)&&void 0!==eo?eo:0)>0)return eK.Highlight;(null!==(ea=ec.total)&&void 0!==ea?ea:0)>0&&!ei&&(ei=eK.Total)}return ei}resetThreadUnreadNotificationCount(ei){if(ei)for(let[eo]of this.threadNotifications)ei.includes(eo)||this.threadNotifications.delete(eo);else this.threadNotifications.clear();this.emit(e$.UnreadNotifications)}setUnreadNotificationCount(ei,eo){this.notificationCounts[ei]=eo,this.emit(e$.UnreadNotifications,this.notificationCounts)}setUnread(ei,eo){return this.setUnreadNotificationCount(ei,eo)}setSummary(ei){let eo=ei["m.heroes"],ea=ei["m.joined_member_count"],ec=ei["m.invited_member_count"];Number.isInteger(ea)&&this.currentState.setJoinedMemberCount(ea),Number.isInteger(ec)&&this.currentState.setInvitedMemberCount(ec),Array.isArray(eo)&&(this.summaryHeroes=eo.filter(ei=>ei!==this.myUserId))}setBlacklistUnverifiedDevices(ei){this.blacklistUnverifiedDevices=ei}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(ei,eo,ea,ec,ed=!0){let eu=this.currentState.getStateEvents(e_.EventType.RoomAvatar,"");if(!eu&&!ed)return null;let eh=eu?eu.getContent().url:null;return eh?(0,ep.getHttpUriForMxc)(ei,eh,eo,ea,ec):null}getMxcAvatarUrl(){var ei,eo;return(null===(ei=this.currentState.getStateEvents(e_.EventType.RoomAvatar,""))||void 0===ei?void 0:null===(eo=ei.getContent())||void 0===eo?void 0:eo.url)||null}getCanonicalAlias(){let ei=this.currentState.getStateEvents(e_.EventType.RoomCanonicalAlias,"");return ei&&ei.getContent().alias||null}getAltAliases(){let ei=this.currentState.getStateEvents(e_.EventType.RoomCanonicalAlias,"");return ei&&ei.getContent().alt_aliases||[]}addEventsToTimeline(ei,eo,ea,ec){ea.getTimelineSet().addEventsToTimeline(ei,eo,ea,ec)}getThread(ei){var eo;return null!==(eo=this.threads.get(ei))&&void 0!==eo?eo:null}getThreads(){return Array.from(this.threads.values())}getMember(ei){return this.currentState.getMember(ei)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(ei){return this.currentState.getMembers().filter(function(eo){return eo.membership===ei})}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let ei=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(ei=ei.concat(this.getMembersWithMembership("invite"))),ei}shouldEncryptForInvitedMembers(){var ei;let eo=this.currentState.getStateEvents(e_.EventType.RoomHistoryVisibility,"");return(null==eo?void 0:null===(ei=eo.getContent())||void 0===ei?void 0:ei.history_visibility)!=="joined"}getDefaultRoomName(ei){return this.calculateRoomName(ei,!0)}hasMembershipState(ei,eo){let ea=this.getMember(ei);return!!ea&&ea.membership===eo}getOrCreateFilteredTimelineSet(ei,{prepopulateTimeline:eo=!0,useSyncEvents:ea=!0,pendingEvents:ec=!0}={}){if(this.filteredTimelineSets[ei.filterId])return this.filteredTimelineSets[ei.filterId];let ed=Object.assign({filter:ei,pendingEvents:ec},this.opts),eu=new eh.EventTimelineSet(this,ed);this.reEmitter.reEmit(eu,[e$.Timeline,e$.TimelineReset]),ea&&(this.filteredTimelineSets[ei.filterId]=eu,this.timelineSets.push(eu));let ep=this.getLiveTimeline();if(eo){ep.getEvents().forEach(function(ei){eu.addLiveEvent(ei)});let ei=ep;for(;ei.getNeighbouringTimeline(ef.EventTimeline.BACKWARDS);)ei=ei.getNeighbouringTimeline(ef.EventTimeline.BACKWARDS);eu.getLiveTimeline().setPaginationToken(ei.getPaginationToken(ef.EventTimeline.BACKWARDS),ef.EventTimeline.BACKWARDS)}else if(ea){let ei=ep.getPaginationToken(ef.Direction.Forward);eu.getLiveTimeline().setPaginationToken(ei,ef.Direction.Backward)}return eu}async getThreadListFilter(ei=eR.ThreadFilterType.All){let eo=this.client.getUserId(),ea=new eI.Filter(eo),ec={room:{timeline:{[eR.FILTER_RELATED_BY_REL_TYPES.name]:[eR.THREAD_RELATION_TYPE.name]}}};ei===eR.ThreadFilterType.My&&(ec.room.timeline[eR.FILTER_RELATED_BY_SENDERS.name]=[eo]),ea.setDefinition(ec);let ed=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${ei}`,ea);return ea.filterId=ed,ea}async createThreadTimelineSet(ei){let eo;if(eR.Thread.hasServerSideListSupport)eo=new eh.EventTimelineSet(this,eN(eN({},this.opts),{},{pendingEvents:!1}),void 0,void 0,null!=ei?ei:eR.ThreadFilterType.All),this.reEmitter.reEmit(eo,[e$.Timeline,e$.TimelineReset]);else if(eR.Thread.hasServerSideSupport){let ea=await this.getThreadListFilter(ei);eo=this.getOrCreateFilteredTimelineSet(ea,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else eo=new eh.EventTimelineSet(this,{pendingEvents:!1}),Array.from(this.threads).forEach(([,ea])=>{if(0===ea.length)return;let ec=ea.timeline.some(ei=>ei.getSender()===this.client.getUserId());(ei!==eR.ThreadFilterType.My||ec)&&eo.getLiveTimeline().addEvent(ea.rootEvent,{toStartOfTimeline:!1})});return eo}processThreadRoots(ei,eo){for(let ea of ei)ef.EventTimeline.setEventMetadata(ea,this.currentState,eo),this.getThread(ea.getId())||this.createThread(ea.getId(),ea,[],eo)}async fetchRoomThreads(){if(!this.threadsReady&&this.client.supportsThreads()){if(eR.Thread.hasServerSideListSupport)await Promise.all([this.fetchRoomThreadList(eR.ThreadFilterType.All),this.fetchRoomThreadList(eR.ThreadFilterType.My)]);else{let ea;let ec=await this.getThreadListFilter(),{chunk:ed}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,ef.Direction.Backward,ec);if(!ed.length)return;let eu=ed.map(this.client.getEventMapper()).sort((ei,eo)=>{let ea=ei.getServerAggregatedRelation(eR.THREAD_RELATION_TYPE.name),ec=eo.getServerAggregatedRelation(eR.THREAD_RELATION_TYPE.name);return ea.latest_event.origin_server_ts-ec.latest_event.origin_server_ts}),ep=this.getLiveTimeline().getState(ef.EventTimeline.FORWARDS);for(let ec of eu){var ei,eo;let ed={duplicateStrategy:eh.DuplicateStrategy.Ignore,fromCache:!1,roomState:ep};null===(ei=this.threadsTimelineSets[0])||void 0===ei||ei.addLiveEvent(ec,ed);let eu=ec.getServerAggregatedRelation(eR.THREAD_RELATION_TYPE.name);null!=eu&&eu.current_user_participated&&(null===(eo=this.threadsTimelineSets[1])||void 0===eo||eo.addLiveEvent(ec,ed),ea=ec)}this.processThreadRoots(eu,!0),this.client.decryptEventIfNeeded(eu[eu.length-1]),ea&&this.client.decryptEventIfNeeded(ea)}this.on(eR.ThreadEvent.NewReply,this.onThreadNewReply),this.on(eR.ThreadEvent.Delete,this.onThreadDelete),this.threadsReady=!0}}async processPollEvents(ei){for(let eo of ei)try{if(!eo.isEncrypted()&&!(0,eA.isPollEvent)(eo))continue;await this.client.decryptEventIfNeeded(eo),this.processPollEvent(eo)}catch(ei){eE.logger.warn("Error processing poll event",eo.getId(),ei)}}async processPollEvent(ei){if(ei.isDecryptionFailure()){ei.once(em.MatrixEventEvent.Decrypted,ei=>{this.processPollEvent(ei)});return}if(eu.M_POLL_START.matches(ei.getType())){try{let eo=new eA.Poll(ei,this.client,this);this.polls.set(ei.getId(),eo),this.emit(eA.PollEvent.New,eo)}catch{}return}let eo=ei.relationEventId;if(eo&&this.polls.has(eo)){let ea=this.polls.get(eo);null==ea||ea.onNewRelation(ei)}}async fetchRoomThreadList(ei){if(0===this.threadsTimelineSets.length)return;let eo=ei===eR.ThreadFilterType.My?this.threadsTimelineSets[1]:this.threadsTimelineSets[0],{chunk:ea,end:ec}=await this.client.createThreadListMessagesRequest(this.roomId,null,void 0,ef.Direction.Backward,eo.threadListType,eo.getFilter());if(eo.getLiveTimeline().setPaginationToken(null!=ec?ec:null,ef.Direction.Backward),!ea.length)return;let ed=ea.map(this.client.getEventMapper());this.processThreadRoots(ed,!0);let eu=this.getLiveTimeline().getState(ef.EventTimeline.FORWARDS);for(let ei of ed)eo.addLiveEvent(ei,{duplicateStrategy:eh.DuplicateStrategy.Replace,fromCache:!1,roomState:eu})}onThreadNewReply(ei){this.updateThreadRootEvents(ei,!1,!0)}onThreadDelete(ei){var eo;this.threads.delete(ei.id);let ea=this.getTimelineForEvent(ei.id),ec=null==ea?void 0:null===(eo=ea.getEvents())||void 0===eo?void 0:eo.find(eo=>eo.getId()===ei.id);for(let eo of(ec?ei.clearEventMetadata(ec):eE.logger.debug("onThreadDelete: Could not find root event in room timeline"),this.threadsTimelineSets))eo.removeEvent(ei.id)}removeFilteredTimelineSet(ei){let eo=this.filteredTimelineSets[ei.filterId];delete this.filteredTimelineSets[ei.filterId];let ea=this.timelineSets.indexOf(eo);ea>-1&&this.timelineSets.splice(ea,1)}eventShouldLiveIn(ei,eo,ea){var ec,ed;let eu;if(!(null!==(ec=this.client)&&void 0!==ec&&ec.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(ei.isThreadRoot||null!=ea&&ea.has(ei.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:ei.getId()};if(ei.isRelation(eR.THREAD_RELATION_TYPE.name))return{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:ei.threadRootId};let eh=ei.getAssociatedId();return(eh&&(eu=null!==(ed=this.findEventById(eh))&&void 0!==ed?ed:null==eo?void 0:eo.find(ei=>ei.getId()===eh)),eu&&(ei.isRelation()||ei.isRedaction()))?this.eventShouldLiveIn(eu,eo,ea):null!=ea&&ea.has(ei.relationEventId)?{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:ei.relationEventId}:{shouldLiveInRoom:!0,shouldLiveInThread:!1}}findThreadForEvent(ei){if(!ei)return null;let{threadId:eo}=this.eventShouldLiveIn(ei);return eo?this.getThread(eo):null}addThreadedEvents(ei,eo,ea=!1){let ec=this.getThread(ei);if(!ec){var ed;let eu=null!==(ed=this.findEventById(ei))&&void 0!==ed?ed:eo.find(eo=>eo.getId()===ei);ec=this.createThread(ei,eu,eo,ea)}ec.addEvents(eo,ea)}processThreadedEvents(ei,eo){ei.forEach(this.applyRedaction);let ea={};for(let eo of ei){var ec;let{threadId:ei,shouldLiveInThread:ed}=this.eventShouldLiveIn(eo);ed&&!ea[ei]&&(ea[ei]=[]),null===(ec=ea[ei])||void 0===ec||ec.push(eo)}Object.entries(ea).map(([ei,ea])=>this.addThreadedEvents(ei,ea,eo))}createThread(ei,eo,ea=[],ec){var ed,eu,eh;if(this.threads.has(ei))return this.threads.get(ei);if(eo){let ei=this.relations.getAllChildEventsForEvent(eo.getId());null!=ei&&ei.length&&(ea=ea.concat(ei.filter(ei=>!ei.isRelation(e_.RelationType.Replace))))}let ef=new eR.Thread(ei,eo,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!==(ed=this.cachedThreadReadReceipts.get(ei))&&void 0!==ed?ed:[]});this.cachedThreadReadReceipts.delete(ei),this.threads.set(ef.id,ef),ef.addEvents(ea,!1),this.reEmitter.reEmit(ef,[eR.ThreadEvent.Delete,eR.ThreadEvent.Update,eR.ThreadEvent.NewReply,e$.Timeline,e$.TimelineReset]);let ep=(null===(eu=this.lastThread)||void 0===eu?void 0:eu.rootEvent)&&(null==eo?void 0:eo.localTimestamp)&&(null===(eh=this.lastThread.rootEvent)||void 0===eh?void 0:eh.localTimestamp)<(null==eo?void 0:eo.localTimestamp);return(!this.lastThread||ep)&&(this.lastThread=ef),this.threadsReady&&this.updateThreadRootEvents(ef,ec,!1),this.emit(eR.ThreadEvent.New,ef,ec),ef}processLiveEvent(ei){this.applyRedaction(ei),ei.isVisibilityEvent()&&this.applyNewVisibilityEvent(ei),this.applyPendingVisibilityEvents(ei);let eo=ei.getUnsigned().transaction_id;if(!eo&&ei.getSender()===this.myUserId){for(let[eo,ea]of this.txnToEvent)if(ea.getId()===ei.getId()){eE.logger.debug("processLiveEvent: found sent event without txn ID: ",eo,ei.getId());let ea=ei.getUnsigned();ea.transaction_id=eo,ei.setUnsigned(ea);break}}}addLiveEvent(ei,eo){let{duplicateStrategy:ea,timelineWasEmpty:ec,fromCache:ed}=eo;for(let eo of this.timelineSets)eo.addLiveEvent(ei,{duplicateStrategy:ea,fromCache:ed,timelineWasEmpty:ec});ei.sender&&ei.getType()!==e_.EventType.RoomRedaction&&this.addReceipt((0,eP.synthesizeReceipt)(ei.sender.userId,ei,ek.ReceiptType.Read),!0)}addPendingEvent(ei,eo){if(ei.status!==ey.EventStatus.SENDING&&ei.status!==ey.EventStatus.NOT_SENT)throw Error("addPendingEvent called on an event with status "+ei.status);if(this.txnToEvent.get(eo))throw Error("addPendingEvent called on an event with known txnId "+eo);if(ef.EventTimeline.setEventMetadata(ei,this.getLiveTimeline().getState(ef.EventTimeline.FORWARDS),!1),this.txnToEvent.set(eo,ei),this.pendingEventList){if(this.pendingEventList.some(ei=>ei.status===ey.EventStatus.NOT_SENT)&&(eE.logger.warn("Setting event as NOT_SENT due to messages in the same state"),ei.setStatus(ey.EventStatus.NOT_SENT)),this.pendingEventList.push(ei),this.savePendingEvents(),ei.isRelation()&&this.aggregateNonLiveRelation(ei),ei.isRedaction()){let eo=ei.event.redacts,ea=this.pendingEventList.find(ei=>ei.getId()===eo);!ea&&eo&&(ea=this.findEventById(eo)),ea&&(ea.markLocallyRedacted(ei),this.emit(e$.Redaction,ei,this))}}else for(let eo of this.timelineSets)eo.getFilter()?eo.getFilter().filterRoomTimeline([ei]).length&&eo.addEventToTimeline(ei,eo.getLiveTimeline(),{toStartOfTimeline:!1}):eo.addEventToTimeline(ei,eo.getLiveTimeline(),{toStartOfTimeline:!1});this.emit(e$.LocalEchoUpdated,ei,this)}savePendingEvents(){if(this.pendingEventList){let ei=this.pendingEventList.map(ei=>eN(eN({},ei.event),{},{txn_id:ei.getTxnId()})).filter(ei=>{let eo=ei.type===e_.EventType.RoomMessageEncrypted,ea=this.client.isRoomEncrypted(this.roomId);return eo||!ea});this.client.store.setPendingEvents(this.roomId,ei)}}aggregateNonLiveRelation(ei){this.relations.aggregateChildEvent(ei)}getEventForTxnId(ei){return this.txnToEvent.get(ei)}handleRemoteEcho(ei,eo){let ea=eo.getId(),ec=ei.getId(),ed=eo.status;eE.logger.debug(`Got remote echo for event ${ea} -> ${ec} old status ${ed}`),this.txnToEvent.delete(ei.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(ea),eo.handleRemoteEcho(ei.event);let{shouldLiveInRoom:eu,threadId:eh}=this.eventShouldLiveIn(ei),ef=eh?this.getThread(eh):null;if(null==ef||ef.setEventMetadata(eo),null==ef||ef.timelineSet.handleRemoteEcho(eo,ea,ec),eu)for(let ei of this.timelineSets)ei.handleRemoteEcho(eo,ea,ec);this.emit(e$.LocalEchoUpdated,eo,this,ea,ed)}updatePendingEvent(ei,eo,ea){if(eE.logger.log(`setting pendingEvent status to ${eo} in ${ei.getRoomId()} event ID ${ei.getId()} -> ${ea}`),eo==ey.EventStatus.SENT&&!ea)throw Error("updatePendingEvent called with status=SENT, but no new event id");if(eo==ey.EventStatus.SENT){let eo=this.getTimelineForEvent(ea);if(eo){let eo=this.findEventById(ea),ec=null==eo?void 0:eo.getUnsigned().transaction_id;if(!ec&&eo){let ea=eo.getUnsigned();ea.transaction_id=ei.getTxnId(),eo.setUnsigned(ea),this.removeEvent(eo.getId()),this.handleRemoteEcho(eo,ei)}return}}let ec=ei.status,ed=ei.getId();if(!ec)throw Error("updatePendingEventStatus called on an event which is not a local echo.");let eu=eV[ec];if(!(null!=eu&&eu.includes(eo)))throw Error(`Invalid EventStatus transition ${ec}->${eo}`);if(ei.setStatus(eo),eo==ey.EventStatus.SENT){ei.replaceLocalEventId(ea);let{shouldLiveInRoom:eo,threadId:ec}=this.eventShouldLiveIn(ei),eu=ec?this.getThread(ec):void 0;if(null==eu||eu.setEventMetadata(ei),null==eu||eu.timelineSet.replaceEventId(ed,ea),eo)for(let ei of this.timelineSets)ei.replaceEventId(ed,ea)}else if(eo==ey.EventStatus.CANCELLED){if(this.pendingEventList){let ei=this.getPendingEvent(ed);this.removePendingEvent(ed),null!=ei&&ei.isRedaction()&&this.revertRedactionLocalEcho(ei)}this.removeEvent(ed)}this.savePendingEvents(),this.emit(e$.LocalEchoUpdated,ei,this,ed,ec)}revertRedactionLocalEcho(ei){let eo=ei.event.redacts;if(!eo)return;let ea=this.getUnfilteredTimelineSet().findEventById(eo);ea&&(ea.unmarkLocallyRedacted(),this.emit(e$.RedactionCancelled,ei,this),ea.isRelation()&&this.aggregateNonLiveRelation(ea))}addLiveEvents(ei,eo,ea=!1){let ec=eo,ed=!1;if("object"==typeof eo?{duplicateStrategy:ec,fromCache:ea=!1,timelineWasEmpty:ed}=eo:void 0!==eo&&eE.logger.warn("Overload deprecated: `Room.addLiveEvents(events, duplicateStrategy?, fromCache?)` is deprecated in favor of the overload with `Room.addLiveEvents(events, IAddLiveEventOptions)`"),ec&&-1===["replace","ignore"].indexOf(ec))throw Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let ei=0;ei<this.timelineSets.length;ei++){let eo=this.timelineSets[ei].getLiveTimeline();if(eo.getPaginationToken(ef.EventTimeline.FORWARDS))throw Error("live timeline "+ei+" is no longer live - it has a pagination token ("+eo.getPaginationToken(ef.EventTimeline.FORWARDS)+")");if(eo.getNeighbouringTimeline(ef.EventTimeline.FORWARDS))throw Error(`live timeline ${ei} is no longer live - it has a neighbouring timeline`)}let eu=this.findThreadRoots(ei),eh={},ep={duplicateStrategy:ec,fromCache:ea,timelineWasEmpty:ed};for(let eo of ei){var eg;if(this.processLiveEvent(eo),eo.getUnsigned().transaction_id){let ei=this.txnToEvent.get(eo.getUnsigned().transaction_id);if(ei){this.handleRemoteEcho(eo,ei);continue}}let{shouldLiveInRoom:ea,shouldLiveInThread:ec,threadId:ed}=this.eventShouldLiveIn(eo,ei,eu);ec&&!eh[null!=ed?ed:""]&&(eh[null!=ed?ed:""]=[]),null===(eg=eh[null!=ed?ed:""])||void 0===eg||eg.push(eo),ea&&this.addLiveEvent(eo,ep)}Object.entries(eh).forEach(([ei,eo])=>{this.addThreadedEvents(ei,eo,!1)})}partitionThreadedEvents(ei){let eo=0,ea=1;if(!this.client.supportsThreads())return[ei,[]];{let ec=this.findThreadRoots(ei);return ei.reduce((ed,eu)=>{let{shouldLiveInRoom:eh,shouldLiveInThread:ef,threadId:ep}=this.eventShouldLiveIn(eu,ei,ec);return eh&&ed[eo].push(eu),ef&&(eu.setThreadId(null!=ep?ep:""),ed[ea].push(eu)),ed},[[],[]])}}findThreadRoots(ei){let eo=new Set;for(let ec of ei)if(ec.isRelation(eR.THREAD_RELATION_TYPE.name)){var ea;eo.add(null!==(ea=ec.relationEventId)&&void 0!==ea?ea:"")}return eo}addReceipt(ei,eo=!1){let ea=ei.getContent();Object.keys(ea).forEach(ei=>{Object.keys(ea[ei]).forEach(ec=>{Object.keys(ea[ei][ec]).forEach(ed=>{var eu,eh,ef,ep;let eg=ea[ei][ec][ed],em=!eg.thread_id||eg.thread_id===ek.MAIN_ROOM_TIMELINE,ey=em?this:this.threads.get(null!==(eu=eg.thread_id)&&void 0!==eu?eu:"");if(ey){if(ey.addReceiptToStructure(ei,ec,ed,eg,eo),this.client.isInitialSyncComplete()&&ed===this.client.getUserId()){let eo=ey.timeline[ey.timeline.length-1];eo&&ei===eo.getId()&&ed===eo.getSender()&&(ey.setUnread(eK.Total,0),ey.setUnread(eK.Highlight,0))}}else this.cachedThreadReadReceipts.set(eg.thread_id,[...null!==(ep=this.cachedThreadReadReceipts.get(eg.thread_id))&&void 0!==ep?ep:[],{eventId:ei,receiptType:ec,userId:ed,receipt:eg,synthetic:eo}]);let eb=this.client.getUserId();ed===eb&&!em&&eg.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=eg.ts),!eg.thread_id&&eg.ts>(null!==(eh=null===(ef=this.unthreadedReceipts.get(ed))||void 0===ef?void 0:ef.ts)&&void 0!==eh?eh:0)&&this.unthreadedReceipts.set(ed,eg)})})}),this.emit(e$.Receipt,ei,this)}addEphemeralEvents(ei){for(let eo of ei)eo.getType()===e_.EventType.Typing?this.currentState.setTypingEvent(eo):eo.getType()===e_.EventType.Receipt&&this.addReceipt(eo)}removeEvents(ei){for(let eo of ei)this.removeEvent(eo)}removeEvent(ei){let eo=!1;for(let ea of this.timelineSets){let ec=ea.removeEvent(ei);ec&&(ec.isRedaction()&&this.revertRedactionLocalEcho(ec),eo=!0)}return eo}recalculate(){let ei=this.currentState.getStateEvents(e_.EventType.RoomMember,this.myUserId);if(ei){let eo=ei.getContent().membership;if(this.updateMyMembership(eo),"invite"===eo){let eo=ei.getUnsigned().invite_room_state||[];eo.forEach(ei=>{let eo=this.currentState.getStateEvents(ei.type,ei.state_key);eo||this.currentState.setStateEvents([new em.MatrixEvent({type:ei.type,state_key:ei.state_key,content:ei.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])})}}let eo=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,eg.normalize)(this.name),this.summary=new eS.RoomSummary(this.roomId,{title:this.name}),eo!==this.name&&this.emit(e$.Name,this)}addTags(ei){this.tags=ei.getContent().tags||{},this.emit(e$.Tags,ei,this)}addAccountData(ei){for(let eo of ei){"m.tag"===eo.getType()&&this.addTags(eo);let ei=eo.getType(),ea=this.accountData.get(ei);this.accountData.set(ei,eo),this.emit(e$.AccountData,eo,this,ea)}}getAccountData(ei){return this.accountData.get(ei)}maySendMessage(){return"join"===this.getMyMembership()&&(this.client.isRoomEncrypted(this.roomId)?this.currentState.maySendEvent(e_.EventType.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(e_.EventType.RoomMessage,this.myUserId))}canInvite(ei){let eo="join"===this.getMyMembership(),ea=this.currentState.getStateEvents(e_.EventType.RoomPowerLevels,""),ec=ea&&ea.getContent(),ed=this.getMember(ei);return ec&&ed&&ec.invite>ed.powerLevel&&(eo=!1),eo}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){let ei=this.currentState.getStateEvents(e_.EventType.RoomCreate,"");if(!ei){this.getTypeWarning||(eE.logger.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return ei.getContent()[e_.RoomCreateTypeField]}isSpaceRoom(){return this.getType()===e_.RoomType.Space}isCallRoom(){return this.getType()===e_.RoomType.UnstableCall}isElementVideoRoom(){return this.getType()===e_.RoomType.ElementVideo}findPredecessor(ei=!1){let eo=this.getLiveTimeline().getState(ef.EventTimeline.FORWARDS);return eo?eo.findPredecessor(ei):null}roomNameGenerator(ei){if(this.client.roomNameGenerator){let eo=this.client.roomNameGenerator(this.roomId,ei);if(null!==eo)return eo}switch(ei.type){case eG.Actual:return ei.name;case eG.Generated:if("Inviting"===ei.subtype)return`Inviting ${eH(ei.names,ei.count)}`;return eH(ei.names,ei.count);case eG.EmptyRoom:if(ei.oldName)return`Empty room (was ${ei.oldName})`;return"Empty room"}}calculateRoomName(ei,eo=!1){let ea;if(!eo){let ei=this.currentState.getStateEvents(e_.EventType.RoomName,"");if(null!=ei&&ei.getContent().name)return this.roomNameGenerator({type:eG.Actual,name:ei.getContent().name})}let ec=this.getCanonicalAlias();if(ec)return this.roomNameGenerator({type:eG.Actual,name:ec});let ed=this.currentState.getJoinedMemberCount(),eu=this.currentState.getInvitedMemberCount(),eh=ed+eu-1,ef=[],ep=this.currentState.getStateEvents(e_.UNSTABLE_ELEMENT_FUNCTIONAL_USERS.name,"");Array.isArray(null==ep?void 0:ep.getContent().service_members)&&(ef=ep.getContent().service_members);let em=[];if(this.summaryHeroes)this.summaryHeroes.forEach(ei=>{if(ef.includes(ei)){eh--;return}let eo=this.getMember(ei);em.push(eo?eo.name:ei)});else{let eo=this.currentState.getMembers().filter(eo=>eo.userId!==ei&&("invite"===eo.membership||"join"===eo.membership));(eo=eo.filter(({userId:ei})=>!ef.includes(ei)||(eh--,!1))).sort((ei,eo)=>eg.compare(ei.userId,eo.userId)),em=(eo=eo.slice(0,5)).map(ei=>ei.name)}if(eh)return this.roomNameGenerator({type:eG.Generated,names:em,count:eh});let ey=this.getMyMembership();if("join"==ey){let ei=this.currentState.getStateEvents(e_.EventType.RoomThirdPartyInvite);if(null!=ei&&ei.length){let eo=ei.map(ei=>ei.getContent().display_name);return this.roomNameGenerator({type:eG.Generated,subtype:"Inviting",names:eo,count:eo.length+1})}}let eb=em;return eb.length||(eb=this.currentState.getMembers().filter(eo=>eo.userId!==ei&&"invite"!==eo.membership&&"join"!==eo.membership).map(ei=>ei.name)),eb.length&&(ea=this.roomNameGenerator({type:eG.Generated,names:eb,count:eb.length+1})),this.roomNameGenerator({type:eG.EmptyRoom,oldName:ea})}applyNewVisibilityEvent(ei){let eo=ei.asVisibilityChange();if(!eo)return;let ea=ei.getSender();if(!ea)return;let ec=e_.EVENT_VISIBILITY_CHANGE_TYPE.name&&this.currentState.maySendStateEvent(e_.EVENT_VISIBILITY_CHANGE_TYPE.name,ea)||e_.EVENT_VISIBILITY_CHANGE_TYPE.altName&&this.currentState.maySendStateEvent(e_.EVENT_VISIBILITY_CHANGE_TYPE.altName,ea);if(!ec)return;let ed=this.visibilityEvents.get(eo.eventId);if(ed){let eo=ed.length-1,ea=Math.max(0,ed.length-eF);for(;eo>=ea;--eo){let ea=ed[eo];if(ea.getTs()<ei.getTs())break}-1===eo?ed.unshift(ei):ed.splice(eo+1,0,ei)}else this.visibilityEvents.set(eo.eventId,[ei]);let eu=this.findEventById(eo.eventId);eu&&eu.applyVisibilityEvent(eo)}redactVisibilityChangeEvent(ei){if(!ei.isVisibilityEvent)throw Error("expected a visibility change event");let eo=ei.getRelation(),ea=null==eo?void 0:eo.event_id,ec=this.visibilityEvents.get(ea);if(!ec)return;let ed=ec.findIndex(eo=>eo.getId()===ei.getId());if(-1!==ed&&(ec.splice(ed,1),ed===ec.length)){let ei=this.findEventById(ea);if(!ei)return;if(0===ed)this.visibilityEvents.delete(ea),ei.applyVisibilityEvent();else{let eo=ec[ec.length-1],ea=eo.asVisibilityChange();if(!ea)throw Error("at this stage, visibility changes should be well-formed");ei.applyVisibilityEvent(ea)}}}applyPendingVisibilityEvents(ei){let eo=this.visibilityEvents.get(ei.getId());if(!eo||0==eo.length)return;let ea=eo[eo.length-1],ec=ea.asVisibilityChange();ec&&(ec.visible,ea.getTs()<ei.getTs()||ei.applyVisibilityEvent(ec))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}getLastUnthreadedReceiptFor(ei){return this.unthreadedReceipts.get(ei)}fixupNotifications(ei){super.fixupNotifications(ei);let eo=this.getThreads().filter(ei=>this.getThreadUnreadNotificationCount(ei.id,eK.Total)>0);for(let ea of eo)ea.fixupNotifications(ei)}}eo.Room=eW;let eV={[ey.EventStatus.ENCRYPTING]:[ey.EventStatus.SENDING,ey.EventStatus.NOT_SENT,ey.EventStatus.CANCELLED],[ey.EventStatus.SENDING]:[ey.EventStatus.ENCRYPTING,ey.EventStatus.QUEUED,ey.EventStatus.NOT_SENT,ey.EventStatus.SENT],[ey.EventStatus.QUEUED]:[ey.EventStatus.SENDING,ey.EventStatus.NOT_SENT,ey.EventStatus.CANCELLED],[ey.EventStatus.SENT]:[],[ey.EventStatus.NOT_SENT]:[ey.EventStatus.SENDING,ey.EventStatus.QUEUED,ey.EventStatus.CANCELLED],[ey.EventStatus.CANCELLED]:[]},eG=function(ei){return ei[ei.EmptyRoom=0]="EmptyRoom",ei[ei.Generated=1]="Generated",ei[ei.Actual=2]="Actual",ei}({});function eH(ei,eo){let ea=eo-1;if(!ei.length)return"Empty room";if(1===ei.length&&ea<=1)return ei[0];if(2===ei.length&&ea<=2)return`${ei[0]} and ${ei[1]}`;{let eo=ea>1;return eo?`${ei[0]} and ${ea} others`:`${ei[0]} and 1 other`}}eo.RoomNameType=eG},1398:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.SearchResult=void 0;var ec=ea(3558);class ed{static fromJson(ei,eo){let ea=ei.context||{},eu=(ea.events_before||[]).map(eo),eh=(ea.events_after||[]).map(eo),ef=new ec.EventContext(eo(ei.result)),ep=ef.ourEvent.threadRootId;return eu=eu.filter(ei=>ei.threadRootId===ep),eh=eh.filter(ei=>ei.threadRootId===ep),ef.setPaginateToken(ea.start,!0),ef.addEvents(eu,!0),ef.addEvents(eh,!1),ef.setPaginateToken(ea.end,!1),new ed(ei.rank,ef)}constructor(ei,eo){this.rank=ei,this.context=eo}}eo.SearchResult=ed},6969:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.ThreadFilterType=eo.ThreadEvent=eo.Thread=eo.THREAD_RELATION_TYPE=eo.FeatureSupport=eo.FILTER_RELATED_BY_SENDERS=eo.FILTER_RELATED_BY_REL_TYPES=void 0,eo.determineFeatureSupport=eO,eo.threadFilterTypeToFilter=eD;var ed=ec(ea(8416)),eu=ea(2168),eh=ea(771),ef=ea(2481),ep=ea(4369),eg=ea(8910),em=ea(3705),ey=ea(7366),eb=ea(7048),eS=ea(7434),eE=ea(2958),ew=ea(5550);function e_(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eT(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?e_(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):e_(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let eI=function(ei){return ei.New="Thread.new",ei.Update="Thread.update",ei.NewReply="Thread.newReply",ei.ViewThread="Thread.viewThread",ei.Delete="Thread.delete",ei}({});eo.ThreadEvent=eI;let eC=function(ei){return ei[ei.None=0]="None",ei[ei.Experimental=1]="Experimental",ei[ei.Stable=2]="Stable",ei}({});function eO(ei,eo){return ei?eC.Stable:eo?eC.Experimental:eC.None}eo.FeatureSupport=eC;class eR extends eE.ReadReceipt{constructor(ei,eo,ea){var ec;if(super(),this.id=ei,this.rootEvent=eo,(0,ed.default)(this,"timelineSet",void 0),(0,ed.default)(this,"timeline",[]),(0,ed.default)(this,"_currentUserParticipated",!1),(0,ed.default)(this,"reEmitter",void 0),(0,ed.default)(this,"lastEvent",void 0),(0,ed.default)(this,"replyCount",0),(0,ed.default)(this,"lastPendingEvent",void 0),(0,ed.default)(this,"pendingReplyCount",0),(0,ed.default)(this,"room",void 0),(0,ed.default)(this,"client",void 0),(0,ed.default)(this,"pendingEventOrdering",void 0),(0,ed.default)(this,"initialEventsFetched",!eR.hasServerSideSupport),(0,ed.default)(this,"replayEvents",[]),(0,ed.default)(this,"onBeforeRedaction",(ei,eo)=>{null!=ei&&ei.isRelation(eP.name)&&this.room.eventShouldLiveIn(ei).threadId===this.id&&ei.getId()!==this.id&&!eo.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(eI.Update,this))}),(0,ed.default)(this,"onRedaction",async ei=>{if(ei.threadRootId===this.id){if(this.replyCount<=0){for(let ei of this.timeline)this.clearEventMetadata(ei);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit(eI.Delete,this)}else await this.updateThreadMetadata()}}),(0,ed.default)(this,"onTimelineEvent",(ei,eo,ea)=>{ea||eo.addLocalEchoReceipt(ei.getSender(),ei,ew.ReceiptType.Read),this.onEcho(ei,null!=ea&&ea)}),(0,ed.default)(this,"onLocalEcho",ei=>{this.onEcho(ei,!1)}),(0,ed.default)(this,"onEcho",async(ei,eo)=>{ei.threadRootId===this.id&&this.lastEvent!==ei&&(await this.updateThreadMetadata(),ei.isRelation(eP.name)&&(eo||this.emit(eI.NewReply,this,ei)))}),!(null!=ea&&ea.room))throw Error("element-web#22141: A thread requires a room in order to function");this.room=ea.room,this.client=ea.client,this.pendingEventOrdering=null!==(ec=ea.pendingEventOrdering)&&void 0!==ec?ec:eu.PendingEventOrdering.Chronological,this.timelineSet=new em.EventTimelineSet(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new eh.TypedReEmitter(this),this.reEmitter.reEmit(this.timelineSet,[ey.RoomEvent.Timeline,ey.RoomEvent.TimelineReset]),this.room.on(ep.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.room.on(ey.RoomEvent.Redaction,this.onRedaction),this.room.on(ey.RoomEvent.LocalEchoUpdated,this.onLocalEcho),this.timelineSet.on(ey.RoomEvent.Timeline,this.onTimelineEvent),this.processReceipts(ea.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}async fetchRootEvent(){this.rootEvent=this.room.findEventById(this.id);try{let ei=await this.client.fetchRoomEvent(this.roomId,this.id),eo=this.client.getEventMapper();this.rootEvent=eo(ei)}catch(ei){eS.logger.error("Failed to fetch thread root to construct thread with",ei)}await this.processEvent(this.rootEvent)}static setServerSideSupport(ei){eR.hasServerSideSupport=ei,ei!==eC.Stable&&(ek.setPreferUnstable(!0),eM.setPreferUnstable(!0),eP.setPreferUnstable(!0))}static setServerSideListSupport(ei){eR.hasServerSideListSupport=ei}static setServerSideFwdPaginationSupport(ei){eR.hasServerSideFwdPaginationSupport=ei}get roomState(){return this.room.getLiveTimeline().getState(eg.EventTimeline.FORWARDS)}addEventToTimeline(ei,eo){this.findEventById(ei.getId())||(this.timelineSet.addEventToTimeline(ei,this.liveTimeline,{toStartOfTimeline:eo,fromCache:!1,roomState:this.roomState}),this.timeline=this.events)}addEvents(ei,eo){ei.forEach(ei=>this.addEvent(ei,eo,!1)),this.updateThreadMetadata()}async addEvent(ei,eo,ea=!0){this.setEventMetadata(ei);let ec=this.lastReply(),ed=!ec||ei.localTimestamp>=ec.localTimestamp;if(eR.hasServerSideSupport){if(!eo&&this.initialEventsFetched&&ed)this.addEventToTimeline(ei,!1),this.fetchEditsWhereNeeded(ei);else if(ei.isRelation(ef.RelationType.Annotation)||ei.isRelation(ef.RelationType.Replace)){var eu,eh,ep;this.initialEventsFetched?this.addEventToTimeline(ei,eo):null===(ep=this.replayEvents)||void 0===ep||ep.push(ei),null===(eu=this.timelineSet.relations)||void 0===eu||eu.aggregateParentEvent(ei),null===(eh=this.timelineSet.relations)||void 0===eh||eh.aggregateChildEvent(ei,this.timelineSet);return}}else this.addEventToTimeline(ei,eo),this.client.decryptEventIfNeeded(ei,{});(!eR.hasServerSideSupport||!this.rootEvent)&&ei.isRelation(eP.name)&&this.replyCount++,ea&&(this.emit(eI.NewReply,this,ei),this.updateThreadMetadata())}async processEvent(ei){ei&&(this.setEventMetadata(ei),await this.fetchEditsWhereNeeded(ei)),this.timeline=this.events}processReceipts(ei=[]){for(let{eventId:eo,receiptType:ea,userId:ec,receipt:ed,synthetic:eu}of ei)this.addReceiptToStructure(eo,ea,ec,ed,eu)}getRootEventBundledRelationship(ei=this.rootEvent){return null==ei?void 0:ei.getServerAggregatedRelation(eP.name)}async processRootEvent(){let ei=this.getRootEventBundledRelationship();if(eR.hasServerSideSupport&&ei){this.replyCount=ei.count,this._currentUserParticipated=!!ei.current_user_participated;let eo=this.client.getEventMapper();this.lastEvent=eo(eT(eT({},ei.latest_event),{},{room_id:this.roomId})),this.updatePendingReplyCount(),await this.processEvent(this.lastEvent)}}updatePendingReplyCount(){let ei=this.pendingEventOrdering===eu.PendingEventOrdering.Detached?this.room.getPendingEvents():this.events,eo=ei.filter(ei=>{var eo;return ei.threadRootId===this.id&&ei.isRelation(eP.name)&&null!==ei.status&&ei.getId()!==(null===(eo=this.lastEvent)||void 0===eo?void 0:eo.getId())});this.lastPendingEvent=eo.length?eo[eo.length-1]:void 0,this.pendingReplyCount=eo.length}async resetLiveTimeline(ei,eo){var ea,ec;let ed,eu;let eh=this.liveTimeline;this.timelineSet.resetLiveTimeline(null!=ei?ei:void 0,null!=eo?eo:void 0);let ef=this.liveTimeline;if(ei){let eo=await this.client.createMessagesRequest(this.roomId,ei,1,eg.Direction.Forward);ed=eo.end}if(eo){let ei=await this.client.createMessagesRequest(this.roomId,eo,1,eg.Direction.Backward);eu=ei.start}eo&&eh.getPaginationToken(eg.Direction.Forward)===eo&&eh.setPaginationToken(null!==(ea=eu)&&void 0!==ea?ea:null,eg.Direction.Forward),ei&&ef.getPaginationToken(eg.Direction.Backward)===ei&&ef.setPaginationToken(null!==(ec=ed)&&void 0!==ec?ec:null,eg.Direction.Backward)}async updateThreadMetadata(){if(this.updatePendingReplyCount(),eR.hasServerSideSupport&&(this.initialEventsFetched||await this.processRootEvent(),await this.fetchRootEvent()),await this.processRootEvent(),!this.initialEventsFetched){this.initialEventsFetched=!0;try{for(let ei of(0===this.replyCount&&this.rootEvent?(this.timelineSet.addEventsToTimeline([this.rootEvent],!0,this.liveTimeline,null),this.liveTimeline.setPaginationToken(null,eg.Direction.Backward)):await this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0,limit:Math.max(1,this.length)}),this.replayEvents))this.addEvent(ei,!1);this.replayEvents=null,this.emit(ey.RoomEvent.TimelineReset,this.room,this.timelineSet,!0)}catch(ei){eS.logger.error("Failed to load start of newly created thread: ",ei),this.initialEventsFetched=!1}}this.emit(eI.Update,this)}async fetchEditsWhereNeeded(...ei){return Promise.all(ei.filter(ei=>ei.isEncrypted()).map(ei=>{if(!ei.isRelation())return this.client.relations(this.roomId,ei.getId(),ef.RelationType.Replace,ei.getType(),{limit:1}).then(eo=>{eo.events.length&&ei.makeReplaced(eo.events[0])}).catch(ei=>{eS.logger.error("Failed to load edits for encrypted thread event",ei)})}))}setEventMetadata(ei){ei&&(eg.EventTimeline.setEventMetadata(ei,this.roomState,!1),ei.setThread(this))}clearEventMetadata(ei){if(ei){var eo,ea,ec;ei.setThread(void 0),null===(eo=ei.event)||void 0===eo||null===(ea=eo.unsigned)||void 0===ea||null===(ec=ea["m.relations"])||void 0===ec||delete ec[eP.name]}}findEventById(ei){return this.timelineSet.findEventById(ei)}lastReply(ei=()=>!0){for(let eo=this.timeline.length-1;eo>=0;eo--){let ea=this.timeline[eo];if(ei(ea))return ea}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var ei,eo;return null!==(ei=null!==(eo=this.lastPendingEvent)&&void 0!==eo?eo:this.lastEvent)&&void 0!==ei?ei:this.lastReply()}get events(){return this.liveTimeline.getEvents()}has(ei){return this.timelineSet.findEventById(ei) instanceof ep.MatrixEvent}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(ei,eo){throw Error("Unsupported function on the thread model")}getEventReadUpTo(ei,eo){let ea=ei===this.client.getUserId(),ec=this.timeline[this.timeline.length-1];if(ea&&ec){let ei=ec.getTs()<this.room.getOldestThreadedReceiptTs(),eo=ec.getId();if(ei&&eo)return eo}let ed=super.getEventReadUpTo(ei,eo);if(ec){let eo=this.room.getLastUnthreadedReceiptFor(ei);if(!eo)return ed;for(let ei=(null===(eu=this.timeline)||void 0===eu?void 0:eu.length)-1;ei>=0;--ei){var eu,eh;let ea=this.timeline[ei];if(ea.getId()===ed)break;if(ea.getTs()<eo.ts)return null!==(eh=ea.getId())&&void 0!==eh?eh:ed}}return ed}hasUserReadEvent(ei,eo){if(ei===this.client.getUserId()){var ea,ec,ed,eu,eh,ef;let eo=(null!==(ea=null===(ec=this.lastReply())||void 0===ec?void 0:ec.getTs())&&void 0!==ea?ea:0)<this.room.getOldestThreadedReceiptTs(),ep=null!==(ed=null===(eu=this.room.getLastUnthreadedReceiptFor(ei))||void 0===eu?void 0:eu.ts)&&void 0!==ed?ed:0,eg=(null!==(eh=this===null||void 0===this?void 0:null===(ef=this.lastReply())||void 0===ef?void 0:ef.getTs())&&void 0!==eh?eh:0)<ep;if(eo||eg)return!0}return super.hasUserReadEvent(ei,eo)}setUnread(ei,eo){return this.room.setThreadUnreadNotificationCount(this.id,ei,eo)}}eo.Thread=eR,(0,ed.default)(eR,"hasServerSideSupport",eC.None),(0,ed.default)(eR,"hasServerSideListSupport",eC.None),(0,ed.default)(eR,"hasServerSideFwdPaginationSupport",eC.None);let ek=new eb.ServerControlledNamespacedValue("related_by_senders","io.element.relation_senders");eo.FILTER_RELATED_BY_SENDERS=ek;let eM=new eb.ServerControlledNamespacedValue("related_by_rel_types","io.element.relation_types");eo.FILTER_RELATED_BY_REL_TYPES=eM;let eP=new eb.ServerControlledNamespacedValue("m.thread","io.element.thread");eo.THREAD_RELATION_TYPE=eP;let eA=function(ei){return ei[ei.My=0]="My",ei[ei.All=1]="All",ei}({});function eD(ei){return ei===eA.My?"participated":"all"}eo.ThreadFilterType=eA},5861:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.TypedEventEmitter=eo.EventEmitterEvents=void 0;var ec=ea(7187);let ed=function(ei){return ei.NewListener="newListener",ei.RemoveListener="removeListener",ei.Error="error",ei}({});eo.EventEmitterEvents=ed;class eu extends ec.EventEmitter{addListener(ei,eo){return super.addListener(ei,eo)}emit(ei,...eo){return super.emit(ei,...eo)}listenerCount(ei){return super.listenerCount(ei)}listeners(ei){return super.listeners(ei)}off(ei,eo){return super.off(ei,eo)}on(ei,eo){return super.on(ei,eo)}once(ei,eo){return super.once(ei,eo)}prependListener(ei,eo){return super.prependListener(ei,eo)}prependOnceListener(ei,eo){return super.prependOnceListener(ei,eo)}removeAllListeners(ei){return super.removeAllListeners(ei)}removeListener(ei,eo){return super.removeListener(ei,eo)}rawListeners(ei){return super.rawListeners(ei)}}eo.TypedEventEmitter=eu},3998:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.UserEvent=eo.User=void 0;var ed=ec(ea(8416)),eu=ea(5861);let eh=function(ei){return ei.DisplayName="User.displayName",ei.AvatarUrl="User.avatarUrl",ei.Presence="User.presence",ei.CurrentlyActive="User.currentlyActive",ei.LastPresenceTs="User.lastPresenceTs",ei}({});eo.UserEvent=eh;class ef extends eu.TypedEventEmitter{constructor(ei){super(),this.userId=ei,(0,ed.default)(this,"modified",-1),(0,ed.default)(this,"displayName",void 0),(0,ed.default)(this,"rawDisplayName",void 0),(0,ed.default)(this,"avatarUrl",void 0),(0,ed.default)(this,"presenceStatusMsg",void 0),(0,ed.default)(this,"presence","offline"),(0,ed.default)(this,"lastActiveAgo",0),(0,ed.default)(this,"lastPresenceTs",0),(0,ed.default)(this,"currentlyActive",!1),(0,ed.default)(this,"events",{}),this.displayName=ei,this.rawDisplayName=ei,this.updateModifiedTime()}setPresenceEvent(ei){if("m.presence"!==ei.getType())return;let eo=null===this.events.presence;this.events.presence=ei;let ea=[];for(let ec of((ei.getContent().presence!==this.presence||eo)&&ea.push(eh.Presence),ei.getContent().avatar_url&&ei.getContent().avatar_url!==this.avatarUrl&&ea.push(eh.AvatarUrl),ei.getContent().displayname&&ei.getContent().displayname!==this.displayName&&ea.push(eh.DisplayName),void 0!==ei.getContent().currently_active&&ei.getContent().currently_active!==this.currentlyActive&&ea.push(eh.CurrentlyActive),this.presence=ei.getContent().presence,ea.push(eh.LastPresenceTs),ei.getContent().status_msg&&(this.presenceStatusMsg=ei.getContent().status_msg),ei.getContent().displayname&&(this.displayName=ei.getContent().displayname),ei.getContent().avatar_url&&(this.avatarUrl=ei.getContent().avatar_url),this.lastActiveAgo=ei.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=ei.getContent().currently_active,this.updateModifiedTime(),ea))this.emit(ec,ei,this)}setDisplayName(ei){let eo=this.displayName;this.displayName=ei,ei!==eo&&this.updateModifiedTime()}setRawDisplayName(ei){this.rawDisplayName=ei}setAvatarUrl(ei){let eo=this.avatarUrl;this.avatarUrl=ei,ei!==eo&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}eo.User=ef},1707:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.PushProcessor=void 0;var ed=ec(ea(8416)),eu=ea(3102),eh=ea(7434),ef=ea(1470),ep=ea(2481);function eg(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function em(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eg(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eg(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let ey=[ef.PushRuleKind.Override,ef.PushRuleKind.ContentSpecific,ef.PushRuleKind.RoomSpecific,ef.PushRuleKind.SenderSpecific,ef.PushRuleKind.Underride],eb=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:ef.ConditionKind.EventMatch,key:"type",pattern:"m.reaction"}],actions:[ef.PushRuleActionName.DontNotify]},{rule_id:ef.RuleId.IsUserMention,default:!0,enabled:!0,conditions:[{kind:ef.ConditionKind.EventPropertyContains,key:"content.org\\.matrix\\.msc3952\\.mentions.user_ids",value:""}],actions:[ef.PushRuleActionName.Notify,{set_tweak:ef.TweakName.Highlight}]},{rule_id:ef.RuleId.IsRoomMention,default:!0,enabled:!0,conditions:[{kind:ef.ConditionKind.EventPropertyIs,key:"content.org\\.matrix\\.msc3952\\.mentions.room",value:!0},{kind:ef.ConditionKind.SenderNotificationPermission,key:"room"}],actions:[ef.PushRuleActionName.Notify,{set_tweak:ef.TweakName.Highlight}]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:ef.ConditionKind.EventMatch,key:"type",pattern:ep.EventType.RoomServerAcl},{kind:ef.ConditionKind.EventMatch,key:"state_key",pattern:""}],actions:[]}],eS=[{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:ef.ConditionKind.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:ef.ConditionKind.CallStarted}],actions:[ef.PushRuleActionName.Notify,{set_tweak:ef.TweakName.Sound,value:"default"}]}];class eE{constructor(ei){this.client=ei,(0,ed.default)(this,"parsedKeys",new Map)}static actionListToActionsObject(ei){let eo={notify:!1,tweaks:{}};for(let ea of ei)ea===ef.PushRuleActionName.Notify?eo.notify=!0:"object"==typeof ea&&(void 0===ea.value&&(ea.value=!0),eo.tweaks[ea.set_tweak]=ea.value);return eo}static rewriteDefaultRules(ei,eo){var ea;let ec=JSON.parse(JSON.stringify(ei));ec||(ec={}),ec.global||(ec.global={}),ec.global.override||(ec.global.override=[]),ec.global.underride||(ec.global.underride=[]);let ed=ec.global.override;for(let ei of eb){let ea;let ec=ed.find(eo=>eo.rule_id===ei.rule_id);if(ei.rule_id===ef.RuleId.IsUserMention){if(!eo)continue;(ea=JSON.parse(JSON.stringify(ei))).conditions[0].value=eo}else ea=ei;if(ec)ec.default=ea.default,ec.conditions=ea.conditions,ec.actions=ea.actions;else{let ei=ea.rule_id;eh.logger.warn(`Adding default global override for ${ei}`),ed.push(ea)}}let eu=null!==(ea=ec.global.underride)&&void 0!==ea?ea:[];for(let ei of eS){let eo=eu.find(eo=>eo.rule_id===ei.rule_id);if(eo)eo.default=ei.default,eo.conditions=ei.conditions,eo.actions=ei.actions;else{let eo=ei.rule_id;eh.logger.warn(`Adding default global underride for ${eo}`),eu.push(ei)}}return ec}updateCachedPushRuleKeys(ei){ei||(ei={}),ei.global||(ei.global={}),ei.global.override||(ei.global.override=[]),ei.global.room||(ei.global.room=[]),ei.global.sender||(ei.global.sender=[]),ei.global.underride||(ei.global.underride=[]);let eo=new Set(this.parsedKeys.keys());for(let ea of[ei.global.override,ei.global.room,ei.global.sender,ei.global.underride])for(let ei of ea)if(ei.conditions)for(let ea of ei.conditions)ea.kind===ef.ConditionKind.EventMatch&&(eo.delete(ea.key),this.parsedKeys.set(ea.key,eE.partsForDottedKey(ea.key)));eo.forEach(ei=>this.parsedKeys.delete(ei))}matchingRuleFromKindSet(ei,eo){for(let ea of ey){let ec=eo[ea];if(ec)for(let eo of ec){if(!eo.enabled)continue;let ec=this.templateRuleToRaw(ea,eo);if(ec&&this.ruleMatchesEvent(ec,ei))return em(em({},eo),{},{kind:ea})}}return null}templateRuleToRaw(ei,eo){let ea={rule_id:eo.rule_id,actions:eo.actions,conditions:[]};switch(ei){case ef.PushRuleKind.Underride:case ef.PushRuleKind.Override:ea.conditions=eo.conditions;break;case ef.PushRuleKind.RoomSpecific:if(!eo.rule_id)return null;ea.conditions.push({kind:ef.ConditionKind.EventMatch,key:"room_id",value:eo.rule_id});break;case ef.PushRuleKind.SenderSpecific:if(!eo.rule_id)return null;ea.conditions.push({kind:ef.ConditionKind.EventMatch,key:"user_id",value:eo.rule_id});break;case ef.PushRuleKind.ContentSpecific:if(!eo.pattern)return null;ea.conditions.push({kind:ef.ConditionKind.EventMatch,key:"content.body",pattern:eo.pattern})}return ea}eventFulfillsCondition(ei,eo){switch(ei.kind){case ef.ConditionKind.EventMatch:return this.eventFulfillsEventMatchCondition(ei,eo);case ef.ConditionKind.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(ei,eo);case ef.ConditionKind.EventPropertyContains:return this.eventFulfillsEventPropertyContains(ei,eo);case ef.ConditionKind.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(ei,eo);case ef.ConditionKind.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(ei,eo);case ef.ConditionKind.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(ei,eo);case ef.ConditionKind.CallStarted:case ef.ConditionKind.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(ei,eo)}return!1}eventFulfillsSenderNotifPermCondition(ei,eo){let ea=ei.key;if(!ea)return!1;let ec=this.client.getRoom(eo.getRoomId());return null!=ec&&!!ec.currentState&&ec.currentState.mayTriggerNotifOfType(ea,eo.getSender())}eventFulfillsRoomMemberCountCondition(ei,eo){if(!ei.is)return!1;let ea=this.client.getRoom(eo.getRoomId());if(!ea||!ea.currentState||!ea.currentState.members)return!1;let ec=ea.currentState.getJoinedMemberCount(),ed=ei.is.match(/^([=<>]*)(\d*)$/);if(!ed)return!1;let eu=ed[1],eh=parseInt(ed[2]);if(isNaN(eh))return!1;switch(eu){case"":case"==":return ec==eh;case"<":return ec<eh;case">":return ec>eh;case"<=":return ec<=eh;case">=":return ec>=eh;default:return!1}}eventFulfillsDisplayNameCondition(ei,eo){var ea;let ec=eo.getContent();if(eo.isEncrypted()&&eo.getClearContent()&&(ec=eo.getClearContent()),!ec||!ec.body||"string"!=typeof ec.body)return!1;let ed=this.client.getRoom(eo.getRoomId()),eh=null==ed?void 0:null===(ea=ed.currentState)||void 0===ea?void 0:ea.getMember(this.client.credentials.userId);if(!eh)return!1;let ef=eh.name,ep=RegExp("(^|\\W)"+(0,eu.escapeRegExp)(ef)+"(\\W|$)","i");return ec.body.search(ep)>-1}eventFulfillsEventMatchCondition(ei,eo){if(!ei.key)return!1;let ea=this.valueForDottedKey(ei.key,eo);if("string"!=typeof ea)return!1;if(ei.value)return ei.value===ea;if("string"!=typeof ei.pattern)return!1;let ec="content.body"===ei.key?this.createCachedRegex("(^|\\W)",ei.pattern,"(\\W|$)"):this.createCachedRegex("^",ei.pattern,"$");return!!ea.match(ec)}eventFulfillsEventPropertyIsCondition(ei,eo){return!!ei.key&&void 0!==ei.value&&ei.value===this.valueForDottedKey(ei.key,eo)}eventFulfillsEventPropertyContains(ei,eo){if(!ei.key||void 0===ei.value)return!1;let ea=this.valueForDottedKey(ei.key,eo);return!!Array.isArray(ea)&&ea.includes(ei.value)}eventFulfillsCallStartedCondition(ei,eo){return["m.ring","m.prompt"].includes(eo.getContent()["m.intent"])&&!("m.terminated"in eo.getContent())&&(eo.getPrevContent()["m.terminated"]!==eo.getContent()["m.terminated"]||(0,eu.deepCompare)(eo.getPrevContent(),{}))}createCachedRegex(ei,eo,ea){return eE.cachedGlobToRegex[eo]||(eE.cachedGlobToRegex[eo]=RegExp(ei+(0,eu.globToRegexp)(eo)+ea,"i")),eE.cachedGlobToRegex[eo]}static partsForDottedKey(ei){let eo=[],ea="",ec=!1;for(let ed of ei){if(ec){"\\"===ed||"."===ed?ea+=ed:ea+="\\"+ed,ec=!1;continue}"."==ed?(eo.push(ea),ea=""):"\\"==ed?ec=!0:ea+=ed}return ec&&(ea+="\\"),eo.push(ea),eo}valueForDottedKey(ei,eo){let ea,ec=this.parsedKeys.get(ei);void 0===ec&&(ec=eE.partsForDottedKey(ei),this.parsedKeys.set(ei,ec));let ed=ec[0],eh=0;for("content"===ed?(ea=eo.getContent(),++eh):"type"===ed?(ea=eo.getType(),++eh):ea=eo.event;eh<ec.length;++eh){if((0,eu.isNullOrUndefined)(ea))return;let ei=ec[eh];ea=ea[ei]}return ea}matchingRuleForEventWithRulesets(ei,eo){return eo&&ei.getSender()!==this.client.getSafeUserId()?this.matchingRuleFromKindSet(ei,eo.global):null}pushActionsForEventAndRulesets(ei,eo){let ea=this.matchingRuleForEventWithRulesets(ei,eo);if(!ea)return{};let ec=eE.actionListToActionsObject(ea.actions);return void 0===ec.tweaks.highlight&&(ec.tweaks.highlight=ea.kind==ef.PushRuleKind.ContentSpecific),{actions:ec,rule:ea}}ruleMatchesEvent(ei,eo){var ea;return(!this.client.supportsIntentionalMentions()||void 0===eo.getContent()["org.matrix.msc3952.mentions"]||ei.rule_id!==ef.RuleId.ContainsUserName&&ei.rule_id!==ef.RuleId.ContainsDisplayName&&ei.rule_id!==ef.RuleId.AtRoomNotification)&&!(null!==(ea=ei.conditions)&&void 0!==ea&&ea.some(ei=>!this.eventFulfillsCondition(ei,eo)))}actionsForEvent(ei){let{actions:eo}=this.pushActionsForEventAndRulesets(ei,this.client.pushRules);return eo||{}}actionsAndRuleForEvent(ei){return this.pushActionsForEventAndRulesets(ei,this.client.pushRules)}getPushRuleById(ei){var eo;let ea=this.getPushRuleAndKindById(ei);return null!==(eo=null==ea?void 0:ea.rule)&&void 0!==eo?eo:null}getPushRuleAndKindById(ei){for(let ea of["global"]){var eo;if((null===(eo=this.client.pushRules)||void 0===eo?void 0:eo[ea])!==void 0){for(let eo of ey)if(void 0!==this.client.pushRules[ea][eo]){for(let ec of this.client.pushRules[ea][eo])if(ec.rule_id===ei)return{rule:ec,kind:eo}}}}return null}}eo.PushProcessor=eE,(0,ed.default)(eE,"cachedGlobToRegex",{})},8401:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.randomLowercaseString=eh,eo.randomString=eu,eo.randomUppercaseString=ef;let ea="abcdefghijklmnopqrstuvwxyz",ec="ABCDEFGHIJKLMNOPQRSTUVWXYZ",ed="0123456789";function eu(ei){return ep(ei,ec+ea+ed)}function eh(ei){return ep(ei,ea)}function ef(ei){return ep(ei,ec)}function ep(ei,eo){let ea="";for(let ec=0;ec<ei;++ec)ea+=eo.charAt(Math.floor(Math.random()*eo.length));return ea}},2731:function(ei,eo,ea){"use strict";let ec;Object.defineProperty(eo,"__esModule",{value:!0}),eo.clearTimeout=em,eo.setTimeout=eg;var ed=ea(7434);let eu=1e3,eh=0,ef=[],ep=function(...ei){};function eg(ei,eo,...ea){(eo=eo||0)<0&&(eo=0);let ec=Date.now()+eo,ed=eh++;ep("setTimeout: scheduling cb",ed,"at",ec,"(delay",eo,")");let eu={runAt:ec,func:ei,params:ea,key:ed},em=eS(ef,function(ei){return ei.runAt-ec});return ef.splice(em,0,eu),ey(),ed}function em(ei){let eo;if(0!==ef.length){for(eo=0;eo<ef.length;eo++){let ea=ef[eo];if(ea.key==ei){ef.splice(eo,1);break}}0===eo&&ey()}}function ey(){ec&&ea.g.clearTimeout(ec);let ei=ef[0];if(!ei){ep("scheduleRealCallback: no more callbacks, not rescheduling");return}let eo=Date.now(),ed=Math.min(ei.runAt-eo,eu);ep("scheduleRealCallback: now:",eo,"delay:",ed),ec=ea.g.setTimeout(eb,ed)}function eb(){let ei=Date.now();ep("runCallbacks: now:",ei);let eo=[];for(;;){let ea=ef[0];if(!ea||ea.runAt>ei)break;let ec=ef.shift();ep("runCallbacks: popping",ec.key),eo.push(ec)}for(let ei of(ey(),eo))try{ei.func.apply(ea.g,ei.params)}catch(ei){ed.logger.error("Uncaught exception in callback function",ei)}}function eS(ei,eo){let ea=0,ec=ei.length;for(;ea<ec;){let ed=ea+ec>>1,eu=eo(ei[ed]);eu>0?ec=ed:ea=ed+1}return ea}},8180:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.KeyClaimManager=void 0;var ed=ec(ea(8416));class eu{constructor(ei,eo){this.olmMachine=ei,this.outgoingRequestProcessor=eo,(0,ed.default)(this,"currentClaimPromise",void 0),(0,ed.default)(this,"stopped",!1),this.currentClaimPromise=Promise.resolve()}stop(){this.stopped=!0}ensureSessionsForUsers(ei){let eo=this.currentClaimPromise.catch(()=>{}).then(()=>this.ensureSessionsForUsersInner(ei));return this.currentClaimPromise=eo,eo}async ensureSessionsForUsersInner(ei){if(this.stopped)throw Error("Cannot ensure Olm sessions: shutting down");let eo=await this.olmMachine.getMissingSessions(ei);eo&&await this.outgoingRequestProcessor.makeOutgoingRequest(eo)}}eo.KeyClaimManager=eu},8251:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.OutgoingRequestProcessor=void 0;var ec=ea(1752),ed=ea(7434),eu=ea(95);class eh{constructor(ei,eo){this.olmMachine=ei,this.http=eo}async makeOutgoingRequest(ei){let eo;if(ei instanceof ec.KeysUploadRequest)eo=await this.rawJsonRequest(eu.Method.Post,"/_matrix/client/v3/keys/upload",{},ei.body);else if(ei instanceof ec.KeysQueryRequest)eo=await this.rawJsonRequest(eu.Method.Post,"/_matrix/client/v3/keys/query",{},ei.body);else if(ei instanceof ec.KeysClaimRequest)eo=await this.rawJsonRequest(eu.Method.Post,"/_matrix/client/v3/keys/claim",{},ei.body);else if(ei instanceof ec.SignatureUploadRequest)eo=await this.rawJsonRequest(eu.Method.Post,"/_matrix/client/v3/keys/signatures/upload",{},ei.body);else if(ei instanceof ec.KeysBackupRequest)eo=await this.rawJsonRequest(eu.Method.Put,"/_matrix/client/v3/room_keys/keys",{},ei.body);else if(ei instanceof ec.ToDeviceRequest){let ea=`/_matrix/client/v3/sendToDevice/${encodeURIComponent(ei.event_type)}/`+encodeURIComponent(ei.txn_id);eo=await this.rawJsonRequest(eu.Method.Put,ea,{},ei.body)}else if(ei instanceof ec.RoomMessageRequest){let ea=`/_matrix/client/v3/room/${encodeURIComponent(ei.room_id)}/send/${encodeURIComponent(ei.event_type)}/${encodeURIComponent(ei.txn_id)}`;eo=await this.rawJsonRequest(eu.Method.Put,ea,{},ei.body)}else ed.logger.warn("Unsupported outgoing message",Object.getPrototypeOf(ei)),eo="";ei.id&&await this.olmMachine.markRequestAsSent(ei.id,ei.type,eo)}async rawJsonRequest(ei,eo,ea,ec){let eu={json:!1,headers:{"Content-Type":"application/json",Accept:"application/json"},prefix:""};try{let eh=await this.http.authedRequest(ei,eo,ea,ec,eu);return ed.logger.info(`rust-crypto: successfully made HTTP request: ${ei} ${eo}`),eh}catch(ea){throw ed.logger.warn(`rust-crypto: error making HTTP request: ${ei} ${eo}: ${ea}`),ea}}}eo.OutgoingRequestProcessor=eh},5015:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RoomEncryptor=void 0;var ed=ec(ea(8416)),eu=ea(1752),eh=ea(2481),ef=ea(7434);class ep{constructor(ei,eo,ea,ec,eu){this.olmMachine=ei,this.keyClaimManager=eo,this.outgoingRequestProcessor=ea,this.room=ec,this.encryptionSettings=eu,(0,ed.default)(this,"prefixedLogger",void 0),this.prefixedLogger=ef.logger.withPrefix(`[${ec.roomId} encryption]`)}onCryptoEvent(ei){JSON.stringify(this.encryptionSettings)!=JSON.stringify(ei)&&this.prefixedLogger.error("Ignoring m.room.encryption event which requests a change of config")}onRoomMembership(ei){this.prefixedLogger.debug(`${ei.membership} event for ${ei.userId}`),("join"==ei.membership||"invite"==ei.membership&&this.room.shouldEncryptForInvitedMembers())&&(this.prefixedLogger.debug(`starting to track devices for: ${ei.userId}`),this.olmMachine.updateTrackedUsers([new eu.UserId(ei.userId)]))}async ensureEncryptionSession(){if("m.megolm.v1.aes-sha2"!==this.encryptionSettings.algorithm)throw Error(`Cannot encrypt in ${this.room.roomId} for unsupported algorithm '${this.encryptionSettings.algorithm}'`);let ei=await this.room.getEncryptionTargetMembers();this.prefixedLogger.debug(`Encrypting for users (shouldEncryptForInvitedMembers: ${this.room.shouldEncryptForInvitedMembers()}):`,ei.map(ei=>`${ei.userId} (${ei.membership})`));let eo=ei.map(ei=>new eu.UserId(ei.userId));await this.keyClaimManager.ensureSessionsForUsers(eo),this.prefixedLogger.debug("Sessions for users are ready; now sharing room key");let ea=new eu.EncryptionSettings,ec=await this.olmMachine.shareRoomKey(new eu.RoomId(this.room.roomId),eo,ea);if(ec)for(let ei of ec)await this.outgoingRequestProcessor.makeOutgoingRequest(ei)}async forceDiscardSession(){let ei=await this.olmMachine.invalidateGroupSession(new eu.RoomId(this.room.roomId));ei&&this.prefixedLogger.info("Discarded existing group session")}async encryptEvent(ei){await this.ensureEncryptionSession();let eo=await this.olmMachine.encryptRoomEvent(new eu.RoomId(this.room.roomId),ei.getType(),JSON.stringify(ei.getContent()));ei.makeEncrypted(eh.EventType.RoomMessageEncrypted,JSON.parse(eo),this.olmMachine.identityKeys.curve25519.toBase64(),this.olmMachine.identityKeys.ed25519.toBase64())}}eo.RoomEncryptor=ep},4576:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.RUST_SDK_STORE_PREFIX=void 0;let ea="matrix-js-sdk";eo.RUST_SDK_STORE_PREFIX=ea},2713:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.initRustCrypto=eg;var ec=ep(ea(1752)),ed=ea(2350),eu=ea(7434),eh=ea(4576);function ef(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(ef=function(ei){return ei?ea:eo})(ei)}function ep(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=ef(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}async function eg(ei,eo,ea){await ec.initAsync(),new ec.Tracing(ec.LoggerLevel.Trace).turnOn();let ef=new ec.UserId(eo),ep=new ec.DeviceId(ea);eu.logger.info("Init OlmMachine");let eg=await ec.OlmMachine.initialize(ef,ep,eh.RUST_SDK_STORE_PREFIX,"test pass"),em=new ed.RustCrypto(eg,ei,eo,ea);return await eg.registerRoomKeyUpdatedCallback(ei=>em.onRoomKeysUpdated(ei)),eu.logger.info("Completed rust crypto-sdk setup"),em}},2350:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RustCrypto=void 0;var ed=ec(ea(8416)),eu=eS(ea(1752)),eh=ea(7434),ef=ea(3075),ep=ea(5015),eg=ea(8251),em=ea(8180),ey=ea(3102);function eb(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eb=function(ei){return ei?ea:eo})(ei)}function eS(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eb(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}class eE{constructor(ei,eo,ea,ec){this.olmMachine=ei,(0,ed.default)(this,"globalErrorOnUnknownDevices",!1),(0,ed.default)(this,"stopped",!1),(0,ed.default)(this,"outgoingRequestLoopRunning",!1),(0,ed.default)(this,"roomEncryptors",{}),(0,ed.default)(this,"eventDecryptor",void 0),(0,ed.default)(this,"keyClaimManager",void 0),(0,ed.default)(this,"outgoingRequestProcessor",void 0),(0,ed.default)(this,"globalBlacklistUnverifiedDevices",!1),this.outgoingRequestProcessor=new eg.OutgoingRequestProcessor(ei,eo),this.keyClaimManager=new em.KeyClaimManager(ei,this.outgoingRequestProcessor),this.eventDecryptor=new ew(ei)}stop(){this.stopped||(this.stopped=!0,this.keyClaimManager.stop(),this.olmMachine.close())}async encryptEvent(ei,eo){let ea=ei.getRoomId(),ec=this.roomEncryptors[ea];if(!ec)throw Error(`Cannot encrypt event in unconfigured room ${ea}`);await ec.encryptEvent(ei)}async decryptEvent(ei){let eo=ei.getRoomId();if(!eo)throw Error("to-device event was not decrypted in preprocessToDeviceMessages");return await this.eventDecryptor.attemptEventDecryption(ei)}getEventEncryptionInfo(ei){var eo;let ea={};return(ea.senderKey=null!==(eo=ei.getSenderKey())&&void 0!==eo?eo:void 0,ea.algorithm=ei.getWireContent().algorithm,ea.senderKey&&ea.algorithm)?(ea.encrypted=!0,ea.authenticated=!0,ea.mismatchedSender=!0,ea):(ea.encrypted=!1,ea)}checkUserTrust(ei){return new ef.UserTrustLevel(!1,!1,!1)}checkDeviceTrust(ei,eo){return new ef.DeviceTrustLevel(!1,!1,!1,!1)}async userHasCrossSigningKeys(){return!1}prepareToEncrypt(ei){let eo=this.roomEncryptors[ei.roomId];eo&&eo.ensureEncryptionSession()}forceDiscardSession(ei){var eo;return null===(eo=this.roomEncryptors[ei])||void 0===eo?void 0:eo.forceDiscardSession()}async exportRoomKeys(){return[]}async receiveSyncChanges({events:ei,oneTimeKeysCounts:eo=new Map,unusedFallbackKeys:ea=new Set,devices:ec=new eu.DeviceLists}){let ed=await this.olmMachine.receiveSyncChanges(ei?JSON.stringify(ei):"[]",ec,eo,ea);return JSON.parse(ed)}preprocessToDeviceMessages(ei){return this.receiveSyncChanges({events:ei})}async processKeyCounts(ei,eo){let ea=ei&&new Map(Object.entries(ei)),ec=eo&&new Set(eo);(void 0!==ea||void 0!==ec)&&await this.receiveSyncChanges({oneTimeKeysCounts:ea,unusedFallbackKeys:ec})}async processDeviceLists(ei){var eo,ea;let ec=new eu.DeviceLists(null===(eo=ei.changed)||void 0===eo?void 0:eo.map(ei=>new eu.UserId(ei)),null===(ea=ei.left)||void 0===ea?void 0:ea.map(ei=>new eu.UserId(ei)));await this.receiveSyncChanges({devices:ec})}async onCryptoEvent(ei,eo){let ea=eo.getContent(),ec=this.roomEncryptors[ei.roomId];ec?ec.onCryptoEvent(ea):this.roomEncryptors[ei.roomId]=new ep.RoomEncryptor(this.olmMachine,this.keyClaimManager,this.outgoingRequestProcessor,ei,ea);let ed=await ei.getEncryptionTargetMembers();eh.logger.debug(`[${ei.roomId} encryption] starting to track devices for: `,ed.map(ei=>`${ei.userId} (${ei.membership})`)),await this.olmMachine.updateTrackedUsers(ed.map(ei=>new eu.UserId(ei.userId)))}onSyncCompleted(ei){this.outgoingRequestLoop()}onRoomMembership(ei,eo,ea){let ec=this.roomEncryptors[ei.getRoomId()];ec&&ec.onRoomMembership(eo)}async onRoomKeysUpdated(ei){for(let eo of ei)this.onRoomKeyUpdated(eo)}onRoomKeyUpdated(ei){eh.logger.debug(`Got update for session ${ei.senderKey.toBase64()}|${ei.sessionId} in ${ei.roomId.toString()}`);let eo=this.eventDecryptor.getEventsPendingRoomKey(ei);if(0!==eo.length)for(let ei of(eh.logger.debug("Retrying decryption on events:",eo.map(ei=>`${ei.getId()}`)),eo))ei.attemptDecryption(this,{isRetry:!0}).catch(eo=>{eh.logger.info(`Still unable to decrypt event ${ei.getId()} after receiving key`)})}async outgoingRequestLoop(){if(!this.outgoingRequestLoopRunning){this.outgoingRequestLoopRunning=!0;try{for(;!this.stopped;){let ei=await this.olmMachine.outgoingRequests();if(0==ei.length||this.stopped)return;for(let eo of ei)await this.outgoingRequestProcessor.makeOutgoingRequest(eo)}}catch(ei){eh.logger.error("Error processing outgoing-message requests from rust crypto-sdk",ei)}finally{this.outgoingRequestLoopRunning=!1}}}}eo.RustCrypto=eE;class ew{constructor(ei){this.olmMachine=ei,(0,ed.default)(this,"eventsPendingKey",new ey.MapWithDefault(()=>new ey.MapWithDefault(()=>new Set)))}async attemptEventDecryption(ei){eh.logger.info("Attempting decryption of event",ei),this.addEventToPendingList(ei);let eo=await this.olmMachine.decryptRoomEvent(JSON.stringify({event_id:ei.getId(),type:ei.getWireType(),sender:ei.getSender(),state_key:ei.getStateKey(),content:ei.getWireContent(),origin_server_ts:ei.getTs()}),new eu.RoomId(ei.getRoomId()));return this.removeEventFromPendingList(ei),{clearEvent:JSON.parse(eo.event),claimedEd25519Key:eo.senderClaimedEd25519Key,senderCurve25519Key:eo.senderCurve25519Key,forwardingCurve25519KeyChain:eo.forwardingCurve25519KeyChain}}getEventsPendingRoomKey(ei){let eo=this.eventsPendingKey.get(ei.senderKey.toBase64());if(!eo)return[];let ea=eo.get(ei.sessionId);if(!ea)return[];let ec=ei.roomId.toString();return[...ea].filter(ei=>ei.getRoomId()===ec)}addEventToPendingList(ei){let eo=ei.getWireContent(),ea=eo.sender_key,ec=eo.session_id,ed=this.eventsPendingKey.getOrCreate(ea),eu=ed.getOrCreate(ec);eu.add(ei)}removeEventFromPendingList(ei){let eo=ei.getWireContent(),ea=eo.sender_key,ec=eo.session_id,ed=this.eventsPendingKey.get(ea);if(!ed)return;let eu=ed.get(ec);eu&&(eu.delete(ei),0===eu.size&&(ed.delete(ec),0===ed.size&&this.eventsPendingKey.delete(ea)))}}},9443:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MatrixScheduler=void 0;var ed=ec(ea(8416)),eu=em(ea(3102)),eh=ea(7434),ef=ea(2481),ep=ea(95);function eg(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eg=function(ei){return ei?ea:eo})(ei)}function em(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eg(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let ey=!1;class eb{static RETRY_BACKOFF_RATELIMIT(ei,eo,ea){if(400===ea.httpStatus||403===ea.httpStatus||401===ea.httpStatus||ea instanceof ep.ConnectionError||"M_TOO_LARGE"===ea.name)return -1;if("M_LIMIT_EXCEEDED"===ea.name){let ei=ea.data.retry_after_ms;if(ei>0)return ei}return eo>4?-1:1e3*Math.pow(2,eo)}static QUEUE_MESSAGES(ei){return ei.getType()===ef.EventType.RoomMessage||ei.hasAssociation()?"message":null}constructor(ei=eb.RETRY_BACKOFF_RATELIMIT,eo=eb.QUEUE_MESSAGES){this.retryAlgorithm=ei,this.queueAlgorithm=eo,(0,ed.default)(this,"queues",{}),(0,ed.default)(this,"activeQueues",[]),(0,ed.default)(this,"procFn",null),(0,ed.default)(this,"processQueue",ei=>{let eo=this.peekNextEvent(ei);if(!eo){this.disableQueue(ei);return}eS("Queue '%s' has %s pending events",ei,this.queues[ei].length),Promise.resolve().then(()=>this.procFn(eo.event)).then(ea=>{this.removeNextEvent(ei),eS("Queue '%s' sent event %s",ei,eo.event.getId()),eo.defer.resolve(ea),this.processQueue(ei)},ea=>{eo.attempts+=1;let ec=this.retryAlgorithm(eo.event,eo.attempts,ea);eS("retry(%s) err=%s event_id=%s waitTime=%s",eo.attempts,ea,eo.event.getId(),ec),-1===ec?(eS("Queue '%s' giving up on event %s",ei,eo.event.getId()),this.clearQueue(ei,ea)):setTimeout(this.processQueue,ec,ei)})})}getQueueForEvent(ei){let eo=this.queueAlgorithm(ei);return eo&&this.queues[eo]?this.queues[eo].map(function(ei){return ei.event}):null}removeEventFromQueue(ei){let eo=this.queueAlgorithm(ei);if(!eo||!this.queues[eo])return!1;let ea=!1;return eu.removeElement(this.queues[eo],eo=>eo.event.getId()===ei.getId()&&(ea=!0,!0)),ea}setProcessFunction(ei){this.procFn=ei,this.startProcessingQueues()}queueEvent(ei){let eo=this.queueAlgorithm(ei);if(!eo)return null;this.queues[eo]||(this.queues[eo]=[]);let ea=eu.defer();return this.queues[eo].push({event:ei,defer:ea,attempts:0}),eS("Queue algorithm dumped event %s into queue '%s'",ei.getId(),eo),this.startProcessingQueues(),ea.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(ei=>-1===this.activeQueues.indexOf(ei)&&this.queues[ei].length>0).forEach(ei=>{this.activeQueues.push(ei),eS("Spinning up queue: '%s'",ei),this.processQueue(ei)})}disableQueue(ei){let eo=this.activeQueues.indexOf(ei);eo>=0&&this.activeQueues.splice(eo,1),eS("Stopping queue '%s' as it is now empty",ei)}clearQueue(ei,eo){let ea;for(eS("clearing queue '%s'",ei);ea=this.removeNextEvent(ei);)ea.defer.reject(eo);this.disableQueue(ei)}peekNextEvent(ei){let eo=this.queues[ei];if(Array.isArray(eo))return eo[0]}removeNextEvent(ei){let eo=this.queues[ei];if(Array.isArray(eo))return eo.shift()}}function eS(...ei){ey&&eh.logger.log(...ei)}eo.MatrixScheduler=eb},1891:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.ServerSideSecretStorageImpl=eo.SECRET_STORAGE_ALGORITHM_V1_AES=void 0,eo.trimTrailingEquals=eg;var ec=ea(2168),ed=ea(2611),eu=ea(8401),eh=ea(7434);let ef="m.secret_storage.v1.aes-hmac-sha2";eo.SECRET_STORAGE_ALGORITHM_V1_AES=ef;class ep{constructor(ei,eo){this.accountDataAdapter=ei,this.callbacks=eo}async getDefaultKeyId(){let ei=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return ei?ei.key:null}setDefaultKeyId(ei){return new Promise((eo,ea)=>{let ed=ea=>{"m.secret_storage.default_key"===ea.getType()&&ea.getContent().key===ei&&(this.accountDataAdapter.removeListener(ec.ClientEvent.AccountData,ed),eo())};this.accountDataAdapter.on(ec.ClientEvent.AccountData,ed),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:ei}).catch(ei=>{this.accountDataAdapter.removeListener(ec.ClientEvent.AccountData,ed),ea(ei)})})}async addKey(ei,eo={},ea){if(ei!==ef)throw Error(`Unknown key algorithm ${ei}`);let ec={algorithm:ei};if(eo.name&&(ec.name=eo.name),eo.passphrase&&(ec.passphrase=eo.passphrase),eo.key){let{iv:ei,mac:ea}=await (0,ed.calculateKeyCheck)(eo.key);ec.iv=ei,ec.mac=ea}if(!ea)do ea=(0,eu.randomString)(32);while(await this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${ea}`));return await this.accountDataAdapter.setAccountData(`m.secret_storage.key.${ea}`,ec),{keyId:ea,keyInfo:ec}}async getKey(ei){if(ei||(ei=await this.getDefaultKeyId()),!ei)return null;let eo=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+ei);return eo?[ei,eo]:null}async hasKey(ei){let eo=await this.getKey(ei);return!!eo}async checkKey(ei,eo){if(eo.algorithm===ef){if(!eo.mac)return!0;{let{mac:ea}=await (0,ed.calculateKeyCheck)(ei,eo.iv);return eg(eo.mac)===eg(ea)}}throw Error("Unknown algorithm")}async store(ei,eo,ea){let ec={};if(!ea){let ei=await this.getDefaultKeyId();if(!ei)throw Error("No keys specified and no default key present");ea=[ei]}if(0===ea.length)throw Error("Zero keys given to encrypt with!");for(let ed of ea){let ea=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+ed);if(!ea)throw Error("Unknown key: "+ed);if(ea.algorithm===ef){let eu={[ed]:ea},[,eh]=await this.getSecretStorageKey(eu,ei);ec[ed]=await eh.encrypt(eo)}else eh.logger.warn("unknown algorithm for secret storage key "+ed+": "+ea.algorithm)}await this.accountDataAdapter.setAccountData(ei,{encrypted:ec})}async get(ei){let eo=await this.accountDataAdapter.getAccountDataFromServer(ei);if(!eo)return;if(!eo.encrypted)throw Error("Content is not encrypted!");let ea={};for(let ei of Object.keys(eo.encrypted)){let ec=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+ei),ed=eo.encrypted[ei];(null==ec?void 0:ec.algorithm)===ef&&ed.iv&&ed.ciphertext&&ed.mac&&(ea[ei]=ec)}if(0===Object.keys(ea).length)throw Error(`Could not decrypt ${ei} because none of the keys it is encrypted with are for a supported algorithm`);let[ec,ed]=await this.getSecretStorageKey(ea,ei),eu=eo.encrypted[ec];return ed.decrypt(eu)}async isStored(ei){let eo=await this.accountDataAdapter.getAccountDataFromServer(ei);if(!(null!=eo&&eo.encrypted))return null;let ea={};for(let ei of Object.keys(eo.encrypted)){let ec=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+ei);if(!ec)continue;let ed=eo.encrypted[ei];ec.algorithm===ef&&ed.iv&&ed.ciphertext&&ed.mac&&(ea[ei]=ec)}return Object.keys(ea).length?ea:null}async getSecretStorageKey(ei,eo){if(!this.callbacks.getSecretStorageKey)throw Error("No getSecretStorageKey callback supplied");let ea=await this.callbacks.getSecretStorageKey({keys:ei},eo);if(!ea)throw Error("getSecretStorageKey callback returned falsey");if(ea.length<2)throw Error("getSecretStorageKey callback returned invalid data");let[ec,eu]=ea;if(!ei[ec])throw Error("App returned unknown key from getSecretStorageKey!");if(ei[ec].algorithm===ef){let ei={encrypt:function(ei){return(0,ed.encryptAES)(ei,eu,eo)},decrypt:function(ei){return(0,ed.decryptAES)(ei,eu,eo)}};return[ec,ei]}throw Error("Unknown key type: "+ei[ec].algorithm)}}function eg(ei){let eo=ei.length;for(;eo>=1&&61==ei.charCodeAt(eo-1);)eo--;return eo<ei.length?ei.substring(0,eo):ei}eo.ServerSideSecretStorageImpl=ep},1415:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.SERVICE_TYPES=void 0;let ea=function(ei){return ei.IS="SERVICE_TYPE_IS",ei.IM="SERVICE_TYPE_IM",ei}({});eo.SERVICE_TYPES=ea},11:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SlidingSyncSdk=void 0;var ed=ec(ea(8416)),eu=ea(7366),eh=ea(7434),ef=eT(ea(3102)),ep=ea(8910),eg=ea(2168),em=ea(4551),ey=ea(95),eb=ea(2443),eS=ea(2481),eE=ea(6860),ew=ea(2848);function e_(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(e_=function(ei){return ei?ea:eo})(ei)}function eT(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=e_(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let eI=3;class eC{constructor(ei){this.crypto=ei}name(){return"e2ee"}when(){return eb.ExtensionState.PreProcess}onRequest(ei){if(ei)return{enabled:!0}}async onResponse(ei){ei.device_lists&&await this.crypto.processDeviceLists(ei.device_lists),await this.crypto.processKeyCounts(ei.device_one_time_keys_count,ei.device_unused_fallback_key_types||ei["org.matrix.msc2732.device_unused_fallback_key_types"]),this.crypto.onSyncCompleted({})}}class eO{constructor(ei,eo){this.client=ei,this.cryptoCallbacks=eo,(0,ed.default)(this,"nextBatch",null)}name(){return"to_device"}when(){return eb.ExtensionState.PreProcess}onRequest(ei){let eo={since:null!==this.nextBatch?this.nextBatch:void 0};return ei&&(eo.limit=100,eo.enabled=!0),eo}async onResponse(ei){let eo=[],ea=ei.events||[];ea.length>0&&this.cryptoCallbacks&&(ea=await this.cryptoCallbacks.preprocessToDeviceMessages(ea)),ea.map(this.client.getEventMapper()).map(ei=>{if("m.key.verification.cancel"===ei.getType()){let ea=ei.getContent().transaction_id;ea&&eo.push(ea)}return ei}).forEach(ei=>{let ea=ei.getContent();if("m.room.message"==ei.getType()&&"m.bad.encrypted"==ea.msgtype){eh.logger.log("Ignoring undecryptable to-device event from "+ei.getSender());return}if("m.key.verification.start"===ei.getType()||"m.key.verification.request"===ei.getType()){let ec=ea.transaction_id;eo.includes(ec)&&ei.flagCancelled()}this.client.emit(eg.ClientEvent.ToDeviceEvent,ei)}),this.nextBatch=ei.next_batch}}class eR{constructor(ei){this.client=ei}name(){return"account_data"}when(){return eb.ExtensionState.PostProcess}onRequest(ei){if(ei)return{enabled:!0}}onResponse(ei){for(let eo in ei.global&&ei.global.length>0&&this.processGlobalAccountData(ei.global),ei.rooms){let ea=eD(this.client,eo,ei.rooms[eo]),ec=this.client.getRoom(eo);if(!ec){eh.logger.warn("got account data for room but room doesn't exist on client:",eo);continue}ec.addAccountData(ea),ea.forEach(ei=>{this.client.emit(eg.ClientEvent.Event,ei)})}}processGlobalAccountData(ei){let eo=eD(this.client,void 0,ei),ea=eo.reduce((ei,eo)=>(ei[eo.getType()]=this.client.store.getAccountData(eo.getType()),ei),{});this.client.store.storeAccountDataEvents(eo),eo.forEach(ei=>{if(ei.getType()===eS.EventType.PushRules){let eo=ei.getContent();this.client.setPushRules(eo)}let eo=ea[ei.getType()];return this.client.emit(eg.ClientEvent.AccountData,ei,eo),ei})}}class ek{constructor(ei){this.client=ei}name(){return"typing"}when(){return eb.ExtensionState.PostProcess}onRequest(ei){if(ei)return{enabled:!0}}onResponse(ei){if(null!=ei&&ei.rooms)for(let eo in ei.rooms)ej(this.client,eo,[ei.rooms[eo]])}}class eM{constructor(ei){this.client=ei}name(){return"receipts"}when(){return eb.ExtensionState.PostProcess}onRequest(ei){if(ei)return{enabled:!0}}onResponse(ei){if(null!=ei&&ei.rooms)for(let eo in ei.rooms)ej(this.client,eo,[ei.rooms[eo]])}}class eP{constructor(ei,eo,ea,ec){this.slidingSync=ei,this.client=eo,(0,ed.default)(this,"opts",void 0),(0,ed.default)(this,"syncOpts",void 0),(0,ed.default)(this,"syncState",null),(0,ed.default)(this,"syncStateData",void 0),(0,ed.default)(this,"lastPos",null),(0,ed.default)(this,"failCount",0),(0,ed.default)(this,"notifEvents",[]),this.opts=(0,em.defaultClientOpts)(ea),this.syncOpts=(0,em.defaultSyncApiOpts)(ec),eo.getNotifTimelineSet()&&eo.reEmitter.reEmit(eo.getNotifTimelineSet(),[eu.RoomEvent.Timeline,eu.RoomEvent.TimelineReset]),this.slidingSync.on(eb.SlidingSyncEvent.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(eb.SlidingSyncEvent.RoomData,this.onRoomData.bind(this));let eh=[new eO(this.client,this.syncOpts.cryptoCallbacks),new eR(this.client),new ek(this.client),new eM(this.client)];this.syncOpts.crypto&&eh.push(new eC(this.syncOpts.crypto)),eh.forEach(ei=>{this.slidingSync.registerExtension(ei)})}onRoomData(ei,eo){let ea=this.client.store.getRoom(ei);if(!ea){if(!eo.initial){eh.logger.debug("initial flag not set but no stored room exists for room ",ei,eo);return}ea=(0,em._createAndReEmitRoom)(this.client,ei,this.opts)}this.processRoomData(this.client,ea,eo)}onLifecycle(ei,eo,ea){switch(ea&&eh.logger.debug("onLifecycle",ei,ea),ei){case eb.SlidingSyncState.Complete:if(this.purgeNotifications(),!eo)break;this.lastPos||this.updateSyncState(em.SyncState.Prepared,{oldSyncToken:void 0,nextSyncToken:eo.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(em.SyncState.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:eo.pos,catchingUp:!1,fromCache:!1}),this.lastPos=eo.pos;break;case eb.SlidingSyncState.RequestFinished:if(ea){if(this.failCount+=1,this.updateSyncState(this.failCount>eI?em.SyncState.Error:em.SyncState.Reconnecting,{error:new ey.MatrixError(ea)}),this.shouldAbortSync(new ey.MatrixError(ea)))return}else this.failCount=0}}async syncLeftRooms(){return[]}async peek(ei){return null}stopPeeking(){}getSyncState(){return this.syncState}getSyncStateData(){var ei;return null!==(ei=this.syncStateData)&&void 0!==ei?ei:null}createRoom(ei){let{timelineSupport:eo}=this.client,ea=new eu.Room(ei,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:eo});return this.client.reEmitter.reEmit(ea,[eu.RoomEvent.Name,eu.RoomEvent.Redaction,eu.RoomEvent.RedactionCancelled,eu.RoomEvent.Receipt,eu.RoomEvent.Tags,eu.RoomEvent.LocalEchoUpdated,eu.RoomEvent.AccountData,eu.RoomEvent.MyMembership,eu.RoomEvent.Timeline,eu.RoomEvent.TimelineReset]),this.registerStateListeners(ea),ea}registerStateListeners(ei){this.client.reEmitter.reEmit(ei.currentState,[eE.RoomStateEvent.Events,eE.RoomStateEvent.Members,eE.RoomStateEvent.NewMember,eE.RoomStateEvent.Update]),ei.currentState.on(eE.RoomStateEvent.NewMember,(ei,eo,ea)=>{var ec;ea.user=null!==(ec=this.client.getUser(ea.userId))&&void 0!==ec?ec:void 0,this.client.reEmitter.reEmit(ea,[ew.RoomMemberEvent.Name,ew.RoomMemberEvent.Typing,ew.RoomMemberEvent.PowerLevel,ew.RoomMemberEvent.Membership])})}shouldAbortSync(ei){return"M_UNKNOWN_TOKEN"===ei.errcode&&(eh.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(em.SyncState.Error,{error:ei}),!0)}async processRoomData(ei,eo,ea){ea=eA(ei,eo.roomId,ea);let ec=eD(this.client,eo.roomId,ea.required_state),ed=eD(this.client,eo.roomId,ea.timeline,!1),eh=[];if(ea.initial){let ei=new Set;eo.getLiveTimeline().getEvents().forEach(eo=>{ei.add(eo.getId())});let ec=[],eu=[],eh=!1;for(let eo=ed.length-1;eo>=0;eo--){let ea=ed[eo];if(ei.has(ea.getId())){eh=!0;continue}eh?ec.push(ea):eu.unshift(ea)}ed=eu,ec.length>0&&eo.addEventsToTimeline(ec,!0,eo.getLiveTimeline(),ea.prev_batch)}let em=this.client.isRoomEncrypted(eo.roomId);if(null!=ea.notification_count&&eo.setUnreadNotificationCount(eu.NotificationCountType.Total,ea.notification_count),null!=ea.highlight_count&&(!em||em&&0>=eo.getUnreadNotificationCount(eu.NotificationCountType.Highlight))&&eo.setUnreadNotificationCount(eu.NotificationCountType.Highlight,ea.highlight_count),Number.isInteger(ea.invited_count)&&eo.currentState.setInvitedMemberCount(ea.invited_count),Number.isInteger(ea.joined_count)&&eo.currentState.setJoinedMemberCount(ea.joined_count),ea.invite_state){let ei=eD(this.client,eo.roomId,ea.invite_state);this.injectRoomEvents(eo,ei),ea.initial&&(eo.recalculate(),this.client.store.storeRoom(eo),this.client.emit(eg.ClientEvent.Room,eo)),ei.forEach(ei=>{this.client.emit(eg.ClientEvent.Event,ei)}),eo.updateMyMembership("invite");return}if(ea.initial){var ey;eo.getLiveTimeline().setPaginationToken(null!==(ey=ea.prev_batch)&&void 0!==ey?ey:null,ep.EventTimeline.BACKWARDS)}this.injectRoomEvents(eo,ec,ed,ea.num_live),eo.addEphemeralEvents(eh),eo.updateMyMembership("join"),eo.recalculate(),ea.initial&&(ei.store.storeRoom(eo),ei.emit(eg.ClientEvent.Room,eo)),this.addNotifications(ed);let eb=async ea=>{ei.emit(eg.ClientEvent.Event,ea),ea.isState()&&ea.getType()==eS.EventType.RoomEncryption&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(eo,ea)};await ef.promiseMapSeries(ec,eb),await ef.promiseMapSeries(ed,eb),eh.forEach(function(eo){ei.emit(eg.ClientEvent.Event,eo)}),eo.decryptCriticalEvents()}injectRoomEvents(ei,eo,ea,ec){ea=ea||[],eo=eo||[],ec=ec||0;let ed=ei.getLiveTimeline(),eu=0==ed.getEvents().length;if(eu){for(let ei of eo)this.client.getPushActionsForEvent(ei);ed.initialiseState(eo)}eu||(ei.oldState.setStateEvents(eo),ei.currentState.setStateEvents(eo));let eh=[];ec>0&&(eh=ea.slice(-1*ec),ea=ea.slice(0,-1*eh.length)),ei.addLiveEvents(ea,{fromCache:!0}),eh.length>0&&ei.addLiveEvents(eh,{fromCache:!1}),ei.recalculate(),this.resolveInvites(ei)}resolveInvites(ei){if(!ei||!this.opts.resolveInvitesToProfiles)return;let eo=this.client;ei.getMembersWithMembership("invite").forEach(function(ea){let ec;if(ea.requestedProfileInfo)return;ea.requestedProfileInfo=!0;let ed=eo.getUser(ea.userId);(ec=ed?Promise.resolve({avatar_url:ed.avatarUrl,displayname:ed.displayName}):eo.getProfileInfo(ea.userId)).then(function(eo){let ec=ea.events.member;"invite"===ec.getContent().membership&&(ec.getContent().avatar_url=eo.avatar_url,ec.getContent().displayname=eo.displayname,ea.setMembershipEvent(ec,ei.currentState))},function(ei){})})}retryImmediately(){return!0}async sync(){for(eh.logger.debug("Sliding sync init loop");!this.client.isGuest();)try{eh.logger.debug("Getting push rules...");let ei=await this.client.getPushRules();eh.logger.debug("Got push rules"),this.client.pushRules=ei;break}catch(ei){if(eh.logger.error("Getting push rules failed",ei),this.shouldAbortSync(ei))return}await this.slidingSync.start()}stop(){eh.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(ei,eo){let ea=this.syncState;this.syncState=ei,this.syncStateData=eo,this.client.emit(eg.ClientEvent.Sync,this.syncState,ea,eo)}addNotifications(ei){if(this.client.getNotifTimelineSet())for(let eo of ei){let ei=this.client.getPushActionsForEvent(eo);ei&&ei.notify&&ei.tweaks&&ei.tweaks.highlight&&this.notifEvents.push(eo)}}purgeNotifications(){this.notifEvents.sort(function(ei,eo){return ei.getTs()-eo.getTs()}),this.notifEvents.forEach(ei=>{var eo;null===(eo=this.client.getNotifTimelineSet())||void 0===eo||eo.addLiveEvent(ei)}),this.notifEvents=[]}}function eA(ei,eo,ea){if(!ea.name)return ea;for(let ei of ea.required_state)if(ei.type===eS.EventType.RoomName&&""===ei.state_key)return ei.content={name:ea.name},ea;return ea.required_state.push({event_id:"$fake-sliding-sync-name-event-"+eo,state_key:"",type:eS.EventType.RoomName,content:{name:ea.name},sender:ei.getUserId(),origin_server_ts:new Date().getTime()}),ea}function eD(ei,eo,ea,ec=!0){let ed=ei.getEventMapper({decrypt:ec});return ea.map(function(ei){return ei.room_id=eo,ed(ei)})}function ej(ei,eo,ea){let ec=eD(ei,eo,ea),ed=ei.getRoom(eo);if(!ed){eh.logger.warn("got ephemeral events for room but room doesn't exist on client:",eo);return}ed.addEphemeralEvents(ec),ec.forEach(eo=>{ei.emit(eg.ClientEvent.Event,eo)})}eo.SlidingSyncSdk=eP},2443:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SlidingSyncState=eo.SlidingSyncEvent=eo.SlidingSync=eo.MSC3575_WILDCARD=eo.MSC3575_STATE_KEY_ME=eo.MSC3575_STATE_KEY_LAZY=eo.ExtensionState=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(5861),ef=ea(3102);function ep(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eg(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ep(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ep(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let em=1e4,ey="*";eo.MSC3575_WILDCARD=ey;let eb="$ME";eo.MSC3575_STATE_KEY_ME=eb;let eS="$LAZY";eo.MSC3575_STATE_KEY_LAZY=eS;let eE=function(ei){return ei.RequestFinished="FINISHED",ei.Complete="COMPLETE",ei}({});eo.SlidingSyncState=eE;class ew{constructor(ei){(0,ed.default)(this,"list",void 0),(0,ed.default)(this,"isModified",void 0),(0,ed.default)(this,"roomIndexToRoomId",{}),(0,ed.default)(this,"joinedCount",0),this.replaceList(ei)}setModified(ei){this.isModified=ei}updateListRange(ei){this.list.ranges=JSON.parse(JSON.stringify(ei))}replaceList(ei){ei.filters=ei.filters||{},ei.ranges=ei.ranges||[],this.list=JSON.parse(JSON.stringify(ei)),this.isModified=!0,this.roomIndexToRoomId={},this.joinedCount=0}getList(ei){let eo={ranges:JSON.parse(JSON.stringify(this.list.ranges))};return(this.isModified||ei)&&(eo=JSON.parse(JSON.stringify(this.list))),eo}isIndexInRange(ei){for(let eo of this.list.ranges)if(eo[0]<=ei&&ei<=eo[1])return!0;return!1}}let e_=function(ei){return ei.PreProcess="ExtState.PreProcess",ei.PostProcess="ExtState.PostProcess",ei}({});eo.ExtensionState=e_;let eT=function(ei){return ei.RoomData="SlidingSync.RoomData",ei.Lifecycle="SlidingSync.Lifecycle",ei.List="SlidingSync.List",ei}({});eo.SlidingSyncEvent=eT;class eI extends eh.TypedEventEmitter{constructor(ei,eo,ea,ec,eu){super(),this.proxyBaseUrl=ei,this.roomSubscriptionInfo=ea,this.client=ec,this.timeoutMS=eu,(0,ed.default)(this,"lists",void 0),(0,ed.default)(this,"listModifiedCount",0),(0,ed.default)(this,"terminated",!1),(0,ed.default)(this,"needsResend",!1),(0,ed.default)(this,"txnId",null),(0,ed.default)(this,"txnIdDefers",[]),(0,ed.default)(this,"extensions",{}),(0,ed.default)(this,"desiredRoomSubscriptions",new Set),(0,ed.default)(this,"confirmedRoomSubscriptions",new Set),(0,ed.default)(this,"customSubscriptions",new Map),(0,ed.default)(this,"roomIdToCustomSubscription",new Map),(0,ed.default)(this,"pendingReq",void 0),(0,ed.default)(this,"abortController",void 0),this.lists=new Map,eo.forEach((ei,eo)=>{this.lists.set(eo,new ew(ei))})}addCustomSubscription(ei,eo){if(this.customSubscriptions.has(ei)){eu.logger.warn(`addCustomSubscription: ${ei} already exists as a custom subscription, ignoring.`);return}this.customSubscriptions.set(ei,eo)}useCustomSubscription(ei,eo){this.roomIdToCustomSubscription.get(ei)!==eo&&(this.roomIdToCustomSubscription.set(ei,eo),this.confirmedRoomSubscriptions.delete(ei))}getListData(ei){let eo=this.lists.get(ei);return eo?{joinedCount:eo.joinedCount,roomIndexToRoomId:Object.assign({},eo.roomIndexToRoomId)}:null}getListParams(ei){let eo=this.lists.get(ei);return eo?eo.getList(!0):null}setListRanges(ei,eo){let ea=this.lists.get(ei);return ea?(ea.updateListRange(eo),this.resend()):Promise.reject(Error("no list with key "+ei))}setList(ei,eo){let ea=this.lists.get(ei);return ea?(ea.replaceList(eo),this.lists.set(ei,ea)):this.lists.set(ei,new ew(eo)),this.listModifiedCount+=1,this.resend()}getRoomSubscriptions(){return new Set(Array.from(this.desiredRoomSubscriptions))}modifyRoomSubscriptions(ei){return this.desiredRoomSubscriptions=ei,this.resend()}modifyRoomSubscriptionInfo(ei){return this.roomSubscriptionInfo=ei,this.confirmedRoomSubscriptions=new Set,this.resend()}registerExtension(ei){if(this.extensions[ei.name()])throw Error(`registerExtension: ${ei.name()} already exists as an extension`);this.extensions[ei.name()]=ei}getExtensionRequest(ei){let eo={};return Object.keys(this.extensions).forEach(ea=>{eo[ea]=this.extensions[ea].onRequest(ei)}),eo}onPreExtensionsResponse(ei){Object.keys(ei).forEach(eo=>{this.extensions[eo].when()==e_.PreProcess&&this.extensions[eo].onResponse(ei[eo])})}onPostExtensionsResponse(ei){Object.keys(ei).forEach(eo=>{this.extensions[eo].when()==e_.PostProcess&&this.extensions[eo].onResponse(ei[eo])})}invokeRoomDataListeners(ei,eo){eo.required_state||(eo.required_state=[]),eo.timeline||(eo.timeline=[]),this.emit(eT.RoomData,ei,eo)}invokeLifecycleListeners(ei,eo,ea){this.emit(eT.Lifecycle,ei,eo,ea)}shiftRight(ei,eo,ea){let ec=this.lists.get(ei);if(ec)for(let ei=eo;ei>ea;ei--)ec.isIndexInRange(ei)&&(ec.roomIndexToRoomId[ei]=ec.roomIndexToRoomId[ei-1])}shiftLeft(ei,eo,ea){let ec=this.lists.get(ei);if(ec)for(let ei=ea;ei<eo;ei++)ec.isIndexInRange(ei)&&(ec.roomIndexToRoomId[ei]=ec.roomIndexToRoomId[ei+1])}removeEntry(ei,eo){let ea=this.lists.get(ei);if(!ea)return;let ec=-1;for(let ei in ea.roomIndexToRoomId)Number(ei)>ec&&(ec=Number(ei));ec<0||eo>ec||(this.shiftLeft(ei,ec,eo),delete ea.roomIndexToRoomId[ec])}addEntry(ei,eo){let ea=this.lists.get(ei);if(!ea)return;let ec=-1;for(let ei in ea.roomIndexToRoomId)Number(ei)>ec&&(ec=Number(ei));ec<0||eo>ec||this.shiftRight(ei,ec+1,eo)}processListOps(ei,eo){let ea=-1,ec=this.lists.get(eo);ec&&(ei.ops.forEach(ei=>{if(ec)switch(ei.op){case"DELETE":eu.logger.debug("DELETE",eo,ei.index,";"),delete ec.roomIndexToRoomId[ei.index],-1!==ea&&this.removeEntry(eo,ea),ea=ei.index;break;case"INSERT":eu.logger.debug("INSERT",eo,ei.index,ei.room_id,";"),ec.roomIndexToRoomId[ei.index]&&(ea<0?this.addEntry(eo,ei.index):ea>ei.index?this.shiftRight(eo,ea,ei.index):ea<ei.index&&this.shiftLeft(eo,ei.index,ea)),ea=-1,ec.roomIndexToRoomId[ei.index]=ei.room_id;break;case"INVALIDATE":{let ea=ei.range[0];for(let eo=ea;eo<=ei.range[1];eo++)delete ec.roomIndexToRoomId[eo];eu.logger.debug("INVALIDATE",eo,ei.range[0],ei.range[1],";");break}case"SYNC":{let ea=ei.range[0];for(let eo=ea;eo<=ei.range[1];eo++){let ed=ei.room_ids[eo-ea];if(!ed)break;ec.roomIndexToRoomId[eo]=ed}eu.logger.debug("SYNC",eo,ei.range[0],ei.range[1],(ei.room_ids||[]).join(" "),";")}}}),-1!==ea&&this.removeEntry(eo,ea))}resend(){var ei;if(this.needsResend&&this.txnIdDefers.length>0)return this.txnIdDefers[this.txnIdDefers.length-1].promise;this.needsResend=!0,this.txnId=this.client.makeTxnId();let eo=(0,ef.defer)();return this.txnIdDefers.push(eg(eg({},eo),{},{txnId:this.txnId})),null===(ei=this.abortController)||void 0===ei||ei.abort(),this.abortController=new AbortController,eo.promise}resolveTransactionDefers(ei){if(!ei)return;let eo=-1;for(let ea=0;ea<this.txnIdDefers.length;ea++)if(this.txnIdDefers[ea].txnId===ei){eo=ea;break}if(-1===eo){eu.logger.warn(`resolveTransactionDefers: seen ${ei} but it isn't a pending txn, ignoring.`);return}for(let ei=0;ei<eo;ei++)this.txnIdDefers[ei].reject(this.txnIdDefers[ei].txnId);this.txnIdDefers[eo].resolve(ei),this.txnIdDefers=this.txnIdDefers.slice(eo+1)}stop(){var ei;this.terminated=!0,null===(ei=this.abortController)||void 0===ei||ei.abort(),this.removeAllListeners(eT.Lifecycle),this.removeAllListeners(eT.List),this.removeAllListeners(eT.RoomData)}resetup(){var ei;eu.logger.warn("SlidingSync: resetting connection info"),this.txnIdDefers.forEach(ei=>{ei.reject(ei.txnId)}),this.txnIdDefers=[],this.lists.forEach(ei=>{ei.setModified(!0)}),this.confirmedRoomSubscriptions=new Set,this.needsResend=!0,null===(ei=this.abortController)||void 0===ei||ei.abort(),this.abortController=new AbortController}async start(){let ei;for(this.abortController=new AbortController;!this.terminated;){let eo;this.needsResend=!1;let ea=!1;try{let ec=this.listModifiedCount,ed={};this.lists.forEach((ei,eo)=>{ed[eo]=ei.getList(!1)});let eh={lists:ed,pos:ei,timeout:this.timeoutMS,clientTimeout:this.timeoutMS+em,extensions:this.getExtensionRequest(void 0===ei)},ef=eC(this.desiredRoomSubscriptions,this.confirmedRoomSubscriptions),ep=eC(this.confirmedRoomSubscriptions,this.desiredRoomSubscriptions);if(ep.size>0&&(eh.unsubscribe_rooms=Array.from(ep)),ef.size>0)for(let ei of(eh.room_subscriptions={},ef)){let eo=this.roomIdToCustomSubscription.get(ei),ea=this.roomSubscriptionInfo;eo&&this.customSubscriptions.has(eo)&&(ea=this.customSubscriptions.get(eo)),eh.room_subscriptions[ei]=ea}for(let ea of(this.txnId&&(eh.txn_id=this.txnId,this.txnId=null),this.pendingReq=this.client.slidingSync(eh,this.proxyBaseUrl,this.abortController.signal),ei=(eo=await this.pendingReq).pos,ef))this.confirmedRoomSubscriptions.add(ea);for(let ei of ep)this.confirmedRoomSubscriptions.delete(ei);ec!==this.listModifiedCount&&(eu.logger.debug("list modified during await call, not updating list"),ea=!0),this.lists.forEach(ei=>{ei.setModified(!1)}),eo.lists=eo.lists||{},eo.rooms=eo.rooms||{},eo.extensions=eo.extensions||{},Object.keys(eo.lists).forEach(ei=>{let ea=this.lists.get(ei);ea&&eo&&(ea.joinedCount=eo.lists[ei].count)}),this.invokeLifecycleListeners(eE.RequestFinished,eo)}catch(eo){if(eo.httpStatus){if(this.invokeLifecycleListeners(eE.RequestFinished,null,eo),400===eo.httpStatus){this.resetup(),ei=void 0,await (0,ef.sleep)(50);continue}}else if(this.needsResend||"AbortError"===eo.name)continue;eu.logger.error(eo),await (0,ef.sleep)(5e3)}if(!eo)continue;this.onPreExtensionsResponse(eo.extensions),Object.keys(eo.rooms).forEach(ei=>{this.invokeRoomDataListeners(ei,eo.rooms[ei])});let ec=new Set;if(!ea)for(let[ei,ea]of Object.entries(eo.lists))ea.ops=ea.ops||[],ea.ops.length>0&&ec.add(ei),this.processListOps(ea,ei);this.invokeLifecycleListeners(eE.Complete,eo),this.onPostExtensionsResponse(eo.extensions),ec.forEach(ei=>{let eo=this.lists.get(ei);eo&&this.emit(eT.List,ei,eo.joinedCount,Object.assign({},eo.roomIndexToRoomId))}),this.resolveTransactionDefers(eo.txn_id)}}}eo.SlidingSync=eI;let eC=(ei,eo)=>{let ea=new Set(ei);for(let ei of eo)ea.delete(ei);return ea}},3861:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.LocalIndexedDBStoreBackend=void 0;var ed=ec(ea(8416)),eu=ea(2741),eh=em(ea(3102)),ef=em(ea(3415)),ep=ea(7434);function eg(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eg=function(ei){return ei?ea:eo})(ei)}function em(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eg(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}let ey=[ei=>{ei.createObjectStore("users",{keyPath:["userId"]}),ei.createObjectStore("accountData",{keyPath:["type"]}),ei.createObjectStore("sync",{keyPath:["clobber"]})},ei=>{let eo=ei.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});eo.createIndex("room","room_id")},ei=>{ei.createObjectStore("client_options",{keyPath:["clobber"]})},ei=>{ei.createObjectStore("to_device_queue",{autoIncrement:!0})}],eb=ey.length;function eS(ei,eo,ea){let ec=ei.openCursor(eo);return new Promise((ei,eo)=>{let ed=[];ec.onerror=()=>{eo(Error("Query failed: "+ec.error))},ec.onsuccess=()=>{let eo=ec.result;if(!eo){ei(ed);return}ed.push(ea(eo)),eo.continue()}})}function eE(ei){return new Promise((eo,ea)=>{ei.oncomplete=function(ei){eo(ei)},ei.onerror=function(){ea(ei.error)}})}function ew(ei){return new Promise((eo,ea)=>{ei.onsuccess=function(ei){eo(ei)},ei.onerror=function(){ea(ei.error)}})}function e_(ei){return new Promise((eo,ea)=>{ei.onsuccess=()=>eo(ei),ei.onerror=ei=>ea(ei)})}function eT(ei){return ew(ei).then(eo=>ei.result)}class eI{static exists(ei,eo){return eo="matrix-js-sdk:"+(eo||"default"),ef.exists(ei,eo)}constructor(ei,eo="default"){this.indexedDB=ei,(0,ed.default)(this,"dbName",void 0),(0,ed.default)(this,"syncAccumulator",void 0),(0,ed.default)(this,"db",void 0),(0,ed.default)(this,"disconnected",!0),(0,ed.default)(this,"_isNewlyCreated",!1),(0,ed.default)(this,"syncToDatabasePromise",void 0),(0,ed.default)(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+eo,this.syncAccumulator=new eu.SyncAccumulator}connect(ei){if(!this.disconnected)return ep.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,ep.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");let eo=this.indexedDB.open(this.dbName,eb);return eo.onupgradeneeded=ei=>{let ea=eo.result,ec=ei.oldVersion;ep.logger.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${ec}`),ec<1&&(this._isNewlyCreated=!0),ey.forEach((ei,eo)=>{ec<=eo&&ei(ea)})},eo.onblocked=()=>{ep.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},ep.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),ew(eo).then(async()=>{ep.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=eo.result,this.db.onversionchange=()=>{var eo;null===(eo=this.db)||void 0===eo||eo.close(),this.disconnected=!0,this.db=void 0,null==ei||ei()},this.db.onclose=()=>{this.disconnected=!0,this.db=void 0,null==ei||ei()},await this.init()})}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(([ei,eo])=>{ep.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:eo.nextBatch,rooms:eo.roomsData,account_data:{events:ei}},!0)})}getOutOfBandMembers(ei){return new Promise((eo,ea)=>{let ec=this.db.transaction(["oob_membership_events"],"readonly"),ed=ec.objectStore("oob_membership_events"),eu=ed.index("room"),eh=IDBKeyRange.only(ei),ef=eu.openCursor(eh),ep=[],eg=!1;ef.onsuccess=()=>{let ei=ef.result;if(!ei)return ep.length||eg?eo(ep):eo(null);let ea=ei.value;ea.oob_written?eg=!0:ep.push(ea),ei.continue()},ef.onerror=ei=>{ea(ei)}}).then(eo=>(ep.logger.log(`LL: got ${null==eo?void 0:eo.length} membershipEvents from storage for room ${ei} ...`),eo))}async setOutOfBandMembers(ei,eo){ep.logger.log(`LL: backend about to store ${eo.length} members for ${ei}`);let ea=this.db.transaction(["oob_membership_events"],"readwrite"),ec=ea.objectStore("oob_membership_events");eo.forEach(ei=>{ec.put(ei)});let ed={room_id:ei,oob_written:!0,state_key:0};ec.put(ed),await eE(ea),ep.logger.log(`LL: backend done storing for ${ei}!`)}async clearOutOfBandMembers(ei){let eo=this.db.transaction(["oob_membership_events"],"readonly"),ea=eo.objectStore("oob_membership_events"),ec=ea.index("room"),ed=IDBKeyRange.only(ei),eu=eT(ec.openKeyCursor(ed,"next")).then(ei=>(null==ei?void 0:ei.primaryKey)[1]),eh=eT(ec.openKeyCursor(ed,"prev")).then(ei=>(null==ei?void 0:ei.primaryKey)[1]),[ef,eg]=await Promise.all([eu,eh]),em=this.db.transaction(["oob_membership_events"],"readwrite"),ey=em.objectStore("oob_membership_events"),eb=IDBKeyRange.bound([ei,ef],[ei,eg]);ep.logger.log(`LL: Deleting all users + marker in storage for room ${ei}, with key range:`,[ei,ef],[ei,eg]),await e_(ey.delete(eb))}clearDatabase(){return new Promise(ei=>{ep.logger.log(`Removing indexeddb instance: ${this.dbName}`);let eo=this.indexedDB.deleteDatabase(this.dbName);eo.onblocked=()=>{ep.logger.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},eo.onerror=()=>{ep.logger.warn(`unable to delete js-sdk store indexeddb: ${eo.error}`),ei()},eo.onsuccess=()=>{ep.logger.log(`Removed indexeddb instance: ${this.dbName}`),ei()}})}getSavedSync(ei=!0){let eo=this.syncAccumulator.getJSON();return eo.nextBatch?ei?Promise.resolve(eh.deepCopy(eo)):Promise.resolve(eo):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(ei){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(ei)})}async syncToDatabase(ei){return this.syncToDatabasePromise?(ep.logger.warn("Skipping syncToDatabase() as persist already in flight"),this.pendingUserPresenceData.push(...ei),this.syncToDatabasePromise):(ei.unshift(...this.pendingUserPresenceData),this.syncToDatabasePromise=this.doSyncToDatabase(ei),this.syncToDatabasePromise)}async doSyncToDatabase(ei){try{let eo=this.syncAccumulator.getJSON(!0);await Promise.all([this.persistUserPresenceEvents(ei),this.persistAccountData(eo.accountData),this.persistSyncData(eo.nextBatch,eo.roomsData)])}finally{this.syncToDatabasePromise=void 0}}persistSyncData(ei,eo){return ep.logger.log("Persisting sync data up to",ei),eh.promiseTry(()=>{let ea=this.db.transaction(["sync"],"readwrite"),ec=ea.objectStore("sync");return ec.put({clobber:"-",nextBatch:ei,roomsData:eo}),eE(ea).then(()=>{ep.logger.log("Persisted sync data up to",ei)})})}persistAccountData(ei){return eh.promiseTry(()=>{let eo=this.db.transaction(["accountData"],"readwrite"),ea=eo.objectStore("accountData");for(let eo of ei)ea.put(eo);return eE(eo).then()})}persistUserPresenceEvents(ei){return eh.promiseTry(()=>{let eo=this.db.transaction(["users"],"readwrite"),ea=eo.objectStore("users");for(let eo of ei)ea.put({userId:eo[0],event:eo[1]});return eE(eo).then()})}getUserPresenceEvents(){return eh.promiseTry(()=>{let ei=this.db.transaction(["users"],"readonly"),eo=ei.objectStore("users");return eS(eo,void 0,ei=>[ei.value.userId,ei.value.event])})}loadAccountData(){return ep.logger.log("LocalIndexedDBStoreBackend: loading account data..."),eh.promiseTry(()=>{let ei=this.db.transaction(["accountData"],"readonly"),eo=ei.objectStore("accountData");return eS(eo,void 0,ei=>ei.value).then(ei=>(ep.logger.log("LocalIndexedDBStoreBackend: loaded account data"),ei))})}loadSyncData(){return ep.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),eh.promiseTry(()=>{let ei=this.db.transaction(["sync"],"readonly"),eo=ei.objectStore("sync");return eS(eo,void 0,ei=>ei.value).then(ei=>(ep.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),ei.length>1&&ep.logger.warn("loadSyncData: More than 1 sync row found."),ei.length>0?ei[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{let ei=this.db.transaction(["client_options"],"readonly"),eo=ei.objectStore("client_options");return eS(eo,void 0,ei=>{var eo;return null===(eo=ei.value)||void 0===eo?void 0:eo.options}).then(ei=>ei[0])})}async storeClientOptions(ei){let eo=this.db.transaction(["client_options"],"readwrite"),ea=eo.objectStore("client_options");ea.put({clobber:"-",options:ei}),await eE(eo)}async saveToDeviceBatches(ei){let eo=this.db.transaction(["to_device_queue"],"readwrite"),ea=eo.objectStore("to_device_queue");for(let eo of ei)ea.add(eo);await eE(eo)}async getOldestToDeviceBatch(){let ei=this.db.transaction(["to_device_queue"],"readonly"),eo=ei.objectStore("to_device_queue"),ea=await eT(eo.openCursor());if(!ea)return null;let ec=ea.value;return{id:ea.key,txnId:ec.txnId,eventType:ec.eventType,batch:ec.batch}}async removeToDeviceBatch(ei){let eo=this.db.transaction(["to_device_queue"],"readwrite"),ea=eo.objectStore("to_device_queue");ea.delete(ei),await eE(eo)}}eo.LocalIndexedDBStoreBackend=eI},4215:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.RemoteIndexedDBStoreBackend=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(3102);class ef{constructor(ei,eo){this.workerFactory=ei,this.dbName=eo,(0,ed.default)(this,"worker",void 0),(0,ed.default)(this,"nextSeq",0),(0,ed.default)(this,"inFlight",{}),(0,ed.default)(this,"startPromise",void 0),(0,ed.default)(this,"onWorkerMessage",ei=>{let eo=ei.data;if("closed"==eo.command){var ea;null===(ea=this.onClose)||void 0===ea||ea.call(this)}else if("cmd_success"==eo.command||"cmd_fail"==eo.command){if(void 0===eo.seq){eu.logger.error("Got reply from worker with no seq");return}let ei=this.inFlight[eo.seq];if(void 0===ei){eu.logger.error("Got reply for unknown seq "+eo.seq);return}if(delete this.inFlight[eo.seq],"cmd_success"==eo.command)ei.resolve(eo.result);else{let ea=Error(eo.error.message);ea.name=eo.error.name,ei.reject(ea)}}else eu.logger.warn("Unrecognised message from worker: ",eo)})}connect(ei){return this.onClose=ei,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(ei){return this.doCmd("setSyncData",[ei])}syncToDatabase(ei){return this.doCmd("syncToDatabase",[ei])}getOutOfBandMembers(ei){return this.doCmd("getOutOfBandMembers",[ei])}setOutOfBandMembers(ei,eo){return this.doCmd("setOutOfBandMembers",[ei,eo])}clearOutOfBandMembers(ei){return this.doCmd("clearOutOfBandMembers",[ei])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(ei){return this.doCmd("storeClientOptions",[ei])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}async saveToDeviceBatches(ei){return this.doCmd("saveToDeviceBatches",[ei])}async getOldestToDeviceBatch(){return this.doCmd("getOldestToDeviceBatch")}async removeToDeviceBatch(ei){return this.doCmd("removeToDeviceBatch",[ei])}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{eu.logger.log("IndexedDB worker is ready")})),this.startPromise}doCmd(ei,eo){return Promise.resolve().then(()=>{var ea;let ec=this.nextSeq++,ed=(0,eh.defer)();return this.inFlight[ec]=ed,null===(ea=this.worker)||void 0===ea||ea.postMessage({command:ei,seq:ec,args:eo}),ed.promise})}}eo.RemoteIndexedDBStoreBackend=ef},9789:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.IndexedDBStore=void 0;var ed=ec(ea(8416)),eu=ea(1703),eh=ea(3861),ef=ea(4215),ep=ea(3998),eg=ea(4369),em=ea(7434),ey=ea(5861);let eb=3e5;class eS extends eu.MemoryStore{static exists(ei,eo){return eh.LocalIndexedDBStoreBackend.exists(ei,eo)}constructor(ei){if(super(ei),(0,ed.default)(this,"backend",void 0),(0,ed.default)(this,"startedUp",!1),(0,ed.default)(this,"syncTs",0),(0,ed.default)(this,"userModifiedMap",{}),(0,ed.default)(this,"emitter",new ey.TypedEventEmitter),(0,ed.default)(this,"on",this.emitter.on.bind(this.emitter)),(0,ed.default)(this,"onClose",()=>{this.emitter.emit("closed")}),(0,ed.default)(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),(0,ed.default)(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),(0,ed.default)(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),(0,ed.default)(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{em.logger.log("Deleted indexeddb data.")},ei=>{throw em.logger.error(`Failed to delete indexeddb data: ${ei}`),ei})))),(0,ed.default)(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();let ei=[];for(let eo of this.getUsers())this.userModifiedMap[eo.userId]!==eo.getLastModifiedTime()&&eo.events.presence&&(ei.push([eo.userId,eo.events.presence.event]),this.userModifiedMap[eo.userId]=eo.getLastModifiedTime());return this.backend.syncToDatabase(ei)})),(0,ed.default)(this,"setSyncData",this.degradable(ei=>this.backend.setSyncData(ei),"setSyncData")),(0,ed.default)(this,"getOutOfBandMembers",this.degradable(ei=>this.backend.getOutOfBandMembers(ei),"getOutOfBandMembers")),(0,ed.default)(this,"setOutOfBandMembers",this.degradable((ei,eo)=>(super.setOutOfBandMembers(ei,eo),this.backend.setOutOfBandMembers(ei,eo)),"setOutOfBandMembers")),(0,ed.default)(this,"clearOutOfBandMembers",this.degradable(ei=>(super.clearOutOfBandMembers(ei),this.backend.clearOutOfBandMembers(ei)),"clearOutOfBandMembers")),(0,ed.default)(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),(0,ed.default)(this,"storeClientOptions",this.degradable(ei=>(super.storeClientOptions(ei),this.backend.storeClientOptions(ei)),"storeClientOptions")),!ei.indexedDB)throw Error("Missing required option: indexedDB");ei.workerFactory?this.backend=new ef.RemoteIndexedDBStoreBackend(ei.workerFactory,ei.dbName):this.backend=new eh.LocalIndexedDBStoreBackend(ei.indexedDB,ei.dbName)}startup(){return this.startedUp?(em.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(em.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(em.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(ei=>{em.logger.log("IndexedDBStore.startup: processing presence events"),ei.forEach(([ei,eo])=>{let ea=new ep.User(ei);eo&&ea.setPresenceEvent(new eg.MatrixEvent(eo)),this.userModifiedMap[ea.userId]=ea.getLastModifiedTime(),this.storeUser(ea)}),this.startedUp=!0}))}wantsSave(){let ei=Date.now();return ei-this.syncTs>eb}save(ei=!1){return ei||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(ei,eo){let ea=eo?super[eo]:null;return async(...eo)=>{try{return await ei.call(this,...eo)}catch(ei){em.logger.error("IndexedDBStore failure, degrading to MemoryStore",ei),this.emitter.emit("degraded",ei);try{em.logger.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),em.logger.log("IndexedDBStore delete after degrading succeeded")}catch(ei){em.logger.warn("IndexedDBStore delete after degrading failed",ei)}if(ea)return ea.call(this,...eo)}}}async getPendingEvents(ei){if(!this.localStorage)return super.getPendingEvents(ei);let eo=this.localStorage.getItem(eE(ei));if(eo)try{return JSON.parse(eo)}catch(ei){em.logger.error("Could not parse persisted pending events",ei)}return[]}async setPendingEvents(ei,eo){if(!this.localStorage)return super.setPendingEvents(ei,eo);eo.length>0?this.localStorage.setItem(eE(ei),JSON.stringify(eo)):this.localStorage.removeItem(eE(ei))}saveToDeviceBatches(ei){return this.backend.saveToDeviceBatches(ei)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(ei){return this.backend.removeToDeviceBatch(ei)}}function eE(ei){return`mx_pending_events_${ei}`}eo.IndexedDBStore=eS},1703:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MemoryStore=void 0;var ed=ec(ea(8416)),eu=ea(3998),eh=ea(6860),ef=ea(3102);function ep(ei){let eo="string"==typeof ei&&!!ei&&"undefined"!==ei&&"null"!==ei;return eo||"number"==typeof ei}class eg{constructor(ei={}){(0,ed.default)(this,"rooms",{}),(0,ed.default)(this,"users",{}),(0,ed.default)(this,"syncToken",null),(0,ed.default)(this,"filters",new ef.MapWithDefault(()=>new Map)),(0,ed.default)(this,"accountData",new Map),(0,ed.default)(this,"localStorage",void 0),(0,ed.default)(this,"oobMembers",new Map),(0,ed.default)(this,"pendingEvents",{}),(0,ed.default)(this,"clientOptions",void 0),(0,ed.default)(this,"pendingToDeviceBatches",[]),(0,ed.default)(this,"nextToDeviceBatchId",0),(0,ed.default)(this,"onRoomMember",(ei,eo,ea)=>{if("invite"===ea.membership)return;let ec=this.users[ea.userId]||new eu.User(ea.userId);ea.name&&(ec.setDisplayName(ea.name),ea.events.member&&ec.setRawDisplayName(ea.events.member.getDirectionalContent().displayname)),ea.events.member&&ea.events.member.getContent().avatar_url&&ec.setAvatarUrl(ea.events.member.getContent().avatar_url),this.users[ec.userId]=ec}),this.localStorage=ei.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(ei){this.syncToken=ei}storeRoom(ei){this.rooms[ei.roomId]=ei,ei.currentState.on(eh.RoomStateEvent.Members,this.onRoomMember),ei.currentState.getMembers().forEach(eo=>{this.onRoomMember(null,ei.currentState,eo)})}getRoom(ei){return this.rooms[ei]||null}getRooms(){return Object.values(this.rooms)}removeRoom(ei){this.rooms[ei]&&this.rooms[ei].currentState.removeListener(eh.RoomStateEvent.Members,this.onRoomMember),delete this.rooms[ei]}getRoomSummaries(){return Object.values(this.rooms).map(function(ei){return ei.summary})}storeUser(ei){this.users[ei.userId]=ei}getUser(ei){return this.users[ei]||null}getUsers(){return Object.values(this.users)}scrollback(ei,eo){return[]}storeEvents(ei,eo,ea,ec){}storeFilter(ei){null!=ei&&ei.userId&&null!=ei&&ei.filterId&&this.filters.getOrCreate(ei.userId).set(ei.filterId,ei)}getFilter(ei,eo){var ea;return(null===(ea=this.filters.get(ei))||void 0===ea?void 0:ea.get(eo))||null}getFilterIdByName(ei){if(!this.localStorage)return null;let eo="mxjssdk_memory_filter_"+ei;try{let ei=this.localStorage.getItem(eo);if(ep(ei))return ei}catch(ei){}return null}setFilterIdByName(ei,eo){if(!this.localStorage)return;let ea="mxjssdk_memory_filter_"+ei;try{ep(eo)?this.localStorage.setItem(ea,eo):this.localStorage.removeItem(ea)}catch(ei){}}storeAccountDataEvents(ei){ei.forEach(ei=>{let eo=!Object.keys(ei.getContent()).length;eo?this.accountData.delete(ei.getType()):this.accountData.set(ei.getType(),ei)})}getAccountData(ei){return this.accountData.get(ei)}setSyncData(ei){return Promise.resolve()}wantsSave(){return!1}save(ei){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new ef.MapWithDefault(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(ei){return Promise.resolve(this.oobMembers.get(ei)||null)}setOutOfBandMembers(ei,eo){return this.oobMembers.set(ei,eo),Promise.resolve()}clearOutOfBandMembers(ei){return this.oobMembers.delete(ei),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(ei){return this.clientOptions=Object.assign({},ei),Promise.resolve()}async getPendingEvents(ei){var eo;return null!==(eo=this.pendingEvents[ei])&&void 0!==eo?eo:[]}async setPendingEvents(ei,eo){this.pendingEvents[ei]=eo}saveToDeviceBatches(ei){for(let eo of ei)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:eo.eventType,txnId:eo.txnId,batch:eo.batch});return Promise.resolve()}async getOldestToDeviceBatch(){return 0===this.pendingToDeviceBatches.length?null:this.pendingToDeviceBatches[0]}removeToDeviceBatch(ei){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(eo=>eo.id!==ei),Promise.resolve()}}eo.MemoryStore=eg},5641:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.StubStore=void 0;var ed=ec(ea(8416));class eu{constructor(){(0,ed.default)(this,"accountData",new Map),(0,ed.default)(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(ei){this.fromToken=ei}storeRoom(ei){}getRoom(ei){return null}getRooms(){return[]}removeRoom(ei){}getRoomSummaries(){return[]}storeUser(ei){}getUser(ei){return null}getUsers(){return[]}scrollback(ei,eo){return[]}storeEvents(ei,eo,ea,ec){}storeFilter(ei){}getFilter(ei,eo){return null}getFilterIdByName(ei){return null}setFilterIdByName(ei,eo){}storeAccountDataEvents(ei){}getAccountData(ei){}setSyncData(ei){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(ei,eo){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(ei){return Promise.resolve()}async getPendingEvents(ei){return[]}setPendingEvents(ei,eo){return Promise.resolve()}async saveToDeviceBatches(ei){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(ei){return Promise.resolve()}}eo.StubStore=eu},2741:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SyncAccumulator=eo.Category=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(3102),ef=ea(2481),ep=ea(5550),eg=ea(1467);function em(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ey(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?em(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):em(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let eb=function(ei){return ei.Invite="invite",ei.Leave="leave",ei.Join="join",ei}({});function eS(ei){return"_localTs"in ei&&void 0!==ei._localTs}eo.Category=eb;class eE{constructor(ei={}){this.opts=ei,(0,ed.default)(this,"accountData",{}),(0,ed.default)(this,"inviteRooms",{}),(0,ed.default)(this,"joinRooms",{}),(0,ed.default)(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(ei,eo=!1){this.accumulateRooms(ei,eo),this.accumulateAccountData(ei),this.nextBatch=ei.next_batch}accumulateAccountData(ei){ei.account_data&&ei.account_data.events&&ei.account_data.events.forEach(ei=>{this.accountData[ei.type]=ei})}accumulateRooms(ei,eo=!1){ei.rooms&&(ei.rooms.invite&&Object.keys(ei.rooms.invite).forEach(ea=>{this.accumulateRoom(ea,eb.Invite,ei.rooms.invite[ea],eo)}),ei.rooms.join&&Object.keys(ei.rooms.join).forEach(ea=>{this.accumulateRoom(ea,eb.Join,ei.rooms.join[ea],eo)}),ei.rooms.leave&&Object.keys(ei.rooms.leave).forEach(ea=>{this.accumulateRoom(ea,eb.Leave,ei.rooms.leave[ea],eo)}))}accumulateRoom(ei,eo,ea,ec=!1){switch(eo){case eb.Invite:this.accumulateInviteState(ei,ea);break;case eb.Join:this.inviteRooms[ei]&&delete this.inviteRooms[ei],this.accumulateJoinState(ei,ea,ec);break;case eb.Leave:this.inviteRooms[ei]?delete this.inviteRooms[ei]:delete this.joinRooms[ei];break;default:eu.logger.error("Unknown cateogory: ",eo)}}accumulateInviteState(ei,eo){if(!eo.invite_state||!eo.invite_state.events)return;if(!this.inviteRooms[ei]){this.inviteRooms[ei]={invite_state:eo.invite_state};return}let ea=this.inviteRooms[ei];eo.invite_state.events.forEach(ei=>{let eo=!1;for(let ec=0;ec<ea.invite_state.events.length;ec++){let ed=ea.invite_state.events[ec];ed.type===ei.type&&ed.state_key==ei.state_key&&(ea.invite_state.events[ec]=ei,eo=!0)}eo||ea.invite_state.events.push(ei)})}accumulateJoinState(ei,eo,ea=!1){var ec,ed,eu,em,eb,eS,eE,e_;this.joinRooms[ei]||(this.joinRooms[ei]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_readReceipts:{},_threadReadReceipts:{}});let eT=this.joinRooms[ei];if(eo.account_data&&eo.account_data.events&&eo.account_data.events.forEach(ei=>{eT._accountData[ei.type]=ei}),eo.unread_notifications&&(eT._unreadNotifications=eo.unread_notifications),eT._unreadThreadNotifications=null!==(ec=null!==(ed=eo[eg.UNREAD_THREAD_NOTIFICATIONS.stable])&&void 0!==ed?ed:eo[eg.UNREAD_THREAD_NOTIFICATIONS.unstable])&&void 0!==ec?ec:void 0,eo.summary){let ei="m.heroes",ea="m.invited_member_count",ec="m.joined_member_count",ed=eT._summary,eu=eo.summary;ed[ei]=eu[ei]||ed[ei],ed[ec]=eu[ec]||ed[ec],ed[ea]=eu[ea]||ed[ea]}if(null===(eu=eo.ephemeral)||void 0===eu||null===(em=eu.events)||void 0===em||em.forEach(ei=>{ei.type===ef.EventType.Receipt&&ei.content&&Object.keys(ei.content).forEach(eo=>{Object.entries(ei.content[eo]).forEach(([ea,ec])=>{if((0,eh.isSupportedReceiptType)(ea))for(let eu of Object.keys(ec)){let ec=ei.content[eo][ea][eu],eh={data:ei.content[eo][ea][eu],type:ea,eventId:eo};if(ec.thread_id&&ec.thread_id!==ep.MAIN_ROOM_TIMELINE){var ed;eT._threadReadReceipts=ey(ey({},eT._threadReadReceipts),{},{[ec.thread_id]:ey(ey({},null!==(ed=eT._threadReadReceipts[ec.thread_id])&&void 0!==ed?ed:{}),{},{[eu]:eh})})}else eT._readReceipts[eu]=eh}})})}),eo.timeline&&eo.timeline.limited&&(eT._timeline=[]),null===(eb=eo.state)||void 0===eb||null===(eS=eb.events)||void 0===eS||eS.forEach(ei=>{ew(eT._currentState,ei)}),null===(eE=eo.timeline)||void 0===eE||null===(e_=eE.events)||void 0===e_||e_.forEach((ei,ec)=>{var ed;let eu;if(ew(eT._currentState,ei),ea)eu=ei;else{void 0!==(eu=Object.assign({},ei)).unsigned&&(eu.unsigned=Object.assign({},eu.unsigned));let eo=ei.unsigned?ei.unsigned.age:ei.age;void 0!==eo&&(eu._localTs=Date.now()-eo)}eT._timeline.push({event:eu,token:0===ec&&null!==(ed=eo.timeline.prev_batch)&&void 0!==ed?ed:null})}),eT._timeline.length>this.opts.maxTimelineEntries){let ei=eT._timeline.length-this.opts.maxTimelineEntries;for(let eo=ei;eo<eT._timeline.length;eo++)if(eT._timeline[eo].token){eT._timeline=eT._timeline.slice(eo,eT._timeline.length);break}}}getJSON(ei=!1){let eo={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(ei=>{eo.invite[ei]=this.inviteRooms[ei]}),Object.keys(this.joinRooms).forEach(ea=>{let ec=this.joinRooms[ea],ed={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:ec._unreadNotifications,unread_thread_notifications:ec._unreadThreadNotifications,summary:ec._summary};Object.keys(ec._accountData).forEach(ei=>{ed.account_data.events.push(ec._accountData[ei])});let eu={type:ef.EventType.Receipt,room_id:ea,content:{}},ep=new eh.MapWithDefault(()=>new eh.MapWithDefault(()=>new Map));for(let[ei,eo]of Object.entries(ec._readReceipts))ep.getOrCreate(eo.eventId).getOrCreate(eo.type).set(ei,eo.data);for(let ei of Object.values(ec._threadReadReceipts))for(let[eo,ea]of Object.entries(ei))ep.getOrCreate(ea.eventId).getOrCreate(ea.type).set(eo,ea.data);eu.content=(0,eh.recursiveMapToObject)(ep),ep.size>0&&ed.ephemeral.events.push(eu),ec._timeline.forEach(eo=>{let ea;if(!ed.timeline.prev_batch){if(!eo.token)return;ed.timeline.prev_batch=eo.token}!ei&&eS(eo.event)?(void 0!==(ea=Object.assign({},eo.event)).unsigned&&(ea.unsigned=Object.assign({},ea.unsigned)),delete ea._localTs,ea.unsigned=ea.unsigned||{},ea.unsigned.age=Date.now()-eo.event._localTs):ea=eo.event,ed.timeline.events.push(ea)});let eg=Object.create(null);for(let ei=ed.timeline.events.length-1;ei>=0;ei--){let eo=ed.timeline.events[ei];if(null===eo.state_key||void 0===eo.state_key)continue;let ea=(0,eh.deepCopy)(eo);ea.unsigned&&(ea.unsigned.prev_content&&(ea.content=ea.unsigned.prev_content),ea.unsigned.prev_sender&&(ea.sender=ea.unsigned.prev_sender)),ew(eg,ea)}Object.keys(ec._currentState).forEach(ei=>{Object.keys(ec._currentState[ei]).forEach(eo=>{let ea=ec._currentState[ei][eo];eg[ei]&&eg[ei][eo]&&(ea=eg[ei][eo]),ed.state.events.push(ea)})}),eo.join[ea]=ed});let ea=[];return Object.keys(this.accountData).forEach(ei=>{ea.push(this.accountData[ei])}),{nextBatch:this.nextBatch,roomsData:eo,accountData:ea}}getNextBatchToken(){return this.nextBatch}}function ew(ei,eo){null!==eo.state_key&&void 0!==eo.state_key&&eo.type&&(ei[eo.type]||(ei[eo.type]=Object.create(null)),ei[eo.type][eo.state_key]=eo)}eo.SyncAccumulator=eE},4551:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SyncState=eo.SyncApi=void 0,eo._createAndReEmitRoom=eV,eo.defaultClientOpts=eF,eo.defaultSyncApiOpts=eK;var ed=ec(ea(8416)),eu=ea(3998),eh=ea(7366),ef=eR(ea(3102)),ep=ea(7906),eg=ea(8910),em=ea(7434),ey=ea(9489),eb=ea(2168),eS=ea(95),eE=ea(2481),ew=ea(6860),e_=ea(2848),eT=ea(3971),eI=ea(1467),eC=ea(5268);function eO(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eO=function(ei){return ei?ea:eo})(ei)}function eR(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eO(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function ek(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eM(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ek(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ek(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let eP=!0,eA=8e4,eD=3,ej=function(ei){return ei.Error="ERROR",ei.Prepared="PREPARED",ei.Stopped="STOPPED",ei.Syncing="SYNCING",ei.Catchup="CATCHUP",ei.Reconnecting="RECONNECTING",ei}({});eo.SyncState=ej;let eL=["org.matrix.msc2716v3"];function eN(ei,eo){return`FILTER_SYNC_${ei}`+(eo?"_"+eo:"")}function eU(...ei){eP&&em.logger.log(...ei)}var eB=function(ei){return ei.Offline="offline",ei.Online="online",ei.Unavailable="unavailable",ei}(eB||{});function eF(ei){return eM({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:eb.PendingEventOrdering.Chronological,threadSupport:!1},ei)}function eK(ei){return eM({canResetEntireTimeline:ei=>!1},ei)}class e${constructor(ei,eo,ea){this.client=ei,(0,ed.default)(this,"opts",void 0),(0,ed.default)(this,"syncOpts",void 0),(0,ed.default)(this,"_peekRoom",null),(0,ed.default)(this,"currentSyncRequest",void 0),(0,ed.default)(this,"abortController",void 0),(0,ed.default)(this,"syncState",null),(0,ed.default)(this,"syncStateData",void 0),(0,ed.default)(this,"catchingUp",!1),(0,ed.default)(this,"running",!1),(0,ed.default)(this,"keepAliveTimer",void 0),(0,ed.default)(this,"connectionReturnedDefer",void 0),(0,ed.default)(this,"notifEvents",[]),(0,ed.default)(this,"failedSyncCount",0),(0,ed.default)(this,"storeIsInvalid",!1),(0,ed.default)(this,"getPushRules",async()=>{try{eU("Getting push rules...");let ei=await this.client.getPushRules();eU("Got push rules"),this.client.pushRules=ei}catch(ei){if(em.logger.error("Getting push rules failed",ei),this.shouldAbortSync(ei))return;return eU("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,ei),this.getPushRules()}}),(0,ed.default)(this,"buildDefaultFilter",()=>{let ei=new ep.Filter(this.client.credentials.userId);return this.client.canSupport.get(eC.Feature.ThreadUnreadNotifications)!==eC.ServerSupport.Unsupported&&ei.setUnreadThreadNotifications(!0),ei}),(0,ed.default)(this,"checkLazyLoadStatus",async()=>{if(eU("Checking lazy load status..."),this.opts.lazyLoadMembers&&this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){eU("Checking server lazy load support...");let ei=await this.client.doesServerSupportLazyLoading();ei?(eU("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)):(eU("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}eU("Checking whether lazy loading has changed in store...");let ei=await this.wasLazyLoadingToggled(this.opts.lazyLoadMembers);if(ei){this.storeIsInvalid=!0;let ei=new ey.InvalidStoreError(ey.InvalidStoreState.ToggledLazyLoading,!!this.opts.lazyLoadMembers);this.updateSyncState(ej.Error,{error:ei}),em.logger.warn("InvalidStoreError: store is not usable: stopping sync.");return}if(this.opts.lazyLoadMembers){var eo;null===(eo=this.syncOpts.crypto)||void 0===eo||eo.enableLazyLoading()}try{eU("Storing client options..."),await this.client.storeClientOptions(),eU("Stored client options")}catch(ei){throw em.logger.error("Storing client options failed",ei),ei}}),(0,ed.default)(this,"getFilter",async()=>{let ei,eo;eU("Getting filter..."),ei=this.opts.filter?this.opts.filter:this.buildDefaultFilter();try{eo=await this.client.getOrCreateFilter(eN(this.client.credentials.userId),ei)}catch(ei){if(em.logger.error("Getting filter failed",ei),this.shouldAbortSync(ei))return{};return eU("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,ei),this.getFilter()}return{filter:ei,filterId:eo}}),(0,ed.default)(this,"savedSyncPromise",void 0),(0,ed.default)(this,"onOnline",()=>{eU("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=eF(eo),this.syncOpts=eK(ea),ei.getNotifTimelineSet()&&ei.reEmitter.reEmit(ei.getNotifTimelineSet(),[eh.RoomEvent.Timeline,eh.RoomEvent.TimelineReset])}createRoom(ei){let eo=eV(this.client,ei,this.opts);return eo.on(ew.RoomStateEvent.Marker,(ei,ea)=>{this.onMarkerStateEvent(eo,ei,ea)}),eo}onMarkerStateEvent(ei,eo,{timelineWasEmpty:ea}={}){if(ea){em.logger.debug(`MarkerState: Ignoring markerEventId=${eo.getId()} in roomId=${ei.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`);return}let ec=eL.includes(ei.getVersion())||eo.getSender()===ei.getCreator();ec?(em.logger.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${eo.getId()} was sent in roomId=${ei.roomId}`),ei.setTimelineNeedsRefresh(!0),ei.emit(eh.RoomEvent.HistoryImportedWithinTimeline,eo,ei)):em.logger.debug(`MarkerState: Ignoring markerEventId=${eo.getId()} in roomId=${ei.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}async syncLeftRooms(){var ei;let eo=this.client,ea=new ep.Filter(this.client.credentials.userId);ea.setTimelineLimit(1),ea.setIncludeLeaveRooms(!0);let ec=this.opts.pollTimeout+eA,ed=await eo.getOrCreateFilter(eN(eo.credentials.userId,"LEFT_ROOMS"),ea),eu={timeout:0,filter:ed},eh=await eo.http.authedRequest(eS.Method.Get,"/sync",eu,void 0,{localTimeoutMs:ec}),ef=[];null!==(ei=eh.rooms)&&void 0!==ei&&ei.leave&&(ef=this.mapSyncResponseToRoomArray(eh.rooms.leave));let em=await Promise.all(ef.map(async ei=>{let ea=ei.room;if(!ei.isBrandNewRoom)return;ei.timeline=ei.timeline||{prev_batch:null,events:[]};let ec=this.mapSyncEventsFormat(ei.timeline,ea),ed=this.mapSyncEventsFormat(ei.state,ea);return ea.getLiveTimeline().setPaginationToken(ei.timeline.prev_batch,eg.EventTimeline.BACKWARDS),await this.injectRoomEvents(ea,ed,ec),ea.recalculate(),eo.store.storeRoom(ea),eo.emit(eb.ClientEvent.Room,ea),this.processEventsForNotifs(ea,ec),ea}));return em.filter(Boolean)}peek(ei){var eo;if((null===(eo=this._peekRoom)||void 0===eo?void 0:eo.roomId)===ei)return Promise.resolve(this._peekRoom);let ea=this.client;return this._peekRoom=this.createRoom(ei),this.client.roomInitialSync(ei,20).then(ei=>{ei.messages=ei.messages||{chunk:[]},ei.messages.chunk=ei.messages.chunk||[],ei.state=ei.state||[];let eo=ef.deepCopy(ei.state).map(ea.getEventMapper()),ec=ei.state.map(ea.getEventMapper()),ed=ei.messages.chunk.map(ea.getEventMapper());return Array.isArray(ei.presence)&&ei.presence.map(ea.getEventMapper()).forEach(function(ei){let eo=ea.store.getUser(ei.getContent().user_id);eo?eo.setPresenceEvent(ei):((eo=eW(ea,ei.getContent().user_id)).setPresenceEvent(ei),ea.store.storeUser(eo)),ea.emit(eb.ClientEvent.Event,ei)}),ei.messages.start&&(this._peekRoom.oldState.paginationToken=ei.messages.start),this._peekRoom.oldState.setStateEvents(eo),this._peekRoom.currentState.setStateEvents(ec),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(ed.reverse(),!0,this._peekRoom.getLiveTimeline(),ei.messages.start),ea.store.storeRoom(this._peekRoom),ea.emit(eb.ClientEvent.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(ei,eo){var ea;if(this._peekRoom!==ei){eU("Stopped peeking in room %s",ei.roomId);return}this.client.http.authedRequest(eS.Method.Get,"/events",{room_id:ei.roomId,timeout:String(3e4),from:eo},void 0,{localTimeoutMs:5e4,abortSignal:null===(ea=this.abortController)||void 0===ea?void 0:ea.signal}).then(eo=>{if(this._peekRoom!==ei){eU("Stopped peeking in room %s",ei.roomId);return}eo.chunk.filter(function(ei){return"m.presence"===ei.type}).map(this.client.getEventMapper()).forEach(ei=>{let eo=this.client.store.getUser(ei.getContent().user_id);eo?eo.setPresenceEvent(ei):((eo=eW(this.client,ei.getContent().user_id)).setPresenceEvent(ei),this.client.store.storeUser(eo)),this.client.emit(eb.ClientEvent.Event,ei)});let ea=eo.chunk.filter(function(eo){return eo.room_id===ei.roomId&&eo.event_id}).map(this.client.getEventMapper());ei.addLiveEvents(ea),this.peekPoll(ei,eo.end)},ea=>{em.logger.error("[%s] Peek poll failed: %s",ei.roomId,ea),setTimeout(()=>{this.peekPoll(ei,eo)},3e4)})}getSyncState(){return this.syncState}getSyncStateData(){var ei;return null!==(ei=this.syncStateData)&&void 0!==ei?ei:null}async recoverFromSyncStartupError(ei,eo){await ei;let ea=this.startKeepAlives();this.updateSyncState(ej.Error,{error:eo}),await ea}async wasLazyLoadingToggled(ei=!1){let eo=!1,ea=await this.client.store.isNewlyCreated();if(!ea){let ea=await this.client.store.getClientOptions();return ea&&(eo=!!ea.lazyLoadMembers),eo!==ei}return!1}shouldAbortSync(ei){return"M_UNKNOWN_TOKEN"===ei.errcode&&(em.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(ej.Error,{error:ei}),!0)}async sync(){var ei,eo;if(this.running=!0,this.abortController=new AbortController,null===(ei=ea.g.window)||void 0===ei||null===(eo=ei.addEventListener)||void 0===eo||eo.call(ei,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});eU("Getting saved sync token...");let ec=this.client.store.getSavedSyncToken().then(ei=>(eU("Got saved sync token"),ei));this.savedSyncPromise=this.client.store.getSavedSync().then(ei=>{if(eU(`Got reply from saved sync, exists? ${!!ei}`),ei)return this.syncFromCache(ei)}).catch(ei=>{em.logger.error("Getting saved sync failed",ei)}),await this.getPushRules(),await this.checkLazyLoadStatus();let{filterId:ed,filter:eu}=await this.getFilter();if(eu){if(this.client.resetNotifTimelineSet(),!this.currentSyncRequest){let ei=ed,eo=await ec;if(eo)eU("Sending first sync request...");else{eU("Sending initial sync request...");let eo=this.buildDefaultFilter();eo.setDefinition(eu.getDefinition()),eo.setTimelineLimit(this.opts.initialSyncLimit),ei=JSON.stringify(eo.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:ei},eo)}return eU("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:ed})}}stop(){var ei,eo,ec;eU("SyncApi.stop"),null===(ei=ea.g.window)||void 0===ei||null===(eo=ei.removeEventListener)||void 0===eo||eo.call(ei,"online",this.onOnline,!1),this.running=!1,null===(ec=this.abortController)||void 0===ec||ec.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(ei){eU("sync(): not doing HTTP hit, instead returning stored /sync data");let eo=ei.nextBatch;this.client.store.setSyncToken(eo);let ea={nextSyncToken:eo,catchingUp:!1,fromCache:!0},ec={next_batch:eo,rooms:ei.roomsData,account_data:{events:ei.accountData}};try{await this.processSyncResponse(ea,ec)}catch(ei){em.logger.error("Error processing cached sync",ei)}this.storeIsInvalid||this.updateSyncState(ej.Prepared,ea)}async doSync(ei){for(;this.running;){let eo;let ea=this.client.store.getSyncToken();try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(ei,ea)),eo=await this.currentSyncRequest}catch(eo){let ei=await this.onSyncError(eo);if(ei)return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(eo.next_batch),this.failedSyncCount=0,await this.client.store.setSyncData(eo);let ec={oldSyncToken:null!=ea?ea:void 0,nextSyncToken:eo.next_batch,catchingUp:this.catchingUp};this.syncOpts.crypto&&await this.syncOpts.crypto.onSyncWillProcess(ec);try{await this.processSyncResponse(ec,eo)}catch(ei){em.logger.error("Caught /sync error",ei),this.client.emit(eb.ClientEvent.SyncUnexpectedError,ei)}ec.catchingUp=this.catchingUp,ei.hasSyncedBefore||(this.updateSyncState(ej.Prepared,ec),ei.hasSyncedBefore=!0),this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onSyncCompleted(ec),this.updateSyncState(ej.Syncing,ec),this.client.store.wantsSave()&&(this.syncOpts.crypto&&await this.syncOpts.crypto.saveDeviceList(0),await this.client.store.save())}this.running||(eU("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(ej.Stopped))}doSyncRequest(ei,eo){var ea;let ec=this.getSyncParams(ei,eo);return this.client.http.authedRequest(eS.Method.Get,"/sync",ec,void 0,{localTimeoutMs:ec.timeout+eA,abortSignal:null===(ea=this.abortController)||void 0===ea?void 0:ea.signal})}getSyncParams(ei,eo){let ea=this.opts.pollTimeout;(this.getSyncState()!==ej.Syncing||this.catchingUp)&&(this.catchingUp=!0,ea=0);let ec=ei.filter;this.client.isGuest()&&!ec&&(ec=this.getGuestFilter());let ed={filter:ec,timeout:ea};return this.opts.disablePresence&&(ed.set_presence=eB.Offline),eo?ed.since=eo:ed._cacheBuster=Date.now(),[ej.Reconnecting,ej.Error].includes(this.getSyncState())&&(ed.timeout=0),ed}async onSyncError(ei){if(!this.running)return eU("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(ej.Stopped),!0;if(em.logger.error("/sync error %s",ei),this.shouldAbortSync(ei))return!0;this.failedSyncCount++,em.logger.log("Number of consecutive failed sync requests:",this.failedSyncCount),eU("Starting keep-alive");let eo=this.startKeepAlives();this.currentSyncRequest=void 0,this.updateSyncState(this.failedSyncCount>=eD?ej.Error:ej.Reconnecting,{error:ei});let ea=await eo;return ea&&this.getSyncState()===ej.Error&&this.updateSyncState(ej.Catchup,{catchingUp:!0}),!1}async processSyncResponse(ei,eo){var ea,ec,ed,eu;let ep=this.client;if(Array.isArray(null===(ea=eo.presence)||void 0===ea?void 0:ea.events)&&eo.presence.events.filter(ef.noUnsafeEventProps).map(ep.getEventMapper()).forEach(function(ei){let eo=ep.store.getUser(ei.getSender());eo?eo.setPresenceEvent(ei):((eo=eW(ep,ei.getSender())).setPresenceEvent(ei),ep.store.storeUser(eo)),ep.emit(eb.ClientEvent.Event,ei)}),Array.isArray(null===(ec=eo.account_data)||void 0===ec?void 0:ec.events)){let ei=eo.account_data.events.filter(ef.noUnsafeEventProps).map(ep.getEventMapper()),ea=ei.reduce((ei,eo)=>(ei[eo.getType()]=ep.store.getAccountData(eo.getType()),ei),{});ep.store.storeAccountDataEvents(ei),ei.forEach(function(ei){if(ei.getType()===eE.EventType.PushRules){let eo=ei.getContent();ep.setPushRules(eo)}let eo=ea[ei.getType()];return ep.emit(eb.ClientEvent.AccountData,ei,eo),ei})}if(eo.to_device&&Array.isArray(eo.to_device.events)&&eo.to_device.events.length>0){let ei=eo.to_device.events.filter(ef.noUnsafeEventProps);this.syncOpts.cryptoCallbacks&&(ei=await this.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(ei));let ea=[];ei.map(ep.getEventMapper({toDevice:!0})).map(ei=>{if("m.key.verification.cancel"===ei.getType()){let eo=ei.getContent().transaction_id;eo&&ea.push(eo)}return ei}).forEach(function(ei){let eo=ei.getContent();if("m.room.message"==ei.getType()&&"m.bad.encrypted"==eo.msgtype){em.logger.log("Ignoring undecryptable to-device event from "+ei.getSender());return}if("m.key.verification.start"===ei.getType()||"m.key.verification.request"===ei.getType()){let ec=eo.transaction_id;ea.includes(ec)&&ei.flagCancelled()}ep.emit(eb.ClientEvent.ToDeviceEvent,ei)})}else this.catchingUp=!1;let ey=[],eS=[],ew=[];eo.rooms&&(eo.rooms.invite&&(ey=this.mapSyncResponseToRoomArray(eo.rooms.invite)),eo.rooms.join&&(eS=this.mapSyncResponseToRoomArray(eo.rooms.join)),eo.rooms.leave&&(ew=this.mapSyncResponseToRoomArray(eo.rooms.leave))),this.notifEvents=[],await ef.promiseMapSeries(ey,async ei=>{var eo;let ea=ei.room,ec=this.mapSyncEventsFormat(ei.invite_state,ea);await this.injectRoomEvents(ea,ec);let ed=null===(eo=ea.currentState.getStateEvents(eE.EventType.RoomMember,ep.getUserId()))||void 0===eo?void 0:eo.getSender(),eu=ep.crypto;if(eu){let ei=await eu.cryptoStore.takeParkedSharedHistory(ea.roomId);for(let eo of ei)eo.senderId===ed&&await eu.olmDevice.addInboundGroupSession(ea.roomId,eo.senderKey,eo.forwardingCurve25519KeyChain,eo.sessionId,eo.sessionKey,eo.keysClaimed,!0,{sharedHistory:!0,untrusted:!0})}ei.isBrandNewRoom?(ea.recalculate(),ep.store.storeRoom(ea),ep.emit(eb.ClientEvent.Room,ea)):ea.recalculate(),ec.forEach(function(ei){ep.emit(eb.ClientEvent.Event,ei)})}),await ef.promiseMapSeries(eS,async eo=>{var ea,ec,ed,eu,ef,ey;let eS=eo.room,ew=this.mapSyncEventsFormat(eo.state,eS),e_=this.mapSyncEventsFormat(eo.timeline,eS,!1),eT=this.mapSyncEventsFormat(eo.ephemeral),eC=this.mapSyncEventsFormat(eo.account_data),eO=ep.isRoomEncrypted(eS.roomId);eo.unread_notifications&&(eO&&0!==eo.unread_notifications.notification_count||eS.setUnreadNotificationCount(eh.NotificationCountType.Total,null!==(ec=eo.unread_notifications.notification_count)&&void 0!==ec?ec:0),(!eO||0>=eS.getUnreadNotificationCount(eh.NotificationCountType.Highlight))&&eS.setUnreadNotificationCount(eh.NotificationCountType.Highlight,null!==(ed=eo.unread_notifications.highlight_count)&&void 0!==ed?ed:0));let eR=null!==(ea=eo[eI.UNREAD_THREAD_NOTIFICATIONS.name])&&void 0!==ea?ea:eo[eI.UNREAD_THREAD_NOTIFICATIONS.altName];if(eR)for(let[ei,eo]of(eS.resetThreadUnreadNotificationCount(Object.keys(eR)),Object.entries(eR))){eO&&0!==eo.notification_count||eS.setThreadUnreadNotificationCount(ei,eh.NotificationCountType.Total,null!==(eu=eo.notification_count)&&void 0!==eu?eu:0);let ea=0>=eS.getThreadUnreadNotificationCount(ei,eh.NotificationCountType.Highlight);(!eO||eO&&ea)&&eS.setThreadUnreadNotificationCount(ei,eh.NotificationCountType.Highlight,null!==(ef=eo.highlight_count)&&void 0!==ef?ef:0)}else eS.resetThreadUnreadNotificationCount();if(eo.timeline=eo.timeline||{},eo.isBrandNewRoom)null!==eo.timeline.prev_batch&&eS.getLiveTimeline().setPaginationToken(eo.timeline.prev_batch,eg.EventTimeline.BACKWARDS);else if(eo.timeline.limited){let ea=!0;for(let ei=e_.length-1;ei>=0;ei--){let eo=e_[ei].getId();if(eS.getTimelineForEvent(eo)){eU(`Already have event ${eo} in limited sync - not resetting`),ea=!1,e_.splice(0,ei);break}}ea&&(eS.resetLiveTimeline(eo.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(eS.roomId)?null:null!==(ey=ei.oldSyncToken)&&void 0!==ey?ey:null),ep.resetNotifTimelineSet())}if(this.syncOpts.cryptoCallbacks)for(let ei of ew.concat(e_))ei.isState()&&ei.getType()===eE.EventType.RoomEncryption&&""===ei.getStateKey()&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(eS,ei);try{await this.injectRoomEvents(eS,ew,e_,ei.fromCache)}catch(ei){em.logger.error(`Failed to process events on room ${eS.roomId}:`,ei)}eo.summary&&eS.setSummary(eo.summary),eS.addEphemeralEvents(eT),eS.addAccountData(eC),eS.recalculate(),eo.isBrandNewRoom&&(ep.store.storeRoom(eS),ep.emit(eb.ClientEvent.Room,eS)),this.processEventsForNotifs(eS,e_);let ek=ei=>ep.emit(eb.ClientEvent.Event,ei);ew.forEach(ek),e_.forEach(ek),eT.forEach(ek),eC.forEach(ek),eS.decryptCriticalEvents()}),await ef.promiseMapSeries(ew,async ei=>{let eo=ei.room,ea=this.mapSyncEventsFormat(ei.state,eo),ec=this.mapSyncEventsFormat(ei.timeline,eo),ed=this.mapSyncEventsFormat(ei.account_data);await this.injectRoomEvents(eo,ea,ec),eo.addAccountData(ed),eo.recalculate(),ei.isBrandNewRoom&&(ep.store.storeRoom(eo),ep.emit(eb.ClientEvent.Room,eo)),this.processEventsForNotifs(eo,ec),ea.forEach(function(ei){ep.emit(eb.ClientEvent.Event,ei)}),ec.forEach(function(ei){ep.emit(eb.ClientEvent.Event,ei)}),ed.forEach(function(ei){ep.emit(eb.ClientEvent.Event,ei)})}),ei.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort(function(ei,eo){return ei.getTs()-eo.getTs()}),this.notifEvents.forEach(function(ei){var eo;null===(eo=ep.getNotifTimelineSet())||void 0===eo||eo.addLiveEvent(ei)})),eo.device_lists&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.processDeviceLists(eo.device_lists),null===(ed=this.syncOpts.cryptoCallbacks)||void 0===ed||ed.processKeyCounts(eo.device_one_time_keys_count,null!==(eu=eo.device_unused_fallback_key_types)&&void 0!==eu?eu:eo["org.matrix.msc2732.device_unused_fallback_key_types"])}startKeepAlives(ei){return void 0===ei&&(ei=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),ei>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),ei):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=ef.defer()),this.connectionReturnedDefer.promise}pokeKeepAlive(ei=!1){var eo;let ea=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(ei),this.connectionReturnedDefer=void 0)};this.client.http.request(eS.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null===(eo=this.abortController)||void 0===eo?void 0:eo.signal}).then(()=>{ea()},eo=>{400==eo.httpStatus||404==eo.httpStatus?this.keepAliveTimer=setTimeout(ea,2e3):(ei=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,ei),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(ej.Error,{error:eo}))})}mapSyncResponseToRoomArray(ei){let eo=this.client;return Object.keys(ei).filter(ei=>!(0,ef.unsafeProp)(ei)).map(ea=>{let ec=ei[ea],ed=eo.store.getRoom(ea),eu=!1;return ed||(ed=this.createRoom(ea),eu=!0),ec.room=ed,ec.isBrandNewRoom=eu,ec})}mapSyncEventsFormat(ei,eo,ea=!0){if(!ei||!Array.isArray(ei.events))return[];let ec=this.client.getEventMapper({decrypt:ea});return ei.events.filter(ef.noUnsafeEventProps).map(function(ei){return eo&&(ei.room_id=eo.roomId),ec(ei)})}resolveInvites(ei){if(!ei||!this.opts.resolveInvitesToProfiles)return;let eo=this.client;ei.getMembersWithMembership("invite").forEach(function(ea){let ec;if(ea.requestedProfileInfo)return;ea.requestedProfileInfo=!0;let ed=eo.getUser(ea.userId);(ec=ed?Promise.resolve({avatar_url:ed.avatarUrl,displayname:ed.displayName}):eo.getProfileInfo(ea.userId)).then(function(eo){let ec=ea.events.member;(null==ec?void 0:ec.getContent().membership)==="invite"&&(ec.getContent().avatar_url=eo.avatar_url,ec.getContent().displayname=eo.displayname,ea.setMembershipEvent(ec,ei.currentState))},function(ei){})})}async injectRoomEvents(ei,eo,ea,ec=!1){let ed=ei.getLiveTimeline(),eu=0==ed.getEvents().length;if(eu){for(let ei of eo)this.client.getPushActionsForEvent(ei);ed.initialiseState(eo,{timelineWasEmpty:eu})}this.resolveInvites(ei),ei.recalculate(),eu||(ei.oldState.setStateEvents(eo||[]),ei.currentState.setStateEvents(eo||[])),ei.addLiveEvents(ea||[],{fromCache:ec,timelineWasEmpty:eu}),this.client.processBeaconEvents(ei,ea)}processEventsForNotifs(ei,eo){if(this.client.getNotifTimelineSet())for(let ei of eo){var ea;let eo=this.client.getPushActionsForEvent(ei);null!=eo&&eo.notify&&null!==(ea=eo.tweaks)&&void 0!==ea&&ea.highlight&&this.notifEvents.push(ei)}}getGuestFilter(){return"{}"}updateSyncState(ei,eo){let ea=this.syncState;this.syncState=ei,this.syncStateData=eo,this.client.emit(eb.ClientEvent.Sync,this.syncState,ea,eo)}}function eW(ei,eo){let ea=new eu.User(eo);return ei.reEmitter.reEmit(ea,[eu.UserEvent.AvatarUrl,eu.UserEvent.DisplayName,eu.UserEvent.Presence,eu.UserEvent.CurrentlyActive,eu.UserEvent.LastPresenceTs]),ea}function eV(ei,eo,ea){let{timelineSupport:ec}=ei,ed=new eh.Room(eo,ei,ei.getUserId(),{lazyLoadMembers:ea.lazyLoadMembers,pendingEventOrdering:ea.pendingEventOrdering,timelineSupport:ec});return ei.reEmitter.reEmit(ed,[eh.RoomEvent.Name,eh.RoomEvent.Redaction,eh.RoomEvent.RedactionCancelled,eh.RoomEvent.Receipt,eh.RoomEvent.Tags,eh.RoomEvent.LocalEchoUpdated,eh.RoomEvent.AccountData,eh.RoomEvent.MyMembership,eh.RoomEvent.Timeline,eh.RoomEvent.TimelineReset,ew.RoomStateEvent.Events,ew.RoomStateEvent.Members,ew.RoomStateEvent.NewMember,ew.RoomStateEvent.Update,eT.BeaconEvent.New,eT.BeaconEvent.Update,eT.BeaconEvent.Destroy,eT.BeaconEvent.LivenessChange]),ed.on(ew.RoomStateEvent.NewMember,(eo,ea,ec)=>{var ed;ec.user=null!==(ed=ei.getUser(ec.userId))&&void 0!==ed?ed:void 0,ei.reEmitter.reEmit(ec,[e_.RoomMemberEvent.Name,e_.RoomMemberEvent.Typing,e_.RoomMemberEvent.PowerLevel,e_.RoomMemberEvent.Membership])}),ed}eo.SyncApi=e$},4969:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.TimelineWindow=eo.TimelineIndex=void 0;var ed=ec(ea(8416)),eu=ea(8910),eh=ea(7434);let ef=!1,ep=ef?eh.logger.log.bind(eh.logger):function(){},eg=5;class em{constructor(ei,eo,ea={}){this.client=ei,this.timelineSet=eo,(0,ed.default)(this,"windowLimit",void 0),(0,ed.default)(this,"start",void 0),(0,ed.default)(this,"end",void 0),(0,ed.default)(this,"eventCount",0),this.windowLimit=ea.windowLimit||1e3}load(ei,eo=20){let ea=ea=>{let ec;if(!ea)throw Error("No timeline given to initFields");let ed=ea.getEvents();if(ei){if((ec=ed.findIndex(eo=>eo.getId()===ei))<0)throw Error("getEventTimeline result didn't include requested event")}else ec=ed.length;let eu=Math.min(ed.length,ec+Math.ceil(eo/2)),eh=Math.max(0,eu-eo);this.start=new ey(ea,eh-ea.getBaseIndex()),this.end=new ey(ea,eu-ea.getBaseIndex()),this.eventCount=eu-eh};return this.timelineSet.getTimelineForEvent(ei)?(ea(this.timelineSet.getTimelineForEvent(ei)),Promise.resolve()):ei?this.client.getEventTimeline(this.timelineSet,ei).then(ea):(ea(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(ei){var eo,ea;if(ei==eu.EventTimeline.BACKWARDS)return null!==(eo=this.start)&&void 0!==eo?eo:null;if(ei==eu.EventTimeline.FORWARDS)return null!==(ea=this.end)&&void 0!==ea?ea:null;throw Error("Invalid direction '"+ei+"'")}extend(ei,eo){let ea=this.getTimelineIndex(ei);if(!ea)return ep("TimelineWindow: no timeline yet"),!1;let ec=ei==eu.EventTimeline.BACKWARDS?ea.retreat(eo):ea.advance(eo);if(ec){this.eventCount+=ec,ep("TimelineWindow: increased cap by "+ec+" (now "+this.eventCount+")");let eo=this.eventCount-this.windowLimit;return eo>0&&this.unpaginate(eo,ei!=eu.EventTimeline.BACKWARDS),!0}return!1}canPaginate(ei){let eo=this.getTimelineIndex(ei);if(!eo)return ep("TimelineWindow: no timeline yet"),!1;if(ei==eu.EventTimeline.BACKWARDS){if(eo.index>eo.minIndex())return!0}else if(eo.index<eo.maxIndex())return!0;let ea=eo.timeline.getNeighbouringTimeline(ei),ec=eo.timeline.getPaginationToken(ei);return!!ea||!!ec}async paginate(ei,eo,ea=!0,ec=eg){let ed=this.getTimelineIndex(ei);if(!ed)return ep("TimelineWindow: no timeline yet"),!1;if(ed.pendingPaginate)return ed.pendingPaginate;if(this.extend(ei,eo))return!0;if(!ea||0===ec)return!1;let eh=ed.timeline.getPaginationToken(ei);if(!eh)return ep("TimelineWindow: no token"),!1;ep("TimelineWindow: starting request");let ef=this.client.paginateEventTimeline(ed.timeline,{backwards:ei==eu.EventTimeline.BACKWARDS,limit:eo}).finally(function(){ed.pendingPaginate=void 0}).then(ea=>(ep("TimelineWindow: request completed with result "+ea),ea)?this.paginate(ei,eo,!0,ec-1):this.paginate(ei,eo,!1,0));return ed.pendingPaginate=ef,ef}unpaginate(ei,eo){let ea=eo?this.start:this.end;if(!ea)throw Error(`Attempting to unpaginate startOfTimeline=${eo} but don't have this direction`);if(ei>this.eventCount||ei<0)throw Error(`Attemting to unpaginate ${ei} events, but only have ${this.eventCount} in the timeline`);for(;ei>0;){let ec=eo?ea.advance(ei):ea.retreat(ei);if(ec<=0)throw Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");ei-=ec,this.eventCount-=ec,ep("TimelineWindow.unpaginate: dropped "+ec+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];let ei=[],eo=this.start.timeline;for(;;){var ea,ec;let ed=eo.getEvents(),eh=0,ef=ed.length;eo===this.start.timeline&&(eh=this.start.index+eo.getBaseIndex()),eo===(null===(ea=this.end)||void 0===ea?void 0:ea.timeline)&&(ef=this.end.index+eo.getBaseIndex());for(let eo=eh;eo<ef;eo++)ei.push(ed[eo]);if(eo===(null===(ec=this.end)||void 0===ec?void 0:ec.timeline))break;eo=eo.getNeighbouringTimeline(eu.EventTimeline.FORWARDS)}return ei}}eo.TimelineWindow=em;class ey{constructor(ei,eo){this.timeline=ei,this.index=eo,(0,ed.default)(this,"pendingPaginate",void 0)}minIndex(){return -1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(ei){let eo;if(!ei)return 0;if(ei<0){if((eo=Math.max(ei,this.minIndex()-this.index))<0)return this.index+=eo,eo}else if((eo=Math.min(ei,this.maxIndex()-this.index))>0)return this.index+=eo,eo;let ea=this.timeline.getNeighbouringTimeline(ei<0?eu.EventTimeline.BACKWARDS:eu.EventTimeline.FORWARDS);return ea?(this.timeline=ea,ei<0?this.index=this.maxIndex():this.index=this.minIndex(),ep("paginate: switched to new neighbour"),this.advance(ei)):0}retreat(ei){return -1*this.advance(-1*ei)}}eo.TimelineIndex=ey},3102:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MapWithDefault=eo.DEFAULT_ALPHABET=void 0,eo.alphabetPad=eY,eo.averageBetweenStrings=eX,eo.baseToString=eJ,eo.checkObjectHasKeys=eC,eo.chunkPromises=eG,eo.compare=e3,eo.decodeParams=ew,eo.deepCompare=eR,eo.deepCopy=eO,eo.deepSortedObjectEntries=ek,eo.defer=e$,eo.encodeParams=eS,eo.encodeUri=e_,eo.ensureNoTrailingSlash=eU,eo.escapeRegExp=eL,eo.globToRegexp=eN,eo.immediate=eF,eo.internaliseString=eb,eo.isFunction=eI,eo.isNullOrUndefined=eK,eo.isNumber=eM,eo.isSupportedReceiptType=e8,eo.lexicographicCompare=e1,eo.mapsEqual=e7,eo.nextString=eZ,eo.noUnsafeEventProps=td,eo.normalize=eD,eo.prevString=e0,eo.promiseMapSeries=eW,eo.promiseTry=eV,eo.recursiveMapToObject=ti,eo.recursivelyAssign=e6,eo.removeDirectionOverrideChars=eA,eo.removeElement=eT,eo.removeHiddenChars=eP,eo.replaceParam=eE,eo.safeSet=tc,eo.simpleRetryOperation=eH,eo.sleep=eB,eo.sortEventsByLatestContentTimestamp=e5,eo.stringToBase=eQ,eo.unsafeProp=ta;var ed=ec(ea(8416)),eu=ec(ea(5067)),eh=ec(ea(2693)),ef=ea(6709),ep=ea(5550);function eg(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function em(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eg(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eg(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let ey=new Map;function eb(ei){return ei instanceof String&&(ei=ei.toString()),ey.has(ei)||ey.set(ei,ei),ey.get(ei)}function eS(ei,eo){let ea=null!=eo?eo:new URLSearchParams;for(let[eo,ec]of Object.entries(ei))null!=ec&&(Array.isArray(ec)?ec.forEach(ei=>{ea.append(eo,String(ei))}):ea.append(eo,String(ec)));return ea}function eE(ei,eo,ea){let ec=em(em({},ea),{},{[eo]:ea[ei]});return delete ec[ei],ec}function ew(ei){let eo={},ea=new URLSearchParams(ei);for(let ei of ea.keys()){let ec=ea.getAll(ei);eo[ei]=1===ec.length?ec[0]:ec}return eo}function e_(ei,eo){for(let ea in eo){if(!eo.hasOwnProperty(ea))continue;let ec=eo[ea];null!=ec&&(ei=ei.replace(ea,encodeURIComponent(ec)))}return ei}function eT(ei,eo,ea){let ec;if(ea){for(ec=ei.length-1;ec>=0;ec--)if(eo(ei[ec],ec,ei))return ei.splice(ec,1),!0}else for(ec=0;ec<ei.length;ec++)if(eo(ei[ec],ec,ei))return ei.splice(ec,1),!0;return!1}function eI(ei){return"[object Function]"===Object.prototype.toString.call(ei)}function eC(ei,eo){for(let ea of eo)if(!ei.hasOwnProperty(ea))throw Error("Missing required key: "+ea)}function eO(ei){return JSON.parse(JSON.stringify(ei))}function eR(ei,eo){if(ei===eo)return!0;if(typeof ei!=typeof eo)return!1;if("number"==typeof ei&&isNaN(ei)&&isNaN(eo))return!0;if(null===ei||null===eo)return ei===eo;if(!(ei instanceof Object)||ei.constructor!==eo.constructor||ei.prototype!==eo.prototype)return!1;if(ei instanceof RegExp||ei instanceof Date)return ei.toString()===eo.toString();if(Array.isArray(ei)){if(ei.length!==eo.length)return!1;for(let ea=0;ea<ei.length;ea++)if(!eR(ei[ea],eo[ea]))return!1}else{for(let ea in eo)if(eo.hasOwnProperty(ea)!==ei.hasOwnProperty(ea))return!1;for(let ea in ei)if(eo.hasOwnProperty(ea)!==ei.hasOwnProperty(ea)||!eR(ei[ea],eo[ea]))return!1}return!0}function ek(ei){if("object"!=typeof ei||null==ei||Array.isArray(ei))return ei;let eo=[];for(let[ea,ec]of Object.entries(ei))eo.push([ea,ek(ec)]);return eo.sort((ei,eo)=>e1(ei[0],eo[0])),eo}function eM(ei){return"number"==typeof ei&&isFinite(ei)}function eP(ei){return"string"==typeof ei?(0,eu.default)(ei.normalize("NFD").replace(ej,"")):""}function eA(ei){return"string"==typeof ei?ei.replace(/[\u202d-\u202e]/g,""):""}function eD(ei){return eP(ei.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}let ej=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function eL(ei){return ei.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function eN(ei,eo=!1){let ea=[[/\\\*/g,".*"],[/\?/g,"."]];return eo||ea.push([/\\\[(!|)(.*)\\]/g,(ei,eo,ea)=>["[",eo?"^":"",ea.replace(/\\-/,"-"),"]"].join("")]),ea.reduce((ei,eo)=>eo?ei.replace(eo[0],eo[1]):ei,eL(ei))}function eU(ei){return null!=ei&&ei.endsWith("/")?ei.slice(0,-1):ei}function eB(ei,eo){return new Promise(ea=>{setTimeout(ea,ei,eo)})}function eF(){return new Promise(setImmediate)}function eK(ei){return null==ei}function e$(){let ei,eo;let ea=new Promise((ea,ec)=>{ei=ea,eo=ec});return{resolve:ei,reject:eo,promise:ea}}async function eW(ei,eo){for(let ea of ei)await eo(await ea)}function eV(ei){return Promise.resolve(ei())}async function eG(ei,eo){let ea=[];for(let ec=0;ec<ei.length;ec+=eo)ea.push(...await Promise.all(ei.slice(ec,ec+eo).map(ei=>ei())));return ea}function eH(ei){return(0,eh.default)(eo=>ei(eo),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}let ez=(()=>{let ei="";for(let eo=32;eo<=126;eo++)ei+=String.fromCharCode(eo);return ei})();function eY(ei,eo,ea=ez){return ei.padEnd(eo,ea[0])}function eJ(ei,eo=ez){let ea=BigInt(eo.length);if(ei<=ea){var ec;return null!==(ec=eo[Number(ei)-1])&&void 0!==ec?ec:""}let ed=ei/ea,eu=Number(ei%ea)-1;return eu<0&&(ed-=BigInt(Math.abs(eu)),eu=Number(ea)-1),eJ(ed,eo)+eo[eu]}function eQ(ei,eo=ez){let ea=BigInt(eo.length),ec=BigInt(0);for(let ed=ei.length-1,eu=BigInt(0);ed>=0;ed--,eu++){let eh=ei.charCodeAt(ed)-eo.charCodeAt(0);ec+=BigInt(1+eh)*ea**eu}return ec}function eX(ei,eo,ea=ez){let ec=Math.max(ei.length,eo.length),ed=eQ(eY(ei,ec,ea),ea),eu=eQ(eY(eo,ec,ea),ea),eh=(ed+eu)/BigInt(2);return eh===ed||eh==eu?eJ(eh,ea)+ea[0]:eJ(eh,ea)}function eZ(ei,eo=ez){return eJ(eQ(ei,eo)+BigInt(1),eo)}function e0(ei,eo=ez){return eJ(eQ(ei,eo)-BigInt(1),eo)}function e1(ei,eo){return ei<eo?-1:ei>eo?1:0}eo.DEFAULT_ALPHABET=ez;let e2=new Intl.Collator;function e3(ei,eo){return e2.compare(ei,eo)}function e6(ei,eo,ea=!1){for(let[ec,ed]of Object.entries(eo)){if(ei[ec]instanceof Object&&ed){e6(ei[ec],ed);continue}if(null!=ed||!ea){ei[ec]=ed;continue}}return ei}function e4(ei){var eo;return null!==(eo=ef.M_TIMESTAMP.findIn(ei.getContent()))&&void 0!==eo?eo:-1}function e5(ei,eo){return e4(eo)-e4(ei)}function e8(ei){return[ep.ReceiptType.Read,ep.ReceiptType.ReadPrivate].includes(ei)}function e7(ei,eo,ea=(ei,eo)=>ei===eo){if(ei.size!==eo.size)return!1;for(let[ec,ed]of ei){let ei=eo.get(ec);if(void 0===ei||!ea(ed,ei))return!1}return!0}function e9(ei){return ei instanceof Map?ti(ei):Array.isArray(ei)?ei.map(ei=>e9(ei)):ei}function ti(ei){let eo=new Map;for(let[ea,ec]of ei)eo.set(ea,e9(ec));return Object.fromEntries(eo.entries())}function ta(ei){return"__proto__"===ei||"prototype"===ei||"constructor"===ei}function tc(ei,eo,ea){if(ta(eo))throw Error("Trying to modify prototype or constructor");ei[eo]=ea}function td(ei){return!(ta(ei.room_id)||ta(ei.sender)||ta(ei.user_id)||ta(ei.event_id))}class tu extends Map{constructor(ei){super(),this.createDefault=ei}getOrCreate(ei){return this.has(ei)||this.set(ei,this.createDefault()),this.get(ei)}}eo.MapWithDefault=tu},2667:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.releaseContext=eo.acquireContext=void 0;let ea=null,ec=0,ed=()=>(null===ea&&(ea=new AudioContext),ec++,ea);eo.acquireContext=ed;let eu=()=>{if(0==--ec){var ei;null===(ei=ea)||void 0===ei||ei.close(),ea=null}};eo.releaseContext=eu},9679:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MatrixCall=eo.CallType=eo.CallState=eo.CallParty=eo.CallEvent=eo.CallErrorCode=eo.CallError=eo.CallDirection=void 0,eo.createNewMatrixCall=eJ,eo.genCallID=eW,eo.setTracksEnabled=ez,eo.supportsMatrixCall=eY;var ed=ec(ea(8416)),eu=ea(7429),eh=ea(766),ef=ea(7434),ep=eI(ea(3102)),eg=ea(2481),em=ea(8401),ey=ea(5964),eb=ea(9704),eS=ea(5861),eE=ea(3272),ew=ea(8969),e_=ea(95);function eT(ei){if("function"!=typeof WeakMap)return null;var eo=new WeakMap,ea=new WeakMap;return(eT=function(ei){return ei?ea:eo})(ei)}function eI(ei,eo){if(!eo&&ei&&ei.__esModule)return ei;if(null===ei||"object"!=typeof ei&&"function"!=typeof ei)return{default:ei};var ea=eT(eo);if(ea&&ea.has(ei))return ea.get(ei);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var eu in ei)if("default"!==eu&&Object.prototype.hasOwnProperty.call(ei,eu)){var eh=ed?Object.getOwnPropertyDescriptor(ei,eu):null;eh&&(eh.get||eh.set)?Object.defineProperty(ec,eu,eh):ec[eu]=ei[eu]}return ec.default=ei,ea&&ea.set(ei,ec),ec}function eC(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eO(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eC(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eC(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}var eR=function(ei){return ei.AUDIO="audio",ei.VIDEO="video",ei}(eR||{}),ek=function(ei){return ei.OPUS="opus",ei}(ek||{});let eM=function(ei){return ei.Fledgling="fledgling",ei.InviteSent="invite_sent",ei.WaitLocalMedia="wait_local_media",ei.CreateOffer="create_offer",ei.CreateAnswer="create_answer",ei.Connecting="connecting",ei.Connected="connected",ei.Ringing="ringing",ei.Ended="ended",ei}({});eo.CallState=eM;let eP=function(ei){return ei.Voice="voice",ei.Video="video",ei}({});eo.CallType=eP;let eA=function(ei){return ei.Inbound="inbound",ei.Outbound="outbound",ei}({});eo.CallDirection=eA;let eD=function(ei){return ei.Local="local",ei.Remote="remote",ei}({});eo.CallParty=eD;let ej=function(ei){return ei.Hangup="hangup",ei.State="state",ei.Error="error",ei.Replaced="replaced",ei.LocalHoldUnhold="local_hold_unhold",ei.RemoteHoldUnhold="remote_hold_unhold",ei.HoldUnhold="hold_unhold",ei.FeedsChanged="feeds_changed",ei.AssertedIdentityChanged="asserted_identity_changed",ei.LengthChanged="length_changed",ei.DataChannel="datachannel",ei.SendVoipEvent="send_voip_event",ei.PeerConnectionCreated="peer_connection_created",ei}({});eo.CallEvent=ej;let eL=function(ei){return ei.UserHangup="user_hangup",ei.LocalOfferFailed="local_offer_failed",ei.NoUserMedia="no_user_media",ei.UnknownDevices="unknown_devices",ei.SendInvite="send_invite",ei.CreateAnswer="create_answer",ei.CreateOffer="create_offer",ei.SendAnswer="send_answer",ei.SetRemoteDescription="set_remote_description",ei.SetLocalDescription="set_local_description",ei.AnsweredElsewhere="answered_elsewhere",ei.IceFailed="ice_failed",ei.InviteTimeout="invite_timeout",ei.Replaced="replaced",ei.SignallingFailed="signalling_timeout",ei.UserBusy="user_busy",ei.Transferred="transferred",ei.NewSession="new_session",ei}({});eo.CallErrorCode=eL;let eN="1",eU="stun:turn.matrix.org",eB=6e4,eF=1e3,eK=3e4;class e$ extends Error{constructor(ei,eo,ea){super(eo+": "+ea),(0,ed.default)(this,"code",void 0),this.code=ei}}function eW(){return Date.now().toString()+(0,em.randomString)(16)}function eV(ei){let eo=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:ei?12e3:void 0}];return eo}function eG(ei,eo){return ei+":"+eo}eo.CallError=e$;class eH extends eS.TypedEventEmitter{constructor(ei){var eo;if(super(),(0,ed.default)(this,"roomId",void 0),(0,ed.default)(this,"callId",void 0),(0,ed.default)(this,"invitee",void 0),(0,ed.default)(this,"hangupParty",void 0),(0,ed.default)(this,"hangupReason",void 0),(0,ed.default)(this,"direction",void 0),(0,ed.default)(this,"ourPartyId",void 0),(0,ed.default)(this,"peerConn",void 0),(0,ed.default)(this,"toDeviceSeq",0),(0,ed.default)(this,"isPtt",!1),(0,ed.default)(this,"_state",eM.Fledgling),(0,ed.default)(this,"client",void 0),(0,ed.default)(this,"forceTURN",void 0),(0,ed.default)(this,"turnServers",void 0),(0,ed.default)(this,"candidateSendQueue",[]),(0,ed.default)(this,"candidateSendTries",0),(0,ed.default)(this,"candidatesEnded",!1),(0,ed.default)(this,"feeds",[]),(0,ed.default)(this,"transceivers",new Map),(0,ed.default)(this,"inviteOrAnswerSent",!1),(0,ed.default)(this,"waitForLocalAVStream",!1),(0,ed.default)(this,"successor",void 0),(0,ed.default)(this,"opponentMember",void 0),(0,ed.default)(this,"opponentVersion",void 0),(0,ed.default)(this,"opponentPartyId",void 0),(0,ed.default)(this,"opponentCaps",void 0),(0,ed.default)(this,"iceDisconnectedTimeout",void 0),(0,ed.default)(this,"inviteTimeout",void 0),(0,ed.default)(this,"removeTrackListeners",new Map),(0,ed.default)(this,"remoteOnHold",!1),(0,ed.default)(this,"callStatsAtEnd",void 0),(0,ed.default)(this,"makingOffer",!1),(0,ed.default)(this,"ignoreOffer",!1),(0,ed.default)(this,"responsePromiseChain",void 0),(0,ed.default)(this,"remoteCandidateBuffer",new Map),(0,ed.default)(this,"remoteAssertedIdentity",void 0),(0,ed.default)(this,"remoteSDPStreamMetadata",void 0),(0,ed.default)(this,"callLengthInterval",void 0),(0,ed.default)(this,"callStartTime",void 0),(0,ed.default)(this,"opponentDeviceId",void 0),(0,ed.default)(this,"opponentDeviceInfo",void 0),(0,ed.default)(this,"opponentSessionId",void 0),(0,ed.default)(this,"groupCallId",void 0),(0,ed.default)(this,"stopVideoTrackTimer",void 0),(0,ed.default)(this,"isOnlyDataChannelAllowed",void 0),(0,ed.default)(this,"stats",void 0),(0,ed.default)(this,"gotLocalIceCandidate",ei=>{if(ei.candidate){if(this.candidatesEnded){ef.logger.warn(`Call ${this.callId} gotLocalIceCandidate() got candidate after candidates have ended - ignoring!`);return}ef.logger.debug(`Call ${this.callId} got local ICE ${ei.candidate.sdpMid} ${ei.candidate.candidate}`),this.callHasEnded()||(""===ei.candidate.candidate?this.queueCandidate(null):this.queueCandidate(ei.candidate))}}),(0,ed.default)(this,"onIceGatheringStateChange",ei=>{var eo;ef.logger.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state changed to ${this.peerConn.iceGatheringState}`),(null===(eo=this.peerConn)||void 0===eo?void 0:eo.iceGatheringState)==="complete"&&this.queueCandidate(null)}),(0,ed.default)(this,"getLocalOfferFailed",ei=>{ef.logger.error(`Call ${this.callId} getLocalOfferFailed() running`,ei),this.emit(ej.Error,new e$(eL.LocalOfferFailed,"Failed to get local offer!",ei),this),this.terminate(eD.Local,eL.LocalOfferFailed,!1)}),(0,ed.default)(this,"getUserMediaFailed",ei=>{if(this.successor){this.successor.getUserMediaFailed(ei);return}ef.logger.warn(`Call ${this.callId} getUserMediaFailed() failed to get user media - ending call`,ei),this.emit(ej.Error,new e$(eL.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",ei),this),this.terminate(eD.Local,eL.NoUserMedia,!1)}),(0,ed.default)(this,"onIceConnectionStateChanged",()=>{var ei,eo,ea,ec,ed,eu;if(!this.callHasEnded()&&(ef.logger.debug(`Call ${this.callId} onIceConnectionStateChanged() running (state=${null===(ei=this.peerConn)||void 0===ei?void 0:ei.iceConnectionState})`),["connected","completed"].includes(null!==(eo=null===(ea=this.peerConn)||void 0===ea?void 0:ea.iceConnectionState)&&void 0!==eo?eo:"")?(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.state=eM.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(ej.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},eF))):(null===(ec=this.peerConn)||void 0===ec?void 0:ec.iceConnectionState)=="failed"?null!==(eu=this.peerConn)&&void 0!==eu&&eu.restartIce?(this.candidatesEnded=!1,this.peerConn.restartIce()):(ef.logger.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)`),this.hangup(eL.IceFailed,!1)):(null===(ed=this.peerConn)||void 0===ed?void 0:ed.iceConnectionState)=="disconnected"&&(this.iceDisconnectedTimeout=setTimeout(()=>{ef.logger.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)`),this.hangup(eL.IceFailed,!1)},eK),this.state=eM.Connecting),this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState)))for(let ei of this.getRemoteFeeds())ei.setAudioVideoMuted(!0,!0)}),(0,ed.default)(this,"onSignallingStateChanged",()=>{var ei;ef.logger.debug(`Call ${this.callId} onSignallingStateChanged() running (state=${null===(ei=this.peerConn)||void 0===ei?void 0:ei.signalingState})`)}),(0,ed.default)(this,"onTrack",ei=>{if(0===ei.streams.length){ef.logger.warn(`Call ${this.callId} onTrack() called with streamless track streamless (kind=${ei.track.kind})`);return}let eo=ei.streams[0];if(this.pushRemoteFeed(eo),!this.removeTrackListeners.has(eo)){let ei=()=>{0===eo.getTracks().length&&(ef.logger.info(`Call ${this.callId} onTrack() removing track (streamId=${eo.id})`),this.deleteFeedByStream(eo),eo.removeEventListener("removetrack",ei),this.removeTrackListeners.delete(eo))};eo.addEventListener("removetrack",ei),this.removeTrackListeners.set(eo,ei)}}),(0,ed.default)(this,"onDataChannel",ei=>{this.emit(ej.DataChannel,ei.channel,this)}),(0,ed.default)(this,"onNegotiationNeeded",async()=>{if(ef.logger.info(`Call ${this.callId} onNegotiationNeeded() negotiation is needed!`),this.state!==eM.CreateOffer&&0===this.opponentVersion){ef.logger.info(`Call ${this.callId} onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event`);return}this.queueGotLocalOffer()}),(0,ed.default)(this,"onHangupReceived",ei=>{ef.logger.debug(`Call ${this.callId} onHangupReceived() running`),this.partyIdMatches(ei)||this.state===eM.Ringing?this.terminate(eD.Remote,ei.reason||eL.UserHangup,!0):ef.logger.info(`Call ${this.callId} onHangupReceived() ignoring message from party ID ${ei.party_id}: our partner is ${this.opponentPartyId}`)}),(0,ed.default)(this,"onRejectReceived",ei=>{ef.logger.debug(`Call ${this.callId} onRejectReceived() running`);let eo=[eM.InviteSent,eM.Ringing].includes(this.state)||this.state===eM.Fledgling&&this.direction===eA.Inbound;eo?this.terminate(eD.Remote,ei.reason||eL.UserHangup,!0):ef.logger.debug(`Call ${this.callId} onRejectReceived() called in wrong state (state=${this.state})`)}),(0,ed.default)(this,"onAnsweredElsewhere",ei=>{ef.logger.debug(`Call ${this.callId} onAnsweredElsewhere() running`),this.terminate(eD.Remote,eL.AnsweredElsewhere,!0)}),this.roomId=ei.roomId,this.invitee=ei.invitee,this.client=ei.client,!this.client.deviceId)throw Error("Client must have a device ID to start calls");for(let ea of(this.forceTURN=null!==(eo=ei.forceTURN)&&void 0!==eo&&eo,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=ei.opponentDeviceId,this.opponentSessionId=ei.opponentSessionId,this.groupCallId=ei.groupCallId,this.turnServers=ei.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[eU]}),this.turnServers))ep.checkObjectHasKeys(ea,["urls"]);this.callId=eW(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(ei,eo){let ea=this.peerConn.createDataChannel(ei,eo);return this.emit(ej.DataChannel,ea,this),ea}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(ei){let eo=this._state;this._state=ei,this.emit(ej.State,ei,eo,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?eP.Video:eP.Voice}get hasLocalUserMediaVideoTrack(){var ei;return!!(null!==(ei=this.localUsermediaStream)&&void 0!==ei&&ei.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(ei=>{var eo;return ei.purpose===ey.SDPStreamMetadataPurpose.Usermedia&&(null===(eo=ei.stream)||void 0===eo?void 0:eo.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var ei;return!!(null!==(ei=this.localUsermediaStream)&&void 0!==ei&&ei.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(ei=>{var eo;return ei.purpose===ey.SDPStreamMetadataPurpose.Usermedia&&!!(null!==(eo=ei.stream)&&void 0!==eo&&eo.getAudioTracks().length)})}get hasUserMediaAudioSender(){var ei;return!!(null===(ei=this.transceivers.get(eG(ey.SDPStreamMetadataPurpose.Usermedia,"audio")))||void 0===ei?void 0:ei.sender)}get hasUserMediaVideoSender(){var ei;return!!(null===(ei=this.transceivers.get(eG(ey.SDPStreamMetadataPurpose.Usermedia,"video")))||void 0===ei?void 0:ei.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(ei=>ei.purpose===ey.SDPStreamMetadataPurpose.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(ei=>ei.purpose===ey.SDPStreamMetadataPurpose.Screenshare)}get localUsermediaStream(){var ei;return null===(ei=this.localUsermediaFeed)||void 0===ei?void 0:ei.stream}get localScreensharingStream(){var ei;return null===(ei=this.localScreensharingFeed)||void 0===ei?void 0:ei.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(ei=>ei.purpose===ey.SDPStreamMetadataPurpose.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(ei=>ei.purpose===ey.SDPStreamMetadataPurpose.Screenshare)}get remoteUsermediaStream(){var ei;return null===(ei=this.remoteUsermediaFeed)||void 0===ei?void 0:ei.stream}get remoteScreensharingStream(){var ei;return null===(ei=this.remoteScreensharingFeed)||void 0===ei?void 0:ei.stream}getFeedByStreamId(ei){return this.getFeeds().find(eo=>eo.stream.id===ei)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(ei=>ei.isLocal())}getRemoteFeeds(){return this.feeds.filter(ei=>!ei.isLocal())}async initOpponentCrypto(){var ei,eo;if(!this.opponentDeviceId||!this.client.getUseE2eForGroupCall())return;if(!this.client.isCryptoEnabled()){this.opponentDeviceInfo=new eE.DeviceInfo(this.opponentDeviceId);return}if(!this.client.crypto)throw Error("Crypto is not initialised.");let ea=this.invitee||(null===(ei=this.getOpponentMember())||void 0===ei?void 0:ei.userId);if(!ea)throw Error("Couldn't find opponent user ID to init crypto");let ec=await this.client.crypto.deviceList.downloadKeys([ea],!1);if(this.opponentDeviceInfo=null===(eo=ec.get(ea))||void 0===eo?void 0:eo.get(this.opponentDeviceId),void 0===this.opponentDeviceInfo)throw new ew.GroupCallUnknownDeviceError(ea)}getLocalSDPStreamMetadata(ei=!1){let eo={};for(let ea of this.getLocalFeeds())ei&&(ea.sdpMetadataStreamId=ea.stream.id),eo[ea.sdpMetadataStreamId]={purpose:ea.purpose,audio_muted:ea.isAudioMuted(),video_muted:ea.isVideoMuted()};return eo}noIncomingFeeds(){return!this.feeds.some(ei=>!ei.isLocal())}pushRemoteFeed(ei){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(ei);return}let eo=this.getOpponentMember().userId,ea=this.remoteSDPStreamMetadata[ei.id].purpose,ec=this.remoteSDPStreamMetadata[ei.id].audio_muted,ed=this.remoteSDPStreamMetadata[ei.id].video_muted;if(!ea){ef.logger.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=${ei.id})`);return}if(this.getFeedByStreamId(ei.id)){ef.logger.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=${ei.id})`);return}this.feeds.push(new eb.CallFeed({client:this.client,call:this,roomId:this.roomId,userId:eo,deviceId:this.getOpponentDeviceId(),stream:ei,purpose:ea,audioMuted:ec,videoMuted:ed})),this.emit(ej.FeedsChanged,this.feeds,this),ef.logger.info(`Call ${this.callId} pushRemoteFeed() pushed stream (streamId=${ei.id}, active=${ei.active}, purpose=${ea})`)}pushRemoteFeedWithoutMetadata(ei){var eo;let ea=this.getOpponentMember().userId,ec=ey.SDPStreamMetadataPurpose.Usermedia,ed=null===(eo=this.feeds.find(ei=>!ei.isLocal()))||void 0===eo?void 0:eo.stream;if(ed&&ei.id!==ed.id){ef.logger.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=${ei.id})`);return}if(this.getFeedByStreamId(ei.id)){ef.logger.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=${ei.id})`);return}this.feeds.push(new eb.CallFeed({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:ea,deviceId:this.getOpponentDeviceId(),stream:ei,purpose:ec})),this.emit(ej.FeedsChanged,this.feeds,this),ef.logger.info(`Call ${this.callId} pushRemoteFeedWithoutMetadata() pushed stream (streamId=${ei.id}, active=${ei.active})`)}pushNewLocalFeed(ei,eo,ea=!0){let ec=this.client.getUserId();if(ez(ei.getAudioTracks(),!0),ez(ei.getVideoTracks(),!0),this.getFeedByStreamId(ei.id)){ef.logger.warn(`Call ${this.callId} pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=${ei.id})`);return}this.pushLocalFeed(new eb.CallFeed({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:ec,deviceId:this.getOpponentDeviceId(),stream:ei,purpose:eo}),ea)}pushLocalFeed(ei,eo=!0){if(this.feeds.some(eo=>ei.stream.id===eo.stream.id)){ef.logger.info(`Call ${this.callId} pushLocalFeed() ignoring duplicate local stream (streamId=${ei.stream.id})`);return}if(this.feeds.push(ei),eo)for(let eo of ei.stream.getTracks()){ef.logger.info(`Call ${this.callId} pushLocalFeed() adding track to peer connection (id=${eo.id}, kind=${eo.kind}, streamId=${ei.stream.id}, streamPurpose=${ei.purpose}, enabled=${eo.enabled})`);let ea=eG(ei.purpose,eo.kind);if(this.transceivers.has(ea)){let ei=this.transceivers.get(ea);ei.sender.replaceTrack(eo),ei.direction="inactive"===ei.direction?"sendonly":"sendrecv"}else{let ec=this.peerConn.addTrack(eo,ei.stream),ed=this.peerConn.getTransceivers().find(ei=>ei.sender===ec);ed?this.transceivers.set(ea,ed):ef.logger.warn(`Call ${this.callId} pushLocalFeed() didn't find a matching transceiver after adding track!`)}}ef.logger.info(`Call ${this.callId} pushLocalFeed() pushed stream (id=${ei.stream.id}, active=${ei.stream.active}, purpose=${ei.purpose})`),this.emit(ej.FeedsChanged,this.feeds,this)}removeLocalFeed(ei){let eo=eG(ei.purpose,"audio"),ea=eG(ei.purpose,"video");for(let ei of[eo,ea])if(this.transceivers.has(ei)){let eo=this.transceivers.get(ei);eo.sender&&this.peerConn.removeTrack(eo.sender)}ei.purpose===ey.SDPStreamMetadataPurpose.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(ei.stream),this.deleteFeed(ei)}deleteAllFeeds(){for(let ei of this.feeds)ei.isLocal()&&this.groupCallId||ei.dispose();this.feeds=[],this.emit(ej.FeedsChanged,this.feeds,this)}deleteFeedByStream(ei){let eo=this.getFeedByStreamId(ei.id);if(!eo){ef.logger.warn(`Call ${this.callId} deleteFeedByStream() didn't find the feed to delete (streamId=${ei.id})`);return}this.deleteFeed(eo)}deleteFeed(ei){ei.dispose(),this.feeds.splice(this.feeds.indexOf(ei),1),this.emit(ej.FeedsChanged,this.feeds,this)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;let ei=await this.peerConn.getStats(),eo=[];return ei.forEach(ei=>{eo.push(ei)}),eo}async initWithInvite(ei){var eo;let ea=ei.getContent();this.direction=eA.Inbound;let ec=await this.client.checkTurnServers();ec||ef.logger.warn(`Call ${this.callId} initWithInvite() failed to get TURN credentials! Proceeding with call anyway...`);let ed=ea[ey.SDPStreamMetadataKey];ed?this.updateRemoteSDPStreamMetadata(ed):ef.logger.debug(`Call ${this.callId} initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams`),this.peerConn=this.createPeerConnection(),this.emit(ej.PeerConnectionCreated,this.peerConn,this),this.chooseOpponent(ei),await this.initOpponentCrypto();try{await this.peerConn.setRemoteDescription(ea.offer),await this.addBufferedIceCandidates()}catch(ei){ef.logger.debug(`Call ${this.callId} initWithInvite() failed to set remote description`,ei),this.terminate(eD.Local,eL.SetRemoteDescription,!1);return}let eu=null===(eo=this.feeds.find(ei=>!ei.isLocal()))||void 0===eo?void 0:eo.stream;if(!this.isOnlyDataChannelAllowed&&(!eu||0===eu.getTracks().length)){ef.logger.error(`Call ${this.callId} initWithInvite() no remote stream or no tracks after setting remote description!`),this.terminate(eD.Local,eL.SetRemoteDescription,!1);return}if(this.state=eM.Ringing,ei.getLocalAge()){let eo=setTimeout(()=>{if(this.state==eM.Ringing){var ei;ef.logger.debug(`Call ${this.callId} initWithInvite() invite has expired. Hanging up.`),this.hangupParty=eD.Remote,this.state=eM.Ended,this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),null===(ei=this.stats)||void 0===ei||ei.removeStatsReportGatherer(this.callId),this.emit(ej.Hangup,this)}},ea.lifetime-ei.getLocalAge()),ec=ei=>{ei!==eM.Ringing&&(clearTimeout(eo),this.off(ej.State,ec))};this.on(ej.State,ec)}}initWithHangup(ei){this.state=eM.Ended}shouldAnswerWithMediaType(ei,eo,ea){return ei&&!eo?(ef.logger.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${ea} because the other side isn't sending it either.`),!1):ep.isNullOrUndefined(ei)||ei===eo||this.opponentSupportsSDPStreamMetadata()?null!=ei?ei:eo:(ef.logger.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${ea}=${ei} because the other side doesn't support it. Answering with ${ea}=${eo}.`),eo)}async answer(ei,eo){if(!this.inviteOrAnswerSent){if(!1===ei&&!1===eo)throw Error("You CANNOT answer a call without media");if(this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&(this.state=eM.WaitLocalMedia);else{let ec=this.state,ed=this.shouldAnswerWithMediaType(ei,this.hasRemoteUserMediaAudioTrack,"audio"),eu=this.shouldAnswerWithMediaType(eo,this.hasRemoteUserMediaVideoTrack,"video");this.state=eM.WaitLocalMedia,this.waitForLocalAVStream=!0;try{var ea;let ei=await this.client.getMediaHandler().getUserMediaStream(ed,eu);this.waitForLocalAVStream=!1;let eo=new eb.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(ea=this.client.getDeviceId())&&void 0!==ea?ea:void 0,stream:ei,purpose:ey.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1}),ec=[eo];this.localScreensharingFeed&&ec.push(this.localScreensharingFeed),this.answerWithCallFeeds(ec)}catch(ei){if(eu)ef.logger.warn(`Call ${this.callId} answer() failed to getUserMedia(), trying to getUserMedia() without video`),this.state=ec,this.waitForLocalAVStream=!1,await this.answer(ed,!1);else{this.getUserMediaFailed(ei);return}}}}}answerWithCallFeeds(ei){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(ei)}replacedBy(ei){ef.logger.debug(`Call ${this.callId} replacedBy() running (newCallId=${ei.callId})`),this.state===eM.WaitLocalMedia?(ef.logger.debug(`Call ${this.callId} replacedBy() telling new call to wait for local media (newCallId=${ei.callId})`),ei.waitForLocalAVStream=!0):[eM.CreateOffer,eM.InviteSent].includes(this.state)&&(ei.direction===eA.Outbound?ei.queueGotCallFeedsForAnswer([]):(ef.logger.debug(`Call ${this.callId} replacedBy() handing local stream to new call(newCallId=${ei.callId})`),ei.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(ei=>ei.clone())))),this.successor=ei,this.emit(ej.Replaced,ei,this),this.hangup(eL.Replaced,!0)}hangup(ei,eo){if(this.callHasEnded()||(ef.logger.debug(`Call ${this.callId} hangup() ending call (reason=${ei})`),this.terminate(eD.Local,ei,!eo),[eM.Fledgling,eM.WaitLocalMedia].includes(this.state)))return;let ea={};(this.opponentVersion&&0!==this.opponentVersion||ei!==eL.UserHangup)&&(ea.reason=ei),this.sendVoipEvent(eg.EventType.CallHangup,ea)}reject(){if(this.state!==eM.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion){ef.logger.info(`Call ${this.callId} reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=${this.opponentVersion})`),this.hangup(eL.UserHangup,!0);return}ef.logger.debug("Rejecting call: "+this.callId),this.terminate(eD.Local,eL.UserHangup,!0),this.sendVoipEvent(eg.EventType.CallReject,{})}async upgradeCall(ei,eo){if((ei||eo)&&this.opponentSupportsSDPStreamMetadata())try{ef.logger.debug(`Call ${this.callId} upgradeCall() upgrading call (audio=${ei}, video=${eo})`);let ea=ei||this.hasLocalUserMediaAudioTrack,ec=eo||this.hasLocalUserMediaVideoTrack,ed=await this.client.getMediaHandler().getUserMediaStream(ea,ec,!1);await this.updateLocalUsermediaStream(ed,ei,eo)}catch(ei){ef.logger.error(`Call ${this.callId} upgradeCall() failed to upgrade the call`,ei),this.emit(ej.Error,new e$(eL.NoUserMedia,"Failed to get camera access: ",ei),this)}}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}async setScreensharingEnabled(ei,eo){if(ei&&this.isScreensharing())return ef.logger.warn(`Call ${this.callId} setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!`),!0;if(!ei&&!this.isScreensharing())return ef.logger.warn(`Call ${this.callId} setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!`),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(ei,eo);if(ef.logger.debug(`Call ${this.callId} setScreensharingEnabled() running (enabled=${ei})`),ei)try{let ei=await this.client.getMediaHandler().getScreensharingStream(eo);if(!ei)return!1;return this.pushNewLocalFeed(ei,ey.SDPStreamMetadataPurpose.Screenshare),!0}catch(ei){return ef.logger.error(`Call ${this.callId} setScreensharingEnabled() failed to get screen-sharing stream:`,ei),!1}else{let ei=this.transceivers.get(eG(ey.SDPStreamMetadataPurpose.Screenshare,"audio")),eo=this.transceivers.get(eG(ey.SDPStreamMetadataPurpose.Screenshare,"video"));for(let ea of[ei,eo])ea&&ea.sender&&this.peerConn.removeTrack(ea.sender);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}}async setScreensharingEnabledWithoutMetadataSupport(ei,eo){var ea,ec,ed;if(ef.logger.debug(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() running (enabled=${ei})`),ei)try{let ei=await this.client.getMediaHandler().getScreensharingStream(eo);if(!ei)return!1;let ec=ei.getTracks().find(ei=>"video"===ei.kind),ed=null===(ea=this.transceivers.get(eG(ey.SDPStreamMetadataPurpose.Usermedia,"video")))||void 0===ea?void 0:ea.sender;return null==ed||ed.replaceTrack(null!=ec?ec:null),this.pushNewLocalFeed(ei,ey.SDPStreamMetadataPurpose.Screenshare,!1),!0}catch(ei){return ef.logger.error(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:`,ei),!1}else{let ei=null===(ec=this.localUsermediaStream)||void 0===ec?void 0:ec.getTracks().find(ei=>"video"===ei.kind),eo=null===(ed=this.transceivers.get(eG(ey.SDPStreamMetadataPurpose.Usermedia,"video")))||void 0===ed?void 0:ed.sender;return null==eo||eo.replaceTrack(null!=ei?ei:null),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}}async updateLocalUsermediaStream(ei,eo=!1,ea=!1){let ec=this.localUsermediaFeed,ed=eo||!ec.isAudioMuted()&&!this.remoteOnHold,eu=ea||!ec.isVideoMuted()&&!this.remoteOnHold;for(let eo of(ef.logger.log(`Call ${this.callId} updateLocalUsermediaStream() running (streamId=${ei.id}, audio=${ed}, video=${eu})`),ez(ei.getAudioTracks(),ed),ez(ei.getVideoTracks(),eu),this.localUsermediaStream.getTracks()))this.localUsermediaStream.removeTrack(eo),eo.stop();for(let eo of ei.getTracks())this.localUsermediaStream.addTrack(eo);for(let eo of ei.getTracks()){let ea=eG(ey.SDPStreamMetadataPurpose.Usermedia,eo.kind),ed=this.transceivers.get(ea),eu=null==ed?void 0:ed.sender,eh=!1;if(eu)try{ef.logger.info(`Call ${this.callId} updateLocalUsermediaStream() replacing track (id=${eo.id}, kind=${eo.kind}, streamId=${ei.id}, streamPurpose=${ec.purpose})`),await eu.replaceTrack(eo),ed.direction="inactive"===ed.direction?"sendonly":"sendrecv",eh=!0}catch(ei){ef.logger.warn(`Call ${this.callId} updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead`,ei)}if(!eh){ef.logger.info(`Call ${this.callId} updateLocalUsermediaStream() adding track to peer connection (id=${eo.id}, kind=${eo.kind}, streamId=${ei.id}, streamPurpose=${ec.purpose})`);let ed=this.peerConn.addTrack(eo,this.localUsermediaStream),eu=this.peerConn.getTransceivers().find(ei=>ei.sender===ed);eu?this.transceivers.set(ea,eu):ef.logger.warn(`Call ${this.callId} updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!`)}}}async setLocalVideoMuted(ei){var eo,ea;if(ef.logger.log(`Call ${this.callId} setLocalVideoMuted() running ${ei}`),ei||void 0===this.stopVideoTrackTimer||(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),!await this.client.getMediaHandler().hasVideoDevice())return this.isLocalVideoMuted();if(!this.hasUserMediaVideoSender&&!ei)return null===(ea=this.localUsermediaFeed)||void 0===ea||ea.setAudioVideoMuted(null,ei),await this.upgradeCall(!1,!0),this.isLocalVideoMuted();if(!ei&&0===this.localUsermediaStream.getVideoTracks().length){let ei=await this.client.getMediaHandler().getUserMediaStream(!0,!0);await this.updateLocalUsermediaStream(ei)}return null===(eo=this.localUsermediaFeed)||void 0===eo||eo.setAudioVideoMuted(null,ei),this.updateMuteStatus(),await this.sendMetadataUpdate(),ei&&(this.stopVideoTrackTimer=setTimeout(()=>{for(let ei of this.localUsermediaStream.getVideoTracks())ei.stop(),this.localUsermediaStream.removeTrack(ei)},120)),this.isLocalVideoMuted()}isLocalVideoMuted(){var ei,eo;return null!==(ei=null===(eo=this.localUsermediaFeed)||void 0===eo?void 0:eo.isVideoMuted())&&void 0!==ei&&ei}async setMicrophoneMuted(ei){var eo;return(ef.logger.log(`Call ${this.callId} setMicrophoneMuted() running ${ei}`),await this.client.getMediaHandler().hasAudioDevice())?ei||this.hasUserMediaAudioSender&&this.hasLocalUserMediaAudioTrack?(null===(eo=this.localUsermediaFeed)||void 0===eo||eo.setAudioVideoMuted(ei,null),this.updateMuteStatus(),await this.sendMetadataUpdate(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var ei,eo;return null!==(ei=null===(eo=this.localUsermediaFeed)||void 0===eo?void 0:eo.isAudioMuted())&&void 0!==ei&&ei}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(ei){if(this.isRemoteOnHold()!==ei){for(let eo of(this.remoteOnHold=ei,this.peerConn.getTransceivers()))eo.direction=ei?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(ej.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==eM.Connected)return!1;let ei=!0;for(let eo of this.peerConn.getTransceivers()){let ea=["inactive","recvonly"].includes(eo.currentDirection);ea||(ei=!1)}return ei}sendDtmfDigit(ei){for(let ea of this.peerConn.getSenders()){var eo;if((null===(eo=ea.track)||void 0===eo?void 0:eo.kind)==="audio"&&ea.dtmf){ea.dtmf.insertDTMF(ei);return}}throw Error("Unable to find a track to send DTMF on")}updateMuteStatus(){let ei=this.isMicrophoneMuted()||this.remoteOnHold,eo=this.isLocalVideoMuted()||this.remoteOnHold;ef.logger.log(`Call ${this.callId} updateMuteStatus stream ${this.localUsermediaStream.id} micShouldBeMuted ${ei} vidShouldBeMuted ${eo}`),ez(this.localUsermediaStream.getAudioTracks(),!ei),ez(this.localUsermediaStream.getVideoTracks(),!eo)}async sendMetadataUpdate(){await this.sendVoipEvent(eg.EventType.CallSDPStreamMetadataChangedPrefix,{[ey.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()})}gotCallFeedsForInvite(ei,eo=!1){if(this.successor){this.successor.queueGotCallFeedsForAnswer(ei);return}if(this.callHasEnded()){this.stopAllMedia();return}for(let eo of ei)this.pushLocalFeed(eo);eo&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=eM.CreateOffer,ef.logger.debug(`Call ${this.callId} gotUserMediaForInvite() run`)}async sendAnswer(){let ei={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[ey.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata(!0)};ei.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1};let eo=this.discardDuplicateCandidates();ef.logger.info(`Call ${this.callId} sendAnswer() discarding ${eo} candidates that will be sent in answer`);try{await this.sendVoipEvent(eg.EventType.CallAnswer,ei),this.inviteOrAnswerSent=!0}catch(ea){this.state=eM.Ringing,ea instanceof e_.MatrixError&&ea.event&&this.client.cancelPendingEvent(ea.event);let ei=eL.SendAnswer,eo="Failed to send answer";throw"UnknownDeviceError"==ea.name&&(ei=eL.UnknownDevices,eo="Unknown devices present in the room"),this.emit(ej.Error,new e$(ei,eo,ea),this),ea}this.sendCandidateQueue()}queueGotCallFeedsForAnswer(ei){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(ei)):this.responsePromiseChain=this.gotCallFeedsForAnswer(ei)}mungeSdp(ei,eo){let ea=(0,eh.parse)(ei.sdp);ea.media.forEach(ei=>{let ea=new Map,ec=new Map;for(let eo of ei.rtp)ea.set(eo.payload,eo.codec),ec.set(eo.codec,eo.payload);for(let ed of eo){if(ed.mediaType!==ei.type)continue;if(!ec.has(ed.codec)){ef.logger.info(`Call ${this.callId} mungeSdp() ignoring SDP modifications for ${ed.codec} as it's not present.`);continue}let eo=[];void 0!==ed.enableDtx&&eo.push(`usedtx=${ed.enableDtx?"1":"0"}`),void 0!==ed.maxAverageBitrate&&eo.push(`maxaveragebitrate=${ed.maxAverageBitrate}`);let eu=!1;for(let ec of ei.fmtp)ea.get(ec.payload)===ed.codec&&(eu=!0,ec.config+=";"+eo.join(";"));eu||ei.fmtp.push({payload:ec.get(ed.codec),config:eo.join(";")})}}),ei.sdp=(0,eh.write)(ea)}async createOffer(){let ei=await this.peerConn.createOffer();return this.mungeSdp(ei,eV(this.isPtt)),ei}async createAnswer(){let ei=await this.peerConn.createAnswer();return this.mungeSdp(ei,eV(this.isPtt)),ei}async gotCallFeedsForAnswer(ei){let eo;if(!this.callHasEnded()){for(let eo of(this.waitForLocalAVStream=!1,ei))this.pushLocalFeed(eo);this.state=eM.CreateAnswer;try{this.getRidOfRTXCodecs(),eo=await this.createAnswer()}catch(ei){ef.logger.debug(`Call ${this.callId} gotCallFeedsForAnswer() failed to create answer: `,ei),this.terminate(eD.Local,eL.CreateAnswer,!0);return}try{if(await this.peerConn.setLocalDescription(eo),this.callHasEnded()||(this.state=eM.Connecting,await new Promise(ei=>{setTimeout(ei,200)}),this.callHasEnded()))return;this.sendAnswer()}catch(ei){ef.logger.debug(`Call ${this.callId} gotCallFeedsForAnswer() error setting local description!`,ei),this.terminate(eD.Local,eL.SetLocalDescription,!0);return}}}async onRemoteIceCandidatesReceived(ei){if(this.callHasEnded())return;let eo=ei.getContent(),ea=eo.candidates;if(!ea){ef.logger.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!`);return}let ec=0===eo.version?null:eo.party_id||null;if(void 0===this.opponentPartyId){if(ec){ef.logger.info(`Call ${this.callId} onRemoteIceCandidatesReceived() buffering ${ea.length} candidates until we pick an opponent`);let ei=this.remoteCandidateBuffer.get(ec)||[];ei.push(...ea),this.remoteCandidateBuffer.set(ec,ei)}return}if(!this.partyIdMatches(eo)){ef.logger.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates from party ID ${eo.party_id}: we have chosen party ID ${this.opponentPartyId}`);return}await this.addIceCandidates(ea)}async onAnswerReceived(ei){let eo=ei.getContent();if(ef.logger.debug(`Call ${this.callId} onAnswerReceived() running (hangupParty=${eo.party_id})`),this.callHasEnded()){ef.logger.debug(`Call ${this.callId} onAnswerReceived() ignoring answer because call has ended`);return}if(void 0!==this.opponentPartyId){ef.logger.info(`Call ${this.callId} onAnswerReceived() ignoring answer from party ID ${eo.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);return}this.chooseOpponent(ei),await this.addBufferedIceCandidates(),this.state=eM.Connecting;let ea=eo[ey.SDPStreamMetadataKey];ea?this.updateRemoteSDPStreamMetadata(ea):ef.logger.warn(`Call ${this.callId} onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams`);try{await this.peerConn.setRemoteDescription(eo.answer)}catch(ei){ef.logger.debug(`Call ${this.callId} onAnswerReceived() failed to set remote description`,ei),this.terminate(eD.Local,eL.SetRemoteDescription,!1);return}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(eg.EventType.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(ei){ef.logger.warn(`Call ${this.callId} onAnswerReceived() failed to send select_answer event`,ei)}}async onSelectAnswerReceived(ei){if(this.direction!==eA.Inbound){ef.logger.warn(`Call ${this.callId} onSelectAnswerReceived() got select_answer for an outbound call: ignoring`);return}let eo=ei.getContent().selected_party_id;if(null==eo){ef.logger.warn(`Call ${this.callId} onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring`);return}eo!==this.ourPartyId&&(ef.logger.info(`Call ${this.callId} onSelectAnswerReceived() got select_answer for party ID ${eo}: we are party ID ${this.ourPartyId}.`),await this.terminate(eD.Remote,eL.AnsweredElsewhere,!0))}async onNegotiateReceived(ei){let eo=ei.getContent(),ea=eo.description;if(!ea||!ea.sdp||!ea.type){ef.logger.info(`Call ${this.callId} onNegotiateReceived() ignoring invalid m.call.negotiate event`);return}let ec=this.direction===eA.Inbound,ed="offer"===ea.type&&(this.makingOffer||"stable"!==this.peerConn.signalingState);if(this.ignoreOffer=!ec&&ed,this.ignoreOffer){ef.logger.info(`Call ${this.callId} onNegotiateReceived() ignoring colliding negotiate event because we're impolite`);return}let eu=this.isLocalOnHold(),eh=eo[ey.SDPStreamMetadataKey];eh?this.updateRemoteSDPStreamMetadata(eh):ef.logger.warn(`Call ${this.callId} onNegotiateReceived() received negotiation event without SDPStreamMetadata!`);try{if(await this.peerConn.setRemoteDescription(ea),"offer"===ea.type){var ep;let ei;try{this.getRidOfRTXCodecs(),ei=await this.createAnswer()}catch(ei){ef.logger.debug(`Call ${this.callId} onNegotiateReceived() failed to create answer: `,ei),this.terminate(eD.Local,eL.CreateAnswer,!0);return}await this.peerConn.setLocalDescription(ei),this.sendVoipEvent(eg.EventType.CallNegotiate,{description:null===(ep=this.peerConn.localDescription)||void 0===ep?void 0:ep.toJSON(),[ey.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata(!0)})}}catch(ei){ef.logger.warn(`Call ${this.callId} onNegotiateReceived() failed to complete negotiation`,ei)}let em=this.isLocalOnHold();eu!==em&&(this.emit(ej.LocalHoldUnhold,em,this),this.emit(ej.HoldUnhold,em))}updateRemoteSDPStreamMetadata(ei){for(let ea of(this.remoteSDPStreamMetadata=ep.recursivelyAssign(this.remoteSDPStreamMetadata||{},ei,!0),this.getRemoteFeeds())){var eo;let ei=ea.stream.id,ec=this.remoteSDPStreamMetadata[ei];ea.setAudioVideoMuted(null==ec?void 0:ec.audio_muted,null==ec?void 0:ec.video_muted),ea.purpose=null===(eo=this.remoteSDPStreamMetadata[ei])||void 0===eo?void 0:eo.purpose}}onSDPStreamMetadataChangedReceived(ei){let eo=ei.getContent(),ea=eo[ey.SDPStreamMetadataKey];this.updateRemoteSDPStreamMetadata(ea)}async onAssertedIdentityReceived(ei){let eo=ei.getContent();eo.asserted_identity&&(this.remoteAssertedIdentity={id:eo.asserted_identity.id,displayName:eo.asserted_identity.display_name},this.emit(ej.AssertedIdentityChanged,this))}callHasEnded(){return this.state===eM.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}async wrappedGotLocalOffer(){this.makingOffer=!0;try{await this.gotLocalOffer()}catch(ei){this.getLocalOfferFailed(ei);return}finally{this.makingOffer=!1}}async gotLocalOffer(){var ei,eo;let ea;if(ef.logger.debug(`Call ${this.callId} gotLocalOffer() running`),this.callHasEnded()){ef.logger.debug(`Call ${this.callId} gotLocalOffer() ignoring newly created offer because the call has ended"`);return}try{this.getRidOfRTXCodecs(),ea=await this.createOffer()}catch(ei){ef.logger.debug(`Call ${this.callId} gotLocalOffer() failed to create offer: `,ei),this.terminate(eD.Local,eL.CreateOffer,!0);return}try{await this.peerConn.setLocalDescription(ea)}catch(ei){ef.logger.debug(`Call ${this.callId} gotLocalOffer() error setting local description!`,ei),this.terminate(eD.Local,eL.SetLocalDescription,!0);return}if("gathering"===this.peerConn.iceGatheringState&&await new Promise(ei=>{setTimeout(ei,200)}),this.callHasEnded())return;let ec=this.state===eM.CreateOffer?eg.EventType.CallInvite:eg.EventType.CallNegotiate,ed={lifetime:eB};ec===eg.EventType.CallInvite&&this.invitee&&(ed.invitee=this.invitee),this.state===eM.CreateOffer?ed.offer=null===(ei=this.peerConn.localDescription)||void 0===ei?void 0:ei.toJSON():ed.description=null===(eo=this.peerConn.localDescription)||void 0===eo?void 0:eo.toJSON(),ed.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},ed[ey.SDPStreamMetadataKey]=this.getLocalSDPStreamMetadata(!0);let eu=this.discardDuplicateCandidates();ef.logger.info(`Call ${this.callId} gotLocalOffer() discarding ${eu} candidates that will be sent in offer`);try{await this.sendVoipEvent(ec,ed)}catch(ea){ef.logger.error(`Call ${this.callId} gotLocalOffer() failed to send invite`,ea),ea instanceof e_.MatrixError&&ea.event&&this.client.cancelPendingEvent(ea.event);let ei=eL.SignallingFailed,eo="Signalling failed";this.state===eM.CreateOffer&&(ei=eL.SendInvite,eo="Failed to send invite"),"UnknownDeviceError"==ea.name&&(ei=eL.UnknownDevices,eo="Unknown devices present in the room"),this.emit(ej.Error,new e$(ei,eo,ea),this),this.terminate(eD.Local,ei,!1);return}this.sendCandidateQueue(),this.state===eM.CreateOffer&&(this.inviteOrAnswerSent=!0,this.state=eM.InviteSent,this.inviteTimeout=setTimeout(()=>{this.inviteTimeout=void 0,this.state===eM.InviteSent&&this.hangup(eL.InviteTimeout,!1)},eB))}getRidOfRTXCodecs(){var ei;if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;let eo=RTCRtpReceiver.getCapabilities("video").codecs,ea=RTCRtpSender.getCapabilities("video").codecs,ec=[...ea,...eo];for(let ei of ec)if("video/rtx"===ei.mimeType){let eo=ec.indexOf(ei);ec.splice(eo,1)}let ed=this.transceivers.get(eG(ey.SDPStreamMetadataPurpose.Screenshare,"video"));null==ed||null===(ei=ed.setCodecPreferences)||void 0===ei||ei.call(ed,ec)}async sendVoipEvent(ei,eo){var ea,ec;let ed=Object.assign({},eo,{version:eN,call_id:this.callId,party_id:this.ourPartyId,conf_id:this.groupCallId});if(this.opponentDeviceId){let eo=this.toDeviceSeq++,ec=eO(eO({},ed),{},{device_id:this.client.deviceId,sender_session_id:this.client.getSessionId(),dest_session_id:this.opponentSessionId,seq:eo,[eg.ToDeviceMessageId]:(0,eu.v4)()});this.emit(ej.SendVoipEvent,{type:"toDevice",eventType:ei,userId:this.invitee||(null===(ea=this.getOpponentMember())||void 0===ea?void 0:ea.userId),opponentDeviceId:this.opponentDeviceId,content:ec},this);let eh=this.invitee||this.getOpponentMember().userId;if(this.client.getUseE2eForGroupCall()){if(!this.opponentDeviceInfo){ef.logger.warn(`Call ${this.callId} sendVoipEvent() failed: we do not have opponentDeviceInfo`);return}await this.client.encryptAndSendToDevices([{userId:eh,deviceInfo:this.opponentDeviceInfo}],{type:ei,content:ec})}else await this.client.sendToDevice(ei,new Map([[eh,new Map([[this.opponentDeviceId,ec]])]]))}else this.emit(ej.SendVoipEvent,{type:"sendEvent",eventType:ei,roomId:this.roomId,content:ed,userId:this.invitee||(null===(ec=this.getOpponentMember())||void 0===ec?void 0:ec.userId)},this),await this.client.sendEvent(this.roomId,ei,ed)}queueCandidate(ei){if(ei?this.candidateSendQueue.push(ei):this.candidatesEnded=!0,this.state===eM.Ringing||!this.inviteOrAnswerSent)return;let eo=this.direction===eA.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout(()=>{this.sendCandidateQueue()},eo)}discardDuplicateCandidates(){let ei=0,eo=[];for(let ea=0;ea<this.candidateSendQueue.length;ea++){let ec=this.candidateSendQueue[ea];""===ec.candidate?eo.push(ec):ei++}return this.candidateSendQueue=eo,ei}async transfer(ei){let eo=await this.client.getProfileInfo(ei),ea=eW(),ec={replacement_id:eW(),target_user:{id:ei,display_name:eo.displayname,avatar_url:eo.avatar_url},create_call:ea};await this.sendVoipEvent(eg.EventType.CallReplaces,ec),await this.terminate(eD.Local,eL.Transferred,!0)}async transferToCall(ei){var eo,ea;let ec=null===(eo=ei.getOpponentMember())||void 0===eo?void 0:eo.userId,ed=ec?await this.client.getProfileInfo(ec):void 0,eu=null===(ea=this.getOpponentMember())||void 0===ea?void 0:ea.userId,eh=eu?await this.client.getProfileInfo(eu):void 0,ef=eW(),ep={replacement_id:eW(),target_user:{id:eu,display_name:null==eh?void 0:eh.displayname,avatar_url:null==eh?void 0:eh.avatar_url},await_call:ef};await ei.sendVoipEvent(eg.EventType.CallReplaces,ep);let em={replacement_id:eW(),target_user:{id:ec,display_name:null==ed?void 0:ed.displayname,avatar_url:null==ed?void 0:ed.avatar_url},create_call:ef};await this.sendVoipEvent(eg.EventType.CallReplaces,em),await this.terminate(eD.Local,eL.Transferred,!0),await ei.terminate(eD.Local,eL.Transferred,!0)}async terminate(ei,eo,ea){var ec;if(!this.callHasEnded()){for(let[ea,ec]of(this.hangupParty=ei,this.hangupReason=eo,this.state=eM.Ended,this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=void 0),void 0!==this.iceDisconnectedTimeout&&(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=void 0),void 0!==this.stopVideoTrackTimer&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),this.removeTrackListeners))ea.removeEventListener("removetrack",ec);this.removeTrackListeners.clear(),this.callStatsAtEnd=await this.collectCallStats(),this.stopAllMedia(),this.deleteAllFeeds(),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),null===(ec=this.stats)||void 0===ec||ec.removeStatsReportGatherer(this.callId),ea&&this.emit(ej.Hangup,this),this.client.callEventHandler.calls.delete(this.callId)}}stopAllMedia(){for(let ei of(ef.logger.debug(`Call ${this.callId} stopAllMedia() running`),this.feeds))if(ei.isLocal()&&ei.purpose===ey.SDPStreamMetadataPurpose.Usermedia)this.client.getMediaHandler().stopUserMediaStream(ei.stream);else if(ei.isLocal()&&ei.purpose===ey.SDPStreamMetadataPurpose.Screenshare)this.client.getMediaHandler().stopScreensharingStream(ei.stream);else if(!ei.isLocal())for(let eo of(ef.logger.debug(`Call ${this.callId} stopAllMedia() stopping stream (streamId=${ei.stream.id})`),ei.stream.getTracks()))eo.stop()}checkForErrorListener(){if(0===this.listeners(eS.EventEmitterEvents.Error).length)throw Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length||this.callHasEnded())return;let ei=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;let eo={candidates:ei.map(ei=>ei.toJSON())};this.candidatesEnded&&eo.candidates.push({candidate:""}),ef.logger.debug(`Call ${this.callId} sendCandidateQueue() attempting to send ${ei.length} candidates`);try{await this.sendVoipEvent(eg.EventType.CallCandidates,eo),this.candidateSendTries=0,this.sendCandidateQueue()}catch(ea){if(ea instanceof e_.MatrixError&&ea.event&&this.client.cancelPendingEvent(ea.event),this.candidateSendQueue.push(...ei),this.candidateSendTries>5){ef.logger.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates on attempt ${this.candidateSendTries}. Giving up on this call.`,ea);let ei=eL.SignallingFailed,eo="Signalling failed";this.emit(ej.Error,new e$(ei,eo,ea),this),this.hangup(ei,!1);return}let eo=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,ef.logger.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates. Retrying in ${eo}ms`,ea),setTimeout(()=>{this.sendCandidateQueue()},eo)}}async placeCall(ei,eo){if(!ei)throw Error("You CANNOT start a call without audio");this.state=eM.WaitLocalMedia;try{var ea;let ec=await this.client.getMediaHandler().getUserMediaStream(ei,eo);ez(ec.getAudioTracks(),!0),ez(ec.getVideoTracks(),!0);let ed=new eb.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(ea=this.client.getDeviceId())&&void 0!==ea?ea:void 0,stream:ec,purpose:ey.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1});await this.placeCallWithCallFeeds([ed])}catch(ei){this.getUserMediaFailed(ei);return}}async placeCallWithCallFeeds(ei,eo=!1){this.checkForErrorListener(),this.direction=eA.Outbound,await this.initOpponentCrypto(),this.client.callEventHandler.calls.set(this.callId,this);let ea=await this.client.checkTurnServers();ea||ef.logger.warn(`Call ${this.callId} placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...`),this.peerConn=this.createPeerConnection(),this.emit(ej.PeerConnectionCreated,this.peerConn,this),this.gotCallFeedsForInvite(ei,eo)}createPeerConnection(){var ei;let eo=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});return eo.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),eo.addEventListener("signalingstatechange",this.onSignallingStateChanged),eo.addEventListener("icecandidate",this.gotLocalIceCandidate),eo.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),eo.addEventListener("track",this.onTrack),eo.addEventListener("negotiationneeded",this.onNegotiationNeeded),eo.addEventListener("datachannel",this.onDataChannel),null===(ei=this.stats)||void 0===ei||ei.addStatsReportGatherer(this.callId,"unknown",eo),eo}partyIdMatches(ei){let eo=0===ei.version?null:ei.party_id||null;return eo===this.opponentPartyId}chooseOpponent(ei){var eo;let ea=ei.getContent();ef.logger.debug(`Call ${this.callId} chooseOpponent() running (partyId=${ea.party_id})`),this.opponentVersion=ea.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=ea.party_id||null,this.opponentCaps=ea.capabilities||{},this.opponentMember=null!==(eo=this.client.getRoom(this.roomId).getMember(ei.getSender()))&&void 0!==eo?eo:void 0}async addBufferedIceCandidates(){let ei=this.remoteCandidateBuffer.get(this.opponentPartyId);ei&&(ef.logger.info(`Call ${this.callId} addBufferedIceCandidates() adding ${ei.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(ei)),this.remoteCandidateBuffer.clear()}async addIceCandidates(ei){for(let eo of ei){(null===eo.sdpMid||void 0===eo.sdpMid)&&(null===eo.sdpMLineIndex||void 0===eo.sdpMLineIndex)?ef.logger.debug(`Call ${this.callId} addIceCandidates() got remote ICE end-of-candidates`):ef.logger.debug(`Call ${this.callId} addIceCandidates() got remote ICE candidate (sdpMid=${eo.sdpMid}, candidate=${eo.candidate})`);try{await this.peerConn.addIceCandidate(eo)}catch(ei){this.ignoreOffer||ef.logger.info(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate`,ei)}}}get hasPeerConnection(){return!!this.peerConn}initStats(ei,eo="unknown"){this.stats=ei,this.stats.start()}}function ez(ei,eo){for(let ea of ei)ea.enabled=eo}function eY(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{let ei=!!(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices);if(!ei)return ef.logger.error("WebRTC is not supported in this browser / environment"),!1}catch(ei){return ef.logger.error("Exception thrown when trying to access WebRTC",ei),!1}return!0}function eJ(ei,eo,ea){if(!eY())return null;let ec=!!ea&&ea.forceTURN,ed={client:ei,roomId:eo,invitee:null==ea?void 0:ea.invitee,turnServers:ei.getTurnServers(),forceTURN:ei.forceTURN||ec,opponentDeviceId:null==ea?void 0:ea.opponentDeviceId,opponentSessionId:null==ea?void 0:ea.opponentSessionId,groupCallId:null==ea?void 0:ea.groupCallId},eu=new eH(ed);return ei.reEmitter.reEmit(eu,Object.values(ej)),eu}eo.MatrixCall=eH},2931:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.CallEventHandlerEvent=eo.CallEventHandler=void 0;var ed=ec(ea(8416)),eu=ea(7434),eh=ea(9679),ef=ea(2481),ep=ea(2168),eg=ea(8969),em=ea(7366);let ey=3e3,eb=function(ei){return ei.Incoming="Call.incoming",ei}({});eo.CallEventHandlerEvent=eb;class eS{constructor(ei){(0,ed.default)(this,"calls",void 0),(0,ed.default)(this,"callEventBuffer",void 0),(0,ed.default)(this,"nextSeqByCall",new Map),(0,ed.default)(this,"toDeviceEventBuffers",new Map),(0,ed.default)(this,"client",void 0),(0,ed.default)(this,"candidateEventsByCall",void 0),(0,ed.default)(this,"eventBufferPromiseChain",void 0),(0,ed.default)(this,"onSync",()=>{let ei=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(ei)):this.eventBufferPromiseChain=this.evaluateEventBuffer(ei)}),(0,ed.default)(this,"onRoomTimeline",ei=>{this.callEventBuffer.push(ei)}),(0,ed.default)(this,"onToDeviceEvent",ei=>{let eo=ei.getContent();if(!eo.call_id||(this.nextSeqByCall.has(eo.call_id)||this.nextSeqByCall.set(eo.call_id,0),void 0===eo.seq)){this.callEventBuffer.push(ei);return}let ea=this.nextSeqByCall.get(eo.call_id)||0;if(eo.seq!==ea){this.toDeviceEventBuffers.has(eo.call_id)||this.toDeviceEventBuffers.set(eo.call_id,[]);let ea=this.toDeviceEventBuffers.get(eo.call_id),ec=ea.findIndex(ei=>ei.getContent().seq>eo.seq);-1===ec?ea.push(ei):ea.splice(ec,0,ei)}else{let ea=eo.call_id;this.callEventBuffer.push(ei),this.nextSeqByCall.set(ea,eo.seq+1);let ec=this.toDeviceEventBuffers.get(ea),ed=ec&&ec.shift();for(;ed&&ed.getContent().seq===this.nextSeqByCall.get(ea);)this.callEventBuffer.push(ed),this.nextSeqByCall.set(ea,ed.getContent().seq+1),ed=ec.shift()}}),this.client=ei,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(ep.ClientEvent.Sync,this.onSync),this.client.on(em.RoomEvent.Timeline,this.onRoomTimeline),this.client.on(ep.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(ep.ClientEvent.Sync,this.onSync),this.client.removeListener(em.RoomEvent.Timeline,this.onRoomTimeline),this.client.removeListener(ep.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)}async evaluateEventBuffer(ei){await Promise.all(ei.map(ei=>this.client.decryptEventIfNeeded(ei)));let eo=ei.filter(ei=>{let eo=ei.getType();return eo.startsWith("m.call.")||eo.startsWith("org.matrix.call.")}),ea=new Set;for(let ei of eo){let eo=ei.getType();(eo===ef.EventType.CallAnswer||eo===ef.EventType.CallHangup)&&ea.add(ei.getContent().call_id)}for(let ei of eo){let eo=ei.getType(),ec=ei.getContent().call_id;if(!(eo===ef.EventType.CallInvite&&ea.has(ec)))try{await this.handleCallEvent(ei)}catch(ei){eu.logger.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",ei)}}}async handleCallEvent(ei){var eo,ea,ec,ed,em,eS,eE,ew;let e_,eT;this.client.emit(ep.ClientEvent.ReceivedVoipEvent,ei);let eI=ei.getContent(),eC=ei.getRoomId()||(null===(eo=this.client.groupCallEventHandler.getGroupCallById(eI.conf_id))||void 0===eo?void 0:null===(ea=eo.room)||void 0===ea?void 0:ea.roomId),eO=eI.conf_id,eR=ei.getType(),ek=ei.getSender(),eM=eI.call_id?this.calls.get(eI.call_id):void 0;if(eO){if(!(eT=this.client.groupCallEventHandler.getGroupCallById(eO))){eu.logger.warn(`CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=${eO}, type=${eR})`);return}if(!(e_=eI.device_id)){eu.logger.warn(`CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=${ek})`),eT.emit(eg.GroupCallEvent.Error,new eg.GroupCallUnknownDeviceError(ek));return}if(eI.dest_session_id!==this.client.getSessionId()){eu.logger.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}let eP=ek===this.client.credentials.userId&&(void 0===e_||e_===this.client.getDeviceId());if(eC){if(eR===ef.EventType.CallInvite){let eo;if(eP||ei.getLocalAge()>eI.lifetime-ey||eM&&eM.state===eh.CallState.Ended||(eM&&eu.logger.warn(`CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=${eI.call_id})`),eI.invitee&&eI.invitee!==this.client.getUserId()))return;let ea=(null!==(ec=this.client.getTurnServersExpiry())&&void 0!==ec?ec:0)-Date.now();if(eu.logger.info("CallEventHandler handleCallEvent() current turn creds expire in "+ea+" ms"),!(eM=null!==(ed=(0,eh.createNewMatrixCall)(this.client,eC,{forceTURN:this.client.forceTURN,opponentDeviceId:e_,groupCallId:eO,opponentSessionId:eI.sender_session_id}))&&void 0!==ed?ed:void 0)){eu.logger.log(`CallEventHandler handleCallEvent() this client does not support WebRTC (callId=${eI.call_id})`);return}eM.callId=eI.call_id;let ef=null===(em=eT)||void 0===em?void 0:em.getGroupCallStats();ef&&eM.initStats(ef);try{await eM.initWithInvite(ei)}catch(ei){ei instanceof eh.CallError&&(ei.code===eg.GroupCallErrorCode.UnknownDevice?null===(eS=eT)||void 0===eS||eS.emit(eg.GroupCallEvent.Error,ei):eu.logger.error(ei))}if(this.calls.set(eM.callId,eM),this.candidateEventsByCall.get(eM.callId))for(let ei of this.candidateEventsByCall.get(eM.callId))eM.onRemoteIceCandidatesReceived(ei);for(let ei of this.calls.values()){let ea=[eh.CallState.WaitLocalMedia,eh.CallState.CreateOffer,eh.CallState.InviteSent].includes(ei.state);if(eM.roomId===ei.roomId&&ei.direction===eh.CallDirection.Outbound&&(null===(eE=eM.getOpponentMember())||void 0===eE?void 0:eE.userId)===ei.invitee&&ea){eo=ei;break}}eo?eo.callId>eM.callId?(eu.logger.log(`CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=${eM.callId}, outgoingId=${eo.callId})`),eo.replacedBy(eM)):(eu.logger.log(`CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=${eM.callId}, outgoingId=${eo.callId})`),eM.hangup(eh.CallErrorCode.Replaced,!0)):this.client.emit(eb.Incoming,eM);return}if(eR===ef.EventType.CallCandidates){if(eP)return;eM?eM.onRemoteIceCandidatesReceived(ei):(this.candidateEventsByCall.has(eI.call_id)||this.candidateEventsByCall.set(eI.call_id,[]),this.candidateEventsByCall.get(eI.call_id).push(ei));return}if([ef.EventType.CallHangup,ef.EventType.CallReject].includes(eR)){eM?eM.state!==eh.CallState.Ended&&(eR===ef.EventType.CallHangup?eM.onHangupReceived(eI):eM.onRejectReceived(eI),eM.state===eh.CallState.Ended&&this.calls.delete(eI.call_id)):(eM=null!==(ew=(0,eh.createNewMatrixCall)(this.client,eC,{opponentDeviceId:e_,opponentSessionId:eI.sender_session_id}))&&void 0!==ew?ew:void 0)&&(eM.callId=eI.call_id,eM.initWithHangup(ei),this.calls.set(eI.call_id,eM));return}if(!eM||!eM.hasPeerConnection){eu.logger.info(`CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=${eR})`);return}if(ei.getContent().party_id!==eM.ourPartyId)switch(eR){case ef.EventType.CallAnswer:eP?eM.state===eh.CallState.Ringing&&eM.onAnsweredElsewhere(eI):eM.onAnswerReceived(ei);break;case ef.EventType.CallSelectAnswer:eM.onSelectAnswerReceived(ei);break;case ef.EventType.CallNegotiate:eM.onNegotiateReceived(ei);break;case ef.EventType.CallAssertedIdentity:case ef.EventType.CallAssertedIdentityPrefix:eM.onAssertedIdentityReceived(ei);break;case ef.EventType.CallSDPStreamMetadataChanged:case ef.EventType.CallSDPStreamMetadataChangedPrefix:eM.onSDPStreamMetadataChangedReceived(ei)}}}}eo.CallEventHandler=eS},5964:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.SDPStreamMetadataPurpose=eo.SDPStreamMetadataKey=void 0;let ea="org.matrix.msc3077.sdp_stream_metadata";eo.SDPStreamMetadataKey=ea;let ec=function(ei){return ei.Usermedia="m.usermedia",ei.Screenshare="m.screenshare",ei}({});eo.SDPStreamMetadataPurpose=ec},9704:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.SPEAKING_THRESHOLD=eo.CallFeedEvent=eo.CallFeed=void 0;var ed=ec(ea(8416)),eu=ea(5964),eh=ea(2667),ef=ea(7434),ep=ea(5861),eg=ea(9679);let em=200,ey=-60;eo.SPEAKING_THRESHOLD=ey;let eb=8,eS=function(ei){return ei.NewStream="new_stream",ei.MuteStateChanged="mute_state_changed",ei.LocalVolumeChanged="local_volume_changed",ei.VolumeChanged="volume_changed",ei.ConnectedChanged="connected_changed",ei.Speaking="speaking",ei.Disposed="disposed",ei}({});eo.CallFeedEvent=eS;class eE extends ep.TypedEventEmitter{constructor(ei){super(),(0,ed.default)(this,"stream",void 0),(0,ed.default)(this,"sdpMetadataStreamId",void 0),(0,ed.default)(this,"userId",void 0),(0,ed.default)(this,"deviceId",void 0),(0,ed.default)(this,"purpose",void 0),(0,ed.default)(this,"speakingVolumeSamples",void 0),(0,ed.default)(this,"client",void 0),(0,ed.default)(this,"call",void 0),(0,ed.default)(this,"roomId",void 0),(0,ed.default)(this,"audioMuted",void 0),(0,ed.default)(this,"videoMuted",void 0),(0,ed.default)(this,"localVolume",1),(0,ed.default)(this,"measuringVolumeActivity",!1),(0,ed.default)(this,"audioContext",void 0),(0,ed.default)(this,"analyser",void 0),(0,ed.default)(this,"frequencyBinCount",void 0),(0,ed.default)(this,"speakingThreshold",ey),(0,ed.default)(this,"speaking",!1),(0,ed.default)(this,"volumeLooperTimeout",void 0),(0,ed.default)(this,"_disposed",!1),(0,ed.default)(this,"_connected",!1),(0,ed.default)(this,"onAddTrack",()=>{this.emit(eS.NewStream,this.stream)}),(0,ed.default)(this,"onCallState",ei=>{ei===eg.CallState.Connected?this.connected=!0:ei===eg.CallState.Connecting&&(this.connected=!1)}),(0,ed.default)(this,"volumeLooper",()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let ei=-1/0;for(let eo of this.frequencyBinCount)eo>ei&&(ei=eo);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(ei),this.emit(eS.VolumeChanged,ei);let eo=!1;for(let ei of this.speakingVolumeSamples)if(ei>this.speakingThreshold){eo=!0;break}this.speaking!==eo&&(this.speaking=eo,this.emit(eS.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,em)}),this.client=ei.client,this.call=ei.call,this.roomId=ei.roomId,this.userId=ei.userId,this.deviceId=ei.deviceId,this.purpose=ei.purpose,this.audioMuted=ei.audioMuted,this.videoMuted=ei.videoMuted,this.speakingVolumeSamples=Array(eb).fill(-1/0),this.sdpMetadataStreamId=ei.stream.id,this.updateStream(null,ei.stream),this.stream=ei.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),ei.call&&(ei.call.addListener(eg.CallEvent.State,this.onCallState),this.onCallState(ei.call.state))}get connected(){return this.isLocal()||this._connected}set connected(ei){this._connected=ei,this.emit(eS.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(ei,eo){eo!==ei&&(ei&&(ei.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=eo,eo.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?this.initVolumeMeasuring():this.measureVolumeActivity(!1),this.emit(eS.NewStream,this.stream))}initVolumeMeasuring(){if(!this.hasAudioTrack)return;this.audioContext||(this.audioContext=(0,eh.acquireContext)()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;let ei=this.audioContext.createMediaStreamSource(this.stream);ei.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){var ei;let eo=this.client.getRoom(this.roomId);return null!==(ei=null==eo?void 0:eo.getMember(this.userId))&&void 0!==ei?ei:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(ei){this.updateStream(this.stream,ei)}setAudioVideoMuted(ei,eo){null!==ei&&(this.audioMuted!==ei&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=ei),null!==eo&&(this.videoMuted=eo),this.emit(eS.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(ei){ei?this.analyser&&this.frequencyBinCount&&this.hasAudioTrack&&(this.measuringVolumeActivity=!0,this.volumeLooper()):(this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(eS.VolumeChanged,-1/0))}setSpeakingThreshold(ei){this.speakingThreshold=ei}clone(){let ei=this.client.getMediaHandler(),eo=this.stream.clone();return ef.logger.log(`CallFeed clone() cloning stream (originalStreamId=${this.stream.id}, newStreamId${eo.id})`),this.purpose===eu.SDPStreamMetadataPurpose.Usermedia?ei.userMediaStreams.push(eo):ei.screensharingStreams.push(eo),new eE({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:eo,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var ei,eo;clearTimeout(this.volumeLooperTimeout),null===(ei=this.stream)||void 0===ei||ei.removeEventListener("addtrack",this.onAddTrack),null===(eo=this.call)||void 0===eo||eo.removeListener(eg.CallEvent.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,(0,eh.releaseContext)()),this._disposed=!0,this.emit(eS.Disposed)}get disposed(){return this._disposed}set disposed(ei){this._disposed=ei}getLocalVolume(){return this.localVolume}setLocalVolume(ei){this.localVolume=ei,this.emit(eS.LocalVolumeChanged,ei)}}eo.CallFeed=eE},8969:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.OtherUserSpeakingError=eo.GroupCallUnknownDeviceError=eo.GroupCallType=eo.GroupCallTerminationReason=eo.GroupCallStatsReportEvent=eo.GroupCallState=eo.GroupCallIntent=eo.GroupCallEvent=eo.GroupCallErrorCode=eo.GroupCallError=eo.GroupCall=void 0;var ed=ec(ea(8416)),eu=ea(5861),eh=ea(9704),ef=ea(9679),ep=ea(6860),eg=ea(7434),em=ea(771),ey=ea(5964),eb=ea(2481),eS=ea(2931),eE=ea(8738),ew=ea(3102),e_=ea(4987),eT=ea(930);function eI(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eC(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eI(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eI(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}let eO=function(ei){return ei.Ring="m.ring",ei.Prompt="m.prompt",ei.Room="m.room",ei}({});eo.GroupCallIntent=eO;let eR=function(ei){return ei.Video="m.video",ei.Voice="m.voice",ei}({});eo.GroupCallType=eR;let ek=function(ei){return ei.CallEnded="call_ended",ei}({});eo.GroupCallTerminationReason=ek;let eM=function(ei){return ei.GroupCallStateChanged="group_call_state_changed",ei.ActiveSpeakerChanged="active_speaker_changed",ei.CallsChanged="calls_changed",ei.UserMediaFeedsChanged="user_media_feeds_changed",ei.ScreenshareFeedsChanged="screenshare_feeds_changed",ei.LocalScreenshareStateChanged="local_screenshare_state_changed",ei.LocalMuteStateChanged="local_mute_state_changed",ei.ParticipantsChanged="participants_changed",ei.Error="group_call_error",ei}({});eo.GroupCallEvent=eM;let eP=function(ei){return ei.ConnectionStats="GroupCall.connection_stats",ei.ByteSentStats="GroupCall.byte_sent_stats",ei.SummaryStats="GroupCall.summary_stats",ei}({});eo.GroupCallStatsReportEvent=eP;let eA=function(ei){return ei.NoUserMedia="no_user_media",ei.UnknownDevice="unknown_device",ei.PlaceCallFailed="place_call_failed",ei}({});eo.GroupCallErrorCode=eA;class eD extends Error{constructor(ei,eo,ea){ea?(super(eo+": "+ea),(0,ed.default)(this,"code",void 0)):(super(eo),(0,ed.default)(this,"code",void 0)),this.code=ei}}eo.GroupCallError=eD;class ej extends eD{constructor(ei){super(eA.UnknownDevice,"No device found for "+ei),this.userId=ei}}eo.GroupCallUnknownDeviceError=ej;class eL extends Error{constructor(){super("Cannot unmute: another user is speaking")}}eo.OtherUserSpeakingError=eL;let eN=function(ei){return ei.LocalCallFeedUninitialized="local_call_feed_uninitialized",ei.InitializingLocalCallFeed="initializing_local_call_feed",ei.LocalCallFeedInitialized="local_call_feed_initialized",ei.Entered="entered",ei.Ended="ended",ei}({});eo.GroupCallState=eN;let eU=36e5;function eB(ei){var eo;return(null===(eo=ei.getOpponentMember())||void 0===eo?void 0:eo.userId)||ei.invitee||null}class eF extends eu.TypedEventEmitter{constructor(ei,eo,ea,ec,eu,ey,eS,eE,ew){var eI,eC;super(),this.client=ei,this.room=eo,this.type=ea,this.isPtt=ec,this.intent=eu,this.dataChannelsEnabled=eS,this.dataChannelOptions=eE,(0,ed.default)(this,"activeSpeakerInterval",1e3),(0,ed.default)(this,"retryCallInterval",5e3),(0,ed.default)(this,"participantTimeout",15e3),(0,ed.default)(this,"pttMaxTransmitTime",2e4),(0,ed.default)(this,"activeSpeaker",void 0),(0,ed.default)(this,"localCallFeed",void 0),(0,ed.default)(this,"localScreenshareFeed",void 0),(0,ed.default)(this,"localDesktopCapturerSourceId",void 0),(0,ed.default)(this,"userMediaFeeds",[]),(0,ed.default)(this,"screenshareFeeds",[]),(0,ed.default)(this,"groupCallId",void 0),(0,ed.default)(this,"allowCallWithoutVideoAndAudio",void 0),(0,ed.default)(this,"calls",new Map),(0,ed.default)(this,"callHandlers",new Map),(0,ed.default)(this,"activeSpeakerLoopInterval",void 0),(0,ed.default)(this,"retryCallLoopInterval",void 0),(0,ed.default)(this,"retryCallCounts",new Map),(0,ed.default)(this,"reEmitter",void 0),(0,ed.default)(this,"transmitTimer",null),(0,ed.default)(this,"participantsExpirationTimer",null),(0,ed.default)(this,"resendMemberStateTimer",null),(0,ed.default)(this,"initWithAudioMuted",!1),(0,ed.default)(this,"initWithVideoMuted",!1),(0,ed.default)(this,"initCallFeedPromise",void 0),(0,ed.default)(this,"stats",void 0),(0,ed.default)(this,"onConnectionStats",ei=>{this.emit(eP.ConnectionStats,{report:ei})}),(0,ed.default)(this,"onByteSentStats",ei=>{this.emit(eP.ByteSentStats,{report:ei})}),(0,ed.default)(this,"onSummaryStats",ei=>{this.emit(eP.SummaryStats,{report:ei})}),(0,ed.default)(this,"_state",eN.LocalCallFeedUninitialized),(0,ed.default)(this,"_participants",new Map),(0,ed.default)(this,"_creationTs",null),(0,ed.default)(this,"_enteredViaAnotherSession",!1),(0,ed.default)(this,"onIncomingCall",ei=>{var eo,ea;if(ei.roomId!==this.room.roomId)return;if(ei.state!==ef.CallState.Ringing){eg.logger.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call no longer in ringing state - ignoring`);return}if(!ei.groupCallId||ei.groupCallId!==this.groupCallId){eg.logger.log(`GroupCall ${this.groupCallId} onIncomingCall() ignored because it doesn't match the current group call`),ei.reject();return}let ec=null===(eo=ei.getOpponentMember())||void 0===eo?void 0:eo.userId;if(void 0===ec){eg.logger.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call with no member - ignoring`);return}let ed=null!==(ea=this.calls.get(ec))&&void 0!==ea?ea:new Map,eu=ed.get(ei.getOpponentDeviceId());if((null==eu?void 0:eu.callId)===ei.callId)return;eg.logger.log(`GroupCall ${this.groupCallId} onIncomingCall() incoming call (userId=${ec}, callId=${ei.callId})`),eu&&eu.hangup(ef.CallErrorCode.Replaced,!1),this.initCall(ei);let eh=this.getLocalFeeds().map(ei=>ei.clone());if(!this.callExpected(ei))for(let ei of eh)(0,ef.setTracksEnabled)(ei.stream.getAudioTracks(),!1),(0,ef.setTracksEnabled)(ei.stream.getVideoTracks(),!1);ei.answerWithCallFeeds(eh),ed.set(ei.getOpponentDeviceId(),ei),this.calls.set(ec,ed),this.emit(eM.CallsChanged,this.calls)}),(0,ed.default)(this,"onRetryCallLoop",()=>{let ei=!1;for(let[{userId:ec},ed]of this.participants){let eu=this.calls.get(ec),eh=this.retryCallCounts.get(ec);for(let[ef,ep]of ed){var eo,ea;let ed=null==eu?void 0:eu.get(ef),eg=null!==(eo=null===(ea=eh)||void 0===ea?void 0:ea.get(ef))&&void 0!==eo?eo:0;(null==ed?void 0:ed.getOpponentSessionId())!==ep.sessionId&&this.wantsOutgoingCall(ec,ef)&&eg<3&&(void 0===eh&&(eh=new Map,this.retryCallCounts.set(ec,eh)),eh.set(ef,eg+1),ei=!0)}}ei&&this.placeOutgoingCalls()}),(0,ed.default)(this,"onCallFeedsChanged",ei=>{let eo=eB(ei),ea=ei.getOpponentDeviceId();if(!eo)throw Error("Cannot change call feeds without user id");let ec=this.getUserMediaFeed(eo,ea),ed=ei.remoteUsermediaFeed,eu=ed!==ec;eu&&(!ec&&ed?this.addUserMediaFeed(ed):ec&&ed?this.replaceUserMediaFeed(ec,ed):ec&&!ed&&this.removeUserMediaFeed(ec));let eh=this.getScreenshareFeed(eo,ea),ef=ei.remoteScreensharingFeed,ep=ef!==eh;ep&&(!eh&&ef?this.addScreenshareFeed(ef):eh&&ef?this.replaceScreenshareFeed(eh,ef):eh&&!ef&&this.removeScreenshareFeed(eh))}),(0,ed.default)(this,"onCallStateChanged",(ei,eo,ea)=>{var ec;if(eo===ef.CallState.Ended)return;let ed=this.localCallFeed.isAudioMuted();ei.localUsermediaStream&&ei.isMicrophoneMuted()!==ed&&ei.setMicrophoneMuted(ed);let eu=this.localCallFeed.isVideoMuted();ei.localUsermediaStream&&ei.isLocalVideoMuted()!==eu&&ei.setLocalVideoMuted(eu);let eh=null===(ec=ei.getOpponentMember())||void 0===ec?void 0:ec.userId;if(eo===ef.CallState.Connected&&eh){let eo=this.retryCallCounts.get(eh);null==eo||eo.delete(ei.getOpponentDeviceId()),(null==eo?void 0:eo.size)===0&&this.retryCallCounts.delete(eh)}}),(0,ed.default)(this,"onCallHangup",ei=>{var eo,ea;if(ei.hangupReason===ef.CallErrorCode.Replaced)return;let ec=null!==(eo=null===(ea=ei.getOpponentMember())||void 0===ea?void 0:ea.userId)&&void 0!==eo?eo:this.room.getMember(ei.invitee).userId,ed=this.calls.get(ec);(null==ed?void 0:ed.get(ei.getOpponentDeviceId()))===ei&&(this.disposeCall(ei,ei.hangupReason),ed.delete(ei.getOpponentDeviceId()),0===ed.size&&this.calls.delete(ec),this.emit(eM.CallsChanged,this.calls))}),(0,ed.default)(this,"onCallReplaced",(ei,eo)=>{let ea=ei.getOpponentMember().userId,ec=this.calls.get(ea);void 0===ec&&(ec=new Map,this.calls.set(ea,ec)),ei.hangup(ef.CallErrorCode.Replaced,!1),this.initCall(eo),ec.set(ei.getOpponentDeviceId(),eo),this.emit(eM.CallsChanged,this.calls)}),(0,ed.default)(this,"onActiveSpeakerLoop",()=>{let ei,eo;for(let ea of this.userMediaFeeds){if(ea.isLocal()&&this.userMediaFeeds.length>1)continue;let ec=ea.speakingVolumeSamples.reduce((ei,eo)=>ei+Math.max(eo,eh.SPEAKING_THRESHOLD)),ed=ec/ea.speakingVolumeSamples.length;(!ei||ed>ei)&&(ei=ed,eo=ea)}eo&&this.activeSpeaker!==eo&&ei&&ei>eh.SPEAKING_THRESHOLD&&(this.activeSpeaker=eo,this.emit(eM.ActiveSpeakerChanged,this.activeSpeaker))}),(0,ed.default)(this,"onRoomState",()=>this.updateParticipants()),(0,ed.default)(this,"onParticipantsChanged",()=>{this.forEachCall(ei=>{let eo=this.callExpected(ei);for(let ea of ei.getLocalFeeds())(0,ef.setTracksEnabled)(ea.stream.getAudioTracks(),!ea.isAudioMuted()&&eo),(0,ef.setTracksEnabled)(ea.stream.getVideoTracks(),!ea.isVideoMuted()&&eo)}),this.state===eN.Entered&&this.placeOutgoingCalls()}),(0,ed.default)(this,"onStateChanged",(ei,eo)=>{(ei===eN.Entered||eo===eN.Entered||ei===eN.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(ei=>eg.logger.error(`GroupCall ${this.groupCallId} onStateChanged() failed to update member state devices"`,ei)))}),(0,ed.default)(this,"onLocalFeedsChanged",()=>{this.state===eN.Entered&&this.updateMemberState().catch(ei=>eg.logger.error(`GroupCall ${this.groupCallId} onLocalFeedsChanged() failed to update member state feeds`,ei))}),this.reEmitter=new em.ReEmitter(this),this.groupCallId=null!=ey?ey:(0,ef.genCallID)(),this.creationTs=null!==(eI=null===(eC=eo.currentState.getStateEvents(eb.EventType.GroupCallPrefix,this.groupCallId))||void 0===eC?void 0:eC.getTs())&&void 0!==eI?eI:null,this.updateParticipants(),eo.on(ep.RoomStateEvent.Update,this.onRoomState),this.on(eM.ParticipantsChanged,this.onParticipantsChanged),this.on(eM.GroupCallStateChanged,this.onStateChanged),this.on(eM.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!ew;let eO=this.client.getUserId()||"unknown";this.stats=new e_.GroupCallStats(this.groupCallId,eO),this.stats.reports.on(eT.StatsReport.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(eT.StatsReport.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(eT.StatsReport.SUMMARY_STATS,this.onSummaryStats)}async create(){this.creationTs=Date.now(),this.client.groupCallEventHandler.groupCalls.set(this.room.roomId,this),this.client.emit(eE.GroupCallEventHandlerEvent.Outgoing,this);let ei={"m.intent":this.intent,"m.type":this.type,"io.element.ptt":this.isPtt,dataChannelsEnabled:this.dataChannelsEnabled,dataChannelOptions:this.dataChannelsEnabled?this.dataChannelOptions:void 0};return await this.client.sendStateEvent(this.room.roomId,eb.EventType.GroupCallPrefix,ei,this.groupCallId),this}get state(){return this._state}set state(ei){let eo=this._state;ei!==eo&&(this._state=ei,this.emit(eM.GroupCallStateChanged,ei,eo))}get participants(){return this._participants}set participants(ei){let eo=this._participants,ea=(ei,eo)=>ei.sessionId===eo.sessionId&&ei.screensharing===eo.screensharing,ec=(ei,eo)=>(0,ew.mapsEqual)(ei,eo,ea);(0,ew.mapsEqual)(ei,eo,ec)||(this._participants=ei,this.emit(eM.ParticipantsChanged,ei))}get creationTs(){return this._creationTs}set creationTs(ei){this._creationTs=ei}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(ei){this._enteredViaAnotherSession=ei,this.updateParticipants()}forEachCall(ei){for(let eo of this.calls.values())for(let ea of eo.values())ei(ea)}getLocalFeeds(){let ei=[];return this.localCallFeed&&ei.push(this.localCallFeed),this.localScreenshareFeed&&ei.push(this.localScreenshareFeed),ei}hasLocalParticipant(){var ei,eo;return null!==(ei=null===(eo=this.participants.get(this.room.getMember(this.client.getUserId())))||void 0===eo?void 0:eo.has(this.client.getDeviceId()))&&void 0!==ei&&ei}callExpected(ei){var eo;let ea=eB(ei),ec=null===ea?null:this.room.getMember(ea),ed=ei.getOpponentDeviceId();return null!==ec&&void 0!==ed&&(null===(eo=this.participants.get(ec))||void 0===eo?void 0:eo.get(ed))!==void 0}async initLocalCallFeed(){if(this.state!==eN.LocalCallFeedUninitialized)throw Error(`Cannot initialize local call feed in the "${this.state}" state.`);if(this.state=eN.InitializingLocalCallFeed,this.initCallFeedPromise)return this.initCallFeedPromise;try{this.initCallFeedPromise=this.initLocalCallFeedInternal(),await this.initCallFeedPromise}finally{this.initCallFeedPromise=void 0}}async initLocalCallFeedInternal(){let ei;eg.logger.log(`GroupCall ${this.groupCallId} initLocalCallFeedInternal() running`);try{ei=await this.client.getMediaHandler().getUserMediaStream(!0,this.type===eR.Video)}catch(eo){if(this.allowCallWithoutVideoAndAudio)ei=new MediaStream;else throw this.state=eN.LocalCallFeedUninitialized,eo}if(this._state!==eN.InitializingLocalCallFeed)throw this.client.getMediaHandler().stopUserMediaStream(ei),Error("Group call disposed while gathering media stream");let eo=new eh.CallFeed({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:ei,purpose:ey.SDPStreamMetadataPurpose.Usermedia,audioMuted:this.initWithAudioMuted||0===ei.getAudioTracks().length||this.isPtt,videoMuted:this.initWithVideoMuted||0===ei.getVideoTracks().length});(0,ef.setTracksEnabled)(ei.getAudioTracks(),!eo.isAudioMuted()),(0,ef.setTracksEnabled)(ei.getVideoTracks(),!eo.isVideoMuted()),this.localCallFeed=eo,this.addUserMediaFeed(eo),this.state=eN.LocalCallFeedInitialized}async updateLocalUsermediaStream(ei){if(this.localCallFeed){let eo=this.localCallFeed.stream;this.localCallFeed.setNewStream(ei);let ea=this.localCallFeed.isAudioMuted(),ec=this.localCallFeed.isVideoMuted();eg.logger.log(`GroupCall ${this.groupCallId} updateLocalUsermediaStream() (oldStreamId=${eo.id}, newStreamId=${ei.id}, micShouldBeMuted=${ea}, vidShouldBeMuted=${ec})`),(0,ef.setTracksEnabled)(ei.getAudioTracks(),!ea),(0,ef.setTracksEnabled)(ei.getVideoTracks(),!ec),this.client.getMediaHandler().stopUserMediaStream(eo)}}async enter(){if(this.state===eN.LocalCallFeedUninitialized)await this.initLocalCallFeed();else if(this.state!==eN.LocalCallFeedInitialized)throw Error(`Cannot enter call in the "${this.state}" state`);for(let ei of(eg.logger.log(`GroupCall ${this.groupCallId} enter() running`),this.state=eN.Entered,this.client.on(eS.CallEventHandlerEvent.Incoming,this.onIncomingCall),this.client.callEventHandler.calls.values()))this.onIncomingCall(ei);this.retryCallLoopInterval=setInterval(this.onRetryCallLoop,this.retryCallInterval),this.activeSpeaker=void 0,this.onActiveSpeakerLoop(),this.activeSpeakerLoopInterval=setInterval(this.onActiveSpeakerLoop,this.activeSpeakerInterval)}dispose(){this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===eN.Entered&&(this.forEachCall(ei=>ei.hangup(ef.CallErrorCode.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(eS.CallEventHandlerEvent.Incoming,this.onIncomingCall),this.stats.stop())}leave(){this.dispose(),this.state=eN.LocalCallFeedUninitialized}async terminate(ei=!0){if(this.dispose(),this.room.off(ep.RoomStateEvent.Update,this.onRoomState),this.client.groupCallEventHandler.groupCalls.delete(this.room.roomId),this.client.emit(eE.GroupCallEventHandlerEvent.Ended,this),this.state=eN.Ended,ei){let ei=this.room.currentState.getStateEvents(eb.EventType.GroupCallPrefix,this.groupCallId);await this.client.sendStateEvent(this.room.roomId,eb.EventType.GroupCallPrefix,eC(eC({},ei.getContent()),{},{"m.terminated":ek.CallEnded}),this.groupCallId)}}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}async setMicrophoneMuted(ei){if(!ei&&!await this.client.getMediaHandler().hasAudioDevice())return!1;let eo=!ei&&this.isPtt;this.isPtt&&(!ei&&this.isMicrophoneMuted()?this.transmitTimer=setTimeout(()=>{this.setMicrophoneMuted(!0)},this.pttMaxTransmitTime):ei&&!this.isMicrophoneMuted()&&(null!==this.transmitTimer&&clearTimeout(this.transmitTimer),this.transmitTimer=null)),this.forEachCall(eo=>{var ea;return null===(ea=eo.localUsermediaFeed)||void 0===ea?void 0:ea.setAudioVideoMuted(ei,null)});let ea=async()=>{let ei=[];this.forEachCall(eo=>ei.push(eo.sendMetadataUpdate())),await Promise.all(ei).catch(ei=>eg.logger.info(`GroupCall ${this.groupCallId} setMicrophoneMuted() failed to send some metadata updates`,ei))};if(eo&&await ea(),this.localCallFeed){eg.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() (streamId=${this.localCallFeed.stream.id}, muted=${ei})`);try{if(!ei){let eo=await this.client.getMediaHandler().getUserMediaStream(!0,!this.localCallFeed.isVideoMuted());if(null===eo)return eg.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device to receive local stream, muted=${ei}`),!1}}catch(eo){return eg.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device or permission to receive local stream, muted=${ei}`),!1}this.localCallFeed.setAudioVideoMuted(ei,null),(0,ef.setTracksEnabled)(this.localCallFeed.stream.getAudioTracks(),!ei)}else eg.logger.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no stream muted (muted=${ei})`),this.initWithAudioMuted=ei;return this.forEachCall(eo=>(0,ef.setTracksEnabled)(eo.localUsermediaFeed.stream.getAudioTracks(),!ei&&this.callExpected(eo))),this.emit(eM.LocalMuteStateChanged,ei,this.isLocalVideoMuted()),eo||await ea(),!0}async setLocalVideoMuted(ei){if(!ei&&!await this.client.getMediaHandler().hasVideoDevice())return!1;if(this.localCallFeed){eg.logger.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() (stream=${this.localCallFeed.stream.id}, muted=${ei})`);try{let eo=await this.client.getMediaHandler().getUserMediaStream(!0,!ei);await this.updateLocalUsermediaStream(eo),this.localCallFeed.setAudioVideoMuted(null,ei),(0,ef.setTracksEnabled)(this.localCallFeed.stream.getVideoTracks(),!ei)}catch(eo){return eg.logger.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no device or permission to receive local stream, muted=${ei}`),!1}}else eg.logger.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no stream muted (muted=${ei})`),this.initWithVideoMuted=ei;let eo=[];return this.forEachCall(ea=>eo.push(ea.setLocalVideoMuted(ei))),await Promise.all(eo),this.forEachCall(eo=>(0,ef.setTracksEnabled)(eo.localUsermediaFeed.stream.getVideoTracks(),!ei&&this.callExpected(eo))),this.emit(eM.LocalMuteStateChanged,this.isMicrophoneMuted(),ei),!0}async setScreensharingEnabled(ei,eo={}){if(ei===this.isScreensharing())return ei;if(!ei)return this.forEachCall(ei=>{ei.localScreensharingFeed&&ei.removeLocalFeed(ei.localScreensharingFeed)}),this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0,this.emit(eM.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{eg.logger.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() is asking for screensharing permissions`);let ei=await this.client.getMediaHandler().getScreensharingStream(eo);for(let eo of ei.getTracks()){let ei=()=>{this.setScreensharingEnabled(!1),eo.removeEventListener("ended",ei)};eo.addEventListener("ended",ei)}return eg.logger.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls`),this.localDesktopCapturerSourceId=eo.desktopCapturerSourceId,this.localScreenshareFeed=new eh.CallFeed({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:ei,purpose:ey.SDPStreamMetadataPurpose.Screenshare,audioMuted:!1,videoMuted:!1}),this.addScreenshareFeed(this.localScreenshareFeed),this.emit(eM.LocalScreenshareStateChanged,!0,this.localScreenshareFeed,this.localDesktopCapturerSourceId),this.forEachCall(ei=>ei.pushLocalFeed(this.localScreenshareFeed.clone())),!0}catch(ei){if(eo.throwOnFail)throw ei;return eg.logger.error(`GroupCall ${this.groupCallId} setScreensharingEnabled() enabling screensharing error`,ei),this.emit(eM.Error,new eD(eA.NoUserMedia,"Failed to get screen-sharing stream: ",ei)),!1}}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(ei,eo){let ea=this.client.getUserId(),ec=this.client.getDeviceId();return ei>=ea&&(ei!==ea||eo>ec)}placeOutgoingCalls(){let ei=!1;for(let[{userId:ea},ec]of this.participants){var eo;let ed=null!==(eo=this.calls.get(ea))&&void 0!==eo?eo:new Map;for(let[eo,eu]of ec){let ec=ed.get(eo);if((null==ec?void 0:ec.getOpponentSessionId())!==eu.sessionId&&this.wantsOutgoingCall(ea,eo)){ei=!0,void 0!==ec&&(eg.logger.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() replacing call (userId=${ea}, deviceId=${eo}, callId=${ec.callId})`),ec.hangup(ef.CallErrorCode.NewSession,!1));let eh=(0,ef.createNewMatrixCall)(this.client,this.room.roomId,{invitee:ea,opponentDeviceId:eo,opponentSessionId:eu.sessionId,groupCallId:this.groupCallId});null===eh?(eg.logger.error(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to create call (userId=${ea}, device=${eo})`),ed.delete(eo)):(this.initCall(eh),ed.set(eo,eh),eg.logger.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() placing call (userId=${ea}, deviceId=${eo}, sessionId=${eu.sessionId})`),eh.placeCallWithCallFeeds(this.getLocalFeeds().map(ei=>ei.clone()),eu.screensharing).then(()=>{this.dataChannelsEnabled&&eh.createDataChannel("datachannel",this.dataChannelOptions)}).catch(ei=>{eg.logger.warn(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to place call (userId=${ea})`,ei),ei instanceof ef.CallError&&ei.code===eA.UnknownDevice?this.emit(eM.Error,ei):this.emit(eM.Error,new eD(eA.PlaceCallFailed,`Failed to place call to ${ea}`)),eh.hangup(ef.CallErrorCode.SignallingFailed,!1),ed.get(eo)===eh&&ed.delete(eo)}))}}ed.size>0?this.calls.set(ea,ed):this.calls.delete(ea)}ei&&this.emit(eM.CallsChanged,this.calls)}getMemberStateEvents(ei){return void 0===ei?this.room.currentState.getStateEvents(eb.EventType.GroupCallMemberPrefix):this.room.currentState.getStateEvents(eb.EventType.GroupCallMemberPrefix,ei)}initCall(ei){let eo=eB(ei);if(!eo)throw Error("Cannot init call without user id");let ea=()=>this.onCallFeedsChanged(ei),ec=(eo,ea)=>this.onCallStateChanged(ei,eo,ea),ed=this.onCallHangup,eu=eo=>this.onCallReplaced(ei,eo),eh=this.callHandlers.get(eo);void 0===eh&&(eh=new Map,this.callHandlers.set(eo,eh)),eh.set(ei.getOpponentDeviceId(),{onCallFeedsChanged:ea,onCallStateChanged:ec,onCallHangup:ed,onCallReplaced:eu}),ei.on(ef.CallEvent.FeedsChanged,ea),ei.on(ef.CallEvent.State,ec),ei.on(ef.CallEvent.Hangup,ed),ei.on(ef.CallEvent.Replaced,eu),ei.isPtt=this.isPtt,this.reEmitter.reEmit(ei,Object.values(ef.CallEvent)),ei.initStats(this.stats),ea()}disposeCall(ei,eo){let ea=eB(ei),ec=ei.getOpponentDeviceId();if(!ea)throw Error("Cannot dispose call without user id");let ed=this.callHandlers.get(ea),{onCallFeedsChanged:eu,onCallStateChanged:eh,onCallHangup:ep,onCallReplaced:eg}=ed.get(ec);if(ei.removeListener(ef.CallEvent.FeedsChanged,eu),ei.removeListener(ef.CallEvent.State,eh),ei.removeListener(ef.CallEvent.Hangup,ep),ei.removeListener(ef.CallEvent.Replaced,eg),ed.delete(ea),0===ed.size&&this.callHandlers.delete(ea),ei.hangupReason===ef.CallErrorCode.Replaced)return;let em=this.getUserMediaFeed(ea,ec);em&&this.removeUserMediaFeed(em);let ey=this.getScreenshareFeed(ea,ec);ey&&this.removeScreenshareFeed(ey)}getUserMediaFeed(ei,eo){return this.userMediaFeeds.find(ea=>ea.userId===ei&&ea.deviceId===eo)}addUserMediaFeed(ei){this.userMediaFeeds.push(ei),ei.measureVolumeActivity(!0),this.emit(eM.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(ei,eo){let ea=this.userMediaFeeds.findIndex(eo=>eo.userId===ei.userId&&eo.deviceId===ei.deviceId);if(-1===ea)throw Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(ea,1,eo),ei.dispose(),eo.measureVolumeActivity(!0),this.emit(eM.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(ei){let eo=this.userMediaFeeds.findIndex(eo=>eo.userId===ei.userId&&eo.deviceId===ei.deviceId);if(-1===eo)throw Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(eo,1),ei.dispose(),this.emit(eM.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===ei&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(eM.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(ei,eo){return this.screenshareFeeds.find(ea=>ea.userId===ei&&ea.deviceId===eo)}addScreenshareFeed(ei){this.screenshareFeeds.push(ei),this.emit(eM.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(ei,eo){let ea=this.screenshareFeeds.findIndex(eo=>eo.userId===ei.userId&&eo.deviceId===ei.deviceId);if(-1===ea)throw Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(ea,1,eo),ei.dispose(),this.emit(eM.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(ei){let eo=this.screenshareFeeds.findIndex(eo=>eo.userId===ei.userId&&eo.deviceId===ei.deviceId);if(-1===eo)throw Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(eo,1),ei.dispose(),this.emit(eM.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){let ei=this.room.getMember(this.client.getUserId());if(!ei){eg.logger.warn(`GroupCall ${this.groupCallId} updateParticipants() tried to update participants before local room member is available`);return}if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===eN.Ended){this.participants=new Map;return}let eo=new Map,ea=Date.now(),ec=this.state===eN.Entered||this.enteredViaAnotherSession,ed=1/0;for(let ei of this.getMemberStateEvents()){let eu=this.room.getMember(ei.getStateKey()),eh=ei.getContent(),ef=Array.isArray(eh["m.calls"])?eh["m.calls"]:[],ep=ef.find(ei=>ei["m.call_id"]===this.groupCallId),eg=Array.isArray(null==ep?void 0:ep["m.devices"])?ep["m.devices"]:[],em=eg.filter(ei=>"string"==typeof ei.device_id&&"string"==typeof ei.session_id&&"number"==typeof ei.expires_ts&&ei.expires_ts>ea&&Array.isArray(ei.feeds));if(ec||(null==eu?void 0:eu.userId)!==this.client.getUserId()||(em=em.filter(ei=>ei.device_id!==this.client.getDeviceId())),em.length>0&&(null==eu?void 0:eu.membership)==="join"){let ei=new Map;for(let ea of(eo.set(eu,ei),em))ei.set(ea.device_id,{sessionId:ea.session_id,screensharing:ea.feeds.some(ei=>ei.purpose===ey.SDPStreamMetadataPurpose.Screenshare)}),ea.expires_ts<ed&&(ed=ea.expires_ts)}}if(ec){let ea=eo.get(ei);void 0===ea&&(ea=new Map,eo.set(ei,ea)),ea.has(this.client.getDeviceId())||ea.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(ei=>ei.purpose===ey.SDPStreamMetadataPurpose.Screenshare)})}this.participants=eo,ed<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),ed-ea))}async updateDevices(ei,eo=!1){var ea;let ec=Date.now(),ed=this.client.getUserId(),eu=this.getMemberStateEvents(ed),eh=null!==(ea=null==eu?void 0:eu.getContent())&&void 0!==ea?ea:{},ef=Array.isArray(eh["m.calls"])?eh["m.calls"]:[],ep=null,eg=[];for(let ei of ef)ei["m.call_id"]===this.groupCallId?ep=ei:eg.push(ei);null===ep&&(ep={});let em=Array.isArray(ep["m.devices"])?ep["m.devices"]:[],ey=em.filter(ei=>"string"==typeof ei.device_id&&"string"==typeof ei.session_id&&"number"==typeof ei.expires_ts&&ei.expires_ts>ec&&Array.isArray(ei.feeds)),eS=ei(ey);if(null===eS)return;let eE=[...eg];eS.length>0&&eE.push(eC(eC({},ep),{},{"m.call_id":this.groupCallId,"m.devices":eS}));let ew={"m.calls":eE};await this.client.sendStateEvent(this.room.roomId,eb.EventType.GroupCallMemberPrefix,ew,ed,{keepAlive:eo})}async addDeviceToMemberState(){await this.updateDevices(ei=>[...ei.filter(ei=>ei.device_id!==this.client.getDeviceId()),{device_id:this.client.getDeviceId(),session_id:this.client.getSessionId(),expires_ts:Date.now()+eU,feeds:this.getLocalFeeds().map(ei=>({purpose:ei.purpose}))}])}async updateMemberState(){null!==this.resendMemberStateTimer&&(clearInterval(this.resendMemberStateTimer),this.resendMemberStateTimer=null),this.state===eN.Entered?(await this.addDeviceToMemberState(),this.resendMemberStateTimer=setInterval(async()=>{eg.logger.log(`GroupCall ${this.groupCallId} updateMemberState() resending call member state"`);try{await this.addDeviceToMemberState()}catch(ei){eg.logger.error(`GroupCall ${this.groupCallId} updateMemberState() failed to resend call member state`,ei)}},3*eU/4)):await this.updateDevices(ei=>ei.filter(ei=>ei.device_id!==this.client.getDeviceId()),!0)}async cleanMemberState(){let{devices:ei}=await this.client.getDevices(),eo=new Map(ei.map(ei=>[ei.device_id,ei]));await this.updateDevices(ei=>{let ea=ei.filter(ei=>{let ea=eo.get(ei.device_id);return(null==ea?void 0:ea.last_seen_ts)!==void 0&&!(ei.device_id===this.client.getDeviceId()&&this.state!==eN.Entered&&!this.enteredViaAnotherSession)});return ea.length===ei.length?null:ea})}getGroupCallStats(){return this.stats}}eo.GroupCall=eF},8738:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.GroupCallEventHandlerEvent=eo.GroupCallEventHandler=void 0;var ed=ec(ea(8416)),eu=ea(2168),eh=ea(8969),ef=ea(6860),ep=ea(7434),eg=ea(2481),em=ea(4551);let ey=function(ei){return ei.Incoming="GroupCall.incoming",ei.Outgoing="GroupCall.outgoing",ei.Ended="GroupCall.ended",ei.Participants="GroupCall.participants",ei}({});eo.GroupCallEventHandlerEvent=ey;class eb{constructor(ei){this.client=ei,(0,ed.default)(this,"groupCalls",new Map),(0,ed.default)(this,"roomDeferreds",new Map),(0,ed.default)(this,"onRoomsChanged",ei=>{this.createGroupCallForRoom(ei)}),(0,ed.default)(this,"onRoomStateChanged",(ei,eo)=>{let ea=ei.getType();if(ea===eg.EventType.GroupCallPrefix){let ea=ei.getStateKey(),ec=ei.getContent(),ed=this.groupCalls.get(eo.roomId);ed||ec["m.terminated"]||ei.isRedacted()?ed&&ed.groupCallId===ea?ec["m.terminated"]||ei.isRedacted()?ed.terminate(!1):ec["m.type"]!==ed.type&&ep.logger.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=${eo.roomId})`):ed&&ed.groupCallId!==ea&&ep.logger.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=${eo.roomId})`):this.createGroupCallFromRoomStateEvent(ei)}})}async start(){this.client.getSyncState()!==em.SyncState.Syncing&&(ep.logger.debug("GroupCallEventHandler start() waiting for client to start syncing"),await new Promise(ei=>{let eo=()=>{if(this.client.getSyncState()===em.SyncState.Syncing)return this.client.off(eu.ClientEvent.Sync,eo),ei()};this.client.on(eu.ClientEvent.Sync,eo)}));let ei=this.client.getRooms();for(let eo of ei)this.createGroupCallForRoom(eo);this.client.on(eu.ClientEvent.Room,this.onRoomsChanged),this.client.on(ef.RoomStateEvent.Events,this.onRoomStateChanged)}stop(){this.client.removeListener(ef.RoomStateEvent.Events,this.onRoomStateChanged)}getRoomDeferred(ei){let eo=this.roomDeferreds.get(ei);if(void 0===eo){let ea;(eo={prom:new Promise(ei=>{ea=ei})}).resolve=ea,this.roomDeferreds.set(ei,eo)}return eo}waitUntilRoomReadyForGroupCalls(ei){return this.getRoomDeferred(ei).prom}getGroupCallById(ei){return[...this.groupCalls.values()].find(eo=>eo.groupCallId===ei)}createGroupCallForRoom(ei){let eo=ei.currentState.getStateEvents(eg.EventType.GroupCallPrefix),ea=eo.sort((ei,eo)=>eo.getTs()-ei.getTs());for(let ec of ea){let ea=ec.getContent();if(!(ea["m.terminated"]||ec.isRedacted())){ep.logger.debug(`GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=${ec.getStateKey()}, ts=${ec.getTs()}, roomId=${ei.roomId}, numOfPossibleCalls=${eo.length})`),this.createGroupCallFromRoomStateEvent(ec);break}}ep.logger.info(`GroupCallEventHandler createGroupCallForRoom() processed room (roomId=${ei.roomId})`),this.getRoomDeferred(ei.roomId).resolve()}createGroupCallFromRoomStateEvent(ei){let eo;let ea=ei.getRoomId(),ec=ei.getContent(),ed=this.client.getRoom(ea);if(!ed){ep.logger.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=${ea})`);return}let eu=ei.getStateKey(),ef=ec["m.type"];if(!Object.values(eh.GroupCallType).includes(ef)){ep.logger.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=${ef}, roomId=${ea})`);return}let eg=ec["m.intent"];if(!Object.values(eh.GroupCallIntent).includes(eg)){ep.logger.warn(`Received invalid group call intent (type=${ef}, roomId=${ea})`);return}let em=!!ec["io.element.ptt"];if(null!=ec&&ec.dataChannelsEnabled&&null!=ec&&ec.dataChannelOptions){let{ordered:ei,maxPacketLifeTime:ea,maxRetransmits:ed,protocol:eu}=ec.dataChannelOptions;eo={ordered:ei,maxPacketLifeTime:ea,maxRetransmits:ed,protocol:eu}}let eb=new eh.GroupCall(this.client,ed,ef,em,eg,eu,(null==ec?void 0:ec.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,eo,this.client.isVoipWithNoMediaAllowed);return this.groupCalls.set(ed.roomId,eb),this.client.emit(ey.Incoming,eb),eb}}eo.GroupCallEventHandler=eb},7626:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MediaHandlerEvent=eo.MediaHandler=void 0;var ed=ec(ea(8416)),eu=ea(5861),eh=ea(8969),ef=ea(7434);let ep=function(ei){return ei.LocalStreamsChanged="local_streams_changed",ei}({});eo.MediaHandlerEvent=ep;class eg extends eu.TypedEventEmitter{constructor(ei){super(),this.client=ei,(0,ed.default)(this,"audioInput",void 0),(0,ed.default)(this,"audioSettings",void 0),(0,ed.default)(this,"videoInput",void 0),(0,ed.default)(this,"localUserMediaStream",void 0),(0,ed.default)(this,"userMediaStreams",[]),(0,ed.default)(this,"screensharingStreams",[]),(0,ed.default)(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(ei,eo){this.audioInput=ei,this.videoInput=eo}async setAudioInput(ei){ef.logger.info(`MediaHandler setAudioInput() running (deviceId=${ei})`),this.audioInput!==ei&&(this.audioInput=ei,await this.updateLocalUsermediaStreams())}async setAudioSettings(ei){ef.logger.info(`MediaHandler setAudioSettings() running (opts=${JSON.stringify(ei)})`),this.audioSettings=Object.assign({},ei),await this.updateLocalUsermediaStreams()}async setVideoInput(ei){ef.logger.info(`MediaHandler setVideoInput() running (deviceId=${ei})`),this.videoInput!==ei&&(this.videoInput=ei,await this.updateLocalUsermediaStreams())}async setMediaInputs(ei,eo){ef.logger.log(`MediaHandler setMediaInputs() running (audioInput: ${ei} videoInput: ${eo})`),this.audioInput=ei,this.videoInput=eo,await this.updateLocalUsermediaStreams()}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;let ei=new Map;for(let eo of this.client.callEventHandler.calls.values())ei.set(eo.callId,{audio:eo.hasLocalUserMediaAudioTrack,video:eo.hasLocalUserMediaVideoTrack});for(let ei of this.userMediaStreams)for(let eo of(ef.logger.log(`MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=${ei.id})`),ei.getTracks()))eo.stop();for(let eo of(this.userMediaStreams=[],this.localUserMediaStream=void 0,this.client.callEventHandler.calls.values())){if(eo.callHasEnded()||!ei.has(eo.callId))continue;let{audio:ea,video:ec}=ei.get(eo.callId);ef.logger.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=${eo.callId})`);let ed=await this.getUserMediaStream(ea,ec);eo.callHasEnded()||await eo.updateLocalUsermediaStream(ed)}for(let ei of this.client.groupCallEventHandler.groupCalls.values()){if(!ei.localCallFeed)continue;ef.logger.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=${ei.groupCallId})`);let eo=await this.getUserMediaStream(!0,ei.type===eh.GroupCallType.Video);ei.state!==eh.GroupCallState.Ended&&await ei.updateLocalUsermediaStream(eo)}this.emit(ep.LocalStreamsChanged)}async hasAudioDevice(){try{let ei=await navigator.mediaDevices.enumerateDevices();return ei.filter(ei=>"audioinput"===ei.kind).length>0}catch(ei){return ef.logger.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",ei),!1}}async hasVideoDevice(){try{let ei=await navigator.mediaDevices.enumerateDevices();return ei.filter(ei=>"videoinput"===ei.kind).length>0}catch(ei){return ef.logger.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",ei),!1}}async getUserMediaStream(ei,eo,ea=!0){return this.getMediaStreamPromise?this.getMediaStreamPromise=this.getMediaStreamPromise.then(()=>this.getUserMediaStreamInternal(ei,eo,ea)):this.getMediaStreamPromise=this.getUserMediaStreamInternal(ei,eo,ea),this.getMediaStreamPromise}async getUserMediaStreamInternal(ei,eo,ea){var ec,ed,eu,eh,eg;let em;let ey=ei&&await this.hasAudioDevice(),eb=eo&&await this.hasVideoDevice(),eS=!0;if(this.localUserMediaStream?(ey!==this.localUserMediaStream.getAudioTracks().length>0&&(eS=!1),eb!==this.localUserMediaStream.getVideoTracks().length>0&&(eS=!1),ey&&(null===(ec=this.localUserMediaStream.getAudioTracks()[0])||void 0===ec?void 0:null===(ed=ec.getSettings())||void 0===ed?void 0:ed.deviceId)!==this.audioInput&&(eS=!1),eb&&(null===(eu=this.localUserMediaStream.getVideoTracks()[0])||void 0===eu?void 0:null===(eh=eu.getSettings())||void 0===eh?void 0:eh.deviceId)!==this.videoInput&&(eS=!1)):eS=!1,eS){if(em=this.localUserMediaStream.clone(),ef.logger.log(`MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=${null===(eg=this.localUserMediaStream)||void 0===eg?void 0:eg.id} newStreamId=${em.id} shouldRequestAudio=${ey} shouldRequestVideo=${eb})`),!ey)for(let ei of em.getAudioTracks())em.removeTrack(ei);if(!eb)for(let ei of em.getVideoTracks())em.removeTrack(ei)}else{let ei=this.getUserMediaContraints(ey,eb);for(let eo of(em=await navigator.mediaDevices.getUserMedia(ei),ef.logger.log(`MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=${em.id}, shouldRequestAudio=${ey}, shouldRequestVideo=${eb}, constraints=${JSON.stringify(ei)})`),em.getTracks())){let ei=eo.getSettings();"audio"===eo.kind?this.audioInput=ei.deviceId:"video"===eo.kind&&(this.videoInput=ei.deviceId)}ea&&(this.localUserMediaStream=em)}return ea&&this.userMediaStreams.push(em),this.emit(ep.LocalStreamsChanged),em}stopUserMediaStream(ei){for(let eo of(ef.logger.log(`MediaHandler stopUserMediaStream() stopping (streamId=${ei.id})`),ei.getTracks()))eo.stop();let eo=this.userMediaStreams.indexOf(ei);-1!==eo&&(ef.logger.debug(`MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=${ei.id})`,ei.id),this.userMediaStreams.splice(eo,1)),this.emit(ep.LocalStreamsChanged),this.localUserMediaStream===ei&&(this.localUserMediaStream=void 0)}async getScreensharingStream(ei={},eo=!0){let ea;if(0===this.screensharingStreams.length){let eo=this.getScreenshareContraints(ei);ei.desktopCapturerSourceId?(ef.logger.debug(`MediaHandler getScreensharingStream() calling getUserMedia() (opts=${JSON.stringify(ei)})`),ea=await navigator.mediaDevices.getUserMedia(eo)):(ef.logger.debug(`MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=${JSON.stringify(ei)})`),ea=await navigator.mediaDevices.getDisplayMedia(eo))}else{let ei=this.screensharingStreams[this.screensharingStreams.length-1];ef.logger.log(`MediaHandler getScreensharingStream() cloning (streamId=${ei.id})`),ea=ei.clone()}return eo&&this.screensharingStreams.push(ea),this.emit(ep.LocalStreamsChanged),ea}stopScreensharingStream(ei){for(let eo of(ef.logger.debug(`MediaHandler stopScreensharingStream() stopping stream (streamId=${ei.id})`),ei.getTracks()))eo.stop();let eo=this.screensharingStreams.indexOf(ei);-1!==eo&&(ef.logger.debug(`MediaHandler stopScreensharingStream() splicing stream out (streamId=${ei.id})`),this.screensharingStreams.splice(eo,1)),this.emit(ep.LocalStreamsChanged)}stopAllStreams(){for(let ei of this.userMediaStreams)for(let eo of(ef.logger.log(`MediaHandler stopAllStreams() stopping (streamId=${ei.id})`),ei.getTracks()))eo.stop();for(let ei of this.screensharingStreams)for(let eo of ei.getTracks())eo.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(ep.LocalStreamsChanged)}getUserMediaContraints(ei,eo){let ea=!!navigator.webkitGetUserMedia;return{audio:!!ei&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0},video:!!eo&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:ea?{exact:640}:{ideal:640},height:ea?{exact:360}:{ideal:360}}}}getScreenshareContraints(ei){let{desktopCapturerSourceId:eo,audio:ea}=ei;return eo?{audio:null!=ea&&ea,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:eo}}}:{audio:null!=ea&&ea,video:!0}}}eo.MediaHandler=eg},476:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.ConnectionStats=void 0;var ed=ec(ea(8416));class eu{constructor(){(0,ed.default)(this,"bandwidth",{}),(0,ed.default)(this,"bitrate",{}),(0,ed.default)(this,"packetLoss",{}),(0,ed.default)(this,"transport",[])}}eo.ConnectionStats=eu},1621:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.ConnectionStatsReporter=void 0;class ea{static buildBandwidthReport(ei){let eo=ei.availableIncomingBitrate,ea=ei.availableOutgoingBitrate;return{download:eo?Math.round(eo/1e3):0,upload:ea?Math.round(ea/1e3):0}}}eo.ConnectionStatsReporter=ea},4987:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.GroupCallStats=void 0;var ed=ec(ea(8416)),eu=ea(2622),eh=ea(9155),ef=ea(6817);class ep{constructor(ei,eo,ea=1e4){this.groupCallId=ei,this.userId=eo,this.interval=ea,(0,ed.default)(this,"timer",void 0),(0,ed.default)(this,"gatherers",new Map),(0,ed.default)(this,"reports",new eh.StatsReportEmitter),(0,ed.default)(this,"summaryStatsReporter",new ef.SummaryStatsReporter(this.reports))}start(){void 0===this.timer&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){void 0!==this.timer&&(clearInterval(this.timer),this.gatherers.forEach(ei=>ei.stopProcessingStats()))}hasStatsReportGatherer(ei){return this.gatherers.has(ei)}addStatsReportGatherer(ei,eo,ea){return!this.hasStatsReportGatherer(ei)&&(this.gatherers.set(ei,new eu.StatsReportGatherer(ei,eo,ea,this.reports)),!0)}removeStatsReportGatherer(ei){return this.gatherers.delete(ei)}getStatsReportGatherer(ei){return this.hasStatsReportGatherer(ei)?this.gatherers.get(ei):void 0}processStats(){let ei=[];this.gatherers.forEach(eo=>{ei.push(eo.processStats(this.groupCallId,this.userId))}),Promise.all(ei).then(ei=>this.summaryStatsReporter.build(ei))}}eo.GroupCallStats=ep},8563:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MediaSsrcHandler=void 0;var ed=ec(ea(8416)),eu=ea(766);class eh{constructor(){(0,ed.default)(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(ei,eo){let ea;return this.ssrcToMid[eo].forEach((eo,ec)=>{if(eo.find(eo=>eo==ei)){ea=ec;return}}),ea}parse(ei,eo){let ea=(0,eu.parse)(ei),ec=new Map;ea.media.forEach(ei=>{if(ei.mid&&"video"===ei.type||"audio"===ei.type){var eo;let ea=[];null===(eo=ei.ssrcs)||void 0===eo||eo.forEach(ei=>{"cname"===ei.attribute&&ea.push(`${ei.id}`)}),ec.set(`${ei.mid}`,ea)}}),this.ssrcToMid[eo]=ec}getSsrcToMidMap(ei){return this.ssrcToMid[ei]}}eo.MediaSsrcHandler=eh},9972:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.MediaTrackHandler=void 0;class ea{constructor(ei){this.pc=ei}getLocalTracks(ei){let eo=eo=>null!==eo&&eo.kind===ei;return this.pc.getTransceivers().filter(ei=>"sendonly"===ei.currentDirection||"sendrecv"===ei.currentDirection).filter(ei=>null!==ei.sender).map(ei=>ei.sender).map(ei=>ei.track).filter(eo)}getTackById(ei){return this.pc.getTransceivers().map(eo=>(null==eo?void 0:eo.sender.track)!==null&&eo.sender.track.id===ei?eo.sender.track:(null==eo?void 0:eo.receiver.track)!==null&&eo.receiver.track.id===ei?eo.receiver.track:void 0).find(ei=>void 0!==ei)}getLocalTrackIdByMid(ei){let eo=this.pc.getTransceivers().find(eo=>eo.mid===ei);if(void 0!==eo&&eo.sender&&eo.sender.track)return eo.sender.track.id}getRemoteTrackIdByMid(ei){let eo=this.pc.getTransceivers().find(eo=>eo.mid===ei);if(void 0!==eo&&eo.receiver&&eo.receiver.track)return eo.receiver.track.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(ei){return this.pc.getTransceivers().find(eo=>eo.receiver.track.id===ei||null!==eo.sender.track&&eo.sender.track.id===ei)}}eo.MediaTrackHandler=ea},8854:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MediaTrackStats=void 0;var ed=ec(ea(8416));class eu{constructor(ei,eo,ea){this.trackId=ei,this.type=eo,this.kind=ea,(0,ed.default)(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),(0,ed.default)(this,"bitrate",{download:0,upload:0}),(0,ed.default)(this,"resolution",{width:-1,height:-1}),(0,ed.default)(this,"framerate",0),(0,ed.default)(this,"jitter",0),(0,ed.default)(this,"codec",""),(0,ed.default)(this,"isAlive",!0),(0,ed.default)(this,"isMuted",!1),(0,ed.default)(this,"isEnabled",!0)}getType(){return this.type}setLoss(ei){this.loss=ei}getLoss(){return this.loss}setResolution(ei){this.resolution=ei}getResolution(){return this.resolution}setFramerate(ei){this.framerate=ei}getFramerate(){return this.framerate}setBitrate(ei){this.bitrate=ei}getBitrate(){return this.bitrate}setCodec(ei){return this.codec=ei,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(ei){this.isAlive=ei}get alive(){return this.isAlive}set muted(ei){this.isMuted=ei}get muted(){return this.isMuted}set enabled(ei){this.isEnabled=ei}get enabled(){return this.isEnabled}setJitter(ei){this.jitter=ei}getJitter(){return this.jitter}}eo.MediaTrackStats=eu},4731:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.MediaTrackStatsHandler=void 0;var ed=ec(ea(8416)),eu=ea(8854);class eh{constructor(ei,eo){this.mediaSsrcHandler=ei,this.mediaTrackHandler=eo,(0,ed.default)(this,"track2stats",new Map)}findTrack2Stats(ei,eo){let ea;if(ei.trackIdentifier)ea=ei.trackIdentifier;else if(ei.mid)ea="remote"===eo?this.mediaTrackHandler.getRemoteTrackIdByMid(ei.mid):this.mediaTrackHandler.getLocalTrackIdByMid(ei.mid);else if(ei.ssrc){let ec=this.mediaSsrcHandler.findMidBySsrc(ei.ssrc,eo);if(!ec)return;ea="remote"===eo?this.mediaTrackHandler.getRemoteTrackIdByMid(ei.mid):this.mediaTrackHandler.getLocalTrackIdByMid(ei.mid)}if(!ea)return;let ec=this.track2stats.get(ea);if(!ec){let ei=this.mediaTrackHandler.getTackById(ea);if(void 0===ei)return;{let ed="audio"===ei.kind?ei.kind:"video";ec=new eu.MediaTrackStats(ea,eo,ed),this.track2stats.set(ea,ec)}}return ec}findLocalVideoTrackStats(ei){let eo=this.mediaTrackHandler.getLocalTracks("video");if(0!==eo.length)return this.findTrack2Stats(ei,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(ei){return this.mediaTrackHandler.getTransceiverByTrackId(ei)}}eo.MediaTrackStatsHandler=eh},930:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.StatsReport=void 0;let ea=function(ei){return ei.CONNECTION_STATS="StatsReport.connection_stats",ei.BYTE_SENT_STATS="StatsReport.byte_sent_stats",ei.SUMMARY_STATS="StatsReport.summary_stats",ei}({});eo.StatsReport=ea},3134:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.StatsReportBuilder=void 0;class ea{static build(ei){let eo={},ec={download:0,upload:0},ed={download:0,upload:0},eu=0,eh=0,ef={local:new Map,remote:new Map},ep={local:new Map,remote:new Map},eg={local:new Map,remote:new Map},em=new Map,ey=0,eb=0,eS=0,eE=0;for(let[eo,ea]of ei){let ei=ea.getLoss(),ew=ei.isDownloadStream?"download":"upload";ec[ew]+=ei.packetsTotal,ed[ew]+=ei.packetsLost,eu+=ea.getBitrate().download,eh+=ea.getBitrate().upload,"audio"===ea.kind?(ey+=ea.getBitrate().download,eb+=ea.getBitrate().upload):(eS+=ea.getBitrate().download,eE+=ea.getBitrate().upload),ef[ea.getType()].set(eo,ea.getResolution()),ep[ea.getType()].set(eo,ea.getFramerate()),eg[ea.getType()].set(eo,ea.getCodec()),"remote"===ea.getType()&&em.set(eo,ea.getJitter()),ea.resetBitrate()}return eo.bitrate={upload:eh,download:eu},eo.bitrate.audio={upload:eb,download:ey},eo.bitrate.video={upload:eE,download:eS},eo.packetLoss={total:ea.calculatePacketLoss(ed.download+ed.upload,ec.download+ec.upload),download:ea.calculatePacketLoss(ed.download,ec.download),upload:ea.calculatePacketLoss(ed.upload,ec.upload)},eo.framerate=ep,eo.resolution=ef,eo.codec=eg,eo.jitter=em,eo}static calculatePacketLoss(ei,eo){return!eo||eo<=0||!ei||ei<=0?0:Math.round(ei/eo*100)}}eo.StatsReportBuilder=ea},9155:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.StatsReportEmitter=void 0;var ec=ea(5861),ed=ea(930);class eu extends ec.TypedEventEmitter{emitByteSendReport(ei){this.emit(ed.StatsReport.BYTE_SENT_STATS,ei)}emitConnectionStatsReport(ei){this.emit(ed.StatsReport.CONNECTION_STATS,ei)}emitSummaryStatsReport(ei){this.emit(ed.StatsReport.SUMMARY_STATS,ei)}}eo.StatsReportEmitter=eu},2622:function(ei,eo,ea){"use strict";var ec=ea(4836);Object.defineProperty(eo,"__esModule",{value:!0}),eo.StatsReportGatherer=void 0;var ed=ec(ea(8416)),eu=ea(476),eh=ea(1621),ef=ea(9716),ep=ea(8563),eg=ea(9972),em=ea(4731),ey=ea(7868),eb=ea(3134),eS=ea(789);function eE(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ew(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eE(Object(ea),!0).forEach(function(eo){(0,ed.default)(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eE(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}class e_{constructor(ei,eo,ea,ec,eh=!0){this.callId=ei,this.remoteUserId=eo,this.pc=ea,this.emitter=ec,this.isFocus=eh,(0,ed.default)(this,"isActive",!0),(0,ed.default)(this,"previousStatsReport",void 0),(0,ed.default)(this,"currentStatsReport",void 0),(0,ed.default)(this,"connectionStats",new eu.ConnectionStats),(0,ed.default)(this,"trackStats",void 0),ea.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new em.MediaTrackStatsHandler(new ep.MediaSsrcHandler,new eg.MediaTrackHandler(ea))}async processStats(ei,eo){let ea={receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0},videoTrackSummary:{count:0,muted:0}};if(this.isActive){let ec=this.pc.getStats();if("function"==typeof(null==ec?void 0:ec.then))return ec.then(ec=>{var ed,eu;this.currentStatsReport="function"==typeof(null==ec?void 0:ec.result)?ec.result():ec;try{this.processStatsReport(ei,eo)}catch(ei){return this.isActive=!1,ea}this.previousStatsReport=this.currentStatsReport,ea.receivedMedia=this.connectionStats.bitrate.download,ea.receivedAudioMedia=(null===(ed=this.connectionStats.bitrate.audio)||void 0===ed?void 0:ed.download)||0,ea.receivedVideoMedia=(null===(eu=this.connectionStats.bitrate.video)||void 0===eu?void 0:eu.download)||0;let eh=ey.TrackStatsReporter.buildTrackSummary(Array.from(this.trackStats.getTrack2stats().values()));return ew(ew({},ea),{},{audioTrackSummary:eh.audioTrackSummary,videoTrackSummary:eh.videoTrackSummary})}).catch(ei=>(this.handleError(ei),ea));this.isActive=!1}return Promise.resolve(ea)}processStatsReport(ei,eo){var ea;let ec=new Map;null===(ea=this.currentStatsReport)||void 0===ea||ea.forEach(ei=>{let eo=this.previousStatsReport?this.previousStatsReport.get(ei.id):null;if("candidate-pair"===ei.type&&ei.nominated&&"succeeded"===ei.state)this.connectionStats.bandwidth=eh.ConnectionStatsReporter.buildBandwidthReport(ei),this.connectionStats.transport=ef.TransportStatsReporter.buildReport(this.currentStatsReport,ei,this.connectionStats.transport,this.isFocus);else if("inbound-rtp"===ei.type||"outbound-rtp"===ei.type){let ea=this.trackStats.findTrack2Stats(ei,"inbound-rtp"===ei.type?"remote":"local");if(!ea)return;if(eo&&ey.TrackStatsReporter.buildPacketsLost(ea,ei,eo),"inbound-rtp"===ei.type){ey.TrackStatsReporter.buildFramerateResolution(ea,ei),eo&&ey.TrackStatsReporter.buildBitrateReceived(ea,ei,eo);let ec=this.trackStats.findTransceiverByTrackId(ea.trackId);ey.TrackStatsReporter.setTrackStatsState(ea,ec),ey.TrackStatsReporter.buildJitter(ea,ei)}else eo&&(ec.set(ea.trackId,eS.StatsValueFormatter.getNonNegativeValue(ei.bytesSent)),ey.TrackStatsReporter.buildBitrateSend(ea,ei,eo));ey.TrackStatsReporter.buildCodec(this.currentStatsReport,ea,ei)}else if("track"===ei.type&&"video"===ei.kind&&!ei.remoteSource){let ea=this.trackStats.findLocalVideoTrackStats(ei);if(!ea)return;ey.TrackStatsReporter.buildFramerateResolution(ea,ei),ey.TrackStatsReporter.calculateSimulcastFramerate(ea,ei,eo,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(ec),this.processAndEmitReport()}setActive(ei){this.isActive=ei}getActive(){return this.isActive}handleError(ei){this.isActive=!1}processAndEmitReport(){let ei=eb.StatsReportBuilder.build(this.trackStats.getTrack2stats());this.connectionStats.bandwidth=ei.bandwidth,this.connectionStats.bitrate=ei.bitrate,this.connectionStats.packetLoss=ei.packetLoss,this.emitter.emitConnectionStatsReport(ew(ew({},ei),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){"stable"===this.pc.signalingState&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}}eo.StatsReportGatherer=e_},789:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.StatsValueFormatter=void 0;class ea{static getNonNegativeValue(ei){let eo=ei;return("number"!=typeof eo&&(eo=Number(eo)),isNaN(eo))?0:Math.max(0,eo)}}eo.StatsValueFormatter=ea},6817:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.SummaryStatsReporter=void 0;class ea{constructor(ei){this.emitter=ei}build(ei){let eo=ei.length;if(0===eo)return;let ea=0,ec=0,ed=0;ei.forEach(ei=>{let eo=!1,eu=!1;ei.receivedAudioMedia>0&&(ed++,eo=!0),ei.receivedVideoMedia>0?(ec++,eu=!0):ei.videoTrackSummary.muted>0&&ei.videoTrackSummary.muted===ei.videoTrackSummary.count&&(ec++,eu=!0),ei.receivedMedia>0&&eu&&eo&&ea++});let eu={percentageReceivedMedia:Math.round(ea/eo*100)/100,percentageReceivedVideoMedia:Math.round(ec/eo*100)/100,percentageReceivedAudioMedia:Math.round(ed/eo*100)/100};this.emitter.emitSummaryStatsReport(eu)}}eo.SummaryStatsReporter=ea},7868:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.TrackStatsReporter=void 0;var ec=ea(789);class ed{static buildFramerateResolution(ei,eo){let ea={height:eo.frameHeight,width:eo.frameWidth},ec=eo.framesPerSecond;ea.height&&ea.width&&ei.setResolution(ea),ei.setFramerate(Math.round(ec||0))}static calculateSimulcastFramerate(ei,eo,ea,ec){let ed=ei.getFramerate();if(!ed){if(ea){let ei=eo.timestamp-ea.timestamp;if(ei>0&&eo.framesSent){let ec=eo.framesSent-ea.framesSent;ed=ec/ei*1e3}}if(!ed)return}ed=ec?Math.round(ed/ec):0,ei.setFramerate(ed)}static buildCodec(ei,eo,ea){let ec=null==ei?void 0:ei.get(ea.codecId);if(ec){let ei=ec.mimeType.split("/")[1];ei&&eo.setCodec(ei)}}static buildBitrateReceived(ei,eo,ea){ei.setBitrate({download:ed.calculateBitrate(eo.bytesReceived,ea.bytesReceived,eo.timestamp,ea.timestamp),upload:0})}static buildBitrateSend(ei,eo,ea){ei.setBitrate({download:0,upload:this.calculateBitrate(eo.bytesSent,ea.bytesSent,eo.timestamp,ea.timestamp)})}static buildPacketsLost(ei,eo,ea){let ed="outbound-rtp"===eo.type?"packetsSent":"packetsReceived",eu=eo[ed];(!eu||eu<0)&&(eu=0);let eh=ec.StatsValueFormatter.getNonNegativeValue(ea[ed]),ef=Math.max(0,eu-eh),ep=ec.StatsValueFormatter.getNonNegativeValue(eo.packetsLost),eg=ec.StatsValueFormatter.getNonNegativeValue(ea.packetsLost),em=Math.max(0,ep-eg);ei.setLoss({packetsTotal:ef+em,packetsLost:em,isDownloadStream:"outbound-rtp"!==eo.type})}static calculateBitrate(ei,eo,ea,ed){let eu=ec.StatsValueFormatter.getNonNegativeValue(ei),eh=ec.StatsValueFormatter.getNonNegativeValue(eo),ef=Math.max(0,eu-eh),ep=ea-ed,eg=0;return ep>0&&(eg=Math.round(8*ef/ep)),eg}static setTrackStatsState(ei,eo){var ea;if(void 0===eo){ei.alive=!1;return}let ec="remote"===ei.getType()?eo.receiver.track:null==eo?void 0:null===(ea=eo.sender)||void 0===ea?void 0:ea.track;if(null==ec||"ended"===ec.readyState){ei.alive=!1;return}ei.muted=ec.muted,ei.enabled=ec.enabled,ei.alive=!0}static buildTrackSummary(ei){let eo={count:0,muted:0},ea={count:0,muted:0};return ei.filter(ei=>"remote"===ei.getType()).forEach(ei=>{let ec="video"===ei.kind?ea:eo;ec.count++,ei.alive&&ei.muted&&ec.muted++}),{audioTrackSummary:eo,videoTrackSummary:ea}}static buildJitter(ei,eo){if("inbound-rtp"!==eo.type)return;let ea=null==eo?void 0:eo.jitter;if(void 0!==ea){let eo=ec.StatsValueFormatter.getNonNegativeValue(ea);ei.setJitter(Math.round(1e3*eo))}else ei.setJitter(-1)}}eo.TrackStatsReporter=ed},9716:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.TransportStatsReporter=void 0;class ea{static buildReport(ei,eo,ea,ec){let ed=null==ei?void 0:ei.get(eo.localCandidateId),eu=null==ei?void 0:ei.get(eo.remoteCandidateId);if(eu&&ed){let ei=void 0!==eu.ip?eu.ip:eu.address,eh=eu.port,ef=`${ei}:${eh}`,ep=void 0!==ed.ip?ed.ip:ed.address,eg=ed.port,em=`${ep}:${eg}`,ey=eu.protocol;ea.some(ei=>ei.ip===ef&&ei.type===ey&&ei.localIp===em)||ea.push({ip:ef,type:ey,localIp:em,isFocus:ec,localCandidateType:ed.candidateType,remoteCandidateType:eu.candidateType,networkType:ed.networkType,rtt:eo.currentRoundTripTime?1e3*eo.currentRoundTripTime:NaN})}return ea}}eo.TransportStatsReporter=ea},7779:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.ClientWidgetApi=void 0;var ec=ea(7187),ed=ea(9843),eu=ea(5206),eh=ea(2047),ef=ea(2646),ep=ea(6376),eg=ea(6005),em=ea(4693),ey=ea(8793),eb=ea(4963);function eS(ei){return(eS="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function eE(){eE=function(){return ei};var ei={},eo=Object.prototype,ea=eo.hasOwnProperty,ec=Object.defineProperty||function(ei,eo,ea){ei[eo]=ea.value},ed="function"==typeof Symbol?Symbol:{},eu=ed.iterator||"@@iterator",eh=ed.asyncIterator||"@@asyncIterator",ef=ed.toStringTag||"@@toStringTag";function ep(ei,eo,ea){return Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}),ei[eo]}try{ep({},"")}catch(ei){ep=function(ei,eo,ea){return ei[eo]=ea}}function eg(ei,eo,ea,ed){var eu=Object.create((eo&&eo.prototype instanceof eb?eo:eb).prototype);return ec(eu,"_invoke",{value:eM(ei,ea,new ej(ed||[]))}),eu}function em(ei,eo,ea){try{return{type:"normal",arg:ei.call(eo,ea)}}catch(ei){return{type:"throw",arg:ei}}}ei.wrap=eg;var ey={};function eb(){}function ew(){}function e_(){}var eT={};ep(eT,eu,function(){return this});var eI=Object.getPrototypeOf,eC=eI&&eI(eI(eL([])));eC&&eC!==eo&&ea.call(eC,eu)&&(eT=eC);var eO=e_.prototype=eb.prototype=Object.create(eT);function eR(ei){["next","throw","return"].forEach(function(eo){ep(ei,eo,function(ei){return this._invoke(eo,ei)})})}function ek(ei,eo){var ed;function eu(ec,ed,eh,ef){var ep=em(ei[ec],ei,ed);if("throw"!==ep.type){var eg=ep.arg,ey=eg.value;return ey&&"object"==eS(ey)&&ea.call(ey,"__await")?eo.resolve(ey.__await).then(function(ei){eu("next",ei,eh,ef)},function(ei){eu("throw",ei,eh,ef)}):eo.resolve(ey).then(function(ei){eg.value=ei,eh(eg)},function(ei){return eu("throw",ei,eh,ef)})}ef(ep.arg)}ec(this,"_invoke",{value:function(ei,ea){function ec(){return new eo(function(eo,ec){eu(ei,ea,eo,ec)})}return ed=ed?ed.then(ec,ec):ec()}})}function eM(ei,eo,ea){var ec="suspendedStart";return function(ed,eu){if("executing"===ec)throw Error("Generator is already running");if("completed"===ec){if("throw"===ed)throw eu;return eN()}for(ea.method=ed,ea.arg=eu;;){var eh=ea.delegate;if(eh){var ef=eP(eh,ea);if(ef){if(ef===ey)continue;return ef}}if("next"===ea.method)ea.sent=ea._sent=ea.arg;else if("throw"===ea.method){if("suspendedStart"===ec)throw ec="completed",ea.arg;ea.dispatchException(ea.arg)}else"return"===ea.method&&ea.abrupt("return",ea.arg);ec="executing";var ep=em(ei,eo,ea);if("normal"===ep.type){if(ec=ea.done?"completed":"suspendedYield",ep.arg===ey)continue;return{value:ep.arg,done:ea.done}}"throw"===ep.type&&(ec="completed",ea.method="throw",ea.arg=ep.arg)}}}function eP(ei,eo){var ea=eo.method,ec=ei.iterator[ea];if(void 0===ec)return eo.delegate=null,"throw"===ea&&ei.iterator.return&&(eo.method="return",eo.arg=void 0,eP(ei,eo),"throw"===eo.method)||"return"!==ea&&(eo.method="throw",eo.arg=TypeError("The iterator does not provide a '"+ea+"' method")),ey;var ed=em(ec,ei.iterator,eo.arg);if("throw"===ed.type)return eo.method="throw",eo.arg=ed.arg,eo.delegate=null,ey;var eu=ed.arg;return eu?eu.done?(eo[ei.resultName]=eu.value,eo.next=ei.nextLoc,"return"!==eo.method&&(eo.method="next",eo.arg=void 0),eo.delegate=null,ey):eu:(eo.method="throw",eo.arg=TypeError("iterator result is not an object"),eo.delegate=null,ey)}function eA(ei){var eo={tryLoc:ei[0]};1 in ei&&(eo.catchLoc=ei[1]),2 in ei&&(eo.finallyLoc=ei[2],eo.afterLoc=ei[3]),this.tryEntries.push(eo)}function eD(ei){var eo=ei.completion||{};eo.type="normal",delete eo.arg,ei.completion=eo}function ej(ei){this.tryEntries=[{tryLoc:"root"}],ei.forEach(eA,this),this.reset(!0)}function eL(ei){if(ei){var eo=ei[eu];if(eo)return eo.call(ei);if("function"==typeof ei.next)return ei;if(!isNaN(ei.length)){var ec=-1,ed=function eo(){for(;++ec<ei.length;)if(ea.call(ei,ec))return eo.value=ei[ec],eo.done=!1,eo;return eo.value=void 0,eo.done=!0,eo};return ed.next=ed}}return{next:eN}}function eN(){return{value:void 0,done:!0}}return ew.prototype=e_,ec(eO,"constructor",{value:e_,configurable:!0}),ec(e_,"constructor",{value:ew,configurable:!0}),ew.displayName=ep(e_,ef,"GeneratorFunction"),ei.isGeneratorFunction=function(ei){var eo="function"==typeof ei&&ei.constructor;return!!eo&&(eo===ew||"GeneratorFunction"===(eo.displayName||eo.name))},ei.mark=function(ei){return Object.setPrototypeOf?Object.setPrototypeOf(ei,e_):(ei.__proto__=e_,ep(ei,ef,"GeneratorFunction")),ei.prototype=Object.create(eO),ei},ei.awrap=function(ei){return{__await:ei}},eR(ek.prototype),ep(ek.prototype,eh,function(){return this}),ei.AsyncIterator=ek,ei.async=function(eo,ea,ec,ed,eu){void 0===eu&&(eu=Promise);var eh=new ek(eg(eo,ea,ec,ed),eu);return ei.isGeneratorFunction(ea)?eh:eh.next().then(function(ei){return ei.done?ei.value:eh.next()})},eR(eO),ep(eO,ef,"Generator"),ep(eO,eu,function(){return this}),ep(eO,"toString",function(){return"[object Generator]"}),ei.keys=function(ei){var eo=Object(ei),ea=[];for(var ec in eo)ea.push(ec);return ea.reverse(),function ei(){for(;ea.length;){var ec=ea.pop();if(ec in eo)return ei.value=ec,ei.done=!1,ei}return ei.done=!0,ei}},ei.values=eL,ej.prototype={constructor:ej,reset:function(ei){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(eD),!ei)for(var eo in this)"t"===eo.charAt(0)&&ea.call(this,eo)&&!isNaN(+eo.slice(1))&&(this[eo]=void 0)},stop:function(){this.done=!0;var ei=this.tryEntries[0].completion;if("throw"===ei.type)throw ei.arg;return this.rval},dispatchException:function(ei){if(this.done)throw ei;var eo=this;function ec(ea,ec){return eh.type="throw",eh.arg=ei,eo.next=ea,ec&&(eo.method="next",eo.arg=void 0),!!ec}for(var ed=this.tryEntries.length-1;ed>=0;--ed){var eu=this.tryEntries[ed],eh=eu.completion;if("root"===eu.tryLoc)return ec("end");if(eu.tryLoc<=this.prev){var ef=ea.call(eu,"catchLoc"),ep=ea.call(eu,"finallyLoc");if(ef&&ep){if(this.prev<eu.catchLoc)return ec(eu.catchLoc,!0);if(this.prev<eu.finallyLoc)return ec(eu.finallyLoc)}else if(ef){if(this.prev<eu.catchLoc)return ec(eu.catchLoc,!0)}else{if(!ep)throw Error("try statement without catch or finally");if(this.prev<eu.finallyLoc)return ec(eu.finallyLoc)}}}},abrupt:function(ei,eo){for(var ec=this.tryEntries.length-1;ec>=0;--ec){var ed=this.tryEntries[ec];if(ed.tryLoc<=this.prev&&ea.call(ed,"finallyLoc")&&this.prev<ed.finallyLoc){var eu=ed;break}}eu&&("break"===ei||"continue"===ei)&&eu.tryLoc<=eo&&eo<=eu.finallyLoc&&(eu=null);var eh=eu?eu.completion:{};return eh.type=ei,eh.arg=eo,eu?(this.method="next",this.next=eu.finallyLoc,ey):this.complete(eh)},complete:function(ei,eo){if("throw"===ei.type)throw ei.arg;return"break"===ei.type||"continue"===ei.type?this.next=ei.arg:"return"===ei.type?(this.rval=this.arg=ei.arg,this.method="return",this.next="end"):"normal"===ei.type&&eo&&(this.next=eo),ey},finish:function(ei){for(var eo=this.tryEntries.length-1;eo>=0;--eo){var ea=this.tryEntries[eo];if(ea.finallyLoc===ei)return this.complete(ea.completion,ea.afterLoc),eD(ea),ey}},catch:function(ei){for(var eo=this.tryEntries.length-1;eo>=0;--eo){var ea=this.tryEntries[eo];if(ea.tryLoc===ei){var ec=ea.completion;if("throw"===ec.type){var ed=ec.arg;eD(ea)}return ed}}throw Error("illegal catch attempt")},delegateYield:function(ei,eo,ea){return this.delegate={iterator:eL(ei),resultName:eo,nextLoc:ea},"next"===this.method&&(this.arg=void 0),ey}},ei}function ew(ei,eo,ea,ec,ed,eu,eh){try{var ef=ei[eu](eh),ep=ef.value}catch(ei){ea(ei);return}ef.done?eo(ep):Promise.resolve(ep).then(ec,ed)}function e_(ei){return function(){var eo=this,ea=arguments;return new Promise(function(ec,ed){var eu=ei.apply(eo,ea);function eh(ei){ew(eu,ec,ed,eh,ef,"next",ei)}function ef(ei){ew(eu,ec,ed,eh,ef,"throw",ei)}eh(void 0)})}}function eT(ei,eo){var ea="undefined"!=typeof Symbol&&ei[Symbol.iterator]||ei["@@iterator"];if(!ea){if(Array.isArray(ei)||(ea=eI(ei))||eo&&ei&&"number"==typeof ei.length){ea&&(ei=ea);var ec=0,ed=function(){};return{s:ed,n:function(){return ec>=ei.length?{done:!0}:{done:!1,value:ei[ec++]}},e:function(ei){throw ei},f:ed}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var eu,eh=!0,ef=!1;return{s:function(){ea=ea.call(ei)},n:function(){var ei=ea.next();return eh=ei.done,ei},e:function(ei){ef=!0,eu=ei},f:function(){try{eh||null==ea.return||ea.return()}finally{if(ef)throw eu}}}}function eI(ei,eo){if(ei){if("string"==typeof ei)return eC(ei,eo);var ea=Object.prototype.toString.call(ei).slice(8,-1);if("Object"===ea&&ei.constructor&&(ea=ei.constructor.name),"Map"===ea||"Set"===ea)return Array.from(ei);if("Arguments"===ea||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ea))return eC(ei,eo)}}function eC(ei,eo){(null==eo||eo>ei.length)&&(eo=ei.length);for(var ea=0,ec=Array(eo);ea<eo;ea++)ec[ea]=ei[ea];return ec}function eO(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eR(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eO(Object(ea),!0).forEach(function(eo){eF(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eO(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function ek(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eM(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,eK(ec.key),ec)}}function eP(ei,eo,ea){return eo&&eM(ei.prototype,eo),ea&&eM(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eA(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eD(ei,eo)}function eD(ei,eo){return(eD=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function ej(ei){var eo=eU();return function(){var ea,ec=eB(ei);if(eo){var ed=eB(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return eL(this,ea)}}function eL(ei,eo){if(eo&&("object"===eS(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eN(ei)}function eN(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function eU(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eB(ei){return(eB=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function eF(ei,eo,ea){return(eo=eK(eo))in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function eK(ei){var eo=e$(ei,"string");return"symbol"===eS(eo)?eo:String(eo)}function e$(ei,eo){if("object"!==eS(ei)||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!==eS(ec))return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}function eW(ei){var eo,ea,ec,ed=2;for("undefined"!=typeof Symbol&&(ea=Symbol.asyncIterator,ec=Symbol.iterator);ed--;){if(ea&&null!=(eo=ei[ea]))return eo.call(ei);if(ec&&null!=(eo=ei[ec]))return new eV(eo.call(ei));ea="@@asyncIterator",ec="@@iterator"}throw TypeError("Object is not async iterable")}function eV(ei){function eo(ei){if(Object(ei)!==ei)return Promise.reject(TypeError(ei+" is not an object."));var eo=ei.done;return Promise.resolve(ei.value).then(function(ei){return{value:ei,done:eo}})}return(eV=function(ei){this.s=ei,this.n=ei.next}).prototype={s:null,n:null,next:function(){return eo(this.n.apply(this.s,arguments))},return:function(ei){var ea=this.s.return;return void 0===ea?Promise.resolve({value:ei,done:!0}):eo(ea.apply(this.s,arguments))},throw:function(ei){var ea=this.s.return;return void 0===ea?Promise.reject(ei):eo(ea.apply(this.s,arguments))}},new eV(ei)}var eG=function(ei){eA(ea,ei);var eo=ej(ea);function ea(ei,ec,eh){var ef;if(ek(this,ea),(ef=eo.call(this)).widget=ei,ef.iframe=ec,ef.driver=eh,eF(eN(ef),"transport",void 0),eF(eN(ef),"contentLoadedActionSent",!1),eF(eN(ef),"allowedCapabilities",new Set),eF(eN(ef),"allowedEvents",[]),eF(eN(ef),"isStopped",!1),eF(eN(ef),"turnServers",null),!(null!=ec&&ec.contentWindow))throw Error("No iframe supplied");if(!ei)throw Error("Invalid widget");if(!eh)throw Error("Invalid driver");return ef.transport=new ed.PostmessageTransport(eu.WidgetApiDirection.ToWidget,ei.id,ec.contentWindow,window),ef.transport.targetOrigin=ei.origin,ef.transport.on("message",ef.handleMessage.bind(eN(ef))),ec.addEventListener("load",ef.onIframeLoad.bind(eN(ef))),ef.transport.start(),ef}return eP(ea,[{key:"hasCapability",value:function(ei){return this.allowedCapabilities.has(ei)}},{key:"canUseRoomTimeline",value:function(ei){return this.hasCapability("org.matrix.msc2762.timeline:".concat(eb.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(ei))}},{key:"canSendRoomEvent",value:function(ei){var eo=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(ea){return ea.matchesAsRoomEvent(eg.EventDirection.Send,ei,eo)})}},{key:"canSendStateEvent",value:function(ei,eo){return this.allowedEvents.some(function(ea){return ea.matchesAsStateEvent(eg.EventDirection.Send,ei,eo)})}},{key:"canSendToDeviceEvent",value:function(ei){return this.allowedEvents.some(function(eo){return eo.matchesAsToDeviceEvent(eg.EventDirection.Send,ei)})}},{key:"canReceiveRoomEvent",value:function(ei){var eo=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(ea){return ea.matchesAsRoomEvent(eg.EventDirection.Receive,ei,eo)})}},{key:"canReceiveStateEvent",value:function(ei,eo){return this.allowedEvents.some(function(ea){return ea.matchesAsStateEvent(eg.EventDirection.Receive,ei,eo)})}},{key:"canReceiveToDeviceEvent",value:function(ei){return this.allowedEvents.some(function(eo){return eo.matchesAsToDeviceEvent(eg.EventDirection.Receive,ei)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"beginCapabilities",value:function(){var ei,eo=this;this.emit("preparing"),this.transport.send(eh.WidgetApiToWidgetAction.Capabilities,{}).then(function(ea){return ei=ea.capabilities,eo.driver.validateCapabilities(new Set(ea.capabilities))}).then(function(ea){console.log("Widget ".concat(eo.widget.id," is allowed capabilities:"),Array.from(ea)),eo.allowedCapabilities=ea,eo.allowedEvents=eg.WidgetEventCapability.findEventCapabilities(ea),eo.notifyCapabilities(ei),eo.emit("ready")})}},{key:"notifyCapabilities",value:function(ei){var eo=this;this.transport.send(eh.WidgetApiToWidgetAction.NotifyCapabilities,{requested:ei,approved:Array.from(this.allowedCapabilities)}).catch(function(ei){console.warn("non-fatal error notifying widget of approved capabilities:",ei)}).then(function(){eo.emit("capabilitiesNotified")})}},{key:"onIframeLoad",value:function(ei){this.widget.waitForIframeLoad?this.beginCapabilities():this.contentLoadedActionSent=!1}},{key:"handleContentLoadedAction",value:function(ei){if(this.contentLoadedActionSent)throw Error("Improper sequence: ContentLoaded Action can only be send once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(ei,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframLoad is true (default=true)"}}):(this.transport.reply(ei,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(ei){this.transport.reply(ei,{supported_versions:ep.CurrentApiVersions})}},{key:"handleCapabilitiesRenegotiate",value:function(ei){var eo,ea=this;this.transport.reply(ei,{});var ec=(null===(eo=ei.data)||void 0===eo?void 0:eo.capabilities)||[],ed=new Set(ec.filter(function(ei){return!ea.hasCapability(ei)}));if(0===ed.size)return this.notifyCapabilities([]);this.driver.validateCapabilities(ed).then(function(ei){return ei.forEach(function(ei){return ea.allowedCapabilities.add(ei)}),eg.WidgetEventCapability.findEventCapabilities(ei).forEach(function(ei){return ea.allowedEvents.push(ei)}),ea.notifyCapabilities(Array.from(ed))})}},{key:"handleNavigate",value:function(ei){var eo,ea,ec=this;if(!this.hasCapability(ef.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(ei,{error:{message:"Missing capability"}});if(!(null!==(eo=ei.data)&&void 0!==eo&&eo.uri)||!(null!==(ea=ei.data)&&void 0!==ea&&ea.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(ei,{error:{message:"Invalid matrix.to URI"}});var ed=function(eo){return console.error("[ClientWidgetApi] Failed to handle navigation: ",eo),ec.transport.reply(ei,{error:{message:"Error handling navigation"}})};try{this.driver.navigate(ei.data.uri.toString()).catch(function(ei){return ed(ei)}).then(function(){return ec.transport.reply(ei,{})})}catch(ei){return ed(ei)}}},{key:"handleOIDC",value:function(ei){var eo=this,ea=1,ec=function(ec,ed){return(ed=ed||{},ea>1)?eo.transport.send(eh.WidgetApiToWidgetAction.OpenIDCredentials,eR({state:ec,original_request_id:ei.requestId},ed)):eo.transport.reply(ei,eR({state:ec},ed))},ed=function(ed){return(console.error("[ClientWidgetApi] Failed to handle OIDC: ",ed),ea>1)?ec(em.OpenIDRequestState.Blocked):eo.transport.reply(ei,{error:{message:ed}})},eu=new ey.SimpleObservable(function(ei){if(ei.state===em.OpenIDRequestState.PendingUserConfirmation&&ea>1)return eu.close(),ed("client provided out-of-phase response to OIDC flow");if(ei.state===em.OpenIDRequestState.PendingUserConfirmation){ec(ei.state),ea++;return}return ei.state!==em.OpenIDRequestState.Allowed||ei.token?(ei.state===em.OpenIDRequestState.Blocked&&(ei.token=void 0),eu.close(),ec(ei.state,ei.token)):ed("client provided invalid OIDC token for an allowed request")});this.driver.askOpenID(eu)}},{key:"handleReadEvents",value:function(ei){var eo=this;if(!ei.data.type)return this.transport.reply(ei,{error:{message:"Invalid request - missing event type"}});if(void 0!==ei.data.limit&&(!ei.data.limit||ei.data.limit<0))return this.transport.reply(ei,{error:{message:"Invalid request - limit out of range"}});var ea=null;if(ei.data.room_ids){Array.isArray(ea=ei.data.room_ids)||(ea=[ea]);var ec,ed=eT(ea);try{for(ed.s();!(ec=ed.n()).done;){var eu=ec.value;if(!this.canUseRoomTimeline(eu))return this.transport.reply(ei,{error:{message:"Unable to access room timeline: ".concat(eu)}})}}catch(ei){ed.e(ei)}finally{ed.f()}}var eh=ei.data.limit||0,ef=Promise.resolve([]);if(void 0!==ei.data.state_key){var ep=!0===ei.data.state_key?void 0:ei.data.state_key.toString();if(!this.canReceiveStateEvent(ei.data.type,null!=ep?ep:null))return this.transport.reply(ei,{error:{message:"Cannot read state events of this type"}});ef=this.driver.readStateEvents(ei.data.type,ep,eh,ea)}else{if(!this.canReceiveRoomEvent(ei.data.type,ei.data.msgtype))return this.transport.reply(ei,{error:{message:"Cannot read room events of this type"}});ef=this.driver.readRoomEvents(ei.data.type,ei.data.msgtype,eh,ea)}return ef.then(function(ea){return eo.transport.reply(ei,{events:ea})})}},{key:"handleSendEvent",value:function(ei){var eo,ea=this;if(!ei.data.type)return this.transport.reply(ei,{error:{message:"Invalid request - missing event type"}});if(ei.data.room_id&&!this.canUseRoomTimeline(ei.data.room_id))return this.transport.reply(ei,{error:{message:"Unable to access room timeline: ".concat(ei.data.room_id)}});if(null!==ei.data.state_key&&void 0!==ei.data.state_key){if(!this.canSendStateEvent(ei.data.type,ei.data.state_key))return this.transport.reply(ei,{error:{message:"Cannot send state events of this type"}});eo=this.driver.sendEvent(ei.data.type,ei.data.content||{},ei.data.state_key,ei.data.room_id)}else{var ec=ei.data.content||{},ed=ec.msgtype;if(!this.canSendRoomEvent(ei.data.type,ed))return this.transport.reply(ei,{error:{message:"Cannot send room events of this type"}});eo=this.driver.sendEvent(ei.data.type,ec,null,ei.data.room_id)}eo.then(function(eo){return ea.transport.reply(ei,{room_id:eo.roomId,event_id:eo.eventId})}).catch(function(eo){return console.error("error sending event: ",eo),ea.transport.reply(ei,{error:{message:"Error sending event"}})})}},{key:"handleSendToDevice",value:function(){var ei=e_(eE().mark(function ei(eo){return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:if(eo.data.type){ei.next=5;break}return ei.next=3,this.transport.reply(eo,{error:{message:"Invalid request - missing event type"}});case 3:case 8:case 13:case 18:case 25:ei.next=32;break;case 5:if(eo.data.messages){ei.next=10;break}return ei.next=8,this.transport.reply(eo,{error:{message:"Invalid request - missing event contents"}});case 10:if(!("boolean"!=typeof eo.data.encrypted)){ei.next=15;break}return ei.next=13,this.transport.reply(eo,{error:{message:"Invalid request - missing encryption flag"}});case 15:if(this.canSendToDeviceEvent(eo.data.type)){ei.next=20;break}return ei.next=18,this.transport.reply(eo,{error:{message:"Cannot send to-device events of this type"}});case 20:return ei.prev=20,ei.next=23,this.driver.sendToDevice(eo.data.type,eo.data.encrypted,eo.data.messages);case 23:return ei.next=25,this.transport.reply(eo,{});case 27:return ei.prev=27,ei.t0=ei.catch(20),console.error("error sending to-device event",ei.t0),ei.next=32,this.transport.reply(eo,{error:{message:"Error sending event"}});case 32:case"end":return ei.stop()}},ei,this,[[20,27]])}));return function(eo){return ei.apply(this,arguments)}}()},{key:"pollTurnServers",value:function(){var ei=e_(eE().mark(function ei(eo,ea){var ec,ed,eu,ef,ep,eg;return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:return ei.prev=0,ei.next=3,this.transport.send(eh.WidgetApiToWidgetAction.UpdateTurnServers,ea);case 3:ec=!1,ed=!1,ei.prev=5,ef=eW(eo);case 7:return ei.next=9,ef.next();case 9:if(!(ec=!(ep=ei.sent).done)){ei.next=16;break}return eg=ep.value,ei.next=13,this.transport.send(eh.WidgetApiToWidgetAction.UpdateTurnServers,eg);case 13:ec=!1,ei.next=7;break;case 16:ei.next=22;break;case 18:ei.prev=18,ei.t0=ei.catch(5),ed=!0,eu=ei.t0;case 22:if(ei.prev=22,ei.prev=23,!(ec&&null!=ef.return)){ei.next=27;break}return ei.next=27,ef.return();case 27:if(ei.prev=27,!ed){ei.next=30;break}throw eu;case 30:return ei.finish(27);case 31:return ei.finish(22);case 32:ei.next=37;break;case 34:ei.prev=34,ei.t1=ei.catch(0),console.error("error polling for TURN servers",ei.t1);case 37:case"end":return ei.stop()}},ei,this,[[0,34],[5,18,22,32],[23,,27,31]])}));return function(eo,ea){return ei.apply(this,arguments)}}()},{key:"handleWatchTurnServers",value:function(){var ei=e_(eE().mark(function ei(eo){var ea,ec,ed,eu;return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:if(this.hasCapability(ef.MatrixCapabilities.MSC3846TurnServers)){ei.next=5;break}return ei.next=3,this.transport.reply(eo,{error:{message:"Missing capability"}});case 3:case 8:ei.next=30;break;case 5:if(!this.turnServers){ei.next=10;break}return ei.next=8,this.transport.reply(eo,{});case 10:return ei.prev=10,ea=this.driver.getTurnServers(),ei.next=14,ea.next();case 14:if(ed=(ec=ei.sent).done,eu=ec.value,!ed){ei.next=19;break}throw Error("Client refuses to provide any TURN servers");case 19:return ei.next=21,this.transport.reply(eo,{});case 21:this.pollTurnServers(ea,eu),this.turnServers=ea,ei.next=30;break;case 25:return ei.prev=25,ei.t0=ei.catch(10),console.error("error getting first TURN server results",ei.t0),ei.next=30,this.transport.reply(eo,{error:{message:"TURN servers not available"}});case 30:case"end":return ei.stop()}},ei,this,[[10,25]])}));return function(eo){return ei.apply(this,arguments)}}()},{key:"handleUnwatchTurnServers",value:function(){var ei=e_(eE().mark(function ei(eo){return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:if(this.hasCapability(ef.MatrixCapabilities.MSC3846TurnServers)){ei.next=5;break}return ei.next=3,this.transport.reply(eo,{error:{message:"Missing capability"}});case 3:case 8:ei.next=15;break;case 5:if(this.turnServers){ei.next=10;break}return ei.next=8,this.transport.reply(eo,{});case 10:return ei.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,ei.next=15,this.transport.reply(eo,{});case 15:case"end":return ei.stop()}},ei,this)}));return function(eo){return ei.apply(this,arguments)}}()},{key:"handleReadRelations",value:function(){var ei=e_(eE().mark(function ei(eo){var ea,ec,ed=this;return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:if(eo.data.event_id){ei.next=2;break}return ei.abrupt("return",this.transport.reply(eo,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(void 0!==eo.data.limit&&eo.data.limit<0)){ei.next=4;break}return ei.abrupt("return",this.transport.reply(eo,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(void 0!==eo.data.room_id&&!this.canUseRoomTimeline(eo.data.room_id))){ei.next=6;break}return ei.abrupt("return",this.transport.reply(eo,{error:{message:"Unable to access room timeline: ".concat(eo.data.room_id)}}));case 6:return ei.prev=6,ei.next=9,this.driver.readEventRelations(eo.data.event_id,eo.data.room_id,eo.data.rel_type,eo.data.event_type,eo.data.from,eo.data.to,eo.data.limit,eo.data.direction);case 9:return ec=(ea=ei.sent).chunk.filter(function(ei){return void 0!==ei.state_key?ed.canReceiveStateEvent(ei.type,ei.state_key):ed.canReceiveRoomEvent(ei.type,ei.content.msgtype)}),ei.abrupt("return",this.transport.reply(eo,{chunk:ec,prev_batch:ea.prevBatch,next_batch:ea.nextBatch}));case 14:return ei.prev=14,ei.t0=ei.catch(6),console.error("error getting the relations",ei.t0),ei.next=19,this.transport.reply(eo,{error:{message:"Unexpected error while reading relations"}});case 19:case"end":return ei.stop()}},ei,this,[[6,14]])}));return function(eo){return ei.apply(this,arguments)}}()},{key:"handleUserDirectorySearch",value:function(){var ei=e_(eE().mark(function ei(eo){var ea;return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:if(this.hasCapability(ef.MatrixCapabilities.MSC3973UserDirectorySearch)){ei.next=2;break}return ei.abrupt("return",this.transport.reply(eo,{error:{message:"Missing capability"}}));case 2:if(!("string"!=typeof eo.data.search_term)){ei.next=4;break}return ei.abrupt("return",this.transport.reply(eo,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(void 0!==eo.data.limit&&eo.data.limit<0)){ei.next=6;break}return ei.abrupt("return",this.transport.reply(eo,{error:{message:"Invalid request - limit out of range"}}));case 6:return ei.prev=6,ei.next=9,this.driver.searchUserDirectory(eo.data.search_term,eo.data.limit);case 9:return ea=ei.sent,ei.abrupt("return",this.transport.reply(eo,{limited:ea.limited,results:ea.results.map(function(ei){return{user_id:ei.userId,display_name:ei.displayName,avatar_url:ei.avatarUrl}})}));case 13:return ei.prev=13,ei.t0=ei.catch(6),console.error("error searching in the user directory",ei.t0),ei.next=18,this.transport.reply(eo,{error:{message:"Unexpected error while searching in the user directory"}});case 18:case"end":return ei.stop()}},ei,this,[[6,13]])}));return function(eo){return ei.apply(this,arguments)}}()},{key:"handleMessage",value:function(ei){if(!this.isStopped){var eo=new CustomEvent("action:".concat(ei.detail.action),{detail:ei.detail,cancelable:!0});if(this.emit("action:".concat(ei.detail.action),eo),!eo.defaultPrevented)switch(ei.detail.action){case eh.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(ei.detail);case eh.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(ei.detail);case eh.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(ei.detail);case eh.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(ei.detail);case eh.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(ei.detail);case eh.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(ei.detail);case eh.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(ei.detail);case eh.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(ei.detail);case eh.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(ei.detail);case eh.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(ei.detail);case eh.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(ei.detail);case eh.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(ei.detail);default:return this.transport.reply(ei.detail,{error:{message:"Unknown or unsupported action: "+ei.detail.action}})}}}},{key:"takeScreenshot",value:function(){return this.transport.send(eh.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(ei){return this.transport.send(eh.WidgetApiToWidgetAction.UpdateVisibility,{visible:ei})}},{key:"sendWidgetConfig",value:function(ei){return this.transport.send(eh.WidgetApiToWidgetAction.WidgetConfig,ei).then()}},{key:"notifyModalWidgetButtonClicked",value:function(ei){return this.transport.send(eh.WidgetApiToWidgetAction.ButtonClicked,{id:ei}).then()}},{key:"notifyModalWidgetClose",value:function(ei){return this.transport.send(eh.WidgetApiToWidgetAction.CloseModalWidget,ei).then()}},{key:"feedEvent",value:function(){var ei=e_(eE().mark(function ei(eo,ea){var ec;return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:if(!(eo.room_id!==ea&&!this.canUseRoomTimeline(eo.room_id))){ei.next=2;break}return ei.abrupt("return");case 2:if(!(void 0!==eo.state_key&&null!==eo.state_key)){ei.next=7;break}if(this.canReceiveStateEvent(eo.type,eo.state_key)){ei.next=5;break}return ei.abrupt("return");case 5:ei.next=9;break;case 7:if(this.canReceiveRoomEvent(eo.type,null===(ec=eo.content)||void 0===ec?void 0:ec.msgtype)){ei.next=9;break}return ei.abrupt("return");case 9:return ei.next=11,this.transport.send(eh.WidgetApiToWidgetAction.SendEvent,eo);case 11:case"end":return ei.stop()}},ei,this)}));return function(eo,ea){return ei.apply(this,arguments)}}()},{key:"feedToDevice",value:function(){var ei=e_(eE().mark(function ei(eo,ea){return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:if(!this.canReceiveToDeviceEvent(eo.type)){ei.next=3;break}return ei.next=3,this.transport.send(eh.WidgetApiToWidgetAction.SendToDevice,eR(eR({},eo),{},{encrypted:ea}));case 3:case"end":return ei.stop()}},ei,this)}));return function(eo,ea){return ei.apply(this,arguments)}}()}]),ea}(ec.EventEmitter);eo.ClientWidgetApi=eG},4963:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.Symbols=void 0;var ea=function(ei){return ei.AnyRoom="*",ei}({});eo.Symbols=ea},4692:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.WidgetApi=void 0;var ec=ea(7187),ed=ea(5206),eu=ea(6376),eh=ea(9843),ef=ea(2047),ep=ea(4693),eg=ea(9094),em=ea(2793),ey=ea(6005),eb=ea(4963);function eS(ei){return(eS="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function eE(){eE=function(){return ei};var ei={},eo=Object.prototype,ea=eo.hasOwnProperty,ec=Object.defineProperty||function(ei,eo,ea){ei[eo]=ea.value},ed="function"==typeof Symbol?Symbol:{},eu=ed.iterator||"@@iterator",eh=ed.asyncIterator||"@@asyncIterator",ef=ed.toStringTag||"@@toStringTag";function ep(ei,eo,ea){return Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}),ei[eo]}try{ep({},"")}catch(ei){ep=function(ei,eo,ea){return ei[eo]=ea}}function eg(ei,eo,ea,ed){var eu=Object.create((eo&&eo.prototype instanceof eb?eo:eb).prototype);return ec(eu,"_invoke",{value:eM(ei,ea,new ej(ed||[]))}),eu}function em(ei,eo,ea){try{return{type:"normal",arg:ei.call(eo,ea)}}catch(ei){return{type:"throw",arg:ei}}}ei.wrap=eg;var ey={};function eb(){}function ew(){}function e_(){}var eT={};ep(eT,eu,function(){return this});var eI=Object.getPrototypeOf,eC=eI&&eI(eI(eL([])));eC&&eC!==eo&&ea.call(eC,eu)&&(eT=eC);var eO=e_.prototype=eb.prototype=Object.create(eT);function eR(ei){["next","throw","return"].forEach(function(eo){ep(ei,eo,function(ei){return this._invoke(eo,ei)})})}function ek(ei,eo){var ed;function eu(ec,ed,eh,ef){var ep=em(ei[ec],ei,ed);if("throw"!==ep.type){var eg=ep.arg,ey=eg.value;return ey&&"object"==eS(ey)&&ea.call(ey,"__await")?eo.resolve(ey.__await).then(function(ei){eu("next",ei,eh,ef)},function(ei){eu("throw",ei,eh,ef)}):eo.resolve(ey).then(function(ei){eg.value=ei,eh(eg)},function(ei){return eu("throw",ei,eh,ef)})}ef(ep.arg)}ec(this,"_invoke",{value:function(ei,ea){function ec(){return new eo(function(eo,ec){eu(ei,ea,eo,ec)})}return ed=ed?ed.then(ec,ec):ec()}})}function eM(ei,eo,ea){var ec="suspendedStart";return function(ed,eu){if("executing"===ec)throw Error("Generator is already running");if("completed"===ec){if("throw"===ed)throw eu;return eN()}for(ea.method=ed,ea.arg=eu;;){var eh=ea.delegate;if(eh){var ef=eP(eh,ea);if(ef){if(ef===ey)continue;return ef}}if("next"===ea.method)ea.sent=ea._sent=ea.arg;else if("throw"===ea.method){if("suspendedStart"===ec)throw ec="completed",ea.arg;ea.dispatchException(ea.arg)}else"return"===ea.method&&ea.abrupt("return",ea.arg);ec="executing";var ep=em(ei,eo,ea);if("normal"===ep.type){if(ec=ea.done?"completed":"suspendedYield",ep.arg===ey)continue;return{value:ep.arg,done:ea.done}}"throw"===ep.type&&(ec="completed",ea.method="throw",ea.arg=ep.arg)}}}function eP(ei,eo){var ea=eo.method,ec=ei.iterator[ea];if(void 0===ec)return eo.delegate=null,"throw"===ea&&ei.iterator.return&&(eo.method="return",eo.arg=void 0,eP(ei,eo),"throw"===eo.method)||"return"!==ea&&(eo.method="throw",eo.arg=TypeError("The iterator does not provide a '"+ea+"' method")),ey;var ed=em(ec,ei.iterator,eo.arg);if("throw"===ed.type)return eo.method="throw",eo.arg=ed.arg,eo.delegate=null,ey;var eu=ed.arg;return eu?eu.done?(eo[ei.resultName]=eu.value,eo.next=ei.nextLoc,"return"!==eo.method&&(eo.method="next",eo.arg=void 0),eo.delegate=null,ey):eu:(eo.method="throw",eo.arg=TypeError("iterator result is not an object"),eo.delegate=null,ey)}function eA(ei){var eo={tryLoc:ei[0]};1 in ei&&(eo.catchLoc=ei[1]),2 in ei&&(eo.finallyLoc=ei[2],eo.afterLoc=ei[3]),this.tryEntries.push(eo)}function eD(ei){var eo=ei.completion||{};eo.type="normal",delete eo.arg,ei.completion=eo}function ej(ei){this.tryEntries=[{tryLoc:"root"}],ei.forEach(eA,this),this.reset(!0)}function eL(ei){if(ei){var eo=ei[eu];if(eo)return eo.call(ei);if("function"==typeof ei.next)return ei;if(!isNaN(ei.length)){var ec=-1,ed=function eo(){for(;++ec<ei.length;)if(ea.call(ei,ec))return eo.value=ei[ec],eo.done=!1,eo;return eo.value=void 0,eo.done=!0,eo};return ed.next=ed}}return{next:eN}}function eN(){return{value:void 0,done:!0}}return ew.prototype=e_,ec(eO,"constructor",{value:e_,configurable:!0}),ec(e_,"constructor",{value:ew,configurable:!0}),ew.displayName=ep(e_,ef,"GeneratorFunction"),ei.isGeneratorFunction=function(ei){var eo="function"==typeof ei&&ei.constructor;return!!eo&&(eo===ew||"GeneratorFunction"===(eo.displayName||eo.name))},ei.mark=function(ei){return Object.setPrototypeOf?Object.setPrototypeOf(ei,e_):(ei.__proto__=e_,ep(ei,ef,"GeneratorFunction")),ei.prototype=Object.create(eO),ei},ei.awrap=function(ei){return{__await:ei}},eR(ek.prototype),ep(ek.prototype,eh,function(){return this}),ei.AsyncIterator=ek,ei.async=function(eo,ea,ec,ed,eu){void 0===eu&&(eu=Promise);var eh=new ek(eg(eo,ea,ec,ed),eu);return ei.isGeneratorFunction(ea)?eh:eh.next().then(function(ei){return ei.done?ei.value:eh.next()})},eR(eO),ep(eO,ef,"Generator"),ep(eO,eu,function(){return this}),ep(eO,"toString",function(){return"[object Generator]"}),ei.keys=function(ei){var eo=Object(ei),ea=[];for(var ec in eo)ea.push(ec);return ea.reverse(),function ei(){for(;ea.length;){var ec=ea.pop();if(ec in eo)return ei.value=ec,ei.done=!1,ei}return ei.done=!0,ei}},ei.values=eL,ej.prototype={constructor:ej,reset:function(ei){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(eD),!ei)for(var eo in this)"t"===eo.charAt(0)&&ea.call(this,eo)&&!isNaN(+eo.slice(1))&&(this[eo]=void 0)},stop:function(){this.done=!0;var ei=this.tryEntries[0].completion;if("throw"===ei.type)throw ei.arg;return this.rval},dispatchException:function(ei){if(this.done)throw ei;var eo=this;function ec(ea,ec){return eh.type="throw",eh.arg=ei,eo.next=ea,ec&&(eo.method="next",eo.arg=void 0),!!ec}for(var ed=this.tryEntries.length-1;ed>=0;--ed){var eu=this.tryEntries[ed],eh=eu.completion;if("root"===eu.tryLoc)return ec("end");if(eu.tryLoc<=this.prev){var ef=ea.call(eu,"catchLoc"),ep=ea.call(eu,"finallyLoc");if(ef&&ep){if(this.prev<eu.catchLoc)return ec(eu.catchLoc,!0);if(this.prev<eu.finallyLoc)return ec(eu.finallyLoc)}else if(ef){if(this.prev<eu.catchLoc)return ec(eu.catchLoc,!0)}else{if(!ep)throw Error("try statement without catch or finally");if(this.prev<eu.finallyLoc)return ec(eu.finallyLoc)}}}},abrupt:function(ei,eo){for(var ec=this.tryEntries.length-1;ec>=0;--ec){var ed=this.tryEntries[ec];if(ed.tryLoc<=this.prev&&ea.call(ed,"finallyLoc")&&this.prev<ed.finallyLoc){var eu=ed;break}}eu&&("break"===ei||"continue"===ei)&&eu.tryLoc<=eo&&eo<=eu.finallyLoc&&(eu=null);var eh=eu?eu.completion:{};return eh.type=ei,eh.arg=eo,eu?(this.method="next",this.next=eu.finallyLoc,ey):this.complete(eh)},complete:function(ei,eo){if("throw"===ei.type)throw ei.arg;return"break"===ei.type||"continue"===ei.type?this.next=ei.arg:"return"===ei.type?(this.rval=this.arg=ei.arg,this.method="return",this.next="end"):"normal"===ei.type&&eo&&(this.next=eo),ey},finish:function(ei){for(var eo=this.tryEntries.length-1;eo>=0;--eo){var ea=this.tryEntries[eo];if(ea.finallyLoc===ei)return this.complete(ea.completion,ea.afterLoc),eD(ea),ey}},catch:function(ei){for(var eo=this.tryEntries.length-1;eo>=0;--eo){var ea=this.tryEntries[eo];if(ea.tryLoc===ei){var ec=ea.completion;if("throw"===ec.type){var ed=ec.arg;eD(ea)}return ed}}throw Error("illegal catch attempt")},delegateYield:function(ei,eo,ea){return this.delegate={iterator:eL(ei),resultName:eo,nextLoc:ea},"next"===this.method&&(this.arg=void 0),ey}},ei}function ew(ei,eo,ea,ec,ed,eu,eh){try{var ef=ei[eu](eh),ep=ef.value}catch(ei){ea(ei);return}ef.done?eo(ep):Promise.resolve(ep).then(ec,ed)}function e_(ei){return function(){var eo=this,ea=arguments;return new Promise(function(ec,ed){var eu=ei.apply(eo,ea);function eh(ei){ew(eu,ec,ed,eh,ef,"next",ei)}function ef(ei){ew(eu,ec,ed,eh,ef,"throw",ei)}eh(void 0)})}}function eT(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eI(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,eL(ec.key),ec)}}function eC(ei,eo,ea){return eo&&eI(ei.prototype,eo),ea&&eI(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eO(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eR(ei,eo)}function eR(ei,eo){return(eR=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function ek(ei){var eo=eA();return function(){var ea,ec=eD(ei);if(eo){var ed=eD(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return eM(this,ea)}}function eM(ei,eo){if(eo&&("object"===eS(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return eP(ei)}function eP(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function eA(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eD(ei){return(eD=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function ej(ei,eo,ea){return(eo=eL(eo))in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function eL(ei){var eo=eN(ei,"string");return"symbol"===eS(eo)?eo:String(eo)}function eN(ei,eo){if("object"!==eS(ei)||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!==eS(ec))return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}function eU(ei){return new eK(ei,0)}function eB(ei){return function(){return new eF(ei.apply(this,arguments))}}function eF(ei){var eo,ea;function ec(eo,ea){try{var eu=ei[eo](ea),eh=eu.value,ef=eh instanceof eK;Promise.resolve(ef?eh.v:eh).then(function(ea){if(ef){var ep="return"===eo?"return":"next";if(!eh.k||ea.done)return ec(ep,ea);ea=ei[ep](ea).value}ed(eu.done?"return":"normal",ea)},function(ei){ec("throw",ei)})}catch(ei){ed("throw",ei)}}function ed(ei,ed){switch(ei){case"return":eo.resolve({value:ed,done:!0});break;case"throw":eo.reject(ed);break;default:eo.resolve({value:ed,done:!1})}(eo=eo.next)?ec(eo.key,eo.arg):ea=null}this._invoke=function(ei,ed){return new Promise(function(eu,eh){var ef={key:ei,arg:ed,resolve:eu,reject:eh,next:null};ea?ea=ea.next=ef:(eo=ea=ef,ec(ei,ed))})},"function"!=typeof ei.return&&(this.return=void 0)}function eK(ei,eo){this.v=ei,this.k=eo}eF.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},eF.prototype.next=function(ei){return this._invoke("next",ei)},eF.prototype.throw=function(ei){return this._invoke("throw",ei)},eF.prototype.return=function(ei){return this._invoke("return",ei)};var e$=function(ei){eO(ea,ei);var eo=ek(ea);function ea(){var ei,ec=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,eu=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(eT(this,ea),(ei=eo.call(this)).clientOrigin=eu,ej(eP(ei),"transport",void 0),ej(eP(ei),"capabilitiesFinished",!1),ej(eP(ei),"supportsMSC2974Renegotiate",!1),ej(eP(ei),"requestedCapabilities",[]),ej(eP(ei),"approvedCapabilities",void 0),ej(eP(ei),"cachedClientVersions",void 0),ej(eP(ei),"turnServerWatchers",0),!window.parent)throw Error("No parent window. This widget doesn't appear to be embedded properly.");return ei.transport=new eh.PostmessageTransport(ed.WidgetApiDirection.FromWidget,ec,window.parent,window),ei.transport.targetOrigin=eu,ei.transport.on("message",ei.handleMessage.bind(eP(ei))),ei}return eC(ea,[{key:"hasCapability",value:function(ei){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(ei):this.requestedCapabilities.includes(ei)}},{key:"requestCapability",value:function(ei){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw Error("Capabilities have already been negotiated");this.requestedCapabilities.push(ei)}},{key:"requestCapabilities",value:function(ei){var eo=this;ei.forEach(function(ei){return eo.requestCapability(ei)})}},{key:"requestCapabilityForRoomTimeline",value:function(ei){this.requestCapability("org.matrix.msc2762.timeline:".concat(ei))}},{key:"requestCapabilityToSendState",value:function(ei,eo){this.requestCapability(ey.WidgetEventCapability.forStateEvent(ey.EventDirection.Send,ei,eo).raw)}},{key:"requestCapabilityToReceiveState",value:function(ei,eo){this.requestCapability(ey.WidgetEventCapability.forStateEvent(ey.EventDirection.Receive,ei,eo).raw)}},{key:"requestCapabilityToSendToDevice",value:function(ei){this.requestCapability(ey.WidgetEventCapability.forToDeviceEvent(ey.EventDirection.Send,ei).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(ei){this.requestCapability(ey.WidgetEventCapability.forToDeviceEvent(ey.EventDirection.Receive,ei).raw)}},{key:"requestCapabilityToSendEvent",value:function(ei){this.requestCapability(ey.WidgetEventCapability.forRoomEvent(ey.EventDirection.Send,ei).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(ei){this.requestCapability(ey.WidgetEventCapability.forRoomEvent(ey.EventDirection.Receive,ei).raw)}},{key:"requestCapabilityToSendMessage",value:function(ei){this.requestCapability(ey.WidgetEventCapability.forRoomMessageEvent(ey.EventDirection.Send,ei).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(ei){this.requestCapability(ey.WidgetEventCapability.forRoomMessageEvent(ey.EventDirection.Receive,ei).raw)}},{key:"requestOpenIDConnectToken",value:function(){var ei=this;return new Promise(function(eo,ea){ei.transport.sendComplete(ef.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(ec){var ed=ec.response;if(ed.state===ep.OpenIDRequestState.Allowed)eo(ed);else if(ed.state===ep.OpenIDRequestState.Blocked)ea(Error("User declined to verify their identity"));else if(ed.state===ep.OpenIDRequestState.PendingUserConfirmation){var eu=function eu(eh){eh.preventDefault();var eg=eh.detail;eg.data.original_request_id===ec.requestId&&(eg.data.state===ep.OpenIDRequestState.Allowed?(eo(eg.data),ei.transport.reply(eg,{})):eg.data.state===ep.OpenIDRequestState.Blocked?(ea(Error("User declined to verify their identity")),ei.transport.reply(eg,{})):(ea(Error("Invalid state on reply: "+ed.state)),ei.transport.reply(eg,{error:{message:"Invalid state"}})),ei.off("action:".concat(ef.WidgetApiToWidgetAction.OpenIDCredentials),eu))};ei.on("action:".concat(ef.WidgetApiToWidgetAction.OpenIDCredentials),eu)}else ea(Error("Invalid state: "+ed.state))}).catch(ea)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(ef.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(ef.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(ei){return this.transport.send(ef.WidgetApiFromWidgetAction.SendSticker,ei).then()}},{key:"setAlwaysOnScreen",value:function(ei){return this.transport.send(ef.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:ei}).then(function(ei){return ei.success})}},{key:"openModalWidget",value:function(ei,eo){var ea=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],ec=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},ed=arguments.length>4&&void 0!==arguments[4]?arguments[4]:eg.MatrixWidgetType.Custom;return this.transport.send(ef.WidgetApiFromWidgetAction.OpenModalWidget,{type:ed,url:ei,name:eo,buttons:ea,data:ec}).then()}},{key:"closeModalWidget",value:function(){var ei=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.transport.send(ef.WidgetApiFromWidgetAction.CloseModalWidget,ei).then()}},{key:"sendRoomEvent",value:function(ei,eo,ea){return this.transport.send(ef.WidgetApiFromWidgetAction.SendEvent,{type:ei,content:eo,room_id:ea})}},{key:"sendStateEvent",value:function(ei,eo,ea,ec){return this.transport.send(ef.WidgetApiFromWidgetAction.SendEvent,{type:ei,content:ea,state_key:eo,room_id:ec})}},{key:"sendToDevice",value:function(ei,eo,ea){return this.transport.send(ef.WidgetApiFromWidgetAction.SendToDevice,{type:ei,encrypted:eo,messages:ea})}},{key:"readRoomEvents",value:function(ei,eo,ea,ec){var ed={type:ei,msgtype:ea};return void 0!==eo&&(ed.limit=eo),ec&&(ec.includes(eb.Symbols.AnyRoom)?ed.room_ids=eb.Symbols.AnyRoom:ed.room_ids=ec),this.transport.send(ef.WidgetApiFromWidgetAction.MSC2876ReadEvents,ed).then(function(ei){return ei.events})}},{key:"readEventRelations",value:function(){var ei=e_(eE().mark(function ei(eo,ea,ec,ed,eh,ep,eg,em){var ey;return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:return ei.next=2,this.getClientVersions();case 2:if(ei.sent.includes(eu.UnstableApiVersion.MSC3869)){ei.next=5;break}throw Error("The read_relations action is not supported by the client.");case 5:return ey={event_id:eo,rel_type:ec,event_type:ed,room_id:ea,to:eg,from:ep,limit:eh,direction:em},ei.abrupt("return",this.transport.send(ef.WidgetApiFromWidgetAction.MSC3869ReadRelations,ey));case 7:case"end":return ei.stop()}},ei,this)}));return function(eo,ea,ec,ed,eu,eh,ef,ep){return ei.apply(this,arguments)}}()},{key:"readStateEvents",value:function(ei,eo,ea,ec){var ed={type:ei,state_key:void 0===ea||ea};return void 0!==eo&&(ed.limit=eo),ec&&(ec.includes(eb.Symbols.AnyRoom)?ed.room_ids=eb.Symbols.AnyRoom:ed.room_ids=ec),this.transport.send(ef.WidgetApiFromWidgetAction.MSC2876ReadEvents,ed).then(function(ei){return ei.events})}},{key:"setModalButtonEnabled",value:function(ei,eo){if(ei===em.BuiltInModalButtonID.Close)throw Error("The close button cannot be disabled");return this.transport.send(ef.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:ei,enabled:eo}).then()}},{key:"navigateTo",value:function(ei){if(!ei||!ei.startsWith("https://matrix.to/#"))throw Error("Invalid matrix.to URI");return this.transport.send(ef.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:ei}).then()}},{key:"getTurnServers",value:function(){var ei=this;return eB(eE().mark(function eo(){var ea,ec;return eE().wrap(function(eo){for(;;)switch(eo.prev=eo.next){case 0:if(ec=function(){var eo=e_(eE().mark(function eo(ec){return eE().wrap(function(eo){for(;;)switch(eo.prev=eo.next){case 0:return ec.preventDefault(),ea(ec.detail.data),eo.next=4,ei.transport.reply(ec.detail,{});case 4:case"end":return eo.stop()}},eo)}));return function(ei){return eo.apply(this,arguments)}}(),ei.on("action:".concat(ef.WidgetApiToWidgetAction.UpdateTurnServers),ec),0!==ei.turnServerWatchers){eo.next=12;break}return eo.prev=3,eo.next=6,eU(ei.transport.send(ef.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:eo.next=12;break;case 8:throw eo.prev=8,eo.t0=eo.catch(3),ei.off("action:".concat(ef.WidgetApiToWidgetAction.UpdateTurnServers),ec),eo.t0;case 12:ei.turnServerWatchers++,eo.prev=13;case 14:return eo.next=17,eU(new Promise(function(ei){return ea=ei}));case 17:return eo.next=19,eo.sent;case 19:eo.next=14;break;case 21:if(eo.prev=21,ei.off("action:".concat(ef.WidgetApiToWidgetAction.UpdateTurnServers),ec),ei.turnServerWatchers--,0!==ei.turnServerWatchers){eo.next=27;break}return eo.next=27,eU(ei.transport.send(ef.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return eo.finish(21);case 28:case"end":return eo.stop()}},eo,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:function(){var ei=e_(eE().mark(function ei(eo,ea){var ec;return eE().wrap(function(ei){for(;;)switch(ei.prev=ei.next){case 0:return ei.next=2,this.getClientVersions();case 2:if(ei.sent.includes(eu.UnstableApiVersion.MSC3973)){ei.next=5;break}throw Error("The user_directory_search action is not supported by the client.");case 5:return ec={search_term:eo,limit:ea},ei.abrupt("return",this.transport.send(ef.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,ec));case 7:case"end":return ei.stop()}},ei,this)}));return function(eo,ea){return ei.apply(this,arguments)}}()},{key:"start",value:function(){var ei=this;this.transport.start(),this.getClientVersions().then(function(eo){eo.includes(eu.UnstableApiVersion.MSC2974)&&(ei.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(ei){var eo=new CustomEvent("action:".concat(ei.detail.action),{detail:ei.detail,cancelable:!0});if(this.emit("action:".concat(ei.detail.action),eo),!eo.defaultPrevented)switch(ei.detail.action){case ef.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(ei.detail);case ef.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(ei.detail);case ef.WidgetApiToWidgetAction.UpdateVisibility:case ef.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(ei.detail,{});default:return this.transport.reply(ei.detail,{error:{message:"Unknown or unsupported action: "+ei.detail.action}})}}},{key:"replyVersions",value:function(ei){this.transport.reply(ei,{supported_versions:eu.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var ei=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(ef.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(eo){return ei.cachedClientVersions=eo.supported_versions,eo.supported_versions}).catch(function(ei){return console.warn("non-fatal error getting supported client versions: ",ei),[]})}},{key:"handleCapabilities",value:function(ei){var eo=this;return this.capabilitiesFinished?this.transport.reply(ei,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(ea){return ea.includes(eu.UnstableApiVersion.MSC2871)?eo.once("action:".concat(ef.WidgetApiToWidgetAction.NotifyCapabilities),function(ei){eo.approvedCapabilities=ei.detail.data.approved,eo.emit("ready")}):eo.emit("ready"),eo.capabilitiesFinished=!0,eo.transport.reply(ei,{capabilities:eo.requestedCapabilities})})}}]),ea}(ec.EventEmitter);eo.WidgetApi=e$},988:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.WidgetDriver=void 0;var ec=ea(7760);function ed(ei){return(ed="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function eu(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eh(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ep(ec.key),ec)}}function ef(ei,eo,ea){return eo&&eh(ei.prototype,eo),ea&&eh(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function ep(ei){var eo=eg(ei,"string");return"symbol"===ed(eo)?eo:String(eo)}function eg(ei,eo){if("object"!==ed(ei)||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!==ed(ec))return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}var em=function(){function ei(){eu(this,ei)}return ef(ei,[{key:"validateCapabilities",value:function(ei){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(ei,eo){return arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],Promise.reject(Error("Failed to override function"))}},{key:"sendToDevice",value:function(ei,eo,ea){return Promise.reject(Error("Failed to override function"))}},{key:"readRoomEvents",value:function(ei,eo,ea){return arguments.length>3&&void 0!==arguments[3]&&arguments[3],Promise.resolve([])}},{key:"readStateEvents",value:function(ei,eo,ea){return arguments.length>3&&void 0!==arguments[3]&&arguments[3],Promise.resolve([])}},{key:"readEventRelations",value:function(ei,eo,ea,ec,ed,eu,eh,ef){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(ei){ei.update({state:ec.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(ei){throw Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(ei,eo){return Promise.resolve({limited:!1,results:[]})}}]),ei}();eo.WidgetDriver=em},7760:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0});var ec=ea(4692);Object.keys(ec).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ec[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ec[ei]}}))});var ed=ea(7779);Object.keys(ed).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ed[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ed[ei]}}))});var eu=ea(4963);Object.keys(eu).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eu[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eu[ei]}}))});var eh=ea(8958);Object.keys(eh).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eh[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eh[ei]}}))});var ef=ea(9843);Object.keys(ef).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ef[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ef[ei]}}))});var ep=ea(4565);Object.keys(ep).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ep[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ep[ei]}}))});var eg=ea(2981);Object.keys(eg).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eg[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eg[ei]}}))});var em=ea(8651);Object.keys(em).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===em[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return em[ei]}}))});var ey=ea(3094);Object.keys(ey).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ey[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ey[ei]}}))});var eb=ea(9094);Object.keys(eb).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eb[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eb[ei]}}))});var eS=ea(4764);Object.keys(eS).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eS[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eS[ei]}}))});var eE=ea(5456);Object.keys(eE).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eE[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eE[ei]}}))});var ew=ea(9301);Object.keys(ew).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ew[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ew[ei]}}))});var e_=ea(2047);Object.keys(e_).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===e_[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e_[ei]}}))});var eT=ea(5206);Object.keys(eT).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eT[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eT[ei]}}))});var eI=ea(6376);Object.keys(eI).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eI[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eI[ei]}}))});var eC=ea(2646);Object.keys(eC).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eC[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eC[ei]}}))});var eO=ea(1409);Object.keys(eO).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eO[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eO[ei]}}))});var eR=ea(6549);Object.keys(eR).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eR[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eR[ei]}}))});var ek=ea(6425);Object.keys(ek).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ek[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ek[ei]}}))});var eM=ea(2179);Object.keys(eM).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eM[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eM[ei]}}))});var eP=ea(7008);Object.keys(eP).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eP[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eP[ei]}}))});var eA=ea(9674);Object.keys(eA).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eA[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eA[ei]}}))});var eD=ea(1085);Object.keys(eD).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eD[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eD[ei]}}))});var ej=ea(4693);Object.keys(ej).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ej[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ej[ei]}}))});var eL=ea(3114);Object.keys(eL).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eL[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eL[ei]}}))});var eN=ea(2603);Object.keys(eN).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eN[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eN[ei]}}))});var eU=ea(3859);Object.keys(eU).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eU[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eU[ei]}}))});var eB=ea(2793);Object.keys(eB).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eB[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eB[ei]}}))});var eF=ea(1471);Object.keys(eF).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eF[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eF[ei]}}))});var eK=ea(9471);Object.keys(eK).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eK[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eK[ei]}}))});var e$=ea(9362);Object.keys(e$).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===e$[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e$[ei]}}))});var eW=ea(6531);Object.keys(eW).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eW[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eW[ei]}}))});var eV=ea(6067);Object.keys(eV).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eV[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eV[ei]}}))});var eG=ea(846);Object.keys(eG).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eG[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eG[ei]}}))});var eH=ea(435);Object.keys(eH).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eH[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eH[ei]}}))});var ez=ea(8299);Object.keys(ez).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===ez[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return ez[ei]}}))});var eY=ea(4889);Object.keys(eY).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eY[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eY[ei]}}))});var eJ=ea(6005);Object.keys(eJ).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eJ[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eJ[ei]}}))});var eQ=ea(9177);Object.keys(eQ).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eQ[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eQ[ei]}}))});var eX=ea(7325);Object.keys(eX).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eX[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eX[ei]}}))});var eZ=ea(6328);Object.keys(eZ).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===eZ[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return eZ[ei]}}))});var e0=ea(6634);Object.keys(e0).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===e0[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e0[ei]}}))});var e1=ea(4174);Object.keys(e1).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===e1[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e1[ei]}}))});var e2=ea(8793);Object.keys(e2).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===e2[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e2[ei]}}))});var e3=ea(988);Object.keys(e3).forEach(function(ei){"default"!==ei&&"__esModule"!==ei&&(ei in eo&&eo[ei]===e3[ei]||Object.defineProperty(eo,ei,{enumerable:!0,get:function(){return e3[ei]}}))})},6376:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.UnstableApiVersion=eo.MatrixApiVersion=eo.CurrentApiVersions=void 0;var ea=function(ei){return ei.Prerelease1="0.0.1",ei.Prerelease2="0.0.2",ei}({});eo.MatrixApiVersion=ea;var ec=function(ei){return ei.MSC2762="org.matrix.msc2762",ei.MSC2871="org.matrix.msc2871",ei.MSC2931="org.matrix.msc2931",ei.MSC2974="org.matrix.msc2974",ei.MSC2876="org.matrix.msc2876",ei.MSC3819="org.matrix.msc3819",ei.MSC3846="town.robin.msc3846",ei.MSC3869="org.matrix.msc3869",ei.MSC3973="org.matrix.msc3973",ei}({});eo.UnstableApiVersion=ec;var ed=[ea.Prerelease1,ea.Prerelease2,ec.MSC2762,ec.MSC2871,ec.MSC2931,ec.MSC2974,ec.MSC2876,ec.MSC3819,ec.MSC3846,ec.MSC3869,ec.MSC3973];eo.CurrentApiVersions=ed},2646:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.VideoConferenceCapabilities=eo.StickerpickerCapabilities=eo.MatrixCapabilities=void 0,eo.getTimelineRoomIDFromCapability=ef,eo.isTimelineCapability=eu,eo.isTimelineCapabilityFor=eh;var ea=function(ei){return ei.Screenshots="m.capability.screenshot",ei.StickerSending="m.sticker",ei.AlwaysOnScreen="m.always_on_screen",ei.RequiresClient="io.element.requires_client",ei.MSC2931Navigate="org.matrix.msc2931.navigate",ei.MSC3846TurnServers="town.robin.msc3846.turn_servers",ei.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",ei}({});eo.MatrixCapabilities=ea;var ec=[ea.StickerSending];eo.StickerpickerCapabilities=ec;var ed=[ea.AlwaysOnScreen];function eu(ei){return null==ei?void 0:ei.startsWith("org.matrix.msc2762.timeline:")}function eh(ei,eo){return ei==="org.matrix.msc2762.timeline:".concat(eo)}function ef(ei){return ei.substring(ei.indexOf(":")+1)}eo.VideoConferenceCapabilities=ed},1409:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},6549:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},4693:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.OpenIDRequestState=void 0;var ea=function(ei){return ei.Allowed="allowed",ei.Blocked="blocked",ei.PendingUserConfirmation="request",ei}({});eo.OpenIDRequestState=ea},4565:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},2981:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},846:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},8651:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},3094:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},4764:function(ei,eo){"use strict";function ea(ei){return"error"in ei&&!!ei.error.message}Object.defineProperty(eo,"__esModule",{value:!0}),eo.isErrorResponse=ea},5456:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},9301:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},3859:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.ModalButtonKind=void 0;var ea=function(ei){return ei.Primary="m.primary",ei.Secondary="m.secondary",ei.Warning="m.warning",ei.Danger="m.danger",ei.Link="m.link",ei}({});eo.ModalButtonKind=ea},2793:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.BuiltInModalButtonID=void 0;var ea=function(ei){return ei.Close="m.close",ei}({});eo.BuiltInModalButtonID=ea},435:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},3114:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},6067:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},4889:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},6425:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},9362:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},6531:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},1471:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},2179:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},7008:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},9674:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},8299:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},1085:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},2047:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.WidgetApiToWidgetAction=eo.WidgetApiFromWidgetAction=void 0;var ea=function(ei){return ei.SupportedApiVersions="supported_api_versions",ei.Capabilities="capabilities",ei.NotifyCapabilities="notify_capabilities",ei.TakeScreenshot="screenshot",ei.UpdateVisibility="visibility",ei.OpenIDCredentials="openid_credentials",ei.WidgetConfig="widget_config",ei.CloseModalWidget="close_modal",ei.ButtonClicked="button_clicked",ei.SendEvent="send_event",ei.SendToDevice="send_to_device",ei.UpdateTurnServers="update_turn_servers",ei}({});eo.WidgetApiToWidgetAction=ea;var ec=function(ei){return ei.SupportedApiVersions="supported_api_versions",ei.ContentLoaded="content_loaded",ei.SendSticker="m.sticker",ei.UpdateAlwaysOnScreen="set_always_on_screen",ei.GetOpenIDCredentials="get_openid",ei.CloseModalWidget="close_modal",ei.OpenModalWidget="open_modal",ei.SetModalButtonEnabled="set_button_enabled",ei.SendEvent="send_event",ei.SendToDevice="send_to_device",ei.WatchTurnServers="watch_turn_servers",ei.UnwatchTurnServers="unwatch_turn_servers",ei.MSC2876ReadEvents="org.matrix.msc2876.read_events",ei.MSC2931Navigate="org.matrix.msc2931.navigate",ei.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",ei.MSC3869ReadRelations="org.matrix.msc3869.read_relations",ei.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",ei}({});eo.WidgetApiFromWidgetAction=ec},5206:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.WidgetApiDirection=void 0,eo.invertedDirection=ec;var ea=function(ei){return ei.ToWidget="toWidget",ei.FromWidget="fromWidget",ei}({});function ec(ei){if(ei===ea.ToWidget)return ea.FromWidget;if(ei===ea.FromWidget)return ea.ToWidget;throw Error("Invalid direction")}eo.WidgetApiDirection=ea},9471:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},2603:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.WidgetKind=void 0;var ea=function(ei){return ei.Room="room",ei.Account="account",ei.Modal="modal",ei}({});eo.WidgetKind=ea},9094:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.MatrixWidgetType=void 0;var ea=function(ei){return ei.Custom="m.custom",ei.JitsiMeet="m.jitsi",ei.Stickerpicker="m.stickerpicker",ei}({});eo.MatrixWidgetType=ea},6328:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.Widget=void 0;var ec=ea(7325),ed=ea(7760);function eu(ei){return(eu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function eh(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function ef(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,eg(ec.key),ec)}}function ep(ei,eo,ea){return eo&&ef(ei.prototype,eo),ea&&ef(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eg(ei){var eo=em(ei,"string");return"symbol"===eu(eo)?eo:String(eo)}function em(ei,eo){if("object"!==eu(ei)||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!==eu(ec))return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}var ey=function(){function ei(eo){if(eh(this,ei),this.definition=eo,!this.definition)throw Error("Definition is required");(0,ec.assertPresent)(eo,"id"),(0,ec.assertPresent)(eo,"creatorUserId"),(0,ec.assertPresent)(eo,"type"),(0,ec.assertPresent)(eo,"url")}return ep(ei,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return!1!==this.definition.waitForIframeLoad&&(this.definition.waitForIframeLoad,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(ei){return(0,ed.runTemplate)(this.templateUrl,this.definition,ei)}}]),ei}();eo.Widget=ey},6005:function(ei,eo){"use strict";function ea(ei){return(ea="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function ec(ei,eo){var ea="undefined"!=typeof Symbol&&ei[Symbol.iterator]||ei["@@iterator"];if(!ea){if(Array.isArray(ei)||(ea=ed(ei))||eo&&ei&&"number"==typeof ei.length){ea&&(ei=ea);var ec=0,eu=function(){};return{s:eu,n:function(){return ec>=ei.length?{done:!0}:{done:!1,value:ei[ec++]}},e:function(ei){throw ei},f:eu}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var eh,ef=!0,ep=!1;return{s:function(){ea=ea.call(ei)},n:function(){var ei=ea.next();return ef=ei.done,ei},e:function(ei){ep=!0,eh=ei},f:function(){try{ef||null==ea.return||ea.return()}finally{if(ep)throw eh}}}}function ed(ei,eo){if(ei){if("string"==typeof ei)return eu(ei,eo);var ea=Object.prototype.toString.call(ei).slice(8,-1);if("Object"===ea&&ei.constructor&&(ea=ei.constructor.name),"Map"===ea||"Set"===ea)return Array.from(ei);if("Arguments"===ea||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ea))return eu(ei,eo)}}function eu(ei,eo){(null==eo||eo>ei.length)&&(eo=ei.length);for(var ea=0,ec=Array(eo);ea<eo;ea++)ec[ea]=ei[ea];return ec}function eh(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function ef(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,eg(ec.key),ec)}}function ep(ei,eo,ea){return eo&&ef(ei.prototype,eo),ea&&ef(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eg(ei){var eo=em(ei,"string");return"symbol"===ea(eo)?eo:String(eo)}function em(ei,eo){if("object"!==ea(ei)||null===ei)return ei;var ec=ei[Symbol.toPrimitive];if(void 0!==ec){var ed=ec.call(ei,eo||"default");if("object"!==ea(ed))return ed;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.WidgetEventCapability=eo.EventKind=eo.EventDirection=void 0;var ey=function(ei){return ei.Event="event",ei.State="state_event",ei.ToDevice="to_device",ei}({});eo.EventKind=ey;var eb=function(ei){return ei.Send="send",ei.Receive="receive",ei}({});eo.EventDirection=eb;var eS=function(){function ei(eo,ea,ec,ed,eu){eh(this,ei),this.direction=eo,this.eventType=ea,this.kind=ec,this.keyStr=ed,this.raw=eu}return ep(ei,[{key:"matchesAsStateEvent",value:function(ei,eo,ea){return this.kind===ey.State&&this.direction===ei&&this.eventType===eo&&(null===this.keyStr||this.keyStr===ea)}},{key:"matchesAsToDeviceEvent",value:function(ei,eo){return this.kind===ey.ToDevice&&this.direction===ei&&this.eventType===eo}},{key:"matchesAsRoomEvent",value:function(ei,eo){var ea=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.kind===ey.Event&&this.direction===ei&&this.eventType===eo&&("m.room.message"!==this.eventType||null===this.keyStr||this.keyStr===ea)}}],[{key:"forStateEvent",value:function(eo,ea,ec){ea=ea.replace(/#/g,"\\#"),ec=null!=ec?"#".concat(ec):"";var ed="org.matrix.msc2762.".concat(eo,".state_event:").concat(ea).concat(ec);return ei.findEventCapabilities([ed])[0]}},{key:"forToDeviceEvent",value:function(eo,ea){var ec="org.matrix.msc3819.".concat(eo,".to_device:").concat(ea);return ei.findEventCapabilities([ec])[0]}},{key:"forRoomEvent",value:function(eo,ea){var ec="org.matrix.msc2762.".concat(eo,".event:").concat(ea);return ei.findEventCapabilities([ec])[0]}},{key:"forRoomMessageEvent",value:function(eo,ea){ea=null==ea?"":ea;var ec="org.matrix.msc2762.".concat(eo,".event:m.room.message#").concat(ea);return ei.findEventCapabilities([ec])[0]}},{key:"findEventCapabilities",value:function(eo){var ea,ed=[],eu=ec(eo);try{for(eu.s();!(ea=eu.n()).done;){var eh=ea.value,ef=null,ep=void 0,eg=null;if(eh.startsWith("org.matrix.msc2762.send.event:")?(ef=eb.Send,eg=ey.Event,ep=eh.substring(30)):eh.startsWith("org.matrix.msc2762.send.state_event:")?(ef=eb.Send,eg=ey.State,ep=eh.substring(36)):eh.startsWith("org.matrix.msc3819.send.to_device:")?(ef=eb.Send,eg=ey.ToDevice,ep=eh.substring(34)):eh.startsWith("org.matrix.msc2762.receive.event:")?(ef=eb.Receive,eg=ey.Event,ep=eh.substring(33)):eh.startsWith("org.matrix.msc2762.receive.state_event:")?(ef=eb.Receive,eg=ey.State,ep=eh.substring(39)):eh.startsWith("org.matrix.msc3819.receive.to_device:")&&(ef=eb.Receive,eg=ey.ToDevice,ep=eh.substring(37)),null!==ef&&null!==eg&&void 0!==ep){var em=ep.startsWith("m.room.message#")||eg===ey.State,eS=null;if(ep.includes("#")&&em){var eE=ep.split("#"),ew=eE.findIndex(function(ei){return!ei.endsWith("\\")});ep=eE.slice(0,ew+1).map(function(ei){return ei.endsWith("\\")?ei.substring(0,ei.length-1):ei}).join("#"),eS=eE.slice(ew+1).join("#")}ed.push(new ei(ef,ep,eg,eS,eh))}}}catch(ei){eu.e(ei)}finally{eu.f()}return ed}}]),ei}();eo.WidgetEventCapability=eS},6634:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.WidgetParser=void 0;var ec=ea(6328),ed=ea(9177);function eu(ei){return(eu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function eh(ei,eo){var ea="undefined"!=typeof Symbol&&ei[Symbol.iterator]||ei["@@iterator"];if(!ea){if(Array.isArray(ei)||(ea=ef(ei))||eo&&ei&&"number"==typeof ei.length){ea&&(ei=ea);var ec=0,ed=function(){};return{s:ed,n:function(){return ec>=ei.length?{done:!0}:{done:!1,value:ei[ec++]}},e:function(ei){throw ei},f:ed}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var eu,eh=!0,ep=!1;return{s:function(){ea=ea.call(ei)},n:function(){var ei=ea.next();return eh=ei.done,ei},e:function(ei){ep=!0,eu=ei},f:function(){try{eh||null==ea.return||ea.return()}finally{if(ep)throw eu}}}}function ef(ei,eo){if(ei){if("string"==typeof ei)return ep(ei,eo);var ea=Object.prototype.toString.call(ei).slice(8,-1);if("Object"===ea&&ei.constructor&&(ea=ei.constructor.name),"Map"===ea||"Set"===ea)return Array.from(ei);if("Arguments"===ea||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ea))return ep(ei,eo)}}function ep(ei,eo){(null==eo||eo>ei.length)&&(eo=ei.length);for(var ea=0,ec=Array(eo);ea<eo;ea++)ec[ea]=ei[ea];return ec}function eg(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function em(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,eb(ec.key),ec)}}function ey(ei,eo,ea){return eo&&em(ei.prototype,eo),ea&&em(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eb(ei){var eo=eS(ei,"string");return"symbol"===eu(eo)?eo:String(eo)}function eS(ei,eo){if("object"!==eu(ei)||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!==eu(ec))return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}var eE=function(){function ei(){eg(this,ei)}return ey(ei,null,[{key:"parseAccountData",value:function(eo){if(!eo)return[];for(var ea=[],ec=0,ed=Object.keys(eo);ec<ed.length;ec++){var eu=ed[ec],eh=eo[eu];if(eh&&("m.widget"===eh.type||"im.vector.modular.widgets"===eh.type)&&eh.sender&&(eh.state_key||eh.id)===eu){var ef={content:eh.content,sender:eh.sender,type:"m.widget",state_key:eu,event_id:"$example",room_id:"!example",origin_server_ts:1},ep=ei.parseRoomWidget(ef);ep&&ea.push(ep)}}return ea}},{key:"parseWidgetsFromRoomState",value:function(eo){if(!eo)return[];var ea,ec=[],ed=eh(eo);try{for(ed.s();!(ea=ed.n()).done;){var eu=ea.value,ef=ei.parseRoomWidget(eu);ef&&ec.push(ef)}}catch(ei){ed.e(ei)}finally{ed.f()}return ec}},{key:"parseRoomWidget",value:function(eo){if(!eo||"m.widget"!==eo.type&&"im.vector.modular.widgets"!==eo.type)return null;var ea=eo.content||{},ec={id:eo.state_key,creatorUserId:ea.creatorUserId||eo.sender,name:ea.name,type:ea.type,url:ea.url,waitForIframeLoad:ea.waitForIframeLoad,data:ea.data};return ei.processEstimatedWidget(ec)}},{key:"processEstimatedWidget",value:function(ei){return ei.id&&ei.creatorUserId&&ei.type&&(0,ed.isValidUrl)(ei.url)?new ec.Widget(ei):null}}]),ei}();eo.WidgetParser=eE},9177:function(ei,eo){"use strict";function ea(ei){if(!ei)return!1;try{var eo=new URL(ei);if("http"!==eo.protocol&&"https"!==eo.protocol)return!1;return!0}catch(ei){if(ei instanceof TypeError)return!1;throw ei}}Object.defineProperty(eo,"__esModule",{value:!0}),eo.isValidUrl=ea},7325:function(ei,eo){"use strict";function ea(ei,eo){if(!ei[eo])throw Error("".concat(String(eo)," is required"))}Object.defineProperty(eo,"__esModule",{value:!0}),eo.assertPresent=ea},4174:function(ei,eo){"use strict";function ea(ei,eo,ea){for(var ed=Object.assign({},eo.data,{matrix_room_id:ea.widgetRoomId||"",matrix_user_id:ea.currentUserId,matrix_display_name:ea.userDisplayName||ea.currentUserId,matrix_avatar_url:ea.userHttpAvatarUrl||"",matrix_widget_id:eo.id,"org.matrix.msc2873.client_id":ea.clientId||"","org.matrix.msc2873.client_theme":ea.clientTheme||"","org.matrix.msc2873.client_language":ea.clientLanguage||"","org.matrix.msc3819.matrix_device_id":ea.deviceId||""}),eu=ei,eh=0,ef=Object.keys(ed);eh<ef.length;eh++){var ep=ef[eh],eg=RegExp("$".concat(ep).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g");eu=eu.replace(eg,encodeURIComponent(ec(ed[ep])))}return eu}function ec(ei){return null==ei?"".concat(ei):String(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.runTemplate=ea,eo.toString=ec},8958:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0})},9843:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.PostmessageTransport=void 0;var ec=ea(7187),ed=ea(7760);function eu(ei){return(eu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function eh(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ef(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eh(Object(ea),!0).forEach(function(eo){eI(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eh(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function ep(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function eg(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,eC(ec.key),ec)}}function em(ei,eo,ea){return eo&&eg(ei.prototype,eo),ea&&eg(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function ey(ei,eo){if("function"!=typeof eo&&null!==eo)throw TypeError("Super expression must either be null or a function");ei.prototype=Object.create(eo&&eo.prototype,{constructor:{value:ei,writable:!0,configurable:!0}}),Object.defineProperty(ei,"prototype",{writable:!1}),eo&&eb(ei,eo)}function eb(ei,eo){return(eb=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function eS(ei){var eo=e_();return function(){var ea,ec=eT(ei);if(eo){var ed=eT(this).constructor;ea=Reflect.construct(ec,arguments,ed)}else ea=ec.apply(this,arguments);return eE(this,ea)}}function eE(ei,eo){if(eo&&("object"===eu(eo)||"function"==typeof eo))return eo;if(void 0!==eo)throw TypeError("Derived constructors may only return object or undefined");return ew(ei)}function ew(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}function e_(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(ei){return!1}}function eT(ei){return(eT=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(ei){return ei.__proto__||Object.getPrototypeOf(ei)})(ei)}function eI(ei,eo,ea){return(eo=eC(eo))in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function eC(ei){var eo=eO(ei,"string");return"symbol"===eu(eo)?eo:String(eo)}function eO(ei,eo){if("object"!==eu(ei)||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!==eu(ec))return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}var eR=function(ei){ey(ea,ei);var eo=eS(ea);function ea(ei,ec,ed,eu){var eh;return ep(this,ea),(eh=eo.call(this)).sendDirection=ei,eh.initialWidgetId=ec,eh.transportWindow=ed,eh.inboundWindow=eu,eI(ew(eh),"strictOriginCheck",!1),eI(ew(eh),"targetOrigin","*"),eI(ew(eh),"timeoutSeconds",10),eI(ew(eh),"_ready",!1),eI(ew(eh),"_widgetId",null),eI(ew(eh),"outboundRequests",new Map),eI(ew(eh),"stopController",new AbortController),eh._widgetId=ec,eh}return em(ea,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var ei="widgetapi-".concat(Date.now()),eo=0,ea=ei;this.outboundRequests.has(ea);)ea="".concat(ei,"-").concat(eo++);return this.outboundRequests.set(ea,null),ea}},{key:"sendInternal",value:function(ei){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),ei),this.transportWindow.postMessage(ei,this.targetOrigin)}},{key:"reply",value:function(ei,eo){return this.sendInternal(ef(ef({},ei),{},{response:eo}))}},{key:"send",value:function(ei,eo){return this.sendComplete(ei,eo).then(function(ei){return ei.response})}},{key:"sendComplete",value:function(ei,eo){var ea=this;if(!this.ready||!this.widgetId)return Promise.reject(Error("Not ready or unknown widget ID"));var ec={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:ei,data:eo};return ei===ed.WidgetApiToWidgetAction.UpdateVisibility&&(ec.visible=eo.visible),new Promise(function(ei,eo){var ed=function(eo){ep(),ei(eo)},eu=function(ei){ep(),eo(ei)},eh=setTimeout(function(){return eu(Error("Request timed out"))},1e3*(ea.timeoutSeconds||1)),ef=function(){return eu(Error("Transport stopped"))};ea.stopController.signal.addEventListener("abort",ef);var ep=function(){ea.outboundRequests.delete(ec.requestId),clearTimeout(eh),ea.stopController.signal.removeEventListener("abort",ef)};ea.outboundRequests.set(ec.requestId,{request:ec,resolve:ed,reject:eu}),ea.sendInternal(ec)})}},{key:"start",value:function(){var ei=this;this.inboundWindow.addEventListener("message",function(eo){ei.handleMessage(eo)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(ei){if(!this.stopController.signal.aborted&&ei.data&&(!this.strictOriginCheck||ei.origin===window.origin)){var eo=ei.data;if(eo.action&&eo.requestId&&eo.widgetId){if(eo.response){if(eo.api!==this.sendDirection)return;this.handleResponse(eo)}else{var ea=eo;if(ea.api!==(0,ed.invertedDirection)(this.sendDirection))return;this.handleRequest(ea)}}}}},{key:"handleRequest",value:function(ei){if(this.widgetId){if(this.widgetId!==ei.widgetId)return}else this._widgetId=ei.widgetId;this.emit("message",new CustomEvent("message",{detail:ei}))}},{key:"handleResponse",value:function(ei){if(ei.widgetId===this.widgetId){var eo=this.outboundRequests.get(ei.requestId);if(eo){if((0,ed.isErrorResponse)(ei.response)){var ea=ei.response;eo.reject(Error(ea.error.message))}else eo.resolve(ei)}}}}]),ea}(ec.EventEmitter);eo.PostmessageTransport=eR},8793:function(ei,eo){"use strict";function ea(ei){return(ea="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei})(ei)}function ec(ei,eo){var ea="undefined"!=typeof Symbol&&ei[Symbol.iterator]||ei["@@iterator"];if(!ea){if(Array.isArray(ei)||(ea=ed(ei))||eo&&ei&&"number"==typeof ei.length){ea&&(ei=ea);var ec=0,eu=function(){};return{s:eu,n:function(){return ec>=ei.length?{done:!0}:{done:!1,value:ei[ec++]}},e:function(ei){throw ei},f:eu}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var eh,ef=!0,ep=!1;return{s:function(){ea=ea.call(ei)},n:function(){var ei=ea.next();return ef=ei.done,ei},e:function(ei){ep=!0,eh=ei},f:function(){try{ef||null==ea.return||ea.return()}finally{if(ep)throw eh}}}}function ed(ei,eo){if(ei){if("string"==typeof ei)return eu(ei,eo);var ea=Object.prototype.toString.call(ei).slice(8,-1);if("Object"===ea&&ei.constructor&&(ea=ei.constructor.name),"Map"===ea||"Set"===ea)return Array.from(ei);if("Arguments"===ea||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(ea))return eu(ei,eo)}}function eu(ei,eo){(null==eo||eo>ei.length)&&(eo=ei.length);for(var ea=0,ec=Array(eo);ea<eo;ea++)ec[ea]=ei[ea];return ec}function eh(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function ef(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,em(ec.key),ec)}}function ep(ei,eo,ea){return eo&&ef(ei.prototype,eo),ea&&ef(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eg(ei,eo,ea){return(eo=em(eo))in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function em(ei){var eo=ey(ei,"string");return"symbol"===ea(eo)?eo:String(eo)}function ey(ei,eo){if("object"!==ea(ei)||null===ei)return ei;var ec=ei[Symbol.toPrimitive];if(void 0!==ec){var ed=ec.call(ei,eo||"default");if("object"!==ea(ed))return ed;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.SimpleObservable=void 0;var eb=function(){function ei(eo){eh(this,ei),eg(this,"listeners",[]),eo&&this.listeners.push(eo)}return ep(ei,[{key:"onUpdate",value:function(ei){this.listeners.push(ei)}},{key:"update",value:function(ei){var eo,ea=ec(this.listeners);try{for(ea.s();!(eo=ea.n()).done;)(0,eo.value)(ei)}catch(ei){ea.e(ei)}finally{ea.f()}}},{key:"close",value:function(){this.listeners=[]}}]),ei}();eo.SimpleObservable=eb},7824:function(ei){var eo=1e3,ea=6e4,ec=36e5,ed=864e5,eu=6048e5,eh=315576e5;function ef(ei){if(!((ei=String(ei)).length>100)){var ef=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(ei);if(ef){var ep=parseFloat(ef[1]);switch((ef[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return ep*eh;case"weeks":case"week":case"w":return ep*eu;case"days":case"day":case"d":return ep*ed;case"hours":case"hour":case"hrs":case"hr":case"h":return ep*ec;case"minutes":case"minute":case"mins":case"min":case"m":return ep*ea;case"seconds":case"second":case"secs":case"sec":case"s":return ep*eo;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return ep;default:return}}}}function ep(ei){var eu=Math.abs(ei);return eu>=ed?Math.round(ei/ed)+"d":eu>=ec?Math.round(ei/ec)+"h":eu>=ea?Math.round(ei/ea)+"m":eu>=eo?Math.round(ei/eo)+"s":ei+"ms"}function eg(ei){var eu=Math.abs(ei);return eu>=ed?em(ei,eu,ed,"day"):eu>=ec?em(ei,eu,ec,"hour"):eu>=ea?em(ei,eu,ea,"minute"):eu>=eo?em(ei,eu,eo,"second"):ei+" ms"}function em(ei,eo,ea,ec){var ed=eo>=1.5*ea;return Math.round(ei/ea)+" "+ec+(ed?"s":"")}ei.exports=function(ei,eo){eo=eo||{};var ea=typeof ei;if("string"===ea&&ei.length>0)return ef(ei);if("number"===ea&&isFinite(ei))return eo.long?eg(ei):ep(ei);throw Error("val is not a non-empty string or a valid number. val="+JSON.stringify(ei))}},3454:function(ei,eo,ea){"use strict";var ec,ed;ei.exports=(null==(ec=ea.g.process)?void 0:ec.env)&&"object"==typeof(null==(ed=ea.g.process)?void 0:ed.env)?ea.g.process:ea(7663)},7663:function(ei){var eo="/";!function(){var ea={229:function(ei){var eo,ea,ec,ed=ei.exports={};function eu(){throw Error("setTimeout has not been defined")}function eh(){throw Error("clearTimeout has not been defined")}function ef(ei){if(eo===setTimeout)return setTimeout(ei,0);if((eo===eu||!eo)&&setTimeout)return eo=setTimeout,setTimeout(ei,0);try{return eo(ei,0)}catch(ea){try{return eo.call(null,ei,0)}catch(ea){return eo.call(this,ei,0)}}}function ep(ei){if(ea===clearTimeout)return clearTimeout(ei);if((ea===eh||!ea)&&clearTimeout)return ea=clearTimeout,clearTimeout(ei);try{return ea(ei)}catch(eo){try{return ea.call(null,ei)}catch(eo){return ea.call(this,ei)}}}!function(){try{eo="function"==typeof setTimeout?setTimeout:eu}catch(ei){eo=eu}try{ea="function"==typeof clearTimeout?clearTimeout:eh}catch(ei){ea=eh}}();var eg=[],em=!1,ey=-1;function eb(){em&&ec&&(em=!1,ec.length?eg=ec.concat(eg):ey=-1,eg.length&&eS())}function eS(){if(!em){var ei=ef(eb);em=!0;for(var eo=eg.length;eo;){for(ec=eg,eg=[];++ey<eo;)ec&&ec[ey].run();ey=-1,eo=eg.length}ec=null,em=!1,ep(ei)}}function eE(ei,eo){this.fun=ei,this.array=eo}function ew(){}ed.nextTick=function(ei){var eo=Array(arguments.length-1);if(arguments.length>1)for(var ea=1;ea<arguments.length;ea++)eo[ea-1]=arguments[ea];eg.push(new eE(ei,eo)),1!==eg.length||em||ef(eS)},eE.prototype.run=function(){this.fun.apply(null,this.array)},ed.title="browser",ed.browser=!0,ed.env={},ed.argv=[],ed.version="",ed.versions={},ed.on=ew,ed.addListener=ew,ed.once=ew,ed.off=ew,ed.removeListener=ew,ed.removeAllListeners=ew,ed.emit=ew,ed.prependListener=ew,ed.prependOnceListener=ew,ed.listeners=function(ei){return[]},ed.binding=function(ei){throw Error("process.binding is not supported")},ed.cwd=function(){return"/"},ed.chdir=function(ei){throw Error("process.chdir is not supported")},ed.umask=function(){return 0}}},ec={};function ed(ei){var eo=ec[ei];if(void 0!==eo)return eo.exports;var eu=ec[ei]={exports:{}},eh=!0;try{ea[ei](eu,eu.exports,ed),eh=!1}finally{eh&&delete ec[ei]}return eu.exports}ed.ab=eo+"/";var eu=ed(229);ei.exports=eu}()},9681:function(ei,eo,ea){var ec="/",ed=ea(3454);!function(){var eo={782:function(ei){"function"==typeof Object.create?ei.exports=function(ei,eo){eo&&(ei.super_=eo,ei.prototype=Object.create(eo.prototype,{constructor:{value:ei,enumerable:!1,writable:!0,configurable:!0}}))}:ei.exports=function(ei,eo){if(eo){ei.super_=eo;var ea=function(){};ea.prototype=eo.prototype,ei.prototype=new ea,ei.prototype.constructor=ei}}},646:function(ei){"use strict";let eo={};function ea(ei,ea,ec){function ed(ei,eo,ec){return"string"==typeof ea?ea:ea(ei,eo,ec)}ec||(ec=Error);class eu extends ec{constructor(ei,eo,ea){super(ed(ei,eo,ea))}}eu.prototype.name=ec.name,eu.prototype.code=ei,eo[ei]=eu}function ec(ei,eo){if(!Array.isArray(ei))return`of ${eo} ${String(ei)}`;{let ea=ei.length;return(ei=ei.map(ei=>String(ei)),ea>2)?`one of ${eo} ${ei.slice(0,ea-1).join(", ")}, or `+ei[ea-1]:2===ea?`one of ${eo} ${ei[0]} or ${ei[1]}`:`of ${eo} ${ei[0]}`}}function ed(ei,eo,ea){return ei.substr(!ea||ea<0?0:+ea,eo.length)===eo}function eu(ei,eo,ea){return(void 0===ea||ea>ei.length)&&(ea=ei.length),ei.substring(ea-eo.length,ea)===eo}function eh(ei,eo,ea){return"number"!=typeof ea&&(ea=0),!(ea+eo.length>ei.length)&&-1!==ei.indexOf(eo,ea)}ea("ERR_INVALID_OPT_VALUE",function(ei,eo){return'The value "'+eo+'" is invalid for option "'+ei+'"'},TypeError),ea("ERR_INVALID_ARG_TYPE",function(ei,eo,ea){let ef,ep;if("string"==typeof eo&&ed(eo,"not ")?(ef="must not be",eo=eo.replace(/^not /,"")):ef="must be",eu(ei," argument"))ep=`The ${ei} ${ef} ${ec(eo,"type")}`;else{let ea=eh(ei,".")?"property":"argument";ep=`The "${ei}" ${ea} ${ef} ${ec(eo,"type")}`}return ep+`. Received type ${typeof ea}`},TypeError),ea("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),ea("ERR_METHOD_NOT_IMPLEMENTED",function(ei){return"The "+ei+" method is not implemented"}),ea("ERR_STREAM_PREMATURE_CLOSE","Premature close"),ea("ERR_STREAM_DESTROYED",function(ei){return"Cannot call "+ei+" after a stream was destroyed"}),ea("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),ea("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),ea("ERR_STREAM_WRITE_AFTER_END","write after end"),ea("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),ea("ERR_UNKNOWN_ENCODING",function(ei){return"Unknown encoding: "+ei},TypeError),ea("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),ei.exports.q=eo},403:function(ei,eo,ea){"use strict";var ec=Object.keys||function(ei){var eo=[];for(var ea in ei)eo.push(ea);return eo};ei.exports=em;var eu=ea(709),eh=ea(337);ea(782)(em,eu);for(var ef=ec(eh.prototype),ep=0;ep<ef.length;ep++){var eg=ef[ep];em.prototype[eg]||(em.prototype[eg]=eh.prototype[eg])}function em(ei){if(!(this instanceof em))return new em(ei);eu.call(this,ei),eh.call(this,ei),this.allowHalfOpen=!0,ei&&(!1===ei.readable&&(this.readable=!1),!1===ei.writable&&(this.writable=!1),!1===ei.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",ey)))}function ey(){this._writableState.ended||ed.nextTick(eb,this)}function eb(ei){ei.end()}Object.defineProperty(em.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(em.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(em.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(em.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(ei){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=ei,this._writableState.destroyed=ei)}})},889:function(ei,eo,ea){"use strict";ei.exports=ed;var ec=ea(170);function ed(ei){if(!(this instanceof ed))return new ed(ei);ec.call(this,ei)}ea(782)(ed,ec),ed.prototype._transform=function(ei,eo,ea){ea(null,ei)}},709:function(ei,eo,ec){"use strict";ei.exports=eN,eN.ReadableState=eL,ec(361).EventEmitter;var eu,eh,ef,ep,eg,em=function(ei,eo){return ei.listeners(eo).length},ey=ec(678),eb=ec(300).Buffer,eS=ea.g.Uint8Array||function(){};function eE(ei){return eb.from(ei)}function ew(ei){return eb.isBuffer(ei)||ei instanceof eS}var e_=ec(837);eh=e_&&e_.debuglog?e_.debuglog("stream"):function(){};var eT=ec(379),eI=ec(25),eC=ec(776).getHighWaterMark,eO=ec(646).q,eR=eO.ERR_INVALID_ARG_TYPE,ek=eO.ERR_STREAM_PUSH_AFTER_EOF,eM=eO.ERR_METHOD_NOT_IMPLEMENTED,eP=eO.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;ec(782)(eN,ey);var eA=eI.errorOrDestroy,eD=["error","close","destroy","pause","resume"];function ej(ei,eo,ea){if("function"==typeof ei.prependListener)return ei.prependListener(eo,ea);ei._events&&ei._events[eo]?Array.isArray(ei._events[eo])?ei._events[eo].unshift(ea):ei._events[eo]=[ea,ei._events[eo]]:ei.on(eo,ea)}function eL(ei,eo,ea){eu=eu||ec(403),ei=ei||{},"boolean"!=typeof ea&&(ea=eo instanceof eu),this.objectMode=!!ei.objectMode,ea&&(this.objectMode=this.objectMode||!!ei.readableObjectMode),this.highWaterMark=eC(this,ei,"readableHighWaterMark",ea),this.buffer=new eT,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==ei.emitClose,this.autoDestroy=!!ei.autoDestroy,this.destroyed=!1,this.defaultEncoding=ei.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,ei.encoding&&(ef||(ef=ec(704).s),this.decoder=new ef(ei.encoding),this.encoding=ei.encoding)}function eN(ei){if(eu=eu||ec(403),!(this instanceof eN))return new eN(ei);var eo=this instanceof eu;this._readableState=new eL(ei,this,eo),this.readable=!0,ei&&("function"==typeof ei.read&&(this._read=ei.read),"function"==typeof ei.destroy&&(this._destroy=ei.destroy)),ey.call(this)}function eU(ei,eo,ea,ec,ed){eh("readableAddChunk",eo);var eu,ef=ei._readableState;if(null===eo)ef.reading=!1,eV(ei,ef);else if(ed||(eu=eF(ef,eo)),eu)eA(ei,eu);else if(ef.objectMode||eo&&eo.length>0){if("string"==typeof eo||ef.objectMode||Object.getPrototypeOf(eo)===eb.prototype||(eo=eE(eo)),ec)ef.endEmitted?eA(ei,new eP):eB(ei,ef,eo,!0);else if(ef.ended)eA(ei,new ek);else{if(ef.destroyed)return!1;ef.reading=!1,ef.decoder&&!ea?(eo=ef.decoder.write(eo),ef.objectMode||0!==eo.length?eB(ei,ef,eo,!1):ez(ei,ef)):eB(ei,ef,eo,!1)}}else ec||(ef.reading=!1,ez(ei,ef));return!ef.ended&&(ef.length<ef.highWaterMark||0===ef.length)}function eB(ei,eo,ea,ec){eo.flowing&&0===eo.length&&!eo.sync?(eo.awaitDrain=0,ei.emit("data",ea)):(eo.length+=eo.objectMode?1:ea.length,ec?eo.buffer.unshift(ea):eo.buffer.push(ea),eo.needReadable&&eG(ei)),ez(ei,eo)}function eF(ei,eo){var ea;return ew(eo)||"string"==typeof eo||void 0===eo||ei.objectMode||(ea=new eR("chunk",["string","Buffer","Uint8Array"],eo)),ea}Object.defineProperty(eN.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(ei){this._readableState&&(this._readableState.destroyed=ei)}}),eN.prototype.destroy=eI.destroy,eN.prototype._undestroy=eI.undestroy,eN.prototype._destroy=function(ei,eo){eo(ei)},eN.prototype.push=function(ei,eo){var ea,ec=this._readableState;return ec.objectMode?ea=!0:"string"==typeof ei&&((eo=eo||ec.defaultEncoding)!==ec.encoding&&(ei=eb.from(ei,eo),eo=""),ea=!0),eU(this,ei,eo,!1,ea)},eN.prototype.unshift=function(ei){return eU(this,ei,null,!0,!1)},eN.prototype.isPaused=function(){return!1===this._readableState.flowing},eN.prototype.setEncoding=function(ei){ef||(ef=ec(704).s);var eo=new ef(ei);this._readableState.decoder=eo,this._readableState.encoding=this._readableState.decoder.encoding;for(var ea=this._readableState.buffer.head,ed="";null!==ea;)ed+=eo.write(ea.data),ea=ea.next;return this._readableState.buffer.clear(),""!==ed&&this._readableState.buffer.push(ed),this._readableState.length=ed.length,this};var eK=1073741824;function e$(ei){return ei>=eK?ei=eK:(ei--,ei|=ei>>>1,ei|=ei>>>2,ei|=ei>>>4,ei|=ei>>>8,ei|=ei>>>16,ei++),ei}function eW(ei,eo){return ei<=0||0===eo.length&&eo.ended?0:eo.objectMode?1:ei!=ei?eo.flowing&&eo.length?eo.buffer.head.data.length:eo.length:(ei>eo.highWaterMark&&(eo.highWaterMark=e$(ei)),ei<=eo.length)?ei:eo.ended?eo.length:(eo.needReadable=!0,0)}function eV(ei,eo){if(eh("onEofChunk"),!eo.ended){if(eo.decoder){var ea=eo.decoder.end();ea&&ea.length&&(eo.buffer.push(ea),eo.length+=eo.objectMode?1:ea.length)}eo.ended=!0,eo.sync?eG(ei):(eo.needReadable=!1,eo.emittedReadable||(eo.emittedReadable=!0,eH(ei)))}}function eG(ei){var eo=ei._readableState;eh("emitReadable",eo.needReadable,eo.emittedReadable),eo.needReadable=!1,eo.emittedReadable||(eh("emitReadable",eo.flowing),eo.emittedReadable=!0,ed.nextTick(eH,ei))}function eH(ei){var eo=ei._readableState;eh("emitReadable_",eo.destroyed,eo.length,eo.ended),!eo.destroyed&&(eo.length||eo.ended)&&(ei.emit("readable"),eo.emittedReadable=!1),eo.needReadable=!eo.flowing&&!eo.ended&&eo.length<=eo.highWaterMark,e1(ei)}function ez(ei,eo){eo.readingMore||(eo.readingMore=!0,ed.nextTick(eY,ei,eo))}function eY(ei,eo){for(;!eo.reading&&!eo.ended&&(eo.length<eo.highWaterMark||eo.flowing&&0===eo.length);){var ea=eo.length;if(eh("maybeReadMore read 0"),ei.read(0),ea===eo.length)break}eo.readingMore=!1}function eJ(ei){return function(){var eo=ei._readableState;eh("pipeOnDrain",eo.awaitDrain),eo.awaitDrain&&eo.awaitDrain--,0===eo.awaitDrain&&em(ei,"data")&&(eo.flowing=!0,e1(ei))}}function eQ(ei){var eo=ei._readableState;eo.readableListening=ei.listenerCount("readable")>0,eo.resumeScheduled&&!eo.paused?eo.flowing=!0:ei.listenerCount("data")>0&&ei.resume()}function eX(ei){eh("readable nexttick read 0"),ei.read(0)}function eZ(ei,eo){eo.resumeScheduled||(eo.resumeScheduled=!0,ed.nextTick(e0,ei,eo))}function e0(ei,eo){eh("resume",eo.reading),eo.reading||ei.read(0),eo.resumeScheduled=!1,ei.emit("resume"),e1(ei),eo.flowing&&!eo.reading&&ei.read(0)}function e1(ei){var eo=ei._readableState;for(eh("flow",eo.flowing);eo.flowing&&null!==ei.read(););}function e2(ei,eo){var ea;return 0===eo.length?null:(eo.objectMode?ea=eo.buffer.shift():!ei||ei>=eo.length?(ea=eo.decoder?eo.buffer.join(""):1===eo.buffer.length?eo.buffer.first():eo.buffer.concat(eo.length),eo.buffer.clear()):ea=eo.buffer.consume(ei,eo.decoder),ea)}function e3(ei){var eo=ei._readableState;eh("endReadable",eo.endEmitted),eo.endEmitted||(eo.ended=!0,ed.nextTick(e6,eo,ei))}function e6(ei,eo){if(eh("endReadableNT",ei.endEmitted,ei.length),!ei.endEmitted&&0===ei.length&&(ei.endEmitted=!0,eo.readable=!1,eo.emit("end"),ei.autoDestroy)){var ea=eo._writableState;(!ea||ea.autoDestroy&&ea.finished)&&eo.destroy()}}function e4(ei,eo){for(var ea=0,ec=ei.length;ea<ec;ea++)if(ei[ea]===eo)return ea;return -1}eN.prototype.read=function(ei){eh("read",ei),ei=parseInt(ei,10);var eo,ea=this._readableState,ec=ei;if(0!==ei&&(ea.emittedReadable=!1),0===ei&&ea.needReadable&&((0!==ea.highWaterMark?ea.length>=ea.highWaterMark:ea.length>0)||ea.ended))return eh("read: emitReadable",ea.length,ea.ended),0===ea.length&&ea.ended?e3(this):eG(this),null;if(0===(ei=eW(ei,ea))&&ea.ended)return 0===ea.length&&e3(this),null;var ed=ea.needReadable;return eh("need readable",ed),(0===ea.length||ea.length-ei<ea.highWaterMark)&&eh("length less than watermark",ed=!0),ea.ended||ea.reading?eh("reading or ended",ed=!1):ed&&(eh("do read"),ea.reading=!0,ea.sync=!0,0===ea.length&&(ea.needReadable=!0),this._read(ea.highWaterMark),ea.sync=!1,ea.reading||(ei=eW(ec,ea))),null===(eo=ei>0?e2(ei,ea):null)?(ea.needReadable=ea.length<=ea.highWaterMark,ei=0):(ea.length-=ei,ea.awaitDrain=0),0===ea.length&&(ea.ended||(ea.needReadable=!0),ec!==ei&&ea.ended&&e3(this)),null!==eo&&this.emit("data",eo),eo},eN.prototype._read=function(ei){eA(this,new eM("_read()"))},eN.prototype.pipe=function(ei,eo){var ea=this,ec=this._readableState;switch(ec.pipesCount){case 0:ec.pipes=ei;break;case 1:ec.pipes=[ec.pipes,ei];break;default:ec.pipes.push(ei)}ec.pipesCount+=1,eh("pipe count=%d opts=%j",ec.pipesCount,eo);var eu=eo&&!1===eo.end||ei===ed.stdout||ei===ed.stderr?eT:ep;function ef(ei,eo){eh("onunpipe"),ei===ea&&eo&&!1===eo.hasUnpiped&&(eo.hasUnpiped=!0,eb())}function ep(){eh("onend"),ei.end()}ec.endEmitted?ed.nextTick(eu):ea.once("end",eu),ei.on("unpipe",ef);var eg=eJ(ea);ei.on("drain",eg);var ey=!1;function eb(){eh("cleanup"),ei.removeListener("close",ew),ei.removeListener("finish",e_),ei.removeListener("drain",eg),ei.removeListener("error",eE),ei.removeListener("unpipe",ef),ea.removeListener("end",ep),ea.removeListener("end",eT),ea.removeListener("data",eS),ey=!0,ec.awaitDrain&&(!ei._writableState||ei._writableState.needDrain)&&eg()}function eS(eo){eh("ondata");var ed=ei.write(eo);eh("dest.write",ed),!1===ed&&((1===ec.pipesCount&&ec.pipes===ei||ec.pipesCount>1&&-1!==e4(ec.pipes,ei))&&!ey&&(eh("false write response, pause",ec.awaitDrain),ec.awaitDrain++),ea.pause())}function eE(eo){eh("onerror",eo),eT(),ei.removeListener("error",eE),0===em(ei,"error")&&eA(ei,eo)}function ew(){ei.removeListener("finish",e_),eT()}function e_(){eh("onfinish"),ei.removeListener("close",ew),eT()}function eT(){eh("unpipe"),ea.unpipe(ei)}return ea.on("data",eS),ej(ei,"error",eE),ei.once("close",ew),ei.once("finish",e_),ei.emit("pipe",ea),ec.flowing||(eh("pipe resume"),ea.resume()),ei},eN.prototype.unpipe=function(ei){var eo=this._readableState,ea={hasUnpiped:!1};if(0===eo.pipesCount)return this;if(1===eo.pipesCount)return ei&&ei!==eo.pipes||(ei||(ei=eo.pipes),eo.pipes=null,eo.pipesCount=0,eo.flowing=!1,ei&&ei.emit("unpipe",this,ea)),this;if(!ei){var ec=eo.pipes,ed=eo.pipesCount;eo.pipes=null,eo.pipesCount=0,eo.flowing=!1;for(var eu=0;eu<ed;eu++)ec[eu].emit("unpipe",this,{hasUnpiped:!1});return this}var eh=e4(eo.pipes,ei);return -1===eh||(eo.pipes.splice(eh,1),eo.pipesCount-=1,1===eo.pipesCount&&(eo.pipes=eo.pipes[0]),ei.emit("unpipe",this,ea)),this},eN.prototype.on=function(ei,eo){var ea=ey.prototype.on.call(this,ei,eo),ec=this._readableState;return"data"===ei?(ec.readableListening=this.listenerCount("readable")>0,!1!==ec.flowing&&this.resume()):"readable"!==ei||ec.endEmitted||ec.readableListening||(ec.readableListening=ec.needReadable=!0,ec.flowing=!1,ec.emittedReadable=!1,eh("on readable",ec.length,ec.reading),ec.length?eG(this):ec.reading||ed.nextTick(eX,this)),ea},eN.prototype.addListener=eN.prototype.on,eN.prototype.removeListener=function(ei,eo){var ea=ey.prototype.removeListener.call(this,ei,eo);return"readable"===ei&&ed.nextTick(eQ,this),ea},eN.prototype.removeAllListeners=function(ei){var eo=ey.prototype.removeAllListeners.apply(this,arguments);return("readable"===ei||void 0===ei)&&ed.nextTick(eQ,this),eo},eN.prototype.resume=function(){var ei=this._readableState;return ei.flowing||(eh("resume"),ei.flowing=!ei.readableListening,eZ(this,ei)),ei.paused=!1,this},eN.prototype.pause=function(){return eh("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(eh("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},eN.prototype.wrap=function(ei){var eo=this,ea=this._readableState,ec=!1;for(var ed in ei.on("end",function(){if(eh("wrapped end"),ea.decoder&&!ea.ended){var ei=ea.decoder.end();ei&&ei.length&&eo.push(ei)}eo.push(null)}),ei.on("data",function(ed){eh("wrapped data"),ea.decoder&&(ed=ea.decoder.write(ed)),(!ea.objectMode||null!=ed)&&(ea.objectMode||ed&&ed.length)&&(eo.push(ed)||(ec=!0,ei.pause()))}),ei)void 0===this[ed]&&"function"==typeof ei[ed]&&(this[ed]=function(eo){return function(){return ei[eo].apply(ei,arguments)}}(ed));for(var eu=0;eu<eD.length;eu++)ei.on(eD[eu],this.emit.bind(this,eD[eu]));return this._read=function(eo){eh("wrapped _read",eo),ec&&(ec=!1,ei.resume())},this},"function"==typeof Symbol&&(eN.prototype[Symbol.asyncIterator]=function(){return void 0===ep&&(ep=ec(871)),ep(this)}),Object.defineProperty(eN.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(eN.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(eN.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(ei){this._readableState&&(this._readableState.flowing=ei)}}),eN._fromList=e2,Object.defineProperty(eN.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(eN.from=function(ei,eo){return void 0===eg&&(eg=ec(727)),eg(eN,ei,eo)})},170:function(ei,eo,ea){"use strict";ei.exports=em;var ec=ea(646).q,ed=ec.ERR_METHOD_NOT_IMPLEMENTED,eu=ec.ERR_MULTIPLE_CALLBACK,eh=ec.ERR_TRANSFORM_ALREADY_TRANSFORMING,ef=ec.ERR_TRANSFORM_WITH_LENGTH_0,ep=ea(403);function eg(ei,eo){var ea=this._transformState;ea.transforming=!1;var ec=ea.writecb;if(null===ec)return this.emit("error",new eu);ea.writechunk=null,ea.writecb=null,null!=eo&&this.push(eo),ec(ei);var ed=this._readableState;ed.reading=!1,(ed.needReadable||ed.length<ed.highWaterMark)&&this._read(ed.highWaterMark)}function em(ei){if(!(this instanceof em))return new em(ei);ep.call(this,ei),this._transformState={afterTransform:eg.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,ei&&("function"==typeof ei.transform&&(this._transform=ei.transform),"function"==typeof ei.flush&&(this._flush=ei.flush)),this.on("prefinish",ey)}function ey(){var ei=this;"function"!=typeof this._flush||this._readableState.destroyed?eb(this,null,null):this._flush(function(eo,ea){eb(ei,eo,ea)})}function eb(ei,eo,ea){if(eo)return ei.emit("error",eo);if(null!=ea&&ei.push(ea),ei._writableState.length)throw new ef;if(ei._transformState.transforming)throw new eh;return ei.push(null)}ea(782)(em,ep),em.prototype.push=function(ei,eo){return this._transformState.needTransform=!1,ep.prototype.push.call(this,ei,eo)},em.prototype._transform=function(ei,eo,ea){ea(new ed("_transform()"))},em.prototype._write=function(ei,eo,ea){var ec=this._transformState;if(ec.writecb=ea,ec.writechunk=ei,ec.writeencoding=eo,!ec.transforming){var ed=this._readableState;(ec.needTransform||ed.needReadable||ed.length<ed.highWaterMark)&&this._read(ed.highWaterMark)}},em.prototype._read=function(ei){var eo=this._transformState;null===eo.writechunk||eo.transforming?eo.needTransform=!0:(eo.transforming=!0,this._transform(eo.writechunk,eo.writeencoding,eo.afterTransform))},em.prototype._destroy=function(ei,eo){ep.prototype._destroy.call(this,ei,function(ei){eo(ei)})}},337:function(ei,eo,ec){"use strict";function eu(ei){var eo=this;this.next=null,this.entry=null,this.finish=function(){e0(eo,ei)}}ei.exports=eL,eL.WritableState=ej;var eh,ef,ep={deprecate:ec(769)},eg=ec(678),em=ec(300).Buffer,ey=ea.g.Uint8Array||function(){};function eb(ei){return em.from(ei)}function eS(ei){return em.isBuffer(ei)||ei instanceof ey}var eE=ec(25),ew=ec(776).getHighWaterMark,e_=ec(646).q,eT=e_.ERR_INVALID_ARG_TYPE,eI=e_.ERR_METHOD_NOT_IMPLEMENTED,eC=e_.ERR_MULTIPLE_CALLBACK,eO=e_.ERR_STREAM_CANNOT_PIPE,eR=e_.ERR_STREAM_DESTROYED,ek=e_.ERR_STREAM_NULL_VALUES,eM=e_.ERR_STREAM_WRITE_AFTER_END,eP=e_.ERR_UNKNOWN_ENCODING,eA=eE.errorOrDestroy;function eD(){}function ej(ei,eo,ea){eh=eh||ec(403),ei=ei||{},"boolean"!=typeof ea&&(ea=eo instanceof eh),this.objectMode=!!ei.objectMode,ea&&(this.objectMode=this.objectMode||!!ei.writableObjectMode),this.highWaterMark=ew(this,ei,"writableHighWaterMark",ea),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var ed=!1===ei.decodeStrings;this.decodeStrings=!ed,this.defaultEncoding=ei.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(ei){eV(eo,ei)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==ei.emitClose,this.autoDestroy=!!ei.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new eu(this)}function eL(ei){var eo=this instanceof(eh=eh||ec(403));if(!eo&&!ef.call(eL,this))return new eL(ei);this._writableState=new ej(ei,this,eo),this.writable=!0,ei&&("function"==typeof ei.write&&(this._write=ei.write),"function"==typeof ei.writev&&(this._writev=ei.writev),"function"==typeof ei.destroy&&(this._destroy=ei.destroy),"function"==typeof ei.final&&(this._final=ei.final)),eg.call(this)}function eN(ei,eo){var ea=new eM;eA(ei,ea),ed.nextTick(eo,ea)}function eU(ei,eo,ea,ec){var eu;return null===ea?eu=new ek:"string"==typeof ea||eo.objectMode||(eu=new eT("chunk",["string","Buffer"],ea)),!eu||(eA(ei,eu),ed.nextTick(ec,eu),!1)}function eB(ei,eo,ea){return ei.objectMode||!1===ei.decodeStrings||"string"!=typeof eo||(eo=em.from(eo,ea)),eo}function eF(ei,eo,ea,ec,ed,eu){if(!ea){var eh=eB(eo,ec,ed);ec!==eh&&(ea=!0,ed="buffer",ec=eh)}var ef=eo.objectMode?1:ec.length;eo.length+=ef;var ep=eo.length<eo.highWaterMark;if(ep||(eo.needDrain=!0),eo.writing||eo.corked){var eg=eo.lastBufferedRequest;eo.lastBufferedRequest={chunk:ec,encoding:ed,isBuf:ea,callback:eu,next:null},eg?eg.next=eo.lastBufferedRequest:eo.bufferedRequest=eo.lastBufferedRequest,eo.bufferedRequestCount+=1}else eK(ei,eo,!1,ef,ec,ed,eu);return ep}function eK(ei,eo,ea,ec,ed,eu,eh){eo.writelen=ec,eo.writecb=eh,eo.writing=!0,eo.sync=!0,eo.destroyed?eo.onwrite(new eR("write")):ea?ei._writev(ed,eo.onwrite):ei._write(ed,eu,eo.onwrite),eo.sync=!1}function e$(ei,eo,ea,ec,eu){--eo.pendingcb,ea?(ed.nextTick(eu,ec),ed.nextTick(eX,ei,eo),ei._writableState.errorEmitted=!0,eA(ei,ec)):(eu(ec),ei._writableState.errorEmitted=!0,eA(ei,ec),eX(ei,eo))}function eW(ei){ei.writing=!1,ei.writecb=null,ei.length-=ei.writelen,ei.writelen=0}function eV(ei,eo){var ea=ei._writableState,ec=ea.sync,eu=ea.writecb;if("function"!=typeof eu)throw new eC;if(eW(ea),eo)e$(ei,ea,ec,eo,eu);else{var eh=eY(ea)||ei.destroyed;eh||ea.corked||ea.bufferProcessing||!ea.bufferedRequest||ez(ei,ea),ec?ed.nextTick(eG,ei,ea,eh,eu):eG(ei,ea,eh,eu)}}function eG(ei,eo,ea,ec){ea||eH(ei,eo),eo.pendingcb--,ec(),eX(ei,eo)}function eH(ei,eo){0===eo.length&&eo.needDrain&&(eo.needDrain=!1,ei.emit("drain"))}function ez(ei,eo){eo.bufferProcessing=!0;var ea=eo.bufferedRequest;if(ei._writev&&ea&&ea.next){var ec=Array(eo.bufferedRequestCount),ed=eo.corkedRequestsFree;ed.entry=ea;for(var eh=0,ef=!0;ea;)ec[eh]=ea,ea.isBuf||(ef=!1),ea=ea.next,eh+=1;ec.allBuffers=ef,eK(ei,eo,!0,eo.length,ec,"",ed.finish),eo.pendingcb++,eo.lastBufferedRequest=null,ed.next?(eo.corkedRequestsFree=ed.next,ed.next=null):eo.corkedRequestsFree=new eu(eo),eo.bufferedRequestCount=0}else{for(;ea;){var ep=ea.chunk,eg=ea.encoding,em=ea.callback,ey=eo.objectMode?1:ep.length;if(eK(ei,eo,!1,ey,ep,eg,em),ea=ea.next,eo.bufferedRequestCount--,eo.writing)break}null===ea&&(eo.lastBufferedRequest=null)}eo.bufferedRequest=ea,eo.bufferProcessing=!1}function eY(ei){return ei.ending&&0===ei.length&&null===ei.bufferedRequest&&!ei.finished&&!ei.writing}function eJ(ei,eo){ei._final(function(ea){eo.pendingcb--,ea&&eA(ei,ea),eo.prefinished=!0,ei.emit("prefinish"),eX(ei,eo)})}function eQ(ei,eo){eo.prefinished||eo.finalCalled||("function"!=typeof ei._final||eo.destroyed?(eo.prefinished=!0,ei.emit("prefinish")):(eo.pendingcb++,eo.finalCalled=!0,ed.nextTick(eJ,ei,eo)))}function eX(ei,eo){var ea=eY(eo);if(ea&&(eQ(ei,eo),0===eo.pendingcb&&(eo.finished=!0,ei.emit("finish"),eo.autoDestroy))){var ec=ei._readableState;(!ec||ec.autoDestroy&&ec.endEmitted)&&ei.destroy()}return ea}function eZ(ei,eo,ea){eo.ending=!0,eX(ei,eo),ea&&(eo.finished?ed.nextTick(ea):ei.once("finish",ea)),eo.ended=!0,ei.writable=!1}function e0(ei,eo,ea){var ec=ei.entry;for(ei.entry=null;ec;){var ed=ec.callback;eo.pendingcb--,ed(ea),ec=ec.next}eo.corkedRequestsFree.next=ei}ec(782)(eL,eg),ej.prototype.getBuffer=function(){for(var ei=this.bufferedRequest,eo=[];ei;)eo.push(ei),ei=ei.next;return eo},function(){try{Object.defineProperty(ej.prototype,"buffer",{get:ep.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(ei){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(ef=Function.prototype[Symbol.hasInstance],Object.defineProperty(eL,Symbol.hasInstance,{value:function(ei){return!!ef.call(this,ei)||this===eL&&ei&&ei._writableState instanceof ej}})):ef=function(ei){return ei instanceof this},eL.prototype.pipe=function(){eA(this,new eO)},eL.prototype.write=function(ei,eo,ea){var ec=this._writableState,ed=!1,eu=!ec.objectMode&&eS(ei);return eu&&!em.isBuffer(ei)&&(ei=eb(ei)),"function"==typeof eo&&(ea=eo,eo=null),eu?eo="buffer":eo||(eo=ec.defaultEncoding),"function"!=typeof ea&&(ea=eD),ec.ending?eN(this,ea):(eu||eU(this,ec,ei,ea))&&(ec.pendingcb++,ed=eF(this,ec,eu,ei,eo,ea)),ed},eL.prototype.cork=function(){this._writableState.corked++},eL.prototype.uncork=function(){var ei=this._writableState;!ei.corked||(ei.corked--,ei.writing||ei.corked||ei.bufferProcessing||!ei.bufferedRequest||ez(this,ei))},eL.prototype.setDefaultEncoding=function(ei){if("string"==typeof ei&&(ei=ei.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((ei+"").toLowerCase())>-1))throw new eP(ei);return this._writableState.defaultEncoding=ei,this},Object.defineProperty(eL.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(eL.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),eL.prototype._write=function(ei,eo,ea){ea(new eI("_write()"))},eL.prototype._writev=null,eL.prototype.end=function(ei,eo,ea){var ec=this._writableState;return"function"==typeof ei?(ea=ei,ei=null,eo=null):"function"==typeof eo&&(ea=eo,eo=null),null!=ei&&this.write(ei,eo),ec.corked&&(ec.corked=1,this.uncork()),ec.ending||eZ(this,ec,ea),this},Object.defineProperty(eL.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(eL.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(ei){this._writableState&&(this._writableState.destroyed=ei)}}),eL.prototype.destroy=eE.destroy,eL.prototype._undestroy=eE.undestroy,eL.prototype._destroy=function(ei,eo){eo(ei)}},871:function(ei,eo,ea){"use strict";function ec(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var eu,eh=ea(698),ef=Symbol("lastResolve"),ep=Symbol("lastReject"),eg=Symbol("error"),em=Symbol("ended"),ey=Symbol("lastPromise"),eb=Symbol("handlePromise"),eS=Symbol("stream");function eE(ei,eo){return{value:ei,done:eo}}function ew(ei){var eo=ei[ef];if(null!==eo){var ea=ei[eS].read();null!==ea&&(ei[ey]=null,ei[ef]=null,ei[ep]=null,eo(eE(ea,!1)))}}function e_(ei){ed.nextTick(ew,ei)}function eT(ei,eo){return function(ea,ec){ei.then(function(){if(eo[em]){ea(eE(void 0,!0));return}eo[eb](ea,ec)},ec)}}var eI=Object.getPrototypeOf(function(){}),eC=Object.setPrototypeOf((ec(eu={get stream(){return this[eS]},next:function(){var ei,eo=this,ea=this[eg];if(null!==ea)return Promise.reject(ea);if(this[em])return Promise.resolve(eE(void 0,!0));if(this[eS].destroyed)return new Promise(function(ei,ea){ed.nextTick(function(){eo[eg]?ea(eo[eg]):ei(eE(void 0,!0))})});var ec=this[ey];if(ec)ei=new Promise(eT(ec,this));else{var eu=this[eS].read();if(null!==eu)return Promise.resolve(eE(eu,!1));ei=new Promise(this[eb])}return this[ey]=ei,ei}},Symbol.asyncIterator,function(){return this}),ec(eu,"return",function(){var ei=this;return new Promise(function(eo,ea){ei[eS].destroy(null,function(ei){if(ei){ea(ei);return}eo(eE(void 0,!0))})})}),eu),eI),eO=function(ei){var eo,ea=Object.create(eC,(ec(eo={},eS,{value:ei,writable:!0}),ec(eo,ef,{value:null,writable:!0}),ec(eo,ep,{value:null,writable:!0}),ec(eo,eg,{value:null,writable:!0}),ec(eo,em,{value:ei._readableState.endEmitted,writable:!0}),ec(eo,eb,{value:function(ei,eo){var ec=ea[eS].read();ec?(ea[ey]=null,ea[ef]=null,ea[ep]=null,ei(eE(ec,!1))):(ea[ef]=ei,ea[ep]=eo)},writable:!0}),eo));return ea[ey]=null,eh(ei,function(ei){if(ei&&"ERR_STREAM_PREMATURE_CLOSE"!==ei.code){var eo=ea[ep];null!==eo&&(ea[ey]=null,ea[ef]=null,ea[ep]=null,eo(ei)),ea[eg]=ei;return}var ec=ea[ef];null!==ec&&(ea[ey]=null,ea[ef]=null,ea[ep]=null,ec(eE(void 0,!0))),ea[em]=!0}),ei.on("readable",e_.bind(null,ea)),ea};ei.exports=eO},379:function(ei,eo,ea){"use strict";function ec(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ed(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ec(Object(ea),!0).forEach(function(eo){eu(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ec(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eu(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function eh(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function ef(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,ec.key,ec)}}function ep(ei,eo,ea){return eo&&ef(ei.prototype,eo),ea&&ef(ei,ea),ei}var eg=ea(300).Buffer,em=ea(837).inspect,ey=em&&em.custom||"inspect";function eb(ei,eo,ea){eg.prototype.copy.call(ei,eo,ea)}ei.exports=function(){function ei(){eh(this,ei),this.head=null,this.tail=null,this.length=0}return ep(ei,[{key:"push",value:function(ei){var eo={data:ei,next:null};this.length>0?this.tail.next=eo:this.head=eo,this.tail=eo,++this.length}},{key:"unshift",value:function(ei){var eo={data:ei,next:this.head};0===this.length&&(this.tail=eo),this.head=eo,++this.length}},{key:"shift",value:function(){if(0!==this.length){var ei=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,ei}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(ei){if(0===this.length)return"";for(var eo=this.head,ea=""+eo.data;eo=eo.next;)ea+=ei+eo.data;return ea}},{key:"concat",value:function(ei){if(0===this.length)return eg.alloc(0);for(var eo=eg.allocUnsafe(ei>>>0),ea=this.head,ec=0;ea;)eb(ea.data,eo,ec),ec+=ea.data.length,ea=ea.next;return eo}},{key:"consume",value:function(ei,eo){var ea;return ei<this.head.data.length?(ea=this.head.data.slice(0,ei),this.head.data=this.head.data.slice(ei)):ea=ei===this.head.data.length?this.shift():eo?this._getString(ei):this._getBuffer(ei),ea}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(ei){var eo=this.head,ea=1,ec=eo.data;for(ei-=ec.length;eo=eo.next;){var ed=eo.data,eu=ei>ed.length?ed.length:ei;if(eu===ed.length?ec+=ed:ec+=ed.slice(0,ei),0==(ei-=eu)){eu===ed.length?(++ea,eo.next?this.head=eo.next:this.head=this.tail=null):(this.head=eo,eo.data=ed.slice(eu));break}++ea}return this.length-=ea,ec}},{key:"_getBuffer",value:function(ei){var eo=eg.allocUnsafe(ei),ea=this.head,ec=1;for(ea.data.copy(eo),ei-=ea.data.length;ea=ea.next;){var ed=ea.data,eu=ei>ed.length?ed.length:ei;if(ed.copy(eo,eo.length-ei,0,eu),0==(ei-=eu)){eu===ed.length?(++ec,ea.next?this.head=ea.next:this.head=this.tail=null):(this.head=ea,ea.data=ed.slice(eu));break}++ec}return this.length-=ec,eo}},{key:ey,value:function(ei,eo){return em(this,ed({},eo,{depth:0,customInspect:!1}))}}]),ei}()},25:function(ei){"use strict";function eo(ei,eo){var eu=this,ef=this._readableState&&this._readableState.destroyed,ep=this._writableState&&this._writableState.destroyed;return ef||ep?(eo?eo(ei):ei&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,ed.nextTick(eh,this,ei)):ed.nextTick(eh,this,ei)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(ei||null,function(ei){!eo&&ei?eu._writableState?eu._writableState.errorEmitted?ed.nextTick(ec,eu):(eu._writableState.errorEmitted=!0,ed.nextTick(ea,eu,ei)):ed.nextTick(ea,eu,ei):eo?(ed.nextTick(ec,eu),eo(ei)):ed.nextTick(ec,eu)}),this)}function ea(ei,eo){eh(ei,eo),ec(ei)}function ec(ei){(!ei._writableState||ei._writableState.emitClose)&&(!ei._readableState||ei._readableState.emitClose)&&ei.emit("close")}function eu(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function eh(ei,eo){ei.emit("error",eo)}function ef(ei,eo){var ea=ei._readableState,ec=ei._writableState;ea&&ea.autoDestroy||ec&&ec.autoDestroy?ei.destroy(eo):ei.emit("error",eo)}ei.exports={destroy:eo,undestroy:eu,errorOrDestroy:ef}},698:function(ei,eo,ea){"use strict";var ec=ea(646).q.ERR_STREAM_PREMATURE_CLOSE;function ed(ei){var eo=!1;return function(){if(!eo){eo=!0;for(var ea=arguments.length,ec=Array(ea),ed=0;ed<ea;ed++)ec[ed]=arguments[ed];ei.apply(this,ec)}}}function eu(){}function eh(ei){return ei.setHeader&&"function"==typeof ei.abort}function ef(ei,eo,ea){if("function"==typeof eo)return ef(ei,null,eo);eo||(eo={}),ea=ed(ea||eu);var ep=eo.readable||!1!==eo.readable&&ei.readable,eg=eo.writable||!1!==eo.writable&&ei.writable,em=function(){ei.writable||eb()},ey=ei._writableState&&ei._writableState.finished,eb=function(){eg=!1,ey=!0,ep||ea.call(ei)},eS=ei._readableState&&ei._readableState.endEmitted,eE=function(){ep=!1,eS=!0,eg||ea.call(ei)},ew=function(eo){ea.call(ei,eo)},e_=function(){var eo;return ep&&!eS?(ei._readableState&&ei._readableState.ended||(eo=new ec),ea.call(ei,eo)):eg&&!ey?(ei._writableState&&ei._writableState.ended||(eo=new ec),ea.call(ei,eo)):void 0},eT=function(){ei.req.on("finish",eb)};return eh(ei)?(ei.on("complete",eb),ei.on("abort",e_),ei.req?eT():ei.on("request",eT)):eg&&!ei._writableState&&(ei.on("end",em),ei.on("close",em)),ei.on("end",eE),ei.on("finish",eb),!1!==eo.error&&ei.on("error",ew),ei.on("close",e_),function(){ei.removeListener("complete",eb),ei.removeListener("abort",e_),ei.removeListener("request",eT),ei.req&&ei.req.removeListener("finish",eb),ei.removeListener("end",em),ei.removeListener("close",em),ei.removeListener("finish",eb),ei.removeListener("end",eE),ei.removeListener("error",ew),ei.removeListener("close",e_)}}ei.exports=ef},727:function(ei,eo,ea){"use strict";function ec(ei,eo,ea,ec,ed,eu,eh){try{var ef=ei[eu](eh),ep=ef.value}catch(ei){ea(ei);return}ef.done?eo(ep):Promise.resolve(ep).then(ec,ed)}function ed(ei){return function(){var eo=this,ea=arguments;return new Promise(function(ed,eu){var eh=ei.apply(eo,ea);function ef(ei){ec(eh,ed,eu,ef,ep,"next",ei)}function ep(ei){ec(eh,ed,eu,ef,ep,"throw",ei)}ef(void 0)})}}function eu(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function eh(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?eu(Object(ea),!0).forEach(function(eo){ef(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):eu(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function ef(ei,eo,ea){return eo in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}var ep=ea(646).q.ERR_INVALID_ARG_TYPE;function eg(ei,eo,ea){if(eo&&"function"==typeof eo.next)ec=eo;else if(eo&&eo[Symbol.asyncIterator])ec=eo[Symbol.asyncIterator]();else if(eo&&eo[Symbol.iterator])ec=eo[Symbol.iterator]();else throw new ep("iterable",["Iterable"],eo);var ec,eu=new ei(eh({objectMode:!0},ea)),ef=!1;function eg(){return em.apply(this,arguments)}function em(){return(em=ed(function*(){try{var ei=yield ec.next(),eo=ei.value;ei.done?eu.push(null):eu.push((yield eo))?eg():ef=!1}catch(ei){eu.destroy(ei)}})).apply(this,arguments)}return eu._read=function(){ef||(ef=!0,eg())},eu}ei.exports=eg},442:function(ei,eo,ea){"use strict";function ec(ei){var eo=!1;return function(){eo||(eo=!0,ei.apply(void 0,arguments))}}var ed,eu=ea(646).q,eh=eu.ERR_MISSING_ARGS,ef=eu.ERR_STREAM_DESTROYED;function ep(ei){if(ei)throw ei}function eg(ei){return ei.setHeader&&"function"==typeof ei.abort}function em(ei,eo,eu,eh){eh=ec(eh);var ep=!1;ei.on("close",function(){ep=!0}),void 0===ed&&(ed=ea(698)),ed(ei,{readable:eo,writable:eu},function(ei){if(ei)return eh(ei);ep=!0,eh()});var em=!1;return function(eo){if(!ep&&!em){if(em=!0,eg(ei))return ei.abort();if("function"==typeof ei.destroy)return ei.destroy();eh(eo||new ef("pipe"))}}}function ey(ei){ei()}function eb(ei,eo){return ei.pipe(eo)}function eS(ei){return ei.length&&"function"==typeof ei[ei.length-1]?ei.pop():ep}function eE(){for(var ei,eo=arguments.length,ea=Array(eo),ec=0;ec<eo;ec++)ea[ec]=arguments[ec];var ed=eS(ea);if(Array.isArray(ea[0])&&(ea=ea[0]),ea.length<2)throw new eh("streams");var eu=ea.map(function(eo,ec){var eh=ec<ea.length-1;return em(eo,eh,ec>0,function(eo){ei||(ei=eo),eo&&eu.forEach(ey),eh||(eu.forEach(ey),ed(ei))})});return ea.reduce(eb)}ei.exports=eE},776:function(ei,eo,ea){"use strict";var ec=ea(646).q.ERR_INVALID_OPT_VALUE;function ed(ei,eo,ea){return null!=ei.highWaterMark?ei.highWaterMark:eo?ei[ea]:null}function eu(ei,eo,ea,eu){var eh=ed(eo,eu,ea);if(null!=eh){if(!(isFinite(eh)&&Math.floor(eh)===eh)||eh<0){var ef=eu?ea:"highWaterMark";throw new ec(ef,eh)}return Math.floor(eh)}return ei.objectMode?16:16384}ei.exports={getHighWaterMark:eu}},678:function(ei,eo,ea){ei.exports=ea(781)},55:function(ei,eo,ea){var ec=ea(300),ed=ec.Buffer;function eu(ei,eo){for(var ea in ei)eo[ea]=ei[ea]}function eh(ei,eo,ea){return ed(ei,eo,ea)}ed.from&&ed.alloc&&ed.allocUnsafe&&ed.allocUnsafeSlow?ei.exports=ec:(eu(ec,eo),eo.Buffer=eh),eh.prototype=Object.create(ed.prototype),eu(ed,eh),eh.from=function(ei,eo,ea){if("number"==typeof ei)throw TypeError("Argument must not be a number");return ed(ei,eo,ea)},eh.alloc=function(ei,eo,ea){if("number"!=typeof ei)throw TypeError("Argument must be a number");var ec=ed(ei);return void 0!==eo?"string"==typeof ea?ec.fill(eo,ea):ec.fill(eo):ec.fill(0),ec},eh.allocUnsafe=function(ei){if("number"!=typeof ei)throw TypeError("Argument must be a number");return ed(ei)},eh.allocUnsafeSlow=function(ei){if("number"!=typeof ei)throw TypeError("Argument must be a number");return ec.SlowBuffer(ei)}},173:function(ei,eo,ea){ei.exports=ed;var ec=ea(361).EventEmitter;function ed(){ec.call(this)}ea(782)(ed,ec),ed.Readable=ea(709),ed.Writable=ea(337),ed.Duplex=ea(403),ed.Transform=ea(170),ed.PassThrough=ea(889),ed.finished=ea(698),ed.pipeline=ea(442),ed.Stream=ed,ed.prototype.pipe=function(ei,eo){var ea=this;function ed(eo){ei.writable&&!1===ei.write(eo)&&ea.pause&&ea.pause()}function eu(){ea.readable&&ea.resume&&ea.resume()}ea.on("data",ed),ei.on("drain",eu),ei._isStdio||eo&&!1===eo.end||(ea.on("end",ef),ea.on("close",ep));var eh=!1;function ef(){eh||(eh=!0,ei.end())}function ep(){eh||(eh=!0,"function"==typeof ei.destroy&&ei.destroy())}function eg(ei){if(em(),0===ec.listenerCount(this,"error"))throw ei}function em(){ea.removeListener("data",ed),ei.removeListener("drain",eu),ea.removeListener("end",ef),ea.removeListener("close",ep),ea.removeListener("error",eg),ei.removeListener("error",eg),ea.removeListener("end",em),ea.removeListener("close",em),ei.removeListener("close",em)}return ea.on("error",eg),ei.on("error",eg),ea.on("end",em),ea.on("close",em),ei.on("close",em),ei.emit("pipe",ea),ei}},704:function(ei,eo,ea){"use strict";var ec=ea(55).Buffer,ed=ec.isEncoding||function(ei){switch((ei=""+ei)&&ei.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function eu(ei){var eo;if(!ei)return"utf8";for(;;)switch(ei){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return ei;default:if(eo)return;ei=(""+ei).toLowerCase(),eo=!0}}function eh(ei){var eo=eu(ei);if("string"!=typeof eo&&(ec.isEncoding===ed||!ed(ei)))throw Error("Unknown encoding: "+ei);return eo||ei}function ef(ei){var eo;switch(this.encoding=eh(ei),this.encoding){case"utf16le":this.text=eE,this.end=ew,eo=4;break;case"utf8":this.fillLast=ey,eo=4;break;case"base64":this.text=e_,this.end=eT,eo=3;break;default:this.write=eI,this.end=eC;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=ec.allocUnsafe(eo)}function ep(ei){return ei<=127?0:ei>>5==6?2:ei>>4==14?3:ei>>3==30?4:ei>>6==2?-1:-2}function eg(ei,eo,ea){var ec=eo.length-1;if(ec<ea)return 0;var ed=ep(eo[ec]);return ed>=0?(ed>0&&(ei.lastNeed=ed-1),ed):--ec<ea||-2===ed?0:(ed=ep(eo[ec]))>=0?(ed>0&&(ei.lastNeed=ed-2),ed):--ec<ea||-2===ed?0:(ed=ep(eo[ec]))>=0?(ed>0&&(2===ed?ed=0:ei.lastNeed=ed-3),ed):0}function em(ei,eo,ea){if((192&eo[0])!=128)return ei.lastNeed=0,"";if(ei.lastNeed>1&&eo.length>1){if((192&eo[1])!=128)return ei.lastNeed=1,"";if(ei.lastNeed>2&&eo.length>2&&(192&eo[2])!=128)return ei.lastNeed=2,""}}function ey(ei){var eo=this.lastTotal-this.lastNeed,ea=em(this,ei,eo);return void 0!==ea?ea:this.lastNeed<=ei.length?(ei.copy(this.lastChar,eo,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):void(ei.copy(this.lastChar,eo,0,ei.length),this.lastNeed-=ei.length)}function eb(ei,eo){var ea=eg(this,ei,eo);if(!this.lastNeed)return ei.toString("utf8",eo);this.lastTotal=ea;var ec=ei.length-(ea-this.lastNeed);return ei.copy(this.lastChar,0,ec),ei.toString("utf8",eo,ec)}function eS(ei){var eo=ei&&ei.length?this.write(ei):"";return this.lastNeed?eo+"":eo}function eE(ei,eo){if((ei.length-eo)%2==0){var ea=ei.toString("utf16le",eo);if(ea){var ec=ea.charCodeAt(ea.length-1);if(ec>=55296&&ec<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=ei[ei.length-2],this.lastChar[1]=ei[ei.length-1],ea.slice(0,-1)}return ea}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=ei[ei.length-1],ei.toString("utf16le",eo,ei.length-1)}function ew(ei){var eo=ei&&ei.length?this.write(ei):"";if(this.lastNeed){var ea=this.lastTotal-this.lastNeed;return eo+this.lastChar.toString("utf16le",0,ea)}return eo}function e_(ei,eo){var ea=(ei.length-eo)%3;return 0===ea?ei.toString("base64",eo):(this.lastNeed=3-ea,this.lastTotal=3,1===ea?this.lastChar[0]=ei[ei.length-1]:(this.lastChar[0]=ei[ei.length-2],this.lastChar[1]=ei[ei.length-1]),ei.toString("base64",eo,ei.length-ea))}function eT(ei){var eo=ei&&ei.length?this.write(ei):"";return this.lastNeed?eo+this.lastChar.toString("base64",0,3-this.lastNeed):eo}function eI(ei){return ei.toString(this.encoding)}function eC(ei){return ei&&ei.length?this.write(ei):""}eo.s=ef,ef.prototype.write=function(ei){var eo,ea;if(0===ei.length)return"";if(this.lastNeed){if(void 0===(eo=this.fillLast(ei)))return"";ea=this.lastNeed,this.lastNeed=0}else ea=0;return ea<ei.length?eo?eo+this.text(ei,ea):this.text(ei,ea):eo||""},ef.prototype.end=eS,ef.prototype.text=eb,ef.prototype.fillLast=function(ei){if(this.lastNeed<=ei.length)return ei.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);ei.copy(this.lastChar,this.lastTotal-this.lastNeed,0,ei.length),this.lastNeed-=ei.length}},769:function(ei){function eo(ei,eo){if(ec("noDeprecation"))return ei;var ea=!1;return function(){if(!ea){if(ec("throwDeprecation"))throw Error(eo);ec("traceDeprecation")?console.trace(eo):console.warn(eo),ea=!0}return ei.apply(this,arguments)}}function ec(ei){try{if(!ea.g.localStorage)return!1}catch(ei){return!1}var eo=ea.g.localStorage[ei];return null!=eo&&"true"===String(eo).toLowerCase()}ei.exports=eo},300:function(ei){"use strict";ei.exports=ea(8764)},361:function(ei){"use strict";ei.exports=ea(7187)},781:function(ei){"use strict";ei.exports=ea(7187).EventEmitter},837:function(ei){"use strict";ei.exports=ea(9720)}},eu={};function eh(ei){var ea=eu[ei];if(void 0!==ea)return ea.exports;var ec=eu[ei]={exports:{}},ed=!0;try{eo[ei](ec,ec.exports,eh),ed=!1}finally{ed&&delete eu[ei]}return ec.exports}eh.ab=ec+"/";var ef=eh(173);ei.exports=ef}()},9720:function(ei,eo,ea){var ec="/",ed=ea(8764).Buffer,eu=ea(3454);!function(){var eo={992:function(ei){ei.exports=function(ei,ea,ec){if(ei.filter)return ei.filter(ea,ec);if(null==ei||"function"!=typeof ea)throw TypeError();for(var ed=[],eu=0;eu<ei.length;eu++)if(eo.call(ei,eu)){var eh=ei[eu];ea.call(ec,eh,eu,ei)&&ed.push(eh)}return ed};var eo=Object.prototype.hasOwnProperty},256:function(ei,eo,ea){"use strict";var ec=ea(500),ed=ea(139),eu=ed(ec("String.prototype.indexOf"));ei.exports=function(ei,eo){var ea=ec(ei,!!eo);return"function"==typeof ea&&eu(ei,".prototype.")>-1?ed(ea):ea}},139:function(ei,eo,ea){"use strict";var ec=ea(174),ed=ea(500),eu=ed("%Function.prototype.apply%"),eh=ed("%Function.prototype.call%"),ef=ed("%Reflect.apply%",!0)||ec.call(eh,eu),ep=ed("%Object.getOwnPropertyDescriptor%",!0),eg=ed("%Object.defineProperty%",!0),em=ed("%Math.max%");if(eg)try{eg({},"a",{value:1})}catch(ei){eg=null}ei.exports=function(ei){var eo=ef(ec,eh,arguments);return ep&&eg&&ep(eo,"length").configurable&&eg(eo,"length",{value:1+em(0,ei.length-(arguments.length-1))}),eo};var ey=function(){return ef(ec,eu,arguments)};eg?eg(ei.exports,"apply",{value:ey}):ei.exports.apply=ey},144:function(ei){var eo=Object.prototype.hasOwnProperty,ea=Object.prototype.toString;ei.exports=function(ei,ec,ed){if("[object Function]"!==ea.call(ec))throw TypeError("iterator must be a function");var eu=ei.length;if(eu===+eu)for(var eh=0;eh<eu;eh++)ec.call(ed,ei[eh],eh,ei);else for(var ef in ei)eo.call(ei,ef)&&ec.call(ed,ei[ef],ef,ei)}},426:function(ei){"use strict";var eo="Function.prototype.bind called on incompatible ",ea=Array.prototype.slice,ec=Object.prototype.toString,ed="[object Function]";ei.exports=function(ei){var eu,eh=this;if("function"!=typeof eh||ec.call(eh)!==ed)throw TypeError(eo+eh);for(var ef=ea.call(arguments,1),ep=function(){if(!(this instanceof eu))return eh.apply(ei,ef.concat(ea.call(arguments)));var eo=eh.apply(this,ef.concat(ea.call(arguments)));return Object(eo)===eo?eo:this},eg=Math.max(0,eh.length-ef.length),em=[],ey=0;ey<eg;ey++)em.push("$"+ey);if(eu=Function("binder","return function ("+em.join(",")+"){ return binder.apply(this,arguments); }")(ep),eh.prototype){var eb=function(){};eb.prototype=eh.prototype,eu.prototype=new eb,eb.prototype=null}return eu}},174:function(ei,eo,ea){"use strict";var ec=ea(426);ei.exports=Function.prototype.bind||ec},500:function(ei,eo,ea){"use strict";var ec,ed=SyntaxError,eu=Function,eh=TypeError,ef=function(ei){try{return eu('"use strict"; return ('+ei+").constructor;")()}catch(ei){}},ep=Object.getOwnPropertyDescriptor;if(ep)try{ep({},"")}catch(ei){ep=null}var eg=function(){throw new eh},em=ep?function(){try{return arguments.callee,eg}catch(ei){try{return ep(arguments,"callee").get}catch(ei){return eg}}}():eg,ey=ea(115)(),eb=Object.getPrototypeOf||function(ei){return ei.__proto__},eS={},eE="undefined"==typeof Uint8Array?ec:eb(Uint8Array),ew={"%AggregateError%":"undefined"==typeof AggregateError?ec:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?ec:ArrayBuffer,"%ArrayIteratorPrototype%":ey?eb([][Symbol.iterator]()):ec,"%AsyncFromSyncIteratorPrototype%":ec,"%AsyncFunction%":eS,"%AsyncGenerator%":eS,"%AsyncGeneratorFunction%":eS,"%AsyncIteratorPrototype%":eS,"%Atomics%":"undefined"==typeof Atomics?ec:Atomics,"%BigInt%":"undefined"==typeof BigInt?ec:BigInt,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?ec:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?ec:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?ec:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?ec:FinalizationRegistry,"%Function%":eu,"%GeneratorFunction%":eS,"%Int8Array%":"undefined"==typeof Int8Array?ec:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?ec:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?ec:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":ey?eb(eb([][Symbol.iterator]())):ec,"%JSON%":"object"==typeof JSON?JSON:ec,"%Map%":"undefined"==typeof Map?ec:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&ey?eb((new Map)[Symbol.iterator]()):ec,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?ec:Promise,"%Proxy%":"undefined"==typeof Proxy?ec:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?ec:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?ec:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&ey?eb((new Set)[Symbol.iterator]()):ec,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?ec:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":ey?eb(""[Symbol.iterator]()):ec,"%Symbol%":ey?Symbol:ec,"%SyntaxError%":ed,"%ThrowTypeError%":em,"%TypedArray%":eE,"%TypeError%":eh,"%Uint8Array%":"undefined"==typeof Uint8Array?ec:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?ec:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?ec:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?ec:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?ec:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?ec:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?ec:WeakSet},e_=function ei(eo){var ea;if("%AsyncFunction%"===eo)ea=ef("async function () {}");else if("%GeneratorFunction%"===eo)ea=ef("function* () {}");else if("%AsyncGeneratorFunction%"===eo)ea=ef("async function* () {}");else if("%AsyncGenerator%"===eo){var ec=ei("%AsyncGeneratorFunction%");ec&&(ea=ec.prototype)}else if("%AsyncIteratorPrototype%"===eo){var ed=ei("%AsyncGenerator%");ed&&(ea=eb(ed.prototype))}return ew[eo]=ea,ea},eT={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},eI=ea(174),eC=ea(101),eO=eI.call(Function.call,Array.prototype.concat),eR=eI.call(Function.apply,Array.prototype.splice),ek=eI.call(Function.call,String.prototype.replace),eM=eI.call(Function.call,String.prototype.slice),eP=eI.call(Function.call,RegExp.prototype.exec),eA=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,eD=/\\(\\)?/g,ej=function(ei){var eo=eM(ei,0,1),ea=eM(ei,-1);if("%"===eo&&"%"!==ea)throw new ed("invalid intrinsic syntax, expected closing `%`");if("%"===ea&&"%"!==eo)throw new ed("invalid intrinsic syntax, expected opening `%`");var ec=[];return ek(ei,eA,function(ei,eo,ea,ed){ec[ec.length]=ea?ek(ed,eD,"$1"):eo||ei}),ec},eL=function(ei,eo){var ea,ec=ei;if(eC(eT,ec)&&(ec="%"+(ea=eT[ec])[0]+"%"),eC(ew,ec)){var eu=ew[ec];if(eu===eS&&(eu=e_(ec)),void 0===eu&&!eo)throw new eh("intrinsic "+ei+" exists, but is not available. Please file an issue!");return{alias:ea,name:ec,value:eu}}throw new ed("intrinsic "+ei+" does not exist!")};ei.exports=function(ei,eo){if("string"!=typeof ei||0===ei.length)throw new eh("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof eo)throw new eh('"allowMissing" argument must be a boolean');if(null===eP(/^%?[^%]*%?$/g,ei))throw new ed("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var ea=ej(ei),ec=ea.length>0?ea[0]:"",eu=eL("%"+ec+"%",eo),ef=eu.name,eg=eu.value,em=!1,ey=eu.alias;ey&&(ec=ey[0],eR(ea,eO([0,1],ey)));for(var eb=1,eS=!0;eb<ea.length;eb+=1){var eE=ea[eb],e_=eM(eE,0,1),eT=eM(eE,-1);if(('"'===e_||"'"===e_||"`"===e_||'"'===eT||"'"===eT||"`"===eT)&&e_!==eT)throw new ed("property names with quotes must have matching quotes");if("constructor"!==eE&&eS||(em=!0),ec+="."+eE,eC(ew,ef="%"+ec+"%"))eg=ew[ef];else if(null!=eg){if(!(eE in eg)){if(!eo)throw new eh("base intrinsic for "+ei+" exists, but the property is not available.");return}if(ep&&eb+1>=ea.length){var eI=ep(eg,eE);eg=(eS=!!eI)&&"get"in eI&&!("originalValue"in eI.get)?eI.get:eg[eE]}else eS=eC(eg,eE),eg=eg[eE];eS&&!em&&(ew[ef]=eg)}}return eg}},942:function(ei,eo,ea){"use strict";var ec="undefined"!=typeof Symbol&&Symbol,ed=ea(773);ei.exports=function(){return"function"==typeof ec&&"function"==typeof Symbol&&"symbol"==typeof ec("foo")&&"symbol"==typeof Symbol("bar")&&ed()}},773:function(ei){"use strict";ei.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var ei={},eo=Symbol("test"),ea=Object(eo);if("string"==typeof eo||"[object Symbol]"!==Object.prototype.toString.call(eo)||"[object Symbol]"!==Object.prototype.toString.call(ea))return!1;var ec=42;for(eo in ei[eo]=ec,ei)return!1;if("function"==typeof Object.keys&&0!==Object.keys(ei).length||"function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(ei).length)return!1;var ed=Object.getOwnPropertySymbols(ei);if(1!==ed.length||ed[0]!==eo||!Object.prototype.propertyIsEnumerable.call(ei,eo))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var eu=Object.getOwnPropertyDescriptor(ei,eo);if(eu.value!==ec||!0!==eu.enumerable)return!1}return!0}},115:function(ei,eo,ea){"use strict";var ec="undefined"!=typeof Symbol&&Symbol,ed=ea(832);ei.exports=function(){return"function"==typeof ec&&"function"==typeof Symbol&&"symbol"==typeof ec("foo")&&"symbol"==typeof Symbol("bar")&&ed()}},832:function(ei){"use strict";ei.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var ei={},eo=Symbol("test"),ea=Object(eo);if("string"==typeof eo||"[object Symbol]"!==Object.prototype.toString.call(eo)||"[object Symbol]"!==Object.prototype.toString.call(ea))return!1;var ec=42;for(eo in ei[eo]=ec,ei)return!1;if("function"==typeof Object.keys&&0!==Object.keys(ei).length||"function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(ei).length)return!1;var ed=Object.getOwnPropertySymbols(ei);if(1!==ed.length||ed[0]!==eo||!Object.prototype.propertyIsEnumerable.call(ei,eo))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var eu=Object.getOwnPropertyDescriptor(ei,eo);if(eu.value!==ec||!0!==eu.enumerable)return!1}return!0}},101:function(ei,eo,ea){"use strict";var ec=ea(174);ei.exports=ec.call(Function.call,Object.prototype.hasOwnProperty)},782:function(ei){"function"==typeof Object.create?ei.exports=function(ei,eo){eo&&(ei.super_=eo,ei.prototype=Object.create(eo.prototype,{constructor:{value:ei,enumerable:!1,writable:!0,configurable:!0}}))}:ei.exports=function(ei,eo){if(eo){ei.super_=eo;var ea=function(){};ea.prototype=eo.prototype,ei.prototype=new ea,ei.prototype.constructor=ei}}},157:function(ei){"use strict";var eo="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,ea=Object.prototype.toString,ec=function(ei){return(!eo||!ei||"object"!=typeof ei||!(Symbol.toStringTag in ei))&&"[object Arguments]"===ea.call(ei)},ed=function(ei){return!!ec(ei)||null!==ei&&"object"==typeof ei&&"number"==typeof ei.length&&ei.length>=0&&"[object Array]"!==ea.call(ei)&&"[object Function]"===ea.call(ei.callee)},eu=function(){return ec(arguments)}();ec.isLegacyArguments=ed,ei.exports=eu?ec:ed},391:function(ei){"use strict";var eo=Object.prototype.toString,ea=Function.prototype.toString,ec=/^\s*(?:function)?\*/,ed="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,eu=Object.getPrototypeOf,eh=function(){if(!ed)return!1;try{return Function("return function*() {}")()}catch(ei){}}(),ef=eh?eu(eh):{};ei.exports=function(ei){return"function"==typeof ei&&(!!ec.test(ea.call(ei))||(ed?eu(ei)===ef:"[object GeneratorFunction]"===eo.call(ei)))}},994:function(ei,eo,ec){"use strict";var ed=ec(144),eu=ec(349),eh=ec(256),ef=eh("Object.prototype.toString"),ep=ec(942)()&&"symbol"==typeof Symbol.toStringTag,eg=eu(),em=eh("Array.prototype.indexOf",!0)||function(ei,eo){for(var ea=0;ea<ei.length;ea+=1)if(ei[ea]===eo)return ea;return -1},ey=eh("String.prototype.slice"),eb={},eS=ec(466),eE=Object.getPrototypeOf;ep&&eS&&eE&&ed(eg,function(ei){var eo=new ea.g[ei];if(!(Symbol.toStringTag in eo))throw EvalError("this engine has support for Symbol.toStringTag, but "+ei+" does not have the property! Please report this.");var ec=eE(eo),ed=eS(ec,Symbol.toStringTag);ed||(ed=eS(eE(ec),Symbol.toStringTag)),eb[ei]=ed.get});var ew=function(ei){var eo=!1;return ed(eb,function(ea,ec){if(!eo)try{eo=ea.call(ei)===ec}catch(ei){}}),eo};ei.exports=function(ei){return!!ei&&"object"==typeof ei&&(ep?!!eS&&ew(ei):em(eg,ey(ef(ei),8,-1))>-1)}},369:function(ei){ei.exports=function(ei){return ei instanceof ed}},584:function(ei,eo,ea){"use strict";var ec=ea(157),ed=ea(391),eu=ea(490),eh=ea(994);function ef(ei){return ei.call.bind(ei)}var ep="undefined"!=typeof BigInt,eg="undefined"!=typeof Symbol,em=ef(Object.prototype.toString),ey=ef(Number.prototype.valueOf),eb=ef(String.prototype.valueOf),eS=ef(Boolean.prototype.valueOf);if(ep)var eE=ef(BigInt.prototype.valueOf);if(eg)var ew=ef(Symbol.prototype.valueOf);function e_(ei,eo){if("object"!=typeof ei)return!1;try{return eo(ei),!0}catch(ei){return!1}}function eT(ei){return"undefined"!=typeof Promise&&ei instanceof Promise||null!==ei&&"object"==typeof ei&&"function"==typeof ei.then&&"function"==typeof ei.catch}function eI(ei){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(ei):eh(ei)||eJ(ei)}function eC(ei){return"Uint8Array"===eu(ei)}function eO(ei){return"Uint8ClampedArray"===eu(ei)}function eR(ei){return"Uint16Array"===eu(ei)}function ek(ei){return"Uint32Array"===eu(ei)}function eM(ei){return"Int8Array"===eu(ei)}function eP(ei){return"Int16Array"===eu(ei)}function eA(ei){return"Int32Array"===eu(ei)}function eD(ei){return"Float32Array"===eu(ei)}function ej(ei){return"Float64Array"===eu(ei)}function eL(ei){return"BigInt64Array"===eu(ei)}function eN(ei){return"BigUint64Array"===eu(ei)}function eU(ei){return"[object Map]"===em(ei)}function eB(ei){return"undefined"!=typeof Map&&(eU.working?eU(ei):ei instanceof Map)}function eF(ei){return"[object Set]"===em(ei)}function eK(ei){return"undefined"!=typeof Set&&(eF.working?eF(ei):ei instanceof Set)}function e$(ei){return"[object WeakMap]"===em(ei)}function eW(ei){return"undefined"!=typeof WeakMap&&(e$.working?e$(ei):ei instanceof WeakMap)}function eV(ei){return"[object WeakSet]"===em(ei)}function eG(ei){return eV(ei)}function eH(ei){return"[object ArrayBuffer]"===em(ei)}function ez(ei){return"undefined"!=typeof ArrayBuffer&&(eH.working?eH(ei):ei instanceof ArrayBuffer)}function eY(ei){return"[object DataView]"===em(ei)}function eJ(ei){return"undefined"!=typeof DataView&&(eY.working?eY(ei):ei instanceof DataView)}eo.isArgumentsObject=ec,eo.isGeneratorFunction=ed,eo.isTypedArray=eh,eo.isPromise=eT,eo.isArrayBufferView=eI,eo.isUint8Array=eC,eo.isUint8ClampedArray=eO,eo.isUint16Array=eR,eo.isUint32Array=ek,eo.isInt8Array=eM,eo.isInt16Array=eP,eo.isInt32Array=eA,eo.isFloat32Array=eD,eo.isFloat64Array=ej,eo.isBigInt64Array=eL,eo.isBigUint64Array=eN,eU.working="undefined"!=typeof Map&&eU(new Map),eo.isMap=eB,eF.working="undefined"!=typeof Set&&eF(new Set),eo.isSet=eK,e$.working="undefined"!=typeof WeakMap&&e$(new WeakMap),eo.isWeakMap=eW,eV.working="undefined"!=typeof WeakSet&&eV(new WeakSet),eo.isWeakSet=eG,eH.working="undefined"!=typeof ArrayBuffer&&eH(new ArrayBuffer),eo.isArrayBuffer=ez,eY.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&eY(new DataView(new ArrayBuffer(1),0,1)),eo.isDataView=eJ;var eQ="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function eX(ei){return"[object SharedArrayBuffer]"===em(ei)}function eZ(ei){return void 0!==eQ&&(void 0===eX.working&&(eX.working=eX(new eQ)),eX.working?eX(ei):ei instanceof eQ)}function e0(ei){return"[object AsyncFunction]"===em(ei)}function e1(ei){return"[object Map Iterator]"===em(ei)}function e2(ei){return"[object Set Iterator]"===em(ei)}function e3(ei){return"[object Generator]"===em(ei)}function e6(ei){return"[object WebAssembly.Module]"===em(ei)}function e4(ei){return e_(ei,ey)}function e5(ei){return e_(ei,eb)}function e8(ei){return e_(ei,eS)}function e7(ei){return ep&&e_(ei,eE)}function e9(ei){return eg&&e_(ei,ew)}function ti(ei){return e4(ei)||e5(ei)||e8(ei)||e7(ei)||e9(ei)}function ta(ei){return"undefined"!=typeof Uint8Array&&(ez(ei)||eZ(ei))}eo.isSharedArrayBuffer=eZ,eo.isAsyncFunction=e0,eo.isMapIterator=e1,eo.isSetIterator=e2,eo.isGeneratorObject=e3,eo.isWebAssemblyCompiledModule=e6,eo.isNumberObject=e4,eo.isStringObject=e5,eo.isBooleanObject=e8,eo.isBigIntObject=e7,eo.isSymbolObject=e9,eo.isBoxedPrimitive=ti,eo.isAnyArrayBuffer=ta,["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(ei){Object.defineProperty(eo,ei,{enumerable:!1,value:function(){throw Error(ei+" is not supported in userland")}})})},177:function(ei,eo,ea){var ec=Object.getOwnPropertyDescriptors||function(ei){for(var eo=Object.keys(ei),ea={},ec=0;ec<eo.length;ec++)ea[eo[ec]]=Object.getOwnPropertyDescriptor(ei,eo[ec]);return ea},ed=/%[sdj%]/g;eo.format=function(ei){if(!eP(ei)){for(var eo=[],ea=0;ea<arguments.length;ea++)eo.push(eg(arguments[ea]));return eo.join(" ")}for(var ea=1,ec=arguments,eu=ec.length,eh=String(ei).replace(ed,function(ei){if("%%"===ei)return"%";if(ea>=eu)return ei;switch(ei){case"%s":return String(ec[ea++]);case"%d":return Number(ec[ea++]);case"%j":try{return JSON.stringify(ec[ea++])}catch(ei){return"[Circular]"}default:return ei}}),ef=ec[ea];ea<eu;ef=ec[++ea])eR(ef)||!eL(ef)?eh+=" "+ef:eh+=" "+eg(ef);return eh},eo.deprecate=function(ei,ea){if(void 0!==eu&&!0===eu.noDeprecation)return ei;if(void 0===eu)return function(){return eo.deprecate(ei,ea).apply(this,arguments)};var ec=!1;return function(){if(!ec){if(eu.throwDeprecation)throw Error(ea);eu.traceDeprecation?console.trace(ea):console.error(ea),ec=!0}return ei.apply(this,arguments)}};var eh={},ef=/^$/;if(eu.env.NODE_DEBUG){var ep=eu.env.NODE_DEBUG;ef=RegExp("^"+(ep=ep.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase())+"$","i")}function eg(ei,ea){var ec={seen:[],stylize:ey};return arguments.length>=3&&(ec.depth=arguments[2]),arguments.length>=4&&(ec.colors=arguments[3]),eO(ea)?ec.showHidden=ea:ea&&eo._extend(ec,ea),eD(ec.showHidden)&&(ec.showHidden=!1),eD(ec.depth)&&(ec.depth=2),eD(ec.colors)&&(ec.colors=!1),eD(ec.customInspect)&&(ec.customInspect=!0),ec.colors&&(ec.stylize=em),eS(ec,ei,ec.depth)}function em(ei,eo){var ea=eg.styles[eo];return ea?"\x1b["+eg.colors[ea][0]+"m"+ei+"\x1b["+eg.colors[ea][1]+"m":ei}function ey(ei,eo){return ei}function eb(ei){var eo={};return ei.forEach(function(ei,ea){eo[ei]=!0}),eo}function eS(ei,ea,ec){if(ei.customInspect&&ea&&eB(ea.inspect)&&ea.inspect!==eo.inspect&&!(ea.constructor&&ea.constructor.prototype===ea)){var ed,eu=ea.inspect(ec,ei);return eP(eu)||(eu=eS(ei,eu,ec)),eu}var eh=eE(ei,ea);if(eh)return eh;var ef=Object.keys(ea),ep=eb(ef);if(ei.showHidden&&(ef=Object.getOwnPropertyNames(ea)),eU(ea)&&(ef.indexOf("message")>=0||ef.indexOf("description")>=0))return ew(ea);if(0===ef.length){if(eB(ea)){var eg=ea.name?": "+ea.name:"";return ei.stylize("[Function"+eg+"]","special")}if(ej(ea))return ei.stylize(RegExp.prototype.toString.call(ea),"regexp");if(eN(ea))return ei.stylize(Date.prototype.toString.call(ea),"date");if(eU(ea))return ew(ea)}var em="",ey=!1,eO=["{","}"];return(eC(ea)&&(ey=!0,eO=["[","]"]),eB(ea)&&(em=" [Function"+(ea.name?": "+ea.name:"")+"]"),ej(ea)&&(em=" "+RegExp.prototype.toString.call(ea)),eN(ea)&&(em=" "+Date.prototype.toUTCString.call(ea)),eU(ea)&&(em=" "+ew(ea)),0!==ef.length||ey&&0!=ea.length)?ec<0?ej(ea)?ei.stylize(RegExp.prototype.toString.call(ea),"regexp"):ei.stylize("[Object]","special"):(ei.seen.push(ea),ed=ey?e_(ei,ea,ec,ep,ef):ef.map(function(eo){return eT(ei,ea,ec,ep,eo,ey)}),ei.seen.pop(),eI(ed,em,eO)):eO[0]+em+eO[1]}function eE(ei,eo){if(eD(eo))return ei.stylize("undefined","undefined");if(eP(eo)){var ea="'"+JSON.stringify(eo).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ei.stylize(ea,"string")}return eM(eo)?ei.stylize(""+eo,"number"):eO(eo)?ei.stylize(""+eo,"boolean"):eR(eo)?ei.stylize("null","null"):void 0}function ew(ei){return"["+Error.prototype.toString.call(ei)+"]"}function e_(ei,eo,ea,ec,ed){for(var eu=[],eh=0,ef=eo.length;eh<ef;++eh)eG(eo,String(eh))?eu.push(eT(ei,eo,ea,ec,String(eh),!0)):eu.push("");return ed.forEach(function(ed){ed.match(/^\d+$/)||eu.push(eT(ei,eo,ea,ec,ed,!0))}),eu}function eT(ei,eo,ea,ec,ed,eu){var eh,ef,ep;if((ep=Object.getOwnPropertyDescriptor(eo,ed)||{value:eo[ed]}).get?ef=ep.set?ei.stylize("[Getter/Setter]","special"):ei.stylize("[Getter]","special"):ep.set&&(ef=ei.stylize("[Setter]","special")),eG(ec,ed)||(eh="["+ed+"]"),!ef&&(0>ei.seen.indexOf(ep.value)?(ef=eR(ea)?eS(ei,ep.value,null):eS(ei,ep.value,ea-1)).indexOf("\n")>-1&&(ef=eu?ef.split("\n").map(function(ei){return"  "+ei}).join("\n").substr(2):"\n"+ef.split("\n").map(function(ei){return"   "+ei}).join("\n")):ef=ei.stylize("[Circular]","special")),eD(eh)){if(eu&&ed.match(/^\d+$/))return ef;(eh=JSON.stringify(""+ed)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(eh=eh.substr(1,eh.length-2),eh=ei.stylize(eh,"name")):(eh=eh.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),eh=ei.stylize(eh,"string"))}return eh+": "+ef}function eI(ei,eo,ea){var ec=0;return ei.reduce(function(ei,eo){return ec++,eo.indexOf("\n")>=0&&ec++,ei+eo.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?ea[0]+(""===eo?"":eo+"\n ")+" "+ei.join(",\n  ")+" "+ea[1]:ea[0]+eo+" "+ei.join(", ")+" "+ea[1]}function eC(ei){return Array.isArray(ei)}function eO(ei){return"boolean"==typeof ei}function eR(ei){return null===ei}function ek(ei){return null==ei}function eM(ei){return"number"==typeof ei}function eP(ei){return"string"==typeof ei}function eA(ei){return"symbol"==typeof ei}function eD(ei){return void 0===ei}function ej(ei){return eL(ei)&&"[object RegExp]"===eK(ei)}function eL(ei){return"object"==typeof ei&&null!==ei}function eN(ei){return eL(ei)&&"[object Date]"===eK(ei)}function eU(ei){return eL(ei)&&("[object Error]"===eK(ei)||ei instanceof Error)}function eB(ei){return"function"==typeof ei}function eF(ei){return null===ei||"boolean"==typeof ei||"number"==typeof ei||"string"==typeof ei||"symbol"==typeof ei||void 0===ei}function eK(ei){return Object.prototype.toString.call(ei)}function e$(ei){return ei<10?"0"+ei.toString(10):ei.toString(10)}eo.debuglog=function(ei){if(!eh[ei=ei.toUpperCase()]){if(ef.test(ei)){var ea=eu.pid;eh[ei]=function(){var ec=eo.format.apply(eo,arguments);console.error("%s %d: %s",ei,ea,ec)}}else eh[ei]=function(){}}return eh[ei]},eo.inspect=eg,eg.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},eg.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},eo.types=ea(584),eo.isArray=eC,eo.isBoolean=eO,eo.isNull=eR,eo.isNullOrUndefined=ek,eo.isNumber=eM,eo.isString=eP,eo.isSymbol=eA,eo.isUndefined=eD,eo.isRegExp=ej,eo.types.isRegExp=ej,eo.isObject=eL,eo.isDate=eN,eo.types.isDate=eN,eo.isError=eU,eo.types.isNativeError=eU,eo.isFunction=eB,eo.isPrimitive=eF,eo.isBuffer=ea(369);var eW=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function eV(){var ei=new Date,eo=[e$(ei.getHours()),e$(ei.getMinutes()),e$(ei.getSeconds())].join(":");return[ei.getDate(),eW[ei.getMonth()],eo].join(" ")}function eG(ei,eo){return Object.prototype.hasOwnProperty.call(ei,eo)}eo.log=function(){console.log("%s - %s",eV(),eo.format.apply(eo,arguments))},eo.inherits=ea(782),eo._extend=function(ei,eo){if(!eo||!eL(eo))return ei;for(var ea=Object.keys(eo),ec=ea.length;ec--;)ei[ea[ec]]=eo[ea[ec]];return ei};var eH="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function ez(ei,eo){if(!ei){var ea=Error("Promise was rejected with a falsy value");ea.reason=ei,ei=ea}return eo(ei)}function eY(ei){if("function"!=typeof ei)throw TypeError('The "original" argument must be of type Function');function eo(){for(var eo=[],ea=0;ea<arguments.length;ea++)eo.push(arguments[ea]);var ec=eo.pop();if("function"!=typeof ec)throw TypeError("The last argument must be of type Function");var ed=this,eh=function(){return ec.apply(ed,arguments)};ei.apply(this,eo).then(function(ei){eu.nextTick(eh.bind(null,null,ei))},function(ei){eu.nextTick(ez.bind(null,ei,eh))})}return Object.setPrototypeOf(eo,Object.getPrototypeOf(ei)),Object.defineProperties(eo,ec(ei)),eo}eo.promisify=function(ei){if("function"!=typeof ei)throw TypeError('The "original" argument must be of type Function');if(eH&&ei[eH]){var eo=ei[eH];if("function"!=typeof eo)throw TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(eo,eH,{value:eo,enumerable:!1,writable:!1,configurable:!0}),eo}function eo(){for(var eo,ea,ec=new Promise(function(ei,ec){eo=ei,ea=ec}),ed=[],eu=0;eu<arguments.length;eu++)ed.push(arguments[eu]);ed.push(function(ei,ec){ei?ea(ei):eo(ec)});try{ei.apply(this,ed)}catch(ei){ea(ei)}return ec}return Object.setPrototypeOf(eo,Object.getPrototypeOf(ei)),eH&&Object.defineProperty(eo,eH,{value:eo,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(eo,ec(ei))},eo.promisify.custom=eH,eo.callbackify=eY},490:function(ei,eo,ec){"use strict";var ed=ec(144),eu=ec(349),eh=ec(256),ef=eh("Object.prototype.toString"),ep=ec(942)()&&"symbol"==typeof Symbol.toStringTag,eg=eu(),em=eh("String.prototype.slice"),ey={},eb=ec(466),eS=Object.getPrototypeOf;ep&&eb&&eS&&ed(eg,function(ei){if("function"==typeof ea.g[ei]){var eo=new ea.g[ei];if(!(Symbol.toStringTag in eo))throw EvalError("this engine has support for Symbol.toStringTag, but "+ei+" does not have the property! Please report this.");var ec=eS(eo),ed=eb(ec,Symbol.toStringTag);ed||(ed=eb(eS(ec),Symbol.toStringTag)),ey[ei]=ed.get}});var eE=function(ei){var eo=!1;return ed(ey,function(ea,ec){if(!eo)try{var ed=ea.call(ei);ed===ec&&(eo=ed)}catch(ei){}}),eo},ew=ec(994);ei.exports=function(ei){return!!ew(ei)&&(ep?eE(ei):em(ef(ei),8,-1))}},349:function(ei,eo,ec){"use strict";var ed=ec(992);ei.exports=function(){return ed(["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],function(ei){return"function"==typeof ea.g[ei]})}},466:function(ei,eo,ea){"use strict";var ec=ea(500)("%Object.getOwnPropertyDescriptor%",!0);if(ec)try{ec([],"length")}catch(ei){ec=null}ei.exports=ec}},eh={};function ef(ei){var ea=eh[ei];if(void 0!==ea)return ea.exports;var ec=eh[ei]={exports:{}},ed=!0;try{eo[ei](ec,ec.exports,ef),ed=!1}finally{ed&&delete eh[ei]}return ec.exports}ef.ab=ec+"/";var ep=ef(177);ei.exports=ep}()},1951:function(module){var __dirname="/";!function(){var __webpack_modules__={950:function(__unused_webpack_module,exports){var indexOf=function(ei,eo){if(ei.indexOf)return ei.indexOf(eo);for(var ea=0;ea<ei.length;ea++)if(ei[ea]===eo)return ea;return -1},Object_keys=function(ei){if(Object.keys)return Object.keys(ei);var eo=[];for(var ea in ei)eo.push(ea);return eo},forEach=function(ei,eo){if(ei.forEach)return ei.forEach(eo);for(var ea=0;ea<ei.length;ea++)eo(ei[ea],ea,ei)},defineProp=function(){try{return Object.defineProperty({},"_",{}),function(ei,eo,ea){Object.defineProperty(ei,eo,{writable:!0,enumerable:!1,configurable:!0,value:ea})}}catch(ei){return function(ei,eo,ea){ei[eo]=ea}}}(),globals=["Array","Boolean","Date","Error","EvalError","Function","Infinity","JSON","Math","NaN","Number","Object","RangeError","ReferenceError","RegExp","String","SyntaxError","TypeError","URIError","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","escape","eval","isFinite","isNaN","parseFloat","parseInt","undefined","unescape"];function Context(){}Context.prototype={};var Script=exports.Script=function(ei){if(!(this instanceof Script))return new Script(ei);this.code=ei};Script.prototype.runInContext=function(ei){if(!(ei instanceof Context))throw TypeError("needs a 'context' argument.");var eo=document.createElement("iframe");eo.style||(eo.style={}),eo.style.display="none",document.body.appendChild(eo);var ea=eo.contentWindow,ec=ea.eval,ed=ea.execScript;!ec&&ed&&(ed.call(ea,"null"),ec=ea.eval),forEach(Object_keys(ei),function(eo){ea[eo]=ei[eo]}),forEach(globals,function(eo){ei[eo]&&(ea[eo]=ei[eo])});var eu=Object_keys(ea),eh=ec.call(ea,this.code);return forEach(Object_keys(ea),function(eo){(eo in ei||-1===indexOf(eu,eo))&&(ei[eo]=ea[eo])}),forEach(globals,function(eo){eo in ei||defineProp(ei,eo,ea[eo])}),document.body.removeChild(eo),eh},Script.prototype.runInThisContext=function(){return eval(this.code)},Script.prototype.runInNewContext=function(ei){var eo=Script.createContext(ei),ea=this.runInContext(eo);return ei&&forEach(Object_keys(eo),function(ea){ei[ea]=eo[ea]}),ea},forEach(Object_keys(Script.prototype),function(ei){exports[ei]=Script[ei]=function(eo){var ea=Script(eo);return ea[ei].apply(ea,[].slice.call(arguments,1))}}),exports.isContext=function(ei){return ei instanceof Context},exports.createScript=function(ei){return exports.Script(ei)},exports.createContext=Script.createContext=function(ei){var eo=new Context;return"object"==typeof ei&&forEach(Object_keys(ei),function(ea){eo[ea]=ei[ea]}),eo}}};"undefined"!=typeof __nccwpck_require__&&(__nccwpck_require__.ab=__dirname+"/");var __webpack_exports__={};__webpack_modules__[950](0,__webpack_exports__),module.exports=__webpack_exports__}()},2693:function(ei,eo,ea){"use strict";let ec=ea(9353),ed=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class eu extends Error{constructor(ei){super(),ei instanceof Error?(this.originalError=ei,{message:ei}=ei):(this.originalError=Error(ei),this.originalError.stack=this.stack),this.name="AbortError",this.message=ei}}let eh=(ei,eo,ea)=>{let ec=ea.retries-(eo-1);return ei.attemptNumber=eo,ei.retriesLeft=ec,ei},ef=ei=>ed.includes(ei),ep=(ei,eo)=>new Promise((ea,ed)=>{eo={onFailedAttempt:()=>{},retries:10,...eo};let ep=ec.operation(eo);ep.attempt(async ec=>{try{ea(await ei(ec))}catch(ei){if(!(ei instanceof Error)){ed(TypeError(`Non-error was thrown: "${ei}". You should only throw errors.`));return}if(ei instanceof eu)ep.stop(),ed(ei.originalError);else if(ei instanceof TypeError&&!ef(ei.message))ep.stop(),ed(ei);else{eh(ei,ec,eo);try{await eo.onFailedAttempt(ei)}catch(ei){ed(ei);return}ep.retry(ei)||ed(ep.mainError())}}})});ei.exports=ep,ei.exports.default=ep,ei.exports.AbortError=eu},4375:function(ei,eo,ea){/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let ec;ei.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:ea.g):ei=>(ec||(ec=Promise.resolve())).then(ei).catch(ei=>setTimeout(()=>{throw ei},0))},1798:function(ei,eo,ea){"use strict";var ec=ea(3454),ed=65536,eu=4294967295;function eh(){throw Error("Secure random number generation is not supported by this browser.\nUse Chrome, Firefox or Internet Explorer 11")}var ef=ea(9509).Buffer,ep=ea.g.crypto||ea.g.msCrypto;function eg(ei,eo){if(ei>eu)throw RangeError("requested too many random bytes");var ea=ef.allocUnsafe(ei);if(ei>0){if(ei>ed)for(var eh=0;eh<ei;eh+=ed)ep.getRandomValues(ea.slice(eh,eh+ed));else ep.getRandomValues(ea)}return"function"==typeof eo?ec.nextTick(function(){eo(null,ea)}):ea}ep&&ep.getRandomValues?ei.exports=eg:ei.exports=eh},4281:function(ei){"use strict";function eo(ei,eo){ei.prototype=Object.create(eo.prototype),ei.prototype.constructor=ei,ei.__proto__=eo}var ea={};function ec(ei,ec,ed){function eu(ei,eo,ea){return"string"==typeof ec?ec:ec(ei,eo,ea)}ed||(ed=Error);var eh=function(ei){function ea(eo,ea,ec){return ei.call(this,eu(eo,ea,ec))||this}return eo(ea,ei),ea}(ed);eh.prototype.name=ed.name,eh.prototype.code=ei,ea[ei]=eh}function ed(ei,eo){if(!Array.isArray(ei))return"of ".concat(eo," ").concat(String(ei));var ea=ei.length;return(ei=ei.map(function(ei){return String(ei)}),ea>2)?"one of ".concat(eo," ").concat(ei.slice(0,ea-1).join(", "),", or ")+ei[ea-1]:2===ea?"one of ".concat(eo," ").concat(ei[0]," or ").concat(ei[1]):"of ".concat(eo," ").concat(ei[0])}function eu(ei,eo,ea){return ei.substr(!ea||ea<0?0:+ea,eo.length)===eo}function eh(ei,eo,ea){return(void 0===ea||ea>ei.length)&&(ea=ei.length),ei.substring(ea-eo.length,ea)===eo}function ef(ei,eo,ea){return"number"!=typeof ea&&(ea=0),!(ea+eo.length>ei.length)&&-1!==ei.indexOf(eo,ea)}ec("ERR_INVALID_OPT_VALUE",function(ei,eo){return'The value "'+eo+'" is invalid for option "'+ei+'"'},TypeError),ec("ERR_INVALID_ARG_TYPE",function(ei,eo,ea){if("string"==typeof eo&&eu(eo,"not ")?(ec="must not be",eo=eo.replace(/^not /,"")):ec="must be",eh(ei," argument"))ep="The ".concat(ei," ").concat(ec," ").concat(ed(eo,"type"));else{var ec,ep,eg=ef(ei,".")?"property":"argument";ep='The "'.concat(ei,'" ').concat(eg," ").concat(ec," ").concat(ed(eo,"type"))}return ep+". Received type ".concat(typeof ea)},TypeError),ec("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),ec("ERR_METHOD_NOT_IMPLEMENTED",function(ei){return"The "+ei+" method is not implemented"}),ec("ERR_STREAM_PREMATURE_CLOSE","Premature close"),ec("ERR_STREAM_DESTROYED",function(ei){return"Cannot call "+ei+" after a stream was destroyed"}),ec("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),ec("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),ec("ERR_STREAM_WRITE_AFTER_END","write after end"),ec("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),ec("ERR_UNKNOWN_ENCODING",function(ei){return"Unknown encoding: "+ei},TypeError),ec("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),ei.exports.q=ea},6753:function(ei,eo,ea){"use strict";var ec=ea(3454),ed=Object.keys||function(ei){var eo=[];for(var ea in ei)eo.push(ea);return eo};ei.exports=em;var eu=ea(9481),eh=ea(4229);ea(5717)(em,eu);for(var ef=ed(eh.prototype),ep=0;ep<ef.length;ep++){var eg=ef[ep];em.prototype[eg]||(em.prototype[eg]=eh.prototype[eg])}function em(ei){if(!(this instanceof em))return new em(ei);eu.call(this,ei),eh.call(this,ei),this.allowHalfOpen=!0,ei&&(!1===ei.readable&&(this.readable=!1),!1===ei.writable&&(this.writable=!1),!1===ei.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",ey)))}function ey(){this._writableState.ended||ec.nextTick(eb,this)}function eb(ei){ei.end()}Object.defineProperty(em.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(em.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(em.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(em.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(ei){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=ei,this._writableState.destroyed=ei)}})},2725:function(ei,eo,ea){"use strict";ei.exports=ed;var ec=ea(4605);function ed(ei){if(!(this instanceof ed))return new ed(ei);ec.call(this,ei)}ea(5717)(ed,ec),ed.prototype._transform=function(ei,eo,ea){ea(null,ei)}},9481:function(ei,eo,ea){"use strict";var ec,ed,eu,eh,ef,ep=ea(3454);ei.exports=eL,eL.ReadableState=ej,ea(7187).EventEmitter;var eg=function(ei,eo){return ei.listeners(eo).length},em=ea(2503),ey=ea(8764).Buffer,eb=(void 0!==ea.g?ea.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}).Uint8Array||function(){};function eS(ei){return ey.from(ei)}function eE(ei){return ey.isBuffer(ei)||ei instanceof eb}var ew=ea(4616);ed=ew&&ew.debuglog?ew.debuglog("stream"):function(){};var e_=ea(7327),eT=ea(1195),eI=ea(2457).getHighWaterMark,eC=ea(4281).q,eO=eC.ERR_INVALID_ARG_TYPE,eR=eC.ERR_STREAM_PUSH_AFTER_EOF,ek=eC.ERR_METHOD_NOT_IMPLEMENTED,eM=eC.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;ea(5717)(eL,em);var eP=eT.errorOrDestroy,eA=["error","close","destroy","pause","resume"];function eD(ei,eo,ea){if("function"==typeof ei.prependListener)return ei.prependListener(eo,ea);ei._events&&ei._events[eo]?Array.isArray(ei._events[eo])?ei._events[eo].unshift(ea):ei._events[eo]=[ea,ei._events[eo]]:ei.on(eo,ea)}function ej(ei,eo,ed){ec=ec||ea(6753),ei=ei||{},"boolean"!=typeof ed&&(ed=eo instanceof ec),this.objectMode=!!ei.objectMode,ed&&(this.objectMode=this.objectMode||!!ei.readableObjectMode),this.highWaterMark=eI(this,ei,"readableHighWaterMark",ed),this.buffer=new e_,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==ei.emitClose,this.autoDestroy=!!ei.autoDestroy,this.destroyed=!1,this.defaultEncoding=ei.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,ei.encoding&&(eu||(eu=ea(2553).StringDecoder),this.decoder=new eu(ei.encoding),this.encoding=ei.encoding)}function eL(ei){if(ec=ec||ea(6753),!(this instanceof eL))return new eL(ei);var eo=this instanceof ec;this._readableState=new ej(ei,this,eo),this.readable=!0,ei&&("function"==typeof ei.read&&(this._read=ei.read),"function"==typeof ei.destroy&&(this._destroy=ei.destroy)),em.call(this)}function eN(ei,eo,ea,ec,eu){ed("readableAddChunk",eo);var eh,ef=ei._readableState;if(null===eo)ef.reading=!1,eW(ei,ef);else if(eu||(eh=eB(ef,eo)),eh)eP(ei,eh);else if(ef.objectMode||eo&&eo.length>0){if("string"==typeof eo||ef.objectMode||Object.getPrototypeOf(eo)===ey.prototype||(eo=eS(eo)),ec)ef.endEmitted?eP(ei,new eM):eU(ei,ef,eo,!0);else if(ef.ended)eP(ei,new eR);else{if(ef.destroyed)return!1;ef.reading=!1,ef.decoder&&!ea?(eo=ef.decoder.write(eo),ef.objectMode||0!==eo.length?eU(ei,ef,eo,!1):eH(ei,ef)):eU(ei,ef,eo,!1)}}else ec||(ef.reading=!1,eH(ei,ef));return!ef.ended&&(ef.length<ef.highWaterMark||0===ef.length)}function eU(ei,eo,ea,ec){eo.flowing&&0===eo.length&&!eo.sync?(eo.awaitDrain=0,ei.emit("data",ea)):(eo.length+=eo.objectMode?1:ea.length,ec?eo.buffer.unshift(ea):eo.buffer.push(ea),eo.needReadable&&eV(ei)),eH(ei,eo)}function eB(ei,eo){var ea;return eE(eo)||"string"==typeof eo||void 0===eo||ei.objectMode||(ea=new eO("chunk",["string","Buffer","Uint8Array"],eo)),ea}Object.defineProperty(eL.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(ei){this._readableState&&(this._readableState.destroyed=ei)}}),eL.prototype.destroy=eT.destroy,eL.prototype._undestroy=eT.undestroy,eL.prototype._destroy=function(ei,eo){eo(ei)},eL.prototype.push=function(ei,eo){var ea,ec=this._readableState;return ec.objectMode?ea=!0:"string"==typeof ei&&((eo=eo||ec.defaultEncoding)!==ec.encoding&&(ei=ey.from(ei,eo),eo=""),ea=!0),eN(this,ei,eo,!1,ea)},eL.prototype.unshift=function(ei){return eN(this,ei,null,!0,!1)},eL.prototype.isPaused=function(){return!1===this._readableState.flowing},eL.prototype.setEncoding=function(ei){eu||(eu=ea(2553).StringDecoder);var eo=new eu(ei);this._readableState.decoder=eo,this._readableState.encoding=this._readableState.decoder.encoding;for(var ec=this._readableState.buffer.head,ed="";null!==ec;)ed+=eo.write(ec.data),ec=ec.next;return this._readableState.buffer.clear(),""!==ed&&this._readableState.buffer.push(ed),this._readableState.length=ed.length,this};var eF=1073741824;function eK(ei){return ei>=eF?ei=eF:(ei--,ei|=ei>>>1,ei|=ei>>>2,ei|=ei>>>4,ei|=ei>>>8,ei|=ei>>>16,ei++),ei}function e$(ei,eo){return ei<=0||0===eo.length&&eo.ended?0:eo.objectMode?1:ei!=ei?eo.flowing&&eo.length?eo.buffer.head.data.length:eo.length:(ei>eo.highWaterMark&&(eo.highWaterMark=eK(ei)),ei<=eo.length)?ei:eo.ended?eo.length:(eo.needReadable=!0,0)}function eW(ei,eo){if(ed("onEofChunk"),!eo.ended){if(eo.decoder){var ea=eo.decoder.end();ea&&ea.length&&(eo.buffer.push(ea),eo.length+=eo.objectMode?1:ea.length)}eo.ended=!0,eo.sync?eV(ei):(eo.needReadable=!1,eo.emittedReadable||(eo.emittedReadable=!0,eG(ei)))}}function eV(ei){var eo=ei._readableState;ed("emitReadable",eo.needReadable,eo.emittedReadable),eo.needReadable=!1,eo.emittedReadable||(ed("emitReadable",eo.flowing),eo.emittedReadable=!0,ep.nextTick(eG,ei))}function eG(ei){var eo=ei._readableState;ed("emitReadable_",eo.destroyed,eo.length,eo.ended),!eo.destroyed&&(eo.length||eo.ended)&&(ei.emit("readable"),eo.emittedReadable=!1),eo.needReadable=!eo.flowing&&!eo.ended&&eo.length<=eo.highWaterMark,e0(ei)}function eH(ei,eo){eo.readingMore||(eo.readingMore=!0,ep.nextTick(ez,ei,eo))}function ez(ei,eo){for(;!eo.reading&&!eo.ended&&(eo.length<eo.highWaterMark||eo.flowing&&0===eo.length);){var ea=eo.length;if(ed("maybeReadMore read 0"),ei.read(0),ea===eo.length)break}eo.readingMore=!1}function eY(ei){return function(){var eo=ei._readableState;ed("pipeOnDrain",eo.awaitDrain),eo.awaitDrain&&eo.awaitDrain--,0===eo.awaitDrain&&eg(ei,"data")&&(eo.flowing=!0,e0(ei))}}function eJ(ei){var eo=ei._readableState;eo.readableListening=ei.listenerCount("readable")>0,eo.resumeScheduled&&!eo.paused?eo.flowing=!0:ei.listenerCount("data")>0&&ei.resume()}function eQ(ei){ed("readable nexttick read 0"),ei.read(0)}function eX(ei,eo){eo.resumeScheduled||(eo.resumeScheduled=!0,ep.nextTick(eZ,ei,eo))}function eZ(ei,eo){ed("resume",eo.reading),eo.reading||ei.read(0),eo.resumeScheduled=!1,ei.emit("resume"),e0(ei),eo.flowing&&!eo.reading&&ei.read(0)}function e0(ei){var eo=ei._readableState;for(ed("flow",eo.flowing);eo.flowing&&null!==ei.read(););}function e1(ei,eo){var ea;return 0===eo.length?null:(eo.objectMode?ea=eo.buffer.shift():!ei||ei>=eo.length?(ea=eo.decoder?eo.buffer.join(""):1===eo.buffer.length?eo.buffer.first():eo.buffer.concat(eo.length),eo.buffer.clear()):ea=eo.buffer.consume(ei,eo.decoder),ea)}function e2(ei){var eo=ei._readableState;ed("endReadable",eo.endEmitted),eo.endEmitted||(eo.ended=!0,ep.nextTick(e3,eo,ei))}function e3(ei,eo){if(ed("endReadableNT",ei.endEmitted,ei.length),!ei.endEmitted&&0===ei.length&&(ei.endEmitted=!0,eo.readable=!1,eo.emit("end"),ei.autoDestroy)){var ea=eo._writableState;(!ea||ea.autoDestroy&&ea.finished)&&eo.destroy()}}function e6(ei,eo){for(var ea=0,ec=ei.length;ea<ec;ea++)if(ei[ea]===eo)return ea;return -1}eL.prototype.read=function(ei){ed("read",ei),ei=parseInt(ei,10);var eo,ea=this._readableState,ec=ei;if(0!==ei&&(ea.emittedReadable=!1),0===ei&&ea.needReadable&&((0!==ea.highWaterMark?ea.length>=ea.highWaterMark:ea.length>0)||ea.ended))return ed("read: emitReadable",ea.length,ea.ended),0===ea.length&&ea.ended?e2(this):eV(this),null;if(0===(ei=e$(ei,ea))&&ea.ended)return 0===ea.length&&e2(this),null;var eu=ea.needReadable;return ed("need readable",eu),(0===ea.length||ea.length-ei<ea.highWaterMark)&&ed("length less than watermark",eu=!0),ea.ended||ea.reading?ed("reading or ended",eu=!1):eu&&(ed("do read"),ea.reading=!0,ea.sync=!0,0===ea.length&&(ea.needReadable=!0),this._read(ea.highWaterMark),ea.sync=!1,ea.reading||(ei=e$(ec,ea))),null===(eo=ei>0?e1(ei,ea):null)?(ea.needReadable=ea.length<=ea.highWaterMark,ei=0):(ea.length-=ei,ea.awaitDrain=0),0===ea.length&&(ea.ended||(ea.needReadable=!0),ec!==ei&&ea.ended&&e2(this)),null!==eo&&this.emit("data",eo),eo},eL.prototype._read=function(ei){eP(this,new ek("_read()"))},eL.prototype.pipe=function(ei,eo){var ea=this,ec=this._readableState;switch(ec.pipesCount){case 0:ec.pipes=ei;break;case 1:ec.pipes=[ec.pipes,ei];break;default:ec.pipes.push(ei)}ec.pipesCount+=1,ed("pipe count=%d opts=%j",ec.pipesCount,eo);var eu=eo&&!1===eo.end||ei===ep.stdout||ei===ep.stderr?eT:ef;function eh(ei,eo){ed("onunpipe"),ei===ea&&eo&&!1===eo.hasUnpiped&&(eo.hasUnpiped=!0,eb())}function ef(){ed("onend"),ei.end()}ec.endEmitted?ep.nextTick(eu):ea.once("end",eu),ei.on("unpipe",eh);var em=eY(ea);ei.on("drain",em);var ey=!1;function eb(){ed("cleanup"),ei.removeListener("close",ew),ei.removeListener("finish",e_),ei.removeListener("drain",em),ei.removeListener("error",eE),ei.removeListener("unpipe",eh),ea.removeListener("end",ef),ea.removeListener("end",eT),ea.removeListener("data",eS),ey=!0,ec.awaitDrain&&(!ei._writableState||ei._writableState.needDrain)&&em()}function eS(eo){ed("ondata");var eu=ei.write(eo);ed("dest.write",eu),!1===eu&&((1===ec.pipesCount&&ec.pipes===ei||ec.pipesCount>1&&-1!==e6(ec.pipes,ei))&&!ey&&(ed("false write response, pause",ec.awaitDrain),ec.awaitDrain++),ea.pause())}function eE(eo){ed("onerror",eo),eT(),ei.removeListener("error",eE),0===eg(ei,"error")&&eP(ei,eo)}function ew(){ei.removeListener("finish",e_),eT()}function e_(){ed("onfinish"),ei.removeListener("close",ew),eT()}function eT(){ed("unpipe"),ea.unpipe(ei)}return ea.on("data",eS),eD(ei,"error",eE),ei.once("close",ew),ei.once("finish",e_),ei.emit("pipe",ea),ec.flowing||(ed("pipe resume"),ea.resume()),ei},eL.prototype.unpipe=function(ei){var eo=this._readableState,ea={hasUnpiped:!1};if(0===eo.pipesCount)return this;if(1===eo.pipesCount)return ei&&ei!==eo.pipes||(ei||(ei=eo.pipes),eo.pipes=null,eo.pipesCount=0,eo.flowing=!1,ei&&ei.emit("unpipe",this,ea)),this;if(!ei){var ec=eo.pipes,ed=eo.pipesCount;eo.pipes=null,eo.pipesCount=0,eo.flowing=!1;for(var eu=0;eu<ed;eu++)ec[eu].emit("unpipe",this,{hasUnpiped:!1});return this}var eh=e6(eo.pipes,ei);return -1===eh||(eo.pipes.splice(eh,1),eo.pipesCount-=1,1===eo.pipesCount&&(eo.pipes=eo.pipes[0]),ei.emit("unpipe",this,ea)),this},eL.prototype.on=function(ei,eo){var ea=em.prototype.on.call(this,ei,eo),ec=this._readableState;return"data"===ei?(ec.readableListening=this.listenerCount("readable")>0,!1!==ec.flowing&&this.resume()):"readable"!==ei||ec.endEmitted||ec.readableListening||(ec.readableListening=ec.needReadable=!0,ec.flowing=!1,ec.emittedReadable=!1,ed("on readable",ec.length,ec.reading),ec.length?eV(this):ec.reading||ep.nextTick(eQ,this)),ea},eL.prototype.addListener=eL.prototype.on,eL.prototype.removeListener=function(ei,eo){var ea=em.prototype.removeListener.call(this,ei,eo);return"readable"===ei&&ep.nextTick(eJ,this),ea},eL.prototype.removeAllListeners=function(ei){var eo=em.prototype.removeAllListeners.apply(this,arguments);return("readable"===ei||void 0===ei)&&ep.nextTick(eJ,this),eo},eL.prototype.resume=function(){var ei=this._readableState;return ei.flowing||(ed("resume"),ei.flowing=!ei.readableListening,eX(this,ei)),ei.paused=!1,this},eL.prototype.pause=function(){return ed("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(ed("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},eL.prototype.wrap=function(ei){var eo=this,ea=this._readableState,ec=!1;for(var eu in ei.on("end",function(){if(ed("wrapped end"),ea.decoder&&!ea.ended){var ei=ea.decoder.end();ei&&ei.length&&eo.push(ei)}eo.push(null)}),ei.on("data",function(eu){ed("wrapped data"),ea.decoder&&(eu=ea.decoder.write(eu)),(!ea.objectMode||null!=eu)&&(ea.objectMode||eu&&eu.length)&&(eo.push(eu)||(ec=!0,ei.pause()))}),ei)void 0===this[eu]&&"function"==typeof ei[eu]&&(this[eu]=function(eo){return function(){return ei[eo].apply(ei,arguments)}}(eu));for(var eh=0;eh<eA.length;eh++)ei.on(eA[eh],this.emit.bind(this,eA[eh]));return this._read=function(eo){ed("wrapped _read",eo),ec&&(ec=!1,ei.resume())},this},"function"==typeof Symbol&&(eL.prototype[Symbol.asyncIterator]=function(){return void 0===eh&&(eh=ea(5850)),eh(this)}),Object.defineProperty(eL.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(eL.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(eL.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(ei){this._readableState&&(this._readableState.flowing=ei)}}),eL._fromList=e1,Object.defineProperty(eL.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(eL.from=function(ei,eo){return void 0===ef&&(ef=ea(5167)),ef(eL,ei,eo)})},4605:function(ei,eo,ea){"use strict";ei.exports=em;var ec=ea(4281).q,ed=ec.ERR_METHOD_NOT_IMPLEMENTED,eu=ec.ERR_MULTIPLE_CALLBACK,eh=ec.ERR_TRANSFORM_ALREADY_TRANSFORMING,ef=ec.ERR_TRANSFORM_WITH_LENGTH_0,ep=ea(6753);function eg(ei,eo){var ea=this._transformState;ea.transforming=!1;var ec=ea.writecb;if(null===ec)return this.emit("error",new eu);ea.writechunk=null,ea.writecb=null,null!=eo&&this.push(eo),ec(ei);var ed=this._readableState;ed.reading=!1,(ed.needReadable||ed.length<ed.highWaterMark)&&this._read(ed.highWaterMark)}function em(ei){if(!(this instanceof em))return new em(ei);ep.call(this,ei),this._transformState={afterTransform:eg.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,ei&&("function"==typeof ei.transform&&(this._transform=ei.transform),"function"==typeof ei.flush&&(this._flush=ei.flush)),this.on("prefinish",ey)}function ey(){var ei=this;"function"!=typeof this._flush||this._readableState.destroyed?eb(this,null,null):this._flush(function(eo,ea){eb(ei,eo,ea)})}function eb(ei,eo,ea){if(eo)return ei.emit("error",eo);if(null!=ea&&ei.push(ea),ei._writableState.length)throw new ef;if(ei._transformState.transforming)throw new eh;return ei.push(null)}ea(5717)(em,ep),em.prototype.push=function(ei,eo){return this._transformState.needTransform=!1,ep.prototype.push.call(this,ei,eo)},em.prototype._transform=function(ei,eo,ea){ea(new ed("_transform()"))},em.prototype._write=function(ei,eo,ea){var ec=this._transformState;if(ec.writecb=ea,ec.writechunk=ei,ec.writeencoding=eo,!ec.transforming){var ed=this._readableState;(ec.needTransform||ed.needReadable||ed.length<ed.highWaterMark)&&this._read(ed.highWaterMark)}},em.prototype._read=function(ei){var eo=this._transformState;null===eo.writechunk||eo.transforming?eo.needTransform=!0:(eo.transforming=!0,this._transform(eo.writechunk,eo.writeencoding,eo.afterTransform))},em.prototype._destroy=function(ei,eo){ep.prototype._destroy.call(this,ei,function(ei){eo(ei)})}},4229:function(ei,eo,ea){"use strict";var ec,ed,eu=ea(3454);function eh(ei){var eo=this;this.next=null,this.entry=null,this.finish=function(){eZ(eo,ei)}}ei.exports=ej,ej.WritableState=eD;var ef={deprecate:ea(4927)},ep=ea(2503),eg=ea(8764).Buffer,em=(void 0!==ea.g?ea.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}).Uint8Array||function(){};function ey(ei){return eg.from(ei)}function eb(ei){return eg.isBuffer(ei)||ei instanceof em}var eS=ea(1195),eE=ea(2457).getHighWaterMark,ew=ea(4281).q,e_=ew.ERR_INVALID_ARG_TYPE,eT=ew.ERR_METHOD_NOT_IMPLEMENTED,eI=ew.ERR_MULTIPLE_CALLBACK,eC=ew.ERR_STREAM_CANNOT_PIPE,eO=ew.ERR_STREAM_DESTROYED,eR=ew.ERR_STREAM_NULL_VALUES,ek=ew.ERR_STREAM_WRITE_AFTER_END,eM=ew.ERR_UNKNOWN_ENCODING,eP=eS.errorOrDestroy;function eA(){}function eD(ei,eo,ed){ec=ec||ea(6753),ei=ei||{},"boolean"!=typeof ed&&(ed=eo instanceof ec),this.objectMode=!!ei.objectMode,ed&&(this.objectMode=this.objectMode||!!ei.writableObjectMode),this.highWaterMark=eE(this,ei,"writableHighWaterMark",ed),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var eu=!1===ei.decodeStrings;this.decodeStrings=!eu,this.defaultEncoding=ei.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(ei){eW(eo,ei)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==ei.emitClose,this.autoDestroy=!!ei.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new eh(this)}function ej(ei){var eo=this instanceof(ec=ec||ea(6753));if(!eo&&!ed.call(ej,this))return new ej(ei);this._writableState=new eD(ei,this,eo),this.writable=!0,ei&&("function"==typeof ei.write&&(this._write=ei.write),"function"==typeof ei.writev&&(this._writev=ei.writev),"function"==typeof ei.destroy&&(this._destroy=ei.destroy),"function"==typeof ei.final&&(this._final=ei.final)),ep.call(this)}function eL(ei,eo){var ea=new ek;eP(ei,ea),eu.nextTick(eo,ea)}function eN(ei,eo,ea,ec){var ed;return null===ea?ed=new eR:"string"==typeof ea||eo.objectMode||(ed=new e_("chunk",["string","Buffer"],ea)),!ed||(eP(ei,ed),eu.nextTick(ec,ed),!1)}function eU(ei,eo,ea){return ei.objectMode||!1===ei.decodeStrings||"string"!=typeof eo||(eo=eg.from(eo,ea)),eo}function eB(ei,eo,ea,ec,ed,eu){if(!ea){var eh=eU(eo,ec,ed);ec!==eh&&(ea=!0,ed="buffer",ec=eh)}var ef=eo.objectMode?1:ec.length;eo.length+=ef;var ep=eo.length<eo.highWaterMark;if(ep||(eo.needDrain=!0),eo.writing||eo.corked){var eg=eo.lastBufferedRequest;eo.lastBufferedRequest={chunk:ec,encoding:ed,isBuf:ea,callback:eu,next:null},eg?eg.next=eo.lastBufferedRequest:eo.bufferedRequest=eo.lastBufferedRequest,eo.bufferedRequestCount+=1}else eF(ei,eo,!1,ef,ec,ed,eu);return ep}function eF(ei,eo,ea,ec,ed,eu,eh){eo.writelen=ec,eo.writecb=eh,eo.writing=!0,eo.sync=!0,eo.destroyed?eo.onwrite(new eO("write")):ea?ei._writev(ed,eo.onwrite):ei._write(ed,eu,eo.onwrite),eo.sync=!1}function eK(ei,eo,ea,ec,ed){--eo.pendingcb,ea?(eu.nextTick(ed,ec),eu.nextTick(eQ,ei,eo),ei._writableState.errorEmitted=!0,eP(ei,ec)):(ed(ec),ei._writableState.errorEmitted=!0,eP(ei,ec),eQ(ei,eo))}function e$(ei){ei.writing=!1,ei.writecb=null,ei.length-=ei.writelen,ei.writelen=0}function eW(ei,eo){var ea=ei._writableState,ec=ea.sync,ed=ea.writecb;if("function"!=typeof ed)throw new eI;if(e$(ea),eo)eK(ei,ea,ec,eo,ed);else{var eh=ez(ea)||ei.destroyed;eh||ea.corked||ea.bufferProcessing||!ea.bufferedRequest||eH(ei,ea),ec?eu.nextTick(eV,ei,ea,eh,ed):eV(ei,ea,eh,ed)}}function eV(ei,eo,ea,ec){ea||eG(ei,eo),eo.pendingcb--,ec(),eQ(ei,eo)}function eG(ei,eo){0===eo.length&&eo.needDrain&&(eo.needDrain=!1,ei.emit("drain"))}function eH(ei,eo){eo.bufferProcessing=!0;var ea=eo.bufferedRequest;if(ei._writev&&ea&&ea.next){var ec=Array(eo.bufferedRequestCount),ed=eo.corkedRequestsFree;ed.entry=ea;for(var eu=0,ef=!0;ea;)ec[eu]=ea,ea.isBuf||(ef=!1),ea=ea.next,eu+=1;ec.allBuffers=ef,eF(ei,eo,!0,eo.length,ec,"",ed.finish),eo.pendingcb++,eo.lastBufferedRequest=null,ed.next?(eo.corkedRequestsFree=ed.next,ed.next=null):eo.corkedRequestsFree=new eh(eo),eo.bufferedRequestCount=0}else{for(;ea;){var ep=ea.chunk,eg=ea.encoding,em=ea.callback,ey=eo.objectMode?1:ep.length;if(eF(ei,eo,!1,ey,ep,eg,em),ea=ea.next,eo.bufferedRequestCount--,eo.writing)break}null===ea&&(eo.lastBufferedRequest=null)}eo.bufferedRequest=ea,eo.bufferProcessing=!1}function ez(ei){return ei.ending&&0===ei.length&&null===ei.bufferedRequest&&!ei.finished&&!ei.writing}function eY(ei,eo){ei._final(function(ea){eo.pendingcb--,ea&&eP(ei,ea),eo.prefinished=!0,ei.emit("prefinish"),eQ(ei,eo)})}function eJ(ei,eo){eo.prefinished||eo.finalCalled||("function"!=typeof ei._final||eo.destroyed?(eo.prefinished=!0,ei.emit("prefinish")):(eo.pendingcb++,eo.finalCalled=!0,eu.nextTick(eY,ei,eo)))}function eQ(ei,eo){var ea=ez(eo);if(ea&&(eJ(ei,eo),0===eo.pendingcb&&(eo.finished=!0,ei.emit("finish"),eo.autoDestroy))){var ec=ei._readableState;(!ec||ec.autoDestroy&&ec.endEmitted)&&ei.destroy()}return ea}function eX(ei,eo,ea){eo.ending=!0,eQ(ei,eo),ea&&(eo.finished?eu.nextTick(ea):ei.once("finish",ea)),eo.ended=!0,ei.writable=!1}function eZ(ei,eo,ea){var ec=ei.entry;for(ei.entry=null;ec;){var ed=ec.callback;eo.pendingcb--,ed(ea),ec=ec.next}eo.corkedRequestsFree.next=ei}ea(5717)(ej,ep),eD.prototype.getBuffer=function(){for(var ei=this.bufferedRequest,eo=[];ei;)eo.push(ei),ei=ei.next;return eo},function(){try{Object.defineProperty(eD.prototype,"buffer",{get:ef.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(ei){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(ed=Function.prototype[Symbol.hasInstance],Object.defineProperty(ej,Symbol.hasInstance,{value:function(ei){return!!ed.call(this,ei)||this===ej&&ei&&ei._writableState instanceof eD}})):ed=function(ei){return ei instanceof this},ej.prototype.pipe=function(){eP(this,new eC)},ej.prototype.write=function(ei,eo,ea){var ec=this._writableState,ed=!1,eu=!ec.objectMode&&eb(ei);return eu&&!eg.isBuffer(ei)&&(ei=ey(ei)),"function"==typeof eo&&(ea=eo,eo=null),eu?eo="buffer":eo||(eo=ec.defaultEncoding),"function"!=typeof ea&&(ea=eA),ec.ending?eL(this,ea):(eu||eN(this,ec,ei,ea))&&(ec.pendingcb++,ed=eB(this,ec,eu,ei,eo,ea)),ed},ej.prototype.cork=function(){this._writableState.corked++},ej.prototype.uncork=function(){var ei=this._writableState;!ei.corked||(ei.corked--,ei.writing||ei.corked||ei.bufferProcessing||!ei.bufferedRequest||eH(this,ei))},ej.prototype.setDefaultEncoding=function(ei){if("string"==typeof ei&&(ei=ei.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((ei+"").toLowerCase())>-1))throw new eM(ei);return this._writableState.defaultEncoding=ei,this},Object.defineProperty(ej.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(ej.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),ej.prototype._write=function(ei,eo,ea){ea(new eT("_write()"))},ej.prototype._writev=null,ej.prototype.end=function(ei,eo,ea){var ec=this._writableState;return"function"==typeof ei?(ea=ei,ei=null,eo=null):"function"==typeof eo&&(ea=eo,eo=null),null!=ei&&this.write(ei,eo),ec.corked&&(ec.corked=1,this.uncork()),ec.ending||eX(this,ec,ea),this},Object.defineProperty(ej.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(ej.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(ei){this._writableState&&(this._writableState.destroyed=ei)}}),ej.prototype.destroy=eS.destroy,ej.prototype._undestroy=eS.undestroy,ej.prototype._destroy=function(ei,eo){eo(ei)}},5850:function(ei,eo,ea){"use strict";var ec,ed=ea(3454);function eu(ei,eo,ea){return(eo=eh(eo))in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function eh(ei){var eo=ef(ei,"string");return"symbol"==typeof eo?eo:String(eo)}function ef(ei,eo){if("object"!=typeof ei||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!=typeof ec)return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}var ep=ea(8610),eg=Symbol("lastResolve"),em=Symbol("lastReject"),ey=Symbol("error"),eb=Symbol("ended"),eS=Symbol("lastPromise"),eE=Symbol("handlePromise"),ew=Symbol("stream");function e_(ei,eo){return{value:ei,done:eo}}function eT(ei){var eo=ei[eg];if(null!==eo){var ea=ei[ew].read();null!==ea&&(ei[eS]=null,ei[eg]=null,ei[em]=null,eo(e_(ea,!1)))}}function eI(ei){ed.nextTick(eT,ei)}function eC(ei,eo){return function(ea,ec){ei.then(function(){if(eo[eb]){ea(e_(void 0,!0));return}eo[eE](ea,ec)},ec)}}var eO=Object.getPrototypeOf(function(){}),eR=Object.setPrototypeOf((eu(ec={get stream(){return this[ew]},next:function(){var ei,eo=this,ea=this[ey];if(null!==ea)return Promise.reject(ea);if(this[eb])return Promise.resolve(e_(void 0,!0));if(this[ew].destroyed)return new Promise(function(ei,ea){ed.nextTick(function(){eo[ey]?ea(eo[ey]):ei(e_(void 0,!0))})});var ec=this[eS];if(ec)ei=new Promise(eC(ec,this));else{var eu=this[ew].read();if(null!==eu)return Promise.resolve(e_(eu,!1));ei=new Promise(this[eE])}return this[eS]=ei,ei}},Symbol.asyncIterator,function(){return this}),eu(ec,"return",function(){var ei=this;return new Promise(function(eo,ea){ei[ew].destroy(null,function(ei){if(ei){ea(ei);return}eo(e_(void 0,!0))})})}),ec),eO),ek=function(ei){var eo,ea=Object.create(eR,(eu(eo={},ew,{value:ei,writable:!0}),eu(eo,eg,{value:null,writable:!0}),eu(eo,em,{value:null,writable:!0}),eu(eo,ey,{value:null,writable:!0}),eu(eo,eb,{value:ei._readableState.endEmitted,writable:!0}),eu(eo,eE,{value:function(ei,eo){var ec=ea[ew].read();ec?(ea[eS]=null,ea[eg]=null,ea[em]=null,ei(e_(ec,!1))):(ea[eg]=ei,ea[em]=eo)},writable:!0}),eo));return ea[eS]=null,ep(ei,function(ei){if(ei&&"ERR_STREAM_PREMATURE_CLOSE"!==ei.code){var eo=ea[em];null!==eo&&(ea[eS]=null,ea[eg]=null,ea[em]=null,eo(ei)),ea[ey]=ei;return}var ec=ea[eg];null!==ec&&(ea[eS]=null,ea[eg]=null,ea[em]=null,ec(e_(void 0,!0))),ea[eb]=!0}),ei.on("readable",eI.bind(null,ea)),ea};ei.exports=ek},7327:function(ei,eo,ea){"use strict";function ec(ei,eo){var ea=Object.keys(ei);if(Object.getOwnPropertySymbols){var ec=Object.getOwnPropertySymbols(ei);eo&&(ec=ec.filter(function(eo){return Object.getOwnPropertyDescriptor(ei,eo).enumerable})),ea.push.apply(ea,ec)}return ea}function ed(ei){for(var eo=1;eo<arguments.length;eo++){var ea=null!=arguments[eo]?arguments[eo]:{};eo%2?ec(Object(ea),!0).forEach(function(eo){eu(ei,eo,ea[eo])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ei,Object.getOwnPropertyDescriptors(ea)):ec(Object(ea)).forEach(function(eo){Object.defineProperty(ei,eo,Object.getOwnPropertyDescriptor(ea,eo))})}return ei}function eu(ei,eo,ea){return(eo=eg(eo))in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}function eh(ei,eo){if(!(ei instanceof eo))throw TypeError("Cannot call a class as a function")}function ef(ei,eo){for(var ea=0;ea<eo.length;ea++){var ec=eo[ea];ec.enumerable=ec.enumerable||!1,ec.configurable=!0,"value"in ec&&(ec.writable=!0),Object.defineProperty(ei,eg(ec.key),ec)}}function ep(ei,eo,ea){return eo&&ef(ei.prototype,eo),ea&&ef(ei,ea),Object.defineProperty(ei,"prototype",{writable:!1}),ei}function eg(ei){var eo=em(ei,"string");return"symbol"==typeof eo?eo:String(eo)}function em(ei,eo){if("object"!=typeof ei||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ec=ea.call(ei,eo||"default");if("object"!=typeof ec)return ec;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}var ey=ea(8764).Buffer,eb=ea(2361).inspect,eS=eb&&eb.custom||"inspect";function eE(ei,eo,ea){ey.prototype.copy.call(ei,eo,ea)}ei.exports=function(){function ei(){eh(this,ei),this.head=null,this.tail=null,this.length=0}return ep(ei,[{key:"push",value:function(ei){var eo={data:ei,next:null};this.length>0?this.tail.next=eo:this.head=eo,this.tail=eo,++this.length}},{key:"unshift",value:function(ei){var eo={data:ei,next:this.head};0===this.length&&(this.tail=eo),this.head=eo,++this.length}},{key:"shift",value:function(){if(0!==this.length){var ei=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,ei}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(ei){if(0===this.length)return"";for(var eo=this.head,ea=""+eo.data;eo=eo.next;)ea+=ei+eo.data;return ea}},{key:"concat",value:function(ei){if(0===this.length)return ey.alloc(0);for(var eo=ey.allocUnsafe(ei>>>0),ea=this.head,ec=0;ea;)eE(ea.data,eo,ec),ec+=ea.data.length,ea=ea.next;return eo}},{key:"consume",value:function(ei,eo){var ea;return ei<this.head.data.length?(ea=this.head.data.slice(0,ei),this.head.data=this.head.data.slice(ei)):ea=ei===this.head.data.length?this.shift():eo?this._getString(ei):this._getBuffer(ei),ea}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(ei){var eo=this.head,ea=1,ec=eo.data;for(ei-=ec.length;eo=eo.next;){var ed=eo.data,eu=ei>ed.length?ed.length:ei;if(eu===ed.length?ec+=ed:ec+=ed.slice(0,ei),0==(ei-=eu)){eu===ed.length?(++ea,eo.next?this.head=eo.next:this.head=this.tail=null):(this.head=eo,eo.data=ed.slice(eu));break}++ea}return this.length-=ea,ec}},{key:"_getBuffer",value:function(ei){var eo=ey.allocUnsafe(ei),ea=this.head,ec=1;for(ea.data.copy(eo),ei-=ea.data.length;ea=ea.next;){var ed=ea.data,eu=ei>ed.length?ed.length:ei;if(ed.copy(eo,eo.length-ei,0,eu),0==(ei-=eu)){eu===ed.length?(++ec,ea.next?this.head=ea.next:this.head=this.tail=null):(this.head=ea,ea.data=ed.slice(eu));break}++ec}return this.length-=ec,eo}},{key:eS,value:function(ei,eo){return eb(this,ed(ed({},eo),{},{depth:0,customInspect:!1}))}}]),ei}()},1195:function(ei,eo,ea){"use strict";var ec=ea(3454);function ed(ei,eo){var ea=this,ed=this._readableState&&this._readableState.destroyed,ef=this._writableState&&this._writableState.destroyed;return ed||ef?(eo?eo(ei):ei&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,ec.nextTick(ep,this,ei)):ec.nextTick(ep,this,ei)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(ei||null,function(ei){!eo&&ei?ea._writableState?ea._writableState.errorEmitted?ec.nextTick(eh,ea):(ea._writableState.errorEmitted=!0,ec.nextTick(eu,ea,ei)):ec.nextTick(eu,ea,ei):eo?(ec.nextTick(eh,ea),eo(ei)):ec.nextTick(eh,ea)}),this)}function eu(ei,eo){ep(ei,eo),eh(ei)}function eh(ei){(!ei._writableState||ei._writableState.emitClose)&&(!ei._readableState||ei._readableState.emitClose)&&ei.emit("close")}function ef(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function ep(ei,eo){ei.emit("error",eo)}function eg(ei,eo){var ea=ei._readableState,ec=ei._writableState;ea&&ea.autoDestroy||ec&&ec.autoDestroy?ei.destroy(eo):ei.emit("error",eo)}ei.exports={destroy:ed,undestroy:ef,errorOrDestroy:eg}},8610:function(ei,eo,ea){"use strict";var ec=ea(4281).q.ERR_STREAM_PREMATURE_CLOSE;function ed(ei){var eo=!1;return function(){if(!eo){eo=!0;for(var ea=arguments.length,ec=Array(ea),ed=0;ed<ea;ed++)ec[ed]=arguments[ed];ei.apply(this,ec)}}}function eu(){}function eh(ei){return ei.setHeader&&"function"==typeof ei.abort}function ef(ei,eo,ea){if("function"==typeof eo)return ef(ei,null,eo);eo||(eo={}),ea=ed(ea||eu);var ep=eo.readable||!1!==eo.readable&&ei.readable,eg=eo.writable||!1!==eo.writable&&ei.writable,em=function(){ei.writable||eb()},ey=ei._writableState&&ei._writableState.finished,eb=function(){eg=!1,ey=!0,ep||ea.call(ei)},eS=ei._readableState&&ei._readableState.endEmitted,eE=function(){ep=!1,eS=!0,eg||ea.call(ei)},ew=function(eo){ea.call(ei,eo)},e_=function(){var eo;return ep&&!eS?(ei._readableState&&ei._readableState.ended||(eo=new ec),ea.call(ei,eo)):eg&&!ey?(ei._writableState&&ei._writableState.ended||(eo=new ec),ea.call(ei,eo)):void 0},eT=function(){ei.req.on("finish",eb)};return eh(ei)?(ei.on("complete",eb),ei.on("abort",e_),ei.req?eT():ei.on("request",eT)):eg&&!ei._writableState&&(ei.on("end",em),ei.on("close",em)),ei.on("end",eE),ei.on("finish",eb),!1!==eo.error&&ei.on("error",ew),ei.on("close",e_),function(){ei.removeListener("complete",eb),ei.removeListener("abort",e_),ei.removeListener("request",eT),ei.req&&ei.req.removeListener("finish",eb),ei.removeListener("end",em),ei.removeListener("close",em),ei.removeListener("finish",eb),ei.removeListener("end",eE),ei.removeListener("error",ew),ei.removeListener("close",e_)}}ei.exports=ef},5167:function(ei){ei.exports=function(){throw Error("Readable.from is not available in the browser")}},9946:function(ei,eo,ea){"use strict";function ec(ei){var eo=!1;return function(){eo||(eo=!0,ei.apply(void 0,arguments))}}var ed,eu=ea(4281).q,eh=eu.ERR_MISSING_ARGS,ef=eu.ERR_STREAM_DESTROYED;function ep(ei){if(ei)throw ei}function eg(ei){return ei.setHeader&&"function"==typeof ei.abort}function em(ei,eo,eu,eh){eh=ec(eh);var ep=!1;ei.on("close",function(){ep=!0}),void 0===ed&&(ed=ea(8610)),ed(ei,{readable:eo,writable:eu},function(ei){if(ei)return eh(ei);ep=!0,eh()});var em=!1;return function(eo){if(!ep&&!em){if(em=!0,eg(ei))return ei.abort();if("function"==typeof ei.destroy)return ei.destroy();eh(eo||new ef("pipe"))}}}function ey(ei){ei()}function eb(ei,eo){return ei.pipe(eo)}function eS(ei){return ei.length&&"function"==typeof ei[ei.length-1]?ei.pop():ep}function eE(){for(var ei,eo=arguments.length,ea=Array(eo),ec=0;ec<eo;ec++)ea[ec]=arguments[ec];var ed=eS(ea);if(Array.isArray(ea[0])&&(ea=ea[0]),ea.length<2)throw new eh("streams");var eu=ea.map(function(eo,ec){var eh=ec<ea.length-1;return em(eo,eh,ec>0,function(eo){ei||(ei=eo),eo&&eu.forEach(ey),eh||(eu.forEach(ey),ed(ei))})});return ea.reduce(eb)}ei.exports=eE},2457:function(ei,eo,ea){"use strict";var ec=ea(4281).q.ERR_INVALID_OPT_VALUE;function ed(ei,eo,ea){return null!=ei.highWaterMark?ei.highWaterMark:eo?ei[ea]:null}function eu(ei,eo,ea,eu){var eh=ed(eo,eu,ea);if(null!=eh){if(!(isFinite(eh)&&Math.floor(eh)===eh)||eh<0){var ef=eu?ea:"highWaterMark";throw new ec(ef,eh)}return Math.floor(eh)}return ei.objectMode?16:16384}ei.exports={getHighWaterMark:eu}},2503:function(ei,eo,ea){ei.exports=ea(7187).EventEmitter},8473:function(ei,eo,ea){(eo=ei.exports=ea(9481)).Stream=eo,eo.Readable=eo,eo.Writable=ea(4229),eo.Duplex=ea(6753),eo.Transform=ea(4605),eo.PassThrough=ea(2725),eo.finished=ea(8610),eo.pipeline=ea(9946)},9353:function(ei,eo,ea){ei.exports=ea(2523)},2523:function(ei,eo,ea){var ec=ea(1960);eo.operation=function(ei){var ea=eo.timeouts(ei);return new ec(ea,{forever:ei&&(ei.forever||ei.retries===1/0),unref:ei&&ei.unref,maxRetryTime:ei&&ei.maxRetryTime})},eo.timeouts=function(ei){if(ei instanceof Array)return[].concat(ei);var eo={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var ea in ei)eo[ea]=ei[ea];if(eo.minTimeout>eo.maxTimeout)throw Error("minTimeout is greater than maxTimeout");for(var ec=[],ed=0;ed<eo.retries;ed++)ec.push(this.createTimeout(ed,eo));return ei&&ei.forever&&!ec.length&&ec.push(this.createTimeout(ed,eo)),ec.sort(function(ei,eo){return ei-eo}),ec},eo.createTimeout=function(ei,eo){return Math.min(Math.round((eo.randomize?Math.random()+1:1)*Math.max(eo.minTimeout,1)*Math.pow(eo.factor,ei)),eo.maxTimeout)},eo.wrap=function(ei,ea,ec){if(ea instanceof Array&&(ec=ea,ea=null),!ec)for(var ed in ec=[],ei)"function"==typeof ei[ed]&&ec.push(ed);for(var eu=0;eu<ec.length;eu++){var eh=ec[eu],ef=ei[eh];ei[eh]=(function(ec){var ed=eo.operation(ea),eu=Array.prototype.slice.call(arguments,1),eh=eu.pop();eu.push(function(ei){ed.retry(ei)||(ei&&(arguments[0]=ed.mainError()),eh.apply(this,arguments))}),ed.attempt(function(){ec.apply(ei,eu)})}).bind(ei,ef),ei[eh].options=ea}}},1960:function(ei){function eo(ei,eo){"boolean"==typeof eo&&(eo={forever:eo}),this._originalTimeouts=JSON.parse(JSON.stringify(ei)),this._timeouts=ei,this._options=eo||{},this._maxRetryTime=eo&&eo.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}ei.exports=eo,eo.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},eo.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},eo.prototype.retry=function(ei){if(this._timeout&&clearTimeout(this._timeout),!ei)return!1;var eo=new Date().getTime();if(ei&&eo-this._operationStart>=this._maxRetryTime)return this._errors.push(ei),this._errors.unshift(Error("RetryOperation timeout occurred")),!1;this._errors.push(ei);var ea=this._timeouts.shift();if(void 0===ea){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),ea=this._cachedTimeouts.slice(-1)}var ec=this;return this._timer=setTimeout(function(){ec._attempts++,ec._operationTimeoutCb&&(ec._timeout=setTimeout(function(){ec._operationTimeoutCb(ec._attempts)},ec._operationTimeout),ec._options.unref&&ec._timeout.unref()),ec._fn(ec._attempts)},ea),this._options.unref&&this._timer.unref(),!0},eo.prototype.attempt=function(ei,eo){this._fn=ei,eo&&(eo.timeout&&(this._operationTimeout=eo.timeout),eo.cb&&(this._operationTimeoutCb=eo.cb));var ea=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){ea._operationTimeoutCb()},ea._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},eo.prototype.try=function(ei){console.log("Using RetryOperation.try() is deprecated"),this.attempt(ei)},eo.prototype.start=function(ei){console.log("Using RetryOperation.start() is deprecated"),this.attempt(ei)},eo.prototype.start=eo.prototype.try,eo.prototype.errors=function(){return this._errors},eo.prototype.attempts=function(){return this._attempts},eo.prototype.mainError=function(){if(0===this._errors.length)return null;for(var ei={},eo=null,ea=0,ec=0;ec<this._errors.length;ec++){var ed=this._errors[ec],eu=ed.message,eh=(ei[eu]||0)+1;ei[eu]=eh,eh>=ea&&(eo=ed,ea=eh)}return eo}},9509:function(ei,eo,ea){/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var ec=ea(8764),ed=ec.Buffer;function eu(ei,eo){for(var ea in ei)eo[ea]=ei[ea]}function eh(ei,eo,ea){return ed(ei,eo,ea)}ed.from&&ed.alloc&&ed.allocUnsafe&&ed.allocUnsafeSlow?ei.exports=ec:(eu(ec,eo),eo.Buffer=eh),eh.prototype=Object.create(ed.prototype),eu(ed,eh),eh.from=function(ei,eo,ea){if("number"==typeof ei)throw TypeError("Argument must not be a number");return ed(ei,eo,ea)},eh.alloc=function(ei,eo,ea){if("number"!=typeof ei)throw TypeError("Argument must be a number");var ec=ed(ei);return void 0!==eo?"string"==typeof ea?ec.fill(eo,ea):ec.fill(eo):ec.fill(0),ec},eh.allocUnsafe=function(ei){if("number"!=typeof ei)throw TypeError("Argument must be a number");return ed(ei)},eh.allocUnsafeSlow=function(ei){if("number"!=typeof ei)throw TypeError("Argument must be a number");return ec.SlowBuffer(ei)}},6692:function(ei){var eo=ei.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(ei){return ei.encoding?"rtpmap:%d %s/%s/%s":ei.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(ei){return null!=ei.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(ei){return null!=ei.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(ei){return"extmap:%d"+(ei.direction?"/%s":"%v")+(ei["encrypt-uri"]?" %s":"%v")+" %s"+(ei.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(ei){return null!=ei.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(ei){var eo="candidate:%s %d %s %d %s %d typ %s";return eo+=(null!=ei.raddr?" raddr %s rport %d":"%v%v")+(null!=ei.tcptype?" tcptype %s":"%v"),null!=ei.generation&&(eo+=" generation %d"),eo+=(null!=ei["network-id"]?" network-id %d":"%v")+(null!=ei["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(ei){var eo="ssrc:%d";return null!=ei.attribute&&(eo+=" %s",null!=ei.value&&(eo+=":%s")),eo}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(ei){return null!=ei.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(ei){return ei.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(ei){return"imageattr:%s %s %s"+(ei.dir2?" %s %s":"")}},{name:"simulcast",reg:RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(ei){return"simulcast:%s %s"+(ei.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(ei){return"ts-refclk:%s"+(null!=ei.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(ei){return"mediaclk:"+((null!=ei.id?"id=%s %s":"%v%s")+(null!=ei.mediaClockValue?"=%s":"")+(null!=ei.rateNumerator?" rate=%s":""))+(null!=ei.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(eo).forEach(function(ei){eo[ei].forEach(function(ei){ei.reg||(ei.reg=/(.*)/),ei.format||(ei.format="%s")})})},766:function(ei,eo,ea){var ec=ea(962),ed=ea(5776);eo.write=ed,eo.parse=ec.parse,eo.parseParams=ec.parseParams,eo.parseFmtpConfig=ec.parseFmtpConfig,eo.parsePayloads=ec.parsePayloads,eo.parseRemoteCandidates=ec.parseRemoteCandidates,eo.parseImageAttributes=ec.parseImageAttributes,eo.parseSimulcastStreamList=ec.parseSimulcastStreamList},962:function(ei,eo,ea){var ec=function(ei){return String(Number(ei))===ei?Number(ei):ei},ed=function(ei,eo,ea,ed){if(ed&&!ea)eo[ed]=ec(ei[1]);else for(var eu=0;eu<ea.length;eu+=1)null!=ei[eu+1]&&(eo[ea[eu]]=ec(ei[eu+1]))},eu=function(ei,eo,ea){var ec=ei.name&&ei.names;ei.push&&!eo[ei.push]?eo[ei.push]=[]:ec&&!eo[ei.name]&&(eo[ei.name]={});var eu=ei.push?{}:ec?eo[ei.name]:eo;ed(ea.match(ei.reg),eu,ei.names,ei.name),ei.push&&eo[ei.push].push(eu)},eh=ea(6692),ef=RegExp.prototype.test.bind(/^([a-z])=(.*)/);eo.parse=function(ei){var eo={},ea=[],ec=eo;return ei.split(/(\r\n|\r|\n)/).filter(ef).forEach(function(ei){var eo=ei[0],ed=ei.slice(2);"m"===eo&&(ea.push({rtp:[],fmtp:[]}),ec=ea[ea.length-1]);for(var ef=0;ef<(eh[eo]||[]).length;ef+=1){var ep=eh[eo][ef];if(ep.reg.test(ed))return eu(ep,ec,ed)}}),eo.media=ea,eo};var ep=function(ei,eo){var ea=eo.split(/=(.+)/,2);return 2===ea.length?ei[ea[0]]=ec(ea[1]):1===ea.length&&eo.length>1&&(ei[ea[0]]=void 0),ei};eo.parseParams=function(ei){return ei.split(/;\s?/).reduce(ep,{})},eo.parseFmtpConfig=eo.parseParams,eo.parsePayloads=function(ei){return ei.toString().split(" ").map(Number)},eo.parseRemoteCandidates=function(ei){for(var eo=[],ea=ei.split(" ").map(ec),ed=0;ed<ea.length;ed+=3)eo.push({component:ea[ed],ip:ea[ed+1],port:ea[ed+2]});return eo},eo.parseImageAttributes=function(ei){return ei.split(" ").map(function(ei){return ei.substring(1,ei.length-1).split(",").reduce(ep,{})})},eo.parseSimulcastStreamList=function(ei){return ei.split(";").map(function(ei){return ei.split(",").map(function(ei){var eo,ea=!1;return"~"!==ei[0]?eo=ec(ei):(eo=ec(ei.substring(1,ei.length)),ea=!0),{scid:eo,paused:ea}})})}},5776:function(ei,eo,ea){var ec=ea(6692),ed=/%[sdv%]/g,eu=function(ei){var eo=1,ea=arguments,ec=ea.length;return ei.replace(ed,function(ei){if(eo>=ec)return ei;var ed=ea[eo];switch(eo+=1,ei){case"%%":return"%";case"%s":return String(ed);case"%d":return Number(ed);case"%v":return""}})},eh=function(ei,eo,ea){var ec=[ei+"="+(eo.format instanceof Function?eo.format(eo.push?ea:ea[eo.name]):eo.format)];if(eo.names)for(var ed=0;ed<eo.names.length;ed+=1){var eh=eo.names[ed];eo.name?ec.push(ea[eo.name][eh]):ec.push(ea[eo.names[ed]])}else ec.push(ea[eo.name]);return eu.apply(null,ec)},ef=["v","o","s","i","u","e","p","c","b","t","r","z","a"],ep=["i","c","b","a"];ei.exports=function(ei,eo){eo=eo||{},null==ei.version&&(ei.version=0),null==ei.name&&(ei.name=" "),ei.media.forEach(function(ei){null==ei.payloads&&(ei.payloads="")});var ea=eo.outerOrder||ef,ed=eo.innerOrder||ep,eu=[];return ea.forEach(function(eo){ec[eo].forEach(function(ea){ea.name in ei&&null!=ei[ea.name]?eu.push(eh(eo,ea,ei)):ea.push in ei&&null!=ei[ea.push]&&ei[ea.push].forEach(function(ei){eu.push(eh(eo,ea,ei))})})}),ei.media.forEach(function(ei){eu.push(eh("m",ec.m[0],ei)),ed.forEach(function(eo){ec[eo].forEach(function(ea){ea.name in ei&&null!=ei[ea.name]?eu.push(eh(eo,ea,ei)):ea.push in ei&&null!=ei[ea.push]&&ei[ea.push].forEach(function(ei){eu.push(eh(eo,ea,ei))})})})}),eu.join("\r\n")+"\r\n"}},8853:function(ei,eo,ea){/*! simple-peer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let ec=ea(1227)("simple-peer"),ed=ea(5177),eu=ea(1798),eh=ea(8473),ef=ea(4375),ep=ea(2114),{Buffer:eg}=ea(8764),em=65536,ey=5e3,eb=5e3;function eS(ei){return ei.replace(/a=ice-options:trickle\s\n/g,"")}function eE(ei){console.warn(ei)}class ew extends eh.Duplex{constructor(ei){if(super(ei=Object.assign({allowHalfOpen:!1},ei)),this._id=eu(4).toString("hex").slice(0,7),this._debug("new peer %o",ei),this.channelName=ei.initiator?ei.channelName||eu(20).toString("hex"):null,this.initiator=ei.initiator||!1,this.channelConfig=ei.channelConfig||ew.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},ew.config,ei.config),this.offerOptions=ei.offerOptions||{},this.answerOptions=ei.answerOptions||{},this.sdpTransform=ei.sdpTransform||(ei=>ei),this.streams=ei.streams||(ei.stream?[ei.stream]:[]),this.trickle=void 0===ei.trickle||ei.trickle,this.allowHalfTrickle=void 0!==ei.allowHalfTrickle&&ei.allowHalfTrickle,this.iceCompleteTimeout=ei.iceCompleteTimeout||ey,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=ei.wrtc&&"object"==typeof ei.wrtc?ei.wrtc:ed(),!this._wrtc){if("undefined"==typeof window)throw ep(Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT");throw ep(Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT")}this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(ei){this.destroy(ep(ei,"ERR_PC_CONSTRUCTOR"));return}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=ei=>{this._onIceCandidate(ei)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch(ei=>{this.destroy(ep(ei,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=ei=>{this._setupData(ei)},this.streams&&this.streams.forEach(ei=>{this.addStream(ei)}),this._pc.ontrack=ei=>{this._onTrack(ei)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(ei){if(!this.destroying){if(this.destroyed)throw ep(Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof ei)try{ei=JSON.parse(ei)}catch(eo){ei={}}this._debug("signal()"),ei.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),ei.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(ei.transceiverRequest.kind,ei.transceiverRequest.init)),ei.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(ei.candidate):this._pendingCandidates.push(ei.candidate)),ei.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(ei)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(ei=>{this._addIceCandidate(ei)}),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())}).catch(ei=>{this.destroy(ep(ei,"ERR_SET_REMOTE_DESCRIPTION"))}),ei.sdp||ei.candidate||ei.renegotiate||ei.transceiverRequest||this.destroy(ep(Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(ei){let eo=new this._wrtc.RTCIceCandidate(ei);this._pc.addIceCandidate(eo).catch(ei=>{!eo.address||eo.address.endsWith(".local")?eE("Ignoring unsupported ICE candidate."):this.destroy(ep(ei,"ERR_ADD_ICE_CANDIDATE"))})}send(ei){if(!this.destroying){if(this.destroyed)throw ep(Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(ei)}}addTransceiver(ei,eo){if(!this.destroying){if(this.destroyed)throw ep(Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(ei,eo),this._needsNegotiation()}catch(ei){this.destroy(ep(ei,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:ei,init:eo}})}}addStream(ei){if(!this.destroying){if(this.destroyed)throw ep(Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),ei.getTracks().forEach(eo=>{this.addTrack(eo,ei)})}}addTrack(ei,eo){if(this.destroying)return;if(this.destroyed)throw ep(Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");let ea=this._senderMap.get(ei)||new Map,ec=ea.get(eo);if(ec){if(ec.removed)throw ep(Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED");throw ep(Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED")}ec=this._pc.addTrack(ei,eo),ea.set(eo,ec),this._senderMap.set(ei,ea),this._needsNegotiation()}replaceTrack(ei,eo,ea){if(this.destroying)return;if(this.destroyed)throw ep(Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");let ec=this._senderMap.get(ei),ed=ec?ec.get(ea):null;if(!ed)throw ep(Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");eo&&this._senderMap.set(eo,ec),null!=ed.replaceTrack?ed.replaceTrack(eo):this.destroy(ep(Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(ei,eo){if(this.destroying)return;if(this.destroyed)throw ep(Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");let ea=this._senderMap.get(ei),ec=ea?ea.get(eo):null;if(!ec)throw ep(Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{ec.removed=!0,this._pc.removeTrack(ec)}catch(ei){"NS_ERROR_UNEXPECTED"===ei.name?this._sendersAwaitingStable.push(ec):this.destroy(ep(ei,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(ei){if(!this.destroying){if(this.destroyed)throw ep(Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),ei.getTracks().forEach(eo=>{this.removeTrack(eo,ei)})}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,ef(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this.destroying){if(this.destroyed)throw ep(Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}destroy(ei){this._destroy(ei,()=>{})}_destroy(ei,eo){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",ei&&(ei.message||ei)),ef(()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",ei&&(ei.message||ei)),this.readable=this.writable=!1,this._readableState.ended||this.push(null),this._writableState.finished||this.end(),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(ei){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(ei){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,ei&&this.emit("error",ei),this.emit("close"),eo()}))}_setupData(ei){if(!ei.channel)return this.destroy(ep(Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=ei.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=em),this.channelName=this._channel.label,this._channel.onmessage=ei=>{this._onChannelMessage(ei)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=ei=>{let eo=ei.error instanceof Error?ei.error:Error(`Datachannel error: ${ei.message} ${ei.filename}:${ei.lineno}:${ei.colno}`);this.destroy(ep(eo,"ERR_DATA_CHANNEL"))};let eo=!1;this._closingInterval=setInterval(()=>{this._channel&&"closing"===this._channel.readyState?(eo&&this._onChannelClose(),eo=!0):eo=!1},eb)}_read(){}_write(ei,eo,ea){if(this.destroyed)return ea(ep(Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(ei)}catch(ei){return this.destroy(ep(ei,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>em?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=ea):ea(null)}else this._debug("write before connect"),this._chunk=ei,this._cb=ea}_onFinish(){if(this.destroyed)return;let ei=()=>{setTimeout(()=>this.destroy(),1e3)};this._connected?ei():this.once("connect",ei)}_startIceCompleteTimeout(){!this.destroyed&&(this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout)))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(ei=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(ei.sdp=eS(ei.sdp)),ei.sdp=this.sdpTransform(ei.sdp);let eo=()=>{if(this.destroyed)return;let eo=this._pc.localDescription||ei;this._debug("signal"),this.emit("signal",{type:eo.type,sdp:eo.sdp})},ea=()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?eo():this.once("_iceComplete",eo))},ec=ei=>{this.destroy(ep(ei,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(ei).then(ea).catch(ec)}).catch(ei=>{this.destroy(ep(ei,"ERR_CREATE_OFFER"))})}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach(ei=>{ei.mid||!ei.sender.track||ei.requested||(ei.requested=!0,this.addTransceiver(ei.sender.track.kind))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(ei=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(ei.sdp=eS(ei.sdp)),ei.sdp=this.sdpTransform(ei.sdp);let eo=()=>{if(this.destroyed)return;let eo=this._pc.localDescription||ei;this._debug("signal"),this.emit("signal",{type:eo.type,sdp:eo.sdp}),this.initiator||this._requestMissingTransceivers()},ea=()=>{this.destroyed||(this.trickle||this._iceComplete?eo():this.once("_iceComplete",eo))},ec=ei=>{this.destroy(ep(ei,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(ei).then(ea).catch(ec)}).catch(ei=>{this.destroy(ep(ei,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||"failed"!==this._pc.connectionState||this.destroy(ep(Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;let ei=this._pc.iceConnectionState,eo=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",ei,eo),this.emit("iceStateChange",ei,eo),("connected"===ei||"completed"===ei)&&(this._pcReady=!0,this._maybeReady()),"failed"===ei&&this.destroy(ep(Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===ei&&this.destroy(ep(Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(ei){let eo=ei=>("[object Array]"===Object.prototype.toString.call(ei.values)&&ei.values.forEach(eo=>{Object.assign(ei,eo)}),ei);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then(ea=>{let ec=[];ea.forEach(ei=>{ec.push(eo(ei))}),ei(null,ec)},eo=>ei(eo)):this._pc.getStats.length>0?this._pc.getStats(ea=>{if(this.destroyed)return;let ec=[];ea.result().forEach(ei=>{let ea={};ei.names().forEach(eo=>{ea[eo]=ei.stat(eo)}),ea.id=ei.id,ea.type=ei.type,ea.timestamp=ei.timestamp,ec.push(eo(ea))}),ei(null,ec)},eo=>ei(eo)):ei(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;let ei=()=>{this.destroyed||this.getStats((eo,ea)=>{if(this.destroyed)return;eo&&(ea=[]);let ec={},ed={},eu={},eh=!1;ea.forEach(ei=>{("remotecandidate"===ei.type||"remote-candidate"===ei.type)&&(ec[ei.id]=ei),("localcandidate"===ei.type||"local-candidate"===ei.type)&&(ed[ei.id]=ei),("candidatepair"===ei.type||"candidate-pair"===ei.type)&&(eu[ei.id]=ei)});let ef=ei=>{eh=!0;let eo=ed[ei.localCandidateId];eo&&(eo.ip||eo.address)?(this.localAddress=eo.ip||eo.address,this.localPort=Number(eo.port)):eo&&eo.ipAddress?(this.localAddress=eo.ipAddress,this.localPort=Number(eo.portNumber)):"string"==typeof ei.googLocalAddress&&(eo=ei.googLocalAddress.split(":"),this.localAddress=eo[0],this.localPort=Number(eo[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let ea=ec[ei.remoteCandidateId];ea&&(ea.ip||ea.address)?(this.remoteAddress=ea.ip||ea.address,this.remotePort=Number(ea.port)):ea&&ea.ipAddress?(this.remoteAddress=ea.ipAddress,this.remotePort=Number(ea.portNumber)):"string"==typeof ei.googRemoteAddress&&(ea=ei.googRemoteAddress.split(":"),this.remoteAddress=ea[0],this.remotePort=Number(ea[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(ea.forEach(ei=>{"transport"===ei.type&&ei.selectedCandidatePairId&&ef(eu[ei.selectedCandidatePairId]),("googCandidatePair"===ei.type&&"true"===ei.googActiveConnection||("candidatepair"===ei.type||"candidate-pair"===ei.type)&&ei.selected)&&ef(ei)}),eh||Object.keys(eu).length&&!Object.keys(ed).length)this._connecting=!1,this._connected=!0;else{setTimeout(ei,100);return}if(this._chunk){try{this.send(this._chunk)}catch(ei){return this.destroy(ep(ei,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');let ei=this._cb;this._cb=null,ei(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")})};ei()}_onInterval(){this._cb&&this._channel&&!(this._channel.bufferedAmount>em)&&this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(ei=>{this._pc.removeTrack(ei),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(ei){!this.destroyed&&(ei.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:ei.candidate.candidate,sdpMLineIndex:ei.candidate.sdpMLineIndex,sdpMid:ei.candidate.sdpMid}}):ei.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),ei.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(ei){if(this.destroyed)return;let eo=ei.data;eo instanceof ArrayBuffer&&(eo=eg.from(eo)),this.push(eo)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);let ei=this._cb;this._cb=null,ei(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(ei){this.destroyed||ei.streams.forEach(eo=>{this._debug("on track"),this.emit("track",ei.track,eo),this._remoteTracks.push({track:ei.track,stream:eo}),this._remoteStreams.some(ei=>ei.id===eo.id)||(this._remoteStreams.push(eo),ef(()=>{this._debug("on stream"),this.emit("stream",eo)}))})}_debug(){let ei=[].slice.call(arguments);ei[0]="["+this._id+"] "+ei[0],ec.apply(null,ei)}}ew.WEBRTC_SUPPORT=!!ed(),ew.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},ew.channelConfig={},ei.exports=ew},2553:function(ei,eo,ea){"use strict";var ec=ea(9509).Buffer,ed=ec.isEncoding||function(ei){switch((ei=""+ei)&&ei.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function eu(ei){var eo;if(!ei)return"utf8";for(;;)switch(ei){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return ei;default:if(eo)return;ei=(""+ei).toLowerCase(),eo=!0}}function eh(ei){var eo=eu(ei);if("string"!=typeof eo&&(ec.isEncoding===ed||!ed(ei)))throw Error("Unknown encoding: "+ei);return eo||ei}function ef(ei){var eo;switch(this.encoding=eh(ei),this.encoding){case"utf16le":this.text=eE,this.end=ew,eo=4;break;case"utf8":this.fillLast=ey,eo=4;break;case"base64":this.text=e_,this.end=eT,eo=3;break;default:this.write=eI,this.end=eC;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=ec.allocUnsafe(eo)}function ep(ei){return ei<=127?0:ei>>5==6?2:ei>>4==14?3:ei>>3==30?4:ei>>6==2?-1:-2}function eg(ei,eo,ea){var ec=eo.length-1;if(ec<ea)return 0;var ed=ep(eo[ec]);return ed>=0?(ed>0&&(ei.lastNeed=ed-1),ed):--ec<ea||-2===ed?0:(ed=ep(eo[ec]))>=0?(ed>0&&(ei.lastNeed=ed-2),ed):--ec<ea||-2===ed?0:(ed=ep(eo[ec]))>=0?(ed>0&&(2===ed?ed=0:ei.lastNeed=ed-3),ed):0}function em(ei,eo,ea){if((192&eo[0])!=128)return ei.lastNeed=0,"";if(ei.lastNeed>1&&eo.length>1){if((192&eo[1])!=128)return ei.lastNeed=1,"";if(ei.lastNeed>2&&eo.length>2&&(192&eo[2])!=128)return ei.lastNeed=2,""}}function ey(ei){var eo=this.lastTotal-this.lastNeed,ea=em(this,ei,eo);return void 0!==ea?ea:this.lastNeed<=ei.length?(ei.copy(this.lastChar,eo,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):void(ei.copy(this.lastChar,eo,0,ei.length),this.lastNeed-=ei.length)}function eb(ei,eo){var ea=eg(this,ei,eo);if(!this.lastNeed)return ei.toString("utf8",eo);this.lastTotal=ea;var ec=ei.length-(ea-this.lastNeed);return ei.copy(this.lastChar,0,ec),ei.toString("utf8",eo,ec)}function eS(ei){var eo=ei&&ei.length?this.write(ei):"";return this.lastNeed?eo+"":eo}function eE(ei,eo){if((ei.length-eo)%2==0){var ea=ei.toString("utf16le",eo);if(ea){var ec=ea.charCodeAt(ea.length-1);if(ec>=55296&&ec<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=ei[ei.length-2],this.lastChar[1]=ei[ei.length-1],ea.slice(0,-1)}return ea}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=ei[ei.length-1],ei.toString("utf16le",eo,ei.length-1)}function ew(ei){var eo=ei&&ei.length?this.write(ei):"";if(this.lastNeed){var ea=this.lastTotal-this.lastNeed;return eo+this.lastChar.toString("utf16le",0,ea)}return eo}function e_(ei,eo){var ea=(ei.length-eo)%3;return 0===ea?ei.toString("base64",eo):(this.lastNeed=3-ea,this.lastTotal=3,1===ea?this.lastChar[0]=ei[ei.length-1]:(this.lastChar[0]=ei[ei.length-2],this.lastChar[1]=ei[ei.length-1]),ei.toString("base64",eo,ei.length-ea))}function eT(ei){var eo=ei&&ei.length?this.write(ei):"";return this.lastNeed?eo+this.lastChar.toString("base64",0,3-this.lastNeed):eo}function eI(ei){return ei.toString(this.encoding)}function eC(ei){return ei&&ei.length?this.write(ei):""}eo.StringDecoder=ef,ef.prototype.write=function(ei){var eo,ea;if(0===ei.length)return"";if(this.lastNeed){if(void 0===(eo=this.fillLast(ei)))return"";ea=this.lastNeed,this.lastNeed=0}else ea=0;return ea<ei.length?eo?eo+this.text(ei,ea):this.text(ei,ea):eo||""},ef.prototype.end=eS,ef.prototype.text=eb,ef.prototype.fillLast=function(ei){if(this.lastNeed<=ei.length)return ei.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);ei.copy(this.lastChar,this.lastTotal-this.lastNeed,0,ei.length),this.lastNeed-=ei.length}},5067:function(ei,eo,ea){"use strict";var ec=ea(7873);function ed(ei){return ei.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var eu=RegExp(Object.keys(ec).map(ed).join("|"),"g");function eh(ei){return ec[ei]}function ef(ei){return ei.replace(eu,eh)}ei.exports=ef},4927:function(ei,eo,ea){function ec(ei,eo){if(ed("noDeprecation"))return ei;var ea=!1;return function(){if(!ea){if(ed("throwDeprecation"))throw Error(eo);ed("traceDeprecation")?console.trace(eo):console.warn(eo),ea=!0}return ei.apply(this,arguments)}}function ed(ei){try{if(!ea.g.localStorage)return!1}catch(ei){return!1}var eo=ea.g.localStorage[ei];return null!=eo&&"true"===String(eo).toLowerCase()}ei.exports=ec},7429:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),Object.defineProperty(eo,"NIL",{enumerable:!0,get:function(){return ef.default}}),Object.defineProperty(eo,"parse",{enumerable:!0,get:function(){return ey.default}}),Object.defineProperty(eo,"stringify",{enumerable:!0,get:function(){return em.default}}),Object.defineProperty(eo,"v1",{enumerable:!0,get:function(){return ec.default}}),Object.defineProperty(eo,"v3",{enumerable:!0,get:function(){return ed.default}}),Object.defineProperty(eo,"v4",{enumerable:!0,get:function(){return eu.default}}),Object.defineProperty(eo,"v5",{enumerable:!0,get:function(){return eh.default}}),Object.defineProperty(eo,"validate",{enumerable:!0,get:function(){return eg.default}}),Object.defineProperty(eo,"version",{enumerable:!0,get:function(){return ep.default}});var ec=eb(ea(3990)),ed=eb(ea(8237)),eu=eb(ea(5355)),eh=eb(ea(3764)),ef=eb(ea(6314)),ep=eb(ea(8464)),eg=eb(ea(6435)),em=eb(ea(4008)),ey=eb(ea(8222));function eb(ei){return ei&&ei.__esModule?ei:{default:ei}}},4163:function(ei,eo){"use strict";function ea(ei){let eo=[],ea=32*ei.length,ec="0123456789abcdef";for(let ed=0;ed<ea;ed+=8){let ea=ei[ed>>5]>>>ed%32&255,eu=parseInt(ec.charAt(ea>>>4&15)+ec.charAt(15&ea),16);eo.push(eu)}return eo}function ec(ei){return(ei+64>>>9<<4)+14+1}function ed(ei,eo){ei[eo>>5]|=128<<eo%32,ei[ec(eo)-1]=eo;let ea=1732584193,ed=-271733879,eu=-1732584194,ef=271733878;for(let eo=0;eo<ei.length;eo+=16){let ec=ea,ep=ed,eS=eu,eE=ef;ea=eg(ea,ed,eu,ef,ei[eo],7,-680876936),ef=eg(ef,ea,ed,eu,ei[eo+1],12,-389564586),eu=eg(eu,ef,ea,ed,ei[eo+2],17,606105819),ed=eg(ed,eu,ef,ea,ei[eo+3],22,-1044525330),ea=eg(ea,ed,eu,ef,ei[eo+4],7,-176418897),ef=eg(ef,ea,ed,eu,ei[eo+5],12,1200080426),eu=eg(eu,ef,ea,ed,ei[eo+6],17,-1473231341),ed=eg(ed,eu,ef,ea,ei[eo+7],22,-45705983),ea=eg(ea,ed,eu,ef,ei[eo+8],7,1770035416),ef=eg(ef,ea,ed,eu,ei[eo+9],12,-1958414417),eu=eg(eu,ef,ea,ed,ei[eo+10],17,-42063),ed=eg(ed,eu,ef,ea,ei[eo+11],22,-1990404162),ea=eg(ea,ed,eu,ef,ei[eo+12],7,1804603682),ef=eg(ef,ea,ed,eu,ei[eo+13],12,-40341101),eu=eg(eu,ef,ea,ed,ei[eo+14],17,-1502002290),ed=eg(ed,eu,ef,ea,ei[eo+15],22,1236535329),ea=em(ea,ed,eu,ef,ei[eo+1],5,-165796510),ef=em(ef,ea,ed,eu,ei[eo+6],9,-1069501632),eu=em(eu,ef,ea,ed,ei[eo+11],14,643717713),ed=em(ed,eu,ef,ea,ei[eo],20,-373897302),ea=em(ea,ed,eu,ef,ei[eo+5],5,-701558691),ef=em(ef,ea,ed,eu,ei[eo+10],9,38016083),eu=em(eu,ef,ea,ed,ei[eo+15],14,-660478335),ed=em(ed,eu,ef,ea,ei[eo+4],20,-405537848),ea=em(ea,ed,eu,ef,ei[eo+9],5,568446438),ef=em(ef,ea,ed,eu,ei[eo+14],9,-1019803690),eu=em(eu,ef,ea,ed,ei[eo+3],14,-187363961),ed=em(ed,eu,ef,ea,ei[eo+8],20,1163531501),ea=em(ea,ed,eu,ef,ei[eo+13],5,-1444681467),ef=em(ef,ea,ed,eu,ei[eo+2],9,-51403784),eu=em(eu,ef,ea,ed,ei[eo+7],14,1735328473),ed=em(ed,eu,ef,ea,ei[eo+12],20,-1926607734),ea=ey(ea,ed,eu,ef,ei[eo+5],4,-378558),ef=ey(ef,ea,ed,eu,ei[eo+8],11,-2022574463),eu=ey(eu,ef,ea,ed,ei[eo+11],16,1839030562),ed=ey(ed,eu,ef,ea,ei[eo+14],23,-35309556),ea=ey(ea,ed,eu,ef,ei[eo+1],4,-1530992060),ef=ey(ef,ea,ed,eu,ei[eo+4],11,1272893353),eu=ey(eu,ef,ea,ed,ei[eo+7],16,-155497632),ed=ey(ed,eu,ef,ea,ei[eo+10],23,-1094730640),ea=ey(ea,ed,eu,ef,ei[eo+13],4,681279174),ef=ey(ef,ea,ed,eu,ei[eo],11,-358537222),eu=ey(eu,ef,ea,ed,ei[eo+3],16,-722521979),ed=ey(ed,eu,ef,ea,ei[eo+6],23,76029189),ea=ey(ea,ed,eu,ef,ei[eo+9],4,-640364487),ef=ey(ef,ea,ed,eu,ei[eo+12],11,-421815835),eu=ey(eu,ef,ea,ed,ei[eo+15],16,530742520),ed=ey(ed,eu,ef,ea,ei[eo+2],23,-995338651),ea=eb(ea,ed,eu,ef,ei[eo],6,-198630844),ef=eb(ef,ea,ed,eu,ei[eo+7],10,1126891415),eu=eb(eu,ef,ea,ed,ei[eo+14],15,-1416354905),ed=eb(ed,eu,ef,ea,ei[eo+5],21,-57434055),ea=eb(ea,ed,eu,ef,ei[eo+12],6,1700485571),ef=eb(ef,ea,ed,eu,ei[eo+3],10,-1894986606),eu=eb(eu,ef,ea,ed,ei[eo+10],15,-1051523),ed=eb(ed,eu,ef,ea,ei[eo+1],21,-2054922799),ea=eb(ea,ed,eu,ef,ei[eo+8],6,1873313359),ef=eb(ef,ea,ed,eu,ei[eo+15],10,-30611744),eu=eb(eu,ef,ea,ed,ei[eo+6],15,-1560198380),ed=eb(ed,eu,ef,ea,ei[eo+13],21,1309151649),ea=eb(ea,ed,eu,ef,ei[eo+4],6,-145523070),ef=eb(ef,ea,ed,eu,ei[eo+11],10,-1120210379),eu=eb(eu,ef,ea,ed,ei[eo+2],15,718787259),ed=eb(ed,eu,ef,ea,ei[eo+9],21,-343485551),ea=eh(ea,ec),ed=eh(ed,ep),eu=eh(eu,eS),ef=eh(ef,eE)}return[ea,ed,eu,ef]}function eu(ei){if(0===ei.length)return[];let eo=8*ei.length,ea=new Uint32Array(ec(eo));for(let ec=0;ec<eo;ec+=8)ea[ec>>5]|=(255&ei[ec/8])<<ec%32;return ea}function eh(ei,eo){let ea=(65535&ei)+(65535&eo),ec=(ei>>16)+(eo>>16)+(ea>>16);return ec<<16|65535&ea}function ef(ei,eo){return ei<<eo|ei>>>32-eo}function ep(ei,eo,ea,ec,ed,eu){return eh(ef(eh(eh(eo,ei),eh(ec,eu)),ed),ea)}function eg(ei,eo,ea,ec,ed,eu,eh){return ep(eo&ea|~eo&ec,ei,eo,ed,eu,eh)}function em(ei,eo,ea,ec,ed,eu,eh){return ep(eo&ec|ea&~ec,ei,eo,ed,eu,eh)}function ey(ei,eo,ea,ec,ed,eu,eh){return ep(eo^ea^ec,ei,eo,ed,eu,eh)}function eb(ei,eo,ea,ec,ed,eu,eh){return ep(ea^(eo|~ec),ei,eo,ed,eu,eh)}Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var eS=function(ei){if("string"==typeof ei){let eo=unescape(encodeURIComponent(ei));ei=new Uint8Array(eo.length);for(let ea=0;ea<eo.length;++ea)ei[ea]=eo.charCodeAt(ea)}return ea(ed(eu(ei),8*ei.length))};eo.default=eS},4790:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;let ea="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var ec={randomUUID:ea};eo.default=ec},6314:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ea="00000000-0000-0000-0000-000000000000";eo.default=ea},8222:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ec=ed(ea(6435));function ed(ei){return ei&&ei.__esModule?ei:{default:ei}}var eu=function(ei){let eo;if(!(0,ec.default)(ei))throw TypeError("Invalid UUID");let ea=new Uint8Array(16);return ea[0]=(eo=parseInt(ei.slice(0,8),16))>>>24,ea[1]=eo>>>16&255,ea[2]=eo>>>8&255,ea[3]=255&eo,ea[4]=(eo=parseInt(ei.slice(9,13),16))>>>8,ea[5]=255&eo,ea[6]=(eo=parseInt(ei.slice(14,18),16))>>>8,ea[7]=255&eo,ea[8]=(eo=parseInt(ei.slice(19,23),16))>>>8,ea[9]=255&eo,ea[10]=(eo=parseInt(ei.slice(24,36),16))/1099511627776&255,ea[11]=eo/4294967296&255,ea[12]=eo>>>24&255,ea[13]=eo>>>16&255,ea[14]=eo>>>8&255,ea[15]=255&eo,ea};eo.default=eu},58:function(ei,eo){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ea=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;eo.default=ea},3319:function(ei,eo){"use strict";let ea;Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=ed;let ec=new Uint8Array(16);function ed(){if(!ea&&!(ea="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ea(ec)}},3757:function(ei,eo){"use strict";function ea(ei,eo,ea,ec){switch(ei){case 0:return eo&ea^~eo&ec;case 1:case 3:return eo^ea^ec;case 2:return eo&ea^eo&ec^ea&ec}}function ec(ei,eo){return ei<<eo|ei>>>32-eo}Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ed=function(ei){let eo=[1518500249,1859775393,2400959708,3395469782],ed=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof ei){let eo=unescape(encodeURIComponent(ei));ei=[];for(let ea=0;ea<eo.length;++ea)ei.push(eo.charCodeAt(ea))}else Array.isArray(ei)||(ei=Array.prototype.slice.call(ei));ei.push(128);let eu=ei.length/4+2,eh=Math.ceil(eu/16),ef=Array(eh);for(let eo=0;eo<eh;++eo){let ea=new Uint32Array(16);for(let ec=0;ec<16;++ec)ea[ec]=ei[64*eo+4*ec]<<24|ei[64*eo+4*ec+1]<<16|ei[64*eo+4*ec+2]<<8|ei[64*eo+4*ec+3];ef[eo]=ea}ef[eh-1][14]=(ei.length-1)*8/4294967296,ef[eh-1][14]=Math.floor(ef[eh-1][14]),ef[eh-1][15]=(ei.length-1)*8&4294967295;for(let ei=0;ei<eh;++ei){let eu=new Uint32Array(80);for(let eo=0;eo<16;++eo)eu[eo]=ef[ei][eo];for(let ei=16;ei<80;++ei)eu[ei]=ec(eu[ei-3]^eu[ei-8]^eu[ei-14]^eu[ei-16],1);let eh=ed[0],ep=ed[1],eg=ed[2],em=ed[3],ey=ed[4];for(let ei=0;ei<80;++ei){let ed=Math.floor(ei/20),ef=ec(eh,5)+ea(ed,ep,eg,em)+ey+eo[ed]+eu[ei]>>>0;ey=em,em=eg,eg=ec(ep,30)>>>0,ep=eh,eh=ef}ed[0]=ed[0]+eh>>>0,ed[1]=ed[1]+ep>>>0,ed[2]=ed[2]+eg>>>0,ed[3]=ed[3]+em>>>0,ed[4]=ed[4]+ey>>>0}return[ed[0]>>24&255,ed[0]>>16&255,ed[0]>>8&255,255&ed[0],ed[1]>>24&255,ed[1]>>16&255,ed[1]>>8&255,255&ed[1],ed[2]>>24&255,ed[2]>>16&255,ed[2]>>8&255,255&ed[2],ed[3]>>24&255,ed[3]>>16&255,ed[3]>>8&255,255&ed[3],ed[4]>>24&255,ed[4]>>16&255,ed[4]>>8&255,255&ed[4]]};eo.default=ed},4008:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0,eo.unsafeStringify=eh;var ec=ed(ea(6435));function ed(ei){return ei&&ei.__esModule?ei:{default:ei}}let eu=[];for(let ei=0;ei<256;++ei)eu.push((ei+256).toString(16).slice(1));function eh(ei,eo=0){return(eu[ei[eo+0]]+eu[ei[eo+1]]+eu[ei[eo+2]]+eu[ei[eo+3]]+"-"+eu[ei[eo+4]]+eu[ei[eo+5]]+"-"+eu[ei[eo+6]]+eu[ei[eo+7]]+"-"+eu[ei[eo+8]]+eu[ei[eo+9]]+"-"+eu[ei[eo+10]]+eu[ei[eo+11]]+eu[ei[eo+12]]+eu[ei[eo+13]]+eu[ei[eo+14]]+eu[ei[eo+15]]).toLowerCase()}var ef=function(ei,eo=0){let ea=eh(ei,eo);if(!(0,ec.default)(ea))throw TypeError("Stringified UUID is invalid");return ea};eo.default=ef},3990:function(ei,eo,ea){"use strict";let ec,ed;Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var eu=ef(ea(3319)),eh=ea(4008);function ef(ei){return ei&&ei.__esModule?ei:{default:ei}}let ep=0,eg=0;var em=function(ei,eo,ea){let ef=eo&&ea||0,em=eo||Array(16),ey=(ei=ei||{}).node||ec,eb=void 0!==ei.clockseq?ei.clockseq:ed;if(null==ey||null==eb){let eo=ei.random||(ei.rng||eu.default)();null==ey&&(ey=ec=[1|eo[0],eo[1],eo[2],eo[3],eo[4],eo[5]]),null==eb&&(eb=ed=(eo[6]<<8|eo[7])&16383)}let eS=void 0!==ei.msecs?ei.msecs:Date.now(),eE=void 0!==ei.nsecs?ei.nsecs:eg+1,ew=eS-ep+(eE-eg)/1e4;if(ew<0&&void 0===ei.clockseq&&(eb=eb+1&16383),(ew<0||eS>ep)&&void 0===ei.nsecs&&(eE=0),eE>=1e4)throw Error("uuid.v1(): Can't create more than 10M uuids/sec");ep=eS,eg=eE,ed=eb,eS+=122192928e5;let e_=((268435455&eS)*1e4+eE)%4294967296;em[ef++]=e_>>>24&255,em[ef++]=e_>>>16&255,em[ef++]=e_>>>8&255,em[ef++]=255&e_;let eT=eS/4294967296*1e4&268435455;em[ef++]=eT>>>8&255,em[ef++]=255&eT,em[ef++]=eT>>>24&15|16,em[ef++]=eT>>>16&255,em[ef++]=eb>>>8|128,em[ef++]=255&eb;for(let ei=0;ei<6;++ei)em[ef+ei]=ey[ei];return eo||(0,eh.unsafeStringify)(em)};eo.default=em},8237:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ec=eu(ea(7925)),ed=eu(ea(4163));function eu(ei){return ei&&ei.__esModule?ei:{default:ei}}let eh=(0,ec.default)("v3",48,ed.default);var ef=eh;eo.default=ef},7925:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.URL=eo.DNS=void 0,eo.default=eg;var ec=ea(4008),ed=eu(ea(8222));function eu(ei){return ei&&ei.__esModule?ei:{default:ei}}function eh(ei){ei=unescape(encodeURIComponent(ei));let eo=[];for(let ea=0;ea<ei.length;++ea)eo.push(ei.charCodeAt(ea));return eo}let ef="6ba7b810-9dad-11d1-80b4-00c04fd430c8";eo.DNS=ef;let ep="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function eg(ei,eo,ea){function eu(ei,eu,ef,ep){var eg;if("string"==typeof ei&&(ei=eh(ei)),"string"==typeof eu&&(eu=(0,ed.default)(eu)),(null===(eg=eu)||void 0===eg?void 0:eg.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let em=new Uint8Array(16+ei.length);if(em.set(eu),em.set(ei,eu.length),(em=ea(em))[6]=15&em[6]|eo,em[8]=63&em[8]|128,ef){ep=ep||0;for(let ei=0;ei<16;++ei)ef[ep+ei]=em[ei];return ef}return(0,ec.unsafeStringify)(em)}try{eu.name=ei}catch(ei){}return eu.DNS=ef,eu.URL=ep,eu}eo.URL=ep},5355:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ec=eh(ea(4790)),ed=eh(ea(3319)),eu=ea(4008);function eh(ei){return ei&&ei.__esModule?ei:{default:ei}}var ef=function(ei,eo,ea){if(ec.default.randomUUID&&!eo&&!ei)return ec.default.randomUUID();ei=ei||{};let eh=ei.random||(ei.rng||ed.default)();if(eh[6]=15&eh[6]|64,eh[8]=63&eh[8]|128,eo){ea=ea||0;for(let ei=0;ei<16;++ei)eo[ea+ei]=eh[ei];return eo}return(0,eu.unsafeStringify)(eh)};eo.default=ef},3764:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ec=eu(ea(7925)),ed=eu(ea(3757));function eu(ei){return ei&&ei.__esModule?ei:{default:ei}}let eh=(0,ec.default)("v5",80,ed.default);var ef=eh;eo.default=ef},6435:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ec=ed(ea(58));function ed(ei){return ei&&ei.__esModule?ei:{default:ei}}var eu=function(ei){return"string"==typeof ei&&ec.default.test(ei)};eo.default=eu},8464:function(ei,eo,ea){"use strict";Object.defineProperty(eo,"__esModule",{value:!0}),eo.default=void 0;var ec=ed(ea(6435));function ed(ei){return ei&&ei.__esModule?ei:{default:ei}}var eu=function(ei){if(!(0,ec.default)(ei))throw TypeError("Invalid UUID");return parseInt(ei.slice(14,15),16)};eo.default=eu},8416:function(ei,eo,ea){var ec=ea(4062);function ed(ei,eo,ea){return(eo=ec(eo))in ei?Object.defineProperty(ei,eo,{value:ea,enumerable:!0,configurable:!0,writable:!0}):ei[eo]=ea,ei}ei.exports=ed,ei.exports.__esModule=!0,ei.exports.default=ei.exports},4836:function(ei){function eo(ei){return ei&&ei.__esModule?ei:{default:ei}}ei.exports=eo,ei.exports.__esModule=!0,ei.exports.default=ei.exports},215:function(ei,eo,ea){var ec=ea(7071);function ed(ei,eo){if(null==ei)return{};var ea,ed,eu=ec(ei,eo);if(Object.getOwnPropertySymbols){var eh=Object.getOwnPropertySymbols(ei);for(ed=0;ed<eh.length;ed++)ea=eh[ed],!(eo.indexOf(ea)>=0)&&Object.prototype.propertyIsEnumerable.call(ei,ea)&&(eu[ea]=ei[ea])}return eu}ei.exports=ed,ei.exports.__esModule=!0,ei.exports.default=ei.exports},7071:function(ei){function eo(ei,eo){if(null==ei)return{};var ea,ec,ed={},eu=Object.keys(ei);for(ec=0;ec<eu.length;ec++)ea=eu[ec],eo.indexOf(ea)>=0||(ed[ea]=ei[ea]);return ed}ei.exports=eo,ei.exports.__esModule=!0,ei.exports.default=ei.exports},7946:function(ei,eo,ea){var ec=ea(8698).default;function ed(ei,eo){if("object"!==ec(ei)||null===ei)return ei;var ea=ei[Symbol.toPrimitive];if(void 0!==ea){var ed=ea.call(ei,eo||"default");if("object"!==ec(ed))return ed;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===eo?String:Number)(ei)}ei.exports=ed,ei.exports.__esModule=!0,ei.exports.default=ei.exports},4062:function(ei,eo,ea){var ec=ea(8698).default,ed=ea(7946);function eu(ei){var eo=ed(ei,"string");return"symbol"===ec(eo)?eo:String(eo)}ei.exports=eu,ei.exports.__esModule=!0,ei.exports.default=ei.exports},8698:function(ei){function eo(ea){return ei.exports=eo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ei){return typeof ei}:function(ei){return ei&&"function"==typeof Symbol&&ei.constructor===Symbol&&ei!==Symbol.prototype?"symbol":typeof ei},ei.exports.__esModule=!0,ei.exports.default=ei.exports,eo(ea)}ei.exports=eo,ei.exports.__esModule=!0,ei.exports.default=ei.exports},9743:function(ei,eo,ea){"use strict";let ec,ed;ea.d(eo,{ms:function(){return tk},wI:function(){return tA}});var eu={};function eh(){return(eh=Object.assign||function(ei){for(var eo=1;eo<arguments.length;eo++){var ea=arguments[eo];for(var ec in ea)Object.prototype.hasOwnProperty.call(ea,ec)&&(ei[ec]=ea[ec])}return ei}).apply(this,arguments)}function ef(ei,eo){ei.prototype=Object.create(eo.prototype),ei.prototype.constructor=ei,ep(ei,eo)}function ep(ei,eo){return(ep=Object.setPrototypeOf||function(ei,eo){return ei.__proto__=eo,ei})(ei,eo)}function eg(ei){if(void 0===ei)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return ei}ea.r(eu),ea.d(eu,{$reactive:function(){return eU},$reactiveproxy:function(){return eB},$skipreactive:function(){return eN},Atom:function(){return eJ},Observer:function(){return eS},Reaction:function(){return ew},autorun:function(){return ez},autorunAsync:function(){return eY},createAtom:function(){return eQ},hasRunningReaction:function(){return e_},isActionRunning:function(){return ey},isReactive:function(){return eF},isTrackingDisabled:function(){return eO},markRaw:function(){return eK},reaction:function(){return eI},reactive:function(){return eV},runInAction:function(){return eb},runningReaction:function(){return eT},untracked:function(){return eR},untrackedCB:function(){return ek}});var em=0;function ey(){return em>0}function eb(ei){em++;try{return ei()}finally{0==--em&&eP()}}var eS=function(){function ei(ei){this.trigger=ei,this.observing=new Map}var eo=ei.prototype;return eo.registerConnection=function(ei){var eo=this.observing.get(ei.observable);eo||(eo={byKey:new Set,iterate:!1},this.observing.set(ei.observable,eo)),"iterate"===ei.type?eo.iterate=!0:eo.byKey.add(ei.key)},eo.removeObservers=function(){var ei=this;this.observing.forEach(function(eo,ea){eo.iterate&&ea[eU].connections.iterate.delete(ei),eo.byKey.forEach(function(eo){ea[eU].connections.byKey.get(eo).delete(ei)})}),this.observing.clear()},ei}(),eE=[],ew=function(ei){function eo(eo,ea,ec){var ed;if((ed=ei.call(this,function(){return ed._trigger()})||this).func=eo,ed.options=ea,ed.effect=ec,ed.isInitial=!0,ed.reaction=function(){eE.push(eg(ed));try{ed.func()}finally{eE.pop()}ed.effect&&(!ed.isInitial||ed.options.fireImmediately)&&ed.effect(),ed.isInitial=!1},!ec&&!ed.options.fireImmediately)throw Error("if no effect function passed, should always fireImmediately");return ed.reaction(),ed}return ef(eo,ei),eo.prototype._trigger=function(){if(eE.includes(this))throw Error("already running reaction");this.removeObservers(),this.reaction()},eo}(eS);function e_(){return!!eE.length}function eT(){return eE.length?eE[eE.length-1]:void 0}function eI(ei,eo,ea){var ec=eh({name:"unnamed",fireImmediately:!0},ea);return new ew(ei,ec,eo)}var eC=!1;function eO(){return eC}function eR(ei){eC=!0;try{ei()}finally{eC=!1}}function ek(ei){return function(){return eR(ei)}}var eM=[];function eP(){var ei=[].concat(eM);eM=[],eA(ei)}function eA(ei){var eo=new Set;ei.forEach(function(ei){var ea;("add"===ei.type||"delete"===ei.type)&&ei.observable[eU].connections.iterate.forEach(function(ei){eo.add(ei)}),null==(ea=ei.observable[eU].connections.byKey.get(ei.key))||ea.forEach(function(ei){eo.add(ei)})}),eo.forEach(function(ei){ei.trigger()})}function eD(ei){if(ey()){eM.push(ei);return}eA([ei])}function ej(ei,eo){if("iterate"===ei.type)ei.observable[eU].connections.iterate.add(eo);else{var ea=ei.observable[eU].connections.byKey.get(ei.key);ea||(ea=new Set,ei.observable[eU].connections.byKey.set(ei.key,ea)),ea.add(eo)}}function eL(ei,eo){if(!eO()){var ea=eT();ea&&(ej(ei,ea),ea.registerConnection(ei)),eo&&(ej(ei,eo),eo.registerConnection(ei))}}var eN=Symbol("$skipreactive"),eU=Symbol("$reactive"),eB=Symbol("$reactiveproxy");function eF(ei,eo){return!!(ei&&ei[eB]&&ei[eB].implicitObserver===eo)}function eK(ei){return ei[eN]=!0,ei}function e$(ei){return!!(ei&&!eF(ei)&&ei[eU])}function eW(ei,eo,ea){if(void 0===ea&&(ea=!1),ei[eN]||eF(ei,eo))return ei;var ec=eG(ei,ea);if(!eo)return ec;var ed=ec[eU].proxiesWithImplicitObserver.get(eo);if(!ed){var eu={implicitObserver:eo};Object.setPrototypeOf(eu,eH),ed=new Proxy(ec[eU].raw,eu),ec[eU].proxiesWithImplicitObserver.set(eo,ed)}return ed}var eV=eW;function eG(ei,eo){if(void 0===eo&&(eo=!1),eF(ei))return ei;if(e$(ei))return ei[eU].proxy;if(ei[eU]||ei[eB])throw Error("unexpected");var ea={connections:{iterate:new Set,byKey:new Map},proxy:{},raw:ei,proxiesWithImplicitObserver:new Map,shallow:eo};Object.defineProperty(ei,eU,{enumerable:!1,writable:!0,configurable:!0,value:ea});var ec=new Proxy(ei,eH);return ea.proxy=ec,ec}var eH={has:function(ei,eo){var ea=Reflect.has(ei,eo);return"symbol"==typeof eo||eL({observable:ei,key:eo,type:"has"},this.implicitObserver),ea},get:function(ei,eo,ea){if(eo===eB)return{implicitObserver:this.implicitObserver};var ec=Reflect.get(ei,eo,ea);if("symbol"==typeof eo)return ec;if("length"===eo&&Array.isArray(ei)?eL({observable:ei,type:"iterate"},this.implicitObserver):eL({observable:ei,key:eo,type:"get"},this.implicitObserver),e$(ec))return eW(ec,this.implicitObserver);if(ei[eU].shallow)return ec;if("object"==typeof ec&&null!==ec&&!eF(ec,this.implicitObserver)&&!Object.isFrozen(ec)){var ed=Reflect.getOwnPropertyDescriptor(ei,eo);if((!ed||!(!1===ed.writable&&!1===ed.configurable))&&(e_()||this.implicitObserver))return eW(ec,this.implicitObserver)}return ec},ownKeys:function(ei){return eL({observable:ei,type:"iterate"},this.implicitObserver),Reflect.ownKeys(ei)},set:function(ei,eo,ea,ec){return eb(function(){if("symbol"==typeof eo)return Reflect.set(ei,eo,ea,ec);var ed=Object.hasOwnProperty.call(ei,eo),eu=Reflect.get(ei,eo,ec),eh=Reflect.set(ei,eo,ea,ec);if(ed){if(ea!==eu){if("length"===eo&&Array.isArray(ei)){if(eu<ea);else for(var ef=ea+1;ef<=eu;ef++)eD({observable:ei,key:""+(ef-1),oldValue:void 0,type:"delete"})}else eD({observable:ei,key:eo,value:ea,oldValue:eu,type:"update"})}}else eD({observable:ei,key:eo,value:ea,type:"add"});return eh})},deleteProperty:function(ei,eo){return eb(function(){if("symbol"==typeof eo)return Reflect.deleteProperty(ei,eo);var ea=Object.hasOwnProperty.call(ei,eo),ec=Reflect.get(ei,eo),ed=Reflect.deleteProperty(ei,eo);return ea&&eD({observable:ei,key:eo,oldValue:ec,type:"delete"}),ed})},preventExtensions:function(ei){throw Error("Dynamic observable objects cannot be frozen")}};function ez(ei,eo){var ea=eh({name:"unnamed",fireImmediately:!0},eo);return new ew(ei,ea)}function eY(ei,eo,ea){var ec=eh({name:"unnamed",fireImmediately:!0},ea),ed=new ew(function(){ei(eo)},ec);return(eo=eV(eo,ed)).bla=4,ec.fireImmediately&&ed.trigger(),ed}var eJ=function(){function ei(){this._observable=eV({_key:1})}var eo=ei.prototype;return eo.reportObserved=function(ei){return eV(this._observable,ei)._key},eo.reportChanged=function(){this._observable._key++},ei}();function eQ(ei,eo,ea){return new eJ}var eX=ea(9527);let eZ=ei=>ei();function e0(ei,eo){if(ed)return ed(ei,eo);eZ(ei)}function e1(ei,eo,ea){if(ec)return ec.apply(null,arguments);throw Error("observable implementation not provided. Call enableReactiveBindings, enableVueBindings or enableMobxBindings.")}function e2(ei){ec=function(eo,ea,ec){let ed=ei.createAtom(eo);return ea&&ea(),ed},ed=(eo,ea)=>ei.reaction(eo,ea,{fireImmediately:!1})}let e3=new WeakSet;function e6(ei){let eo;if(e3.has(ei))return ei;e3.add(ei);let ea=new Map;function ec(){if(!eo){let ea=ei=>{(ei.changes.added.size||ei.changes.deleted.size||ei.changes.keys.size||ei.changes.delta.length)&&eo.reportChanged()};eo=e1("map",()=>{ei.observe(ea)},()=>{ei.unobserve(ea)})}eo.reportObserved(ei._implicitObserver)}function ed(eo){let ec=ea.get(eo);if(!ec){let ed=ei=>{ec.reportChanged()};ec=e1(eo+"",()=>{ei.observe(ed)},()=>{ei.unobserve(ed)}),ea.set(eo,ec)}ec.reportObserved(ei._implicitObserver)}let eu=ei.get;function eh(eo){let ea=ei[eo];ei[eo]=function(){ec();let ei=Reflect.apply(ea,this,arguments);return ei}}function ef(eo){let ea=ei,ed=Object.getOwnPropertyDescriptor(ea,eo);if(ed||(ed=Object.getOwnPropertyDescriptor(ea=Object.getPrototypeOf(ea),eo)),ed||(ed=Object.getOwnPropertyDescriptor(ea=Object.getPrototypeOf(ea),eo)),!ed)throw Error("property not found");let eu=ed.get;ed.get=function(){this._disableTracking||ec();let ei=Reflect.apply(eu,this,arguments);return ei},Object.defineProperty(ei,eo,ed)}function ep(eo,ea){let ec=ei,ed=Object.getOwnPropertyDescriptor(ec,eo);if(ed||(ed=Object.getOwnPropertyDescriptor(ec=Object.getPrototypeOf(ec),eo)),ed||(ed=Object.getOwnPropertyDescriptor(ec=Object.getPrototypeOf(ec),eo)),!ed)throw Error("property not found");Object.defineProperty(ei,ea,ed)}ei.get=function(ei){if("number"!=typeof ei)throw Error("unexpected");ed(ei);let eo=Reflect.apply(eu,this,arguments);return eo},eh("forEach"),eh("toJSON"),eh("toArray"),eh("slice"),eh("map"),ep("length","lengthUntracked"),ef("length");let eg=ei.push;ei.push=function(ei){this._disableTracking=!0;let eo=eg.call(this,ei);return this._disableTracking=!1,eo};let em=ei.slice;return ei.slice=function(ei,eo){this._disableTracking=!0;let ea=em.call(this,ei,eo);return this._disableTracking=!1,ea},ei}let e4=new WeakSet;function e5(ei){let eo;if(e4.has(ei))return ei;function ea(){if(!eo){let ea=Array.from(ei.share.keys()),ec=ec=>{let ed=Array.from(ei.share.keys());JSON.stringify(ea)!==JSON.stringify(ed)&&(ea=ed,eo.reportChanged())};eo=e1("map",()=>{ei.on("beforeObserverCalls",ec)},()=>{ei.off("beforeObserverCalls",ec)})}eo.reportObserved(ei._implicitObserver)}e4.add(ei);let ec=ei.get;return ei.get=function(ei){if("string"!=typeof ei)throw Error("unexpected");let eo=Reflect.apply(ec,this,arguments);return td(eo),eo},function(ec){let ed;let eu=ei[ec];ei[ec]=function(){let ec;let eh=arguments;return ea(),ed&&ed.removeObservers(),ed=e0(()=>ec=Reflect.apply(eu,ei,eh),()=>eo.reportChanged()),ec}}("toJSON"),Object.defineProperty(ei,"keys",{get:()=>(ea(),Object.keys(ei.share))}),ei}let e8=new WeakSet;function e7(ei){let eo;if(e8.has(ei))return ei;e8.add(ei);let ea=new Map;function ec(){if(!eo){let ea=ei=>{(ei.changes.added.size||ei.changes.deleted.size||ei.changes.keys.size||ei.changes.delta.length)&&eo.reportChanged()};eo=e1("map",()=>{ei.observe(ea)},()=>{ei.unobserve(ea)})}eo.reportObserved(ei._implicitObserver)}function ed(eo){let ec=ea.get(eo);if(!ec){let ed=ei=>{ei.keysChanged.has(eo)&&(ei.changes.added.size||ei.changes.deleted.size||ei.changes.keys.size||ei.changes.delta.length)&&ec.reportChanged()};ec=e1(eo,()=>{ei.observe(ed)},()=>{ei.unobserve(ed)}),ea.set(eo,ec)}ec.reportObserved(ei._implicitObserver)}let eu=ei.get;function eh(eo){let ea=ei[eo];ei[eo]=function(){ec();let ei=Reflect.apply(ea,this,arguments);return ei}}return ei.get=function(ei){if("string"!=typeof ei)throw Error("unexpected");ed(ei);let eo=Reflect.apply(eu,this,arguments);return eo},eh("values"),eh("entries"),eh("keys"),eh("forEach"),eh("toJSON"),ei}let e9=new WeakSet;function ti(ei){let eo;if(e9.has(ei))return ei;e9.add(ei);let ea=ei=>{eo.reportChanged()};function ec(ea){let ec=ei[ea];ei[ea]=function(){eo.reportObserved(this._implicitObserver);let ei=Reflect.apply(ec,this,arguments);return ei}}return eo=e1("text",()=>{ei.observe(ea)},()=>{ei.unobserve(ea)}),ec("toString"),ec("toJSON"),ei}let ta=new WeakSet;function tc(ei){let eo;if(ta.has(ei))return ei;ta.add(ei);let ea=ei=>{(ei.changes.added.size||ei.changes.deleted.size||ei.changes.keys.size||ei.changes.delta.length)&&eo.reportChanged()};function ec(ea){let ec=ei[ea];ei[ea]=function(){eo.reportObserved(this._implicitObserver);let ei=Reflect.apply(ec,this,arguments);return ei}}function ed(ea){let ec=ei,ed=Object.getOwnPropertyDescriptor(ec,ea);if(ed||(ed=Object.getOwnPropertyDescriptor(ec=Object.getPrototypeOf(ec),ea)),ed||(ed=Object.getOwnPropertyDescriptor(ec=Object.getPrototypeOf(ec),ea)),!ed)throw Error("property not found");let eu=ed.get;ed.get=function(){eo.reportObserved(this._implicitObserver);let ei=Reflect.apply(eu,this,arguments);return ei},Object.defineProperty(ei,ea,ed)}return eo=e1("xml",()=>{ei.observe(ea)},()=>{ei.unobserve(ea)}),ec("toString"),ec("toDOM"),ec("toArray"),ec("getAttribute"),ed("firstChild"),ei}function td(ei){if(ei instanceof eX.eI||ei instanceof eX.xv)return ti(ei);if(ei instanceof eX.mJ)return e6(ei);if(ei instanceof eX.D5)return e7(ei);if(ei instanceof eX.QW||Object.prototype.hasOwnProperty.call(ei,"autoLoad"))return e5(ei);if(ei instanceof eX.sI)return tc(ei);if(ei instanceof eX.lt)return tc(ei);return ei}function tu(ei){ei.share.forEach(ei=>{ei.constructor!==eX.QP&&td(ei)})}function th(ei,eo){for(let ec=ei.length-1;ec>=eo;ec--){let eo=ei[ec];if(!eo.deleted){var ea;if(eo instanceof eX.GC)continue;null==(ea=eo.content)||ea.getContent().forEach(ei=>{ei instanceof eX.QP&&td(ei)})}}}let tf=new WeakSet;function tp(ei){tf.has(ei)||(tf.add(ei),td(ei),ei.store.clients.forEach(ei=>{ei&&th(ei,0)}),tu(ei),ei.on("beforeObserverCalls",eo=>{tu(ei),eo.afterState.forEach((ei,ea)=>{let ec=eo.beforeState.get(ea)||0;if(ec!==ei){let ei=eo.doc.store.clients.get(ea);if(!ei)return;let ed=eX.g4(ei,ec);th(ei,ed)}})}))}class tg{constructor(ei){this.value=void 0,this.value=ei}}function tv(ei){return ArrayBuffer.isView(ei)?new tg(ei):new tg(Object.freeze(ei))}function tm(ei){let eo=function(){var eo;let ea=null==(eo=this[eB])?void 0:eo.implicitObserver;ei._implicitObserver=ea;let ec=ei.slice.bind(ei).apply(ei,arguments);return ec.map(ei=>{let eo=t_(ei,ea);return ea&&"object"==typeof eo?eV(eo,ea):eo})},ea=function(ei){return ei.map(ei=>{let eo=tT(ei),ea=tM(eo)||eo;if(ea instanceof tg&&(ea=ea.value),ea instanceof eX.QP&&ea.parent)throw Error("Not supported: reassigning object that already occurs in the tree.");return ea})},ec=function(){return[].findIndex.apply(eo.apply(this),arguments)},ed={slice:eo,unshift:(...eo)=>(ei.unshift(ea(eo)),ei.lengthUntracked),push:(...eo)=>(ei.push(ea(eo)),ei.lengthUntracked),insert:ei.insert.bind(ei),toJSON:ei.toJSON.bind(ei),forEach:function(){return[].forEach.apply(eo.apply(this),arguments)},every:function(){return[].every.apply(eo.apply(this),arguments)},filter:function(){return[].filter.apply(eo.apply(this),arguments)},find:function(){return[].find.apply(eo.apply(this),arguments)},findIndex:ec,some:function(){return[].some.apply(eo.apply(this),arguments)},includes:function(){return[].includes.apply(eo.apply(this),arguments)},map:function(){return[].map.apply(eo.apply(this),arguments)},indexOf:function(){let ei=arguments[0];return ec.call(this,eo=>tP(eo,ei))},splice:function(){let ec=arguments[0]<0?ei.length-Math.abs(arguments[0]):arguments[0],ed=arguments[1],eu=Array.from(Array.from(arguments).slice(2)),eh=eo.apply(this,[ec,Number.isInteger(ed)?ec+ed:void 0]);return ei.doc?ei.doc.transact(()=>{ei.delete(ec,ed),ei.insert(ec,ea(eu))}):(ei.delete(ec,ed),ei.insert(ec,ea(eu))),eh}},eu=[];for(let ei in ed)eu[ei]=ed[ei];return eu}function ty(ei){if("string"==typeof ei&&ei.trim().length){let eo=Number(ei);if(Number.isInteger(eo))return eo}return ei}function tb(ei,eo=new eX.mJ){if(eo[eU])throw Error("unexpected");let ea=tm(eo),ec=new Proxy(ea,{set:(ei,eo,ea)=>{let ec=ty(eo);if("number"!=typeof ec)throw Error();throw Error("array assignment is not implemented / supported")},get:(ei,ea,ec)=>{let ed=ty(ea);if(ed===tR)return eo;if("number"==typeof ed){let ei;if(ec&&ec[eB]){var eu;ei=null==(eu=ec[eB])?void 0:eu.implicitObserver,eo._implicitObserver=ei}return t_(eo.get(ed),ei)}if(ed===Symbol.toStringTag)return"Array";if(ed===Symbol.iterator){let ei=eo.slice();return Reflect.get(ei,ed)}if("length"===ed)return eo.length;let eh=Reflect.get(ei,ed,ec);return eh},deleteProperty:(ei,ea)=>{let ec=ty(ea);if("number"!=typeof ec)throw Error();return ec<eo.lengthUntracked&&ec>=0&&(eo.delete(ec),!0)},has:(ei,ea)=>{let ec=ty(ea);return"number"!=typeof ec?Reflect.has(ei,ec):ec<eo.lengthUntracked&&ec>=0},getOwnPropertyDescriptor(ei,ea){let ec=ty(ea);return"length"===ec?{enumerable:!1,configurable:!1,writable:!0}:"number"==typeof ec&&ec>=0&&ec<eo.lengthUntracked?{enumerable:!0,configurable:!0,writable:!0}:void 0},ownKeys:ei=>{let ea=[];for(let ei=0;ei<eo.length;ei++)ea.push(ei+"");return ea.push("length"),ea}});return ea.push.apply(ec,ei),ec}function tS(ei,eo=new eX.D5){if(eo[eU])throw Error("unexpected");let ea=new Proxy({},{set:(ei,ea,ec)=>{if("string"!=typeof ea)throw Error();let ed=tT(ec),eu=tM(ed)||ed;if(eu instanceof tg&&(eu=eu.value),eu instanceof eX.QP&&eu.parent)throw Error("Not supported: reassigning object that already occurs in the tree.");return eo.set(ea,eu),!0},get:(ei,ea,ec)=>{let ed;if(ea===tR)return eo;if("string"!=typeof ea)return Reflect.get(ei,ea);if(ec&&ec[eB]){var eu;ed=null==(eu=ec[eB])?void 0:eu.implicitObserver,eo._implicitObserver=ed}return t_(eo.get(ea),ed)},deleteProperty:(ei,ea)=>{if("string"!=typeof ea)throw Error();return!!eo.has(ea)&&(eo.delete(ea),!0)},has:(ei,ea)=>!!("string"==typeof ea&&eo.has(ea)),getOwnPropertyDescriptor(ei,ea){if("string"==typeof ea&&eo.has(ea))return{enumerable:!0,configurable:!0}},ownKeys:ei=>Array.from(eo.keys())});for(let ec in tw.set(eo,ea),ei)ea[ec]=ei[ec];return ea}function tE(ei){return ei instanceof eX.QP}let tw=new WeakMap;function t_(ei,eo){if(tE(ei)){if(ei._implicitObserver=eo,ei instanceof eX.mJ||ei instanceof eX.D5){if(!tw.has(ei)){let eo=tT(ei);tw.set(ei,eo)}ei=tw.get(ei)}else if(ei instanceof eX.lt||ei instanceof eX.sI||ei instanceof eX.eI||ei instanceof eX.yP||ei instanceof eX.xv)eK(ei),ei.__v_skip=!0;else throw Error("unknown YType")}else if(null===ei)return null;else if("object"==typeof ei)return tv(ei);return ei}function tT(ei){if(null==ei)return ei;if((ei=tM(ei)||ei)instanceof eX.mJ)return tb([],ei);if(ei instanceof eX.D5)return tS({},ei);if("string"==typeof ei)return ei;if(Array.isArray(ei))return tb(ei);if(ei instanceof eX.lt||ei instanceof eX.sI||ei instanceof eX.eI||ei instanceof eX.yP)return ei;if(ei instanceof eX.xv)return ei;if("object"==typeof ei)return ei instanceof tg?ei:tS(ei);else if("number"==typeof ei||"boolean"==typeof ei)return ei;else throw Error("invalid")}function tI(ei){for(let[eo,ea]of Object.entries(ei))if(Array.isArray(ea)){if(0!==ea.length)throw Error("Root Array initializer must always be empty array")}else if(ea&&"object"==typeof ea){if(0!==Object.keys(ea).length||Object.getPrototypeOf(ea)!==Object.prototype)throw Error("Root Object initializer must always be {}")}else if("xml"!==ea&&"text"!==ea)throw Error("unknown Root initializer")}function tC(ei,eo,ea){let ec=eo[ea];if(!ec){"__v_raw"!==ea&&"__v_isRef"!==ea&&"__v_isReadonly"!==ea&&console.warn("property not found on root doc",ea);return}return"xml"===ec?ei.getXmlFragment(ea):"text"===ec?ei.getText(ea):Array.isArray(ec)?ei.getArray(ea):ei.getMap(ea)}function tO(ei,eo){if(ei[eU])throw Error("unexpected");tI(eo);let ea=new Proxy({},{set:(ei,eo,ea)=>{if("string"!=typeof eo)throw Error();throw Error("cannot set new elements on root doc")},get:(ea,ec,ed)=>{let eu;if(ec===tR)return ei;if("string"!=typeof ec)return Reflect.get(ea,ec);if(ed&&ed[eB]){var eh;eu=null==(eh=ed[eB])?void 0:eh.implicitObserver,ei._implicitObserver=eu}if("toJSON"===ec){for(let ea of Object.keys(eo))tC(ei,eo,ea);let ea=Reflect.get(ei,ec);return ea}return t_(tC(ei,eo,ec),eu)},deleteProperty:(ei,eo)=>{throw Error("deleteProperty not available for doc")},has:(eo,ea)=>!!("string"==typeof ea&&ei.share.has(ea)),getOwnPropertyDescriptor(eo,ea){if("string"==typeof ea&&ei.share.has(ea)||"toJSON"===ea)return{enumerable:!0,configurable:!0}},ownKeys:eo=>Array.from(ei.share.keys())});return tw.set(ei,ea),ea}e2(eu);let tR=Symbol("INTERNAL_SYMBOL");function tk(ei){let eo=tM(ei);if(!(eo instanceof eX.QW))throw Error("store is not a valid syncedStore that maps to a Y.Doc");return eo}function tM(ei){if("object"!=typeof ei||null===ei)return;let eo=ei[tR];return eo&&(eK(eo),eo.__v_skip=!0),eo}function tP(ei,eo){if(ei===eo)return!0;if("object"==typeof ei&&"object"==typeof eo){let ea=tM(ei),ec=tM(eo);return!!ea&&!!ec&&ea===ec}return!1}function tA(ei,eo=new eX.QW){return tp(eo),tO(eo,ei)}},9153:function(ei,eo,ea){"use strict";let ec;ea.d(eo,{XM:function(){return i6}});var ed=ea(3447),eu=ea(9527),eh=ea(9141),ef=ea(8743),ep=ea(8853),eg=ea(6486),em=ea(8764).Buffer,ey=ea(3454),eb=Object.defineProperty,eS=(ei,eo,ea)=>eo in ei?eb(ei,eo,{enumerable:!0,configurable:!0,writable:!0,value:ea}):ei[eo]=ea,eE=(ei,eo,ea)=>(eS(ei,"symbol"!=typeof eo?eo+"":eo,ea),ea);async function ew(ei,eo,ea,ec,ed){let eu="ed25519:"+ec,ef=((eo.signatures||{})[ea]||{})[eu];if(!ef)throw Error("No signature");let ep=Object.assign({},eo);delete ep.unsigned,delete ep.signatures;let eg=eh.stringify(ep);ei.verifySignature(ed,eg,ef)}function e_(ei){return em.from(ei).toString("base64")}function eT(ei){return em.from(ei,"base64")}async function eI(ei,eo){if(!ei.crypto)throw Error("MatrixClient.crypto is not initialized");await ei.crypto.signObject(eo)}async function eC(ei,eo,ea,ec){var ed,eu;if(!ea.signatures||1!==Object.keys(ea.signatures).length)throw Error("invalid signature");let eh=Object.keys(ea.signatures)[0];if(!eo.hasWriteAccess(eh,ec))throw Error("user doesn't have write access");let ef=Object.keys(ea.signatures[eh])[0];if(!ef.startsWith("ed25519:"))throw Error("unexpected key");let ep=ef.substr(8);if(!ei.crypto)throw Error("MatrixClient.crypto is not initialized");ei.crypto.deviceList.startTrackingDeviceList(eh);let eg=null==(eu=null==(ed=(await ei.crypto.deviceList.downloadKeys([eh],!1)).get(eh))?void 0:ed.get(ep))?void 0:eu.keys[ef];if(!eg)throw Error("key not found");await ew(ei.crypto.olmDevice,ea,eh,ep,eg)}class eO extends ed.Sx.Disposable{constructor(ei,eo){super(),eE(this,"disposed",!1),eE(this,"initialized",!1),eE(this,"initializing",!1),eE(this,"initializeOutdated",!1),eE(this,"members",new Map),eE(this,"powerLevels"),eE(this,"processEvent",ei=>{if(!("m.room.power_levels"!==ei.type&&"m.room.member"!==ei.type)){if(this.initializing){this.initializeOutdated=!0;return}if(this.initialized){if("m.room.power_levels"===ei.type){this.powerLevels=ei.content;return}if("m.room.member"===ei.type){if("join"===ei.content.membership||"invite"===ei.content.membership){let eo={displayname:ei.content.displayname,user_id:ei.state_key};this.members.set(ei.state_key,eo)}else this.members.delete(ei.state_key);return}throw Error("unexpected")}}}),this.matrixClient=ei,this.reader=eo,this._register(this.reader.onEvents(ei=>ei.events.forEach(ei=>this.processEvent(ei))))}hasWriteAccess(ei,eo="m.room.message"){if(!this.members.has(ei))return!1;let ea=this.powerLevels,ec=ea.events[eo];void 0===ec&&(ec=ea.events_default);let ed=ea.users[ei];if(void 0===ed&&(ed=ea.users_default),"number"!=typeof ed||"number"!=typeof ec)throw Error("unexpected");return ed>=ec}async initialize(){if(this.initializing||this.initialized)throw Error("already initializing / initialized");if(!this.reader.isStarted)throw Error("MatrixReader must have started before initializing MatrixMemberReader");this.initializing=!0;let[ei,eo]=await Promise.all([this.matrixClient.getStateEvent(this.reader.roomId,"m.room.power_levels",void 0),this.matrixClient.members(this.reader.roomId,void 0,["knock","leave","ban"])]);if(this.initializeOutdated)return this.initializing=!1,this.initializeOutdated=!1,this.initialize();this.powerLevels=ei,eo.chunk.filter(ei=>"m.room.member"===ei.type&&("join"===ei.content.membership||"invite"===ei.content.membership)).forEach(ei=>{this.members.set(ei.state_key,{displayname:ei.content.displayname,user_id:ei.state_key})}),this.initializing=!1,this.initialized=!0}dispose(){this.disposed=!0,super.dispose()}}let eR=3e4,ek=3e4,eM={snapshotInterval:30};class eP extends ed.Sx.Disposable{constructor(ei,eo,ea,ec={}){super(),eE(this,"latestToken"),eE(this,"disposed",!1),eE(this,"polling",!1),eE(this,"pendingPollRequest"),eE(this,"pollRetryTimeout"),eE(this,"messagesSinceSnapshot",0),eE(this,"_onEvents",this._register(new ed.B.Emitter)),eE(this,"onEvents",this._onEvents.event),eE(this,"opts"),eE(this,"matrixRoomListener",(ei,eo,ea)=>{throw console.error("not expected; Room.timeline on MatrixClient"),Error("unexpected, we don't use /sync calls for MatrixReader, startClient should not be used on the Matrix client")}),this.matrixClient=ei,this.roomId=eo,this.translator=ea,this.opts={...eM,...ec},this.matrixClient.on(ef.RoomEvent.Timeline,this.matrixRoomListener)}processIncomingEventsForSnapshot(ei){let eo=!1;for(let ea of ei)if(this.translator.isUpdateEvent(ea)){if(ea.room_id!==this.roomId)throw Error("event received with invalid roomid");this.messagesSinceSnapshot++,this.messagesSinceSnapshot%this.opts.snapshotInterval==0&&ea.user_id===this.matrixClient.credentials.userId&&(eo=!0)}else this.translator.isSnapshotEvent(ea)&&(this.messagesSinceSnapshot=0,eo=!1);return eo}async decryptRawEventsIfNecessary(ei){return await Promise.all(ei.map(async ei=>"m.room.encrypted"===ei.type?await this.matrixClient.decryptEventIfNeeded(new ef.MatrixEvent(ei)):ei))}async peekPoll(){if(!this.latestToken)throw Error("polling but no pagination token");if(!this.disposed)try{this.pendingPollRequest=this.matrixClient.http.authedRequest(ef.Method.Get,"/events",{room_id:this.roomId,timeout:eR+"",from:this.latestToken},void 0,{localTimeoutMs:2*eR});let ei=await this.pendingPollRequest;if(this.pendingPollRequest=void 0,this.disposed)return;let eo=await this.decryptRawEventsIfNecessary(ei.chunk),ea=this.processIncomingEventsForSnapshot(eo);eo.length&&this._onEvents.fire({events:eo,shouldSendSnapshot:ea}),this.latestToken=ei.end,this.peekPoll()}catch(ei){console.error("peek error",ei),this.disposed||(this.pollRetryTimeout=setTimeout(()=>this.peekPoll(),ek))}}async getInitialDocumentUpdateEvents(ei){let eo=[],ea="",ec=!0,ed;for(;ec;){let eu=await this.matrixClient.createMessagesRequest(this.roomId,ea,30,ef.Direction.Backward),eh=await this.decryptRawEventsIfNecessary(eu.chunk);for(let ea of eh)if(ei)ea.type===ei&&eo.push(ea);else if(this.translator.isSnapshotEvent(ea))eo.push(ea),ed=ea.content.last_event_id;else if(this.translator.isUpdateEvent(ea)){if(ed&&ed===ea.event_id)return this.latestToken||(this.latestToken=eu.start),eo.reverse();this.messagesSinceSnapshot++,eo.push(ea)}ea=void 0!==eu.end?eu.end:"",this.latestToken||(this.latestToken=eu.start),ec=!!(eu.start!==eu.end&&eu.end)}return eo.reverse()}startPolling(){if(this.polling)throw Error("already polling");this.polling=!0,this.peekPoll()}get isStarted(){return this.polling}dispose(){this.disposed=!0,super.dispose(),this.pollRetryTimeout&&clearTimeout(this.pollRetryTimeout),this.pendingPollRequest&&this.pendingPollRequest.abort(),this.matrixClient.off(ef.RoomEvent.Timeline,this.matrixRoomListener)}}let eA=()=>new Set,eD=Array.from,ej=Array.isArray,eL=String.fromCharCode,eN=ei=>ei.toLowerCase(),eU=/^\s*/g,eB=ei=>ei.replace(eU,""),eF=/([A-Z])/g,eK=(ei,eo)=>eB(ei.replace(eF,ei=>`${eo}${eN(ei)}`)),e$=ei=>{let eo=unescape(encodeURIComponent(ei)),ea=eo.length,ec=new Uint8Array(ea);for(let ei=0;ei<ea;ei++)ec[ei]=eo.codePointAt(ei);return ec},eW="u">typeof TextEncoder?new TextEncoder:null,eV=ei=>eW.encode(ei),eG=eW?eV:e$,eH=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});eH&&1===eH.decode(new Uint8Array).length&&(eH=null);let ez=()=>new Map,eY=(ei,eo,ea)=>{let ec=ei.get(eo);return void 0===ec&&ei.set(eo,ec=ea()),ec},eJ=(ei,eo)=>{let ea=[];for(let[ec,ed]of ei)ea.push(eo(ed,ec));return ea},eQ=ei=>void 0===ei?null:ei;class eX{constructor(){this.map=new Map}setItem(ei,eo){this.map.set(ei,eo)}getItem(ei){return this.map.get(ei)}}let eZ=new eX,e0=!0;try{"u">typeof localStorage&&(eZ=localStorage,e0=!1)}catch{}let e1=eZ,e2=ei=>e0||addEventListener("storage",ei),e3=ei=>e0||removeEventListener("storage",ei),e6=Object.keys,e4=ei=>e6(ei).length,e5=(ei,eo)=>Object.prototype.hasOwnProperty.call(ei,eo),e8=()=>{},e7=(ei,eo)=>ei===eo,e9=(ei,eo)=>{if(null==ei||null==eo)return e7(ei,eo);if(ei.constructor!==eo.constructor)return!1;if(ei===eo)return!0;switch(ei.constructor){case ArrayBuffer:ei=new Uint8Array(ei),eo=new Uint8Array(eo);case Uint8Array:if(ei.byteLength!==eo.byteLength)return!1;for(let ea=0;ea<ei.length;ea++)if(ei[ea]!==eo[ea])return!1;break;case Set:if(ei.size!==eo.size)return!1;for(let ea of ei)if(!eo.has(ea))return!1;break;case Map:if(ei.size!==eo.size)return!1;for(let ea of ei.keys())if(!eo.has(ea)||!e9(ei.get(ea),eo.get(ea)))return!1;break;case Object:if(e4(ei)!==e4(eo))return!1;for(let ea in ei)if(!e5(ei,ea)||!e9(ei[ea],eo[ea]))return!1;break;case Array:if(ei.length!==eo.length)return!1;for(let ea=0;ea<ei.length;ea++)if(!e9(ei[ea],eo[ea]))return!1;break;default:return!1}return!0},ti=(ei,eo)=>eo.includes(ei),ta="u">typeof ey&&ey.release&&/node|io\.js/.test(ey.release.name),tc="u">typeof window&&"u">typeof document&&!ta;"u">typeof navigator&&/Mac/.test(navigator.platform);let td=()=>{if(void 0===ec){if(ta){ec=ez();let ei=ey.argv,eo=null;for(let ea=0;ea<ei.length;ea++){let ed=ei[ea];"-"===ed[0]?(null!==eo&&ec.set(eo,""),eo=ed):null!==eo&&(ec.set(eo,ed),eo=null)}null!==eo&&ec.set(eo,"")}else"object"==typeof location?(ec=ez(),(location.search||"?").slice(1).split("&").forEach(ei=>{if(0!==ei.length){let[eo,ea]=ei.split("=");ec.set(`--${eK(eo,"-")}`,ea),ec.set(`-${eK(eo,"-")}`,ea)}})):ec=ez()}return ec},tu=ei=>td().has(ei),th=ei=>eQ(ta?ey.env[ei.toUpperCase()]:e1.getItem(ei)),tf=ei=>tu("--"+ei)||null!==th(ei);tf("production");let tp=ta&&ti(ey.env.FORCE_COLOR,["true","1","2"]),tg=!tu("no-colors")&&(!ta||ey.stdout.isTTY||tp)&&(!ta||tu("color")||tp||null!==th("COLORTERM")||(th("TERM")||"").includes("color")),tv=Math.floor,tm=Math.abs,ty=Math.log10,tb=(ei,eo)=>ei<eo?ei:eo,tS=(ei,eo)=>ei>eo?ei:eo,tE=ei=>0!==ei?ei<0:1/ei<0,tw=64,t_=128,tT=63,tI=127,tC=2147483647,tO=Number.MAX_SAFE_INTEGER,tR=Number.isInteger||(ei=>"number"==typeof ei&&isFinite(ei)&&tv(ei)===ei);class tk{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}let tM=()=>new tk,tP=ei=>{let eo=ei.cpos;for(let ea=0;ea<ei.bufs.length;ea++)eo+=ei.bufs[ea].length;return eo},tA=ei=>{let eo=new Uint8Array(tP(ei)),ea=0;for(let ec=0;ec<ei.bufs.length;ec++){let ed=ei.bufs[ec];eo.set(ed,ea),ea+=ed.length}return eo.set(t0(ei.cbuf.buffer,0,ei.cpos),ea),eo},tD=(ei,eo)=>{let ea=ei.cbuf.length;ea-ei.cpos<eo&&(ei.bufs.push(t0(ei.cbuf.buffer,0,ei.cpos)),ei.cbuf=new Uint8Array(2*tS(ea,eo)),ei.cpos=0)},tj=(ei,eo)=>{let ea=ei.cbuf.length;ei.cpos===ea&&(ei.bufs.push(ei.cbuf),ei.cbuf=new Uint8Array(2*ea),ei.cpos=0),ei.cbuf[ei.cpos++]=eo},tL=tj,tN=(ei,eo)=>{for(;eo>tI;)tj(ei,t_|tI&eo),eo=tv(eo/128);tj(ei,tI&eo)},tU=(ei,eo)=>{let ea=tE(eo);for(ea&&(eo=-eo),tj(ei,(eo>tT?t_:0)|(ea?tw:0)|tT&eo),eo=tv(eo/64);eo>0;)tj(ei,(eo>tI?t_:0)|tI&eo),eo=tv(eo/128)},tB=new Uint8Array(3e4),tF=tB.length/3,tK=(ei,eo)=>{if(eo.length<tF){let ea=eW.encodeInto(eo,tB).written||0;tN(ei,ea);for(let eo=0;eo<ea;eo++)tj(ei,tB[eo])}else tV(ei,eG(eo))},tq=(ei,eo)=>{let ea=unescape(encodeURIComponent(eo)),ec=ea.length;tN(ei,ec);for(let eo=0;eo<ec;eo++)tj(ei,ea.codePointAt(eo))},t$=eW&&eW.encodeInto?tK:tq,tW=(ei,eo)=>{let ea=ei.cbuf.length,ec=ei.cpos,ed=tb(ea-ec,eo.length),eu=eo.length-ed;ei.cbuf.set(eo.subarray(0,ed),ec),ei.cpos+=ed,eu>0&&(ei.bufs.push(ei.cbuf),ei.cbuf=new Uint8Array(tS(2*ea,eu)),ei.cbuf.set(eo.subarray(ed)),ei.cpos=eu)},tV=(ei,eo)=>{tN(ei,eo.byteLength),tW(ei,eo)},tG=(ei,eo)=>{tD(ei,eo);let ea=new DataView(ei.cbuf.buffer,ei.cpos,eo);return ei.cpos+=eo,ea},tH=(ei,eo)=>tG(ei,4).setFloat32(0,eo,!1),tz=(ei,eo)=>tG(ei,8).setFloat64(0,eo,!1),tY=(ei,eo)=>tG(ei,8).setBigInt64(0,eo,!1),tJ=new DataView(new ArrayBuffer(4)),tQ=ei=>(tJ.setFloat32(0,ei),tJ.getFloat32(0)===ei),tX=(ei,eo)=>{switch(typeof eo){case"string":tj(ei,119),t$(ei,eo);break;case"number":tR(eo)&&tm(eo)<=tC?(tj(ei,125),tU(ei,eo)):tQ(eo)?(tj(ei,124),tH(ei,eo)):(tj(ei,123),tz(ei,eo));break;case"bigint":tj(ei,122),tY(ei,eo);break;case"object":if(null===eo)tj(ei,126);else if(ej(eo)){tj(ei,117),tN(ei,eo.length);for(let ea=0;ea<eo.length;ea++)tX(ei,eo[ea])}else if(eo instanceof Uint8Array)tj(ei,116),tV(ei,eo);else{tj(ei,118);let ea=Object.keys(eo);tN(ei,ea.length);for(let ec=0;ec<ea.length;ec++){let ed=ea[ec];t$(ei,ed),tX(ei,eo[ed])}}break;case"boolean":tj(ei,eo?120:121);break;default:tj(ei,127)}},tZ=ei=>new Uint8Array(ei),t0=(ei,eo,ea)=>new Uint8Array(ei,eo,ea),t1=ei=>new Uint8Array(ei),t2=ei=>{let eo="";for(let ea=0;ea<ei.byteLength;ea++)eo+=eL(ei[ea]);return btoa(eo)},t3=ei=>em.from(ei.buffer,ei.byteOffset,ei.byteLength).toString("base64"),t6=ei=>{let eo=atob(ei),ea=tZ(eo.length);for(let ei=0;ei<eo.length;ei++)ea[ei]=eo.charCodeAt(ei);return ea},t4=ei=>{let eo=em.from(ei,"base64");return new Uint8Array(eo.buffer,eo.byteOffset,eo.byteLength)},t5=tc?t2:t3,t8=tc?t6:t4,t7=ei=>Error(ei),t9=t7("Unexpected end of array"),rr=t7("Integer out of Range");class ri{constructor(ei){this.arr=ei,this.pos=0}}let ro=ei=>new ri(ei),ra=(ei,eo)=>{let ea=t0(ei.arr.buffer,ei.pos+ei.arr.byteOffset,eo);return ei.pos+=eo,ea},rl=ei=>ra(ei,rd(ei)),rc=ei=>ei.arr[ei.pos++],rd=ei=>{let eo=0,ea=1,ec=ei.arr.length;for(;ei.pos<ec;){let ec=ei.arr[ei.pos++];if(eo+=(ec&tI)*ea,ea*=128,ec<t_)return eo;if(eo>tO)throw rr}throw t9},ru=ei=>{let eo=ei.arr[ei.pos++],ea=eo&tT,ec=64,ed=(eo&tw)>0?-1:1;if((eo&t_)==0)return ed*ea;let eu=ei.arr.length;for(;ei.pos<eu;){if(ea+=((eo=ei.arr[ei.pos++])&tI)*ec,ec*=128,eo<t_)return ed*ea;if(ea>tO)throw rr}throw t9},rh=ei=>{let eo=rd(ei);if(0===eo)return"";{let ea=String.fromCodePoint(rc(ei));if(--eo<100)for(;eo--;)ea+=String.fromCodePoint(rc(ei));else for(;eo>0;){let ec=eo<1e4?eo:1e4,ed=ei.arr.subarray(ei.pos,ei.pos+ec);ei.pos+=ec,ea+=String.fromCodePoint.apply(null,ed),eo-=ec}return decodeURIComponent(escape(ea))}},rf=ei=>eH.decode(rl(ei)),rp=eH?rf:rh,rg=(ei,eo)=>{let ea=new DataView(ei.arr.buffer,ei.arr.byteOffset+ei.pos,eo);return ei.pos+=eo,ea},rv=ei=>rg(ei,4).getFloat32(0,!1),rm=ei=>rg(ei,8).getFloat64(0,!1),ry=ei=>rg(ei,8).getBigInt64(0,!1),rb=[ei=>{},ei=>null,ru,rv,rm,ry,ei=>!1,ei=>!0,rp,ei=>{let eo=rd(ei),ea={};for(let ec=0;ec<eo;ec++){let eo=rp(ei);ea[eo]=rS(ei)}return ea},ei=>{let eo=rd(ei),ea=[];for(let ec=0;ec<eo;ec++)ea.push(rS(ei));return ea},rl],rS=ei=>rb[127-rc(ei)](ei),rE=Date.now;class rw{constructor(){this._observers=ez()}on(ei,eo){eY(this._observers,ei,eA).add(eo)}once(ei,eo){let ea=(...ec)=>{this.off(ei,ea),eo(...ec)};this.on(ei,ea)}off(ei,eo){let ea=this._observers.get(ei);void 0!==ea&&(ea.delete(eo),0===ea.size&&this._observers.delete(ei))}emit(ei,eo){return eD((this._observers.get(ei)||ez()).values()).forEach(ei=>ei(...eo))}destroy(){this._observers=ez()}}let r_=3e4;class rT extends rw{constructor(ei){super(),this.doc=ei,this.clientID=ei.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{let ei=rE();null!==this.getLocalState()&&r_/2<=ei-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());let eo=[];this.meta.forEach((ea,ec)=>{ec!==this.clientID&&r_<=ei-ea.lastUpdated&&this.states.has(ec)&&eo.push(ec)}),eo.length>0&&rI(this,eo,"timeout")},tv(r_/10)),ei.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(ei){let eo=this.clientID,ea=this.meta.get(eo),ec=void 0===ea?0:ea.clock+1,ed=this.states.get(eo);null===ei?this.states.delete(eo):this.states.set(eo,ei),this.meta.set(eo,{clock:ec,lastUpdated:rE()});let eu=[],eh=[],ef=[],ep=[];null===ei?ep.push(eo):null==ed?null!=ei&&eu.push(eo):(eh.push(eo),e9(ed,ei)||ef.push(eo)),(eu.length>0||ef.length>0||ep.length>0)&&this.emit("change",[{added:eu,updated:ef,removed:ep},"local"]),this.emit("update",[{added:eu,updated:eh,removed:ep},"local"])}setLocalStateField(ei,eo){let ea=this.getLocalState();null!==ea&&this.setLocalState({...ea,[ei]:eo})}getStates(){return this.states}}let rI=(ei,eo,ea)=>{let ec=[];for(let ea=0;ea<eo.length;ea++){let ed=eo[ea];if(ei.states.has(ed)){if(ei.states.delete(ed),ed===ei.clientID){let eo=ei.meta.get(ed);ei.meta.set(ed,{clock:eo.clock+1,lastUpdated:rE()})}ec.push(ed)}}ec.length>0&&(ei.emit("change",[{added:[],updated:[],removed:ec},ea]),ei.emit("update",[{added:[],updated:[],removed:ec},ea]))},rC=(ei,eo,ea=ei.states)=>{let ec=eo.length,ed=tM();tN(ed,ec);for(let eu=0;eu<ec;eu++){let ec=eo[eu],eh=ea.get(ec)||null,ef=ei.meta.get(ec).clock;tN(ed,ec),tN(ed,ef),t$(ed,JSON.stringify(eh))}return tA(ed)},rO=(ei,eo,ea)=>{let ec=ro(eo),ed=rE(),eu=[],eh=[],ef=[],ep=[],eg=rd(ec);for(let eo=0;eo<eg;eo++){let eo=rd(ec),ea=rd(ec),eg=JSON.parse(rp(ec)),em=ei.meta.get(eo),ey=ei.states.get(eo),eb=void 0===em?0:em.clock;(eb<ea||eb===ea&&null===eg&&ei.states.has(eo))&&(null===eg?eo===ei.clientID&&null!=ei.getLocalState()?ea++:ei.states.delete(eo):ei.states.set(eo,eg),ei.meta.set(eo,{clock:ea,lastUpdated:ed}),void 0===em&&null!==eg?eu.push(eo):void 0!==em&&null===eg?ep.push(eo):null!==eg&&(e9(eg,ey)||ef.push(eo),eh.push(eo)))}(eu.length>0||ef.length>0||ep.length>0)&&ei.emit("change",[{added:eu,updated:ef,removed:ep},ea]),(eu.length>0||eh.length>0||ep.length>0)&&ei.emit("update",[{added:eu,updated:eh,removed:ep},ea])},rR=0,rk=1,rM=2,rP=(ei,eo,ea)=>{tN(ei,rk),tV(ei,eu.D$(eo,ea))},rA=(ei,eo,ea)=>rP(eo,ea,rl(ei)),rD=(ei,eo,ea)=>{try{eu.NG(eo,rl(ei),ea)}catch(ei){console.error("Caught error while handling a Yjs update",ei)}},rx=(ei,eo)=>{tN(ei,rM),tV(ei,eo)},rj=rD,rL=(ei,eo,ea,ec)=>{let ed=rd(ei);switch(ed){case rR:rA(ei,eo,ea);break;case rk:rD(ei,ea,ec);break;case rM:rj(ei,ea,ec);break;default:throw Error("Unknown message type")}return ed};class rN{constructor(ei,eo){this.left=ei,this.right=eo}}let rU=(ei,eo)=>new rN(ei,eo),rB="u">typeof document?document:{};"u">typeof DOMParser&&new DOMParser;let rF=ei=>eJ(ei,(ei,eo)=>`${eo}:${ei};`).join("");rB.ELEMENT_NODE,rB.TEXT_NODE,rB.CDATA_SECTION_NODE,rB.COMMENT_NODE,rB.DOCUMENT_NODE,rB.DOCUMENT_TYPE_NODE,rB.DOCUMENT_FRAGMENT_NODE;let rK=Symbol,rq=rK(),r$=rK(),rW=rK(),rV=rK(),rG=rK(),rH=rK(),rz=rK(),rY=rK(),rJ=rK(),rQ=ei=>{let eo=[],ea=0;for(;ea<ei.length;ea++){let ec=ei[ea];ec.constructor===String||ec.constructor===Number||ec.constructor===Object&&eo.push(JSON.stringify(ec))}return eo},rX=[rG,rz,rY,rW],rZ=0,r0=rE(),r1=(ei,eo)=>{let ea=rX[rZ],ec=th("log"),ed=null!==ec&&("*"===ec||"true"===ec||RegExp(ec,"gi").test(eo));return rZ=(rZ+1)%rX.length,eo+=": ",ed?(...ec)=>{let ed=rE(),eu=ed-r0;r0=ed,ei(ea,eo,rJ,...ec.map(ei=>"string"==typeof ei||"symbol"==typeof ei?ei:JSON.stringify(ei)),ea," +"+eu+"ms")}:e8},r2={[rq]:rU("font-weight","bold"),[r$]:rU("font-weight","normal"),[rW]:rU("color","blue"),[rG]:rU("color","green"),[rV]:rU("color","grey"),[rH]:rU("color","red"),[rz]:rU("color","purple"),[rY]:rU("color","orange"),[rJ]:rU("color","black")},r3=ei=>{let eo=[],ea=[],ec=ez(),ed=[],eu=0;for(;eu<ei.length;eu++){let ed=ei[eu],eh=r2[ed];if(void 0!==eh)ec.set(eh.left,eh.right);else if(ed.constructor===String||ed.constructor===Number){let ei=rF(ec);eu>0||ei.length>0?(eo.push("%c"+ed),ea.push(ei)):eo.push(ed)}else break}for(eu>0&&(ed=ea).unshift(eo.join(""));eu<ei.length;eu++){let eo=ei[eu];eo instanceof Symbol||ed.push(eo)}return ed},r6=tg?r3:rQ,r4=(...ei)=>{console.log(...r6(ei)),r5.forEach(eo=>eo.print(ei))},r5=eA(),r8=ei=>r1(r4,ei),r7=crypto.getRandomValues.bind(crypto),r9=Math.random,ir=()=>r7(new Uint32Array(1))[0],ii="10000000-1000-4000-8000-100000000000",io=()=>ii.replace(/[018]/g,ei=>(ei^ir()&15>>ei/4).toString(16)),ia=ei=>Promise.reject(ei),il="u">typeof window&&"u">typeof window.document,iu=il?null==window?void 0:window.crypto:global.crypto,ih=(ei,eo)=>{let ea=eG(ei).buffer,ec=eG(eo).buffer;return iu.subtle.importKey("raw",ea,"PBKDF2",!1,["deriveKey"]).then(ei=>iu.subtle.deriveKey({name:"PBKDF2",salt:ec,iterations:1e5,hash:"SHA-256"},ei,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]))},ig=async(ei,eo)=>{if(!eo)return ei;let ea=iu.getRandomValues(new Uint8Array(12));return iu.subtle.encrypt({name:"AES-GCM",iv:ea},eo,ei).then(ei=>{let eo=tM();return t$(eo,"AES-GCM"),tV(eo,ea),tV(eo,new Uint8Array(ei)),tA(eo)})},im=(ei,eo)=>{let ea=tM();return tX(ea,ei),ig(tA(ea),eo)},iy=async(ei,eo)=>{if(!eo)return ei;let ea=ro(ei);"AES-GCM"!==rp(ea)&&ia(t7("Unknown encryption algorithm"));let ec=rl(ea),ed=rl(ea);return iu.subtle.decrypt({name:"AES-GCM",iv:ec},eo,ed).then(ei=>new Uint8Array(ei))},ib=(ei,eo)=>iy(ei,eo).then(ei=>rS(ro(new Uint8Array(ei)))),iS=new Map,iE=new Map;function iw(ei){iS.forEach(eo=>{eo.connected&&(eo.send({type:"subscribe",topics:[ei.name]}),ei.webrtcConns.size<ei.provider.maxConns&&eo.publishSignalingMessage(ei,{type:"announce",from:ei.peerId}))})}let i_=new Map;class iT{constructor(ei){this.room=ei,this.onmessage=null,this._onChange=eo=>eo.key===ei&&null!==this.onmessage&&this.onmessage({data:t8(eo.newValue||"")}),e2(this._onChange)}postMessage(ei){e1.setItem(this.room,t5(t1(ei)))}close(){e3(this._onChange)}}let iI=typeof BroadcastChannel>"u"?iT:BroadcastChannel,iC=ei=>eY(i_,ei,()=>{let eo=eA(),ea=new iI(ei);return ea.onmessage=ei=>eo.forEach(eo=>eo(ei.data,"broadcastchannel")),{bc:ea,subs:eo}}),iO=(ei,eo)=>(iC(ei).subs.add(eo),eo),iR=(ei,eo)=>{let ea=iC(ei),ec=ea.subs.delete(eo);return ec&&0===ea.subs.size&&(ea.bc.close(),i_.delete(ei)),ec},ik=(ei,eo,ea=null)=>{let ec=iC(ei);ec.bc.postMessage(eo),ec.subs.forEach(ei=>ei(eo,ea))},iM=()=>{let ei=!0;return(eo,ea)=>{if(ei){ei=!1;try{eo()}finally{ei=!0}}else void 0!==ea&&ea()}},iP=4,iA=5,iD=r8("y-webrtc");class ix{constructor(ei,eo,ea,ec,ed){eE(this,"peerId",io()),eE(this,"synced",!1),eE(this,"webrtcConns",new Map),eE(this,"bcConns",new Set),eE(this,"mux",iM()),eE(this,"bcconnected",!1),eE(this,"_bcSubscriber",ei=>iy(new Uint8Array(ei),this.key).then(ei=>this.mux(()=>{this.readMessage(ei,ei=>{this.broadcastBcMessage(tA(ei))})}))),eE(this,"readMessage",(ei,eo)=>{let ea=ro(ei),ec=tM(),ed=rd(ea),eu=ei=>{tN(ec,iA),tV(ec,ei),eo(ec)};switch(ed){case iA:this.onCustomMessage(rl(ea),eu);break;case iP:{let ei=1===rc(ea),eo=rp(ea);if(eo!==this.peerId&&(this.bcConns.has(eo)&&!ei||!this.bcConns.has(eo)&&ei)){let ea=[],ec=[];ei?(this.bcConns.add(eo),ec.push(eo),this.onPeerConnected(eu)):(this.bcConns.delete(eo),ea.push(eo)),this.provider.emit("peers",[{added:ec,removed:ea,webrtcPeers:Array.from(this.webrtcConns.keys()),bcPeers:Array.from(this.bcConns)}]),this.broadcastBcPeerId()}break}default:console.error("Unable to compute message");return}}),this.provider=ei,this.onCustomMessage=eo,this.onPeerConnected=ea,this.name=ec,this.key=ed}broadcastBcPeerId(){if(this.provider.filterBcConns){let ei=tM();tN(ei,iP),tL(ei,1),t$(ei,this.peerId),this.broadcastBcMessage(tA(ei))}}broadcastWebrtcConn(ei){iD("broadcast message in ",rq,this.name,r$),this.webrtcConns.forEach(eo=>{try{eo.peer.send(ei)}catch{}})}broadcastRoomMessage(ei){let eo=tM();tN(eo,iA),tV(eo,ei);let ea=tA(eo);this.bcconnected&&this.broadcastBcMessage(ea),this.broadcastWebrtcConn(ea)}broadcastBcMessage(ei){return ig(ei,this.key).then(ei=>this.mux(()=>ik(this.name,ei)))}connect(){iw(this);let ei=this.name;iO(ei,this._bcSubscriber),this.bcconnected=!0,this.broadcastBcPeerId()}disconnect(){iS.forEach(ei=>{ei.connected&&ei.send({type:"unsubscribe",topics:[this.name]})});let ei=tM();tN(ei,iP),tL(ei,0),t$(ei,this.peerId),this.broadcastBcMessage(tA(ei)),iR(this.name,this._bcSubscriber),this.bcconnected=!1,this.webrtcConns.forEach(ei=>ei.destroy())}destroy(){this.disconnect()}}let ij=1200,iL=2500,iN=3e4,iU=ei=>{if(ei.shouldConnect&&null===ei.ws){let eo=new WebSocket(ei.url),ea=ei.binaryType,ec=null;ea&&(eo.binaryType=ea),ei.ws=eo,ei.connecting=!0,ei.connected=!1,eo.onmessage=eo=>{ei.lastMessageReceived=rE();let ea=eo.data,ed="string"==typeof ea?JSON.parse(ea):ea;ed&&"pong"===ed.type&&(clearTimeout(ec),ec=setTimeout(eu,iN/2)),ei.emit("message",[ed,ei])};let ed=eo=>{null!==ei.ws&&(ei.ws=null,ei.connecting=!1,ei.connected?(ei.connected=!1,ei.emit("disconnect",[{type:"disconnect",error:eo},ei])):ei.unsuccessfulReconnects++,setTimeout(iU,tb(ty(ei.unsuccessfulReconnects+1)*ij,iL),ei)),clearTimeout(ec)},eu=()=>{ei.ws===eo&&ei.send({type:"ping"})};eo.onclose=()=>ed(null),eo.onerror=ei=>ed(ei),eo.onopen=()=>{ei.lastMessageReceived=rE(),ei.connecting=!1,ei.connected=!0,ei.unsuccessfulReconnects=0,ei.emit("connect",[{type:"connect"},ei]),ec=setTimeout(eu,iN/2)}}};class iB extends rw{constructor(ei,{binaryType:eo}={}){super(),this.url=ei,this.ws=null,this.binaryType=eo||null,this.connected=!1,this.connecting=!1,this.unsuccessfulReconnects=0,this.lastMessageReceived=0,this.shouldConnect=!0,this._checkInterval=setInterval(()=>{this.connected&&iN<rE()-this.lastMessageReceived&&this.ws.close()},iN/2),iU(this)}send(ei){this.ws&&this.ws.send(JSON.stringify(ei))}destroy(){clearInterval(this._checkInterval),this.disconnect(),super.destroy()}disconnect(){this.shouldConnect=!1,null!==this.ws&&this.ws.close()}connect(){this.shouldConnect=!0,this.connected||null!==this.ws||iU(this)}}let iF=r8("y-webrtc");class iK{constructor(ei,eo,ea,ec){eE(this,"closed",!1),eE(this,"connected",!1),eE(this,"synced",!1),eE(this,"peer"),this.remotePeerId=ea,this.room=ec,iF("establishing connection to ",rq,ea),this.peer=new ep({initiator:eo,...ec.provider.peerOpts}),this.peer.on("signal",eo=>{ei.publishSignalingMessage(ec,{to:ea,from:ec.peerId,type:"signal",signal:eo})}),this.peer.on("connect",()=>{iF("connected to ",rq,ea),this.connected=!0,ec.onPeerConnected(ei=>{let eo=tM();tN(eo,iA),tV(eo,ei),this.sendWebrtcConn(eo)})}),this.peer.on("close",()=>{this.connected=!1,this.closed=!0,ec.webrtcConns.has(this.remotePeerId)&&(ec.webrtcConns.delete(this.remotePeerId),ec.provider.emit("peers",[{removed:[this.remotePeerId],added:[],webrtcPeers:Array.from(ec.webrtcConns.keys()),bcPeers:Array.from(ec.bcConns)}])),this.peer.destroy(),iF("closed connection to ",rq,ea),iw(ec)}),this.peer.on("error",ei=>{iF("Error in connection to ",rq,ea,": ",ei),iw(ec)}),this.peer.on("data",ei=>{iF("received message from ",rq,this.remotePeerId,rV," (",ec.name,")",r$,rJ),this.room.readMessage(ei,ei=>{this.sendWebrtcConn(ei)})})}sendWebrtcConn(ei){iF("send message to ",rq,this.remotePeerId,r$,rV," (",this.room.name,")",rJ);try{this.peer.send(tA(ei))}catch{}}destroy(){this.peer.destroy()}}let iq=r8("y-webrtc");class i$ extends iB{constructor(ei){super(ei),eE(this,"providers",new Set),eE(this,"publishSignalingMessage",(ei,eo)=>{ei.key?im(eo,ei.key).then(eo=>{this.send({type:"publish",topic:ei.name,data:t5(eo)})}):this.send({type:"publish",topic:ei.name,data:eo})}),this.on("connect",()=>{iq(`connected (${ei})`);let eo=Array.from(iE.keys());this.send({type:"subscribe",topics:eo}),iE.forEach(ei=>this.publishSignalingMessage(ei,{type:"announce",from:ei.peerId}))}),this.on("message",ei=>{if("publish"===ei.type){let eo=ei.topic,ea=iE.get(eo);if(null==ea||"string"!=typeof eo)return;let ec=ei=>{let eo=ea.webrtcConns,ec=ea.peerId;if(null==ei||ei.from===ec||void 0!==ei.to&&ei.to!==ec||ea.bcConns.has(ei.from))return;let ed=eo.has(ei.from)?()=>{}:()=>ea.provider.emit("peers",[{removed:[],added:[ei.from],webrtcPeers:Array.from(ea.webrtcConns.keys()),bcPeers:Array.from(ea.bcConns)}]);switch(ei.type){case"announce":eo.size<ea.provider.maxConns&&(eY(eo,ei.from,()=>new iK(this,!0,ei.from,ea)),ed());break;case"signal":ei.to===ec&&(eY(eo,ei.from,()=>new iK(this,!1,ei.from,ea)).peer.signal(ei.signal),ed())}};ea.key?"string"==typeof ei.data&&ib(t8(ei.data),ea.key).then(ec):ec(ei.data)}}),this.on("disconnect",()=>iq(`disconnect (${ei})`))}}r8("y-webrtc");let iW=(ei,eo,ea,ec,ed)=>{if(iE.has(ec))throw t7(`A Yjs Doc connected to room "${ec}" already exists!`);let eu=new ix(ei,eo,ea,ec,ed);return iE.set(ec,eu),eu};class iV extends rw{constructor(ei,{signaling:eo=["wss://signaling.yjs.dev","wss://y-webrtc-signaling-eu.herokuapp.com","wss://y-webrtc-signaling-us.herokuapp.com"],password:ea,maxConns:ec=20+tv(15*r9()),filterBcConns:ed=!0,peerOpts:eu={}}={}){super(),eE(this,"shouldConnect",!1),eE(this,"filterBcConns",!0),eE(this,"signalingUrls"),eE(this,"signalingConns"),eE(this,"peerOpts"),eE(this,"maxConns"),eE(this,"key"),eE(this,"room"),this.roomName=ei,this.filterBcConns=ed,this.shouldConnect=!1,this.signalingUrls=eo,this.signalingConns=[],this.maxConns=ec,this.peerOpts={iceServers:[]},this.key=ea?ih(ea,ei):Promise.resolve(void 0),this.key.then(eo=>{this.room=iW(this,this.onCustomMessage,this.onPeerConnected,ei,eo),this.shouldConnect?this.room.connect():this.room.disconnect()}),this.connect()}get connected(){return null!==this.room&&this.shouldConnect}connect(){this.shouldConnect=!0,this.signalingUrls.forEach(ei=>{let eo=eY(iS,ei,()=>new i$(ei));this.signalingConns.push(eo),eo.providers.add(this)}),this.room&&this.room.connect()}disconnect(){this.shouldConnect=!1,this.signalingConns.forEach(ei=>{ei.providers.delete(this),0===ei.providers.size&&(ei.destroy(),iS.delete(ei.url))}),this.room&&this.room.disconnect()}destroy(){this.key.then(()=>{var ei;null==(ei=this.room)||ei.destroy(),iE.delete(this.roomName)}),super.destroy()}}let iG=r8("y-webrtc"),iH=0,iz=1;class iY extends iV{constructor(ei,eo,ea,ec,ed,eu,eh=new rT(ei)){super(eo,{password:ea,...eu}),eE(this,"onCustomMessage",(ei,eo)=>{let ea=ro(ei),ec=tM();switch(rd(ea)){case iH:{let ei=rS(ea);this.verify(ei).then(()=>{let eo=eT(ei.message),ea=ro(eo);if(rL(ea,ec,this.doc,this)!==rM)throw iG("error: expect only updates"),Error("error: only update messages expected")},ei=>{console.error("couldn't verify message")});break}case iz:rO(this.awareness,rl(ea),this)}}),eE(this,"onPeerConnected",ei=>{let eo=tM(),ea=this.awareness.getStates();ea.size>0&&(tN(eo,iz),tV(eo,rC(this.awareness,Array.from(ea.keys()))),ei(tA(eo)))}),eE(this,"_docUpdateHandler",async(ei,eo)=>{if(!this.room)return;let ea=tM();tN(ea,iH);let ec=tM();rx(ec,ei);let ed={message:e_(tA(ec))};await this.sign(ed),tX(ea,ed),this.room.broadcastRoomMessage(tA(ea))}),eE(this,"_awarenessUpdateHandler",({added:ei,updated:eo,removed:ea},ec)=>{if(!this.room)return;let ed=ei.concat(eo).concat(ea);iG("awareness change ",{added:ei,updated:eo,removed:ea},"local",this.awareness.clientID);let eu=tM();tN(eu,iz),tV(eu,rC(this.awareness,ed)),this.room.broadcastRoomMessage(tA(eu))}),this.doc=ei,this.roomPassword=ea,this.sign=ec,this.verify=ed,this.awareness=eh,ei.on("destroy",this.destroy.bind(this)),this.doc.on("update",this._docUpdateHandler),this.awareness.on("update",this._awarenessUpdateHandler),window.addEventListener("beforeunload",()=>{rI(this.awareness,[ei.clientID],"window unload"),iE.forEach(ei=>{ei.disconnect()})})}destroy(){this.doc.off("update",this._docUpdateHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("destroy",this.destroy),super.destroy()}}let iJ={flushInterval:500,retryIfForbiddenInterval:3e4};class iQ extends ed.Sx.Disposable{constructor(ei,eo,ea={}){super(),eE(this,"pendingUpdates",[]),eE(this,"isSendingUpdates",!1),eE(this,"_canWrite",!0),eE(this,"retryTimeoutHandler"),eE(this,"roomId"),eE(this,"_onCanWriteChanged",this._register(new ed.B.Emitter)),eE(this,"onCanWriteChanged",this._onCanWriteChanged.event),eE(this,"_onSentAllEvents",this._register(new ed.B.Emitter)),eE(this,"onSentAllEvents",this._onSentAllEvents.event),eE(this,"throttledFlushUpdatesToMatrix"),eE(this,"opts"),eE(this,"flushUpdatesToMatrix",async()=>{if(this.isSendingUpdates||!this.pendingUpdates.length||!this.roomId)return;this.isSendingUpdates=!0;let ei=eu.kp(this.pendingUpdates);this.pendingUpdates=[];let eo=!1;try{console.log("Sending updates"),await this.translator.sendUpdate(this.matrixClient,this.roomId,ei),this.setCanWrite(!0),console.log("sent updates")}catch(ea){if("M_FORBIDDEN"===ea.errcode){console.warn("not allowed to edit document",ea),this.setCanWrite(!1);try{await this.matrixClient.joinRoom(this.roomId),console.log("joined room",this.roomId),eo=!0}catch(ei){console.warn("failed to join room",ei)}}else console.error("error sending updates",ea);this.pendingUpdates.unshift(ei)}finally{this.isSendingUpdates=!1}this.pendingUpdates.length?this.retryTimeoutHandler=setTimeout(()=>{this.throttledFlushUpdatesToMatrix()},eo?0:this.canWrite?this.opts.flushInterval:this.opts.retryIfForbiddenInterval):(console.log("_onSentAllEvents"),this._onSentAllEvents.fire())}),this.matrixClient=ei,this.translator=eo,this.opts={...iJ,...ea},this.throttledFlushUpdatesToMatrix=eg.throttle(this.flushUpdatesToMatrix,this.canWrite?this.opts.flushInterval:this.opts.retryIfForbiddenInterval)}setCanWrite(ei){this._canWrite!==ei&&(this._canWrite=ei,this._onCanWriteChanged.fire())}async initialize(ei){this.roomId=ei,this.throttledFlushUpdatesToMatrix()}get canWrite(){return this._canWrite}writeUpdate(ei){this.pendingUpdates.push(ei),this.throttledFlushUpdatesToMatrix()}async waitForFlush(){(this.pendingUpdates.length||this.isSendingUpdates)&&await ed.B.Event.toPromise(this.onSentAllEvents)}dispose(){super.dispose(),clearTimeout(this.retryTimeoutHandler),this.throttledFlushUpdatesToMatrix.cancel()}}function iX(ei,eo){return iZ(new DataView(ei),new DataView(eo))}function iZ(ei,eo){if(ei.byteLength!==eo.byteLength)return!1;for(let ea=0;ea<ei.byteLength;ea++)if(ei.getUint8(ea)!==eo.getUint8(ea))return!1;return!0}let i0="m.room.message",i1={updatesAsRegularMessages:!1,updateEventType:"matrix-crdt.doc_update",snapshotEventType:"matrix-crdt.doc_snapshot"};class i2{constructor(ei={}){eE(this,"opts"),this.opts={...i1,...ei}}async sendUpdate(ei,eo,ea){let ec=e_(ea),ed={update:ec};if(this.opts.updatesAsRegularMessages){let ea={body:this.opts.updateEventType+": "+ec,msgtype:this.opts.updateEventType,...ed};ei.scheduler=void 0,await ei.sendEvent(eo,i0,ea,"")}else await ei.sendEvent(eo,this.opts.updateEventType,ed,"")}async sendSnapshot(ei,eo,ea,ec){let ed=e_(ea),eu={update:ed,last_event_id:ec};if(this.opts.updatesAsRegularMessages){let ea={body:this.opts.snapshotEventType+": "+ed,msgtype:this.opts.snapshotEventType,...eu};ei.scheduler=void 0,await ei.sendEvent(eo,i0,ea,"")}else await ei.sendEvent(eo,this.opts.snapshotEventType,eu,"")}isUpdateEvent(ei){return this.opts.updatesAsRegularMessages?ei.type===i0&&ei.content.msgtype===this.opts.updateEventType:ei.type===this.opts.updateEventType}isSnapshotEvent(ei){return this.opts.updatesAsRegularMessages?ei.type===i0&&ei.content.msgtype===this.opts.snapshotEventType:ei.type===this.opts.snapshotEventType}get WrappedEventType(){return this.opts.updatesAsRegularMessages?i0:this.opts.updateEventType}}let i3={enableExperimentalWebrtcSync:!1,reader:{},writer:{},translator:{}};class i6 extends ed.Sx.Disposable{constructor(ei,eo,ea,ec,eh={}){if(super(),eE(this,"disposed",!1),eE(this,"_roomId"),eE(this,"initializeTimeoutHandler"),eE(this,"initializedResolve"),eE(this,"initializedPromise",new Promise(ei=>{this.initializedResolve=ei})),eE(this,"webrtcProvider"),eE(this,"reader"),eE(this,"throttledWriter"),eE(this,"translator"),eE(this,"_onDocumentAvailable",this._register(new ed.B.Emitter)),eE(this,"_onDocumentUnavailable",this._register(new ed.B.Emitter)),eE(this,"_onReceivedEvents",this._register(new ed.B.Emitter)),eE(this,"opts"),eE(this,"onDocumentAvailable",this._onDocumentAvailable.event),eE(this,"onReceivedEvents",this._onReceivedEvents.event),eE(this,"onDocumentUnavailable",this._onDocumentUnavailable.event),eE(this,"totalEventsReceived",0),eE(this,"documentUpdateListener",async(ei,eo)=>{eo===this||this.webrtcProvider&&eo===this.webrtcProvider||null!=eo&&eo.provider||this.throttledWriter.writeUpdate(ei)}),eE(this,"processIncomingEvents",(ei,eo=!1)=>{ei=ei.filter(ei=>!(!this.translator.isUpdateEvent(ei)&&!this.translator.isSnapshotEvent(ei))),this.totalEventsReceived+=ei.length;let ea=ei.map(ei=>new Uint8Array(eT(ei.content.update))),ec=eu.kp(ea);if(!ea.length)return ec;if(eu.NG(this.doc,ec,this),eo){let eo=ei[ei.length-1],ea=eu.D$(this.doc);this.translator.sendSnapshot(this.matrixClient,this._roomId,ea,eo.event_id).catch(ei=>{console.error("failed to send snapshot")})}return ei.filter(ei=>ei.user_id!==this.matrixClient.credentials.userId).length&&this._onReceivedEvents.fire(),ec}),this.doc=ei,this.matrixClient=eo,this.room=ea,this.awareness=ec,ec&&!eh.enableExperimentalWebrtcSync)throw Error("awareness is only supported when using enableExperimentalWebrtcSync=true");this.opts={...i3,...eh},this.translator=new i2(this.opts.translator),this.throttledWriter=new iQ(this.matrixClient,this.translator,this.opts.writer),ei.on("update",this.documentUpdateListener)}get onCanWriteChanged(){return this.throttledWriter.onCanWriteChanged}get canWrite(){return this.throttledWriter.canWrite}get roomId(){return this._roomId}get matrixReader(){return this.reader}async initializeWebrtc(){if(!this._roomId)throw Error("not initialized");if(!this.reader)throw Error("needs reader to initialize webrtc");let ei=this._register(new eO(this.matrixClient,this.reader));await ei.initialize(),this.webrtcProvider=new iY(this.doc,this._roomId,this._roomId,async ei=>{await eI(this.matrixClient,ei)},async eo=>{await eC(this.matrixClient,ei,eo,this.translator.WrappedEventType)},void 0,this.awareness)}async initializeNoCatch(){let ei="id"===this.room.type?this.room.id:this.room.alias;try{if("id"===this.room.type)this._roomId=this.room.id;else if("alias"===this.room.type){let ei=await this.matrixClient.getRoomIdForAlias(this.room.alias);this._roomId=ei.room_id}if(!this._roomId)throw Error("error receiving room id");console.log("room resolved",this._roomId),await this.throttledWriter.initialize(this._roomId)}catch(ea){let eo=5e3;"M_NOT_FOUND"===ea.errcode?(console.log("room not found",ei),this._onDocumentUnavailable.fire()):"ConnectionError"===ea.name?console.log("room not found (offline)",ei):(console.error("error retrieving room",ei,ea),eo=3e4,this._onDocumentUnavailable.fire()),this.initializeTimeoutHandler=setTimeout(()=>{this.initialize()},eo);return}let eo=eu.D$(this.doc),ea=eu.rL(eo),ec=eu.TV(eo,ea),ed=eu.CO(this.doc),eh=await this.initializeReader();this._onDocumentAvailable.fire();let ef=eu.rL(eh),ep=eu.TV(eo,ef);if(iX(ec.buffer,ep.buffer)){let ei=new eu.QW;if(eu.NG(ei,eh),i4(eu.CO(ei),ed)){this.initializedResolve();return}}ep.length>2&&this.throttledWriter.writeUpdate(ep),this.initializedResolve()}async initializeReader(){if(this.reader)throw Error("already initialized reader");if(!this._roomId)throw Error("no roomId");this.reader=this._register(new eP(this.matrixClient,this._roomId,this.translator,this.opts.reader)),this._register(this.reader.onEvents(ei=>this.processIncomingEvents(ei.events,ei.shouldSendSnapshot)));let ei=await this.reader.getInitialDocumentUpdateEvents();return this.reader.startPolling(),this.processIncomingEvents(ei)}async waitForFlush(){await this.initializedPromise,await this.throttledWriter.waitForFlush()}async initialize(){try{await this.initializeNoCatch(),await this.initializedPromise,!this.disposed&&this.opts.enableExperimentalWebrtcSync&&await this.initializeWebrtc()}catch(ei){throw console.error(ei),ei}}dispose(){var ei,eo;super.dispose(),this.disposed=!0,null==(ei=this.webrtcProvider)||ei.destroy(),null==(eo=this.reader)||eo.dispose(),clearTimeout(this.initializeTimeoutHandler),this.doc.off("update",this.documentUpdateListener)}}function i4(ei,eo){for(let[ea,ec]of eo.ds.clients.entries()){let eo=ei.ds.clients.get(ea)||[];if(ec.length>eo.length)return!1;for(let ei=0;ei<ec.length;ei++){let ea=ec[ei],ed=eo[ei];if(ea.clock!==ed.clock||ea.len!==ed.len)return!1}}return!0}r8("y-webrtc")},8974:function(ei,eo,ea){"use strict";ea.d(eo,{Dp:function(){return eu},Z$:function(){return ec},kJ:function(){return eh},s7:function(){return ed}});let ec=ei=>ei[ei.length-1],ed=(ei,eo)=>{for(let ea=0;ea<eo.length;ea++)ei.push(eo[ea])},eu=Array.from,eh=Array.isArray},6399:function(ei,eo,ea){"use strict";ea.d(eo,{$2:function(){return ey},CY:function(){return eu},Ko:function(){return eh},Qn:function(){return ed},RP:function(){return eS},Vw:function(){return ec},cq:function(){return ef},jS:function(){return eb},kr:function(){return em},rc:function(){return ep},x1:function(){return eg}});let ec=1,ed=2,eu=4,eh=8,ef=32,ep=64,eg=128,em=31,ey=63,eb=127,eS=2147483647},8137:function(ei,eo,ea){"use strict";ea.d(eo,{Te:function(){return eu},f9:function(){return eh}}),ea(7083);var ec=ea(8211);ea(8764).Buffer;let ed=ei=>new Uint8Array(ei),eu=(ei,eo,ea)=>new Uint8Array(ei,eo,ea);ec.jU,ec.jU;let eh=ei=>{let eo=ed(ei.byteLength);return eo.set(ei),eo}},5913:function(ei,eo,ea){"use strict";ea.d(eo,{HN:function(){return ew},UF:function(){return eN},XW:function(){return eL},dD:function(){return eU},kf:function(){return eR},kj:function(){return e_},l1:function(){return eb},sO:function(){return eB},v_:function(){return ej},yg:function(){return eT}});var ec=ea(8137),ed=ea(6399),eu=ea(909),eh=ea(7615),ef=ea(7083),ep=ea(3562);let eg=ep.Ue("Unexpected end of array"),em=ep.Ue("Integer out of Range");class ey{constructor(ei){this.arr=ei,this.pos=0}}let eb=ei=>new ey(ei),eS=ei=>ei.pos!==ei.arr.length,eE=(ei,eo)=>{let ea=ec.Te(ei.arr.buffer,ei.pos+ei.arr.byteOffset,eo);return ei.pos+=eo,ea},ew=ei=>eE(ei,eT(ei)),e_=ei=>ei.arr[ei.pos++],eT=ei=>{let eo=0,ea=1,ec=ei.arr.length;for(;ei.pos<ec;){let ec=ei.arr[ei.pos++];if(eo+=(ec&ed.jS)*ea,ea*=128,ec<ed.x1)return eo;if(eo>eh.YM)throw em}throw eg},eI=ei=>{let eo=ei.arr[ei.pos++],ea=eo&ed.$2,ec=64,eu=(eo&ed.rc)>0?-1:1;if((eo&ed.x1)==0)return eu*ea;let ef=ei.arr.length;for(;ei.pos<ef;){if(ea+=((eo=ei.arr[ei.pos++])&ed.jS)*ec,ec*=128,eo<ed.x1)return eu*ea;if(ea>eh.YM)throw em}throw eg},eC=ei=>{let eo=eT(ei);if(0===eo)return"";{let ea=String.fromCodePoint(e_(ei));if(--eo<100)for(;eo--;)ea+=String.fromCodePoint(e_(ei));else for(;eo>0;){let ec=eo<1e4?eo:1e4,ed=ei.arr.subarray(ei.pos,ei.pos+ec);ei.pos+=ec,ea+=String.fromCodePoint.apply(null,ed),eo-=ec}return decodeURIComponent(escape(ea))}},eO=ei=>ef.CO.decode(ew(ei)),eR=ef.CO?eO:eC,ek=(ei,eo)=>{let ea=new DataView(ei.arr.buffer,ei.arr.byteOffset+ei.pos,eo);return ei.pos+=eo,ea},eM=ei=>ek(ei,4).getFloat32(0,!1),eP=ei=>ek(ei,8).getFloat64(0,!1),eA=ei=>ek(ei,8).getBigInt64(0,!1),eD=[ei=>void 0,ei=>null,eI,eM,eP,eA,ei=>!1,ei=>!0,eR,ei=>{let eo=eT(ei),ea={};for(let ec=0;ec<eo;ec++){let eo=eR(ei);ea[eo]=ej(ei)}return ea},ei=>{let eo=eT(ei),ea=[];for(let ec=0;ec<eo;ec++)ea.push(ej(ei));return ea},ew],ej=ei=>eD[127-e_(ei)](ei);class eL extends ey{constructor(ei,eo){super(ei),this.reader=eo,this.s=null,this.count=0}read(){return 0===this.count&&(this.s=this.reader(this),eS(this)?this.count=eT(this)+1:this.count=-1),this.count--,this.s}}class eN extends ey{constructor(ei){super(ei),this.s=0,this.count=0}read(){if(0===this.count){this.s=eI(this);let ei=eu.GR(this.s);this.count=1,ei&&(this.s=-this.s,this.count=eT(this)+2)}return this.count--,this.s}}class eU extends ey{constructor(ei){super(ei),this.s=0,this.count=0,this.diff=0}read(){if(0===this.count){let ei=eI(this),eo=1&ei;this.diff=eu.GW(ei/2),this.count=1,eo&&(this.count=eT(this)+2)}return this.s+=this.diff,this.count--,this.s}}class eB{constructor(ei){this.decoder=new eN(ei),this.str=eR(this.decoder),this.spos=0}read(){let ei=this.spos+this.decoder.read(),eo=this.str.slice(this.spos,ei);return this.spos=ei,eo}}},5580:function(ei,eo,ea){"use strict";ea.d(eo,{$F:function(){return ew},EM:function(){return eF},GF:function(){return eK},HE:function(){return eW},HK:function(){return eP},Mf:function(){return em},TS:function(){return eH},_f:function(){return eb},mK:function(){return eM},mP:function(){return eA},sX:function(){return eG},uE:function(){return e_},uw:function(){return ek}});var ec=ea(8137),ed=ea(909),eu=ea(7615),eh=ea(6399),ef=ea(7083),ep=ea(8974);class eg{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}let em=()=>new eg,ey=ei=>{let eo=ei.cpos;for(let ea=0;ea<ei.bufs.length;ea++)eo+=ei.bufs[ea].length;return eo},eb=ei=>{let eo=new Uint8Array(ey(ei)),ea=0;for(let ec=0;ec<ei.bufs.length;ec++){let ed=ei.bufs[ec];eo.set(ed,ea),ea+=ed.length}return eo.set(ec.Te(ei.cbuf.buffer,0,ei.cpos),ea),eo},eS=(ei,eo)=>{let ea=ei.cbuf.length;ea-ei.cpos<eo&&(ei.bufs.push(ec.Te(ei.cbuf.buffer,0,ei.cpos)),ei.cbuf=new Uint8Array(2*ed.Fp(ea,eo)),ei.cpos=0)},eE=(ei,eo)=>{let ea=ei.cbuf.length;ei.cpos===ea&&(ei.bufs.push(ei.cbuf),ei.cbuf=new Uint8Array(2*ea),ei.cpos=0),ei.cbuf[ei.cpos++]=eo},ew=eE,e_=(ei,eo)=>{for(;eo>eh.jS;)eE(ei,eh.x1|eh.jS&eo),eo=ed.GW(eo/128);eE(ei,eh.jS&eo)},eT=(ei,eo)=>{let ea=ed.GR(eo);for(ea&&(eo=-eo),eE(ei,(eo>eh.$2?eh.x1:0)|(ea?eh.rc:0)|eh.$2&eo),eo=ed.GW(eo/64);eo>0;)eE(ei,(eo>eh.jS?eh.x1:0)|eh.jS&eo),eo=ed.GW(eo/128)},eI=new Uint8Array(3e4),eC=eI.length/3,eO=(ei,eo)=>{if(eo.length<eC){let ea=ef.YZ.encodeInto(eo,eI).written||0;e_(ei,ea);for(let eo=0;eo<ea;eo++)eE(ei,eI[eo])}else eA(ei,ef.lz(eo))},eR=(ei,eo)=>{let ea=unescape(encodeURIComponent(eo)),ec=ea.length;e_(ei,ec);for(let eo=0;eo<ec;eo++)eE(ei,ea.codePointAt(eo))},ek=ef.YZ&&ef.YZ.encodeInto?eO:eR,eM=(ei,eo)=>eP(ei,eb(eo)),eP=(ei,eo)=>{let ea=ei.cbuf.length,ec=ei.cpos,eu=ed.VV(ea-ec,eo.length),eh=eo.length-eu;ei.cbuf.set(eo.subarray(0,eu),ec),ei.cpos+=eu,eh>0&&(ei.bufs.push(ei.cbuf),ei.cbuf=new Uint8Array(ed.Fp(2*ea,eh)),ei.cbuf.set(eo.subarray(eu)),ei.cpos=eh)},eA=(ei,eo)=>{e_(ei,eo.byteLength),eP(ei,eo)},eD=(ei,eo)=>{eS(ei,eo);let ea=new DataView(ei.cbuf.buffer,ei.cpos,eo);return ei.cpos+=eo,ea},ej=(ei,eo)=>eD(ei,4).setFloat32(0,eo,!1),eL=(ei,eo)=>eD(ei,8).setFloat64(0,eo,!1),eN=(ei,eo)=>eD(ei,8).setBigInt64(0,eo,!1),eU=new DataView(new ArrayBuffer(4)),eB=ei=>(eU.setFloat32(0,ei),eU.getFloat32(0)===ei),eF=(ei,eo)=>{switch(typeof eo){case"string":eE(ei,119),ek(ei,eo);break;case"number":eu.U(eo)&&ed.Wn(eo)<=eh.RP?(eE(ei,125),eT(ei,eo)):eB(eo)?(eE(ei,124),ej(ei,eo)):(eE(ei,123),eL(ei,eo));break;case"bigint":eE(ei,122),eN(ei,eo);break;case"object":if(null===eo)eE(ei,126);else if(ep.kJ(eo)){eE(ei,117),e_(ei,eo.length);for(let ea=0;ea<eo.length;ea++)eF(ei,eo[ea])}else if(eo instanceof Uint8Array)eE(ei,116),eA(ei,eo);else{eE(ei,118);let ea=Object.keys(eo);e_(ei,ea.length);for(let ec=0;ec<ea.length;ec++){let ed=ea[ec];ek(ei,ed),eF(ei,eo[ed])}}break;case"boolean":eE(ei,eo?120:121);break;default:eE(ei,127)}};class eK extends eg{constructor(ei){super(),this.w=ei,this.s=null,this.count=0}write(ei){this.s===ei?this.count++:(this.count>0&&e_(this,this.count-1),this.count=1,this.w(this,ei),this.s=ei)}}let e$=ei=>{ei.count>0&&(eT(ei.encoder,1===ei.count?ei.s:-ei.s),ei.count>1&&e_(ei.encoder,ei.count-2))};class eW{constructor(){this.encoder=new eg,this.s=0,this.count=0}write(ei){this.s===ei?this.count++:(e$(this),this.count=1,this.s=ei)}toUint8Array(){return e$(this),eb(this.encoder)}}let eV=ei=>{if(ei.count>0){let eo=2*ei.diff+(1===ei.count?0:1);eT(ei.encoder,eo),ei.count>1&&e_(ei.encoder,ei.count-2)}};class eG{constructor(){this.encoder=new eg,this.s=0,this.count=0,this.diff=0}write(ei){this.diff===ei-this.s?(this.s=ei,this.count++):(eV(this),this.count=1,this.diff=ei-this.s,this.s=ei)}toUint8Array(){return eV(this),eb(this.encoder)}}class eH{constructor(){this.sarr=[],this.s="",this.lensE=new eW}write(ei){this.s+=ei,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(ei.length)}toUint8Array(){let ei=new eg;return this.sarr.push(this.s),this.s="",ek(ei,this.sarr.join("")),eP(ei,this.lensE.toUint8Array()),eb(ei)}}},8211:function(ei,eo,ea){"use strict";let ec;ea.d(eo,{jU:function(){return eE},hH:function(){return eR}});var ed=ea(9805),eu=ea(7083);let eh=ei=>void 0===ei?null:ei;class ef{constructor(){this.map=new Map}setItem(ei,eo){this.map.set(ei,eo)}getItem(ei){return this.map.get(ei)}}let ep=new ef,eg=!0;try{"undefined"!=typeof localStorage&&(ep=localStorage,eg=!1)}catch(ei){}let em=ep;var ey=ea(1351),eb=ea(3454);let eS=void 0!==eb&&eb.release&&/node|io\.js/.test(eb.release.name),eE="undefined"!=typeof window&&"undefined"!=typeof document&&!eS;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);let ew=[],e_=()=>{if(void 0===ec){if(eS){ec=ed.Ue();let ei=eb.argv,eo=null;for(let ea=0;ea<ei.length;ea++){let ed=ei[ea];"-"===ed[0]?(null!==eo&&ec.set(eo,""),eo=ed):null!==eo?(ec.set(eo,ed),eo=null):ew.push(ed)}null!==eo&&ec.set(eo,"")}else"object"==typeof location?(ec=ed.Ue(),(location.search||"?").slice(1).split("&").forEach(ei=>{if(0!==ei.length){let[eo,ea]=ei.split("=");ec.set(`--${eu.NF(eo,"-")}`,ea),ec.set(`-${eu.NF(eo,"-")}`,ea)}})):ec=ed.Ue()}return ec},eT=ei=>e_().has(ei),eI=ei=>eS?eh(eb.env[ei.toUpperCase()]):eh(em.getItem(ei)),eC=ei=>eT("--"+ei)||null!==eI(ei);eC("production");let eO=eS&&ey.gB(eb.env.FORCE_COLOR,["true","1","2"]),eR=!eT("no-colors")&&(!eS||eb.stdout.isTTY||eO)&&(!eS||eT("color")||eO||null!==eI("COLORTERM")||(eI("TERM")||"").includes("color"))},3562:function(ei,eo,ea){"use strict";ea.d(eo,{Nw:function(){return ed},Ue:function(){return ec},zR:function(){return eu}});let ec=ei=>Error(ei),ed=()=>{throw ec("Method unimplemented")},eu=()=>{throw ec("Unexpected case")}},1351:function(ei,eo,ea){"use strict";ea.d(eo,{PP:function(){return ec},gB:function(){return ef},id:function(){return ed}});let ec=(ei,eo,ea=0)=>{try{for(;ea<ei.length;ea++)ei[ea](...eo)}finally{ea<ei.length&&ec(ei,eo,ea+1)}},ed=ei=>ei,eu=(ei,eo)=>ei===eo,eh=(ei,eo)=>{if(null==ei||null==eo)return eu(ei,eo);if(ei.constructor!==eo.constructor)return!1;if(ei===eo)return!0;switch(ei.constructor){case ArrayBuffer:ei=new Uint8Array(ei),eo=new Uint8Array(eo);case Uint8Array:if(ei.byteLength!==eo.byteLength)return!1;for(let ea=0;ea<ei.length;ea++)if(ei[ea]!==eo[ea])return!1;break;case Set:if(ei.size!==eo.size)return!1;for(let ea of ei)if(!eo.has(ea))return!1;break;case Map:if(ei.size!==eo.size)return!1;for(let ea of ei.keys())if(!eo.has(ea)||!eh(ei.get(ea),eo.get(ea)))return!1;break;case Object:if(object.length(ei)!==object.length(eo))return!1;for(let ea in ei)if(!object.hasProperty(ei,ea)||!eh(ei[ea],eo[ea]))return!1;break;case Array:if(ei.length!==eo.length)return!1;for(let ea=0;ea<ei.length;ea++)if(!eh(ei[ea],eo[ea]))return!1;break;default:return!1}return!0},ef=(ei,eo)=>eo.includes(ei)},1111:function(ei,eo,ea){"use strict";ea.d(eo,{BG:function(){return ed},CA:function(){return eu}});let ec=ei=>({[Symbol.iterator](){return this},next:ei}),ed=(ei,eo)=>ec(()=>{let ea;do ea=ei.next();while(!ea.done&&!eo(ea.value));return ea}),eu=(ei,eo)=>ec(()=>{let{done:ea,value:ec}=ei.next();return{done:ea,value:ea?void 0:eo(ec)}})},8730:function(ei,eo,ea){"use strict";ea.d(eo,{Ej:function(){return ef},Pl:function(){return eu},ZA:function(){return eg},s7:function(){return ep},ud:function(){return eb},Wd:function(){return ey},hM:function(){return em},YW:function(){return eh},WO:function(){return eS},_X:function(){return eE}});let ec=Symbol,ed=Date.now,eu=ec(),eh=ec(),ef=ec(),ep=ec(),eg=ec(),em=ec(),ey=ec(),eb=ec(),eS=ec(),eE=ei=>{let eo=[],ea=[],ec=0;for(;ec<ei.length;ec++){let ed=ei[ec];ed.constructor===String||ed.constructor===Number?eo.push(ed):ed.constructor===Object&&ea.push(JSON.stringify(ed))}return ea};ed()},2860:function(ei,eo,ea){"use strict";ea.d(eo,{S0:function(){return eE}});var ec=ea(8211),ed=ea(5064);class eu{constructor(ei,eo){this.left=ei,this.right=eo}}let eh=(ei,eo)=>new eu(ei,eo);var ef=ea(9805);let ep="undefined"!=typeof document?document:{};"undefined"!=typeof DOMParser&&new DOMParser;let eg=ei=>ef.UI(ei,(ei,eo)=>`${eo}:${ei};`).join("");ep.ELEMENT_NODE,ep.TEXT_NODE,ep.CDATA_SECTION_NODE,ep.COMMENT_NODE,ep.DOCUMENT_NODE,ep.DOCUMENT_TYPE_NODE,ep.DOCUMENT_FRAGMENT_NODE;var em=ea(8730);let ey={[em.Pl]:eh("font-weight","bold"),[em.YW]:eh("font-weight","normal"),[em.Ej]:eh("color","blue"),[em.ZA]:eh("color","green"),[em.s7]:eh("color","grey"),[em.hM]:eh("color","red"),[em.Wd]:eh("color","purple"),[em.ud]:eh("color","orange"),[em.WO]:eh("color","black")},eb=ei=>{let eo=[],ea=[],ec=ef.Ue(),ed=[],eu=0;for(;eu<ei.length;eu++){let ed=ei[eu],eh=ey[ed];if(void 0!==eh)ec.set(eh.left,eh.right);else if(ed.constructor===String||ed.constructor===Number){let ei=eg(ec);eu>0||ei.length>0?(eo.push("%c"+ed),ea.push(ei)):eo.push(ed)}else break}for(eu>0&&(ed=ea).unshift(eo.join(""));eu<ei.length;eu++){let eo=ei[eu];eo instanceof Symbol||ed.push(eo)}return ed},eS=ec.hH?eb:em._X,eE=(...ei)=>{console.log(...eS(ei)),ew.forEach(eo=>eo.print(ei))},ew=ed.Ue()},9805:function(ei,eo,ea){"use strict";ea.d(eo,{JG:function(){return ed},UI:function(){return eh},Ue:function(){return ec},Yj:function(){return ef},Yu:function(){return eu}});let ec=()=>new Map,ed=ei=>{let eo=ec();return ei.forEach((ei,ea)=>{eo.set(ea,ei)}),eo},eu=(ei,eo,ea)=>{let ec=ei.get(eo);return void 0===ec&&ei.set(eo,ec=ea()),ec},eh=(ei,eo)=>{let ea=[];for(let[ec,ed]of ei)ea.push(eo(ed,ec));return ea},ef=(ei,eo)=>{for(let[ea,ec]of ei)if(eo(ec,ea))return!0;return!1}},909:function(ei,eo,ea){"use strict";ea.d(eo,{Fp:function(){return eh},GR:function(){return ef},GW:function(){return ec},VV:function(){return eu},Wn:function(){return ed}});let ec=Math.floor,ed=Math.abs,eu=(ei,eo)=>ei<eo?ei:eo,eh=(ei,eo)=>ei>eo?ei:eo,ef=ei=>0!==ei?ei<0:1/ei<0},7615:function(ei,eo,ea){"use strict";ea.d(eo,{U:function(){return eh},YM:function(){return eu}});var ec=ea(909),ed=ea(6399);let eu=Number.MAX_SAFE_INTEGER;ed.RP;let eh=Number.isInteger||(ei=>"number"==typeof ei&&isFinite(ei)&&ec.GW(ei)===ei)},9776:function(ei,eo,ea){"use strict";ea.d(eo,{$m:function(){return em},Ed:function(){return eu},f0:function(){return ec},xb:function(){return ef}});let ec=Object.assign,ed=Object.keys,eu=(ei,eo)=>{for(let ea in ei)eo(ei[ea],ea)},eh=ei=>ed(ei).length,ef=ei=>{for(let eo in ei)return!1;return!0},ep=(ei,eo)=>{for(let ea in ei)if(!eo(ei[ea],ea))return!1;return!0},eg=(ei,eo)=>Object.prototype.hasOwnProperty.call(ei,eo),em=(ei,eo)=>ei===eo||eh(ei)===eh(eo)&&ep(ei,(ei,ea)=>(void 0!==ei||eg(eo,ea))&&eo[ea]===ei)},6320:function(ei,eo,ea){"use strict";ea.d(eo,{y:function(){return eh}});var ec=ea(9805),ed=ea(5064),eu=ea(8974);class eh{constructor(){this._observers=ec.Ue()}on(ei,eo){ec.Yu(this._observers,ei,ed.Ue).add(eo)}once(ei,eo){let ea=(...ec)=>{this.off(ei,ea),eo(...ec)};this.on(ei,ea)}off(ei,eo){let ea=this._observers.get(ei);void 0!==ea&&(ea.delete(eo),0===ea.size&&this._observers.delete(ei))}emit(ei,eo){return eu.Dp((this._observers.get(ei)||ec.Ue()).values()).forEach(ei=>ei(...eo))}destroy(){this._observers=ec.Ue()}}},790:function(ei,eo,ea){"use strict";ea.d(eo,{Ue:function(){return ec}});let ec=ei=>new Promise(ei)},5097:function(ei,eo,ea){"use strict";ea.d(eo,{U7:function(){return ed},k$:function(){return eh}}),crypto.subtle;let ec=crypto.getRandomValues.bind(crypto),ed=()=>ec(new Uint32Array(1))[0],eu="10000000-1000-4000-8000-100000000000",eh=()=>eu.replace(/[018]/g,ei=>(ei^ed()&15>>ei/4).toString(16))},5064:function(ei,eo,ea){"use strict";ea.d(eo,{Ue:function(){return ec}});let ec=()=>new Set},7083:function(ei,eo,ea){"use strict";ea.d(eo,{CO:function(){return eS},IK:function(){return ec},NF:function(){return ep},YZ:function(){return em},lz:function(){return eb}});let ec=String.fromCharCode,ed=ei=>ei.toLowerCase(),eu=/^\s*/g,eh=ei=>ei.replace(eu,""),ef=/([A-Z])/g,ep=(ei,eo)=>eh(ei.replace(ef,ei=>`${eo}${ed(ei)}`)),eg=ei=>{let eo=unescape(encodeURIComponent(ei)),ea=eo.length,ec=new Uint8Array(ea);for(let ei=0;ei<ea;ei++)ec[ei]=eo.codePointAt(ei);return ec},em="undefined"!=typeof TextEncoder?new TextEncoder:null,ey=ei=>em.encode(ei),eb=em?ey:eg,eS="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});eS&&1===eS.decode(new Uint8Array).length&&(eS=null)},7873:function(ei){"use strict";ei.exports=JSON.parse('{"0":"O","1":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDCBF":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD804\uDF00":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD804\uDDCA":"","\uD805\uDCC3":"","\uD802\uDE3A":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDCC1":"","":"","":"","":"","":"","":"","":"","\\u2028":" ","\\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","\xa0":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","\xb8":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","\uD834\uDD6D":".","":".","":".","":".","":".","\uD802\uDE50":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","\uD800\uDD01":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7\xb7\xb7","":"\xb7\xb7\xb7","":"\xb7<","":"\xb7>","":"\xb7>","":"\xb7>","":"\xb74","":"\xb7b","":"\xb7b","":"\xb7d","":"\xb7J","":"\xb7L","":"\xb7P","":"\xb7U","":"\xb7V","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"","":"","":"","":"","":"","":"","\uD802\uDE57":"\uD802\uDE56\uD802\uDE56","\uD805\uDC4C":"\uD805\uDC4B\uD805\uDC4B","\uD805\uDE42":"\uD805\uDE41\uD805\uDE41","\uD807\uDC42":"\uD807\uDC41\uD807\uDC41","":"","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","`":"\'","":"\'","":"\'","\xb4":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","\uD81B\uDF51":"\'","\uD81B\uDF52":"\'","":"\'\'","\\"":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'\'","":"\'\'\'","":"\'\'\'\'","":"\'B","":"\'D","":"\'n","":"\'P","":"\'T","":"\'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","\uD83C\uDD10":"(A)","":"(b)","\uD83C\uDD11":"(B)","":"(c)","\uD83C\uDD12":"(C)","":"(d)","\uD83C\uDD13":"(D)","":"(e)","\uD83C\uDD14":"(E)","":"(f)","\uD83C\uDD15":"(F)","":"(g)","\uD83C\uDD16":"(G)","":"(h)","\uD83C\uDD17":"(H)","":"(i)","":"(j)","\uD83C\uDD19":"(J)","":"(k)","\uD83C\uDD1A":"(K)","":"(l)","\uD83C\uDD18":"(l)","":"(l)","\uD83C\uDD1B":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","\uD83C\uDD1C":"(M)","":"(n)","\uD83C\uDD1D":"(N)","":"(o)","\uD83C\uDD1E":"(O)","":"(p)","\uD83C\uDD1F":"(P)","":"(q)","\uD83C\uDD20":"(Q)","":"(r)","\uD83C\uDD21":"(R)","":"(rn)","":"(s)","\uD83C\uDD22":"(S)","\uD83C\uDD2A":"(S)","":"(t)","\uD83C\uDD23":"(T)","":"(u)","\uD83C\uDD24":"(U)","":"(v)","\uD83C\uDD25":"(V)","":"(w)","\uD83C\uDD26":"(W)","":"(x)","\uD83C\uDD27":"(X)","":"(y)","\uD83C\uDD28":"(Y)","":"(z)","\uD83C\uDD29":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","\uD83C\uDE41":"()","":"()","":"()","\uD83C\uDE42":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","\uD83C\uDE47":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","\uD83C\uDE43":"()","\uD83C\uDE45":"()","\uD83C\uDE48":"()","":"()","":"()","":"()","":"()","\uD83C\uDE40":"()","":"()","":"()","":"()","\uD83C\uDE44":"()","":"()","\uD83C\uDE46":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","\uD834\uDD14":"{","":"}","":"","":"","":"","":"","":"","":"","":"","\uD847\uDFE8":"","":"","":"","":"","":"","":"\xb6","":"*","":"*","":"*","\uD800\uDF1F":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","\uD834\uDE3A":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","\uD834\uDE0F":"\\\\","\uD834\uDE3B":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\\\\\","":"\\\\\\\\","":"\\\\","":"&","":"","\uD804\uDCBB":"","\uD804\uDDC7":"","":"","\uD804\uDDDB":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","\xaf":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0C","":"\xb0F","":"","":"","":"","":"","":"","":"\xa9","":"\xae","":"","\uD834\uDE1B":"","":"","":"","":"","":"","":"","":"","":"","\uD835\uDEDB":"","\uD835\uDF15":"","\uD835\uDF4F":"","\uD835\uDF89":"","\uD835\uDFC3":"","\uD83A\uDCCC":"","\uD83A\uDCCD":"","\xf0":"","":"","\uD835\uDEC1":"","\uD835\uDEFB":"","\uD835\uDF35":"","\uD835\uDF6F":"","\uD835\uDFA9":"","\uD806\uDCA8":"","":"","":"","":"","":"","":"","":"+","":"+","\uD800\uDE9B":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"\xf7","":"<","":"<","":"<","\uD834\uDE36":"<","":"<","":"<","":"<\xb7","":"<\xb7","":"<\xb7","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","\uD834\uDE37":">","":">","\uD81B\uDF3F":">","":">\xb7","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","\uD83A\uDCC8":"","":"","":"","":"","":"","":"","":"","\uD804\uDDDE":"","":"","\uD83D\uDF5E":"","":"","":"","":"","\uD834\uDE38":"","\uD834\uDE39":"","":"","":"","":"","":"","\uD83D\uDF71":"","\uD83D\uDF55":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83D\uDF0A":"","\uD83C\uDF12":"","\uD83C\uDF19":"","":"","\uD83C\uDF18":"","":"","\uD83D\uDF3A":"","":"","\uD800\uDDA0":"","":"\uD834\uDD58\uD834\uDD65","":"\uD834\uDD58\uD834\uDD65\uD834\uDD6E","":"\uD83C\uDD0D","":"\uD83C\uDD0E","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83C\uDD0F":"$","":"\xa3","":"","":"","":"","":"","\uD805\uDCD1":"","":"","":"","":"","":"","":"","\uD835\uDFD0":"2","\uD835\uDFDA":"2","\uD835\uDFE4":"2","\uD835\uDFEE":"2","\uD835\uDFF8":"2","\uD83E\uDFF2":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","\uD805\uDCD2":"","":"","":"","":"2","\uD83C\uDD03":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","\uD834\uDE06":"3","\uD835\uDFD1":"3","\uD835\uDFDB":"3","\uD835\uDFE5":"3","\uD835\uDFEF":"3","\uD835\uDFF9":"3","\uD83E\uDFF3":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","\uD81B\uDF3B":"3","\uD806\uDCCA":"3","":"","\uD83A\uDCC9":"","":"","":"","":"3","\uD83C\uDD04":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","\uD835\uDFD2":"4","\uD835\uDFDC":"4","\uD835\uDFE6":"4","\uD835\uDFF0":"4","\uD835\uDFFA":"4","\uD83E\uDFF4":"4","":"4","\uD806\uDCAF":"4","":"","":"","":"","\uD83C\uDD05":"4,","":"4.","":"4\xb7","":"4","":"4","":"4","\uD835\uDFD3":"5","\uD835\uDFDD":"5","\uD835\uDFE7":"5","\uD835\uDFF1":"5","\uD835\uDFFB":"5","\uD83E\uDFF5":"5","":"5","\uD806\uDCBB":"5","":"","\uD83C\uDD06":"5,","":"5.","":"5","":"5","":"5","\uD835\uDFD4":"6","\uD835\uDFDE":"6","\uD835\uDFE8":"6","\uD835\uDFF2":"6","\uD835\uDFFC":"6","\uD83E\uDFF6":"6","":"6","":"6","":"6","\uD806\uDCD5":"6","":"","\uD805\uDCD6":"","":"","\uD83C\uDD07":"6,","":"6.","":"6","":"6","":"6","\uD834\uDE12":"7","\uD835\uDFD5":"7","\uD835\uDFDF":"7","\uD835\uDFE9":"7","\uD835\uDFF3":"7","\uD835\uDFFD":"7","\uD83E\uDFF7":"7","\uD801\uDCD2":"7","\uD806\uDCC6":"7","":"","\uD83C\uDD08":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","\uD83A\uDCCB":"8","\uD835\uDFD6":"8","\uD835\uDFE0":"8","\uD835\uDFEA":"8","\uD835\uDFF4":"8","\uD835\uDFFE":"8","\uD83E\uDFF8":"8","":"8","":"8","\uD800\uDF1A":"8","":"","":"","\uD83C\uDD09":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","\uD835\uDFD7":"9","\uD835\uDFE1":"9","\uD835\uDFEB":"9","\uD835\uDFF5":"9","\uD835\uDFFF":"9","\uD83E\uDFF9":"9","":"9","":"9","\uD806\uDCCC":"9","\uD806\uDCAC":"9","\uD806\uDCD6":"9","":"","\uD806\uDCE4":"","":"","":"","":"","\uD83C\uDD0A":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","\uD835\uDC1A":"a","\uD835\uDC4E":"a","\uD835\uDC82":"a","\uD835\uDCB6":"a","\uD835\uDCEA":"a","\uD835\uDD1E":"a","\uD835\uDD52":"a","\uD835\uDD86":"a","\uD835\uDDBA":"a","\uD835\uDDEE":"a","\uD835\uDE22":"a","\uD835\uDE56":"a","\uD835\uDE8A":"a","":"a","":"a","\uD835\uDEC2":"a","\uD835\uDEFC":"a","\uD835\uDF36":"a","\uD835\uDF70":"a","\uD835\uDFAA":"a","":"a","":"","":"A","\uD835\uDC00":"A","\uD835\uDC34":"A","\uD835\uDC68":"A","\uD835\uDC9C":"A","\uD835\uDCD0":"A","\uD835\uDD04":"A","\uD835\uDD38":"A","\uD835\uDD6C":"A","\uD835\uDDA0":"A","\uD835\uDDD4":"A","\uD835\uDE08":"A","\uD835\uDE3C":"A","\uD835\uDE70":"A","":"A","\uD835\uDEA8":"A","\uD835\uDEE2":"A","\uD835\uDF1C":"A","\uD835\uDF56":"A","\uD835\uDF90":"A","":"A","":"A","":"A","":"A","\uD81B\uDF40":"A","\uD800\uDEA0":"A","":"a","":"","":"","":"\xe5","":"\xc5","":"","":"a/c","":"a/s","":"aa","":"AA","\xe6":"ae","":"ae","\xc6":"AE","":"AE","":"ao","":"AO","\uD83D\uDF07":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","\uD834\uDE17":"","":"","":"","\uD801\uDC1F":"","\uD835\uDC1B":"b","\uD835\uDC4F":"b","\uD835\uDC83":"b","\uD835\uDCB7":"b","\uD835\uDCEB":"b","\uD835\uDD1F":"b","\uD835\uDD53":"b","\uD835\uDD87":"b","\uD835\uDDBB":"b","\uD835\uDDEF":"b","\uD835\uDE23":"b","\uD835\uDE57":"b","\uD835\uDE8B":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","\uD835\uDC01":"B","\uD835\uDC35":"B","\uD835\uDC69":"B","\uD835\uDCD1":"B","\uD835\uDD05":"B","\uD835\uDD39":"B","\uD835\uDD6D":"B","\uD835\uDDA1":"B","\uD835\uDDD5":"B","\uD835\uDE09":"B","\uD835\uDE3D":"B","\uD835\uDE71":"B","":"B","":"B","\uD835\uDEA9":"B","\uD835\uDEE3":"B","\uD835\uDF1D":"B","\uD835\uDF57":"B","\uD835\uDF91":"B","":"B","":"B","":"B","":"B","\uD800\uDE82":"B","\uD800\uDEA1":"B","\uD800\uDF01":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b\xb7","":"b\xb7","":"b\'","":"bl","":"","":"","":"c","":"c","\uD835\uDC1C":"c","\uD835\uDC50":"c","\uD835\uDC84":"c","\uD835\uDCB8":"c","\uD835\uDCEC":"c","\uD835\uDD20":"c","\uD835\uDD54":"c","\uD835\uDD88":"c","\uD835\uDDBC":"c","\uD835\uDDF0":"c","\uD835\uDE24":"c","\uD835\uDE58":"c","\uD835\uDE8C":"c","":"c","":"c","":"c","":"c","":"c","\uD801\uDC3D":"c","":"","\uD83D\uDF4C":"C","\uD806\uDCF2":"C","\uD806\uDCE9":"C","":"C","":"C","":"C","":"C","\uD835\uDC02":"C","\uD835\uDC36":"C","\uD835\uDC6A":"C","\uD835\uDC9E":"C","\uD835\uDCD2":"C","\uD835\uDD6E":"C","\uD835\uDDA2":"C","\uD835\uDDD6":"C","\uD835\uDE0A":"C","\uD835\uDE3E":"C","\uD835\uDE72":"C","":"C","":"C","":"C","":"C","":"C","\uD800\uDEA2":"C","\uD800\uDF02":"C","\uD801\uDC15":"C","\uD801\uDD1C":"C","\xa2":"c","":"c","":"C","\uD83C\uDD6E":"C","\xe7":"c","":"c","\xc7":"C","":"C","":"C\'","":"c/o","":"c/u","\uD83C\uDD6D":"\\t","":"","":"","":"","":"","\uD835\uDEC6":"","\uD835\uDEDC":"","\uD835\uDF00":"","\uD835\uDF16":"","\uD835\uDF3A":"","\uD835\uDF50":"","\uD835\uDF74":"","\uD835\uDF8A":"","\uD835\uDFAE":"","\uD835\uDFC4":"","":"","":"","":"","":"","\uD806\uDCCE":"","\uD801\uDC29":"","":"","":"","":"","":"","":"","":"","":"d","":"d","\uD835\uDC1D":"d","\uD835\uDC51":"d","\uD835\uDC85":"d","\uD835\uDCB9":"d","\uD835\uDCED":"d","\uD835\uDD21":"d","\uD835\uDD55":"d","\uD835\uDD89":"d","\uD835\uDDBD":"d","\uD835\uDDF1":"d","\uD835\uDE25":"d","\uD835\uDE59":"d","\uD835\uDE8D":"d","":"d","":"d","":"d","":"d","":"D","":"D","\uD835\uDC03":"D","\uD835\uDC37":"D","\uD835\uDC6B":"D","\uD835\uDC9F":"D","\uD835\uDCD3":"D","\uD835\uDD07":"D","\uD835\uDD3B":"D","\uD835\uDD6F":"D","\uD835\uDDA3":"D","\uD835\uDDD7":"D","\uD835\uDE0B":"D","\uD835\uDE3F":"D","\uD835\uDE73":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","\xd0":"D","":"D","":"d","":"","":"d\xb7","":"d\'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","\uD835\uDEC5":"","\uD835\uDEFF":"","\uD835\uDF39":"","\uD835\uDF73":"","\uD835\uDFAD":"","":"","":"","":"e","":"e","":"e","":"e","\uD835\uDC1E":"e","\uD835\uDC52":"e","\uD835\uDC86":"e","\uD835\uDCEE":"e","\uD835\uDD22":"e","\uD835\uDD56":"e","\uD835\uDD8A":"e","\uD835\uDDBE":"e","\uD835\uDDF2":"e","\uD835\uDE26":"e","\uD835\uDE5A":"e","\uD835\uDE8E":"e","":"e","":"e","":"e","":"","":"E","":"E","":"E","\uD835\uDC04":"E","\uD835\uDC38":"E","\uD835\uDC6C":"E","\uD835\uDCD4":"E","\uD835\uDD08":"E","\uD835\uDD3C":"E","\uD835\uDD70":"E","\uD835\uDDA4":"E","\uD835\uDDD8":"E","\uD835\uDE0C":"E","\uD835\uDE40":"E","\uD835\uDE74":"E","":"E","\uD835\uDEAC":"E","\uD835\uDEE6":"E","\uD835\uDF20":"E","\uD835\uDF5A":"E","\uD835\uDF94":"E","":"E","":"E","":"E","":"E","\uD806\uDCA6":"E","\uD806\uDCAE":"E","\uD800\uDE86":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","\uD834\uDE21":"","":"","":"","":"","\uD81B\uDF2D":"","\uD801\uDC01":"","":"","":"","":"","":"","\uD801\uDC42":"","":"","\uD801\uDC2A":"","\uD835\uDC1F":"f","\uD835\uDC53":"f","\uD835\uDC87":"f","\uD835\uDCBB":"f","\uD835\uDCEF":"f","\uD835\uDD23":"f","\uD835\uDD57":"f","\uD835\uDD8B":"f","\uD835\uDDBF":"f","\uD835\uDDF3":"f","\uD835\uDE27":"f","\uD835\uDE5B":"f","\uD835\uDE8F":"f","":"f","":"f","":"f","":"f","":"f","\uD834\uDE13":"F","":"F","\uD835\uDC05":"F","\uD835\uDC39":"F","\uD835\uDC6D":"F","\uD835\uDCD5":"F","\uD835\uDD09":"F","\uD835\uDD3D":"F","\uD835\uDD71":"F","\uD835\uDDA5":"F","\uD835\uDDD9":"F","\uD835\uDE0D":"F","\uD835\uDE41":"F","\uD835\uDE75":"F","":"F","":"F","\uD835\uDFCA":"F","":"F","":"F","\uD806\uDCC2":"F","\uD806\uDCA2":"F","\uD800\uDE87":"F","\uD800\uDEA5":"F","\uD801\uDD25":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","\uD834\uDE30":"","":"","":"g","":"g","\uD835\uDC20":"g","\uD835\uDC54":"g","\uD835\uDC88":"g","\uD835\uDCF0":"g","\uD835\uDD24":"g","\uD835\uDD58":"g","\uD835\uDD8C":"g","\uD835\uDDC0":"g","\uD835\uDDF4":"g","\uD835\uDE28":"g","\uD835\uDE5C":"g","\uD835\uDE90":"g","":"g","":"g","":"g","":"g","\uD835\uDC06":"G","\uD835\uDC3A":"G","\uD835\uDC6E":"G","\uD835\uDCA2":"G","\uD835\uDCD6":"G","\uD835\uDD0A":"G","\uD835\uDD3E":"G","\uD835\uDD72":"G","\uD835\uDDA6":"G","\uD835\uDDDA":"G","\uD835\uDE0E":"G","\uD835\uDE42":"G","\uD835\uDE76":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G\'","":"","":"","":"","":"h","":"h","\uD835\uDC21":"h","\uD835\uDC89":"h","\uD835\uDCBD":"h","\uD835\uDCF1":"h","\uD835\uDD25":"h","\uD835\uDD59":"h","\uD835\uDD8D":"h","\uD835\uDDC1":"h","\uD835\uDDF5":"h","\uD835\uDE29":"h","\uD835\uDE5D":"h","\uD835\uDE91":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","\uD835\uDC07":"H","\uD835\uDC3B":"H","\uD835\uDC6F":"H","\uD835\uDCD7":"H","\uD835\uDD73":"H","\uD835\uDDA7":"H","\uD835\uDDDB":"H","\uD835\uDE0F":"H","\uD835\uDE43":"H","\uD835\uDE77":"H","":"H","\uD835\uDEAE":"H","\uD835\uDEE8":"H","\uD835\uDF22":"H","\uD835\uDF5C":"H","\uD835\uDF96":"H","":"H","":"H","":"H","":"H","":"H","\uD800\uDECF":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","\uD835\uDC22":"i","\uD835\uDC56":"i","\uD835\uDC8A":"i","\uD835\uDCBE":"i","\uD835\uDCF2":"i","\uD835\uDD26":"i","\uD835\uDD5A":"i","\uD835\uDD8E":"i","\uD835\uDDC2":"i","\uD835\uDDF6":"i","\uD835\uDE2A":"i","\uD835\uDE5E":"i","\uD835\uDE92":"i","":"i","\uD835\uDEA4":"i","":"i","":"i","":"i","":"i","":"i","\uD835\uDECA":"i","\uD835\uDF04":"i","\uD835\uDF3E":"i","\uD835\uDF78":"i","\uD835\uDFB2":"i","":"i","":"i","":"i","":"i","":"i","\uD806\uDCC3":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","\uD835\uDC23":"j","\uD835\uDC57":"j","\uD835\uDC8B":"j","\uD835\uDCBF":"j","\uD835\uDCF3":"j","\uD835\uDD27":"j","\uD835\uDD5B":"j","\uD835\uDD8F":"j","\uD835\uDDC3":"j","\uD835\uDDF7":"j","\uD835\uDE2B":"j","\uD835\uDE5F":"j","\uD835\uDE93":"j","":"j","":"j","":"J","\uD835\uDC09":"J","\uD835\uDC3D":"J","\uD835\uDC71":"J","\uD835\uDCA5":"J","\uD835\uDCD9":"J","\uD835\uDD0D":"J","\uD835\uDD41":"J","\uD835\uDD75":"J","\uD835\uDDA9":"J","\uD835\uDDDD":"J","\uD835\uDE11":"J","\uD835\uDE45":"J","\uD835\uDE79":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J\xb7","\uD835\uDEA5":"","":"","":"","\uD835\uDC24":"k","\uD835\uDC58":"k","\uD835\uDC8C":"k","\uD835\uDCC0":"k","\uD835\uDCF4":"k","\uD835\uDD28":"k","\uD835\uDD5C":"k","\uD835\uDD90":"k","\uD835\uDDC4":"k","\uD835\uDDF8":"k","\uD835\uDE2C":"k","\uD835\uDE60":"k","\uD835\uDE94":"k","":"K","":"K","\uD835\uDC0A":"K","\uD835\uDC3E":"K","\uD835\uDC72":"K","\uD835\uDCA6":"K","\uD835\uDCDA":"K","\uD835\uDD0E":"K","\uD835\uDD42":"K","\uD835\uDD76":"K","\uD835\uDDAA":"K","\uD835\uDDDE":"K","\uD835\uDE12":"K","\uD835\uDE46":"K","\uD835\uDE7A":"K","":"K","\uD835\uDEB1":"K","\uD835\uDEEB":"K","\uD835\uDF25":"K","\uD835\uDF5F":"K","\uD835\uDF99":"K","":"K","":"K","":"K","":"K","":"K","\uD801\uDD18":"K","":"k","":"K","":"K","":"K","":"K","":"K","":"K\'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","\uD800\uDF20":"l","\uD83A\uDCC7":"l","\uD835\uDFCF":"l","\uD835\uDFD9":"l","\uD835\uDFE3":"l","\uD835\uDFED":"l","\uD835\uDFF7":"l","\uD83E\uDFF1":"l","I":"l","":"l","":"l","":"l","":"l","\uD835\uDC08":"l","\uD835\uDC3C":"l","\uD835\uDC70":"l","\uD835\uDCD8":"l","\uD835\uDD40":"l","\uD835\uDD74":"l","\uD835\uDDA8":"l","\uD835\uDDDC":"l","\uD835\uDE10":"l","\uD835\uDE44":"l","\uD835\uDE78":"l","":"l","":"l","":"l","":"l","\uD835\uDC25":"l","\uD835\uDC59":"l","\uD835\uDC8D":"l","\uD835\uDCC1":"l","\uD835\uDCF5":"l","\uD835\uDD29":"l","\uD835\uDD5D":"l","\uD835\uDD91":"l","\uD835\uDDC5":"l","\uD835\uDDF9":"l","\uD835\uDE2D":"l","\uD835\uDE61":"l","\uD835\uDE95":"l","":"l","":"l","\uD835\uDEB0":"l","\uD835\uDEEA":"l","\uD835\uDF24":"l","\uD835\uDF5E":"l","\uD835\uDF98":"l","":"l","":"l","":"l","":"l","":"l","":"l","\uD83B\uDE00":"l","\uD83B\uDE80":"l","":"l","":"l","":"l","":"l","":"l","":"l","\uD81B\uDF28":"l","\uD800\uDE8A":"l","\uD800\uDF09":"l","\uD834\uDE2A":"L","":"L","":"L","\uD835\uDC0B":"L","\uD835\uDC3F":"L","\uD835\uDC73":"L","\uD835\uDCDB":"L","\uD835\uDD0F":"L","\uD835\uDD43":"L","\uD835\uDD77":"L","\uD835\uDDAB":"L","\uD835\uDDDF":"L","\uD835\uDE13":"L","\uD835\uDE47":"L","\uD835\uDE7B":"L","":"L","":"L","":"L","":"L","\uD81B\uDF16":"L","\uD806\uDCA3":"L","\uD806\uDCB2":"L","\uD801\uDC1B":"L","\uD801\uDD26":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l\xb7","":"l\xb7","":"l\xb7","\uD83C\uDD02":"l,","":"l.","":"l\'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","\uD800\uDD99":"ll","":"ll.","":"lll","\uD800\uDD98":"llS","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","\uD801\uDC43":"","":"M","":"M","":"M","\uD835\uDC0C":"M","\uD835\uDC40":"M","\uD835\uDC74":"M","\uD835\uDCDC":"M","\uD835\uDD10":"M","\uD835\uDD44":"M","\uD835\uDD78":"M","\uD835\uDDAC":"M","\uD835\uDDE0":"M","\uD835\uDE14":"M","\uD835\uDE48":"M","\uD835\uDE7C":"M","":"M","\uD835\uDEB3":"M","\uD835\uDEED":"M","\uD835\uDF27":"M","\uD835\uDF61":"M","\uD835\uDF9B":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","\uD800\uDEB0":"M","\uD800\uDF11":"M","":"M","\uD83D\uDF6B":"MB","":"","\uD835\uDC27":"n","\uD835\uDC5B":"n","\uD835\uDC8F":"n","\uD835\uDCC3":"n","\uD835\uDCF7":"n","\uD835\uDD2B":"n","\uD835\uDD5F":"n","\uD835\uDD93":"n","\uD835\uDDC7":"n","\uD835\uDDFB":"n","\uD835\uDE2F":"n","\uD835\uDE63":"n","\uD835\uDE97":"n","":"n","":"n","":"N","":"N","\uD835\uDC0D":"N","\uD835\uDC41":"N","\uD835\uDC75":"N","\uD835\uDCA9":"N","\uD835\uDCDD":"N","\uD835\uDD11":"N","\uD835\uDD79":"N","\uD835\uDDAD":"N","\uD835\uDDE1":"N","\uD835\uDE15":"N","\uD835\uDE49":"N","\uD835\uDE7D":"N","":"N","\uD835\uDEB4":"N","\uD835\uDEEE":"N","\uD835\uDF28":"N","\uD835\uDF62":"N","\uD835\uDF9C":"N","":"N","":"N","\uD801\uDD13":"N","\uD800\uDD8E":"N","":"n","":"n","":"n","\uD835\uDEC8":"n","\uD835\uDF02":"n","\uD835\uDF3C":"n","\uD835\uDF76":"n","\uD835\uDFB0":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","\uD801\uDC4D":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","\uD835\uDC28":"o","\uD835\uDC5C":"o","\uD835\uDC90":"o","\uD835\uDCF8":"o","\uD835\uDD2C":"o","\uD835\uDD60":"o","\uD835\uDD94":"o","\uD835\uDDC8":"o","\uD835\uDDFC":"o","\uD835\uDE30":"o","\uD835\uDE64":"o","\uD835\uDE98":"o","":"o","":"o","":"o","":"o","\uD835\uDED0":"o","\uD835\uDF0A":"o","\uD835\uDF44":"o","\uD835\uDF7E":"o","\uD835\uDFB8":"o","":"o","\uD835\uDED4":"o","\uD835\uDF0E":"o","\uD835\uDF48":"o","\uD835\uDF82":"o","\uD835\uDFBC":"o","":"o","":"o","":"o","":"o","":"o","":"o","\uD83B\uDE24":"o","\uD83B\uDE64":"o","\uD83B\uDE84":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","\uD801\uDCEA":"o","\uD806\uDCC8":"o","\uD806\uDCD7":"o","\uD801\uDC2C":"o","":"O","":"O","":"O","":"O","\uD805\uDCD0":"O","\uD806\uDCE0":"O","\uD835\uDFCE":"O","\uD835\uDFD8":"O","\uD835\uDFE2":"O","\uD835\uDFEC":"O","\uD835\uDFF6":"O","\uD83E\uDFF0":"O","":"O","\uD835\uDC0E":"O","\uD835\uDC42":"O","\uD835\uDC76":"O","\uD835\uDCAA":"O","\uD835\uDCDE":"O","\uD835\uDD12":"O","\uD835\uDD46":"O","\uD835\uDD7A":"O","\uD835\uDDAE":"O","\uD835\uDDE2":"O","\uD835\uDE16":"O","\uD835\uDE4A":"O","\uD835\uDE7E":"O","":"O","\uD835\uDEB6":"O","\uD835\uDEF0":"O","\uD835\uDF2A":"O","\uD835\uDF64":"O","\uD835\uDF9E":"O","":"O","":"O","":"O","":"O","":"O","":"O","\uD801\uDCC2":"O","":"O","\uD806\uDCB5":"O","\uD800\uDE92":"O","\uD800\uDEAB":"O","\uD801\uDC04":"O","\uD801\uDD16":"O","":"\xba","":"\xba","":"","":"","":"o","":"\xd6","\xf8":"o","":"o","\xd8":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","\uD834\uDE1A":"O","\uD83D\uDF14":"O","":"O","":"O","":"O","":"O","\uD835\uDEC9":"O","\uD835\uDEDD":"O","\uD835\uDF03":"O","\uD835\uDF17":"O","\uD835\uDF3D":"O","\uD835\uDF51":"O","\uD835\uDF77":"O","\uD835\uDF8B":"O","\uD835\uDFB1":"O","\uD835\uDFC5":"O","":"O","":"O","\uD835\uDEAF":"O","\uD835\uDEB9":"O","\uD835\uDEE9":"O","\uD835\uDEF3":"O","\uD835\uDF23":"O","\uD835\uDF2D":"O","\uD835\uDF5D":"O","\uD835\uDF67":"O","\uD835\uDF97":"O","\uD835\uDFA1":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","\uD83C\uDD01":"O,","\uD83C\uDD00":"O.","":"o\'","":"O\'","":"O\'","%":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","\uD801\uDC4B":"","":"","":"","":"","\uD801\uDC23":"","":"","":"e","\uD801\uDC3F":"","":"p","":"p","\uD835\uDC29":"p","\uD835\uDC5D":"p","\uD835\uDC91":"p","\uD835\uDCC5":"p","\uD835\uDCF9":"p","\uD835\uDD2D":"p","\uD835\uDD61":"p","\uD835\uDD95":"p","\uD835\uDDC9":"p","\uD835\uDDFD":"p","\uD835\uDE31":"p","\uD835\uDE65":"p","\uD835\uDE99":"p","":"p","":"p","\uD835\uDED2":"p","\uD835\uDEE0":"p","\uD835\uDF0C":"p","\uD835\uDF1A":"p","\uD835\uDF46":"p","\uD835\uDF54":"p","\uD835\uDF80":"p","\uD835\uDF8E":"p","\uD835\uDFBA":"p","\uD835\uDFC8":"p","":"p","":"p","":"P","":"P","\uD835\uDC0F":"P","\uD835\uDC43":"P","\uD835\uDC77":"P","\uD835\uDCAB":"P","\uD835\uDCDF":"P","\uD835\uDD13":"P","\uD835\uDD7B":"P","\uD835\uDDAF":"P","\uD835\uDDE3":"P","\uD835\uDE17":"P","\uD835\uDE4B":"P","\uD835\uDE7F":"P","":"P","\uD835\uDEB8":"P","\uD835\uDEF2":"P","\uD835\uDF2C":"P","\uD835\uDF66":"P","\uD835\uDFA0":"P","":"P","":"P","":"P","":"P","":"P","\uD800\uDE95":"P","":"p","":"p","":"p\xb7","":"P\'","":"","":"","":"","":"","\uD835\uDED7":"","\uD835\uDEDF":"","\uD835\uDF11":"","\uD835\uDF19":"","\uD835\uDF4B":"","\uD835\uDF53":"","\uD835\uDF85":"","\uD835\uDF8D":"","\uD835\uDFBF":"","\uD835\uDFC7":"","":"","":"","\uD835\uDC2A":"q","\uD835\uDC5E":"q","\uD835\uDC92":"q","\uD835\uDCC6":"q","\uD835\uDCFA":"q","\uD835\uDD2E":"q","\uD835\uDD62":"q","\uD835\uDD96":"q","\uD835\uDDCA":"q","\uD835\uDDFE":"q","\uD835\uDE32":"q","\uD835\uDE66":"q","\uD835\uDE9A":"q","":"q","":"q","":"q","":"Q","\uD835\uDC10":"Q","\uD835\uDC44":"Q","\uD835\uDC78":"Q","\uD835\uDCAC":"Q","\uD835\uDCE0":"Q","\uD835\uDD14":"Q","\uD835\uDD7C":"Q","\uD835\uDDB0":"Q","\uD835\uDDE4":"Q","\uD835\uDE18":"Q","\uD835\uDE4C":"Q","\uD835\uDE80":"Q","":"Q","":"q","\uD83D\uDF00":"QE","":"","":"","":"","":"","\uD835\uDECB":"","\uD835\uDEDE":"","\uD835\uDF05":"","\uD835\uDF18":"","\uD835\uDF3F":"","\uD835\uDF52":"","\uD835\uDF79":"","\uD835\uDF8C":"","\uD835\uDFB3":"","\uD835\uDFC6":"","":"","":"","":"","":"","":"","\uD835\uDC2B":"r","\uD835\uDC5F":"r","\uD835\uDC93":"r","\uD835\uDCC7":"r","\uD835\uDCFB":"r","\uD835\uDD2F":"r","\uD835\uDD63":"r","\uD835\uDD97":"r","\uD835\uDDCB":"r","\uD835\uDDFF":"r","\uD835\uDE33":"r","\uD835\uDE67":"r","\uD835\uDE9B":"r","":"r","":"r","":"r","":"r","":"r","":"r","\uD834\uDE16":"R","":"R","":"R","":"R","\uD835\uDC11":"R","\uD835\uDC45":"R","\uD835\uDC79":"R","\uD835\uDCE1":"R","\uD835\uDD7D":"R","\uD835\uDDB1":"R","\uD835\uDDE5":"R","\uD835\uDE19":"R","\uD835\uDE4D":"R","\uD835\uDE81":"R","":"R","":"R","":"R","\uD801\uDCB4":"R","":"R","":"R","\uD81B\uDF35":"R","":"r","":"r","":"r","":"r","":"r","":"r\'","\uD806\uDCE3":"rn","m":"rn","":"rn","\uD835\uDC26":"rn","\uD835\uDC5A":"rn","\uD835\uDC8E":"rn","\uD835\uDCC2":"rn","\uD835\uDCF6":"rn","\uD835\uDD2A":"rn","\uD835\uDD5E":"rn","\uD835\uDD92":"rn","\uD835\uDDC6":"rn","\uD835\uDDFA":"rn","\uD835\uDE2E":"rn","\uD835\uDE62":"rn","\uD835\uDE96":"rn","\uD805\uDF00":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"","":"","":"s","\uD835\uDC2C":"s","\uD835\uDC60":"s","\uD835\uDC94":"s","\uD835\uDCC8":"s","\uD835\uDCFC":"s","\uD835\uDD30":"s","\uD835\uDD64":"s","\uD835\uDD98":"s","\uD835\uDDCC":"s","\uD835\uDE00":"s","\uD835\uDE34":"s","\uD835\uDE68":"s","\uD835\uDE9C":"s","":"s","":"s","":"s","":"s","\uD806\uDCC1":"s","\uD801\uDC48":"s","":"S","\uD835\uDC12":"S","\uD835\uDC46":"S","\uD835\uDC7A":"S","\uD835\uDCAE":"S","\uD835\uDCE2":"S","\uD835\uDD16":"S","\uD835\uDD4A":"S","\uD835\uDD7E":"S","\uD835\uDDB2":"S","\uD835\uDDE6":"S","\uD835\uDE1A":"S","\uD835\uDE4E":"S","\uD835\uDE82":"S","":"S","":"S","":"S","":"S","":"S","\uD81B\uDF3A":"S","\uD800\uDE96":"S","\uD801\uDC20":"S","":"s","":"s","":"\xdf","":"\xdf","":"\xdf","\uD835\uDEC3":"\xdf","\uD835\uDEFD":"\xdf","\uD835\uDF37":"\xdf","\uD835\uDF71":"\xdf","\uD835\uDFAB":"\xdf","":"\xdf","\uD83D\uDF5C":"sss","":"st","":"","":"","":"","":"","":"","\uD835\uDEBA":"","\uD835\uDEF4":"","\uD835\uDF2E":"","\uD835\uDF68":"","\uD835\uDFA2":"","":"","":"","":"","":"","\uD835\uDC2D":"t","\uD835\uDC61":"t","\uD835\uDC95":"t","\uD835\uDCC9":"t","\uD835\uDCFD":"t","\uD835\uDD31":"t","\uD835\uDD65":"t","\uD835\uDD99":"t","\uD835\uDDCD":"t","\uD835\uDE01":"t","\uD835\uDE35":"t","\uD835\uDE69":"t","\uD835\uDE9D":"t","":"T","":"T","\uD83D\uDF68":"T","":"T","\uD835\uDC13":"T","\uD835\uDC47":"T","\uD835\uDC7B":"T","\uD835\uDCAF":"T","\uD835\uDCE3":"T","\uD835\uDD17":"T","\uD835\uDD4B":"T","\uD835\uDD7F":"T","\uD835\uDDB3":"T","\uD835\uDDE7":"T","\uD835\uDE1B":"T","\uD835\uDE4F":"T","\uD835\uDE83":"T","":"T","\uD835\uDEBB":"T","\uD835\uDEF5":"T","\uD835\uDF2F":"T","\uD835\uDF69":"T","\uD835\uDFA3":"T","":"T","":"T","":"T","":"T","\uD81B\uDF0A":"T","\uD806\uDCBC":"T","\uD800\uDE97":"T","\uD800\uDEB1":"T","\uD800\uDF15":"T","":"t","":"T","":"T","":"","":"T","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","\uD835\uDED5":"","\uD835\uDF0F":"","\uD835\uDF49":"","\uD835\uDF83":"","\uD835\uDFBD":"","":"","":"","":"","":"","":"","":"","\uD835\uDC2E":"u","\uD835\uDC62":"u","\uD835\uDC96":"u","\uD835\uDCCA":"u","\uD835\uDCFE":"u","\uD835\uDD32":"u","\uD835\uDD66":"u","\uD835\uDD9A":"u","\uD835\uDDCE":"u","\uD835\uDE02":"u","\uD835\uDE36":"u","\uD835\uDE6A":"u","\uD835\uDE9E":"u","":"u","":"u","":"u","":"u","":"u","":"u","\uD835\uDED6":"u","\uD835\uDF10":"u","\uD835\uDF4A":"u","\uD835\uDF84":"u","\uD835\uDFBE":"u","":"u","\uD801\uDCF6":"u","\uD806\uDCD8":"u","":"U","":"U","\uD835\uDC14":"U","\uD835\uDC48":"U","\uD835\uDC7C":"U","\uD835\uDCB0":"U","\uD835\uDCE4":"U","\uD835\uDD18":"U","\uD835\uDD4C":"U","\uD835\uDD80":"U","\uD835\uDDB4":"U","\uD835\uDDE8":"U","\uD835\uDE1C":"U","\uD835\uDE50":"U","\uD835\uDE84":"U","":"U","":"U","\uD801\uDCCE":"U","":"U","":"U","\uD81B\uDF42":"U","\uD806\uDCB8":"U","":"","":"","":"u","":"u","":"U","":"U","":"U\xb7","":"U\'","":"ue","":"uo","":"","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","\uD835\uDC2F":"v","\uD835\uDC63":"v","\uD835\uDC97":"v","\uD835\uDCCB":"v","\uD835\uDCFF":"v","\uD835\uDD33":"v","\uD835\uDD67":"v","\uD835\uDD9B":"v","\uD835\uDDCF":"v","\uD835\uDE03":"v","\uD835\uDE37":"v","\uD835\uDE6B":"v","\uD835\uDE9F":"v","":"v","":"v","\uD835\uDECE":"v","\uD835\uDF08":"v","\uD835\uDF42":"v","\uD835\uDF7C":"v","\uD835\uDFB6":"v","":"v","":"v","\uD805\uDF06":"v","":"v","\uD806\uDCC0":"v","\uD834\uDE0D":"V","":"V","":"V","":"V","\uD835\uDC15":"V","\uD835\uDC49":"V","\uD835\uDC7D":"V","\uD835\uDCB1":"V","\uD835\uDCE5":"V","\uD835\uDD19":"V","\uD835\uDD4D":"V","\uD835\uDD81":"V","\uD835\uDDB5":"V","\uD835\uDDE9":"V","\uD835\uDE1D":"V","\uD835\uDE51":"V","\uD835\uDE85":"V","":"V","":"V","":"V","":"V","":"V","":"V","\uD81B\uDF08":"V","\uD806\uDCA0":"V","\uD801\uDD1D":"V","\uD800\uDD97":"V","":"V\xb7","\uD83D\uDF6C":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","\uD83D\uDF08":"V","":"","\uD801\uDCD8":"","":"","":"","":"","\uD835\uDEB2":"","\uD835\uDEEC":"","\uD835\uDF26":"","\uD835\uDF60":"","\uD835\uDF9A":"","":"","":"","\uD801\uDCB0":"","":"","":"","":"","\uD81B\uDF3D":"","\uD800\uDE8D":"","":"","":"\xb7","":"w","\uD835\uDC30":"w","\uD835\uDC64":"w","\uD835\uDC98":"w","\uD835\uDCCC":"w","\uD835\uDD00":"w","\uD835\uDD34":"w","\uD835\uDD68":"w","\uD835\uDD9C":"w","\uD835\uDDD0":"w","\uD835\uDE04":"w","\uD835\uDE38":"w","\uD835\uDE6C":"w","\uD835\uDEA0":"w","":"w","":"w","":"w","":"w","\uD805\uDF0A":"w","\uD805\uDF0E":"w","\uD805\uDF0F":"w","":"w","\uD806\uDCEF":"W","\uD806\uDCE6":"W","\uD835\uDC16":"W","\uD835\uDC4A":"W","\uD835\uDC7E":"W","\uD835\uDCB2":"W","\uD835\uDCE6":"W","\uD835\uDD1A":"W","\uD835\uDD4E":"W","\uD835\uDD82":"W","\uD835\uDDB6":"W","\uD835\uDDEA":"W","\uD835\uDE1E":"W","\uD835\uDE52":"W","\uD835\uDE86":"W","":"W","":"W","":"W","":"W","":"w","\uD805\uDCC5":"w","":"W","":"w","":"","":"","":"","":"","":"x","\xd7":"x","":"x","":"x","":"x","":"x","":"x","\uD835\uDC31":"x","\uD835\uDC65":"x","\uD835\uDC99":"x","\uD835\uDCCD":"x","\uD835\uDD01":"x","\uD835\uDD35":"x","\uD835\uDD69":"x","\uD835\uDD9D":"x","\uD835\uDDD1":"x","\uD835\uDE05":"x","\uD835\uDE39":"x","\uD835\uDE6D":"x","\uD835\uDEA1":"x","":"x","":"x","":"x","":"","":"X","":"X","\uD800\uDF22":"X","\uD806\uDCEC":"X","":"X","":"X","\uD835\uDC17":"X","\uD835\uDC4B":"X","\uD835\uDC7F":"X","\uD835\uDCB3":"X","\uD835\uDCE7":"X","\uD835\uDD1B":"X","\uD835\uDD4F":"X","\uD835\uDD83":"X","\uD835\uDDB7":"X","\uD835\uDDEB":"X","\uD835\uDE1F":"X","\uD835\uDE53":"X","\uD835\uDE87":"X","":"X","":"X","\uD835\uDEBE":"X","\uD835\uDEF8":"X","\uD835\uDF32":"X","\uD835\uDF6C":"X","\uD835\uDFA6":"X","":"X","":"X","":"X","":"X","":"X","\uD800\uDE90":"X","\uD800\uDEB4":"X","\uD800\uDF17":"X","\uD801\uDD27":"X","":"x","":"X","\uD800\uDD96":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","\uD835\uDC32":"y","\uD835\uDC66":"y","\uD835\uDC9A":"y","\uD835\uDCCE":"y","\uD835\uDD02":"y","\uD835\uDD36":"y","\uD835\uDD6A":"y","\uD835\uDD9E":"y","\uD835\uDDD2":"y","\uD835\uDE06":"y","\uD835\uDE3A":"y","\uD835\uDE6E":"y","\uD835\uDEA2":"y","":"y","":"y","":"y","":"y","":"y","\uD835\uDEC4":"y","\uD835\uDEFE":"y","\uD835\uDF38":"y","\uD835\uDF72":"y","\uD835\uDFAC":"y","":"y","":"y","":"y","\uD806\uDCDC":"y","":"Y","\uD835\uDC18":"Y","\uD835\uDC4C":"Y","\uD835\uDC80":"Y","\uD835\uDCB4":"Y","\uD835\uDCE8":"Y","\uD835\uDD1C":"Y","\uD835\uDD50":"Y","\uD835\uDD84":"Y","\uD835\uDDB8":"Y","\uD835\uDDEC":"Y","\uD835\uDE20":"Y","\uD835\uDE54":"Y","\uD835\uDE88":"Y","":"Y","":"Y","\uD835\uDEBC":"Y","\uD835\uDEF6":"Y","\uD835\uDF30":"Y","\uD835\uDF6A":"Y","\uD835\uDFA4":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","\uD81B\uDF43":"Y","\uD806\uDCA4":"Y","\uD800\uDEB2":"Y","":"y","":"y","":"y","\xa5":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","\uD835\uDC33":"z","\uD835\uDC67":"z","\uD835\uDC9B":"z","\uD835\uDCCF":"z","\uD835\uDD03":"z","\uD835\uDD37":"z","\uD835\uDD6B":"z","\uD835\uDD9F":"z","\uD835\uDDD3":"z","\uD835\uDE07":"z","\uD835\uDE3B":"z","\uD835\uDE6F":"z","\uD835\uDEA3":"z","":"z","":"z","\uD806\uDCC4":"z","\uD800\uDEF5":"Z","\uD806\uDCE5":"Z","":"Z","":"Z","":"Z","\uD835\uDC19":"Z","\uD835\uDC4D":"Z","\uD835\uDC81":"Z","\uD835\uDCB5":"Z","\uD835\uDCE9":"Z","\uD835\uDD85":"Z","\uD835\uDDB9":"Z","\uD835\uDDED":"Z","\uD835\uDE21":"Z","\uD835\uDE55":"Z","\uD835\uDE89":"Z","":"Z","\uD835\uDEAD":"Z","\uD835\uDEE7":"Z","\uD835\uDF21":"Z","\uD835\uDF5B":"Z","\uD835\uDF95":"Z","":"Z","":"Z","\uD806\uDCA9":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"\xfe","":"\xfe","":"\xde","\uD801\uDCC4":"\xde","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","\uD801\uDCC3":"","":"","\uD835\uDEAA":"","\uD835\uDEE4":"","\uD835\uDF1E":"","\uD835\uDF58":"","\uD835\uDF92":"","":"","":"","":"","":"","\uD81B\uDF07":"","":"","":"\xb7","":"\'","":"","":"","\uD83D\uDF02":"","\uD835\uDEAB":"","\uD835\uDEE5":"","\uD835\uDF1F":"","\uD835\uDF59":"","\uD835\uDF93":"","":"","":"","":"","\uD81B\uDF1A":"","\uD800\uDE85":"","\uD800\uDEA3":"","":"","":"\xb7","":"","\uD835\uDFCB":"","\uD835\uDEC7":"","\uD835\uDF01":"","\uD835\uDF3B":"","\uD835\uDF75":"","\uD835\uDFAF":"","":"","\uD835\uDECC":"","\uD835\uDF06":"","\uD835\uDF40":"","\uD835\uDF7A":"","\uD835\uDFB4":"","":"","\uD801\uDCDB":"","\xb5":"","\uD835\uDECD":"","\uD835\uDF07":"","\uD835\uDF41":"","\uD835\uDF7B":"","\uD835\uDFB5":"","\uD835\uDECF":"","\uD835\uDF09":"","\uD835\uDF43":"","\uD835\uDF7D":"","\uD835\uDFB7":"","\uD835\uDEB5":"","\uD835\uDEEF":"","\uD835\uDF29":"","\uD835\uDF63":"","\uD835\uDF9D":"","":"","":"","\uD835\uDED1":"","\uD835\uDEE1":"","\uD835\uDF0B":"","\uD835\uDF1B":"","\uD835\uDF45":"","\uD835\uDF55":"","\uD835\uDF7F":"","\uD835\uDF8F":"","\uD835\uDFB9":"","\uD835\uDFC9":"","":"","":"","":"","":"","\uD835\uDEB7":"","\uD835\uDEF1":"","\uD835\uDF2B":"","\uD835\uDF65":"","\uD835\uDF9F":"","":"","":"","":"","\uD800\uDEAD":"","\uD800\uDF12":"","":"","\uD835\uDED3":"","\uD835\uDF0D":"","\uD835\uDF47":"","\uD835\uDF81":"","\uD835\uDFBB":"","\uD835\uDEBD":"","\uD835\uDEF7":"","\uD835\uDF31":"","\uD835\uDF6B":"","\uD835\uDFA5":"","":"","":"","":"","":"","":"","\uD800\uDEB3":"","":"","":"","\uD835\uDED8":"","\uD835\uDF12":"","\uD835\uDF4C":"","\uD835\uDF86":"","\uD835\uDFC0":"","":"","\uD835\uDED9":"","\uD835\uDF13":"","\uD835\uDF4D":"","\uD835\uDF87":"","\uD835\uDFC1":"","":"","\uD801\uDCF9":"","\uD835\uDEBF":"","\uD835\uDEF9":"","\uD835\uDF33":"","\uD835\uDF6D":"","\uD835\uDFA7":"","":"","":"","\uD801\uDCD1":"","":"","\uD800\uDEB5":"","":"","":"","\uD835\uDEDA":"","\uD835\uDF14":"","\uD835\uDF4E":"","\uD835\uDF88":"","\uD835\uDFC2":"","":"","":"","":"","\uD835\uDEC0":"","\uD835\uDEFA":"","\uD835\uDF34":"","\uD835\uDF6E":"","\uD835\uDFA8":"","":"","":"","\uD800\uDEB6":"","":"","":"","":"","":"","":"","":"","\uD834\uDE0B":"","":"","":"","\uD801\uDC25":"","":"","":"","":"","":"","\uD801\uDCBC":"","":"","":"","":"","\uD801\uDCEB":"","":"","\uD801\uDCCD":"","\uD834\uDE02":"","\uD834\uDE22":"","":"","":"","":"","":"\xb7","":"","":"","":"","":"","":"","":"","":"l","":"","\uD83D\uDF01":"","\uD81B\uDF1C":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD834\uDE45":"","":"","":"","":"","":"\xb7","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE01":"","\uD83B\uDE21":"","\uD83B\uDE61":"","\uD83B\uDE81":"","\uD83B\uDEA1":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\xf6":"","":"","":"","":"","\uD83B\uDE15":"","\uD83B\uDE35":"","\uD83B\uDE75":"","\uD83B\uDE95":"","\uD83B\uDEB5":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE02":"","\uD83B\uDE22":"","\uD83B\uDE42":"","\uD83B\uDE62":"","\uD83B\uDE82":"","\uD83B\uDEA2":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE07":"","\uD83B\uDE27":"","\uD83B\uDE47":"","\uD83B\uDE67":"","\uD83B\uDE87":"","\uD83B\uDEA7":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE17":"","\uD83B\uDE37":"","\uD83B\uDE57":"","\uD83B\uDE77":"","\uD83B\uDE97":"","\uD83B\uDEB7":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEE1":"","\uD83B\uDE03":"","\uD83B\uDE83":"","\uD83B\uDEA3":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE18":"","\uD83B\uDE98":"","\uD83B\uDEB8":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE13":"","\uD83B\uDE93":"","\uD83B\uDEB3":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","\uD83B\uDE06":"","\uD83B\uDE86":"","\uD83B\uDEA6":"","":"","":"","":"","":"","\uD83B\uDE0E":"","\uD83B\uDE2E":"","\uD83B\uDE4E":"","\uD83B\uDE6E":"","\uD83B\uDE8E":"","\uD83B\uDEAE":"","":"","":"","":"","":"","":"","\uD83B\uDE14":"","\uD83B\uDE34":"","\uD83B\uDE54":"","\uD83B\uDE74":"","\uD83B\uDE94":"","\uD83B\uDEB4":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEF2":"","\uD83B\uDE11":"","\uD83B\uDE31":"","\uD83B\uDE51":"","\uD83B\uDE71":"","\uD83B\uDE91":"","\uD83B\uDEB1":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE19":"","\uD83B\uDE39":"","\uD83B\uDE59":"","\uD83B\uDE79":"","\uD83B\uDE99":"","\uD83B\uDEB9":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEE8":"","\uD83B\uDE08":"","\uD83B\uDE68":"","\uD83B\uDE88":"","\uD83B\uDEA8":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1A":"","\uD83B\uDE7A":"","\uD83B\uDE9A":"","\uD83B\uDEBA":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0F":"","\uD83B\uDE2F":"","\uD83B\uDE4F":"","\uD83B\uDE6F":"","\uD83B\uDE8F":"","\uD83B\uDEAF":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1B":"","\uD83B\uDE3B":"","\uD83B\uDE5B":"","\uD83B\uDE7B":"","\uD83B\uDE9B":"","\uD83B\uDEBB":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE10":"","\uD83B\uDE30":"","\uD83B\uDE70":"","\uD83B\uDE90":"","\uD83B\uDEB0":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1E":"","\uD83B\uDE7E":"","":"","":"","\uD83B\uDE1F":"","\uD83B\uDE5F":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE12":"","\uD83B\uDE32":"","\uD83B\uDE52":"","\uD83B\uDE72":"","\uD83B\uDE92":"","\uD83B\uDEB2":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0A":"","\uD83B\uDE2A":"","\uD83B\uDE6A":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0B":"","\uD83B\uDE2B":"","\uD83B\uDE4B":"","\uD83B\uDE8B":"","\uD83B\uDEAB":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0C":"","\uD83B\uDE2C":"","\uD83B\uDE6C":"","\uD83B\uDE8C":"","\uD83B\uDEAC":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0D":"","\uD83B\uDE2D":"","\uD83B\uDE4D":"","\uD83B\uDE6D":"","\uD83B\uDE8D":"","\uD83B\uDEAD":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEE4":"","\uD83B\uDE05":"","\uD83B\uDE85":"","\uD83B\uDEA5":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1C":"","\uD83B\uDE7C":"","":"","\uD83B\uDE1D":"","\uD83B\uDE5D":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE09":"","\uD83B\uDE29":"","\uD83B\uDE49":"","\uD83B\uDE69":"","\uD83B\uDE89":"","\uD83B\uDEA9":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE16":"","\uD83B\uDE36":"","\uD83B\uDE76":"","\uD83B\uDE96":"","\uD83B\uDEB6":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEB8":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD804\uDDDC":"","\uD804\uDDCB":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDC92":"","\uD805\uDC94":"","\uD805\uDC96":"","\uD805\uDC98":"","\uD805\uDC99":"","\uD805\uDC9B":"","\uD805\uDCAA":"","\uD805\uDC9E":"","\uD805\uDC9F":"","\uD805\uDCA0":"","\uD805\uDCA1":"","\uD805\uDCA2":"","\uD805\uDCA3":"","\uD805\uDCA9":"","\uD805\uDCA7":"","\uD805\uDCA8":"","\uD805\uDCAB":"","\uD805\uDC9D":"","\uD805\uDCAD":"","\uD805\uDCAE":"","\uD805\uDCC4":"","\uD805\uDCB0":"","\uD805\uDCB1":"","\uD805\uDCB9":"","\uD805\uDCBC":"","\uD805\uDCBE":"","\uD805\uDCC2":"","\uD805\uDCBD":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDC13":"\uD805\uDC34\uD805\uDC42\uD805\uDC12","\uD805\uDC19":"\uD805\uDC34\uD805\uDC42\uD805\uDC18","\uD805\uDC24":"\uD805\uDC34\uD805\uDC42\uD805\uDC23","\uD805\uDC2A":"\uD805\uDC34\uD805\uDC42\uD805\uDC29","\uD805\uDC2D":"\uD805\uDC34\uD805\uDC42\uD805\uDC2C","\uD805\uDC2F":"\uD805\uDC34\uD805\uDC42\uD805\uDC2E","\uD805\uDDD8":"\uD805\uDD82","\uD805\uDDD9":"\uD805\uDD82","\uD805\uDDDA":"\uD805\uDD83","\uD805\uDDDB":"\uD805\uDD84","\uD805\uDDDC":"\uD805\uDDB2","\uD805\uDDDD":"\uD805\uDDB3","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD807\uDCB2":"\uD807\uDCAA","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\xb7","":"","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"","":"\xb7","":"","":"","":"","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"","":"","":"\xb7","":"\'","":"/","":"","":"\xb7","":"","":"","":"\xb7","":"\'","":"\xb7","":"\xb7","":"\'","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"<","":"b","":"","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"","":"","":"\xb7","":"b","":"b","":"d","":"P","":"","":"","":"","":"","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"","":"","":"\xb7","":"\xb7","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD834\uDE3F":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83D\uDF54":"","\uD806\uDCB7":"","\uD800\uDE94":"","":"","":"","":"","\uD801\uDCD0":"","":"","\uD803\uDCFC":"\uD803\uDC82","\uD803\uDCFA":"\uD803\uDCA5","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD834\uDE1C":"","":"","":"","":"","":"","\uD834\uDE15":"","\uD834\uDE2B":"","\uD81B\uDF26":"","\uD801\uDC11":"","":"\uD81B\uDF00","\uD806\uDEE6":"\uD806\uDEE5\uD806\uDEEF","\uD806\uDEE8":"\uD806\uDEE5\uD806\uDEE5","\uD806\uDEE9":"\uD806\uDEE5\uD806\uDEE5\uD806\uDEEF","\uD806\uDEEA":"\uD806\uDEE5\uD806\uDEE5\uD806\uDEF0","\uD806\uDEE7":"\uD806\uDEE5\uD806\uDEF0","\uD806\uDEF4":"\uD806\uDEF3\uD806\uDEEF","\uD806\uDEF6":"\uD806\uDEF3\uD806\uDEF3","\uD806\uDEF7":"\uD806\uDEF3\uD806\uDEF3\uD806\uDEEF","\uD806\uDEF8":"\uD806\uDEF3\uD806\uDEF3\uD806\uDEF0","\uD806\uDEF5":"\uD806\uDEF3\uD806\uDEF0","\uD806\uDEEC":"\uD806\uDEEB\uD806\uDEEF","\uD806\uDEED":"\uD806\uDEEB\uD806\uDEEB","\uD806\uDEEE":"\uD806\uDEEB\uD806\uDEEB\uD806\uDEEF","":"\uD800\uDEA8","":"\uD800\uDEA8","\uD83D\uDF28":"\uD800\uDEA8","":"\uD800\uDEA8","":"\uD800\uDEBC","\uD834\uDE14":"\uD800\uDEBC","\uD83D\uDF04":"\uD800\uDEBC","":"\uD800\uDEC0","":"\uD801\uDC3A","":"\uD801\uDC12","\uD801\uDCA0":"\uD801\uDC86","\uD800\uDFD1":"\uD800\uDF82","\uD800\uDFD3":"\uD800\uDF93","\uD808\uDC38":"\uD800\uDF9A","":"\uD802\uDD9E","\uD80C\uDEF9":"\uD802\uDD9E","":"","":"","\uD87E\uDC00":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC01":"","":"","\uD87E\uDC02":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC03":"\uD840\uDD22","":"","":"","":"","":"","":"","":"","\uD87E\uDC19":"","":"","\uD87E\uDC04":"","":"","\uD87E\uDC07":"","":"","":"","":"","":"","\uD87E\uDC05":"","\uD87E\uDC06":"","":"","":"","":"","\uD87E\uDC08":"","\uD87E\uDC09":"","\uD87E\uDC0B":"","":"","":"","\uD87E\uDC0A":"","\uD87E\uDC0C":"","":"","":"","":"","":"","":"","\uD87E\uDC0E":"","\uD87E\uDC0F":"","\uD87E\uDC10":"","":"","\uD87E\uDC14":"","":"","":"","":"","":"","":"","\uD87E\uDC11":"","\uD87E\uDC12":"\uD841\uDD1C","\uD87E\uDD1B":"\uD841\uDD25","":"","\uD87E\uDC13":"","":"","\uD87E\uDC15":"","\uD87E\uDC16":"\uD841\uDD4B","\uD87E\uDCD2":"","\uD87E\uDCD3":"","\uD87E\uDDCA":"","\uD87E\uDCD4":"","":"","\uD87E\uDC17":"","\uD87E\uDC18":"","":"","\uD87E\uDC1A":"","":"","\uD87E\uDC1B":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC0D":"\uD841\uDE3A","\uD87E\uDC1D":"","":"","":"","":"","\uD87E\uDC1E":"","":"","\uD87E\uDC50":"","":"","":"","\uD87E\uDC1F":"","":"","\uD87E\uDC20":"","\uD87E\uDC21":"","\uD87E\uDC22":"","\uD87E\uDC23":"","":"","\uD87E\uDDD9":"\uD842\uDC04","":"","":"","":"","":"","\uD87E\uDC24":"","\uD87E\uDD92":"","":"","\uD87E\uDC25":"","":"","\uD87E\uDC26":"","":"","":"","":"","\uD87E\uDC27":"","":"","":"","":"","\uD87E\uDC28":"","\uD87E\uDC29":"","\uD87E\uDC2A":"","\uD87E\uDDDD":"\uD842\uDCDE","":"","":"","\uD87E\uDC2B":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC2C":"","":"","":"","":"","\uD87E\uDC2D":"","\uD87E\uDC2E":"","":"","":"","":"","":"","\uD87E\uDC2F":"","":"","\uD87E\uDC30":"","\uD87E\uDC31":"","\uD87E\uDC32":"","\uD87E\uDC33":"","":"","\uD87E\uDC34":"\uD842\uDE2C","":"","":"","":"","\uD87E\uDC36":"","\uD87E\uDC37":"","\uD87E\uDC38":"\uD842\uDF63","":"","":"","":"","":"","":"","\uD87E\uDC39":"","\uD87E\uDC3A":"","\uD87E\uDC3B":"","":"","":"","\uD87E\uDC3D":"","":"","\uD87E\uDC3E":"","\uD87E\uDC3F":"","\uD87E\uDC3C":"","\uD87E\uDC40":"","":"","":"","\uD87E\uDC41":"","\uD87E\uDC42":"","\uD87E\uDC43":"","":"","":"","\uD87E\uDC44":"","\uD87E\uDC45":"","\uD87E\uDC46":"","":"","":"","\uD87E\uDC47":"","":"","":"","\uD87E\uDC48":"","\uD87E\uDC49":"","":"","\uD87E\uDC4A":"","":"","":"","\uD87E\uDC4C":"","\uD87E\uDC4E":"","\uD87E\uDC4F":"","":"","":"","\uD87E\uDC4B":"","\uD87E\uDC4D":"","":"","":"","":"","\uD87E\uDC55":"","\uD87E\uDC52":"","":"","\uD87E\uDC53":"","\uD87E\uDC54":"","\uD87E\uDC57":"","\uD87E\uDC56":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC58":"","":"","":"","":"","\uD87E\uDC59":"\uD845\uDCE4","\uD87E\uDC51":"","\uD87E\uDC5A":"","\uD87E\uDC5B":"","":"","\uD87E\uDC5C":"","":"","":"","":"","\uD87E\uDC5D":"","\uD87E\uDC5E":"","":"","":"","":"","":"","":"","\uD87E\uDC5F":"","":"","":"","\uD87E\uDC60":"\uD845\uDEA8","\uD87E\uDC61":"\uD845\uDEEA","\uD87E\uDC65":"","\uD87E\uDC62":"","\uD87E\uDC63":"","\uD87E\uDC64":"","":"","\uD87E\uDC66":"","":"","\uD87E\uDC67":"","\uD87E\uDC68":"","\uD87E\uDD86":"","\uD87E\uDC69":"","":"","\uD87E\uDC6A":"","\uD87E\uDC6B":"","":"","":"","":"","\uD87E\uDC6C":"\uD846\uDDC8","\uD87E\uDC6D":"","\uD87E\uDC6E":"","":"","":"","\uD87E\uDC6F":"","":"","\uD87E\uDC70":"","\uD87E\uDC71":"\uD846\uDF18","":"","\uD87E\uDC72":"","\uD87E\uDC73":"","":"","\uD87E\uDC75":"","":"","":"","":"","\uD87E\uDC76":"","":"","":"","\uD87E\uDC77":"","":"","":"","":"","":"","\uD87E\uDC78":"","":"","\uD87E\uDCF8":"\uD847\uDD0B","":"","\uD87E\uDC79":"","\uD87E\uDC7A":"","\uD87E\uDC7B":"\uD847\uDDE4","\uD87E\uDC7D":"\uD847\uDDE6","":"","\uD87E\uDC7C":"","":"","\uD87E\uDC7F":"","\uD87E\uDC7E":"","\uD87E\uDC80":"","\uD87E\uDDF4":"","":"","":"","\uD87E\uDC82":"","":"","":"","":"","":"","\uD87E\uDC83":"","\uD87E\uDC84":"","":"","":"","\uD87E\uDC85":"","\uD87E\uDC86":"","\uD87E\uDC87":"","\uD87E\uDC88":"","\uD87E\uDC89":"\uD848\uDD83","":"","":"","\uD87E\uDD39":"\uD848\uDD9F","":"","":"","":"","":"","\uD87E\uDC8A":"","\uD87E\uDC8B":"","\uD87E\uDC8C":"","\uD87E\uDC8D":"","":"","\uD87E\uDC8E":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC90":"","":"","\uD87E\uDC91":"\uD848\uDF31","\uD87E\uDC92":"\uD848\uDF31","":"","":"","":"","\uD87E\uDC94":"","\uD87E\uDC95":"","":"","":"","\uD87E\uDC74":"","\uD87E\uDC96":"","":"","\uD87E\uDC99":"","":"","\uD87E\uDC9A":"","":"","":"","\uD87E\uDC9B":"","\uD87E\uDC9C":"","":"","":"","":"","":"","":"","\uD87E\uDC9D":"","\uD87E\uDC9E":"","":"","\uD87E\uDC9F":"","":"","":"","":"","\uD87E\uDCA2":"","\uD87E\uDCA1":"","\uD87E\uDCA0":"","":"","\uD87E\uDCA3":"","\uD87E\uDCA5":"","":"","":"","\uD87E\uDCA4":"\uD849\uDED4","":"","":"","":"","\uD87E\uDCA6":"","\uD87E\uDCA7":"","\uD87E\uDCA9":"","":"","\uD87E\uDCA8":"","":"","\uD87E\uDCAA":"","":"","":"","\uD87E\uDCAB":"","":"","\uD87E\uDCAD":"","\uD87E\uDCAE":"","\uD87E\uDCAC":"","":"\uD84A\uDC44","":"\uD84A\uDC4A","\uD87E\uDCAF":"","":"","":"","\uD87E\uDCB0":"","":"","\uD87E\uDCB1":"","":"","":"","\uD87E\uDCB2":"","\uD87E\uDCB3":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCB4":"","\uD87E\uDCB5":"","":"","":"","":"","\uD87E\uDCB6":"","\uD87E\uDCBA":"","":"","\uD87E\uDCB8":"\uD84A\uDF0C","\uD87E\uDCB9":"","\uD87E\uDCB7":"","\uD87E\uDCBB":"","":"","\uD87E\uDCBC":"","":"","\uD87E\uDCC1":"","":"","\uD87E\uDCBD":"","":"","\uD87E\uDCBE":"\uD84A\uDFF1","":"","\uD87E\uDCBF":"","\uD87E\uDCC0":"","\uD87E\uDCC3":"","\uD87E\uDCC6":"","\uD87E\uDCC4":"","\uD87E\uDCC2":"","":"","":"","\uD87E\uDCC5":"","":"","\uD87E\uDCC7":"","":"","":"","":"","":"","\uD87E\uDCC8":"","":"","\uD87E\uDCC9":"","":"","\uD87E\uDCCA":"\uD84C\uDC0A","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCCB":"","":"","":"","":"","\uD87E\uDCD1":"","\uD87E\uDCCD":"","":"","":"","":"","":"","\uD87E\uDCCF":"","":"","\uD87E\uDCD0":"","\uD87E\uDCD5":"","":"","":"","\uD87E\uDCCE":"","\uD87E\uDC97":"\uD84C\uDEB8","":"","":"","\uD87E\uDCCC":"","":"","\uD87E\uDD80":"\uD84C\uDF5F","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCD8":"","":"","":"","\uD87E\uDCD9":"","":"","":"","\uD87E\uDD89":"\uD84C\uDF93","":"","\uD87E\uDD8A":"\uD84C\uDF9C","":"","":"","\uD87E\uDCDC":"","":"","\uD87E\uDCDB":"","\uD87E\uDCDD":"\uD84C\uDFC3","":"","":"","\uD87E\uDCE0":"","":"","\uD87E\uDCDE":"","":"\uD84C\uDFD5","":"","\uD87E\uDCDF":"","":"","\uD87E\uDCE5":"","\uD87E\uDCE1":"","\uD87E\uDCE3":"\uD84D\uDC6D","":"","":"","\uD87E\uDCE2":"","\uD87E\uDCE4":"","":"","\uD87E\uDCE6":"","\uD87E\uDCE8":"","":"","\uD87E\uDCE7":"","":"","":"","\uD87E\uDCE9":"","\uD87E\uDCEA":"","":"","":"","":"","":"","\uD87E\uDCEC":"\uD84D\uDEA3","\uD87E\uDCEB":"","":"","\uD87E\uDCED":"","":"","\uD87E\uDCEE":"","":"","\uD87E\uDCEF":"","\uD87E\uDCF0":"\uD84E\uDCA7","\uD87E\uDCF1":"","\uD87E\uDCF2":"","":"","":"","\uD87E\uDCF3":"","":"","":"","":"","":"","\uD87E\uDCF4":"","":"","":"","":"","":"","\uD87E\uDCF5":"","\uD87E\uDCF6":"","\uD87E\uDCF7":"\uD84E\uDE8D","":"","":"","\uD87E\uDCF9":"\uD84E\uDEFA","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCFA":"","\uD87E\uDCFE":"","":"","\uD87E\uDCFC":"","":"","\uD87E\uDCFD":"","":"","\uD87E\uDCFB":"\uD84F\uDCBC","":"","":"","\uD87E\uDD07":"","\uD87E\uDD00":"","":"","":"","\uD87E\uDD02":"","\uD87E\uDCFF":"","\uD87E\uDD03":"","":"","":"","\uD87E\uDD01":"","\uD87E\uDD04":"","\uD87E\uDD05":"","\uD87E\uDD06":"\uD84F\uDD1E","":"","":"","":"","\uD87E\uDD0E":"","":"","\uD87E\uDD08":"","\uD87E\uDD09":"","":"","":"","\uD87E\uDD0B":"","":"","":"","\uD87E\uDD0C":"","":"","":"","\uD87E\uDD0A":"","":"","":"","":"","":"","\uD87E\uDD0D":"\uD84F\uDED1","\uD87E\uDD0F":"","\uD87E\uDD10":"\uD84F\uDF5E","\uD87E\uDD11":"\uD84F\uDF8E","\uD87E\uDD12":"","":"","":"","\uD87E\uDD15":"","":"","\uD87E\uDD14":"","\uD87E\uDD13":"","\uD87E\uDD17":"","\uD87E\uDD16":"","":"","":"","\uD87E\uDC35":"","\uD87E\uDD19":"","\uD87E\uDD18":"","":"","\uD87E\uDD1A":"","":"","":"","":"","":"","\uD87E\uDD1D":"\uD850\uDE63","\uD87E\uDD1C":"","":"","":"\uD850\uDEEE","\uD87E\uDD1E":"","":"","":"","\uD87E\uDD1F":"\uD850\uDFAB","":"","":"","\uD87E\uDD20":"","":"","":"","":"","":"","\uD87E\uDD21":"","":"","":"","":"","":"","":"","\uD87E\uDD22":"","":"","\uD87E\uDD23":"\uD851\uDE08","":"","":"","\uD87E\uDD24":"","\uD87E\uDD25":"","":"","":"","":"","":"","\uD87E\uDD26":"\uD851\uDF35","":"","":"","":"","\uD87E\uDD27":"\uD852\uDC14","":"","\uD87E\uDD28":"","":"","":"","":"","":"","\uD87E\uDD29":"","\uD87E\uDD2A":"","\uD87E\uDD2B":"","":"","\uD87E\uDD2C":"","\uD87E\uDD2D":"","":"","":"","":"","":"","\uD87E\uDD2E":"","\uD87E\uDD2F":"","":"","":"","\uD87E\uDD30":"","\uD87E\uDD31":"","":"","":"","\uD87E\uDD32":"","":"","":"","\uD87E\uDD33":"","":"","":"","":"","\uD87E\uDD34":"","":"","":"","":"","\uD87E\uDD36":"","\uD87E\uDD35":"\uD853\uDC36","":"","":"","":"","\uD87E\uDD38":"","\uD87E\uDD37":"\uD853\uDC92","":"","":"","":"","\uD87E\uDD3A":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD3B":"\uD853\uDFA1","\uD87E\uDD3C":"\uD853\uDFB8","":"","":"","\uD87E\uDD3D":"\uD854\uDC44","\uD87E\uDD3E":"","":"","":"","":"","":"","\uD87E\uDD3F":"","":"","":"","\uD87E\uDD40":"","\uD87E\uDD42":"\uD854\uDCF2","\uD87E\uDD41":"\uD854\uDCF3","":"","":"","\uD87E\uDD43":"\uD854\uDD19","\uD87E\uDD45":"","\uD87E\uDD46":"","\uD87E\uDD47":"","\uD87E\uDD44":"\uD854\uDD33","":"","":"","\uD87E\uDD48":"","":"","":"","\uD87E\uDD49":"","":"","\uD87E\uDD4B":"","\uD87E\uDD4A":"","":"\uD854\uDE49","":"","":"","":"","":"","\uD87E\uDD4C":"","\uD87E\uDD4D":"\uD855\uDC1D","":"","\uD87E\uDD4E":"","":"","":"","\uD87E\uDD4F":"","":"","":"","":"","\uD87E\uDD50":"","":"","\uD87E\uDD51":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD52":"\uD855\uDE26","":"","":"","\uD87E\uDD53":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD54":"\uD855\uDE9A","":"","":"","":"","\uD87E\uDD56":"","\uD87E\uDD55":"\uD855\uDEC5","":"","":"","":"","":"","\uD87E\uDD58":"","\uD87E\uDD57":"","":"","\uD87E\uDD5A":"","":"","\uD87E\uDD59":"","\uD87E\uDD5B":"","":"","":"","\uD87E\uDD5C":"\uD856\uDD7C","":"","":"","":"","":"","\uD87E\uDD5D":"\uD856\uDEA7","\uD87E\uDD5E":"\uD856\uDEA7","\uD87E\uDD5F":"","":"","":"","":"","":"","\uD87E\uDD60":"","\uD87E\uDD61":"\uD856\uDFAB","\uD87E\uDD62":"","\uD87E\uDD64":"","\uD87E\uDD63":"","\uD87E\uDD65":"\uD857\uDC80","":"\uD857\uDCD0","":"","":"","":"","":"","":"","":"","\uD87E\uDD66":"","":"","\uD87E\uDD68":"","\uD87E\uDD67":"","\uD87E\uDD69":"","":"","":"","":"","\uD87E\uDD6B":"\uD857\uDF86","\uD87E\uDD6A":"","":"","":"","":"","":"","\uD87E\uDD6C":"","":"","":"","":"","\uD87E\uDD6E":"","":"","":"","":"","\uD87E\uDD6F":"","\uD87E\uDD6D":"","":"","":"","":"","\uD87E\uDD70":"","\uD87E\uDC98":"\uD858\uDDDA","\uD87E\uDD71":"","":"","\uD87E\uDD72":"\uD858\uDE28","":"","\uD87E\uDD73":"\uD858\uDE47","":"","":"","":"","":"","\uD87E\uDD74":"","":"","\uD87E\uDD75":"\uD858\uDED9","":"","\uD87E\uDD76":"","":"","\uD87E\uDD77":"\uD858\uDF3E","":"","\uD87E\uDD78":"","":"","":"","":"","\uD87E\uDD79":"","":"","":"","":"","":"","":"","\uD87E\uDD7A":"","":"","\uD87E\uDD7B":"\uD859\uDCDA","":"","\uD87E\uDD7C":"\uD859\uDD23","":"","":"","\uD87E\uDD7D":"","\uD87E\uDD7E":"\uD859\uDDA8","":"","\uD87E\uDD7F":"","":"","":"","":"","":"","":"","\uD87E\uDCD6":"","\uD87E\uDD82":"","\uD87E\uDD81":"","\uD87E\uDCD7":"","":"","\uD87E\uDD83":"","\uD87E\uDD85":"","\uD87E\uDD84":"","\uD87E\uDCDA":"","\uD87E\uDD87":"\uD859\uDFA7","\uD87E\uDD88":"\uD859\uDFB5","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC93":"","\uD87E\uDD8B":"","\uD87E\uDD8C":"","":"","":"","":"","":"","\uD87E\uDD8E":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD90":"","\uD87E\uDD8F":"","\uD87E\uDD91":"","\uD87E\uDD93":"","\uD87E\uDD94":"","\uD87E\uDD95":"","":"","\uD87E\uDD98":"","\uD87E\uDD96":"","\uD87E\uDD97":"\uD85A\uDF3C","":"","":"","\uD87E\uDD9A":"","\uD87E\uDD99":"","\uD87E\uDD9C":"","\uD87E\uDD9D":"","\uD87E\uDDA0":"","":"","\uD87E\uDDA1":"","\uD87E\uDDA2":"","\uD87E\uDDA3":"","\uD87E\uDD9E":"","":"","":"","":"","\uD87E\uDD9F":"","\uD87E\uDDA4":"\uD85B\uDC36","\uD87E\uDD9B":"","":"","":"","":"","\uD87E\uDDA6":"\uD85B\uDCD5","\uD87E\uDDA5":"\uD85B\uDD6B","":"","\uD87E\uDDA8":"","\uD87E\uDDA9":"","":"","\uD87E\uDDAA":"","\uD87E\uDDA7":"","\uD87E\uDDAC":"","\uD87E\uDDAD":"\uD85B\uDF2C","":"","\uD87E\uDDAE":"","\uD87E\uDDB0":"\uD85B\uDFB1","\uD87E\uDDAF":"","":"","":"","\uD87E\uDDB2":"","":"","":"","\uD87E\uDDB1":"\uD85C\uDCD2","":"","":"","":"","":"","\uD87E\uDDB3":"","":"","\uD87E\uDDB4":"","\uD87E\uDDB5":"","\uD87E\uDDB6":"","":"","\uD87E\uDDB7":"","\uD87E\uDDB8":"","\uD87E\uDDBA":"","\uD87E\uDDB9":"","\uD87E\uDDBC":"","\uD87E\uDDBD":"","\uD87E\uDDC0":"","":"","\uD87E\uDDBB":"","\uD87E\uDDBE":"","\uD87E\uDDBF":"","\uD87E\uDDAB":"\uD85C\uDFCA","":"","\uD87E\uDDC1":"","\uD87E\uDDC2":"","":"","":"","":"","":"","\uD87E\uDDC3":"","\uD87E\uDDC4":"","":"","":"","":"","\uD87E\uDDC5":"\uD85D\uDE67","":"","\uD87E\uDDC6":"","\uD87E\uDDC7":"","":"","":"","\uD87E\uDDC9":"","\uD87E\uDDC8":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDCB":"\uD85E\uDCAE","":"","":"","":"","\uD87E\uDDCC":"\uD85E\uDD66","":"","":"","\uD87E\uDDCD":"","\uD87E\uDDCE":"","\uD87E\uDDCF":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDD0":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDD1":"","":"","":"","":"","":"","\uD87E\uDDD2":"","":"","":"","":"","\uD87E\uDDD3":"\uD85F\uDCA8","":"","\uD87E\uDDD4":"","\uD87E\uDDD5":"","":"","":"","":"","":"","":"","\uD87E\uDDD6":"","":"","":"","":"","\uD87E\uDDD7":"","":"","":"\uD85F\uDED3","\uD87E\uDDD8":"\uD85F\uDF2F","":"","\uD87E\uDDDA":"","\uD87E\uDDDB":"","":"","":"","\uD87E\uDDDC":"","":"","":"","":"","":"","\uD87E\uDDDE":"","":"","":"","":"","":"","\uD87E\uDDDF":"","":"","":"","":"","":"","\uD87E\uDD8D":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC81":"","":"","":"","":"","":"","":"","\uD87E\uDDE0":"\uD861\uDDD2","\uD87E\uDDE1":"\uD861\uDDED","":"","":"","\uD87E\uDDE2":"","":"","":"","":"","\uD87E\uDDE3":"","":"","\uD87E\uDDE5":"\uD861\uDF2E","\uD87E\uDDE4":"","\uD87E\uDDE6":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDE7":"","":"","\uD87E\uDDE8":"","\uD87E\uDDE9":"","\uD87E\uDDEA":"","":"","":"","":"","\uD87E\uDDEB":"","\uD87E\uDDEC":"","\uD87E\uDDED":"\uD862\uDFFA","":"","":"","":"","":"","":"","":"","\uD87E\uDDEE":"","\uD87E\uDDEF":"","":"","\uD87E\uDDF0":"","\uD87E\uDDF1":"\uD863\uDD77","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDF2":"","":"","":"","":"","":"","":"","\uD87E\uDDF3":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDF5":"","\uD87E\uDDF6":"\uD864\uDD45","":"","":"","":"","":"","":"","":"","\uD87E\uDC1C":"\uD864\uDDDF","":"","":"","\uD87E\uDDF7":"\uD864\uDE1A","":"","\uD87E\uDDF8":"","\uD87E\uDDF9":"","":"","":"","\uD87E\uDDFA":"","":"","":"","\uD87E\uDDFB":"\uD865\uDC0A","":"","":"","":"","":"","\uD87E\uDDFC":"","":"","\uD87E\uDDFE":"","\uD87E\uDDFF":"","":"","\uD87E\uDE00":"","\uD87E\uDDFD":"\uD865\uDC96","":"","":"","":"","":"","":"","\uD87E\uDE01":"\uD865\uDDB6","":"","":"","":"","":"","":"","":"","\uD87E\uDE02":"","":"","":"","\uD87E\uDE03":"","":"","\uD87E\uDE04":"","":"","":"","":"","\uD87E\uDE05":"","":"","\uD87E\uDE06":"","":"","\uD87E\uDE07":"","":"","":"","":"","\uD87E\uDE08":"","":"","":"","\uD87E\uDE09":"\uD866\uDF30","":"","\uD87E\uDE0A":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDE0B":"","":"","":"","":"","\uD87E\uDE0C":"","\uD87E\uDE0D":"","\uD87E\uDE0F":"","\uD87E\uDE0E":"","\uD87E\uDE10":"\uD868\uDCCE","":"","\uD87E\uDE12":"\uD868\uDD05","\uD87E\uDE11":"","":"","\uD87E\uDE13":"\uD868\uDE0E","":"","":"","":"","":"","":"","\uD87E\uDE14":"\uD868\uDE91","":"","":"","":"","":"","\uD87E\uDE15":"","":"","\uD87E\uDC8F":"\uD868\uDF92","":"","":"","":"","":"","\uD87E\uDE16":"","":"","":"","":"","\uD87E\uDE17":"","":"","":"","\uD87E\uDE19":"","\uD87E\uDE18":"","":"","\uD87E\uDE1A":"","":"","\uD87E\uDE1B":"","":"","\uD87E\uDE1C":"","":"","":"","":"","":"","":"","\uD87E\uDE1D":"\uD869\uDE00","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}')}}]);