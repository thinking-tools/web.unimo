"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[189],{2168:function(e,t,r){var i,o,s,n,a=r(4836);Object.defineProperty(t,"__esModule",{value:!0}),t.UNSTABLE_MSC3882_CAPABILITY=t.UNSTABLE_MSC3852_LAST_SEEN_UA=t.RoomVersionStability=t.PendingEventOrdering=t.MatrixClient=t.M_AUTHENTICATION=t.ClientEvent=t.CRYPTO_ENABLED=void 0,t.fixNotificationCountOnDecryption=eS;var d=a(r(215)),l=a(r(8416)),h=r(4551),u=r(4369),c=r(5641),p=r(9679),v=r(7906),g=r(2931),m=el(r(3102)),y=r(8910),f=r(1707),E=r(9118),S=el(r(2772)),R=r(771),I=r(635),T=r(7434),k=r(1415),w=r(95),b=r(2600),_=r(4077),P=r(1597),C=r(3998),M=r(3667),U=r(1398),D=r(4830),$=r(764),A=el(r(4656)),x=r(7366),q=r(2848),O=r(2481),B=r(4702),N=r(1166),K=r(8401),F=r(5537),L=r(6170),G=r(9162),V=r(1470),H=r(8969),W=r(7626),j=r(8738),Y=r(5861),z=r(5550),Q=r(11),J=r(6969),Z=r(5699),X=r(7048),ee=r(3210),et=r(8515),er=r(5268),ei=r(4576),eo=r(1891);let es=["server","limit","since"];function en(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,i)}return r}function ea(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?en(Object(r),!0).forEach(function(t){(0,l.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):en(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function ed(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(ed=function(e){return e?r:t})(e)}function el(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=ed(t);if(r&&r.has(e))return r.get(e);var i={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var n=o?Object.getOwnPropertyDescriptor(e,s):null;n&&(n.get||n.set)?Object.defineProperty(i,s,n):i[s]=e[s]}return i.default=e,r&&r.set(e,i),i}let eh=(0,b.isCryptoAvailable)();t.CRYPTO_ENABLED=eh;let eu=new X.UnstableValue("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent");t.UNSTABLE_MSC3852_LAST_SEEN_UA=eu;let ec=((i={}).Chronological="chronological",i.Detached="detached",i);t.PendingEventOrdering=ec;let ep=((o={}).Stable="stable",o.Unstable="unstable",o);t.RoomVersionStability=ep;let ev=new X.UnstableValue("m.get_login_token","org.matrix.msc3882.get_login_token");t.UNSTABLE_MSC3882_CAPABILITY=ev;var eg=((s=eg||{}).MasterKey="master_key",s.SelfSigningKey="self_signing_key",s.UserSigningKey="user_signing_key",s);let em=new X.UnstableValue("m.authentication","org.matrix.msc2965.authentication");t.M_AUTHENTICATION=em;let ey=((n={}).Sync="sync",n.Event="event",n.ToDeviceEvent="toDeviceEvent",n.AccountData="accountData",n.Room="Room",n.DeleteRoom="deleteRoom",n.SyncUnexpectedError="sync.unexpectedError",n.ClientWellKnown="WellKnown.client",n.ReceivedVoipEvent="received_voip_event",n.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",n.TurnServers="turnServers",n.TurnServersError="turnServers.error",n);t.ClientEvent=ey;let ef=new X.UnstableValue("action","org.matrix.msc3824.action");class eE extends Y.TypedEventEmitter{constructor(e){var t,r;super(),(0,l.default)(this,"reEmitter",new R.TypedReEmitter(this)),(0,l.default)(this,"olmVersion",null),(0,l.default)(this,"usingExternalCrypto",!1),(0,l.default)(this,"store",void 0),(0,l.default)(this,"deviceId",void 0),(0,l.default)(this,"credentials",void 0),(0,l.default)(this,"pickleKey",void 0),(0,l.default)(this,"scheduler",void 0),(0,l.default)(this,"clientRunning",!1),(0,l.default)(this,"timelineSupport",!1),(0,l.default)(this,"urlPreviewCache",{}),(0,l.default)(this,"identityServer",void 0),(0,l.default)(this,"http",void 0),(0,l.default)(this,"crypto",void 0),(0,l.default)(this,"cryptoBackend",void 0),(0,l.default)(this,"cryptoCallbacks",void 0),(0,l.default)(this,"callEventHandler",void 0),(0,l.default)(this,"groupCallEventHandler",void 0),(0,l.default)(this,"supportsCallTransfer",!1),(0,l.default)(this,"forceTURN",!1),(0,l.default)(this,"iceCandidatePoolSize",0),(0,l.default)(this,"idBaseUrl",void 0),(0,l.default)(this,"baseUrl",void 0),(0,l.default)(this,"isVoipWithNoMediaAllowed",void 0),(0,l.default)(this,"canSupportVoip",!1),(0,l.default)(this,"peekSync",null),(0,l.default)(this,"isGuestAccount",!1),(0,l.default)(this,"ongoingScrollbacks",{}),(0,l.default)(this,"notifTimelineSet",null),(0,l.default)(this,"cryptoStore",void 0),(0,l.default)(this,"verificationMethods",void 0),(0,l.default)(this,"fallbackICEServerAllowed",!1),(0,l.default)(this,"roomList",void 0),(0,l.default)(this,"syncApi",void 0),(0,l.default)(this,"roomNameGenerator",void 0),(0,l.default)(this,"pushRules",void 0),(0,l.default)(this,"syncLeftRoomsPromise",void 0),(0,l.default)(this,"syncedLeftRooms",!1),(0,l.default)(this,"clientOpts",void 0),(0,l.default)(this,"clientWellKnownIntervalID",void 0),(0,l.default)(this,"canResetTimelineCallback",void 0),(0,l.default)(this,"canSupport",new Map),(0,l.default)(this,"pushProcessor",new f.PushProcessor(this)),(0,l.default)(this,"serverVersionsPromise",void 0),(0,l.default)(this,"cachedCapabilities",void 0),(0,l.default)(this,"clientWellKnown",void 0),(0,l.default)(this,"clientWellKnownPromise",void 0),(0,l.default)(this,"turnServers",[]),(0,l.default)(this,"turnServersExpiry",0),(0,l.default)(this,"checkTurnServersIntervalID",void 0),(0,l.default)(this,"exportedOlmDeviceToImport",void 0),(0,l.default)(this,"txnCtr",0),(0,l.default)(this,"mediaHandler",new W.MediaHandler(this)),(0,l.default)(this,"sessionId",void 0),(0,l.default)(this,"pendingEventEncryption",new Map),(0,l.default)(this,"useE2eForGroupCall",!0),(0,l.default)(this,"toDeviceMessageQueue",void 0),(0,l.default)(this,"_secretStorage",void 0),(0,l.default)(this,"ignoredInvites",void 0),(0,l.default)(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.groupCallEventHandler.start(),this.off(ey.Sync,this.startCallEventHandler))}),(0,l.default)(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var e;let t=(null!==(e=this.getRooms())&&void 0!==e?e:[]).filter(e=>e.getUnreadNotificationCount(x.NotificationCountType.Total)>0);for(let e of t){let t=this.getSafeUserId();e.fixupNotifications(t)}this.off(ey.Sync,this.fixupRoomNotifications)}}),e.baseUrl=m.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=m.ensureNoTrailingSlash(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!==(t=e.usingExternalCrypto)&&void 0!==t&&t,this.store=e.store||new c.StubStore,this.deviceId=e.deviceId||null,this.sessionId=(0,K.randomString)(10);let i=e.userId||null;this.credentials={userId:i},this.http=new w.MatrixHttpApi(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,prefix:w.ClientPrefix.R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?T.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?T.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):T.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(async e=>{let t=this.getRoom(e.getRoomId());e.status!==u.EventStatus.SENDING&&this.updatePendingEventStatus(t,e,u.EventStatus.SENDING);let r=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,u.EventStatus.SENT,r.event_id),r}),(0,p.supportsMatrixCall)()&&(this.callEventHandler=new g.CallEventHandler(this),this.groupCallEventHandler=new j.GroupCallEventHandler(this),this.canSupportVoip=!0,this.on(ey.Sync,this.startCallEventHandler)),this.on(ey.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.roomList=new I.RoomList(this.cryptoStore),this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new ee.ToDeviceMessageQueue(this),this.on(u.MatrixEventEvent.Decrypted,e=>{eS(this,e)}),this.on(x.RoomEvent.Receipt,(e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){let i=e.getContent(),o=Object.keys(i).filter(e=>{for(let[t,r]of Object.entries(i[e]))if(m.isSupportedReceiptType(t)&&r&&Object.keys(r).includes(this.getUserId()))return!0;return!1}).length>0;if(!o)return;let s=t.getLiveTimeline().getEvents(),n=0;for(let e=s.length-1;e>=0;e--){var r;if(e===s.length-20)return;let i=s[e];if(t.hasUserReadEvent(this.getUserId(),i.getId()))break;let o=this.getPushActionsForEvent(i);n+=null!=o&&null!==(r=o.tweaks)&&void 0!==r&&r.highlight?1:0}t.setUnreadNotificationCount(x.NotificationCountType.Highlight,n)}}),this.ignoredInvites=new et.IgnoredInvites(this),this._secretStorage=new eo.ServerSideSecretStorageImpl(this,null!==(r=e.cryptoCallbacks)&&void 0!==r?r:{})}async startClient(e){var t;if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});let r=this.getUserId();r&&this.store.storeUser(new C.User(r)),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval(()=>{this.checkTurnServers()},6e5),this.checkTurnServers()),this.syncApi&&(T.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{await this.getVersions();let{threads:e,list:t,fwdPagination:r}=await this.doesServerSupportThread();J.Thread.setServerSideSupport(e),J.Thread.setServerSideListSupport(t),J.Thread.setServerSideFwdPaginationSupport(r)}catch(e){T.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",e)}this.clientOpts=null!==(t=e)&&void 0!==t?t:{},this.clientOpts.slidingSync?this.syncApi=new Q.SlidingSyncSdk(this.clientOpts.slidingSync,this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()),this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&T.logger.warn("`experimentalThreadSupport` has been deprecated, use `threadSupport` instead"),!this.clientOpts.hasOwnProperty("threadSupport")&&this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&(this.clientOpts.threadSupport=this.clientOpts.experimentalThreadSupport),this.syncApi.sync(),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval(()=>{this.fetchClientWellKnown()},1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e)}}stopClient(){var e,t,i,o,s;null===(e=this.cryptoBackend)||void 0===e||e.stop(),this.clientRunning&&(T.logger.log("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=void 0,null===(i=this.peekSync)||void 0===i||i.stopPeeking(),null===(o=this.callEventHandler)||void 0===o||o.stop(),null===(s=this.groupCallEventHandler)||void 0===s||s.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,r.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&r.g.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop())}async rehydrateDevice(){if(this.crypto)throw Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;let e=await this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id){T.logger.info("no dehydrated device found");return}let t=new r.g.Olm.Account;try{let r=e.device_data;if(r.algorithm!==D.DEHYDRATION_ALGORITHM){T.logger.warn("Wrong algorithm for dehydrated device");return}T.logger.log("unpickling dehydrated device");let i=await this.cryptoCallbacks.getDehydrationKey(r,e=>{t.unpickle(new Uint8Array(e),r.account)});t.unpickle(i,r.account),T.logger.log("unpickled device");let o=await this.http.authedRequest(w.Method.Post,"/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"});if(o.success){this.deviceId=e.device_id,T.logger.info("using dehydrated device");let r=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:t.pickle(r),sessions:[],pickleKey:r},t.free(),this.deviceId}t.free(),T.logger.info("not using dehydrated device");return}catch(e){t.free(),T.logger.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(w.Method.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){T.logger.info("could not get dehydrated device",e);return}}async setDehydrationKey(e,t,r){if(!this.crypto){T.logger.warn("not dehydrating device if crypto is not enabled");return}return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,r)}async createDehydratedDevice(e,t,r){if(!this.crypto){T.logger.warn("not dehydrating device if crypto is not enabled");return}return await this.crypto.dehydrationManager.setKey(e,t,r),this.crypto.dehydrationManager.dehydrateDevice()}async exportDevice(){if(!this.crypto){T.logger.warn("not exporting device if crypto is not enabled");return}return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()}}clearStores(){if(this.clientRunning)throw Error("Cannot clear stores while client is running");let e=[];e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData());let t=async()=>{let e;try{e=r.g.indexedDB}catch(e){return}for(let t of[`${ei.RUST_SDK_STORE_PREFIX}::matrix-sdk-crypto`,`${ei.RUST_SDK_STORE_PREFIX}::matrix-sdk-crypto-meta`]){let r=new Promise((r,i)=>{T.logger.info(`Removing IndexedDB instance ${t}`);let o=e.deleteDatabase(t);o.onsuccess=e=>{T.logger.info(`Removed IndexedDB instance ${t}`),r(0)},o.onerror=e=>{T.logger.warn(`Failed to remove IndexedDB instance ${t}:`,e),r(0)},o.onblocked=e=>{T.logger.info(`cannot yet remove IndexedDB instance ${t}`)}});await r}};return e.push(t()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){let e=this.getUserId();if(!e)throw Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return(0,p.createNewMatrixCall)(this,e)}async createGroupCall(e,t,r,i,o,s){if(this.getGroupCallForRoom(e))throw Error(`${e} already has an existing group call`);let n=this.getRoom(e);if(!n)throw Error(`Cannot find room ${e}`);return new H.GroupCall(this,n,t,r,i,void 0,o||this.isVoipWithNoMediaAllowed,s,this.isVoipWithNoMediaAllowed).create()}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.getSyncState())&&void 0!==e?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){let e=this.getSyncState();return!!e&&(e===h.SyncState.Prepared||e===h.SyncState.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.retryImmediately())&&void 0!==e&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){let t=new Date().getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(T.logger.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(w.Method.Get,"/capabilities").catch(e=>(T.logger.error(e),{})).then((e={})=>{let r=e.capabilities||{},i=Object.keys(r).length?216e5:6e4+5e3*Math.random();return this.cachedCapabilities={capabilities:r,expiration:t+i},T.logger.log("Caching capabilities: ",r),r})}async initCrypto(){if(!(0,b.isCryptoAvailable)())throw Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.cryptoBackend){T.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}if(!this.cryptoStore)throw Error("Cannot enable encryption: no cryptoStore provided");T.logger.log("Crypto: Starting up crypto store..."),await this.cryptoStore.startup(),T.logger.log("Crypto: initialising roomlist..."),await this.roomList.init();let e=this.getUserId();if(null===e)throw Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");let t=new b.Crypto(this,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,[b.CryptoEvent.KeyBackupFailed,b.CryptoEvent.KeyBackupSessionsRemaining,b.CryptoEvent.RoomKeyRequest,b.CryptoEvent.RoomKeyRequestCancellation,b.CryptoEvent.Warning,b.CryptoEvent.DevicesUpdated,b.CryptoEvent.WillUpdateDevices,b.CryptoEvent.DeviceVerificationChanged,b.CryptoEvent.UserTrustStatusChanged,b.CryptoEvent.KeysChanged]),T.logger.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=b.Crypto.getOlmVersion(),t.registerEventHandlers(this),this.cryptoBackend=this.crypto=t,this.crypto.uploadDeviceKeys().catch(e=>{T.logger.error("Error uploading device keys",e)})}async initRustCrypto(){if(this.cryptoBackend){T.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}let e=this.getUserId();if(null===e)throw Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");let t=this.getDeviceId();if(null===t)throw Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");let i=await Promise.resolve().then(()=>el(r(2713))),o=await i.initRustCrypto(this.http,e,t);this.cryptoBackend=o,this.on(q.RoomMemberEvent.Membership,o.onRoomMembership.bind(o))}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceEd25519Key())&&void 0!==e?e:null}getDeviceCurve25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceCurve25519Key())&&void 0!==e?e:null}async uploadKeys(){T.logger.warn("MatrixClient.uploadKeys is deprecated")}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,r=!0){let i=this.setDeviceVerification(e,t,r,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),i}setDeviceBlocked(e,t,r=!0){return this.setDeviceVerification(e,t,null,r,null)}setDeviceKnown(e,t,r=!0){return this.setDeviceVerification(e,t,null,null,r)}async setDeviceVerification(e,t,r,i,o){if(!this.crypto)throw Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,r,i,o)}requestVerificationDM(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,r){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,r)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(e=$.CrossSigningKey.Master){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,r){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,r)}prepareToEncrypt(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw Error("End-to-end encryption disabled");this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){let t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw Error("End-to-End encryption disabled");let t=e.getWireContent(),r={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return r.session_id&&r.sender_key&&r.algorithm&&r.room_id?this.crypto.cryptoStore.getOutgoingRoomKeyRequest(r):Promise.resolve(null)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){let t=this.getRoom(e);if(!t)return!1;let r=t.currentState.getStateEvents(O.EventType.RoomEncryption,"");return!!r||this.roomList.isRoomEncrypted(e)}encryptAndSendToDevices(e,t){if(!this.crypto)throw Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(w.Method.Get,"/room_keys/version",void 0,void 0,{prefix:w.ClientPrefix.V3})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}return F.BackupManager.checkBackupVersion(e),e}isKeyBackupTrusted(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw Error("End-to-end encryption disabled");let{algorithm:r,auth_data:i,recovery_key:o,privateKey:s}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.secretStorage.store("m.megolm_backup.v1",(0,S.encodeBase64)(s)),T.logger.info("Key backup private key stored in secret storage")),{algorithm:r,auth_data:i,recovery_key:o}}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);let t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");let r=await this.http.authedRequest(w.Method.Post,"/room_keys/version",void 0,t,{prefix:w.ClientPrefix.V3});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||T.logger.error("Key backup not usable even though we just created it"),r}async deleteKeyBackupVersion(e){if(!this.crypto)throw Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();let t=m.encodeUri("/room_keys/version/$version",{$version:e});await this.http.authedRequest(w.Method.Delete,t,void 0,void 0,{prefix:w.ClientPrefix.V3})}makeKeyBackupPath(e,t,r){return{path:void 0!==t?m.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?m.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",queryData:void 0===r?void 0:{version:r}}}async sendKeyBackup(e,t,r,i){if(!this.crypto)throw Error("End-to-end encryption disabled");let o=this.makeKeyBackupPath(e,t,r);await this.http.authedRequest(w.Method.Put,o.path,o.queryData,i,{prefix:w.ClientPrefix.V3})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return(0,_.decodeRecoveryKey)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return(0,P.keyFromAuthData)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return(0,_.decodeRecoveryKey)(e)}async restoreKeyBackupWithPassword(e,t,r,i,o){let s=await (0,P.keyFromAuthData)(i.auth_data,e);return this.restoreKeyBackup(s,t,r,i,o)}async restoreKeyBackupWithSecretStorage(e,t,r,i){if(!this.crypto)throw Error("End-to-end encryption disabled");let o=await this.secretStorage.get("m.megolm_backup.v1"),s=(0,b.fixBackupKey)(o);if(s){let e=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",s,[e[0]])}let n=(0,S.decodeBase64)(s||o);return this.restoreKeyBackup(n,t,r,e,i)}restoreKeyBackupWithRecoveryKey(e,t,r,i,o){let s=(0,_.decodeRecoveryKey)(e);return this.restoreKeyBackup(s,t,r,i,o)}async restoreKeyBackupWithCache(e,t,r,i){if(!this.crypto)throw Error("End-to-end encryption disabled");let o=await this.crypto.getSessionBackupPrivateKey();if(!o)throw Error("Couldn't get key");return this.restoreKeyBackup(o,e,t,r,i)}async restoreKeyBackup(e,t,r,i,o){let s=null==o?void 0:o.cacheCompleteCallback,n=null==o?void 0:o.progressCallback;if(!this.crypto)throw Error("End-to-end encryption disabled");let a=0,d=[],l=this.makeKeyBackupPath(t,r,i.version),h=await F.BackupManager.makeAlgorithm(i,async()=>e),u=h.untrusted;try{if(!await h.keyMatches(e))return Promise.reject(new w.MatrixError({errcode:eE.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch(e=>{T.logger.warn("Error caching session backup key:",e)}).then(s),n&&n({stage:"fetch"});let i=await this.http.authedRequest(w.Method.Get,l.path,l.queryData,void 0,{prefix:w.ClientPrefix.V3});if(i.rooms){let e=i.rooms;for(let[t,r]of Object.entries(e)){if(!r.sessions)continue;a+=Object.keys(r.sessions).length;let e=await h.decryptSessions(r.sessions);for(let r of e)r.room_id=t,d.push(r)}}else if(i.sessions){let e=i.sessions;for(let r of(a=Object.keys(e).length,d=await h.decryptSessions(e)))r.room_id=t}else{a=1;try{let[e]=await h.decryptSessions({[r]:i});e.room_id=t,e.session_id=r,d.push(e)}catch(e){T.logger.log("Failed to decrypt megolm session from backup",e)}}}finally{h.free()}return await this.importRoomKeys(d,{progressCallback:n,untrusted:u,source:"backup"}),await this.checkKeyBackup(),{total:a,imported:d.length}}async deleteKeysFromBackup(e,t,r){if(!this.crypto)throw Error("End-to-end encryption disabled");let i=this.makeKeyBackupPath(e,t,r);await this.http.authedRequest(w.Method.Delete,i.path,i.queryData,void 0,{prefix:w.ClientPrefix.V3})}async sendSharedHistoryKeys(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");let r=this.roomList.getRoomEncryption(e);if(!r){T.logger.error("Unknown room.  Not sharing decryption keys");return}let i=await this.crypto.downloadKeys(t),o=new Map;for(let[e,t]of i)o.set(e,Array.from(t.values()));let s=this.crypto.getRoomDecryptor(e,r.algorithm);s.sendSharedHistoryInboundSessions?await s.sendSharedHistoryInboundSessions(o):T.logger.warn("Algorithm does not support sharing previous keys",r.algorithm)}getMediaConfig(){return this.http.authedRequest(w.Method.Get,"/config",void 0,void 0,{prefix:w.MediaPrefix.R0})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(e=!1){let t=this.store.getRooms(),r=new Set;for(let o of t){var i;let t=null===(i=o.findPredecessor(e))||void 0===i?void 0:i.roomId;t&&r.add(t)}return t.filter(e=>{let t=e.currentState.getStateEvents(O.EventType.RoomTombstone,"");return!(t&&r.has(e.roomId))})}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){let r=m.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return(0,w.retryNetworkOperation)(5,()=>this.http.authedRequest(w.Method.Put,r,void 0,t))}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){let t=this.store.getAccountData(e);return t?t.getContent():null}let t=m.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(w.Method.Get,t)}catch(e){var r;if((null===(r=e.data)||void 0===r?void 0:r.errcode)==="M_NOT_FOUND")return null;throw e}}async deleteAccountData(e){let t=this.canSupport.get(er.Feature.AccountDataDeletion);if(t===er.ServerSupport.Unsupported){await this.setAccountData(e,{});return}let r=m.encodeUri("/user/$userId/account_data/$type",{$userId:this.getSafeUserId(),$type:e}),i=t===er.ServerSupport.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return await this.http.authedRequest(w.Method.Delete,r,void 0,void 0,i)}getIgnoredUsers(){let e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){let t={ignored_users:{}};return e.forEach(e=>{t.ignored_users[e]={}}),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t={}){void 0===t.syncRoom&&(t.syncRoom=!0);let r=this.getRoom(e);if(null!=r&&r.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(r);let i=Promise.resolve();if(t.inviteSignUrl){let e=new URL(t.inviteSignUrl);e.searchParams.set("mxid",this.credentials.userId),i=this.http.requestOtherUrl(w.Method.Post,e)}let o={};t.viaServers&&(o.server_name=t.viaServers);try{let r={},s=await i;s&&(r.third_party_signed=s);let n=m.encodeUri("/join/$roomid",{$roomid:e}),a=await this.http.authedRequest(w.Method.Post,n,o,r),d=a.room_id,l=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()),u=l.createRoom(d);return t.syncRoom,u}catch(e){throw e}}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,u.EventStatus.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![u.EventStatus.QUEUED,u.EventStatus.NOT_SENT,u.EventStatus.ENCRYPTING].includes(e.status))throw Error("cannot cancel an event with status "+e.status);e.status===u.EventStatus.ENCRYPTING?this.pendingEventEncryption.delete(e.getId()):this.scheduler&&e.status===u.EventStatus.QUEUED&&this.scheduler.removeEventFromQueue(e);let t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,u.EventStatus.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,O.EventType.RoomName,{name:t})}setRoomTopic(e,t,r){let i=A.makeTopicContent(t,r);return this.sendStateEvent(e,O.EventType.RoomTopic,i)}getRoomTags(e){let t=m.encodeUri("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(w.Method.Get,t)}setRoomTag(e,t,r){let i=m.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(w.Method.Put,i,void 0,r)}deleteRoomTag(e,t){let r=m.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(w.Method.Delete,r)}setRoomAccountData(e,t,r){let i=m.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(w.Method.Put,i,void 0,r)}setPowerLevel(e,t,r,i){let o={users:{}};(null==i?void 0:i.getType())===O.EventType.RoomPowerLevels&&(o=m.deepCopy(i.getContent()));let s=Array.isArray(t)?t:[t];for(let e of s)null==r?delete o.users[e]:o.users[e]=r;let n=m.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(w.Method.Put,n,void 0,o)}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){return this.sendStateEvent(e,Z.M_BEACON_INFO.name,t,this.getUserId())}sendEvent(e,t,r,i,o){var s,n,a,d,l;let h,u,c,p;if(null!=t&&t.startsWith("$")||null===t?(p=o,c=i,u=r,h=t):(p=i,c=r,u=t,h=null),h&&!(null!==(s=c["m.relates_to"])&&void 0!==s&&s.rel_type)){let t=!!(null!==(n=c["m.relates_to"])&&void 0!==n&&n["m.in_reply_to"]);c["m.relates_to"]=ea(ea({},c["m.relates_to"]),{},{rel_type:J.THREAD_RELATION_TYPE.name,event_id:h,is_falling_back:!t});let r=null===(a=this.getRoom(e))||void 0===a?void 0:a.getThread(h);r&&!t&&(c["m.relates_to"]["m.in_reply_to"]={event_id:null!==(d=null===(l=r.lastReply(e=>e.isRelation(J.THREAD_RELATION_TYPE.name)&&!e.status))||void 0===l?void 0:l.getId())&&void 0!==d?d:h})}return this.sendCompleteEvent(e,h,{type:u,content:c},p)}sendCompleteEvent(e,t,r,i){i||(i=this.makeTxnId());let o=new u.MatrixEvent(Object.assign(r,{event_id:"~"+e+":"+i,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),s=this.getRoom(e),n=t?null==s?void 0:s.getThread(t):void 0;n&&o.setThread(n),this.reEmitter.reEmit(o,[u.MatrixEventEvent.Replaced,u.MatrixEventEvent.VisibilityChange]),null==s||s.reEmitter.reEmit(o,[u.MatrixEventEvent.BeforeRedaction]);let a=o.getAssociatedId();if(null!=a&&a.startsWith("~")){let e=null==s?void 0:s.getPendingEvents().find(e=>e.getId()===a);null==e||e.once(u.MatrixEventEvent.LocalEventIdReplaced,()=>{o.updateAssociatedId(e.getId())})}let d=o.getType();return(T.logger.log(`sendEvent of type ${d} in ${e} with txnId ${i}`),o.setTxnId(i),o.setStatus(u.EventStatus.SENDING),null==s||s.addPendingEvent(o,i),o.status===u.EventStatus.NOT_SENT)?Promise.reject(Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(s,o)}encryptAndSendEvent(e,t){let r=!1;return Promise.resolve().then(()=>{let i=this.encryptEventIfNeeded(t,null!=e?e:void 0);return i?(this.pendingEventEncryption.set(t.getId(),i),this.updatePendingEventStatus(e,t,u.EventStatus.ENCRYPTING),i.then(()=>{if(!this.pendingEventEncryption.has(t.getId())){r=!0;return}this.updatePendingEventStatus(e,t,u.EventStatus.SENDING)})):null}).then(()=>{if(r)return{};let i=null;return this.scheduler&&(i=this.scheduler.queueEvent(t))&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,u.EventStatus.QUEUED),!i&&(i=this.sendEventHttpRequest(t),e&&(i=i.then(r=>(e.updatePendingEvent(t,u.EventStatus.SENT,r.event_id),r)))),i}).catch(r=>{T.logger.error("Error sending event",r.stack||r);try{t.error=r,this.updatePendingEventStatus(e,t,u.EventStatus.NOT_SENT)}catch(e){T.logger.error("Exception in error handler!",e.stack||r)}throw r instanceof w.MatrixError&&(r.event=t),r})}encryptEventIfNeeded(e,t){if(e.isEncrypted()||e.isRedaction()||!t||!this.isRoomEncrypted(e.getRoomId())||!this.cryptoBackend&&this.usingExternalCrypto||e.getType()===O.EventType.Reaction)return null;if(!this.cryptoBackend)throw Error("This room is configured to use encryption, but your client does not support encryption.");return this.cryptoBackend.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===O.EventType.Reaction?t:this.isRoomEncrypted(e)?O.EventType.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e){let t,r=e.getTxnId();r||(r=this.makeTxnId(),e.setTxnId(r));let i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:r};if(e.isState()){let r="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(r="/rooms/$roomId/state/$eventType/$stateKey"),t=m.encodeUri(r,i)}else t=e.isRedaction()?m.encodeUri("/rooms/$roomId/redact/$redactsEventId/$txnId",ea({$redactsEventId:e.event.redacts},i)):m.encodeUri("/rooms/$roomId/send/$eventType/$txnId",i);return this.http.authedRequest(w.Method.Put,t,void 0,e.getWireContent()).then(t=>(T.logger.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t))}redactEvent(e,t,r,i,o){var s,n,a,d,l;null!==(s=r)&&void 0!==s&&s.startsWith("$")||(o=i,i=r,r=t,t=null);let h=null===(n=o)||void 0===n?void 0:n.reason;if(null!==(a=o)&&void 0!==a&&a.with_relations&&this.canSupport.get(er.Feature.RelationBasedRedactions)===er.ServerSupport.Unsupported)throw Error(`Server does not support relation based redactions roomId ${e} eventId ${r} txnId: ${i} threadId ${t}`);let u=null!==(d=o)&&void 0!==d&&d.with_relations?{[this.canSupport.get(er.Feature.RelationBasedRedactions)===er.ServerSupport.Stable?O.MSC3912_RELATION_BASED_REDACTIONS_PROP.stable:O.MSC3912_RELATION_BASED_REDACTIONS_PROP.unstable]:null===(l=o)||void 0===l?void 0:l.with_relations}:{};return this.sendCompleteEvent(e,t,{type:O.EventType.RoomRedaction,content:ea(ea({},u),{},{reason:h}),redacts:r},i)}sendMessage(e,t,r,i){"string"!=typeof t&&null!==t&&(i=r,r=t,t=null);let o=O.EventType.RoomMessage,s=r;return this.sendEvent(e,t,o,s,i)}sendTextMessage(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let s=A.makeTextMessage(r);return this.sendMessage(e,t,s,i)}sendNotice(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let s=A.makeNotice(r);return this.sendMessage(e,t,s,i)}sendEmoteMessage(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let s=A.makeEmoteMessage(r);return this.sendMessage(e,t,s,i)}sendImageMessage(e,t,r,i,o="Image"){var s;null!==(s=t)&&void 0!==s&&s.startsWith("$")||null===t||(o=i||"Image",i=r,r=t,t=null);let n={msgtype:O.MsgType.Image,url:r,info:i,body:o};return this.sendMessage(e,t,n)}sendStickerMessage(e,t,r,i,o="Sticker"){var s;null!==(s=t)&&void 0!==s&&s.startsWith("$")||null===t||(o=i||"Sticker",i=r,r=t,t=null);let n={url:r,info:i,body:o};return this.sendEvent(e,t,O.EventType.Sticker,n)}sendHtmlMessage(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let s=A.makeHtmlMessage(r,i);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let s=A.makeHtmlNotice(r,i);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let s=A.makeHtmlEmote(r,i);return this.sendMessage(e,t,s)}async sendReceipt(e,t,r,i=!1){if(this.isGuest())return Promise.resolve({});let o=m.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()});if(!i){let t=!!e.threadRootId;r=ea(ea({},r),{},{thread_id:t?e.threadRootId:z.MAIN_ROOM_TIMELINE})}let s=this.http.authedRequest(w.Method.Post,o,void 0,r||{}),n=this.getRoom(e.getRoomId());return n&&this.credentials.userId&&n.addLocalEchoReceipt(this.credentials.userId,e,t),s}async sendReadReceipt(e,t=z.ReceiptType.Read,r=!1){if(!e)return;let i=e.getId(),o=this.getRoom(e.getRoomId());if(null!=o&&o.hasPendingEvent(i))throw Error(`Cannot set read receipt to a pending event (${i})`);return this.sendReceipt(e,t,{},r)}async setRoomReadMarkers(e,t,r,i){let o,s;let n=this.getRoom(e);if(n&&n.hasPendingEvent(t))throw Error(`Cannot set read marker to a pending event (${t})`);if(r){if(o=r.getId(),null!=n&&n.hasPendingEvent(o))throw Error(`Cannot set read receipt to a pending event (${o})`);null==n||n.addLocalEchoReceipt(this.credentials.userId,r,z.ReceiptType.Read)}if(i){if(s=i.getId(),null!=n&&n.hasPendingEvent(s))throw Error(`Cannot set read receipt to a pending event (${s})`);null==n||n.addLocalEchoReceipt(this.credentials.userId,i,z.ReceiptType.ReadPrivate)}return await this.setRoomReadMarkersHttpRequest(e,t,o,s)}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);let r=new URL(e);r.hash="",e=r.toString();let i=t+"_"+e,o=this.urlPreviewCache[i];if(o)return o;let s=this.http.authedRequest(w.Method.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:w.MediaPrefix.R0});return this.urlPreviewCache[i]=s,s}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});let i=m.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),o={typing:t};return t&&(o.timeout=r||2e4),this.http.authedRequest(w.Method.Put,i,void 0,o)}getRoomUpgradeHistory(e,t=!1,r=!1){let i=this.getRoom(e);if(!i)return[];let o=this.findPredecessorRooms(i,t,r),s=this.findSuccessorRooms(i,t,r);return[...o,i,...s]}findPredecessorRooms(e,t,r){var i,o;let s=[],n=null===(i=e.findPredecessor(r))||void 0===i?void 0:i.roomId;for(;null!==n;){let i=this.getRoom(n);if(null===i)break;if(t){let t=i.currentState.getStateEvents(O.EventType.RoomTombstone,"");if(!t||t.getContent().replacement_room!==e.roomId)break}s.splice(0,0,i),n=null===(o=(e=i).findPredecessor(r))||void 0===o?void 0:o.roomId}return s}findSuccessorRooms(e,t,r){let i=[],o=e.currentState.getStateEvents(O.EventType.RoomTombstone,"");for(;o;){let n=this.getRoom(o.getContent().replacement_room);if(!n||n.roomId===e.roomId)break;if(t){var s;let t=null===(s=n.findPredecessor(r))||void 0===s?void 0:s.roomId;if(!t||t!==e.roomId)break}i.push(n);let a=new Set(i.map(e=>e.roomId));if(a.size<i.length)return i.slice(0,i.length-1);o=(e=n).currentState.getStateEvents(O.EventType.RoomTombstone,"")}return i}invite(e,t,r){return this.membershipChange(e,t,"invite",r)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}async inviteByThreePid(e,t,r){var i;let o=m.encodeUri("/rooms/$roomId/invite",{$roomId:e}),s=this.getIdentityServerUrl(!0);if(!s)return Promise.reject(new w.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));let n={id_server:s,medium:t,address:r};if(null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){let e=await this.identityServer.getAccessToken();e&&(n.id_access_token=e)}return this.http.authedRequest(w.Method.Post,o,void 0,n)}leave(e){return this.membershipChange(e,void 0,"leave")}leaveRoomChain(e,t=!0){let r=this.getRoomUpgradeHistory(e),i=r;if(!t){for(let t of(i=[],r))if(i.push(t),t.roomId===e)break}let o={},s=[],n=e=>this.leave(e).then(()=>{delete o[e]}).catch(t=>{o[e]=t});for(let e of i)s.push(n(e.roomId));return Promise.all(s).then(()=>o)}ban(e,t,r){return this.membershipChange(e,t,"ban",r)}forget(e,t=!0){let r=this.membershipChange(e,void 0,"forget");return t?r.then(t=>(this.store.removeRoom(e),this.emit(ey.DeleteRoom,e),t)):r}unban(e,t){let r=m.encodeUri("/rooms/$roomId/unban",{$roomId:e});return this.http.authedRequest(w.Method.Post,r,void 0,{user_id:t})}kick(e,t,r){let i=m.encodeUri("/rooms/$roomId/kick",{$roomId:e});return this.http.authedRequest(w.Method.Post,i,void 0,{user_id:t,reason:r})}membershipChange(e,t,r,i){let o=m.encodeUri("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(w.Method.Post,o,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e,t=!1){if(!e.getPushActions()||t){let{actions:t,rule:r}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,r)}return e.getPushActions()}getPushDetailsForEvent(e,t=!1){if(!e.getPushDetails()||t){let{actions:t,rule:r}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,r)}return e.getPushDetails()}setProfileInfo(e,t){let r=m.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(w.Method.Put,r,void 0,t)}async setDisplayName(e){let t=await this.setProfileInfo("displayname",{displayname:e}),r=this.getUser(this.getUserId());return r&&(r.displayName=e,r.emit(C.UserEvent.DisplayName,r.events.presence,r)),t}async setAvatarUrl(e){let t=await this.setProfileInfo("avatar_url",{avatar_url:e}),r=this.getUser(this.getUserId());return r&&(r.avatarUrl=e,r.emit(C.UserEvent.AvatarUrl,r.events.presence,r)),t}mxcUrlToHttp(e,t,r,i,o){return(0,M.getHttpUriForMxc)(this.baseUrl,e,t,r,i,o)}async setPresence(e){let t=m.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw Error("Bad presence value: "+e.presence);await this.http.authedRequest(w.Method.Put,t,void 0,e)}getPresence(e){let t=m.encodeUri("/presence/$userId/status",{$userId:e});return this.http.authedRequest(w.Method.Get,t)}scrollback(e,t=30){let r=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){let e=Date.now()-i.errorTs;r=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);let o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;let s=new Promise((i,o)=>{(0,m.sleep)(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,y.Direction.Backward)).then(t=>{var r,o;let s=t.chunk.map(this.getEventMapper());if(t.state){let r=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(r)}let[n,a]=e.partitionThreadedEvents(s);this.processAggregatedTimelineEvents(e,n),e.addEventsToTimeline(n,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),e.oldState.paginationToken=null!==(r=t.end)&&void 0!==r?r:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,s,null!==(o=t.end)&&void 0!==o?o:null,!0),delete this.ongoingScrollbacks[e.roomId],i(e)}).catch(t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},o(t)})});return i={promise:s},this.ongoingScrollbacks[e.roomId]=i,s}getEventMapper(e){return(0,N.eventMapperFor)(this,e||{})}async getEventTimeline(e,t){var r,i,o,s;let n;if(!this.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(null!=e&&e.room))throw Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&this.supportsThreads())return this.getThreadTimeline(e,t);let a=m.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(n={filter:JSON.stringify(v.Filter.LAZY_LOADING_MESSAGES_FILTER)});let d=await this.http.authedRequest(w.Method.Get,a,n);if(!d.event)throw Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);let l=this.getEventMapper(),h=l(d.event);if(h.isRelation(J.THREAD_RELATION_TYPE.name)){T.logger.warn("Tried loading a regular timeline at the position of a thread event");return}let u=[...d.events_after.reverse().map(l),h,...d.events_before.map(l)],c=e.getTimelineForEvent(u[0].getId());c?c.getState(y.EventTimeline.BACKWARDS).setUnknownStateEvents(d.state.map(l)):((c=e.addTimeline()).initialiseState(d.state.map(l)),c.getState(y.EventTimeline.FORWARDS).paginationToken=d.end);let[p,g]=e.room.partitionThreadedEvents(u);return e.addEventsToTimeline(p,!0,c,d.start),this.processThreadEvents(e.room,g,!0),this.processAggregatedTimelineEvents(e.room,p),null!==(i=null!==(o=e.getTimelineForEvent(t))&&void 0!==o?o:null===(s=e.room.findThreadForEvent(h))||void 0===s?void 0:s.liveTimeline)&&void 0!==i?i:c}async getThreadTimeline(e,t){var r,i,o,s,n,a,d,l;if(!this.supportsThreads())throw Error("could not get thread timeline: no client support");if(!e.room)throw Error("could not get thread timeline: not a room timeline");if(!e.thread)throw Error("could not get thread timeline: not a thread timeline");let h=m.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),u={limit:"0"};null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(u.filter=JSON.stringify(v.Filter.LAZY_LOADING_MESSAGES_FILTER));let c=await this.http.authedRequest(w.Method.Get,h,u),p=this.getEventMapper(),g=p(c.event);if(e.canContain(g)&&J.Thread.hasServerSideSupport){if(J.Thread.hasServerSideFwdPaginationSupport){if(!e.thread)throw Error("could not get thread timeline: not a thread timeline");let r=e.thread,a=await this.fetchRelations(e.room.roomId,r.id,J.THREAD_RELATION_TYPE.name,null,{dir:y.Direction.Backward,from:c.start}),d=await this.fetchRelations(e.room.roomId,r.id,J.THREAD_RELATION_TYPE.name,null,{dir:y.Direction.Forward,from:c.end}),l=[...d.chunk.reverse().map(p),g,...a.chunk.map(p)];for(let t of l)await (null===(n=e.thread)||void 0===n?void 0:n.processEvent(t));let h=e.getTimelineForEvent(g.getId());if(h?h.getState(y.EventTimeline.BACKWARDS).setUnknownStateEvents(c.state.map(p)):(h=e.addTimeline()).initialiseState(c.state.map(p)),e.addEventsToTimeline(l,!0,h,d.next_batch),!a.next_batch){let t=await this.fetchRoomEvent(e.room.roomId,r.id);e.addEventsToTimeline([p(t)],!0,h,null)}return h.setPaginationToken(null!==(i=a.next_batch)&&void 0!==i?i:null,y.Direction.Backward),h.setPaginationToken(null!==(o=d.next_batch)&&void 0!==o?o:null,y.Direction.Forward),this.processAggregatedTimelineEvents(e.room,l),null!==(s=e.getTimelineForEvent(t))&&void 0!==s?s:h}{let t=e.thread,r=await this.fetchRelations(e.room.roomId,t.id,J.THREAD_RELATION_TYPE.name,null,{dir:y.Direction.Backward,from:c.start}),i=[],o=c.end;for(;o;){let r=await this.fetchRelations(e.room.roomId,t.id,J.THREAD_RELATION_TYPE.name,null,{dir:y.Direction.Forward,from:o});o=null!==(d=r.next_batch)&&void 0!==d?d:null,i.push(...r.chunk)}let s=[...i.reverse().map(p),g,...r.chunk.map(p)];for(let t of s)await (null===(l=e.thread)||void 0===l?void 0:l.processEvent(t));let n=e.getLiveTimeline();if(n.getState(y.EventTimeline.BACKWARDS).setUnknownStateEvents(c.state.map(p)),e.addEventsToTimeline(s,!0,n,null),!r.next_batch){let r=await this.fetchRoomEvent(e.room.roomId,t.id);e.addEventsToTimeline([p(r)],!0,n,null)}return n.setPaginationToken(null!==(a=r.next_batch)&&void 0!==a?a:null,y.Direction.Backward),n.setPaginationToken(null,y.Direction.Forward),this.processAggregatedTimelineEvents(e.room,s),n}}}async getLatestTimeline(e){var t,r,i,o;let s;if(!this.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw Error("getLatestTimeline only supports room timelines");if(null!==e.threadListType){let r=await this.createThreadListMessagesRequest(e.room.roomId,null,1,y.Direction.Backward,e.threadListType,e.getFilter());s=null===(t=r.chunk)||void 0===t?void 0:t[0]}else if(e.thread&&J.Thread.hasServerSideSupport){let t=await this.fetchRelations(e.room.roomId,e.thread.id,J.THREAD_RELATION_TYPE.name,null,{dir:y.Direction.Backward,limit:1});s=null===(r=t.chunk)||void 0===r?void 0:r[0]}else{let t=m.encodeUri("/rooms/$roomId/messages",{$roomId:e.room.roomId}),r={dir:"b"};null!==(i=this.clientOpts)&&void 0!==i&&i.lazyLoadMembers&&(r.filter=JSON.stringify(v.Filter.LAZY_LOADING_MESSAGES_FILTER));let n=await this.http.authedRequest(w.Method.Get,t,r);s=null===(o=n.chunk)||void 0===o?void 0:o[0]}if(!s)throw Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(e,s.event_id)}createMessagesRequest(e,t,r=30,i,o){var s,n;let a=m.encodeUri("/rooms/$roomId/messages",{$roomId:e}),d={limit:r.toString(),dir:i};t&&(d.from=t);let l=null;return null!==(s=this.clientOpts)&&void 0!==s&&s.lazyLoadMembers&&(l=Object.assign({},v.Filter.LAZY_LOADING_MESSAGES_FILTER)),o&&Object.assign(l=l||{},null===(n=o.getRoomTimelineFilterComponent())||void 0===n?void 0:n.toJSON()),l&&(d.filter=JSON.stringify(l)),this.http.authedRequest(w.Method.Get,a,d)}createThreadListMessagesRequest(e,t,r=30,i=y.Direction.Backward,o=J.ThreadFilterType.All,s){var n,a;let d=m.encodeUri("/rooms/$roomId/threads",{$roomId:e}),l={limit:r.toString(),dir:i,include:(0,J.threadFilterTypeToFilter)(o)};t&&(l.from=t);let h={};null!==(n=this.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(h=ea({},v.Filter.LAZY_LOADING_MESSAGES_FILTER)),s&&(h=ea(ea({},h),null===(a=s.getRoomTimelineFilterComponent())||void 0===a?void 0:a.toJSON())),Object.keys(h).length&&(l.filter=JSON.stringify(h));let u={prefix:J.Thread.hasServerSideListSupport===J.FeatureSupport.Stable?"/_matrix/client/v1":"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(w.Method.Get,d,l,void 0,u).then(e=>{var t;return ea(ea({},e),{},{chunk:null===(t=e.chunk)||void 0===t?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})})}paginateEventTimeline(e,t){var r,i,o;let s,n;let a=e.getTimelineSet()===this.notifTimelineSet,d=this.getRoom(e.getRoomId()),l=e.getTimelineSet().threadListType,h=e.getTimelineSet().thread;t=t||{};let u=t.backwards||!1;if(a&&!u)throw Error("paginateNotifTimeline can only paginate backwards");let c=u?y.EventTimeline.BACKWARDS:y.EventTimeline.FORWARDS,p=e.getPaginationToken(c),v=e.paginationRequests[c];if(v)return v;if(a)s={limit:(null!==(r=t.limit)&&void 0!==r?r:30).toString(),only:"highlight"},p&&"end"!==p&&(s.from=p),n=this.http.authedRequest(w.Method.Get,"/notifications",s).then(async t=>{let r=t.next_token,i=[];t.notifications=t.notifications.filter(m.noUnsafeEventProps);for(let e=0;e<t.notifications.length;e++){let r=t.notifications[e],o=this.getEventMapper()(r.event);this.getPushDetailsForEvent(o,!0),o.event.room_id=r.room_id,i[e]=o}let o=e.getTimelineSet();return o.addEventsToTimeline(i,u,e,r),this.processAggregatedTimelineEvents(o.room,i),u&&!t.next_token&&e.setPaginationToken(null,c),!!t.next_token}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=n;else if(null!==l){if(!d)throw Error("Unknown room "+e.getRoomId());if(!J.Thread.hasServerSideFwdPaginationSupport&&c===y.Direction.Forward)throw Error("Cannot paginate threads forwards without server-side support for MSC 3715");n=this.createThreadListMessagesRequest(e.getRoomId(),p,t.limit,c,l,e.getFilter()).then(t=>{if(t.state){let r=e.getState(c),i=t.state.filter(m.noUnsafeEventProps).map(this.getEventMapper());r.setUnknownStateEvents(i)}let r=t.end,i=t.chunk.filter(m.noUnsafeEventProps).map(this.getEventMapper()),o=e.getTimelineSet();return o.addEventsToTimeline(i,u,e,r),this.processAggregatedTimelineEvents(d,i),this.processThreadRoots(d,i,u),u&&t.end==t.start&&e.setPaginationToken(null,c),t.end!==t.start}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=n}else if(h){let r=this.getRoom(null!==(i=e.getRoomId())&&void 0!==i?i:void 0);if(!r)throw Error("Unknown room "+e.getRoomId());n=this.fetchRelations(null!==(o=e.getRoomId())&&void 0!==o?o:"",h.id,J.THREAD_RELATION_TYPE.name,null,{dir:c,limit:t.limit,from:null!=p?p:void 0}).then(async t=>{let i=this.getEventMapper(),o=t.chunk.filter(m.noUnsafeEventProps).map(i);for(let e of o.slice().reverse()){await (null==h?void 0:h.processEvent(e));let t=e.getSender();u&&(null==h?void 0:h.getEventReadUpTo(t))!==null||r.addLocalEchoReceipt(t,e,z.ReceiptType.Read)}let s=t.next_batch,n=e.getTimelineSet();if(n.addEventsToTimeline(o,u,e,null!=s?s:null),!s&&u){var a;let t=await this.fetchRoomEvent(null!==(a=e.getRoomId())&&void 0!==a?a:"",h.id);n.addEventsToTimeline([i(t)],!0,e,null)}return this.processAggregatedTimelineEvents(n.room,o),u&&!s&&e.setPaginationToken(null,c),!!s}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=n}else{if(!d)throw Error("Unknown room "+e.getRoomId());n=this.createMessagesRequest(e.getRoomId(),p,t.limit,c,e.getFilter()).then(t=>{if(t.state){let r=e.getState(c),i=t.state.filter(m.noUnsafeEventProps).map(this.getEventMapper());r.setUnknownStateEvents(i)}let r=t.end,i=t.chunk.filter(m.noUnsafeEventProps).map(this.getEventMapper()),o=e.getTimelineSet(),[s]=d.partitionThreadedEvents(i);o.addEventsToTimeline(s,u,e,r),this.processAggregatedTimelineEvents(d,s),this.processThreadRoots(d,s.filter(e=>e.getServerAggregatedRelation(J.THREAD_RELATION_TYPE.name)),!1);let n=void 0===t.end||t.end===t.start;return u&&n&&e.setPaginationToken(null,c),!n}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=n}return n}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t;return null===(t=this.peekSync)||void 0===t||t.stopPeeking(),this.peekSync=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){let r=this.sendStateEvent(e,O.EventType.RoomGuestAccess,{guest_access:t.allowJoin?"can_join":"forbidden"},""),i=Promise.resolve(void 0);return t.allowRead&&(i=this.sendStateEvent(e,O.EventType.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([i,r]).then()}requestRegisterEmailToken(e,t,r,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:i})}requestRegisterMsisdnToken(e,t,r,i,o){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:i,next_link:o})}requestAdd3pidEmailToken(e,t,r,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:i})}requestAdd3pidMsisdnToken(e,t,r,i,o){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:i,next_link:o})}requestPasswordEmailToken(e,t,r,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:i})}requestPasswordMsisdnToken(e,t,r,i,o){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:i,next_link:o})}async requestTokenFromEndpoint(e,t){let r=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){var i;let e=new URL(this.idBaseUrl);if(r.id_server=e.host,null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){let e=await this.identityServer.getAccessToken();e&&(r.id_access_token=e)}}return this.http.request(w.Method.Post,e,void 0,r)}getRoomPushRule(e,t){if(this.pushRules){var r,i;return null===(r=this.pushRules[e])||void 0===r?void 0:null===(i=r.room)||void 0===i?void 0:i.find(e=>e.rule_id===t)}throw Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){let i;let o=!1,s=this.getRoomPushRule(e,t);if(null!=s&&s.actions.includes(V.PushRuleActionName.DontNotify)&&(o=!0),r){if(s){if(!o){let r=m.defer();this.deletePushRule(e,V.PushRuleKind.RoomSpecific,s.rule_id).then(()=>{this.addPushRule(e,V.PushRuleKind.RoomSpecific,t,{actions:[V.PushRuleActionName.DontNotify]}).then(()=>{r.resolve()}).catch(e=>{r.reject(e)})}).catch(e=>{r.reject(e)}),i=r.promise}}else i=this.addPushRule(e,V.PushRuleKind.RoomSpecific,t,{actions:[V.PushRuleActionName.DontNotify]})}else o&&(i=this.deletePushRule(e,V.PushRuleKind.RoomSpecific,s.rule_id));if(i)return new Promise((e,t)=>{i.then(()=>{this.getPushRules().then(t=>{this.pushRules=t,e()}).catch(e=>{t(e)})}).catch(e=>{this.getPushRules().then(r=>{this.pushRules=r,t(e)}).catch(r=>{t(e)})})})}searchMessageText(e){let t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){let t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:G.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(e=>this.processRoomEventsSearch(r,e))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;let t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(t=>this.processRoomEventsSearch(e,t)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,i;let o=t.search_categories.room_events;e.count=o.count,e.next_batch=o.next_batch;let s=new Set(o.highlights);e.highlights.forEach(e=>{s.add(e)}),e.highlights=Array.from(s);let n=this.getEventMapper(),a=null!==(r=null===(i=o.results)||void 0===i?void 0:i.length)&&void 0!==r?r:0;for(let t=0;t<a;t++){let r=U.SearchResult.fromJson(o.results[t],n),i=this.getRoom(r.context.getEvent().getRoomId());if(i)for(let e of r.context.getTimeline()){let t=i.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(r)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;let e=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{T.logger.log("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){let t=m.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(w.Method.Post,t,void 0,e).then(t=>{let r=v.Filter.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(r),r})}getFilter(e,t,r){if(r){let r=this.store.getFilter(e,t);if(r)return Promise.resolve(r)}let i=m.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(w.Method.Get,i).then(r=>{let i=v.Filter.fromJson(e,t,r);return this.store.storeFilter(i),i})}async getOrCreateFilter(e,t){let r;let i=this.store.getFilterIdByName(e);if(i){try{let e=await this.getFilter(this.credentials.userId,i,!0);if(e){let o=e.getDefinition(),s=t.getDefinition();m.deepCompare(o,s)&&(r=i)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}r||this.store.setFilterIdByName(e,void 0)}if(r)return r;let o=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,o.filterId),o.filterId}getOpenIdToken(){let e=m.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(w.Method.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(w.Method.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}async checkTurnServers(){if(!this.canSupportVoip)return;let e=!1,t=this.turnServersExpiry-Date.now();if(t>6e5)T.logger.debug("TURN creds are valid for another "+t+" ms: not fetching new ones."),e=!0;else{T.logger.debug("Fetching new TURN credentials");try{let t=await this.turnServer();if(t.uris){T.logger.log("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");let r={urls:t.uris,username:t.username,credential:t.password};this.turnServers=[r],this.turnServersExpiry=Date.now()+1e3*t.ttl,e=!0,this.emit(ey.TurnServers,this.turnServers)}}catch(e){T.logger.error("Failed to get TURN URIs",e),403===e.httpStatus?(T.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&r.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.emit(ey.TurnServersError,e,!0)):this.emit(ey.TurnServersError,e,!1)}}return e}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){let e=m.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(w.Method.Get,e,void 0,void 0,{prefix:""}).then(e=>e.admin)}whoisSynapseUser(e){let t=m.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(w.Method.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){let t=m.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(w.Method.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){var e;this.clientWellKnownPromise=E.AutoDiscovery.getRawClientConfig(null!==(e=this.getDomain())&&void 0!==e?e:void 0),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(ey.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){let e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(([t,r])=>e.includes(typeof r)).reduce((e,[t,r])=>(e[t]=r,e),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){let t=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),r=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms");if(!t&&!r)throw Error("Server does not support mutual_rooms API");let i=m.encodeUri(`/uk.half-shot.msc2666/user/${r?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e}),o=await this.http.authedRequest(w.Method.Get,i,void 0,void 0,{prefix:w.ClientPrefix.Unstable});return o.joined}async getVersions(){if(this.serverVersionsPromise)return this.serverVersionsPromise;this.serverVersionsPromise=this.http.request(w.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(e=>{throw this.serverVersionsPromise=void 0,e});let e=await this.serverVersionsPromise;return this.canSupport=await (0,er.buildFeatureSupportMap)(e),this.serverVersionsPromise}async isVersionSupported(e){let{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportLazyLoading(){let e=await this.getVersions();if(!e)return!1;let t=e.versions,r=e.unstable_features;return t&&t.includes("r0.5.0")||r&&r["m.lazy_load_members"]}async doesServerRequireIdServerParam(){let e=await this.getVersions();if(!e)return!0;let t=e.versions;if(t&&t.includes("r0.6.0"))return!1;let r=e.unstable_features;return!r||void 0===r["m.require_identity_server"]||r["m.require_identity_server"]}async doesServerAcceptIdentityAccessToken(){let e=await this.getVersions();if(!e)return!1;let t=e.versions,r=e.unstable_features;return t&&t.includes("r0.6.0")||r&&r["m.id_access_token"]}async doesServerSupportSeparateAddAndBind(){let e=await this.getVersions();if(!e)return!1;let t=e.versions,r=e.unstable_features;return(null==t?void 0:t.includes("r0.6.0"))||(null==r?void 0:r["m.separate_add_and_bind"])}async doesServerSupportUnstableFeature(e){let t=await this.getVersions();if(!t)return!1;let r=t.unstable_features;return r&&!!r[e]}async doesServerForceEncryptionForPreset(e){let t=await this.getVersions();if(!t)return!1;let r=t.unstable_features,i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return r&&!!r[`io.element.e2ee_forced.${i}`]}async doesServerSupportThread(){if(await this.isVersionSupported("v1.4"))return{threads:J.FeatureSupport.Stable,list:J.FeatureSupport.Stable,fwdPagination:J.FeatureSupport.Stable};try{let[e,t,r,i,o,s]=await Promise.all([this.doesServerSupportUnstableFeature("org.matrix.msc3440"),this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3856"),this.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3715"),this.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:(0,J.determineFeatureSupport)(t,e),list:(0,J.determineFeatureSupport)(i,r),fwdPagination:(0,J.determineFeatureSupport)(s,o)}}catch(e){return{threads:J.FeatureSupport.None,list:J.FeatureSupport.None,fwdPagination:J.FeatureSupport.None}}}doesServerSupportLogoutDevices(){return this.isVersionSupported("r0.6.1")}hasLazyLoadMembersEnabled(){var e;return!!(null!==(e=this.clientOpts)&&void 0!==e&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,r,i,o={dir:y.Direction.Backward}){var s,n;let a=i?this.getEncryptedIfNeededEventType(e,i):null,[d,l]=await Promise.all([this.fetchRoomEvent(e,t),this.fetchRelations(e,t,r,a,o)]),h=this.getEventMapper(),u=d?h(d):void 0,c=l.chunk.map(h);if(a===O.EventType.RoomMessageEncrypted){let e=u?c.concat(u):c;await Promise.all(e.map(e=>this.decryptEventIfNeeded(e))),null!==i&&(c=c.filter(e=>e.getType()===i))}return u&&r===O.RelationType.Replace&&(c=c.filter(e=>e.getSender()===u.getSender())),{originalEvent:null!=u?u:null,events:c,nextBatch:null!==(s=l.next_batch)&&void 0!==s?s:null,prevBatch:null!==(n=l.prev_batch)&&void 0!==n?n:null}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,K.randomString)(32)}decryptEventIfNeeded(e,t){return(e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted())?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case k.SERVICE_TYPES.IS:return this.http.getUrl("/terms",void 0,w.IdentityPrefix.V2,t);case k.SERVICE_TYPES.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){var t,r;return e&&(null!==(t=this.idBaseUrl)&&void 0!==t&&t.startsWith("http://")||null!==(r=this.idBaseUrl)&&void 0!==r&&r.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=m.ensureNoTrailingSlash(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}setAccessToken(e){this.http.opts.accessToken=e}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(w.Method.Get,"/register/available",{username:e}).then(e=>e.available).catch(e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e))}register(e,t,r,i,o,s,n){!0===o?o={email:!0}:(null==o||!1===o)&&(o={}),r&&(i.session=r);let a={auth:i,refresh_token:!0};return null!=e&&(a.username=e),null!=t&&(a.password=t),o.email&&(a.bind_email=!0),o.msisdn&&(a.bind_msisdn=!0),null!=s&&(a.guest_access_token=s),null!=n&&(a.inhibit_login=n),null!=t&&(a.x_show_msisdn=!0),this.registerRequest(a)}registerGuest({body:e}={}){return this.registerRequest(e||{},"guest")}registerRequest(e,t){let r={};return t&&(r.kind=t),this.http.request(w.Method.Post,"/register",r,e)}refreshToken(e){return this.http.authedRequest(w.Method.Post,"/refresh",void 0,{refresh_token:e},{prefix:w.ClientPrefix.V1,inhibitLogoutEmit:!0})}loginFlows(){return this.http.request(w.Method.Get,"/login")}login(e,t){let r={type:e};return Object.assign(r,t),this.http.authedRequest(w.Method.Post,"/login",void 0,r).then(e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}loginWithSAML2(e){return this.login("m.login.saml2",{relay_state:e})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",r,i){let o="/login/"+t+"/redirect";r&&(o+="/"+r);let s={redirectUrl:e,[ef.unstable]:i};return this.http.getUrl(o,s,w.ClientPrefix.R0).href}loginWithToken(e){return this.login("m.login.token",{token:e})}async logout(e=!1){var t,r;if(null!==(t=this.crypto)&&void 0!==t&&null!==(r=t.backupManager)&&void 0!==r&&r.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(e){T.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",e)}return e&&(this.stopClient(),this.http.abort()),this.http.authedRequest(w.Method.Post,"/logout")}deactivateAccount(e,t){let r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this.http.authedRequest(w.Method.Post,"/account/deactivate",void 0,r)}async requestLoginToken(e){let t=await this.getCapabilities(),r=ev.findIn(t)?"/org.matrix.msc3882/login/get_token":"/org.matrix.msc3882/login/token",i=await this.http.authedRequest(w.Method.Post,r,void 0,{auth:e},{prefix:w.ClientPrefix.Unstable});return"login_token"in i&&("number"==typeof i.expires_in_ms?i.expires_in=Math.floor(i.expires_in_ms/1e3):"number"==typeof i.expires_in&&(i.expires_in_ms=1e3*i.expires_in)),i}getFallbackAuthUrl(e,t){let r=m.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t},w.ClientPrefix.R0).href}async createRoom(e){var t;let r=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(r.length>0&&null!==(t=this.identityServer)&&void 0!==t&&t.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){let e=await this.identityServer.getAccessToken();if(e)for(let t of r)t.id_access_token=e}return this.http.authedRequest(w.Method.Post,"/createRoom",void 0,e)}fetchRelations(e,t,r,i,o={dir:y.Direction.Backward}){let s=o;J.Thread.hasServerSideFwdPaginationSupport===J.FeatureSupport.Experimental&&(s=(0,m.replaceParam)("dir","org.matrix.msc3715.dir",s));let n=m.encodeParams(s),a="/rooms/$roomId/relations/$eventId";null!==r?(a+="/$relationType",null!==i&&(a+="/$eventType")):null!==i&&(T.logger.warn(`eventType: ${i} ignored when fetching
            relations as relationType is null`),i=null);let d=m.encodeUri(a+"?"+n,{$roomId:e,$eventId:t,$relationType:r,$eventType:i});return this.http.authedRequest(w.Method.Get,d,void 0,void 0,{prefix:w.ClientPrefix.V1})}roomState(e){let t=m.encodeUri("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(w.Method.Get,t)}fetchRoomEvent(e,t){let r=m.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(w.Method.Get,r)}members(e,t,r,i){let o={};t&&(o.membership=t),r&&(o.not_membership=r),i&&(o.at=i);let s=m.encodeParams(o),n=m.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(w.Method.Get,n)}upgradeRoom(e,t){let r=m.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(w.Method.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){let i={$roomId:e,$eventType:t,$stateKey:r},o=m.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==r&&(o=m.encodeUri(o+"/$stateKey",i)),this.http.authedRequest(w.Method.Get,o)}sendStateEvent(e,t,r,i="",o={}){let s={$roomId:e,$eventType:t,$stateKey:i},n=m.encodeUri("/rooms/$roomId/state/$eventType",s);return void 0!==i&&(n=m.encodeUri(n+"/$stateKey",s)),this.http.authedRequest(w.Method.Put,n,void 0,r,o)}roomInitialSync(e,t){var r;let i=m.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(w.Method.Get,i,{limit:null!==(r=null==t?void 0:t.toString())&&void 0!==r?r:"30"})}async setRoomReadMarkersHttpRequest(e,t,r,i){let o=m.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),s={[z.ReceiptType.FullyRead]:t,[z.ReceiptType.Read]:r};return(await this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await this.isVersionSupported("v1.4"))&&(s[z.ReceiptType.ReadPrivate]=i),this.http.authedRequest(w.Method.Post,o,void 0,s)}getJoinedRooms(){let e=m.encodeUri("/joined_rooms",{});return this.http.authedRequest(w.Method.Get,e)}getJoinedRoomMembers(e){let t=m.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(w.Method.Get,t)}publicRooms(e={}){let{server:t,limit:r,since:i}=e,o=(0,d.default)(e,es),s={server:t,limit:r,since:i};return 0===Object.keys(o).length?this.http.authedRequest(w.Method.Get,"/publicRooms",s):this.http.authedRequest(w.Method.Post,"/publicRooms",s,o)}createAlias(e,t){let r=m.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(w.Method.Put,r,void 0,{room_id:t})}deleteAlias(e){let t=m.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(w.Method.Delete,t)}getLocalAliases(e){let t=m.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),r=w.ClientPrefix.V3;return this.http.authedRequest(w.Method.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){let t=m.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(w.Method.Get,t)}resolveRoomAlias(e){let t=m.encodeUri("/directory/room/$alias",{$alias:e});return this.http.request(w.Method.Get,t)}getRoomDirectoryVisibility(e){let t=m.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(w.Method.Get,t)}setRoomDirectoryVisibility(e,t){let r=m.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(w.Method.Put,r,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,r){let i=m.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(w.Method.Put,i,void 0,{visibility:r})}searchUserDirectory({term:e,limit:t}){let r={search_term:e};return void 0!==t&&(r.limit=t),this.http.authedRequest(w.Method.Post,"/user_directory/search",void 0,r)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){let r=t?m.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):m.encodeUri("/profile/$userId",{$userId:e});return this.http.authedRequest(w.Method.Get,r)}getThreePids(){return this.http.authedRequest(w.Method.Get,"/account/3pid")}addThreePid(e,t){return this.http.authedRequest(w.Method.Post,"/account/3pid",void 0,{threePidCreds:e,bind:t})}async addThreePidOnly(e){let t=await this.isVersionSupported("r0.6.0")?w.ClientPrefix.R0:w.ClientPrefix.Unstable;return this.http.authedRequest(w.Method.Post,"/account/3pid/add",void 0,e,{prefix:t})}async bindThreePid(e){let t=await this.isVersionSupported("r0.6.0")?w.ClientPrefix.R0:w.ClientPrefix.Unstable;return this.http.authedRequest(w.Method.Post,"/account/3pid/bind",void 0,e,{prefix:t})}async unbindThreePid(e,t){let r={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},i=await this.isVersionSupported("r0.6.0")?w.ClientPrefix.R0:w.ClientPrefix.Unstable;return this.http.authedRequest(w.Method.Post,"/account/3pid/unbind",void 0,r,{prefix:i})}deleteThreePid(e,t){return this.http.authedRequest(w.Method.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,r){return this.http.authedRequest(w.Method.Post,"/account/password",void 0,{auth:e,new_password:t,logout_devices:r})}getDevices(){return this.http.authedRequest(w.Method.Get,"/devices")}getDevice(e){let t=m.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(w.Method.Get,t)}setDeviceDetails(e,t){let r=m.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(w.Method.Put,r,void 0,t)}deleteDevice(e,t){let r=m.encodeUri("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(w.Method.Delete,r,void 0,i)}deleteMultipleDevices(e,t){let r={devices:e};return t&&(r.auth=t),this.http.authedRequest(w.Method.Post,"/delete_devices",void 0,r)}async getPushers(){let e=await this.http.authedRequest(w.Method.Get,"/pushers");return await this.doesServerSupportUnstableFeature("org.matrix.msc3881")||(e.pushers=e.pushers.map(e=>(e.hasOwnProperty(O.PUSHER_ENABLED.name)||(e[O.PUSHER_ENABLED.name]=!0),e))),e}setPusher(e){return this.http.authedRequest(w.Method.Post,"/pushers/set",void 0,e)}setLocalNotificationSettings(e,t){let r=`${O.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${e}`;return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(w.Method.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=f.PushProcessor.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,i){let o=m.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(w.Method.Put,o,void 0,i)}deletePushRule(e,t,r){let i=m.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(w.Method.Delete,i)}setPushRuleEnabled(e,t,r,i){let o=m.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(w.Method.Put,o,void 0,{enabled:i})}setPushRuleActions(e,t,r,i){let o=m.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(w.Method.Put,o,void 0,{actions:i})}search({body:e,next_batch:t},r){let i={};return t&&(i.next_batch=t),this.http.authedRequest(w.Method.Post,"/search",i,e,{abortSignal:r})}uploadKeysRequest(e,t){return this.http.authedRequest(w.Method.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(w.Method.Post,"/keys/signatures/upload",void 0,e,{prefix:w.ClientPrefix.V3})}downloadKeysForUsers(e,{token:t}={}){let r={device_keys:{}};return void 0!==t&&(r.token=t),e.forEach(e=>{r.device_keys[e]=[]}),this.http.authedRequest(w.Method.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e,t="signed_curve25519",r){let i={};for(let[r,o]of(void 0===t&&(t="signed_curve25519"),e)){let e=i[r]||{};(0,m.safeSet)(i,r,e),(0,m.safeSet)(e,o,t)}let o={one_time_keys:i};return r&&(o.timeout=r),this.http.authedRequest(w.Method.Post,"/keys/claim",void 0,o)}getKeyChanges(e,t){return this.http.authedRequest(w.Method.Get,"/keys/changes",{from:e,to:t})}uploadDeviceSigningKeys(e,t){let r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(w.Method.Post,"/keys/device_signing/upload",void 0,r,{prefix:w.ClientPrefix.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw Error("No identity server base URL set");let t=this.http.getUrl("/account/register",void 0,w.IdentityPrefix.V2,this.idBaseUrl);return this.http.requestOtherUrl(w.Method.Post,t,e)}requestEmailToken(e,t,r,i,o){let s={client_secret:t,email:e,send_attempt:null==r?void 0:r.toString()};return i&&(s.next_link=i),this.http.idServerRequest(w.Method.Post,"/validate/email/requestToken",s,w.IdentityPrefix.V2,o)}requestMsisdnToken(e,t,r,i,o,s){let n={client_secret:r,country:e,phone_number:t,send_attempt:null==i?void 0:i.toString()};return o&&(n.next_link=o),this.http.idServerRequest(w.Method.Post,"/validate/msisdn/requestToken",n,w.IdentityPrefix.V2,s)}submitMsisdnToken(e,t,r,i){return this.http.idServerRequest(w.Method.Post,"/validate/msisdn/submitToken",{sid:e,client_secret:t,token:r},w.IdentityPrefix.V2,i)}submitMsisdnTokenOtherUrl(e,t,r,i){return this.http.requestOtherUrl(w.Method.Post,e,{sid:t,client_secret:r,token:i})}getIdentityHashDetails(e){return this.http.idServerRequest(w.Method.Get,"/hash_details",void 0,w.IdentityPrefix.V2,e)}async identityHashedLookup(e,t){let i={},o=await this.getIdentityHashDetails(t);if(!o||!o.lookup_pepper||!o.algorithms)throw Error("Unsupported identity server: bad response");i.pepper=o.lookup_pepper;let s={};if(o.algorithms.includes("sha256")){let t=new r.g.Olm.Utility;i.addresses=e.map(e=>{let r=e[0].toLowerCase(),o=e[1].toLowerCase(),n=t.sha256(`${r} ${o} ${i.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return s[n]=e[0],n}),i.algorithm="sha256"}else if(o.algorithms.includes("none"))i.addresses=e.map(e=>{let t=e[0].toLowerCase(),r=e[1].toLowerCase(),i=`${t} ${r}`;return s[i]=e[0],i}),i.algorithm="none";else throw Error("Unsupported identity server: unknown hash algorithm");let n=await this.http.idServerRequest(w.Method.Post,"/lookup",i,w.IdentityPrefix.V2,t);if(!(null!=n&&n.mappings))return[];let a=[];for(let e of Object.keys(n.mappings)){let t=n.mappings[e],r=s[e];if(!r)throw Error("Identity server returned more results than expected");a.push({address:r,mxid:t})}return a}async lookupThreePid(e,t,r){let i=await this.identityHashedLookup([[t,e]],r),o=i.find(e=>e.address===t);if(!o)return{};let s={address:t,medium:e,mxid:o.mxid};return s}async bulkLookupThreePids(e,t){let r=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),i=[];for(let t of r){let r=e.find(e=>e[1]===t.address);if(!r)throw Error("Identity sever returned unexpected results");i.push([r[0],t.address,t.mxid])}return{threepids:i}}getIdentityAccount(e){return this.http.idServerRequest(w.Method.Get,"/account",void 0,w.IdentityPrefix.V2,e)}sendToDevice(e,t,r){let i=m.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),o={messages:m.recursiveMapToObject(t)},s=new Map;for(let[e,r]of t)s.set(e,Array.from(r.keys()));return T.logger.log(`PUT ${i}`,s),this.http.authedRequest(w.Method.Put,i,void 0,o)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(w.Method.Get,"/thirdparty/protocols").then(e=>{if(!e||"object"!=typeof e)throw Error(`/thirdparty/protocols did not return an object: ${e}`);return e})}getThirdpartyLocation(e,t){let r=m.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(w.Method.Get,r,t)}getThirdpartyUser(e,t){let r=m.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(w.Method.Get,r,t)}getTerms(e,t){let r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(w.Method.Get,r)}agreeToTerms(e,t,r,i){let o=this.termsUrlForService(e,t);return this.http.requestOtherUrl(w.Method.Post,o,{user_accepts:i},{headers:{Authorization:"Bearer "+r}})}reportEvent(e,t,r,i){let o=m.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(w.Method.Post,o,void 0,{score:r,reason:i})}getRoomHierarchy(e,t,r,i=!1,o){let s=m.encodeUri("/rooms/$roomId/hierarchy",{$roomId:e}),n={suggested_only:String(i),max_depth:null==r?void 0:r.toString(),from:o,limit:null==t?void 0:t.toString()};return this.http.authedRequest(w.Method.Get,s,n,void 0,{prefix:w.ClientPrefix.V1}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(w.Method.Get,s,n,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e})}async unstableCreateFileTree(e){let{room_id:t}=await this.createRoom({name:e,preset:B.Preset.PrivateChat,power_level_content_override:ea(ea({},L.DEFAULT_TREE_POWER_LEVELS_TEMPLATE),{},{users:{[this.getUserId()]:100}}),creation_content:{[O.RoomCreateTypeField]:O.RoomType.Space},initial_state:[{type:O.UNSTABLE_MSC3088_PURPOSE.name,state_key:O.UNSTABLE_MSC3089_TREE_SUBTYPE.name,content:{[O.UNSTABLE_MSC3088_ENABLED.name]:!0}},{type:O.EventType.RoomEncryption,state_key:"",content:{algorithm:S.MEGOLM_ALGORITHM}}]});return new L.MSC3089TreeSpace(this,t)}unstableGetFileTreeSpace(e){var t,r;let i=this.getRoom(e);if((null==i?void 0:i.getMyMembership())!=="join")return null;let o=i.currentState.getStateEvents(O.EventType.RoomCreate,""),s=i.currentState.getStateEvents(O.UNSTABLE_MSC3088_PURPOSE.name,O.UNSTABLE_MSC3089_TREE_SUBTYPE.name);if(!o)throw Error("Expected single room create event");return null!=s&&null!==(t=s.getContent())&&void 0!==t&&t[O.UNSTABLE_MSC3088_ENABLED.name]&&(null===(r=o.getContent())||void 0===r?void 0:r[O.RoomCreateTypeField])===O.RoomType.Space?new L.MSC3089TreeSpace(this,e):null}slidingSync(e,t,r){let i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);let o=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(w.Method.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:o,abortSignal:r})}supportsExperimentalThreads(){var e;return T.logger.warn("supportsExperimentalThreads() is deprecated, use supportThreads() instead"),(null===(e=this.clientOpts)||void 0===e?void 0:e.experimentalThreadSupport)||!1}supportsThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.intentionalMentions)||!1}async getRoomSummary(e,t){let r=m.encodeUri("/rooms/$roomid/summary",{$roomid:e});return this.http.authedRequest(w.Method.Get,r,{via:t},void 0,{prefix:"/_matrix/client/unstable/im.nheko.summary"})}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!=t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}async whoami(){return this.http.authedRequest(w.Method.Get,"/account/whoami")}async timestampToEvent(e,t,r){let i=m.encodeUri("/rooms/$roomId/timestamp_to_event",{$roomId:e}),o={ts:t.toString(),dir:r};try{return await this.http.authedRequest(w.Method.Get,i,o,void 0,{prefix:w.ClientPrefix.V1})}catch(e){if("M_UNRECOGNIZED"===e.errcode&&(400===e.httpStatus||404===e.httpStatus||405===e.httpStatus))return await this.http.authedRequest(w.Method.Get,i,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw e}}}function eS(e,t){var r,i;let o;let s=e.getUserId(),n=t.getId(),a=e.getRoom(t.getRoomId());if(!a||!s||!n)return;let d=t.getPushActions(),l=e.getPushActionsForEvent(t,!0),h=!!t.threadRootId&&!t.isThreadRoot,u=a.getUnreadCountForEventContext(x.NotificationCountType.Highlight,t),c=!!(null!=d&&null!==(r=d.tweaks)&&void 0!==r&&r.highlight),p=!!(null!=l&&null!==(i=l.tweaks)&&void 0!==i&&i.highlight);if(h){let e=a.getThread(t.threadRootId);o=!e||e.hasUserReadEvent(s,n)}else o=a.hasUserReadEvent(s,n);if(o)return;if(c!==p||u>0){let e=u;p&&!c&&e++,!p&&c&&e--,h?a.setThreadUnreadNotificationCount(t.threadRootId,x.NotificationCountType.Highlight,e):a.setUnreadNotificationCount(x.NotificationCountType.Highlight,e)}let v=a.getUnreadCountForEventContext(x.NotificationCountType.Total,t),g=!!(null!=l&&l.notify);g&&(h?a.setThreadUnreadNotificationCount(t.threadRootId,x.NotificationCountType.Total,v+1):a.setUnreadNotificationCount(x.NotificationCountType.Total,v+1))}t.MatrixClient=eE,(0,l.default)(eE,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")}}]);